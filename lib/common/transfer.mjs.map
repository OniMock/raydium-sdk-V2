{"version":3,"sources":["../../src/common/transfer.ts"],"sourceRoot":"../src","sourcesContent":["import { EpochInfo } from \"@solana/web3.js\";\r\nimport BN from \"bn.js\";\r\nimport { TransferFee, TransferFeeConfig } from \"@solana/spl-token\";\r\n\r\nimport { TransferFeeDataBaseType } from \"../api/type\";\r\nimport { GetTransferAmountFee } from \"../raydium/type\";\r\n\r\nconst POINT = 10_000;\r\nexport function getTransferAmountFee(\r\n  amount: BN,\r\n  feeConfig: TransferFeeConfig | undefined,\r\n  epochInfo: EpochInfo,\r\n  addFee: boolean,\r\n): GetTransferAmountFee {\r\n  if (feeConfig === undefined) {\r\n    return {\r\n      amount,\r\n      fee: undefined,\r\n      expirationTime: undefined,\r\n    };\r\n  }\r\n\r\n  const nowFeeConfig: TransferFee =\r\n    epochInfo.epoch < feeConfig.newerTransferFee.epoch ? feeConfig.olderTransferFee : feeConfig.newerTransferFee;\r\n  const maxFee = new BN(nowFeeConfig.maximumFee.toString());\r\n  const expirationTime: number | undefined =\r\n    epochInfo.epoch < feeConfig.newerTransferFee.epoch\r\n      ? ((Number(feeConfig.newerTransferFee.epoch) * epochInfo.slotsInEpoch - epochInfo.absoluteSlot) * 400) / 1000\r\n      : undefined;\r\n\r\n  if (addFee) {\r\n    if (nowFeeConfig.transferFeeBasisPoints === POINT) {\r\n      const nowMaxFee = new BN(nowFeeConfig.maximumFee.toString());\r\n      return {\r\n        amount: amount.add(nowMaxFee),\r\n        fee: nowMaxFee,\r\n        expirationTime,\r\n      };\r\n    } else {\r\n      const _TAmount = BNDivCeil(amount.mul(new BN(POINT)), new BN(POINT - nowFeeConfig.transferFeeBasisPoints));\r\n\r\n      const nowMaxFee = new BN(nowFeeConfig.maximumFee.toString());\r\n      const TAmount = _TAmount.sub(amount).gt(nowMaxFee) ? amount.add(nowMaxFee) : _TAmount;\r\n\r\n      const _fee = BNDivCeil(TAmount.mul(new BN(nowFeeConfig.transferFeeBasisPoints)), new BN(POINT));\r\n      const fee = _fee.gt(maxFee) ? maxFee : _fee;\r\n      return {\r\n        amount: TAmount,\r\n        fee,\r\n        expirationTime,\r\n      };\r\n    }\r\n  } else {\r\n    const _fee = BNDivCeil(amount.mul(new BN(nowFeeConfig.transferFeeBasisPoints)), new BN(POINT));\r\n    const fee = _fee.gt(maxFee) ? maxFee : _fee;\r\n\r\n    return {\r\n      amount,\r\n      fee,\r\n      expirationTime,\r\n    };\r\n  }\r\n}\r\n\r\nexport function getTransferAmountFeeV2(\r\n  amount: BN,\r\n  _feeConfig: TransferFeeDataBaseType | undefined,\r\n  epochInfo: EpochInfo,\r\n  addFee: boolean,\r\n): GetTransferAmountFee {\r\n  if (_feeConfig === undefined) {\r\n    return {\r\n      amount,\r\n      fee: undefined,\r\n      expirationTime: undefined,\r\n    };\r\n  }\r\n  const feeConfig = {\r\n    ..._feeConfig,\r\n    olderTransferFee: {\r\n      epoch: BigInt(_feeConfig.olderTransferFee.epoch),\r\n      maximumFee: BigInt(_feeConfig.olderTransferFee.maximumFee),\r\n      transferFeeBasisPoints: _feeConfig.olderTransferFee.transferFeeBasisPoints,\r\n    },\r\n    newerTransferFee: {\r\n      epoch: BigInt(_feeConfig.newerTransferFee.epoch),\r\n      maximumFee: BigInt(_feeConfig.newerTransferFee.maximumFee),\r\n      transferFeeBasisPoints: _feeConfig.newerTransferFee.transferFeeBasisPoints,\r\n    },\r\n  };\r\n\r\n  const nowFeeConfig: TransferFee =\r\n    epochInfo.epoch < feeConfig.newerTransferFee.epoch ? feeConfig.olderTransferFee : feeConfig.newerTransferFee;\r\n  const maxFee = new BN(nowFeeConfig.maximumFee.toString());\r\n  const expirationTime: number | undefined =\r\n    epochInfo.epoch < feeConfig.newerTransferFee.epoch\r\n      ? ((Number(feeConfig.newerTransferFee.epoch) * epochInfo.slotsInEpoch - epochInfo.absoluteSlot) * 400) / 1000\r\n      : undefined;\r\n\r\n  if (addFee) {\r\n    if (nowFeeConfig.transferFeeBasisPoints === POINT) {\r\n      const nowMaxFee = new BN(nowFeeConfig.maximumFee.toString());\r\n      return {\r\n        amount: amount.add(nowMaxFee),\r\n        fee: nowMaxFee,\r\n        expirationTime,\r\n      };\r\n    } else {\r\n      const _TAmount = BNDivCeil(amount.mul(new BN(POINT)), new BN(POINT - nowFeeConfig.transferFeeBasisPoints));\r\n\r\n      const nowMaxFee = new BN(nowFeeConfig.maximumFee.toString());\r\n      const TAmount = _TAmount.sub(amount).gt(nowMaxFee) ? amount.add(nowMaxFee) : _TAmount;\r\n\r\n      const _fee = BNDivCeil(TAmount.mul(new BN(nowFeeConfig.transferFeeBasisPoints)), new BN(POINT));\r\n      const fee = _fee.gt(maxFee) ? maxFee : _fee;\r\n      return {\r\n        amount: TAmount,\r\n        fee,\r\n        expirationTime,\r\n      };\r\n    }\r\n  } else {\r\n    const _fee = BNDivCeil(amount.mul(new BN(nowFeeConfig.transferFeeBasisPoints)), new BN(POINT));\r\n    const fee = _fee.gt(maxFee) ? maxFee : _fee;\r\n\r\n    return {\r\n      amount,\r\n      fee,\r\n      expirationTime,\r\n    };\r\n  }\r\n}\r\n\r\nexport function minExpirationTime(\r\n  expirationTime1: number | undefined,\r\n  expirationTime2: number | undefined,\r\n): number | undefined {\r\n  if (expirationTime1 === undefined) return expirationTime2;\r\n  if (expirationTime2 === undefined) return expirationTime1;\r\n\r\n  return Math.min(expirationTime1, expirationTime2);\r\n}\r\n\r\nexport function BNDivCeil(bn1: BN, bn2: BN): BN {\r\n  const { div, mod } = bn1.divmod(bn2);\r\n\r\n  if (mod.gt(new BN(0))) {\r\n    return div.add(new BN(1));\r\n  } else {\r\n    return div;\r\n  }\r\n}\r\n\r\nexport function ceilDivBN(amountA: BN, amountB: BN): BN {\r\n  if (amountA.isZero()) return new BN(0);\r\n\r\n  const quotient = amountA.div(amountB);\r\n\r\n  if (quotient.isZero()) return new BN(1);\r\n\r\n  const remainder = amountA.mod(amountB);\r\n  if (remainder.gt(new BN(0))) {\r\n    return quotient.add(new BN(1));\r\n  }\r\n  return quotient;\r\n}\r\n"],"mappings":";AACA;AAMA,IAAM,QAAQ;AACP,8BACL,QACA,WACA,WACA,QACsB;AACtB,MAAI,cAAc,QAAW;AAC3B,WAAO;AAAA,MACL;AAAA,MACA,KAAK;AAAA,MACL,gBAAgB;AAAA,IAClB;AAAA,EACF;AAEA,QAAM,eACJ,UAAU,QAAQ,UAAU,iBAAiB,QAAQ,UAAU,mBAAmB,UAAU;AAC9F,QAAM,SAAS,IAAI,GAAG,aAAa,WAAW,SAAS,CAAC;AACxD,QAAM,iBACJ,UAAU,QAAQ,UAAU,iBAAiB,QACvC,QAAO,UAAU,iBAAiB,KAAK,IAAI,UAAU,eAAe,UAAU,gBAAgB,MAAO,MACvG;AAEN,MAAI,QAAQ;AACV,QAAI,aAAa,2BAA2B,OAAO;AACjD,YAAM,YAAY,IAAI,GAAG,aAAa,WAAW,SAAS,CAAC;AAC3D,aAAO;AAAA,QACL,QAAQ,OAAO,IAAI,SAAS;AAAA,QAC5B,KAAK;AAAA,QACL;AAAA,MACF;AAAA,IACF,OAAO;AACL,YAAM,WAAW,UAAU,OAAO,IAAI,IAAI,GAAG,KAAK,CAAC,GAAG,IAAI,GAAG,QAAQ,aAAa,sBAAsB,CAAC;AAEzG,YAAM,YAAY,IAAI,GAAG,aAAa,WAAW,SAAS,CAAC;AAC3D,YAAM,UAAU,SAAS,IAAI,MAAM,EAAE,GAAG,SAAS,IAAI,OAAO,IAAI,SAAS,IAAI;AAE7E,YAAM,OAAO,UAAU,QAAQ,IAAI,IAAI,GAAG,aAAa,sBAAsB,CAAC,GAAG,IAAI,GAAG,KAAK,CAAC;AAC9F,YAAM,MAAM,KAAK,GAAG,MAAM,IAAI,SAAS;AACvC,aAAO;AAAA,QACL,QAAQ;AAAA,QACR;AAAA,QACA;AAAA,MACF;AAAA,IACF;AAAA,EACF,OAAO;AACL,UAAM,OAAO,UAAU,OAAO,IAAI,IAAI,GAAG,aAAa,sBAAsB,CAAC,GAAG,IAAI,GAAG,KAAK,CAAC;AAC7F,UAAM,MAAM,KAAK,GAAG,MAAM,IAAI,SAAS;AAEvC,WAAO;AAAA,MACL;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAAA,EACF;AACF;AAEO,gCACL,QACA,YACA,WACA,QACsB;AACtB,MAAI,eAAe,QAAW;AAC5B,WAAO;AAAA,MACL;AAAA,MACA,KAAK;AAAA,MACL,gBAAgB;AAAA,IAClB;AAAA,EACF;AACA,QAAM,YAAY;AAAA,OACb;AAAA,IACH,kBAAkB;AAAA,MAChB,OAAO,OAAO,WAAW,iBAAiB,KAAK;AAAA,MAC/C,YAAY,OAAO,WAAW,iBAAiB,UAAU;AAAA,MACzD,wBAAwB,WAAW,iBAAiB;AAAA,IACtD;AAAA,IACA,kBAAkB;AAAA,MAChB,OAAO,OAAO,WAAW,iBAAiB,KAAK;AAAA,MAC/C,YAAY,OAAO,WAAW,iBAAiB,UAAU;AAAA,MACzD,wBAAwB,WAAW,iBAAiB;AAAA,IACtD;AAAA,EACF;AAEA,QAAM,eACJ,UAAU,QAAQ,UAAU,iBAAiB,QAAQ,UAAU,mBAAmB,UAAU;AAC9F,QAAM,SAAS,IAAI,GAAG,aAAa,WAAW,SAAS,CAAC;AACxD,QAAM,iBACJ,UAAU,QAAQ,UAAU,iBAAiB,QACvC,QAAO,UAAU,iBAAiB,KAAK,IAAI,UAAU,eAAe,UAAU,gBAAgB,MAAO,MACvG;AAEN,MAAI,QAAQ;AACV,QAAI,aAAa,2BAA2B,OAAO;AACjD,YAAM,YAAY,IAAI,GAAG,aAAa,WAAW,SAAS,CAAC;AAC3D,aAAO;AAAA,QACL,QAAQ,OAAO,IAAI,SAAS;AAAA,QAC5B,KAAK;AAAA,QACL;AAAA,MACF;AAAA,IACF,OAAO;AACL,YAAM,WAAW,UAAU,OAAO,IAAI,IAAI,GAAG,KAAK,CAAC,GAAG,IAAI,GAAG,QAAQ,aAAa,sBAAsB,CAAC;AAEzG,YAAM,YAAY,IAAI,GAAG,aAAa,WAAW,SAAS,CAAC;AAC3D,YAAM,UAAU,SAAS,IAAI,MAAM,EAAE,GAAG,SAAS,IAAI,OAAO,IAAI,SAAS,IAAI;AAE7E,YAAM,OAAO,UAAU,QAAQ,IAAI,IAAI,GAAG,aAAa,sBAAsB,CAAC,GAAG,IAAI,GAAG,KAAK,CAAC;AAC9F,YAAM,MAAM,KAAK,GAAG,MAAM,IAAI,SAAS;AACvC,aAAO;AAAA,QACL,QAAQ;AAAA,QACR;AAAA,QACA;AAAA,MACF;AAAA,IACF;AAAA,EACF,OAAO;AACL,UAAM,OAAO,UAAU,OAAO,IAAI,IAAI,GAAG,aAAa,sBAAsB,CAAC,GAAG,IAAI,GAAG,KAAK,CAAC;AAC7F,UAAM,MAAM,KAAK,GAAG,MAAM,IAAI,SAAS;AAEvC,WAAO;AAAA,MACL;AAAA,MACA;AAAA,MACA;AAAA,IACF;AAAA,EACF;AACF;AAEO,2BACL,iBACA,iBACoB;AACpB,MAAI,oBAAoB;AAAW,WAAO;AAC1C,MAAI,oBAAoB;AAAW,WAAO;AAE1C,SAAO,KAAK,IAAI,iBAAiB,eAAe;AAClD;AAEO,mBAAmB,KAAS,KAAa;AAC9C,QAAM,EAAE,KAAK,QAAQ,IAAI,OAAO,GAAG;AAEnC,MAAI,IAAI,GAAG,IAAI,GAAG,CAAC,CAAC,GAAG;AACrB,WAAO,IAAI,IAAI,IAAI,GAAG,CAAC,CAAC;AAAA,EAC1B,OAAO;AACL,WAAO;AAAA,EACT;AACF;AAEO,mBAAmB,SAAa,SAAiB;AACtD,MAAI,QAAQ,OAAO;AAAG,WAAO,IAAI,GAAG,CAAC;AAErC,QAAM,WAAW,QAAQ,IAAI,OAAO;AAEpC,MAAI,SAAS,OAAO;AAAG,WAAO,IAAI,GAAG,CAAC;AAEtC,QAAM,YAAY,QAAQ,IAAI,OAAO;AACrC,MAAI,UAAU,GAAG,IAAI,GAAG,CAAC,CAAC,GAAG;AAC3B,WAAO,SAAS,IAAI,IAAI,GAAG,CAAC,CAAC;AAAA,EAC/B;AACA,SAAO;AACT;","names":[]}