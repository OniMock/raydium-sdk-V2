var am=Object.defineProperty;var um=(i,e,t)=>e in i?am(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var Nt=(i,e,t)=>(um(i,typeof e!="symbol"?e+"":e,t),t);import nc from"axios";import{PublicKey as fu}from"@solana/web3.js";import{get as ds,set as du}from"lodash";var cm=(o=>(o[o.Error=0]="Error",o[o.Warning=1]="Warning",o[o.Info=2]="Info",o[o.Debug=3]="Debug",o))(cm||{}),ps=class{logLevel;name;constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},fs={},pu={};function pe(i){let e=ds(fs,i);if(!e){let t=ds(pu,i);e=new ps({name:i,logLevel:t}),du(fs,i,e)}return e}function lb(i,e){du(pu,i,e);let t=ds(fs,i);t&&(t.level=e)}import{MINT_SIZE as lm,TOKEN_PROGRAM_ID as mm,getTransferFeeConfig as dm,unpackMint as pm}from"@solana/spl-token";var ys=pe("Raydium_accountInfo_util");async function qt(i,e,t){let{batchRequest:n,commitment:o="confirmed",chunkCount:r=100}={batchRequest:!1,...t},s=bs(e,r),a=new Array(s.length).fill([]);if(n){let c=s.map(d=>{let m=i._buildArgs([d.map(p=>p.toBase58())],o,"base64");return{methodName:"getMultipleAccounts",args:m}}),u=bs(c,10);a=(await(await Promise.all(u.map(async d=>await i._rpcBatchRequest(d)))).flat()).map(d=>(d.error&&ys.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${d.error.message}`),d.result.value.map(m=>{if(m){let{data:p,executable:y,lamports:f,owner:b,rentEpoch:g}=m;return p.length!==2&&p[1]!=="base64"&&ys.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(p[0],"base64"),executable:y,lamports:f,owner:new fu(b),rentEpoch:g}}return null})))}else try{a=await Promise.all(s.map(c=>i.getMultipleAccountsInfo(c,o)))}catch(c){c instanceof Error&&ys.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${c.message}`)}return a.flat()}async function Ke(i,e,t){let n=await qt(i,e.map(o=>o.pubkey),t);return e.map((o,r)=>({...o,accountInfo:n[r]}))}var fm=(n=>(n[n.Uninitialized=0]="Uninitialized",n[n.Mint=1]="Mint",n[n.Account=2]="Account",n))(fm||{}),Pb=1;async function po({connection:i,mints:e,config:t}){if(e.length===0)return{};let n=await Ke(i,e.map(r=>({pubkey:ft(r)})),t),o={};for(let r of n){if(!r.accountInfo||r.accountInfo.data.length<lm){console.log("invalid mint account",r.pubkey.toBase58());continue}let s=pm(r.pubkey,r.accountInfo,r.accountInfo?.owner);o[r.pubkey.toString()]={...s,programId:r.accountInfo?.owner||mm,feeConfig:dm(s)??void 0}}return o[fu.default.toBase58()]=o[j.toBase58()],o}import qe from"bn.js";var fo=9e15,Rn=1e9,gs="0123456789abcdef",ji="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",Yi="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",As={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-fo,maxE:fo,crypto:!1},Au,bn,ue=!0,$i="[DecimalError] ",Ln=$i+"Invalid argument: ",Pu=$i+"Precision limit exceeded",wu=$i+"crypto unavailable",ku="[object Decimal]",yt=Math.floor,Je=Math.pow,ym=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,bm=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,gm=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,hu=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,Gt=1e7,oe=7,Am=9007199254740991,Pm=ji.length-1,Ps=Yi.length-1,W={toStringTag:ku};W.absoluteValue=W.abs=function(){var i=new this.constructor(this);return i.s<0&&(i.s=1),J(i)};W.ceil=function(){return J(new this.constructor(this),this.e+1,2)};W.clampedTo=W.clamp=function(i,e){var t,n=this,o=n.constructor;if(i=new o(i),e=new o(e),!i.s||!e.s)return new o(NaN);if(i.gt(e))throw Error(Ln+e);return t=n.cmp(i),t<0?i:n.cmp(e)>0?e:new o(n)};W.comparedTo=W.cmp=function(i){var e,t,n,o,r=this,s=r.d,a=(i=new r.constructor(i)).d,c=r.s,u=i.s;if(!s||!a)return!c||!u?NaN:c!==u?c:s===a?0:!s^c<0?1:-1;if(!s[0]||!a[0])return s[0]?c:a[0]?-u:0;if(c!==u)return c;if(r.e!==i.e)return r.e>i.e^c<0?1:-1;for(n=s.length,o=a.length,e=0,t=n<o?n:o;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^c<0?1:-1;return n===o?0:n>o^c<0?1:-1};W.cosine=W.cos=function(){var i,e,t=this,n=t.constructor;return t.d?t.d[0]?(i=n.precision,e=n.rounding,n.precision=i+Math.max(t.e,t.sd())+oe,n.rounding=1,t=wm(n,Su(n,t)),n.precision=i,n.rounding=e,J(bn==2||bn==3?t.neg():t,i,e,!0)):new n(1):new n(NaN)};W.cubeRoot=W.cbrt=function(){var i,e,t,n,o,r,s,a,c,u,l=this,d=l.constructor;if(!l.isFinite()||l.isZero())return new d(l);for(ue=!1,r=l.s*Je(l.s*l,1/3),!r||Math.abs(r)==1/0?(t=ct(l.d),i=l.e,(r=(i-t.length+1)%3)&&(t+=r==1||r==-2?"0":"00"),r=Je(t,1/3),i=yt((i+1)/3)-(i%3==(i<0?-1:2)),r==1/0?t="5e"+i:(t=r.toExponential(),t=t.slice(0,t.indexOf("e")+1)+i),n=new d(t),n.s=l.s):n=new d(r.toString()),s=(i=d.precision)+3;;)if(a=n,c=a.times(a).times(a),u=c.plus(l),n=Ce(u.plus(l).times(a),u.plus(c),s+2,1),ct(a.d).slice(0,s)===(t=ct(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!o&&t=="4999"){if(!o&&(J(a,i+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,o=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&(J(n,i+1,1),e=!n.times(n).times(n).eq(l));break}return ue=!0,J(n,i,d.rounding,e)};W.decimalPlaces=W.dp=function(){var i,e=this.d,t=NaN;if(e){if(i=e.length-1,t=(i-yt(this.e/oe))*oe,i=e[i],i)for(;i%10==0;i/=10)t--;t<0&&(t=0)}return t};W.dividedBy=W.div=function(i){return Ce(this,new this.constructor(i))};W.dividedToIntegerBy=W.divToInt=function(i){var e=this,t=e.constructor;return J(Ce(e,new t(i),0,1,1),t.precision,t.rounding)};W.equals=W.eq=function(i){return this.cmp(i)===0};W.floor=function(){return J(new this.constructor(this),this.e+1,3)};W.greaterThan=W.gt=function(i){return this.cmp(i)>0};W.greaterThanOrEqualTo=W.gte=function(i){var e=this.cmp(i);return e==1||e===0};W.hyperbolicCosine=W.cosh=function(){var i,e,t,n,o,r=this,s=r.constructor,a=new s(1);if(!r.isFinite())return new s(r.s?1/0:NaN);if(r.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(r.e,r.sd())+4,s.rounding=1,o=r.d.length,o<32?(i=Math.ceil(o/3),e=(1/er(4,i)).toString()):(i=16,e="2.3283064365386962890625e-10"),r=yo(s,1,r.times(e),new s(1),!0);for(var c,u=i,l=new s(8);u--;)c=r.times(r),r=a.minus(c.times(l.minus(c.times(l))));return J(r,s.precision=t,s.rounding=n,!0)};W.hyperbolicSine=W.sinh=function(){var i,e,t,n,o=this,r=o.constructor;if(!o.isFinite()||o.isZero())return new r(o);if(e=r.precision,t=r.rounding,r.precision=e+Math.max(o.e,o.sd())+4,r.rounding=1,n=o.d.length,n<3)o=yo(r,2,o,o,!0);else{i=1.4*Math.sqrt(n),i=i>16?16:i|0,o=o.times(1/er(5,i)),o=yo(r,2,o,o,!0);for(var s,a=new r(5),c=new r(16),u=new r(20);i--;)s=o.times(o),o=o.times(a.plus(s.times(c.times(s).plus(u))))}return r.precision=e,r.rounding=t,J(o,e,t,!0)};W.hyperbolicTangent=W.tanh=function(){var i,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+7,n.rounding=1,Ce(t.sinh(),t.cosh(),n.precision=i,n.rounding=e)):new n(t.s)};W.inverseCosine=W.acos=function(){var i,e=this,t=e.constructor,n=e.abs().cmp(1),o=t.precision,r=t.rounding;return n!==-1?n===0?e.isNeg()?Ut(t,o,r):new t(0):new t(NaN):e.isZero()?Ut(t,o+4,r).times(.5):(t.precision=o+6,t.rounding=1,e=e.asin(),i=Ut(t,o+4,r).times(.5),t.precision=o,t.rounding=r,i.minus(e))};W.inverseHyperbolicCosine=W.acosh=function(){var i,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(i=n.precision,e=n.rounding,n.precision=i+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,ue=!1,t=t.times(t).minus(1).sqrt().plus(t),ue=!0,n.precision=i,n.rounding=e,t.ln()):new n(t)};W.inverseHyperbolicSine=W.asinh=function(){var i,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,ue=!1,t=t.times(t).plus(1).sqrt().plus(t),ue=!0,n.precision=i,n.rounding=e,t.ln())};W.inverseHyperbolicTangent=W.atanh=function(){var i,e,t,n,o=this,r=o.constructor;return o.isFinite()?o.e>=0?new r(o.abs().eq(1)?o.s/0:o.isZero()?o:NaN):(i=r.precision,e=r.rounding,n=o.sd(),Math.max(n,i)<2*-o.e-1?J(new r(o),i,e,!0):(r.precision=t=n-o.e,o=Ce(o.plus(1),new r(1).minus(o),t+i,1),r.precision=i+4,r.rounding=1,o=o.ln(),r.precision=i,r.rounding=e,o.times(.5))):new r(NaN)};W.inverseSine=W.asin=function(){var i,e,t,n,o=this,r=o.constructor;return o.isZero()?new r(o):(e=o.abs().cmp(1),t=r.precision,n=r.rounding,e!==-1?e===0?(i=Ut(r,t+4,n).times(.5),i.s=o.s,i):new r(NaN):(r.precision=t+6,r.rounding=1,o=o.div(new r(1).minus(o.times(o)).sqrt().plus(1)).atan(),r.precision=t,r.rounding=n,o.times(2)))};W.inverseTangent=W.atan=function(){var i,e,t,n,o,r,s,a,c,u=this,l=u.constructor,d=l.precision,m=l.rounding;if(u.isFinite()){if(u.isZero())return new l(u);if(u.abs().eq(1)&&d+4<=Ps)return s=Ut(l,d+4,m).times(.25),s.s=u.s,s}else{if(!u.s)return new l(NaN);if(d+4<=Ps)return s=Ut(l,d+4,m).times(.5),s.s=u.s,s}for(l.precision=a=d+10,l.rounding=1,t=Math.min(28,a/oe+2|0),i=t;i;--i)u=u.div(u.times(u).plus(1).sqrt().plus(1));for(ue=!1,e=Math.ceil(a/oe),n=1,c=u.times(u),s=new l(u),o=u;i!==-1;)if(o=o.times(c),r=s.minus(o.div(n+=2)),o=o.times(c),s=r.plus(o.div(n+=2)),s.d[e]!==void 0)for(i=e;s.d[i]===r.d[i]&&i--;);return t&&(s=s.times(2<<t-1)),ue=!0,J(s,l.precision=d,l.rounding=m,!0)};W.isFinite=function(){return!!this.d};W.isInteger=W.isInt=function(){return!!this.d&&yt(this.e/oe)>this.d.length-2};W.isNaN=function(){return!this.s};W.isNegative=W.isNeg=function(){return this.s<0};W.isPositive=W.isPos=function(){return this.s>0};W.isZero=function(){return!!this.d&&this.d[0]===0};W.lessThan=W.lt=function(i){return this.cmp(i)<0};W.lessThanOrEqualTo=W.lte=function(i){return this.cmp(i)<1};W.logarithm=W.log=function(i){var e,t,n,o,r,s,a,c,u=this,l=u.constructor,d=l.precision,m=l.rounding,p=5;if(i==null)i=new l(10),e=!0;else{if(i=new l(i),t=i.d,i.s<0||!t||!t[0]||i.eq(1))return new l(NaN);e=i.eq(10)}if(t=u.d,u.s<0||!t||!t[0]||u.eq(1))return new l(t&&!t[0]?-1/0:u.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)r=!0;else{for(o=t[0];o%10===0;)o/=10;r=o!==1}if(ue=!1,a=d+p,s=Cn(u,a),n=e?Zi(l,a+10):Cn(i,a),c=Ce(s,n,a,1),Fo(c.d,o=d,m))do if(a+=10,s=Cn(u,a),n=e?Zi(l,a+10):Cn(i,a),c=Ce(s,n,a,1),!r){+ct(c.d).slice(o+1,o+15)+1==1e14&&(c=J(c,d+1,0));break}while(Fo(c.d,o+=10,m));return ue=!0,J(c,d,m)};W.minus=W.sub=function(i){var e,t,n,o,r,s,a,c,u,l,d,m,p=this,y=p.constructor;if(i=new y(i),!p.d||!i.d)return!p.s||!i.s?i=new y(NaN):p.d?i.s=-i.s:i=new y(i.d||p.s!==i.s?p:NaN),i;if(p.s!=i.s)return i.s=-i.s,p.plus(i);if(u=p.d,m=i.d,a=y.precision,c=y.rounding,!u[0]||!m[0]){if(m[0])i.s=-i.s;else if(u[0])i=new y(p);else return new y(c===3?-0:0);return ue?J(i,a,c):i}if(t=yt(i.e/oe),l=yt(p.e/oe),u=u.slice(),r=l-t,r){for(d=r<0,d?(e=u,r=-r,s=m.length):(e=m,t=l,s=u.length),n=Math.max(Math.ceil(a/oe),s)+2,r>n&&(r=n,e.length=1),e.reverse(),n=r;n--;)e.push(0);e.reverse()}else{for(n=u.length,s=m.length,d=n<s,d&&(s=n),n=0;n<s;n++)if(u[n]!=m[n]){d=u[n]<m[n];break}r=0}for(d&&(e=u,u=m,m=e,i.s=-i.s),s=u.length,n=m.length-s;n>0;--n)u[s++]=0;for(n=m.length;n>r;){if(u[--n]<m[n]){for(o=n;o&&u[--o]===0;)u[o]=Gt-1;--u[o],u[n]+=Gt}u[n]-=m[n]}for(;u[--s]===0;)u.pop();for(;u[0]===0;u.shift())--t;return u[0]?(i.d=u,i.e=Ji(u,t),ue?J(i,a,c):i):new y(c===3?-0:0)};W.modulo=W.mod=function(i){var e,t=this,n=t.constructor;return i=new n(i),!t.d||!i.s||i.d&&!i.d[0]?new n(NaN):!i.d||t.d&&!t.d[0]?J(new n(t),n.precision,n.rounding):(ue=!1,n.modulo==9?(e=Ce(t,i.abs(),0,3,1),e.s*=i.s):e=Ce(t,i,0,n.modulo,1),e=e.times(i),ue=!0,t.minus(e))};W.naturalExponential=W.exp=function(){return ws(this)};W.naturalLogarithm=W.ln=function(){return Cn(this)};W.negated=W.neg=function(){var i=new this.constructor(this);return i.s=-i.s,J(i)};W.plus=W.add=function(i){var e,t,n,o,r,s,a,c,u,l,d=this,m=d.constructor;if(i=new m(i),!d.d||!i.d)return!d.s||!i.s?i=new m(NaN):d.d||(i=new m(i.d||d.s===i.s?d:NaN)),i;if(d.s!=i.s)return i.s=-i.s,d.minus(i);if(u=d.d,l=i.d,a=m.precision,c=m.rounding,!u[0]||!l[0])return l[0]||(i=new m(d)),ue?J(i,a,c):i;if(r=yt(d.e/oe),n=yt(i.e/oe),u=u.slice(),o=r-n,o){for(o<0?(t=u,o=-o,s=l.length):(t=l,n=r,s=u.length),r=Math.ceil(a/oe),s=r>s?r+1:s+1,o>s&&(o=s,t.length=1),t.reverse();o--;)t.push(0);t.reverse()}for(s=u.length,o=l.length,s-o<0&&(o=s,t=l,l=u,u=t),e=0;o;)e=(u[--o]=u[o]+l[o]+e)/Gt|0,u[o]%=Gt;for(e&&(u.unshift(e),++n),s=u.length;u[--s]==0;)u.pop();return i.d=u,i.e=Ji(u,n),ue?J(i,a,c):i};W.precision=W.sd=function(i){var e,t=this;if(i!==void 0&&i!==!!i&&i!==1&&i!==0)throw Error(Ln+i);return t.d?(e=Tu(t.d),i&&t.e+1>e&&(e=t.e+1)):e=NaN,e};W.round=function(){var i=this,e=i.constructor;return J(new e(i),i.e+1,e.rounding)};W.sine=W.sin=function(){var i,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+Math.max(t.e,t.sd())+oe,n.rounding=1,t=hm(n,Su(n,t)),n.precision=i,n.rounding=e,J(bn>2?t.neg():t,i,e,!0)):new n(NaN)};W.squareRoot=W.sqrt=function(){var i,e,t,n,o,r,s=this,a=s.d,c=s.e,u=s.s,l=s.constructor;if(u!==1||!a||!a[0])return new l(!u||u<0&&(!a||a[0])?NaN:a?s:1/0);for(ue=!1,u=Math.sqrt(+s),u==0||u==1/0?(e=ct(a),(e.length+c)%2==0&&(e+="0"),u=Math.sqrt(e),c=yt((c+1)/2)-(c<0||c%2),u==1/0?e="5e"+c:(e=u.toExponential(),e=e.slice(0,e.indexOf("e")+1)+c),n=new l(e)):n=new l(u.toString()),t=(c=l.precision)+3;;)if(r=n,n=r.plus(Ce(s,r,t+2,1)).times(.5),ct(r.d).slice(0,t)===(e=ct(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!o&&e=="4999"){if(!o&&(J(r,c+1,0),r.times(r).eq(s))){n=r;break}t+=4,o=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&(J(n,c+1,1),i=!n.times(n).eq(s));break}return ue=!0,J(n,c,l.rounding,i)};W.tangent=W.tan=function(){var i,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+10,n.rounding=1,t=t.sin(),t.s=1,t=Ce(t,new n(1).minus(t.times(t)).sqrt(),i+10,0),n.precision=i,n.rounding=e,J(bn==2||bn==4?t.neg():t,i,e,!0)):new n(NaN)};W.times=W.mul=function(i){var e,t,n,o,r,s,a,c,u,l=this,d=l.constructor,m=l.d,p=(i=new d(i)).d;if(i.s*=l.s,!m||!m[0]||!p||!p[0])return new d(!i.s||m&&!m[0]&&!p||p&&!p[0]&&!m?NaN:!m||!p?i.s/0:i.s*0);for(t=yt(l.e/oe)+yt(i.e/oe),c=m.length,u=p.length,c<u&&(r=m,m=p,p=r,s=c,c=u,u=s),r=[],s=c+u,n=s;n--;)r.push(0);for(n=u;--n>=0;){for(e=0,o=c+n;o>n;)a=r[o]+p[n]*m[o-n-1]+e,r[o--]=a%Gt|0,e=a/Gt|0;r[o]=(r[o]+e)%Gt|0}for(;!r[--s];)r.pop();return e?++t:r.shift(),i.d=r,i.e=Ji(r,t),ue?J(i,d.precision,d.rounding):i};W.toBinary=function(i,e){return hs(this,2,i,e)};W.toDecimalPlaces=W.toDP=function(i,e){var t=this,n=t.constructor;return t=new n(t),i===void 0?t:(Bt(i,0,Rn),e===void 0?e=n.rounding:Bt(e,0,8),J(t,i+t.e+1,e))};W.toExponential=function(i,e){var t,n=this,o=n.constructor;return i===void 0?t=rn(n,!0):(Bt(i,0,Rn),e===void 0?e=o.rounding:Bt(e,0,8),n=J(new o(n),i+1,e),t=rn(n,!0,i+1)),n.isNeg()&&!n.isZero()?"-"+t:t};W.toFixed=function(i,e){var t,n,o=this,r=o.constructor;return i===void 0?t=rn(o):(Bt(i,0,Rn),e===void 0?e=r.rounding:Bt(e,0,8),n=J(new r(o),i+o.e+1,e),t=rn(n,!1,i+n.e+1)),o.isNeg()&&!o.isZero()?"-"+t:t};W.toFraction=function(i){var e,t,n,o,r,s,a,c,u,l,d,m,p=this,y=p.d,f=p.constructor;if(!y)return new f(p);if(u=t=new f(1),n=c=new f(0),e=new f(n),r=e.e=Tu(y)-p.e-1,s=r%oe,e.d[0]=Je(10,s<0?oe+s:s),i==null)i=r>0?e:u;else{if(a=new f(i),!a.isInt()||a.lt(u))throw Error(Ln+a);i=a.gt(e)?r>0?e:u:a}for(ue=!1,a=new f(ct(y)),l=f.precision,f.precision=r=y.length*oe*2;d=Ce(a,e,0,1,1),o=t.plus(d.times(n)),o.cmp(i)!=1;)t=n,n=o,o=u,u=c.plus(d.times(o)),c=o,o=e,e=a.minus(d.times(o)),a=o;return o=Ce(i.minus(t),n,0,1,1),c=c.plus(o.times(u)),t=t.plus(o.times(n)),c.s=u.s=p.s,m=Ce(u,n,r,1).minus(p).abs().cmp(Ce(c,t,r,1).minus(p).abs())<1?[u,n]:[c,t],f.precision=l,ue=!0,m};W.toHexadecimal=W.toHex=function(i,e){return hs(this,16,i,e)};W.toNearest=function(i,e){var t=this,n=t.constructor;if(t=new n(t),i==null){if(!t.d)return t;i=new n(1),e=n.rounding}else{if(i=new n(i),e===void 0?e=n.rounding:Bt(e,0,8),!t.d)return i.s?t:i;if(!i.d)return i.s&&(i.s=t.s),i}return i.d[0]?(ue=!1,t=Ce(t,i,0,e,1).times(i),ue=!0,J(t)):(i.s=t.s,t=i),t};W.toNumber=function(){return+this};W.toOctal=function(i,e){return hs(this,8,i,e)};W.toPower=W.pow=function(i){var e,t,n,o,r,s,a=this,c=a.constructor,u=+(i=new c(i));if(!a.d||!i.d||!a.d[0]||!i.d[0])return new c(Je(+a,u));if(a=new c(a),a.eq(1))return a;if(n=c.precision,r=c.rounding,i.eq(1))return J(a,n,r);if(e=yt(i.e/oe),e>=i.d.length-1&&(t=u<0?-u:u)<=Am)return o=Iu(c,a,t,n),i.s<0?new c(1).div(o):J(o,n,r);if(s=a.s,s<0){if(e<i.d.length-1)return new c(NaN);if((i.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=Je(+a,u),e=t==0||!isFinite(t)?yt(u*(Math.log("0."+ct(a.d))/Math.LN10+a.e+1)):new c(t+"").e,e>c.maxE+1||e<c.minE-1?new c(e>0?s/0:0):(ue=!1,c.rounding=a.s=1,t=Math.min(12,(e+"").length),o=ws(i.times(Cn(a,n+t)),n),o.d&&(o=J(o,n+5,1),Fo(o.d,n,r)&&(e=n+10,o=J(ws(i.times(Cn(a,e+t)),e),e+5,1),+ct(o.d).slice(n+1,n+15)+1==1e14&&(o=J(o,n+1,0)))),o.s=s,ue=!0,c.rounding=r,J(o,n,r))};W.toPrecision=function(i,e){var t,n=this,o=n.constructor;return i===void 0?t=rn(n,n.e<=o.toExpNeg||n.e>=o.toExpPos):(Bt(i,1,Rn),e===void 0?e=o.rounding:Bt(e,0,8),n=J(new o(n),i,e),t=rn(n,i<=n.e||n.e<=o.toExpNeg,i)),n.isNeg()&&!n.isZero()?"-"+t:t};W.toSignificantDigits=W.toSD=function(i,e){var t=this,n=t.constructor;return i===void 0?(i=n.precision,e=n.rounding):(Bt(i,1,Rn),e===void 0?e=n.rounding:Bt(e,0,8)),J(new n(t),i,e)};W.toString=function(){var i=this,e=i.constructor,t=rn(i,i.e<=e.toExpNeg||i.e>=e.toExpPos);return i.isNeg()&&!i.isZero()?"-"+t:t};W.truncated=W.trunc=function(){return J(new this.constructor(this),this.e+1,1)};W.valueOf=W.toJSON=function(){var i=this,e=i.constructor,t=rn(i,i.e<=e.toExpNeg||i.e>=e.toExpPos);return i.isNeg()?"-"+t:t};function ct(i){var e,t,n,o=i.length-1,r="",s=i[0];if(o>0){for(r+=s,e=1;e<o;e++)n=i[e]+"",t=oe-n.length,t&&(r+=Kn(t)),r+=n;s=i[e],n=s+"",t=oe-n.length,t&&(r+=Kn(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return r+s}function Bt(i,e,t){if(i!==~~i||i<e||i>t)throw Error(Ln+i)}function Fo(i,e,t,n){var o,r,s,a;for(r=i[0];r>=10;r/=10)--e;return--e<0?(e+=oe,o=0):(o=Math.ceil((e+1)/oe),e%=oe),r=Je(10,oe-e),a=i[o]%r|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==r||t>3&&a+1==r/2)&&(i[o+1]/r/100|0)==Je(10,e-2)-1||(a==r/2||a==0)&&(i[o+1]/r/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==r||!n&&t>3&&a+1==r/2)&&(i[o+1]/r/1e3|0)==Je(10,e-3)-1,s}function Hi(i,e,t){for(var n,o=[0],r,s=0,a=i.length;s<a;){for(r=o.length;r--;)o[r]*=e;for(o[0]+=gs.indexOf(i.charAt(s++)),n=0;n<o.length;n++)o[n]>t-1&&(o[n+1]===void 0&&(o[n+1]=0),o[n+1]+=o[n]/t|0,o[n]%=t)}return o.reverse()}function wm(i,e){var t,n,o;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),o=(1/er(4,t)).toString()):(t=16,o="2.3283064365386962890625e-10"),i.precision+=t,e=yo(i,1,e.times(o),new i(1));for(var r=t;r--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return i.precision-=t,e}var Ce=function(){function i(n,o,r){var s,a=0,c=n.length;for(n=n.slice();c--;)s=n[c]*o+a,n[c]=s%r|0,a=s/r|0;return a&&n.unshift(a),n}function e(n,o,r,s){var a,c;if(r!=s)c=r>s?1:-1;else for(a=c=0;a<r;a++)if(n[a]!=o[a]){c=n[a]>o[a]?1:-1;break}return c}function t(n,o,r,s){for(var a=0;r--;)n[r]-=a,a=n[r]<o[r]?1:0,n[r]=a*s+n[r]-o[r];for(;!n[0]&&n.length>1;)n.shift()}return function(n,o,r,s,a,c){var u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I,K,O,v,_=n.constructor,D=n.s==o.s?1:-1,q=n.d,G=o.d;if(!q||!q[0]||!G||!G[0])return new _(!n.s||!o.s||(q?G&&q[0]==G[0]:!G)?NaN:q&&q[0]==0||!G?D*0:D/0);for(c?(p=1,l=n.e-o.e):(c=Gt,p=oe,l=yt(n.e/p)-yt(o.e/p)),O=G.length,I=q.length,g=new _(D),w=g.d=[],d=0;G[d]==(q[d]||0);d++);if(G[d]>(q[d]||0)&&l--,r==null?(T=r=_.precision,s=_.rounding):a?T=r+(n.e-o.e)+1:T=r,T<0)w.push(1),y=!0;else{if(T=T/p+2|0,d=0,O==1){for(m=0,G=G[0],T++;(d<I||m)&&T--;d++)B=m*c+(q[d]||0),w[d]=B/G|0,m=B%G|0;y=m||d<I}else{for(m=c/(G[0]+1)|0,m>1&&(G=i(G,m,c),q=i(q,m,c),O=G.length,I=q.length),S=O,k=q.slice(0,O),h=k.length;h<O;)k[h++]=0;v=G.slice(),v.unshift(0),K=G[0],G[1]>=c/2&&++K;do m=0,u=e(G,k,O,h),u<0?(x=k[0],O!=h&&(x=x*c+(k[1]||0)),m=x/K|0,m>1?(m>=c&&(m=c-1),f=i(G,m,c),b=f.length,h=k.length,u=e(f,k,b,h),u==1&&(m--,t(f,O<b?v:G,b,c))):(m==0&&(u=m=1),f=G.slice()),b=f.length,b<h&&f.unshift(0),t(k,f,h,c),u==-1&&(h=k.length,u=e(G,k,O,h),u<1&&(m++,t(k,O<h?v:G,h,c))),h=k.length):u===0&&(m++,k=[0]),w[d++]=m,u&&k[0]?k[h++]=q[S]||0:(k=[q[S]],h=1);while((S++<I||k[0]!==void 0)&&T--);y=k[0]!==void 0}w[0]||w.shift()}if(p==1)g.e=l,Au=y;else{for(d=1,m=w[0];m>=10;m/=10)d++;g.e=d+l*p-1,J(g,a?r+g.e+1:r,s,y)}return g}}();function J(i,e,t,n){var o,r,s,a,c,u,l,d,m,p=i.constructor;e:if(e!=null){if(d=i.d,!d)return i;for(o=1,a=d[0];a>=10;a/=10)o++;if(r=e-o,r<0)r+=oe,s=e,l=d[m=0],c=l/Je(10,o-s-1)%10|0;else if(m=Math.ceil((r+1)/oe),a=d.length,m>=a)if(n){for(;a++<=m;)d.push(0);l=c=0,o=1,r%=oe,s=r-oe+1}else break e;else{for(l=a=d[m],o=1;a>=10;a/=10)o++;r%=oe,s=r-oe+o,c=s<0?0:l/Je(10,o-s-1)%10|0}if(n=n||e<0||d[m+1]!==void 0||(s<0?l:l%Je(10,o-s-1)),u=t<4?(c||n)&&(t==0||t==(i.s<0?3:2)):c>5||c==5&&(t==4||n||t==6&&(r>0?s>0?l/Je(10,o-s):0:d[m-1])%10&1||t==(i.s<0?8:7)),e<1||!d[0])return d.length=0,u?(e-=i.e+1,d[0]=Je(10,(oe-e%oe)%oe),i.e=-e||0):d[0]=i.e=0,i;if(r==0?(d.length=m,a=1,m--):(d.length=m+1,a=Je(10,oe-r),d[m]=s>0?(l/Je(10,o-s)%Je(10,s)|0)*a:0),u)for(;;)if(m==0){for(r=1,s=d[0];s>=10;s/=10)r++;for(s=d[0]+=a,a=1;s>=10;s/=10)a++;r!=a&&(i.e++,d[0]==Gt&&(d[0]=1));break}else{if(d[m]+=a,d[m]!=Gt)break;d[m--]=0,a=1}for(r=d.length;d[--r]===0;)d.pop()}return ue&&(i.e>p.maxE?(i.d=null,i.e=NaN):i.e<p.minE&&(i.e=0,i.d=[0])),i}function rn(i,e,t){if(!i.isFinite())return xu(i);var n,o=i.e,r=ct(i.d),s=r.length;return e?(t&&(n=t-s)>0?r=r.charAt(0)+"."+r.slice(1)+Kn(n):s>1&&(r=r.charAt(0)+"."+r.slice(1)),r=r+(i.e<0?"e":"e+")+i.e):o<0?(r="0."+Kn(-o-1)+r,t&&(n=t-s)>0&&(r+=Kn(n))):o>=s?(r+=Kn(o+1-s),t&&(n=t-o-1)>0&&(r=r+"."+Kn(n))):((n=o+1)<s&&(r=r.slice(0,n)+"."+r.slice(n)),t&&(n=t-s)>0&&(o+1===s&&(r+="."),r+=Kn(n))),r}function Ji(i,e){var t=i[0];for(e*=oe;t>=10;t/=10)e++;return e}function Zi(i,e,t){if(e>Pm)throw ue=!0,t&&(i.precision=t),Error(Pu);return J(new i(ji),e,1,!0)}function Ut(i,e,t){if(e>Ps)throw Error(Pu);return J(new i(Yi),e,t,!0)}function Tu(i){var e=i.length-1,t=e*oe+1;if(e=i[e],e){for(;e%10==0;e/=10)t--;for(e=i[0];e>=10;e/=10)t++}return t}function Kn(i){for(var e="";i--;)e+="0";return e}function Iu(i,e,t,n){var o,r=new i(1),s=Math.ceil(n/oe+4);for(ue=!1;;){if(t%2&&(r=r.times(e),bu(r.d,s)&&(o=!0)),t=yt(t/2),t===0){t=r.d.length-1,o&&r.d[t]===0&&++r.d[t];break}e=e.times(e),bu(e.d,s)}return ue=!0,r}function yu(i){return i.d[i.d.length-1]&1}function Bu(i,e,t){for(var n,o=new i(e[0]),r=0;++r<e.length;)if(n=new i(e[r]),n.s)o[t](n)&&(o=n);else{o=n;break}return o}function ws(i,e){var t,n,o,r,s,a,c,u=0,l=0,d=0,m=i.constructor,p=m.rounding,y=m.precision;if(!i.d||!i.d[0]||i.e>17)return new m(i.d?i.d[0]?i.s<0?0:1/0:1:i.s?i.s<0?0:i:0/0);for(e==null?(ue=!1,c=y):c=e,a=new m(.03125);i.e>-2;)i=i.times(a),d+=5;for(n=Math.log(Je(2,d))/Math.LN10*2+5|0,c+=n,t=r=s=new m(1),m.precision=c;;){if(r=J(r.times(i),c,1),t=t.times(++l),a=s.plus(Ce(r,t,c,1)),ct(a.d).slice(0,c)===ct(s.d).slice(0,c)){for(o=d;o--;)s=J(s.times(s),c,1);if(e==null)if(u<3&&Fo(s.d,c-n,p,u))m.precision=c+=10,t=r=a=new m(1),l=0,u++;else return J(s,m.precision=y,p,ue=!0);else return m.precision=y,s}s=a}}function Cn(i,e){var t,n,o,r,s,a,c,u,l,d,m,p=1,y=10,f=i,b=f.d,g=f.constructor,w=g.rounding,k=g.precision;if(f.s<0||!b||!b[0]||!f.e&&b[0]==1&&b.length==1)return new g(b&&!b[0]?-1/0:f.s!=1?NaN:b?0:f);if(e==null?(ue=!1,l=k):l=e,g.precision=l+=y,t=ct(b),n=t.charAt(0),Math.abs(r=f.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)f=f.times(i),t=ct(f.d),n=t.charAt(0),p++;r=f.e,n>1?(f=new g("0."+t),r++):f=new g(n+"."+t.slice(1))}else return u=Zi(g,l+2,k).times(r+""),f=Cn(new g(n+"."+t.slice(1)),l-y).plus(u),g.precision=k,e==null?J(f,k,w,ue=!0):f;for(d=f,c=s=f=Ce(f.minus(1),f.plus(1),l,1),m=J(f.times(f),l,1),o=3;;){if(s=J(s.times(m),l,1),u=c.plus(Ce(s,new g(o),l,1)),ct(u.d).slice(0,l)===ct(c.d).slice(0,l))if(c=c.times(2),r!==0&&(c=c.plus(Zi(g,l+2,k).times(r+""))),c=Ce(c,new g(p),l,1),e==null)if(Fo(c.d,l-y,w,a))g.precision=l+=y,u=s=f=Ce(d.minus(1),d.plus(1),l,1),m=J(f.times(f),l,1),o=a=1;else return J(c,g.precision=k,w,ue=!0);else return g.precision=k,c;c=u,o+=2}}function xu(i){return String(i.s*i.s/0)}function ks(i,e){var t,n,o;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(o=e.length;e.charCodeAt(o-1)===48;--o);if(e=e.slice(n,o),e){if(o-=n,i.e=t=t-n-1,i.d=[],n=(t+1)%oe,t<0&&(n+=oe),n<o){for(n&&i.d.push(+e.slice(0,n)),o-=oe;n<o;)i.d.push(+e.slice(n,n+=oe));e=e.slice(n),n=oe-e.length}else n-=o;for(;n--;)e+="0";i.d.push(+e),ue&&(i.e>i.constructor.maxE?(i.d=null,i.e=NaN):i.e<i.constructor.minE&&(i.e=0,i.d=[0]))}else i.e=0,i.d=[0];return i}function km(i,e){var t,n,o,r,s,a,c,u,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),hu.test(e))return ks(i,e)}else if(e==="Infinity"||e==="NaN")return+e||(i.s=NaN),i.e=NaN,i.d=null,i;if(bm.test(e))t=16,e=e.toLowerCase();else if(ym.test(e))t=2;else if(gm.test(e))t=8;else throw Error(Ln+e);for(r=e.search(/p/i),r>0?(c=+e.slice(r+1),e=e.substring(2,r)):e=e.slice(2),r=e.indexOf("."),s=r>=0,n=i.constructor,s&&(e=e.replace(".",""),a=e.length,r=a-r,o=Iu(n,new n(t),r,r*2)),u=Hi(e,t,Gt),l=u.length-1,r=l;u[r]===0;--r)u.pop();return r<0?new n(i.s*0):(i.e=Ji(u,l),i.d=u,ue=!1,s&&(i=Ce(i,o,a*4)),c&&(i=i.times(Math.abs(c)<54?Je(2,c):Vo.pow(2,c))),ue=!0,i)}function hm(i,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:yo(i,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/er(5,t)),e=yo(i,2,e,e);for(var o,r=new i(5),s=new i(16),a=new i(20);t--;)o=e.times(e),e=e.times(r.plus(o.times(s.times(o).minus(a))));return e}function yo(i,e,t,n,o){var r,s,a,c,u=1,l=i.precision,d=Math.ceil(l/oe);for(ue=!1,c=t.times(t),a=new i(n);;){if(s=Ce(a.times(c),new i(e++*e++),l,1),a=o?n.plus(s):n.minus(s),n=Ce(s.times(c),new i(e++*e++),l,1),s=a.plus(n),s.d[d]!==void 0){for(r=d;s.d[r]===a.d[r]&&r--;);if(r==-1)break}r=a,a=n,n=s,s=r,u++}return ue=!0,s.d.length=d+1,s}function er(i,e){for(var t=i;--e;)t*=i;return t}function Su(i,e){var t,n=e.s<0,o=Ut(i,i.precision,1),r=o.times(.5);if(e=e.abs(),e.lte(r))return bn=n?4:1,e;if(t=e.divToInt(o),t.isZero())bn=n?3:2;else{if(e=e.minus(t.times(o)),e.lte(r))return bn=yu(t)?n?2:3:n?4:1,e;bn=yu(t)?n?1:4:n?3:2}return e.minus(o).abs()}function hs(i,e,t,n){var o,r,s,a,c,u,l,d,m,p=i.constructor,y=t!==void 0;if(y?(Bt(t,1,Rn),n===void 0?n=p.rounding:Bt(n,0,8)):(t=p.precision,n=p.rounding),!i.isFinite())l=xu(i);else{for(l=rn(i),s=l.indexOf("."),y?(o=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):o=e,s>=0&&(l=l.replace(".",""),m=new p(1),m.e=l.length-s,m.d=Hi(rn(m),10,o),m.e=m.d.length),d=Hi(l,10,o),r=c=d.length;d[--c]==0;)d.pop();if(!d[0])l=y?"0p+0":"0";else{if(s<0?r--:(i=new p(i),i.d=d,i.e=r,i=Ce(i,m,t,n,0,o),d=i.d,r=i.e,u=Au),s=d[t],a=o/2,u=u||d[t+1]!==void 0,u=n<4?(s!==void 0||u)&&(n===0||n===(i.s<0?3:2)):s>a||s===a&&(n===4||u||n===6&&d[t-1]&1||n===(i.s<0?8:7)),d.length=t,u)for(;++d[--t]>o-1;)d[t]=0,t||(++r,d.unshift(1));for(c=d.length;!d[c-1];--c);for(s=0,l="";s<c;s++)l+=gs.charAt(d[s]);if(y){if(c>1)if(e==16||e==8){for(s=e==16?4:3,--c;c%s;c++)l+="0";for(d=Hi(l,o,e),c=d.length;!d[c-1];--c);for(s=1,l="1.";s<c;s++)l+=gs.charAt(d[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(r<0?"p":"p+")+r}else if(r<0){for(;++r;)l="0"+l;l="0."+l}else if(++r>c)for(r-=c;r--;)l+="0";else r<c&&(l=l.slice(0,r)+"."+l.slice(r))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return i.s<0?"-"+l:l}function bu(i,e){if(i.length>e)return i.length=e,!0}function Tm(i){return new this(i).abs()}function Im(i){return new this(i).acos()}function Bm(i){return new this(i).acosh()}function xm(i,e){return new this(i).plus(e)}function Sm(i){return new this(i).asin()}function Km(i){return new this(i).asinh()}function Cm(i){return new this(i).atan()}function Lm(i){return new this(i).atanh()}function Rm(i,e){i=new this(i),e=new this(e);var t,n=this.precision,o=this.rounding,r=n+4;return!i.s||!e.s?t=new this(NaN):!i.d&&!e.d?(t=Ut(this,r,1).times(e.s>0?.25:.75),t.s=i.s):!e.d||i.isZero()?(t=e.s<0?Ut(this,n,o):new this(0),t.s=i.s):!i.d||e.isZero()?(t=Ut(this,r,1).times(.5),t.s=i.s):e.s<0?(this.precision=r,this.rounding=1,t=this.atan(Ce(i,e,r,1)),e=Ut(this,r,1),this.precision=n,this.rounding=o,t=i.s<0?t.minus(e):t.plus(e)):t=this.atan(Ce(i,e,r,1)),t}function Nm(i){return new this(i).cbrt()}function Om(i){return J(i=new this(i),i.e+1,2)}function vm(i,e,t){return new this(i).clamp(e,t)}function Mm(i){if(!i||typeof i!="object")throw Error($i+"Object expected");var e,t,n,o=i.defaults===!0,r=["precision",1,Rn,"rounding",0,8,"toExpNeg",-fo,0,"toExpPos",0,fo,"maxE",0,fo,"minE",-fo,0,"modulo",0,9];for(e=0;e<r.length;e+=3)if(t=r[e],o&&(this[t]=As[t]),(n=i[t])!==void 0)if(yt(n)===n&&n>=r[e+1]&&n<=r[e+2])this[t]=n;else throw Error(Ln+t+": "+n);if(t="crypto",o&&(this[t]=As[t]),(n=i[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(wu);else this[t]=!1;else throw Error(Ln+t+": "+n);return this}function Em(i){return new this(i).cos()}function _m(i){return new this(i).cosh()}function Ku(i){var e,t,n;function o(r){var s,a,c,u=this;if(!(u instanceof o))return new o(r);if(u.constructor=o,gu(r)){u.s=r.s,ue?!r.d||r.e>o.maxE?(u.e=NaN,u.d=null):r.e<o.minE?(u.e=0,u.d=[0]):(u.e=r.e,u.d=r.d.slice()):(u.e=r.e,u.d=r.d?r.d.slice():r.d);return}if(c=typeof r,c==="number"){if(r===0){u.s=1/r<0?-1:1,u.e=0,u.d=[0];return}if(r<0?(r=-r,u.s=-1):u.s=1,r===~~r&&r<1e7){for(s=0,a=r;a>=10;a/=10)s++;ue?s>o.maxE?(u.e=NaN,u.d=null):s<o.minE?(u.e=0,u.d=[0]):(u.e=s,u.d=[r]):(u.e=s,u.d=[r]);return}else if(r*0!==0){r||(u.s=NaN),u.e=NaN,u.d=null;return}return ks(u,r.toString())}else if(c!=="string")throw Error(Ln+r);return(a=r.charCodeAt(0))===45?(r=r.slice(1),u.s=-1):(a===43&&(r=r.slice(1)),u.s=1),hu.test(r)?ks(u,r):km(u,r)}if(o.prototype=W,o.ROUND_UP=0,o.ROUND_DOWN=1,o.ROUND_CEIL=2,o.ROUND_FLOOR=3,o.ROUND_HALF_UP=4,o.ROUND_HALF_DOWN=5,o.ROUND_HALF_EVEN=6,o.ROUND_HALF_CEIL=7,o.ROUND_HALF_FLOOR=8,o.EUCLID=9,o.config=o.set=Mm,o.clone=Ku,o.isDecimal=gu,o.abs=Tm,o.acos=Im,o.acosh=Bm,o.add=xm,o.asin=Sm,o.asinh=Km,o.atan=Cm,o.atanh=Lm,o.atan2=Rm,o.cbrt=Nm,o.ceil=Om,o.clamp=vm,o.cos=Em,o.cosh=_m,o.div=Fm,o.exp=Vm,o.floor=Wm,o.hypot=Dm,o.ln=qm,o.log=Um,o.log10=Xm,o.log2=Gm,o.max=Qm,o.min=zm,o.mod=Hm,o.mul=jm,o.pow=Ym,o.random=Zm,o.round=$m,o.sign=Jm,o.sin=ed,o.sinh=td,o.sqrt=nd,o.sub=od,o.sum=id,o.tan=rd,o.tanh=sd,o.trunc=ad,i===void 0&&(i={}),i&&i.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)i.hasOwnProperty(t=n[e++])||(i[t]=this[t]);return o.config(i),o}function Fm(i,e){return new this(i).div(e)}function Vm(i){return new this(i).exp()}function Wm(i){return J(i=new this(i),i.e+1,3)}function Dm(){var i,e,t=new this(0);for(ue=!1,i=0;i<arguments.length;)if(e=new this(arguments[i++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return ue=!0,new this(1/0);t=e}return ue=!0,t.sqrt()}function gu(i){return i instanceof Vo||i&&i.toStringTag===ku||!1}function qm(i){return new this(i).ln()}function Um(i,e){return new this(i).log(e)}function Gm(i){return new this(i).log(2)}function Xm(i){return new this(i).log(10)}function Qm(){return Bu(this,arguments,"lt")}function zm(){return Bu(this,arguments,"gt")}function Hm(i,e){return new this(i).mod(e)}function jm(i,e){return new this(i).mul(e)}function Ym(i,e){return new this(i).pow(e)}function Zm(i){var e,t,n,o,r=0,s=new this(1),a=[];if(i===void 0?i=this.precision:Bt(i,1,Rn),n=Math.ceil(i/oe),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));r<n;)o=e[r],o>=429e7?e[r]=crypto.getRandomValues(new Uint32Array(1))[0]:a[r++]=o%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);r<n;)o=e[r]+(e[r+1]<<8)+(e[r+2]<<16)+((e[r+3]&127)<<24),o>=214e7?crypto.randomBytes(4).copy(e,r):(a.push(o%1e7),r+=4);r=n/4}else throw Error(wu);else for(;r<n;)a[r++]=Math.random()*1e7|0;for(n=a[--r],i%=oe,n&&i&&(o=Je(10,oe-i),a[r]=(n/o|0)*o);a[r]===0;r--)a.pop();if(r<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=oe)a.shift();for(n=1,o=a[0];o>=10;o/=10)n++;n<oe&&(t-=oe-n)}return s.e=t,s.d=a,s}function $m(i){return J(i=new this(i),i.e+1,this.rounding)}function Jm(i){return i=new this(i),i.d?i.d[0]?i.s:0*i.s:i.s||NaN}function ed(i){return new this(i).sin()}function td(i){return new this(i).sinh()}function nd(i){return new this(i).sqrt()}function od(i,e){return new this(i).sub(e)}function id(){var i=0,e=arguments,t=new this(e[i]);for(ue=!1;t.s&&++i<e.length;)t=t.plus(e[i]);return ue=!0,J(t,this.precision,this.rounding)}function rd(i){return new this(i).tan()}function sd(i){return new this(i).tanh()}function ad(i){return J(i=new this(i),i.e+1,1)}W[Symbol.for("nodejs.util.inspect.custom")]=W.toString;W[Symbol.toStringTag]="Decimal";var Vo=W.constructor=Ku(As);ji=new Vo(ji);Yi=new Vo(Yi);var C=Vo;import fd from"big.js";import Nn from"bn.js";import ud from"toformat";var cd=ud,Wo=cd;import nr from"big.js";import ld from"bn.js";import md from"decimal.js-light";import Do from"bn.js";var Ts=(n=>(n[n.ROUND_DOWN=0]="ROUND_DOWN",n[n.ROUND_HALF_UP=1]="ROUND_HALF_UP",n[n.ROUND_UP=2]="ROUND_UP",n))(Ts||{}),Cu=9007199254740991;function Y(i){let e=pe("Raydium_parseBigNumberish");if(i instanceof Do)return i;if(typeof i=="string"){if(i.match(/^-?[0-9]+$/))return new Do(i);e.logWithError(`invalid BigNumberish string: ${i}`)}return typeof i=="number"?(i%1&&e.logWithError(`BigNumberish number underflow: ${i}`),(i>=Cu||i<=-Cu)&&e.logWithError(`BigNumberish number overflow: ${i}`),new Do(String(i))):typeof i=="bigint"?new Do(i.toString()):(e.error(`invalid BigNumberish value: ${i}`),new Do(0))}var tr=pe("module/fraction"),Is=Wo(nr),qo=Wo(md),dd={[0]:qo.ROUND_DOWN,[1]:qo.ROUND_HALF_UP,[2]:qo.ROUND_UP},pd={[0]:nr.roundDown,[1]:nr.roundHalfUp,[2]:nr.roundUp},le=class{numerator;denominator;constructor(e,t=new ld(1)){this.numerator=Y(e),this.denominator=Y(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new le(this.denominator,this.numerator)}add(e){let t=e instanceof le?e:new le(Y(e));return this.denominator.eq(t.denominator)?new le(this.numerator.add(t.numerator),this.denominator):new le(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof le?e:new le(Y(e));return this.denominator.eq(t.denominator)?new le(this.numerator.sub(t.numerator),this.denominator):new le(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof le?e:new le(Y(e));return new le(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof le?e:new le(Y(e));return new le(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||tr.logWithError(`${e} is not an integer.`),e<=0&&tr.logWithError(`${e} is not positive.`),qo.set({precision:e+1,rounding:dd[n]});let o=new qo(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return o.toFormat(o.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||tr.logWithError(`${e} is not an integer.`),e<0&&tr.logWithError(`${e} is negative.`),Is.DP=e,Is.RM=pd[n]||1,new Is(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var yd=pe("Raydium_amount"),or=Wo(fd);function Lu(i,e){let t="0",n="0";if(i.includes(".")){let o=i.split(".");o.length===2?([t,n]=o,n=n.padEnd(e,"0")):yd.logWithError(`invalid number string, num: ${i}`)}else t=i;return[t,n.slice(0,e)||n]}var we=class extends le{token;logger;constructor(e,t,n=!0,o){let r=new Nn(0),s=zn.pow(new Nn(e.decimals));if(n)r=Y(t);else{let a=new Nn(0),c=new Nn(0);if(typeof t=="string"||typeof t=="number"||typeof t=="bigint"){let[u,l]=Lu(t.toString(),e.decimals);a=Y(u),c=Y(l)}a=a.mul(s),r=a.add(c)}super(r,s),this.logger=pe(o||"TokenAmount"),this.token=e}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(e){return this.token.equals(e.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(e.raw)}lt(e){return this.token.equals(e.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(e.raw)}add(e){return this.token.equals(e.token)||this.logger.logWithError("add token not equals"),new we(this.token,this.raw.add(e.raw))}subtract(e){return this.token.equals(e.token)||this.logger.logWithError("sub token not equals"),new we(this.token,this.raw.sub(e.raw))}toSignificant(e=this.token.decimals,t,n=0){return super.toSignificant(e,t,n)}toFixed(e=this.token.decimals,t,n=0){return e>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(e,t,n)}toExact(e={groupSeparator:""}){return or.DP=this.token.decimals,new or(this.numerator.toString()).div(this.denominator.toString()).toFormat(e)}},Qn=class extends le{currency;logger;constructor(e,t,n=!0,o){let r=new Nn(0),s=zn.pow(new Nn(e.decimals));if(n)r=Y(t);else{let a=new Nn(0),c=new Nn(0);if(typeof t=="string"||typeof t=="number"||typeof t=="bigint"){let[u,l]=Lu(t.toString(),e.decimals);a=Y(u),c=Y(l)}a=a.mul(s),r=a.add(c)}super(r,s),this.logger=pe(o||"TokenAmount"),this.currency=e}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(e){return this.currency.equals(e.currency)||this.logger.logWithError("gt currency not equals"),this.raw.gt(e.raw)}lt(e){return this.currency.equals(e.currency)||this.logger.logWithError("lt currency not equals"),this.raw.lt(e.raw)}add(e){return this.currency.equals(e.currency)||this.logger.logWithError("add currency not equals"),new Qn(this.currency,this.raw.add(e.raw))}sub(e){return this.currency.equals(e.currency)||this.logger.logWithError("sub currency not equals"),new Qn(this.currency,this.raw.sub(e.raw))}toSignificant(e=this.currency.decimals,t,n=0){return super.toSignificant(e,t,n)}toFixed(e=this.currency.decimals,t,n=0){return e>this.currency.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(e,t,n)}toExact(e={groupSeparator:""}){return or.DP=this.currency.decimals,new or(this.numerator.toString()).div(this.denominator.toString()).toFormat(e)}};import{PublicKey as bd}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ru}from"@solana/spl-token";var sn={chainId:101,address:bd.default.toBase58(),programId:Ru.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},it={chainId:101,address:"So11111111111111111111111111111111111111112",programId:Ru.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};import{PublicKey as Cs}from"@solana/web3.js";import{PublicKey as Me,SystemProgram as Nu,SYSVAR_RENT_PUBKEY as gd}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ad}from"@solana/spl-token";function A({pubkey:i,isSigner:e=!1,isWritable:t=!0}){return{pubkey:i,isWritable:t,isSigner:e}}var Bs=[A({pubkey:Ad,isWritable:!1}),A({pubkey:Nu.programId,isWritable:!1}),A({pubkey:gd,isWritable:!1})];function xs({publicKey:i,transformSol:e}){let t=Ss(i.toString());if(t instanceof Me)return e&&t.equals(rt)?j:t;if(e&&t.toString()===rt.toBase58())return j;if(typeof t=="string"){if(t===Me.default.toBase58())return Me.default;try{return new Me(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function Ss(i){try{return new Me(i)}catch{return i}}var ir=new Me("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),an=new Me("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),je=new Me("SysvarRent111111111111111111111111111111111"),Ks=new Me("SysvarC1ock11111111111111111111111111111111"),Xt=new Me("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),rr=new Me("Sysvar1nstructions1111111111111111111111111"),sr=Nu.programId,$b=new Me("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Jb=new Me("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),eg=new Me("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),tg=new Me("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),ng=new Me("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),og=new Me("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),ig=new Me("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),rg=new Me("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),sg=new Me("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),ag=new Me("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),ug=new Me("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),j=new Me("So11111111111111111111111111111111111111112"),rt=Me.default;function ft(i){return xs({publicKey:i,transformSol:!0})}var Ls=class{symbol;name;decimals;isToken2022;mint;constructor({mint:e,decimals:t,symbol:n,name:o,skipMint:r=!1,isToken2022:s=!1}){if(e===rt.toBase58()||e instanceof Cs&&rt.equals(e)){this.decimals=it.decimals,this.symbol=it.symbol,this.name=it.name,this.mint=new Cs(it.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=o||e.toString().substring(0,6),this.mint=r?Cs.default:xs({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Te=Ls;Nt(Te,"WSOL",new Ls({...it,mint:it.address}));var Rs=class{symbol;name;decimals;constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},Uo=Rs;Nt(Uo,"SOL",new Rs(sn));function gg(i,e){return i instanceof Te&&e instanceof Te?i.equals(e):i instanceof Te||e instanceof Te?!1:i===e}import Pd from"bn.js";var Ou=new le(new Pd(100)),De=class extends le{toSignificant(e=5,t,n){return this.mul(Ou).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(Ou).toFixed(e,t,n)}};var wd=pe("Raydium_price"),st=class extends le{baseToken;quoteToken;scalar;constructor(e){let{baseToken:t,quoteToken:n,numerator:o,denominator:r}=e;super(o,r),this.baseToken=t,this.quoteToken=n,this.scalar=new le(Ns(t.decimals),Ns(n.decimals))}get raw(){return new le(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new st({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(e){this.quoteToken!==e.baseToken&&wd.logWithError("mul token not equals");let t=super.mul(e);return new st({baseToken:this.baseToken,quoteToken:e.quoteToken,denominator:t.denominator,numerator:t.numerator})}toSignificant(e=this.quoteToken.decimals,t,n){return this.adjusted.toSignificant(e,t,n)}toFixed(e=this.quoteToken.decimals,t,n){return this.adjusted.toFixed(e,t,n)}};function Qe(i){if(i instanceof De)return new le(i.numerator,i.denominator);if(i instanceof st)return i.adjusted;if(i instanceof we)try{return Qe(i.toExact())}catch{return new le(ze)}if(i instanceof le)return i;let e=String(i),t=Hn(e);return new le(t.numerator,t.denominator)}function Fg(i){if(i instanceof De)return{fr:new le(i.numerator,i.denominator)};if(i instanceof st)return{fr:i.adjusted};if(i instanceof we)return{fr:Qe(i.toExact()),decimals:i.token.decimals};if(i instanceof le)return{fr:i};let e=String(i),t=Hn(e);return{fr:new le(t.numerator,t.denominator),decimals:t.dec?.length}}function Vg(i,e){if(i==null||e==null)return!1;let t=Qe(i),n=Qe(e);return t.sub(n).numerator,t.sub(n).numerator.lt(ze)}function kd(i,e){if(i==null||e==null)return!1;let t=Qe(i),n=Qe(e);return t.sub(n).numerator.gt(ze)}function Wg(i,e){if(i==null||e==null)return!1;let t=Qe(i),n=Qe(e);return t.sub(n).numerator.lte(ze)}function Dg(i,e){if(i==null||e==null)return!1;let t=Qe(i),n=Qe(e);return t.sub(n).numerator.gte(ze)}function hd(i,e){if(i==null||e==null)return!1;let t=Qe(i),n=Qe(e);return t.sub(n).numerator.eq(ze)}function qg(i,e){if(i==null||e==null)return;let t=Qe(i),n=Qe(e);try{return t.div(n)}catch{return t}}function Ug(i,e){if(i==null||e==null)return;let t=Qe(i),n=Qe(e);return t.sub(n)}function Gg(i){return i==null?!1:!hd(i,0)}function Xg(i,e){return kd(e,i)?e:i}function Os(i,e){if(i==null||e==null)return;let t=Qe(i),n=Qe(e);return t.mul(n)}function Qg(i,e){if(i==null||e==null)return;let t=Qe(i),n=Qe(e);return t.add(n)}import{PublicKey as Td}from"@solana/web3.js";import Id from"bn.js";async function vu(i){new Promise(e=>setTimeout(e,i))}function $g(){return new Date().getTime()}function vs(i){return typeof i=="object"&&i!==null&&![Te,we,Td,le,Id,st,De].some(e=>typeof e=="object"&&i instanceof e)}function Re(i){return typeof i=="string"?Ss(i):Array.isArray(i)?i.map(e=>Re(e)):vs(i)?Object.fromEntries(Object.entries(i).map(([e,t])=>[e,Re(t)])):i}var ze=new qe(0),_u=new qe(1),mA=new qe(2),dA=new qe(3),pA=new qe(5),zn=new qe(10),fA=new qe(100),yA=new qe(1e3),bA=new qe(1e4);function Ns(i){return zn.pow(Y(i))}function Hn(i){if(i===void 0)return{denominator:"1",numerator:"0"};if(i instanceof qe)return{numerator:i.toString(),denominator:"1"};if(i instanceof le)return{denominator:i.denominator.toString(),numerator:i.numerator.toString()};let e=String(i),[,t="",n="",o=""]=e.replace(",","").match(/(-?)(\d*)\.?(\d*)/)??[],r="1"+"0".repeat(o.length),s=t+(n==="0"?"":n)+o||"0";return{denominator:r,numerator:s,sign:t,int:n,dec:o}}function ar(i,e){let t=i.divmod(e);return t.mod.isZero()?t.div:t.div.isNeg()?t.div.isubn(1):t.div.iaddn(1)}function Bd(i){let[,e="",t=""]=i.toFixed(2).match(/(-?)(\d*)\.?(\d*)/)??[];return`${e}${t}`}function xd(i,e=0){return i instanceof qe?i:new qe(Bd(Fu(i).mul(zn.pow(new qe(String(e))))))}function Fu(i){if(i instanceof De)return new le(i.numerator,i.denominator);if(i instanceof st)return i.adjusted;if(i instanceof we)try{return Fu(i.toExact())}catch{return new le(ze)}if(i instanceof le)return i;let e=String(i),t=Hn(e);return new le(t.numerator,t.denominator)}function ur(i,e,t){return i.mul(e).add(t).sub(new qe(1)).div(t)}function Ms(i,e,t){return i.mul(e).div(t)}function gA(i,e){let{numerator:t,denominator:n}=Hn(i);return new De(new qe(t),new qe(n).mul(e?.alreadyDecimaled?new qe(100):new qe(1)))}function AA(i){let{token:e,numberPrice:t,decimalDone:n}=i,o=new Te({mint:"",decimals:6,symbol:"usd",name:"usd",skipMint:!0}),{numerator:r,denominator:s}=Hn(t),a=n?new qe(r).mul(zn.pow(new qe(e.decimals))):r,c=new qe(s).mul(zn.pow(new qe(o.decimals)));return new st({baseToken:o,denominator:c.toString(),quoteToken:new Te({...e,skipMint:!0,mint:""}),numerator:a.toString()})}function Mu(i){let e=new Uo({decimals:6,symbol:"usd",name:"usd"}),t=xd(Os(i,10**e.decimals));return new Qn(e,t)}function PA(i,e){return Mu(!e||!i?0:Os(i,e))}function Sd(i){if(i==null)return;let{numerator:e,denominator:t}=Hn(i.toString());return new le(e,t)}function Kd(i){return i instanceof C}function Eu(i){return Kd(i)?Sd(i):Array.isArray(i)?i.map(e=>Eu(e)):vs(i)?Object.fromEntries(Object.entries(i).map(([e,t])=>[e,Eu(t)])):i}var Vu=i=>typeof i=="number",Wu=i=>i?new Date(i):new Date,Cd=i=>Wu(i).getTime();function Du(i,e,t){let n=Vu(e)?e*(t?.unit==="s"?1e3:1):e;return new Date(i).getTime()<=n}function qu(i,e,t){let n=Vu(e)?e*(t?.unit==="s"?1e3:1):e;return new Date(i).getTime()>n}function kA(i,e){let n=Cd(i)+(e.days?e.days*24*60*60*1e3:0)+(e.hours?e.hours*60*60*1e3:0)+(e.minutes?e.minutes*60*1e3:0)+(e.seconds?e.seconds*1e3:0)+(e.milliseconds?e.milliseconds:0);return Wu(n)}function bs(i,e=1,t=[]){let n=[...i];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}function TA(i,...e){return i.filter(t=>e.every(n=>n.includes(t)))}function IA(i,...e){return i.filter(t=>e.every(n=>!n.includes(t)))}function BA(i){return[...new Set(i)]}var Qt=class{_owner;constructor(e){this._owner=e}get publicKey(){return Qt.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return Qt.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return Qt.isKeyPair(this._owner)}get isPublicKey(){return Qt.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!Qt.isKeyPair(e)}};import{PublicKey as vd}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Md}from"@solana/spl-token";import{ComputeBudgetProgram as Uu,Keypair as Gu,PublicKey as Xu,Transaction as lr,TransactionMessage as Ld,VersionedTransaction as Es}from"@solana/web3.js";var On=(t=>(t[t.V0=0]="V0",t[t.LEGACY=1]="LEGACY",t))(On||{}),V={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",ClmmLockPosition:"ClmmLockPosition",ClmmHarvestLockPosition:"ClmmHarvestLockPosition",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV4Withdraw:"FarmV4Withdraw",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut",CpmmLockLp:"CpmmLockLp",CpmmCollectLockFee:"CpmmCollectLockFee",TransferTip:"TransferTip",NonceAccount:"NonceAccount"};import{TOKEN_PROGRAM_ID as Rd}from"@solana/spl-token";var gn=pe("Raydium_txUtil"),Qu=1644;function bo(i){let e=[],t=[];return i.microLamports&&(e.push(Uu.setComputeUnitPrice({microLamports:i.microLamports})),t.push(V.SetComputeUnitPrice)),i.units&&(e.push(Uu.setComputeUnitLimit({units:i.units})),t.push(V.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function go(i,e){let t=e??"confirmed";return(await i.getLatestBlockhash?.({commitment:t}))?.blockhash}async function mr(i,e){return i.getSignatureStatuses([e]),new Promise((t,n)=>{let o=setTimeout(n,6e4);i.onSignature(e,r=>{if(clearTimeout(o),!r.err){t("");return}n(Object.assign(r.err,{txId:e}))},"confirmed")})}function dr(i,e){i.length<1&&gn.logWithError(`no instructions provided: ${i.toString()}`),e.length<1&&gn.logWithError(`no signers provided:, ${e.toString()}`);let t=new lr;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...i);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<Qu}catch{return!1}}async function zu(i,e,t,n=!0){let o=new Xu("RaydiumSimuLateTransaction11111111111111111"),r=[],s=new lr;s.feePayer=o;for(let u of e)dr([...s.instructions,u],[o])||(r.push(s),s=new lr,s.feePayer=o),s.add(u);s.instructions.length>0&&r.push(s);let a=[];try{if(a=await Nd(i,r,n),a.find(u=>u.err!==null))throw Error("rpc simulateTransaction error")}catch(u){u instanceof Error&&gn.logWithError("failed to simulate for instructions","RPC_ERROR",{message:u.message})}let c=[];for(let u of a)if(gn.debug("simulate result:",u),u.logs){let l=u.logs.filter(d=>d&&d.includes(t));gn.debug("filteredLog:",c),l.length||gn.logWithError("simulate log not match keyword","keyword",t),c.push(...l)}return c}function Hu(i,e){let t=i.match(/{["\w:,]+}/g);return!t||t.length!==1?gn.logWithError(`simulate log fail to match json, keyword: ${e}`):t[0]}function An(i,e){let n=new RegExp(`"${e}":(\\d+)`,"g").exec(i);return!n||n.length!==2?gn.logWithError(`simulate log fail to match key", key: ${e}`):n[1]}function ee(i,e){let[t,n]=Xu.findProgramAddressSync(i,e);return{publicKey:t,nonce:n}}async function Nd(i,e,t){let n=[];if(t){let o=await i.getLatestBlockhash(),r=[];for(let u of e){u.recentBlockhash=o.blockhash,u.lastValidBlockHeight=o.lastValidBlockHeight;let d=u._compile().serialize(),p=u._serialize(d).toString("base64");r.push(p)}let s=r.map(u=>{let l=i._buildArgs([u],void 0,"base64");return{methodName:"simulateTransaction",args:l}}),a=[],c=20;for(let u=0;u<Math.ceil(s.length/c);u++)a.push(s.slice(u*c,(u+1)*c));n=await(await Promise.all(a.map(async u=>(await i._rpcBatchRequest(u)).map(l=>l.result.value)))).flat()}else try{n=await Promise.all(e.map(async o=>await(await i.simulateTransaction(o)).value))}catch(o){o instanceof Error&&gn.logWithError("failed to get info for multiple accounts","RPC_ERROR",{message:o.message})}return n}function Go({instructions:i,payer:e,signers:t}){return dr(i,[e,...t])}function Xo({instructions:i,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=Gu.generate().publicKey.toString()}){let r=new Ld({payerKey:e,recentBlockhash:n,instructions:i}).compileToV0Message(Object.values(t??{}));try{return Buffer.from(new Es(r).serialize()).toString("base64").length<Qu}catch{return!1}}var cr={time:0,data:void 0};async function FA(i){if(!cr.data||(Date.now()-cr.time)/1e3>30){let e=await i.getEpochInfo();return cr={time:Date.now(),data:e},e}else return cr.data}var ju=i=>Buffer.isBuffer(i)?i:i instanceof Uint8Array?Buffer.from(i.buffer,i.byteOffset,i.byteLength):Buffer.from(i),Od=i=>{let e=i.serialize({requireAllSignatures:!1,verifySignatures:!1});i instanceof Es&&(e=ju(e));try{return e instanceof Buffer?e.toString("base64"):Buffer.from(e).toString("base64")}catch{return e.toString("base64")}};function jn(i){let e=[];return i.forEach(t=>{t instanceof lr&&(t.recentBlockhash||(t.recentBlockhash=Rd.toBase58()),t.feePayer||(t.feePayer=Gu.generate().publicKey)),e.push(Od(t))}),console.log("simulate tx string:",e),e}function VA(i){let e=i.serialize({requireAllSignatures:!1,verifySignatures:!1});return i instanceof Es&&(e=ju(e)),e.toString("base64")}function Z(i,e,t){return ee([i.toBuffer(),(t??Md).toBuffer(),e.toBuffer()],new vd("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import{PublicKey as ce}from"@solana/web3.js";var _s=new ce("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),Yu=new ce("CBuCnLe26faBpcBP2fktp4rp8abpcAnTWft6ZrP5Q4T"),Fs=new ce("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),Ao=new ce("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),Ed=new ce("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),Vs=new ce("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),pr=new ce("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),Qo=new ce("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),_d=new ce("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),fr=new ce("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),vn=new ce("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),Po=new ce("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),zo=new ce("kN1kEznaF5Xbd8LYuqtEFcxzWSBk5Fv6ygX6SqEGJVy"),Fd=new ce("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),Zu=new ce("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),Vd=new ce("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),Wd=new ce("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),Dd=new ce("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),qd=new ce("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),Ho=new ce("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),Ws=new ce("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),Ud=new ce("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),Gd=new ce("CPMDWBwJDtYax9qW7AyRuVC19Cc4L4Vcy4n2BHAbHkCW"),Xd=new ce("7rQ1QFNosMkUCuh7Z7fPbTHvh73b68sQYdirycEzJVuw"),Qd=new ce("G11FKBRaAkHAKuLCgLM6K6NUc9rTjPAznRCjZifrTQe2"),jo=new ce("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),zd=new ce("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),Yo=new ce("3f7GcQFG397GAaEnv51zR6tsTVihYRydnydDD1cXekxH"),Hd=new ce("7AFUeLVRjBfzqK3tTGw8hN48KLQWSk6DTE8xprWdPqix"),zt=new ce("LanMV9sAd7wArD4vJFi2qDdfnVhFxYSUg6eADduJ3uj"),jd=new ce("WLHv2UAZm6z4KyaaELi5pjdbJh6RESMva1Rnn8pJVVh"),Yd=new ce("LanD8FpTBBvzZFXjTxsAoipkFsxPUCDB4qAqKxYDiNP"),Zd=new ce("HYNHiyKJ3gGVFvyxJAurK7qr7P2o5J9THmvCGMdULtpW"),Zo={IDO_PROGRAM_ID_V1:Vd,IDO_PROGRAM_ID_V2:Wd,IDO_PROGRAM_ID_V3:Dd,IDO_PROGRAM_ID_V4:qd},wt={AMM_V4:Qo,AMM_STABLE:_d,CLMM_PROGRAM_ID:vn,CLMM_LOCK_PROGRAM_ID:Po,CLMM_LOCK_AUTH_ID:zo,FARM_PROGRAM_ID_V3:_s,FARM_PROGRAM_ID_V5:Fs,FARM_PROGRAM_ID_V6:Ao,OPEN_BOOK_PROGRAM:Vs,SERUM_PROGRAM_ID_V3:pr,UTIL1216:Ed,Router:Fd,CREATE_CPMM_POOL_PROGRAM:Ho,CREATE_CPMM_POOL_AUTH:Ws,CREATE_CPMM_POOL_FEE_ACC:Ud,LOCK_CPMM_PROGRAM:jo,LOCK_CPMM_AUTH:Yo,LAUNCHPAD_PROGRAM:zt,LAUNCHPAD_AUTH:jd},QA={SERUM_MARKET:ce.default,OPENBOOK_MARKET:new ce("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),UTIL1216:ce.default,FarmV3:new ce("85BFyr98MbCUU9MVTEgzx1nbhWACbJqLzho6zd6DZcWL"),FarmV5:new ce("EcLzTrNg9V7qhcdyXDe2qjtPkiGzDM2UbdRaeaadU5r2"),FarmV6:new ce("Farm2hJLcqPtPg8M4rR6DMrsRNc5TPm5Cs4bVQrMe2T7"),AmmV4:new ce("HWy1jotHpo6UqeQxx49dpYYdQB8wj9Qk9MdxwjLvDHB8"),AmmStable:new ce("DDg4VmQaJV9ogWce7LpcjBA9bv22wRp5uaTPa5pGjijF"),CLMM:new ce("devi51mZmdwUJGU9hjN27vEz64Gps7uUefqxg27EAtH"),CLMM_LOCK_PROGRAM_ID:new ce("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),CLMM_LOCK_AUTH_ID:new ce("8qmHNvu2Kr2C7U8mJL4Vz1vTDxMhVuXKREwU7TNoaVEo"),Router:new ce("BVChZ3XFEwTMUk1o9i3HAf91H6mFxSwa5X2wFAWhYPhU"),CREATE_CPMM_POOL_PROGRAM:Gd,CREATE_CPMM_POOL_AUTH:Xd,CREATE_CPMM_POOL_FEE_ACC:Qd,FEE_DESTINATION_ID:new ce("3XMrhbv989VxAMi3DErLV9eJht1pHppW5LbKxe9fkEFR"),LOCK_CPMM_PROGRAM:zd,LCOK_CPMM_AUTH:Hd,LAUNCHPAD_PROGRAM:Yd,LAUNCHPAD_AUTH:Zd};import Ee from"bn.js";var un=1e4;function jA(i,e,t,n){if(e===void 0)return{amount:i,fee:void 0,expirationTime:void 0};let o=t.epoch<e.newerTransferFee.epoch?e.olderTransferFee:e.newerTransferFee,r=new Ee(o.maximumFee.toString()),s=t.epoch<e.newerTransferFee.epoch?(Number(e.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(o.transferFeeBasisPoints===un){let a=new Ee(o.maximumFee.toString());return{amount:i.add(a),fee:a,expirationTime:s}}else{let a=Ht(i.mul(new Ee(un)),new Ee(un-o.transferFeeBasisPoints)),c=new Ee(o.maximumFee.toString()),u=a.sub(i).gt(c)?i.add(c):a,l=Ht(u.mul(new Ee(o.transferFeeBasisPoints)),new Ee(un)),d=l.gt(r)?r:l;return{amount:u,fee:d,expirationTime:s}}else{let a=Ht(i.mul(new Ee(o.transferFeeBasisPoints)),new Ee(un)),c=a.gt(r)?r:a;return{amount:i,fee:c,expirationTime:s}}}function ke(i,e,t,n){if(e===void 0)return{amount:i,fee:void 0,expirationTime:void 0};let o={...e,olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}},r=t.epoch<o.newerTransferFee.epoch?o.olderTransferFee:o.newerTransferFee,s=new Ee(r.maximumFee.toString()),a=t.epoch<o.newerTransferFee.epoch?(Number(o.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(r.transferFeeBasisPoints===un){let c=new Ee(r.maximumFee.toString());return{amount:i.add(c),fee:c,expirationTime:a}}else{let c=Ht(i.mul(new Ee(un)),new Ee(un-r.transferFeeBasisPoints)),u=new Ee(r.maximumFee.toString()),l=c.sub(i).gt(u)?i.add(u):c,d=Ht(l.mul(new Ee(r.transferFeeBasisPoints)),new Ee(un)),m=d.gt(s)?s:d;return{amount:l,fee:m,expirationTime:a}}else{let c=Ht(i.mul(new Ee(r.transferFeeBasisPoints)),new Ee(un)),u=c.gt(s)?s:c;return{amount:i,fee:u,expirationTime:a}}}function jt(i,e){return i===void 0?e:e===void 0?i:Math.min(i,e)}function Ht(i,e){let{div:t,mod:n}=i.divmod(e);return n.gt(new Ee(0))?t.add(new Ee(1)):t}function yr(i,e){if(i.isZero())return new Ee(0);let t=i.div(e);return t.isZero()?new Ee(1):i.mod(e).gt(new Ee(0))?t.add(new Ee(1)):t}import{PublicKey as $u,AddressLookupTableAccount as br}from"@solana/web3.js";async function Ds({connection:i,address:e}){let t=await qt(i,[...new Set(e.map(o=>o.toString()))].map(o=>new $u(o))),n={};for(let o=0;o<e.length;o++){let r=t[o],s=e[o];if(!r)continue;let a=new br({key:s,state:br.deserialize(r.data)});n[s.toString()]=a,gr[s.toString()]=a}return n}var gr={AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU:new br({key:new $u("AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU"),state:br.deserialize(Buffer.from("AQAAAP//////////I1rcEwAAAAAvAQYwun9CU6c5Ikm2pAj+D9IEnCOR45nK+SFTGSdpd6J6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAbd9uHXZaGT2cvhRs7reawctIXtX1s3kTqM9YV+/wCpBt324e51j94YQl285GzN2rYa/E2DuQ0n/r35KNihi/wFSlNQ+F3IgtYUpVZyeIopbd8eq6vQpgZ4iEky9O72oAVKU1qZKSEGTSTocWDaOHx8NbXdvJK7geQfqEBBBUSNBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvBkX2T9y7AHdNGviJAqQNtlDUDCnauQRWybsLji6nPM8Qkw5asQRvCdB3MbX6IEBwytOrpM32l4jQygKG9TKgR0vZScQ2AsM/IHeQ7RajUkyhuZdc8SGiqQz/7H34torNR/Wir3sl0ruUrVxJWEZfUg+QLNAxxODdBi53/OP7Ioil1cqeBM9dtZC3FLov4yyxWRM/wcGStyJX/QfTnLBAHqkqWotPKVlShCVQqpP9W5W1rOao65IMk5QuQ2kMIOxzDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu/YsA/yfEEFGcr8Z57VKDw8uQzpiru7g4lvjnfapW62W030syevD8k07SGoxUHiuT/ai7gAHWWhDsVmg/C63ajgpkH7Sn3GdutArDTfyqOkdqv4/IPC/EFFy7mGkfDd2C57N5a/4jC+BbmJy7wQaSEZr0CQU88lPtUxIVvzGjC95b8Ooss2TqmkrayGKofkPMGQn7Ux+9lfwBSNfxwH8NgbpqC/7LNlV4I7nCvsXf3p+ohQk9NrAJb2KAFpUqEIJ9ZBV7BYDzHF/ORKYlgtvPnXjudZQ6CEo5OzUDaNIomTCCsvhD16TxJjsbgne1kGnQPCFSoaxUbq2V1bPMFQ3VYP6wDZ9bKStCFKx9A3tNbwZFC5ZGAN83MFK7XoTy+OmmcFEr6rLOjfSuTfPvHJkSVxW6Qllwkl67XcBi5v00u2gQsbu+38sp+rd5pA/LvyWj4P94ZGZwc1tE2P88xekCLcAwZGb+UhFzL/7K26csOb57yM5bvF9xJrLEObOkAAAAAn+HWRkdcPKyFFMnVwEoD7vnD0jCKFIU1sImubYCxNTSVzsKpaQX+fzNxrLAI3L14JQnJx/D6Uk2LADIHGqnGELzjEbkBDAlaM77NkXMPfqXNLSveCkWI7UEgNs31WEWB6XHSYI/v5DklHOb4QTtDOR804PVbi3fjloZeLR2F8d4FuZmMMO7ck3Fnkn2zEMG5gOmqsygb6PjTitArVl52NhcSznTxVnguaIJxiZkAnurDmn3MWR0PC2GLghp2KJqHCc6QQ85odeIjFHKOlRlJyeSXVJmL8vb1UgOzsbJPVP8p6zM4M3C1Sd7uWIHP33G42AP2Zg8ucn/n6meQjjD266JgCWdxZD6PXs9CsnIeL7SSG0/6lGb9xfP0ZcWkCXB/3hjxHYVXjra/GPOeXGk0fLLKjCbk+mgs2w6d2oCwimBipTzuoZ30GiI8ij8VRzD5CzMWtu2m21eDBIfjGAEo4pQeNNonKcqzV/cleX8ySZLOHsz8PtBCrLqF+VkLm9hOzIT+6i/nIf6keR4GWKMOD4AvqfpjHoD4DuhBpz8P28+DxkGrDXXr/nr20x291VPvcTU/b+b+o2kC9G0kcXeTlLjU6a2TQXWlZ4gBUdBl1jgT7mObSTpLblNiXZsLkbmVXZwvFKXua5cUKlWed/w30skmEUraTuQqtqr5fHZPW9n57EmeTif6LjHL2YJFZkQU+TrJmFzqzmF4/b8OwrPQAprl8mX3q4LUIdAS/a+11B6DWD1Xk2++Sn94dLC4xjkO4Wtlw8c4XuzciVbepHOmnoWzVu/0y3KCrLCSfQxQ3br8DJCoVzhgtPsS2nZZjsBGIZgnU0QpMv+2MnRsnKwdp1VsrCX84j/qvaZn4WhKunippgTbN2EUs0tPTP55Qfgj+nKmjtWW5IYs72FrEwJKYoNfsmqaF4o5pf4v9zgPwVwY/5I4XJKUL2L25m9kAQcW/K+H1RTFEUoj8Z4ajpOmAB/dG0COmCphVMW2CCMvnxhcGiSgPnpDuWu6qiJ7NG7ye5kvHgefgqPLeicspNJ5EpL3XiRNLM2tmJLI1awAwOyd6iHv0dCkMYRKaa6rcaZeYwmKCkckm0kM2JNmnmmAaBQQ7mwmIM0IMxX4f5W6j9PqZWcJxF7r17T/lQBAmcjoupRiJifbnXCNUv9GhpRF19WcBdeKbivRJVlGop6I2RS6lGImJ9udcI1S/0aGlEXX1ZwF14puK9ElWUainojZFYVHLHD6dIP2ESjqBzg3ol1/wB7+/ylGwd9LS7wSZ2A630CJSVKwH47K9P4bB8PEQP8BwjMFa7xQHOqZFP1XqaQ==","base64"))})};import{PublicKey as wo,sendAndConfirmTransaction as qs,SystemProgram as $d,Transaction as $o,TransactionMessage as Jo,VersionedTransaction as ei}from"@solana/web3.js";import Jd from"axios";var Ar=2e3,Pr=class{connection;owner;instructions=[];endInstructions=[];lookupTableAddress=[];signers=[];instructionTypes=[];endInstructionTypes=[];feePayer;cluster;signAllTransactions;blockhashCommitment;loopMultiTxStatus;constructor(e){this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster,this.blockhashCommitment=e.blockhashCommitment,this.loopMultiTxStatus=!!e.loopMultiTxStatus}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){let e=(await Jd.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=e?.[15]??{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=bo(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}addTipInstruction(e){return e?(this.endInstructions.push($d.transfer({fromPubkey:e.feePayer??this.feePayer,toPubkey:new wo(e.address),lamports:BigInt(e.amount.toString())})),this.endInstructionTypes.push(V.TransferTip),!0):!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:o=[],endInstructionTypes:r=[],lookupTableAddress:s=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...o),this.endInstructionTypes.push(...r),this.lookupTableAddress.push(...s.filter(a=>a!==wo.default.toString())),this}async versionBuild({txVersion:e,extInfo:t},n){return e===0?await this.buildV0({...t||{}},n):this.build(t,n)}build(e,t){let n=new $o;return this.allInstructions.length&&n.add(...this.allInstructions),n.feePayer=this.feePayer,this.owner?.signer&&!this.signers.some(o=>o.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer),{builder:this,transaction:n,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async o=>{let{recentBlockHash:r,skipPreflight:s=!0,sendAndConfirm:a,notSendToRpc:c}=o||{},u=r??t??await go(this.connection,this.blockhashCommitment);if(n.recentBlockhash=u,this.signers.length&&n.sign(...this.signers),jn([n]),this.owner?.isKeyPair)return{txId:a?await qs(this.connection,n,this.signers.find(d=>d.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:s}):await this.connection.sendRawTransaction(n.serialize(),{skipPreflight:s}),signedTx:n};if(this.signAllTransactions){let l=await this.signAllTransactions([n]);if(this.signers.length)for(let d of l)try{d.sign(...this.signers)}catch{}return{txId:c?"":await this.connection.sendRawTransaction(l[0].serialize(),{skipPreflight:s}),signedTx:l[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:o}=this.build(n),r=t.filter(u=>u.transaction.instructions.length>0),s=[o,...r.map(u=>u.transaction)],a=[this.signers,...r.map(u=>u.signers)],c=[...this.instructionTypes,...r.map(u=>u.instructionTypes).flat()];return this.owner?.signer&&a.forEach(u=>{u.some(l=>l.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:c,execute:async u=>{let{sequentially:l,onTxUpdate:d,skipTxCount:m=0,recentBlockHash:p,skipPreflight:y=!0}=u||{},f=p??await go(this.connection,this.blockhashCommitment);if(this.owner?.isKeyPair){if(l){let b=[],g=0;for(let w of s){if(++g,g<=m)continue;let k=await qs(this.connection,w,this.signers.find(h=>h.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:y});b.push(k)}return{txIds:b,signedTxs:s}}return{txIds:await await Promise.all(s.map(async b=>(b.recentBlockhash=f,await this.connection.sendRawTransaction(b.serialize(),{skipPreflight:y})))),signedTxs:s}}if(this.signAllTransactions){let b=s.map((w,k)=>(w.recentBlockhash=f,a[k].length&&w.sign(...a[k]),w));jn(b);let g=await this.signAllTransactions(b);if(l){let w=0,k=[],h=async()=>{if(!g[w])return;let x=await this.connection.sendRawTransaction(g[w].serialize(),{skipPreflight:y});k.push({txId:x,status:"sent",signedTx:g[w]}),d?.([...k]),w++;let T=!1,B=null,S=null,I=K=>{B!==null&&clearInterval(B),S!==null&&this.connection.removeSignatureListener(S);let O=k.findIndex(v=>v.txId===x);if(O>-1){if(k[O].status==="error"||k[O].status==="success")return;k[O].status=K.err?"error":"success"}d?.([...k]),K.err||h()};this.loopMultiTxStatus&&(B=setInterval(async()=>{if(T){clearInterval(B);return}try{let K=await this.connection.getTransaction(x,{commitment:"confirmed",maxSupportedTransactionVersion:0});K&&(T=!0,clearInterval(B),I({err:K.meta?.err||null}),console.log("tx status from getTransaction:",x))}catch(K){T=!0,clearInterval(B),console.error("getTransaction timeout:",K,x)}},Ar)),S=this.connection.onSignature(x,K=>{if(T){this.connection.removeSignatureListener(S);return}T=!0,I(K)},"confirmed"),this.connection.getSignatureStatus(x)};return await h(),{txIds:k.map(x=>x.txId),signedTxs:g}}else{let w=[];for(let k=0;k<g.length;k+=1){let h=await this.connection.sendRawTransaction(g[k].serialize(),{skipPreflight:y});w.push(h)}return{txIds:w,signedTxs:g}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e,t){let{lookupTableCache:n={},lookupTableAddress:o=[],forerunCreate:r,recentBlockhash:s,...a}=e||{},c={...this.cluster==="devnet"?{}:gr,...n},u=Array.from(new Set([...o,...this.lookupTableAddress])),l=[];for(let y of u)c[y]===void 0&&l.push(new wo(y));if(l.length>0){let y=await Ds({connection:this.connection,address:l});for(let[f,b]of Object.entries(y))c[f]=b}let d=t??(r?wo.default.toBase58():s??await go(this.connection,this.blockhashCommitment)),m=new Jo({payerKey:this.feePayer,recentBlockhash:d,instructions:[...this.allInstructions]}).compileToV0Message(Object.values(c));this.owner?.signer&&!this.signers.some(y=>y.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer);let p=new ei(m);return p.sign(this.signers),{builder:this,transaction:p,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async y=>{let{skipPreflight:f=!0,sendAndConfirm:b,notSendToRpc:g}=y||{};if(jn([p]),this.owner?.isKeyPair){let w=await this.connection.sendTransaction(p,{skipPreflight:f});return b&&await mr(this.connection,w),{txId:w,signedTx:p}}if(this.signAllTransactions){let w=await this.signAllTransactions([p]);if(this.signers.length)for(let k of w)try{k.sign(this.signers)}catch{}return{txId:g?"":await this.connection.sendTransaction(w[0],{skipPreflight:f}),signedTx:w[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:a||{}}}async buildV0MultiTx(e){let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:o}=await this.buildV0(n),r=t.filter(u=>u.builder.instructions.length>0),s=[o,...r.map(u=>u.transaction)],a=[this.signers,...r.map(u=>u.signers)],c=[...this.instructionTypes,...r.map(u=>u.instructionTypes).flat()];return this.owner?.signer&&a.forEach(u=>{u.some(l=>l.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),s.forEach(async(u,l)=>{u.sign(a[l])}),{builder:this,transactions:s,signers:a,instructionTypes:c,buildProps:n,execute:async u=>{let{sequentially:l,onTxUpdate:d,recentBlockHash:m,skipPreflight:p=!0}=u||{};if(m&&s.forEach(y=>y.message.recentBlockhash=m),jn(s),this.owner?.isKeyPair){if(l){let y=[];for(let f of s){let b=await this.connection.sendTransaction(f,{skipPreflight:p});await mr(this.connection,b),y.push(b)}return{txIds:y,signedTxs:s}}return{txIds:await Promise.all(s.map(async y=>await this.connection.sendTransaction(y,{skipPreflight:p}))),signedTxs:s}}if(this.signAllTransactions){let y=await this.signAllTransactions(s);if(l){let f=0,b=[],g=async()=>{if(!y[f])return;let w=await this.connection.sendTransaction(y[f],{skipPreflight:p});b.push({txId:w,status:"sent",signedTx:y[f]}),d?.([...b]),f++;let k=!1,h=null,x=null,T=B=>{h!==null&&clearInterval(h),x!==null&&this.connection.removeSignatureListener(x);let S=b.findIndex(I=>I.txId===w);if(S>-1){if(b[S].status==="error"||b[S].status==="success")return;b[S].status=B.err?"error":"success"}d?.([...b]),B.err||g()};this.loopMultiTxStatus&&(h=setInterval(async()=>{if(k){clearInterval(h);return}try{let B=await this.connection.getTransaction(w,{commitment:"confirmed",maxSupportedTransactionVersion:0});B&&(k=!0,clearInterval(h),T({err:B.meta?.err||null}),console.log("tx status from getTransaction:",w))}catch(B){k=!0,clearInterval(h),console.error("getTransaction timeout:",B,w)}},Ar)),x=this.connection.onSignature(w,B=>{if(k){this.connection.removeSignatureListener(x);return}k=!0,T(B)},"confirmed"),this.connection.getSignatureStatus(w)};return g(),{txIds:[],signedTxs:y}}else{let f=[];for(let b=0;b<y.length;b+=1){let g=await this.connection.sendTransaction(y[b],{skipPreflight:p});f.push(g)}return{txIds:f,signedTxs:y}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){let{splitIns:t=[],computeBudgetConfig:n,...o}=e||{},r=n?bo(n):{instructions:[],instructionTypes:[]},s=this.signers.reduce((d,m)=>({...d,[m.publicKey.toBase58()]:m}),{}),a=[],c=[],u=[],l=0;if(this.allInstructions.forEach(d=>{let m=[...u,d],p=n?[...r.instructions,...m]:m,f=[...new Set(m.map(b=>b.keys.filter(g=>g.isSigner).map(g=>g.pubkey.toString())).flat()).values()].map(b=>new wo(b));if(d!==t[l]&&u.length<12&&(Go({instructions:p,payer:this.feePayer,signers:f})||Go({instructions:m,payer:this.feePayer,signers:f})))u.push(d);else{if(u.length===0)throw Error("item ins too big");l+=d===t[l]?1:0,Go({instructions:n?[...r.instructions,...u]:[...u],payer:this.feePayer,signers:f})?a.push(new $o().add(...r.instructions,...u)):a.push(new $o().add(...u)),c.push(Array.from(new Set(u.map(b=>b.keys.filter(g=>g.isSigner).map(g=>g.pubkey.toString())).flat())).map(b=>s[b]).filter(b=>b!==void 0)),u=[d]}}),u.length>0){let m=[...new Set(u.map(p=>p.keys.filter(y=>y.isSigner).map(y=>y.pubkey.toString())).flat()).values()].map(p=>s[p]).filter(p=>p!==void 0);Go({instructions:n?[...r.instructions,...u]:[...u],payer:this.feePayer,signers:m.map(p=>p.publicKey)})?a.push(new $o().add(...r.instructions,...u)):a.push(new $o().add(...u)),c.push(m)}return a.forEach(d=>d.feePayer=this.feePayer),this.owner?.signer&&c.forEach(d=>{d.some(m=>m.publicKey.equals(this.owner.publicKey))||d.push(this.owner.signer)}),{builder:this,transactions:a,signers:c,instructionTypes:this.instructionTypes,execute:async d=>{let{sequentially:m,onTxUpdate:p,skipTxCount:y=0,recentBlockHash:f,skipPreflight:b=!0}=d||{},g=f??await go(this.connection,this.blockhashCommitment);if(a.forEach(async(w,k)=>{w.recentBlockhash=g,c[k].length&&w.sign(...c[k])}),jn(a),this.owner?.isKeyPair){if(m){let w=0,k=[];for(let h of a){if(++w,w<=y){k.push("tx skipped");continue}let x=await qs(this.connection,h,this.signers.find(T=>T.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:b});k.push(x)}return{txIds:k,signedTxs:a}}return{txIds:await Promise.all(a.map(async w=>await this.connection.sendRawTransaction(w.serialize(),{skipPreflight:b}))),signedTxs:a}}if(this.signAllTransactions){let w=await this.signAllTransactions(a.slice(y,a.length)),k=[...a.slice(0,y),...w];if(m){let h=0,x=[],T=async()=>{if(!k[h])return;h<y&&(x.push({txId:"",status:"success",signedTx:k[h]}),p?.([...x]),h++,T());let B=await this.connection.sendRawTransaction(k[h].serialize(),{skipPreflight:b});x.push({txId:B,status:"sent",signedTx:k[h]}),p?.([...x]),h++;let S=!1,I=null,K=null,O=v=>{I!==null&&clearInterval(I),K!==null&&this.connection.removeSignatureListener(K);let _=x.findIndex(D=>D.txId===B);if(_>-1){if(x[_].status==="error"||x[_].status==="success")return;x[_].status=v.err?"error":"success"}p?.([...x]),v.err||T()};this.loopMultiTxStatus&&(I=setInterval(async()=>{if(S){clearInterval(I);return}try{let v=await this.connection.getTransaction(B,{commitment:"confirmed",maxSupportedTransactionVersion:0});v&&(S=!0,clearInterval(I),O({err:v.meta?.err||null}),console.log("tx status from getTransaction:",B))}catch(v){S=!0,clearInterval(I),console.error("getTransaction timeout:",v,B)}},Ar)),K=this.connection.onSignature(B,v=>{if(S){this.connection.removeSignatureListener(K);return}S=!0,O(v)},"confirmed"),this.connection.getSignatureStatus(B)};return await T(),{txIds:x.map(B=>B.txId),signedTxs:k}}else{let h=[];for(let x=0;x<k.length;x+=1){let T=await this.connection.sendRawTransaction(k[x].serialize(),{skipPreflight:b});h.push(T)}return{txIds:h,signedTxs:k}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:o||{}}}async sizeCheckBuildV0(e){let{computeBudgetConfig:t,splitIns:n=[],lookupTableCache:o={},lookupTableAddress:r=[],...s}=e||{},a={...this.cluster==="devnet"?{}:gr,...o},c=Array.from(new Set([...this.lookupTableAddress,...r])),u=[];for(let w of c)a[w]===void 0&&u.push(new wo(w));let l=await Ds({connection:this.connection,address:u});for(let[w,k]of Object.entries(l))a[w]=k;let d=t?bo(t):{instructions:[],instructionTypes:[]},m=await go(this.connection,this.blockhashCommitment),p=this.signers.reduce((w,k)=>({...w,[k.publicKey.toBase58()]:k}),{}),y=[],f=[],b=[],g=0;if(this.allInstructions.forEach(w=>{let k=[...b,w],h=t?[...d.instructions,...k]:k;if(w!==n[g]&&b.length<12&&(Xo({instructions:h,payer:this.feePayer,lookupTableAddressAccount:a})||Xo({instructions:k,payer:this.feePayer,lookupTableAddressAccount:a})))b.push(w);else{if(b.length===0)throw Error("item ins too big");g+=w===n[g]?1:0;let x={};for(let T of[...new Set(c)])a[T]!==void 0&&(x[T]=a[T]);if(t&&Xo({instructions:[...d.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:a,recentBlockhash:m})){let T=new Jo({payerKey:this.feePayer,recentBlockhash:m,instructions:[...d.instructions,...b]}).compileToV0Message(Object.values(a));y.push(new ei(T))}else{let T=new Jo({payerKey:this.feePayer,recentBlockhash:m,instructions:[...b]}).compileToV0Message(Object.values(a));y.push(new ei(T))}f.push(Array.from(new Set(b.map(T=>T.keys.filter(B=>B.isSigner).map(B=>B.pubkey.toString())).flat())).map(T=>p[T]).filter(T=>T!==void 0)),b=[w]}}),b.length>0){let k=[...new Set(b.map(h=>h.keys.filter(x=>x.isSigner).map(x=>x.pubkey.toString())).flat()).values()].map(h=>p[h]).filter(h=>h!==void 0);if(t&&Xo({instructions:[...d.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:a,recentBlockhash:m})){let h=new Jo({payerKey:this.feePayer,recentBlockhash:m,instructions:[...d.instructions,...b]}).compileToV0Message(Object.values(a));y.push(new ei(h))}else{let h=new Jo({payerKey:this.feePayer,recentBlockhash:m,instructions:[...b]}).compileToV0Message(Object.values(a));y.push(new ei(h))}f.push(k)}return this.owner?.signer&&f.forEach(w=>{w.some(k=>k.publicKey.equals(this.owner.publicKey))||w.push(this.owner.signer)}),y.forEach((w,k)=>{w.sign(f[k])}),{builder:this,transactions:y,buildProps:e,signers:f,instructionTypes:this.instructionTypes,execute:async w=>{let{sequentially:k,onTxUpdate:h,skipTxCount:x=0,recentBlockHash:T,skipPreflight:B=!0}=w||{};if(y.map(async(S,I)=>{f[I].length&&S.sign(f[I]),T&&(S.message.recentBlockhash=T)}),jn(y),this.owner?.isKeyPair){if(k){let S=0,I=[];for(let K of y){if(++S,S<=x){console.log("skip tx: ",S),I.push("tx skipped");continue}let O=await this.connection.sendTransaction(K,{skipPreflight:B});await mr(this.connection,O),I.push(O)}return{txIds:I,signedTxs:y}}return{txIds:await Promise.all(y.map(async S=>await this.connection.sendTransaction(S,{skipPreflight:B}))),signedTxs:y}}if(this.signAllTransactions){let S=await this.signAllTransactions(y.slice(x,y.length)),I=[...y.slice(0,x),...S];if(k){let K=0,O=[],v=async()=>{if(!I[K])return;if(K<x){O.push({txId:"",status:"success",signedTx:I[K]}),h?.([...O]),K++,v();return}let _=await this.connection.sendTransaction(I[K],{skipPreflight:B});O.push({txId:_,status:"sent",signedTx:I[K]}),h?.([...O]),K++;let D=!1,q=null,G=null,ne=ie=>{q!==null&&clearInterval(q),G!==null&&this.connection.removeSignatureListener(G);let de=O.findIndex(re=>re.txId===_);if(de>-1){if(O[de].status==="error"||O[de].status==="success")return;O[de].status=ie.err?"error":"success"}h?.([...O]),ie.err||v()};this.loopMultiTxStatus&&(q=setInterval(async()=>{if(D){clearInterval(q);return}try{let ie=await this.connection.getTransaction(_,{commitment:"confirmed",maxSupportedTransactionVersion:0});ie&&(D=!0,clearInterval(q),ne({err:ie.meta?.err||null}),console.log("tx status from getTransaction:",_))}catch(ie){D=!0,clearInterval(q),console.error("getTransaction timeout:",ie,_)}},Ar)),G=this.connection.onSignature(_,ie=>{if(D){this.connection.removeSignatureListener(G);return}D=!0,ne(ie)},"confirmed"),this.connection.getSignatureStatus(_)};return v(),{txIds:[],signedTxs:I}}else{let K=[];for(let O=0;O<I.length;O+=1){let v=await this.connection.sendTransaction(I[O],{skipPreflight:B});K.push(v)}return{txIds:K,signedTxs:I}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}};import ep from"bn.js";var Yt=new ep(1e6);var Ju=(t=>(t.ALL="all",t.Strict="strict",t))(Ju||{}),ec=(s=>(s.All="all",s.Standard="standard",s.Concentrated="concentrated",s.AllFarm="allFarm",s.StandardFarm="standardFarm",s.ConcentratedFarm="concentratedFarm",s))(ec||{});var at={BASE_HOST:"https://api-v3.raydium.io",OWNER_BASE_HOST:"https://owner-v1.raydium.io",SERVICE_BASE_HOST:"https://service.raydium.io",MONITOR_BASE_HOST:"https://monitor.raydium.io",SERVICE_1_BASE_HOST:"https://service-v1.raydium.io",SEND_TRANSACTION:"/send-transaction",FARM_ARP:"/main/farm/info",FARM_ARP_LINE:"/main/farm-apr-tv",CLMM_CONFIG:"/main/clmm-config",CPMM_CONFIG:"/main/cpmm-config",VERSION:"/main/version",CHECK_AVAILABILITY:"/v3/main/AvailabilityCheckAPI",RPCS:"/main/rpcs",INFO:"/main/info",STAKE_POOLS:"/main/stake-pools",CHAIN_TIME:"/main/chain-time",TOKEN_LIST:"/mint/list",MINT_INFO_ID:"/mint/ids",JUP_TOKEN_LIST:"https://lite-api.jup.ag/tokens/v1/tagged/verified",POOL_LIST:"/pools/info/list",POOL_SEARCH_BY_ID:"/pools/info/ids",POOL_SEARCH_MINT:"/pools/info/mint",POOL_SEARCH_LP:"/pools/info/lps",POOL_KEY_BY_ID:"/pools/key/ids",POOL_LIQUIDITY_LINE:"/pools/line/liquidity",POOL_POSITION_LINE:"/pools/line/position",FARM_INFO:"/farms/info/ids",FARM_LP_INFO:"/farms/info/lp",FARM_KEYS:"/farms/key/ids",OWNER_CREATED_FARM:"/create-pool/{owner}",OWNER_IDO:"/main/ido/{owner}",OWNER_STAKE_FARMS:"/position/stake/{owner}",OWNER_LOCK_POSITION:"/position/clmm-lock/{owner}",IDO_KEYS:"/ido/key/ids",SWAP_HOST:"https://transaction-v1.raydium.io",SWAP_COMPUTE:"/compute/",SWAP_TX:"/transaction/",MINT_PRICE:"/mint/price",MIGRATE_CONFIG:"/main/migrate-lp",PRIORITY_FEE:"/main/auto-fee",CPMM_LOCK:"https://dynamic-ipfs.raydium.io/lock/cpmm/position"},MP={...at};var tc="ray_tab_hash",Us="ray_req_hash",tp=()=>{if(typeof window===void 0)return"";let i=sessionStorage.getItem(tc);return i||(i=`ray-${Date.now()}`,sessionStorage.setItem(tc,i)),i},wr=async({logCount:i=1e3,removeLastLog:e,...t})=>{if(typeof window===void 0)return new Promise(o=>o());let n=JSON.parse(localStorage.getItem(Us)||"[]").slice(0,i-1);e&&n.pop(),new Blob([JSON.stringify(t.data)]).size>1024&&(t.data=JSON.stringify(t.data).substring(0,200)+"..."),n.unshift({...t,time:Date.now(),session:tp()});try{localStorage.setItem(Us,JSON.stringify(n))}catch{if(e){let o=!1,r=JSON.stringify(t.data).substring(0,100);for(n[0].data=r+(r.length>100?"...":"");!o;){n.pop();let s=JSON.stringify(t.data).substring(0,100);n[0].data=s+(s.length>100?"...":"");try{localStorage.setItem(Us,JSON.stringify(n)),o=!0}catch{o=!1}}return new Promise(s=>s())}return wr({...t,logCount:i,removeLastLog:!0})}};import{TOKEN_2022_PROGRAM_ID as np,TOKEN_PROGRAM_ID as op}from"@solana/spl-token";var ko=pe("Raydium_Api"),Gs=new Map;async function rw(i,e,t=1e3){let n;for(;n==null;)try{ko.debug(`Request ${i} through endlessRetry`),n=await e()}catch(o){ko.error(`Request ${i} failed, retry after ${t} ms`,o),await vu(t)}return n}var kr=class{cluster;api;logCount;urlConfigs;constructor({cluster:e,timeout:t,logRequests:n,logCount:o,urlConfigs:r}){this.cluster=e,this.urlConfigs=r||{},this.logCount=o||1e3,this.api=nc.create({baseURL:this.urlConfigs.BASE_HOST||at.BASE_HOST,timeout:t}),this.api.interceptors.request.use(s=>{let{method:a,baseURL:c,url:u}=s;return ko.debug(`${a?.toUpperCase()} ${c}${u}`),s},s=>(ko.error("Request failed"),Promise.reject(s))),this.api.interceptors.response.use(s=>{let{config:a,data:c,status:u}=s,{method:l,baseURL:d,url:m}=a;return n&&wr({status:u,url:`${d}${m}`,params:a.params,data:c,logCount:this.logCount}),ko.debug(`${l?.toUpperCase()} ${d}${m}  ${u}`),c},s=>{let{config:a,response:c={}}=s,{status:u}=c,{method:l,baseURL:d,url:m}=a;return n&&wr({status:u,url:`${d}${m}`,params:a.params,data:s.message,logCount:this.logCount}),ko.error(`${l.toUpperCase()} ${d}${m} ${u||s.message}`),Promise.reject(s)})}async getClmmConfigs(){return(await this.api.get(this.urlConfigs.CLMM_CONFIG||at.CLMM_CONFIG)).data}async getCpmmConfigs(){return(await this.api.get(this.urlConfigs.CPMM_CONFIG||at.CPMM_CONFIG)).data}async getClmmPoolLines(e){return(await this.api.get(`${this.urlConfigs.POOL_LIQUIDITY_LINE||at.POOL_LIQUIDITY_LINE}?pool_id=${e}`)).data}async getBlockSlotCountForSecond(e){if(!e)return 2;let n=(await nc.post(e,{id:"getRecentPerformanceSamples",jsonrpc:"2.0",method:"getRecentPerformanceSamples",params:[4]})).result.map(o=>o.numSlots);return n.reduce((o,r)=>o+r,0)/n.length/60}async getChainTimeOffset(){return(await this.api.get(this.urlConfigs.CHAIN_TIME||at.CHAIN_TIME)).data}async getRpcs(){return this.api.get(this.urlConfigs.RPCS||at.RPCS)}async getTokenList(){return(await this.api.get(this.urlConfigs.TOKEN_LIST||at.TOKEN_LIST)).data}async getJupTokenList(){return(await this.api.get("",{baseURL:this.urlConfigs.JUP_TOKEN_LIST||at.JUP_TOKEN_LIST})).map(t=>({...t,chainId:101,programId:t.tags.includes("token-2022")?np.toBase58():op.toBase58()}))}async getTokenInfo(e){return(await this.api.get((this.urlConfigs.MINT_INFO_ID||at.MINT_INFO_ID)+`?mints=${e.map(n=>n.toString()).join(",")}`)).data}async getPoolList(e={}){let{type:t="all",sort:n="liquidity",order:o="desc",page:r=0,pageSize:s=100}=e;return(await this.api.get((this.urlConfigs.POOL_LIST||at.POOL_LIST)+`?poolType=${t}&poolSortField=${n}&sortType=${o}&page=${r}&pageSize=${s}`)).data}async fetchPoolById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.POOL_SEARCH_BY_ID||at.POOL_SEARCH_BY_ID)+`?ids=${t}`)).data}async fetchPoolKeysById(e){let{idList:t}=e,n=[],o=t.filter(s=>Gs.has(s)?(n.push(Gs.get(s)),!1):!0),r=[];return o.length&&(r=(await this.api.get((this.urlConfigs.POOL_KEY_BY_ID||at.POOL_KEY_BY_ID)+`?ids=${o.join(",")}`)).data.filter(Boolean),r.forEach(a=>{Gs.set(a.id,a)})),n.concat(r)}async fetchPoolByMints(e){let{mint1:t,mint2:n,type:o="all",sort:r="default",order:s="desc",page:a=1}=e,[c,u]=[t&&ft(t).toBase58(),n&&n!=="undefined"?ft(n).toBase58():""],[l,d]=u&&c>u?[u,c]:[c,u];return(await this.api.get((this.urlConfigs.POOL_SEARCH_MINT||at.POOL_SEARCH_MINT)+`?mint1=${l}&mint2=${d}&poolType=${o}&poolSortField=${r}&sortType=${s}&pageSize=100&page=${a}`)).data}async fetchFarmInfoById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_INFO||at.FARM_INFO)+`?ids=${t}`)).data}async fetchFarmKeysById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_KEYS||at.FARM_KEYS)+`?ids=${t}`)).data}async fetchAvailabilityStatus(){return(await this.api.get(this.urlConfigs.CHECK_AVAILABILITY||at.CHECK_AVAILABILITY)).data}};import{merge as ab}from"lodash";var hr="please provide owner in load() initialization or you can set by calling raydium.setOwner(owner)",oc="please provide connection in load() initialization or set it by raydium.setConnection(connection)";import{PublicKey as Kr,SystemProgram as ff}from"@solana/web3.js";import{AccountLayout as Io,createAssociatedTokenAccountInstruction as ia,TOKEN_PROGRAM_ID as Fn,TOKEN_2022_PROGRAM_ID as yf}from"@solana/spl-token";var Xs=(...i)=>i.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Ne=class{scope;disabled=!1;logger;constructor({scope:e,moduleName:t}){this.scope=e,this.logger=pe(t)}createTxBuilder(e){return this.scope.checkOwner(),new Pr({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,blockhashCommitment:this.scope.blockhashCommitment,loopMultiTxStatus:this.scope.loopMultiTxStatus,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(Xs(e))}logInfo(...e){this.logger.info(Xs(e))}logAndCreateError(...e){let t=Xs(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as uf,SystemProgram as cf}from"@solana/web3.js";import lf from"bn.js";import{createCloseAccountInstruction as mf,createInitializeAccountInstruction as df,createTransferInstruction as pf,TOKEN_PROGRAM_ID as To}from"@solana/spl-token";import{Keypair as of,PublicKey as Pc}from"@solana/web3.js";import rf from"bn.js";import{TOKEN_PROGRAM_ID as sf}from"@solana/spl-token";function ip(i){return i instanceof Uint8Array||i!=null&&typeof i=="object"&&i.constructor.name==="Uint8Array"}function Qs(i,...e){if(!ip(i))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(i.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${i.length}`)}function zs(i,e=!0){if(i.destroyed)throw new Error("Hash instance has been destroyed");if(e&&i.finished)throw new Error("Hash#digest() has already been called")}function ic(i,e){Qs(i);let t=e.outputLen;if(i.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var Ir=i=>new DataView(i.buffer,i.byteOffset,i.byteLength),Zt=(i,e)=>i<<32-e|i>>>e;var Pw=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function rp(i){if(typeof i!="string")throw new Error(`utf8ToBytes expected string, got ${typeof i}`);return new Uint8Array(new TextEncoder().encode(i))}function Hs(i){return typeof i=="string"&&(i=rp(i)),Qs(i),i}var Tr=class{clone(){return this._cloneInto()}},ww={}.toString;function rc(i){let e=n=>i().update(Hs(n)).digest(),t=i();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>i(),e}function sp(i,e,t,n){if(typeof i.setBigUint64=="function")return i.setBigUint64(e,t,n);let o=BigInt(32),r=BigInt(4294967295),s=Number(t>>o&r),a=Number(t&r),c=n?4:0,u=n?0:4;i.setUint32(e+c,s,n),i.setUint32(e+u,a,n)}var sc=(i,e,t)=>i&e^~i&t,ac=(i,e,t)=>i&e^i&t^e&t,Br=class extends Tr{constructor(e,t,n,o){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=o,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Ir(this.buffer)}update(e){zs(this);let{view:t,buffer:n,blockLen:o}=this;e=Hs(e);let r=e.length;for(let s=0;s<r;){let a=Math.min(o-this.pos,r-s);if(a===o){let c=Ir(e);for(;o<=r-s;s+=o)this.process(c,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===o&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){zs(this),ic(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:o,isLE:r}=this,{pos:s}=this;t[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>o-s&&(this.process(n,0),s=0);for(let d=s;d<o;d++)t[d]=0;sp(n,o-8,BigInt(this.length*8),r),this.process(n,0);let a=Ir(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let u=c/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let d=0;d<u;d++)a.setUint32(4*d,l[d],r)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:o,finished:r,destroyed:s,pos:a}=this;return e.length=o,e.pos=a,e.finished=r,e.destroyed=s,o%t&&e.buffer.set(n),e}};var ap=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Mn=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),En=new Uint32Array(64),js=class extends Br{constructor(){super(64,32,8,!1),this.A=Mn[0]|0,this.B=Mn[1]|0,this.C=Mn[2]|0,this.D=Mn[3]|0,this.E=Mn[4]|0,this.F=Mn[5]|0,this.G=Mn[6]|0,this.H=Mn[7]|0}get(){let{A:e,B:t,C:n,D:o,E:r,F:s,G:a,H:c}=this;return[e,t,n,o,r,s,a,c]}set(e,t,n,o,r,s,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=o|0,this.E=r|0,this.F=s|0,this.G=a|0,this.H=c|0}process(e,t){for(let d=0;d<16;d++,t+=4)En[d]=e.getUint32(t,!1);for(let d=16;d<64;d++){let m=En[d-15],p=En[d-2],y=Zt(m,7)^Zt(m,18)^m>>>3,f=Zt(p,17)^Zt(p,19)^p>>>10;En[d]=f+En[d-7]+y+En[d-16]|0}let{A:n,B:o,C:r,D:s,E:a,F:c,G:u,H:l}=this;for(let d=0;d<64;d++){let m=Zt(a,6)^Zt(a,11)^Zt(a,25),p=l+m+sc(a,c,u)+ap[d]+En[d]|0,f=(Zt(n,2)^Zt(n,13)^Zt(n,22))+ac(n,o,r)|0;l=u,u=c,c=a,a=s+p|0,s=r,r=o,o=n,n=p+f|0}n=n+this.A|0,o=o+this.B|0,r=r+this.C|0,s=s+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(n,o,r,s,a,c,u,l)}roundClean(){En.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var uc=rc(()=>new js);import{PublicKey as Jp}from"@solana/web3.js";import yc,{isBN as bc}from"bn.js";import{bits as up,BitStructure as cp,blob as lp,Blob as mp,cstr as dp,f32 as pp,f32be as fp,f64 as yp,f64be as bp,greedy as gp,Layout as Ap,ns64 as Pp,ns64be as wp,nu64 as kp,nu64be as hp,offset as Tp,s16 as Ip,s16be as Bp,s24 as xp,s24be as Sp,s32 as Kp,s32be as Cp,s40 as Lp,s40be as Rp,s48 as Np,s48be as Op,s8 as vp,seq as Mp,struct as Cw,Structure as Ep,u16 as _p,u16be as Fp,u24 as Vp,u24be as Wp,u32 as Dp,u32be as qp,u40 as Up,u40be as Gp,u48 as Xp,u48be as Qp,u8 as zp,UInt as Hp,union as jp,Union as Yp,unionLayoutDiscriminator as Zp,utf8 as $p}from"@solana/buffer-layout";var ti=Ap,cc=Ep,lc=Yp,Lw=cp,Ys=Hp,mc=mp,Rw=gp,xr=zp,$t=_p,Nw=Vp,ni=Dp,Ow=Up,vw=Xp,dc=kp,Mw=Fp,Ew=Wp,_w=qp,Fw=Gp,Vw=Qp,Ww=hp,Dw=vp,qw=Ip,Uw=xp,Oe=Kp,Gw=Lp,Xw=Np,Qw=Pp,zw=Bp,Hw=Sp,jw=Cp,Yw=Rp,Zw=Op,$w=wp,Jw=pp,ek=fp,tk=yp,nk=bp;var pc=Mp,fc=jp,ok=Zp,he=lp,ik=dp,rk=$p,Zs=up,$s=Tp;var Yn=class extends ti{blob;signed;constructor(e,t,n){super(e,n),this.blob=he(e),this.signed=t}decode(e,t=0){let n=new yc(this.blob.decode(e,t),10,"le");return this.signed?n.fromTwos(this.span*8).clone():n}encode(e,t,n=0){return typeof e=="number"&&(e=new yc(e)),this.signed&&(e=e.toTwos(this.span*8)),this.blob.encode(e.toArrayLike(Buffer,"le",this.span),t,n)}},Sr=class extends ti{_lower;_upper;constructor(e){super(8,e),this._lower=Zs(ni(),!1),this._upper=Zs(ni(),!1)}addBoolean(e){this._lower.fields.length<32?this._lower.addBoolean(e):this._upper.addBoolean(e)}decode(e,t=0){let n=this._lower.decode(e,t),o=this._upper.decode(e,t+this._lower.span);return{...n,...o}}encode(e,t,n=0){return this._lower.encode(e,t,n)+this._upper.encode(e,t,n+this._lower.span)}};function F(i){return new Ys(1,i)}function lt(i){return new Ys(4,i)}function P(i){return new Yn(8,!1,i)}function $(i){return new Yn(16,!1,i)}function gc(i){return new Yn(1,!0,i)}function ho(i){return new Yn(8,!0,i)}function Ac(i){return new Yn(16,!0,i)}var Pn=class extends ti{layout;decoder;encoder;constructor(e,t,n,o){super(e.span,o),this.layout=e,this.decoder=t,this.encoder=n}decode(e,t){return this.decoder(this.layout.decode(e,t))}encode(e,t,n){return this.layout.encode(this.encoder(e),t,n)}getSpan(e,t){return this.layout.getSpan(e,t)}};function L(i){return new Pn(he(32),e=>new Jp(e),e=>e.toBuffer(),i)}var Js=class extends ti{layout;discriminator;constructor(e,t){super(-1,t),this.layout=e,this.discriminator=xr()}encode(e,t,n=0){return e==null?this.discriminator.encode(0,t,n):(this.discriminator.encode(1,t,n),this.layout.encode(e,t,n+1)+1)}decode(e,t=0){let n=this.discriminator.decode(e,t);if(n===0)return null;if(n===1)return this.layout.decode(e,t+1);throw new Error("Invalid option "+this.property)}getSpan(e,t=0){let n=this.discriminator.decode(e,t);if(n===0)return 1;if(n===1)return this.layout.getSpan(e,t+1)+1;throw new Error("Invalid option "+this.property)}};function lk(i,e){return new Js(i,e)}function _e(i){return new Pn(xr(),ef,tf,i)}function ef(i){if(i===0)return!1;if(i===1)return!0;throw new Error("Invalid bool: "+i)}function tf(i){return i?1:0}function mk(i,e){let t=ni("length"),n=N([t,X(i,$s(t,-t.span),"values")]);return new Pn(n,({values:o})=>o,o=>({values:o}),e)}function dk(i,e,t){let n=N([P("tag"),e.replicate("data")]);function o({tag:r,data:s}){if(!r.eq(i))throw new Error("Invalid tag, expected: "+i.toString("hex")+", got: "+r.toString("hex"));return s}return new Pn(n,o,r=>({tag:i,data:r}),t)}function nf(i){let e=ni("length"),t=N([e,he($s(e,-e.span),"data")]);return new Pn(t,({data:n})=>n,n=>({data:n}),i)}function Jt(i){return new Pn(nf(),e=>e.toString("utf-8"),e=>Buffer.from(e,"utf-8"),i)}function pk(i,e){let t=fc(xr(),e);return i.forEach((n,o)=>t.addVariant(o,n,n.property)),t}function fk(i,e,t){let n=N([X(i,e,"values")]);return new Pn(n,({values:o})=>o,o=>({values:o}),t)}var ea=class extends cc{decode(e,t){return super.decode(e,t)}};function N(i,e,t){return new ea(i,e,t)}var ta=class extends lc{encodeInstruction(e){let t=Math.max(...Object.values(this.registry).map(o=>o.span)),n=Buffer.alloc(t);return n.slice(0,this.encode(e,n))}decodeInstruction(e){return this.decode(e)}};function yk(i,e,t){return new ta(i,e,t)}var na=class extends mc{decode(e,t){let n=super.decode(e,t);if(!n.every(o=>o===0))throw new Error("nonzero padding bytes");return n}};function bk(i){return new na(i)}function X(i,e,t){let n,o=typeof e=="number"?e:bc(e)?e.toNumber():new Proxy(e,{get(r,s){if(!n){let a=Reflect.get(r,"count");n=bc(a)?a.toNumber():a,Reflect.set(r,"count",n)}return Reflect.get(r,s)},set(r,s,a){return s==="count"&&(n=a),Reflect.set(r,s,a)}});return pc(i,o,t)}var en=N([L("mint"),L("owner"),P("amount"),lt("delegateOption"),L("delegate"),F("state"),lt("isNativeOption"),P("isNative"),P("delegatedAmount"),lt("closeAuthorityOption"),L("closeAuthority")]);var Lk=pe("Raydium_Util");function wc({owner:i,solAccountResp:e,tokenAccountResp:t}){let n=[],o=[];for(let{pubkey:r,account:s}of t.value){let a=en.decode(s.data),{mint:c,amount:u}=a;n.push({publicKey:r,mint:c,amount:u,isAssociated:Z(i,c,s.owner).publicKey.equals(r),isNative:!1,programId:s.owner}),o.push({pubkey:r,accountInfo:a,programId:s.owner})}return e&&n.push({mint:Pc.default,amount:new rf(String(e.lamports)),isNative:!0,programId:e.owner}),{tokenAccounts:n,tokenAccountRawInfos:o}}function Ue({fromPublicKey:i,programId:e=sf,assignSeed:t}){let n=t?btoa(t).slice(0,32):of.generate().publicKey.toBase58().slice(0,32);return{publicKey:af(i,n,e),seed:n}}function af(i,e,t){let n=Buffer.concat([i.toBuffer(),Buffer.from(e),t.toBuffer()]),o=uc(n);return new Pc(o)}function oa(i){let{mint:e,tokenAccount:t,owner:n,programId:o=To}=i;return df(t,e,n,o)}function wn(i){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:o,programId:r=To}=i;return mf(e,t,o,n,r)}async function _n(i){let{connection:e,amount:t,commitment:n,payer:o,owner:r,skipCloseAccount:s}=i,a=await e.getMinimumBalanceForRentExemption(en.span,n),c=Y(t).add(new lf(a)),u=Ue({fromPublicKey:o,programId:To});return{addresses:{newAccount:u.publicKey},signers:[],instructions:[cf.createAccountWithSeed({fromPubkey:o,basePubkey:o,seed:u.seed,newAccountPubkey:u.publicKey,lamports:c.toNumber(),space:en.span,programId:To}),oa({mint:new uf(it.address),tokenAccount:u.publicKey,owner:r,programId:To})],instructionTypes:[V.CreateAccount,V.InitAccount],endInstructionTypes:s?[]:[V.CloseAccount],endInstructions:s?[]:[wn({tokenAccount:u.publicKey,payer:o,owner:r})]}}function kc({source:i,destination:e,owner:t,amount:n,multiSigners:o=[],tokenProgram:r=To}){return pf(i,e,t,BigInt(String(n)),o,r)}var oi=class extends Ne{_tokenAccounts=[];_tokenAccountRawInfos=[];_accountChangeListenerId;_accountListener=[];_clientOwnedToken=!1;_notSubscribeAccountChange=!1;_accountFetchTime=0;constructor(e){super(e);let{tokenAccounts:t,tokenAccountRawInfos:n,notSubscribeAccountChange:o}=e;this._tokenAccounts=t||[],this._tokenAccountRawInfos=n||[],this._notSubscribeAccountChange=o??!0,this._clientOwnedToken=!!(t||n)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}set notSubscribeAccountChange(e){this._notSubscribeAccountChange=e}updateTokenAccount({tokenAccounts:e,tokenAccountRawInfos:t}){return e&&(this._tokenAccounts=e),t&&(this._tokenAccountRawInfos=t),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(e){return this._accountListener.push(e),this}removeAccountChangeListener(e){return this._accountListener=this._accountListener.filter(t=>t!==e),this}getAssociatedTokenAccount(e,t){return Z(this.scope.ownerPubKey,e,t).publicKey}resetTokenAccounts(){this._clientOwnedToken||(this._tokenAccounts=[],this._tokenAccountRawInfos=[])}async fetchWalletTokenAccounts(e){if(this._clientOwnedToken||!e?.forceUpdate&&this._tokenAccounts.length&&Date.now()-this._accountFetchTime<(this._notSubscribeAccountChange?1e3*5:1e3*60*3))return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let n={...{},...e},[o,r,s]=await Promise.all([this.scope.connection.getAccountInfo(this.scope.ownerPubKey,n.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:Fn},n.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:yf},n.commitment)]),{tokenAccounts:a,tokenAccountRawInfos:c}=wc({owner:this.scope.ownerPubKey,solAccountResp:o,tokenAccountResp:{context:r.context,value:[...r.value,...s.value]}});return this._tokenAccounts=a,this._tokenAccountRawInfos=c,this._accountFetchTime=Date.now(),this._notSubscribeAccountChange||(this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>{this.fetchWalletTokenAccounts({forceUpdate:!0}),this._accountListener.forEach(u=>u({tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos}))},{commitment:e?.commitment})),{tokenAccounts:a,tokenAccountRawInfos:c}}clearAccountChangeCkb(){this._accountChangeListenerId!==void 0&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId)}async getCreatedTokenAccount({mint:e,programId:t=Fn,associatedOnly:n=!0}){await this.fetchWalletTokenAccounts();let o=this._tokenAccounts.filter(({mint:s})=>s?.equals(e)).sort((s,a)=>s.amount.lt(a.amount)?1:-1),r=this.getAssociatedTokenAccount(e,t);for(let s of o){let{publicKey:a}=s;if(a&&(!n||n&&r.equals(a)))return a}}async getOrCreateTokenAccount(e){await this.fetchWalletTokenAccounts();let{mint:t,createInfo:n,associatedOnly:o,owner:r,notUseTokenAccount:s=!1,skipCloseAccount:a=!1,checkCreateATAOwner:c=!1,assignSeed:u}=e,l=new Kr(e.tokenProgram||Fn),d=this.getAssociatedTokenAccount(t,new Kr(l)),m=(s?[]:this.tokenAccountRawInfos).filter(y=>y.accountInfo.mint.equals(t)&&(!o||y.pubkey.equals(d))).sort((y,f)=>y.accountInfo.amount.lt(f.accountInfo.amount)?1:-1);n===void 0||m.length>0;let p={instructions:[],endInstructions:[],signers:[],instructionTypes:[],endInstructionTypes:[]};if(o){let y=ia(r,d,r,t,l),f=this.tokenAccountRawInfos.find(b=>b.pubkey.equals(d));if(c){let b=await this.scope.connection.getAccountInfo(d);if(b===null)p.instructions?.push(y),p.instructionTypes.push(V.CreateATA);else if(!(b.owner.equals(l)&&Io.decode(b.data).mint.equals(t)&&Io.decode(b.data).owner.equals(r)))throw Error(`create ata check error -> mint: ${t.toString()}, ata: ${d.toString()}`)}else f===void 0&&(p.instructions.push(y),p.instructionTypes.push(V.CreateATA));if(t.equals(j)&&n?.amount){let b=await _n({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:n.payer||this.scope.ownerPubKey,amount:n.amount??0,skipCloseAccount:a});p.instructions.push(...b.instructions||[]),p.endInstructions.push(...b.endInstructions||[]),p.instructionTypes.push(...b.instructionTypes||[]),p.endInstructionTypes.push(...b.endInstructionTypes||[]),n.amount&&(p.instructions.push(kc({source:b.addresses.newAccount,destination:d,owner:this.scope.ownerPubKey,amount:n.amount,tokenProgram:Fn})),p.instructionTypes.push(V.TransferAmount))}return!a&&f===void 0&&(p.endInstructions.push(wn({owner:r,payer:n?.payer||r,tokenAccount:d,programId:l})),p.endInstructionTypes.push(V.CloseAccount)),{account:d,instructionParams:p}}else{let y=Ue({fromPublicKey:r,programId:l,assignSeed:u}),f=await this.scope.connection.getMinimumBalanceForRentExemption(Io.span),b=ff.createAccountWithSeed({fromPubkey:r,basePubkey:r,seed:y.seed,newAccountPubkey:y.publicKey,lamports:f+Number(n?.amount?.toString()??0),space:Io.span,programId:l});return p.instructions.push(b,oa({mint:t,tokenAccount:y.publicKey,owner:this.scope.ownerPubKey,programId:l})),p.instructionTypes.push(V.CreateAccount),p.instructionTypes.push(V.InitAccount),a||(p.endInstructions.push(wn({owner:r,payer:n?.payer||r,tokenAccount:y.publicKey,programId:l})),p.endInstructionTypes.push(V.CloseAccount)),{account:y.publicKey,instructionParams:p}}}async checkOrCreateAta({mint:e,programId:t=Fn,autoUnwrapWSOLToSOL:n}){await this.fetchWalletTokenAccounts();let o=this.scope.account.tokenAccounts.find(({mint:a})=>a?.toBase58()===e.toBase58())?.publicKey,r=this.scope.ownerPubKey,s={};if(!o){let a=this.getAssociatedTokenAccount(e,t),c=await ia(r,a,r,e,t);s.instructions=[c],s.instructionTypes=[V.CreateATA],o=a}return n&&j.toBase58()===e.toBase58()&&(s.endInstructions=[wn({owner:r,payer:r,tokenAccount:o,programId:t})],s.endInstructionTypes=[V.CloseAccount]),{pubKey:o,newInstructions:s}}async handleTokenAccount(e){let{side:t,amount:n,mint:o,programId:r=Fn,tokenAccount:s,payer:a=this.scope.ownerPubKey,bypassAssociatedCheck:c,skipCloseAccount:u,checkCreateATAOwner:l}=e,d=this.getAssociatedTokenAccount(o,r);if(new Kr(j).equals(o)){let m=await _n({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:a,amount:n,skipCloseAccount:u});return{tokenAccount:m.addresses.newAccount,...m}}else if(!s||t==="out"&&!d.equals(s)&&!c){let m=[],p=ia(this.scope.ownerPubKey,d,this.scope.ownerPubKey,o,r);if(l){let y=await this.scope.connection.getAccountInfo(d);if(y===null)m.push(p);else if(!(y.owner.equals(Fn)&&Io.decode(y.data).mint.equals(o)&&Io.decode(y.data).owner.equals(this.scope.ownerPubKey)))throw Error(`create ata check error -> mint: ${o.toString()}, ata: ${d.toString()}`)}else m.push(p);return{tokenAccount:d,instructions:m,instructionTypes:[V.CreateATA]}}return{tokenAccount:s}}async processTokenAccount(e){let{mint:t,programId:n=Fn,amount:o,useSOLBalance:r,handleTokenAccount:s,feePayer:a}=e,c,u=this.createTxBuilder(a);if(t.equals(new Kr(j))&&r){let{tokenAccount:l,...d}=await this.handleTokenAccount({side:"in",amount:o||0,mint:t,bypassAssociatedCheck:!0,programId:n});c=l,u.addInstruction(d)}else if(c=await this.getCreatedTokenAccount({mint:t,associatedOnly:!1,programId:n}),!c&&s){let{tokenAccount:l,...d}=await this.scope.account.handleTokenAccount({side:"in",amount:0,mint:t,bypassAssociatedCheck:!0,programId:n});c=l,u.addInstruction(d)}return{tokenAccount:c,...u.AllTxData}}};import{PublicKey as Ie,SystemProgram as Ef}from"@solana/web3.js";import{createAssociatedTokenAccountInstruction as _f}from"@solana/spl-token";import{PublicKey as Kc}from"@solana/web3.js";var ra=N([F("instruction")]),sa=N([F("instruction")]),bf=N([P("rewardState"),P("rewardOpenTime"),P("rewardEndTime"),P("rewardLastUpdateTime"),P("totalReward"),P("totalRewardEmissioned"),P("rewardClaimed"),P("rewardPerSecond"),$("accRewardPerShare"),L("rewardVault"),L("rewardMint"),L("rewardSender"),P("rewardType"),X(P(),15,"padding")]),gf=N([P("state"),P("nonce"),L("lpVault"),L("rewardVault"),L(),L(),P(),P(),P("totalReward"),$("perShareReward"),P("lastSlot"),P("perSlotReward")]),Af=N([P("state"),P("nonce"),L("lpVault"),L("rewardVaultA"),P("totalRewardA"),$("perShareRewardA"),P("perSlotRewardA"),F("option"),L("rewardVaultB"),he(7),P("totalRewardB"),$("perShareRewardB"),P("perSlotRewardB"),P("lastSlot"),L()]),Pf=N([P(),P("state"),P("nonce"),P("validRewardTokenNum"),$("rewardMultiplier"),P("rewardPeriodMax"),P("rewardPeriodMin"),P("rewardPeriodExtend"),L("lpMint"),L("lpVault"),X(bf,5,"rewardInfos"),L("creator"),L(),X(P(),32,"padding")]),hc=new Proxy(gf,{get(i,e,t){return e==="decode"?(...n)=>{let o=i.decode(...n);return{...o,version:3,rewardInfos:[{rewardVault:o.rewardVault,totalReward:o.totalReward,perSlotReward:o.perSlotReward,perShareReward:o.perShareReward}]}}:Reflect.get(i,e,t)}}),Tc=new Proxy(Af,{get(i,e,t){return e==="decode"?(...n)=>{let o=i.decode(...n);return{...o,version:5,rewardInfos:[{rewardVault:o.rewardVaultA,totalReward:o.totalRewardA,perSlotReward:o.perSlotRewardA,perShareReward:o.perShareRewardA},{rewardVault:o.rewardVaultB,totalReward:o.totalRewardB,perSlotReward:o.perSlotRewardB,perShareReward:o.perShareRewardB}]}}:Reflect.get(i,e,t)}}),ii=new Proxy(Pf,{get(i,e,t){return e==="decode"?(...n)=>{let o=i.decode(...n);return{...o,version:6,rewardInfos:o.rewardInfos.map(r=>({...r,rewardType:(Object.entries(Vn).find(s=>String(s[1])===r.rewardType.toString())??["Standard SPL"])[0]}))}}:Reflect.get(i,e,t)}}),wf=N([P("isSet"),P("rewardPerSecond"),P("rewardOpenTime"),P("rewardEndTime"),P("rewardType")]),aa=N([F("instruction"),P("nonce"),X(wf,5,"rewardTimeInfo")]),ua=N([F("instruction"),P("rewardReopenTime"),P("rewardEndTime"),P("rewardPerSecond")]),ca=N([F("instruction"),P("isSet"),P("rewardPerSecond"),P("rewardOpenTime"),P("rewardEndTime"),P("rewardType")]),uh=N([P("state"),L("id"),L("owner"),P("deposited"),X(P(),1,"rewardDebts")]),ri=N([P("state"),L("id"),L("owner"),P("deposited"),X($(),1,"rewardDebts"),P(""),P("voteLockedBalance"),X(P(),15)]),ch=N([P("state"),L("id"),L("owner"),P("deposited"),X(P(),2,"rewardDebts")]),Ic=N([P("state"),L("id"),L("owner"),P("deposited"),X($(),2,"rewardDebts"),X(P(),17)]),Bc=N([P(),P("state"),L("id"),L("owner"),P("deposited"),X($(),5,"rewardDebts"),X(P(),16)]),kt=N([F("instruction"),P("amount")]),kf=N([L("mint"),L("grantAuthority"),P("baselineVoteWeightScaledFactor"),P("maxExtraLockupVoteWeightScaledFactor"),P("lockupSaturationSecs"),gc("digitShift"),X(F(),7,"reserved1"),X(P(),7,"reserved2")]),xc=N([he(8),L("governanceProgramId"),L("realm"),L("realmGoverningTokenMint"),L("realmAuthority"),X(F(),32,"reserved1"),X(kf,4,"votingMints"),ho("timeOffset"),F("bump"),X(F(),7,"reserved2"),X(P(),11,"reserved3")]),hf=N([ho("startTime"),ho("endTime"),F("kind"),X(F(),15,"reserved")]),Tf=N([X(hf,1,"lockup"),P("amountDeposited_native"),P("amountInitiallyLockedNative"),_e("isUsed"),_e("allowClawback"),F("votingMintConfigIdx"),X(F(),29,"reserved")]),Sc=N([he(8),L("voterAuthority"),L("registrar"),X(Tf,32,"deposits"),F("voterBump"),F("voterWweightRecordBump"),X(F(),94,"reserved")]);var gh=pe("Raydium_farm_config"),Cc=new Kc("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Lc=new Kc("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1"),Rc={3:hc,5:Tc,6:ii},Nc={3:ri,5:Ic,6:Bc},la=i=>[3,4,5,6].indexOf(i)!==-1,ma=i=>{let{version:e,rewardInfos:t,rewardTokenAccountsPublicKeys:n}=i,o=`rewardInfo:${JSON.stringify(t)}, rewardAccount:${JSON.stringify(n)}`;return{3:()=>{if(t.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${o}`},5:()=>{if(t.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${o}`},6:()=>{if(!n.length||t.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${o}`}}[e]?.()},Vn={"Standard SPL":0,"Option tokens":1},_t={[_s.toString()]:3,[Yu.toString()]:4,[Fs.toString()]:5,[Ao.toString()]:6};import{PublicKey as se,SystemProgram as Zn,SYSVAR_CLOCK_PUBKEY as xo,SYSVAR_RENT_PUBKEY as xf,TransactionInstruction as et}from"@solana/web3.js";import Cr from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Sf,createAssociatedTokenAccountInstruction as Kf,TOKEN_PROGRAM_ID as St}from"@solana/spl-token";function da(i,e,t){return ee([e.toBuffer(),Buffer.from("registrar","utf8"),t.toBuffer()],i)}function pa(i,e){return ee([e.toBuffer(),Buffer.from("voting_mint_seed","utf8")],i)}function fa(i,e){return ee([e.toBuffer()],i)}function ya(i,e,t){return ee([e.toBuffer(),Buffer.from("voter","utf8"),t.toBuffer()],i)}function ba(i,e,t){return ee([e.toBuffer(),Buffer.from("voter-weight-record","utf8"),t.toBuffer()],i)}function ga(i,e,t,n){return ee([Buffer.from("governance","utf8"),e.toBuffer(),t.toBuffer(),n.toBuffer()],i)}import xt from"bn.js";var si=pe("Raydium.farm.util");function ai({programId:i,poolId:e,mint:t,type:n}){let{publicKey:o}=ee([e.toBuffer(),t.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],i);return o}function bt({programId:i,poolId:e,owner:t,version:n}){let{publicKey:o}=ee([e.toBuffer(),t.toBuffer(),Buffer.from(n===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],i);return o}var Oc=({programId:i,poolId:e})=>ee([e.toBuffer()],i);function vc(i){return{isSet:new xt(1),rewardPerSecond:Y(i.perSecond),rewardOpenTime:Y(i.openTime),rewardEndTime:Y(i.endTime),rewardType:Y(Vn[i.rewardType])}}function Aa(i){return Y(i.endTime).sub(Y(i.openTime)).mul(Y(i.perSecond))}function Bo(i){let e=Nc[i];return e||si.logWithError("invalid version",i),e}function If(i){let e=Rc[i];return e||si.logWithError("invalid version",i),e}function Bf(i,e,t,n){if(i.version===3||i.version===5){if(i.lastSlot.gte(new xt(t)))return i;let o=new xt(t).sub(i.lastSlot);i.lastSlot=new xt(t);for(let r of i.rewardInfos){if(e.amount.eq(new xt(0)))continue;let s=r.perSlotReward.mul(o);r.perShareReward=r.perShareReward.add(s.mul(new xt(10).pow(new xt(i.version===3?9:15))).div(e.amount)),r.totalReward=r.totalReward.add(s)}}else if(i.version===6)for(let o of i.rewardInfos){if(o.rewardState.eq(new xt(0)))continue;let r=xt.min(new xt(n),o.rewardEndTime);if(o.rewardOpenTime.gte(r))continue;let a=r.sub(o.rewardLastUpdateTime).mul(o.rewardPerSecond),c=o.totalReward.sub(o.totalRewardEmissioned);c.lt(a)?(a=c,o.rewardLastUpdateTime=o.rewardLastUpdateTime.add(c.div(o.rewardPerSecond))):o.rewardLastUpdateTime=r,!e.amount.eq(new xt(0))&&(o.accRewardPerShare=o.accRewardPerShare.add(a.mul(i.rewardMultiplier).div(e.amount)),o.totalRewardEmissioned=o.totalRewardEmissioned.add(a))}return i}async function vh({connection:i,farmPools:e,owner:t,config:n,chainTime:o}){let r=!1,s=!1,a=new xt(10),c=[];for(let m of e){let p=Re(m);p.version===6?s=!0:r=!0,c.push({pubkey:p.id,version:p.version,key:"state",poolId:p.id},{pubkey:p.lpVault,version:p.version,key:"lpVault",poolId:p.id}),t&&c.push({pubkey:bt({programId:p.programId,poolId:p.id,owner:t,version:m.version}),version:p.version,key:"ledger",poolId:p.id})}let u={},l=await Ke(i,c,n);for(let{pubkey:m,version:p,key:y,poolId:f,accountInfo:b}of l){let g=f.toBase58();if(u[g]={...u[g]},y==="state"){let w=If(p);(!b||!b.data||b.data.length!==w.span)&&si.logWithError(`invalid farm state account info, pools.id, ${m}`),u[g].state=w.decode(b.data)}else if(y==="lpVault")(!b||!b.data||b.data.length!==en.span)&&si.logWithError(`invalid farm lp vault account info, pools.lpVault, ${m}`),u[g].lpVault=en.decode(b.data);else if(y==="ledger"){let w=Bo(p);b&&b.data&&(b.data.length!==w.span&&si.logWithError(`invalid farm ledger account info, ledger, ${m}`),u[g].ledger=w.decode(b.data))}}let d=s||r?await i.getSlot():0;for(let m of Object.keys(u))u[m]!==void 0&&(u[m].state=Bf(u[m].state,u[m].lpVault,d,o));for(let[m,{state:p,ledger:y}]of Object.entries(u))if(y){let f=p.version===6?p.rewardMultiplier:p.rewardInfos.length===1?a.pow(new xt(9)):a.pow(new xt(15)),b=p.rewardInfos.map((g,w)=>{let k=y.rewardDebts[w];return y.deposited.mul(p.version===6?g.accRewardPerShare:g.perShareReward).div(f).sub(k)});u[m].wrapped={...u[m].wrapped,pendingRewards:b}}return u}function Mh(i,e=Date.now()){if(i.version===6){let t=i.state.rewardInfos;if(t.every(({rewardOpenTime:n})=>Du(e,n.toNumber(),{unit:"s"})))return"upcoming pool";if(t.every(({rewardEndTime:n})=>qu(e,n.toNumber(),{unit:"s"})))return"closed pool"}else{let t=i.state.rewardInfos.map(({perSlotReward:n})=>n);if(t.length===2){if(String(t[0])==="0"&&String(t[1])!=="0")return"normal fusion pool";if(String(t[0])!=="0"&&String(t[1])!=="0")return"dual fusion pool";if(String(t[0])==="0"&&String(t[1])==="0")return"closed pool"}else if(t.length===1&&String(t[0])==="0")return"closed pool"}}async function Pa(i,e,t,n){let o=await i.getAccountInfo(e);if(o===null)throw Error("registrar info check error");let s=xc.decode(o.data).votingMints.findIndex(l=>l.mint.equals(n));if(s===-1)throw Error("find voter mint error");let a=await i.getAccountInfo(t);if(a===null)return{index:s,isInit:!1};let u=Sc.decode(a.data).deposits.findIndex(l=>l.isUsed&&l.votingMintConfigIdx===s);return u===-1?{index:s,isInit:!1}:{index:u,isInit:!0}}var Cf=pe("Raydium_farm_instruction"),ui={voterStakeRegistryCreateVoter:Buffer.from([6,24,245,52,243,255,148,25]),voterStakeRegistryCreateDepositEntry:Buffer.from([185,131,167,186,159,125,19,67]),voterStakeRegistryDeposit:Buffer.from([242,35,198,137,82,225,242,182]),voterStakeRegistryWithdraw:Buffer.from([183,18,70,156,148,109,161,34]),voterStakeRegistryUpdateVoterWeightRecord:Buffer.from([45,185,3,36,109,190,115,169])};function ci(i){let{version:e,id:t,ledger:n,programId:o,owner:r}=i,s={3:9,5:10}[e];s||Cf.logWithError(`invalid farm pool version: ${e}`);let a=Buffer.alloc(ra.span);ra.encode({instruction:s},a);let c=[A({pubkey:t}),A({pubkey:n}),A({pubkey:r,isWritable:!1}),A({pubkey:Zn.programId,isWritable:!1}),A({pubkey:xf,isWritable:!1})];return{instruction:new et({programId:o,keys:c,data:a}),instructionType:V.FarmV3CreateLedger}}function Mc(i){let e=Buffer.alloc(aa.span);aa.encode({instruction:0,nonce:new Cr(i.nonce),rewardTimeInfo:i.rewardInfoConfig},e);let t=[...Bs,A({pubkey:i.farmId}),A({pubkey:i.farmAuthority,isWritable:!1}),A({pubkey:i.lpVault}),A({pubkey:i.lpMint,isWritable:!1}),A({pubkey:i.lockVault}),A({pubkey:i.lockMint,isWritable:!1}),A({pubkey:i.lockUserAccount??rt}),A({pubkey:i.owner,isWritable:!1,isSigner:!0})];for(let n of i.rewardInfo)t.push(A({pubkey:n.rewardMint,isWritable:!1}),A({pubkey:n.rewardVault}),A({pubkey:n.userRewardToken}));return{instruction:new et({programId:i.programId,keys:t,data:e}),instructionType:V.FarmV6Create}}function Ec(i){let e=Buffer.alloc(sa.span);sa.encode({instruction:5},e);let t=[A({pubkey:St,isWritable:!1}),A({pubkey:i.id}),A({pubkey:i.authority,isWritable:!1}),A({pubkey:i.lpVault,isWritable:!1}),A({pubkey:i.rewardVault}),A({pubkey:i.userRewardToken}),A({pubkey:i.owner,isWritable:!1,isSigner:!0})];return{instruction:new et({programId:i.programId,keys:t,data:e}),instructionType:V.FarmV6CreatorWithdraw}}function Lf(i,e,t,n,o,r,s,a,c,u,l,d,m){let p=N([F("depositEntryIndex"),P("amount")]),y=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:St,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:rr,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({depositEntryIndex:d,amount:m},f);let b=Buffer.from([...ui.voterStakeRegistryDeposit,...f]);return new et({keys:y,programId:i,data:b})}function Rf(i,e,t,n){let o=N([]),r=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:Zn.programId,isSigner:!1,isWritable:!1}],s=Buffer.alloc(o.span);o.encode({},s);let a=Buffer.from([...ui.voterStakeRegistryUpdateVoterWeightRecord,...s]);return new et({keys:r,programId:i,data:a})}function Nf(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y){let f=N([F("depositEntryIndex"),P("amount")]),b=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:St,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:rr,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);f.encode({depositEntryIndex:p,amount:y},g);let w=Buffer.from([...ui.voterStakeRegistryWithdraw,...g]);return new et({keys:b,programId:i,data:w})}function Of(i,e,t,n,o,r){let s=N([F("ins")]),a=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:Zn.programId,isSigner:!1,isWritable:!1}],c=Buffer.alloc(s.span);return s.encode({ins:23},c),new et({keys:a,programId:i,data:c})}function vf(i,e,t,n,o,r,s,a){let c=N([F("voterBump"),F("voterWeightRecordBump")]),u=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:Zn.programId,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:rr,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({voterBump:s,voterWeightRecordBump:a},l);let d=Buffer.from([...ui.voterStakeRegistryCreateVoter,...l]);return new et({keys:u,programId:i,data:d})}function Mf(i,e,t,n,o,r,s,a,c,u,l,d){let m=N([F("depositEntryIndex"),F("kind"),F("option"),P("startTs"),lt("periods"),_e("allowClawback")]),p=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:Zn.programId,isSigner:!1,isWritable:!1},{pubkey:St,isSigner:!1,isWritable:!1},{pubkey:Sf,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1}],y=Buffer.alloc(m.span);m.encode({depositEntryIndex:a,kind:c,option:u===void 0?0:1,startTs:u,periods:l,allowClawback:d},y);let f=Buffer.from([...ui.voterStakeRegistryCreateDepositEntry,...y]);return new et({keys:p,programId:i,data:f})}async function Zh({connection:i,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:o,communityTokenMint:r,owner:s,poolId:a,tokenProgram:c}){let u=da(n,o,r).publicKey,l=bt({programId:e,poolId:a,owner:s,version:3}),d=await i.getAccountInfo(l);if(d===null)throw Error("user is not staker");let m=ri.decode(d.data),p=m.deposited.sub(m.voteLockedBalance);if(console.log("amount",p.toString()),p.eq(new Cr(0)))throw Error("user do not has new stake amount");let y=pa(e,a).publicKey,f=fa(e,a).publicKey,{publicKey:b,nonce:g}=ya(n,u,s),w=Z(b,y,c).publicKey,{publicKey:k,nonce:h}=ba(n,u,s),x=ga(t,o,r,s).publicKey,T=[],B=Z(s,y,c).publicKey;if(await i.getAccountInfo(B)===null&&T.push(Kf(s,B,s,y)),await i.getAccountInfo(b)===null){let v=Of(t,o,s,r,s,x);T.push(v,vf(n,u,b,k,s,s,g,h))}let{index:K,isInit:O}=await Pa(i,u,b,y);return O||T.push(Mf(n,u,b,w,s,s,y,K,0,void 0,0,!1)),T.push(Lf(n,u,b,w,B,s,l,a,y,f,e,K,p),Rf(n,u,b,k)),T}async function $h({connection:i,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:o,communityTokenMint:r,owner:s,poolId:a,tokenProgram:c}){let u=da(n,o,r).publicKey,l=bt({programId:e,poolId:a,owner:s,version:3}),d=await i.getAccountInfo(l);if(d===null)throw Error("user is not staker");let m=ri.decode(d.data);if(m.voteLockedBalance.eq(new Cr(0)))throw Error("user has vote locked balance = 0");let p=pa(e,a).publicKey,y=fa(e,a).publicKey,{publicKey:f}=ya(n,u,s),b=Z(f,p,c).publicKey,{publicKey:g}=ba(n,u,s),w=ga(t,o,r,s).publicKey,k=[],{index:h,isInit:x}=await Pa(i,u,f,p);if(!x)throw Error("deposit entry index check error");return k.push(Nf(n,u,f,s,w,g,b,Z(s,p,c).publicKey,l,a,p,y,e,h,m.voteLockedBalance)),k}function wa({payer:i,rewardVault:e,userRewardTokenPub:t,farmKeys:n,rewardInfo:o}){let r=Buffer.alloc(ua.span);ua.encode({instruction:3,rewardReopenTime:Y(o.openTime),rewardEndTime:Y(o.endTime),rewardPerSecond:Y(o.perSecond)},r);let s=[A({pubkey:St,isWritable:!1}),A({pubkey:n.id}),A({pubkey:n.lpVault,isWritable:!1}),A({pubkey:e}),A({pubkey:t}),A({pubkey:i,isWritable:!1,isSigner:!0})];return new et({programId:n.programId,keys:s,data:r})}function ka({payer:i,userRewardTokenPub:e,farmKeys:t,rewardVault:n,rewardInfo:o}){let r=Buffer.alloc(ca.span);ca.encode({instruction:4,isSet:new Cr(1),rewardPerSecond:Y(o.perSecond),rewardOpenTime:Y(o.openTime),rewardEndTime:Y(o.endTime),rewardType:Y(Vn[o.rewardType])},r);let s=[...Bs,A({pubkey:t.id}),A({pubkey:t.authority,isWritable:!1}),A({pubkey:o.mint,isWritable:!1}),A({pubkey:n}),A({pubkey:e}),A({pubkey:i,isWritable:!1,isSigner:!0})];return new et({programId:t.programId,keys:s,data:r})}function Jh(i){let{farmInfo:e,farmKeys:t,version:n,lpAccount:o,rewardAccounts:r,owner:s,instruction:a,amount:c,deposit:u}=i,[l,d]=[new se(e.programId),new se(e.id)],m=bt({programId:l,poolId:d,owner:s,version:n}),p=Buffer.alloc(kt.span);kt.encode({instruction:a,amount:c},p);let y=n===6?[A({pubkey:St,isWritable:!1}),...u?[A({pubkey:Zn.programId,isWritable:!1})]:[],A({pubkey:d}),A({pubkey:new se(t.authority),isWritable:!1}),A({pubkey:new se(t.lpVault)}),A({pubkey:m}),A({pubkey:s,isWritable:!1,isSigner:!0}),A({pubkey:o})]:[A({pubkey:d}),A({pubkey:new se(t.authority),isWritable:!1}),A({pubkey:m}),A({pubkey:s,isWritable:!1,isSigner:!0}),A({pubkey:o}),A({pubkey:new se(t.lpVault)}),A({pubkey:r[0]}),A({pubkey:new se(t.rewardInfos[0].vault)}),A({pubkey:xo,isWritable:!1}),A({pubkey:St,isWritable:!1})];if(n===5)for(let f=1;f<t.rewardInfos.length;f++)y.push(A({pubkey:r[f]})),y.push(A({pubkey:new se(t.rewardInfos[f].vault)}));if(n===6)for(let f=0;f<t.rewardInfos.length;f++)y.push(A({pubkey:new se(t.rewardInfos[f].vault)})),y.push(A({pubkey:r[f]}));return new et({programId:l,keys:y,data:p})}function li(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:r,amount:s}=i,[a,c]=[new se(e.programId),new se(e.id)],u=bt({programId:a,poolId:c,owner:r,version:6}),l=Buffer.alloc(kt.span);kt.encode({instruction:2,amount:Y(s)},l);let d=[A({pubkey:St,isWritable:!1}),A({pubkey:c}),A({pubkey:new se(t.authority),isWritable:!1}),A({pubkey:new se(t.lpVault)}),A({pubkey:u}),A({pubkey:r,isWritable:!1,isSigner:!0}),A({pubkey:n})];for(let m=0;m<t.rewardInfos.length;m++)d.push(A({pubkey:new se(t.rewardInfos[m].vault)})),d.push(A({pubkey:o[m]}));return new et({programId:a,keys:d,data:l})}function mi(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:r,amount:s,userAuxiliaryLedgers:a}=i,[c,u]=[new se(e.programId),new se(e.id)],l=bt({programId:c,poolId:u,owner:r,version:5}),d=Buffer.alloc(kt.span);kt.encode({instruction:12,amount:Y(s)},d);let m=[A({pubkey:u}),A({pubkey:new se(t.authority),isWritable:!1}),A({pubkey:l}),A({pubkey:r,isWritable:!1,isSigner:!0}),A({pubkey:n}),A({pubkey:new se(t.lpVault)}),A({pubkey:o[0]}),A({pubkey:new se(t.rewardInfos[0].vault)}),A({pubkey:xo,isWritable:!1}),A({pubkey:St,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)m.push(A({pubkey:o[p]})),m.push(A({pubkey:new se(t.rewardInfos[p].vault)}));if(a)for(let p of a)m.push(A({pubkey:p}));return new et({programId:c,keys:m,data:d})}function _c(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:r,amount:s,userAuxiliaryLedgers:a}=i,[c,u]=[new se(e.programId),new se(e.id)],l=N([F("instruction"),P("amount")]),d=[A({pubkey:u}),A({pubkey:new se(t.authority),isWritable:!1}),A({pubkey:a[0]}),A({pubkey:r,isSigner:!0,isWritable:!1}),A({pubkey:n}),A({pubkey:new se(t.lpVault)}),A({pubkey:o[0]}),A({pubkey:new se(t.rewardInfos[0].vault)}),A({pubkey:xo,isWritable:!1}),A({pubkey:St,isWritable:!1}),A({pubkey:o[1]}),A({pubkey:new se(t.rewardInfos[1].vault)})],m=Buffer.alloc(l.span);return l.encode({instruction:2,amount:s},m),new et({keys:d,programId:c,data:m})}function di(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:r,amount:s,userAuxiliaryLedgers:a}=i,[c,u]=[new se(e.programId),new se(e.id)],l=bt({programId:c,poolId:u,owner:r,version:3}),d=Buffer.alloc(kt.span);kt.encode({instruction:11,amount:Y(s)},d);let m=[A({pubkey:u}),A({pubkey:new se(t.authority),isWritable:!1}),A({pubkey:l}),A({pubkey:r,isWritable:!1,isSigner:!0}),A({pubkey:n}),A({pubkey:new se(t.lpVault)}),A({pubkey:o[0]}),A({pubkey:new se(t.rewardInfos[0].vault)}),A({pubkey:xo,isWritable:!1}),A({pubkey:St,isWritable:!1})];if(a)for(let p of a)m.push(A({pubkey:p}));return new et({programId:c,keys:m,data:d})}function Fc(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:r,amount:s,userAuxiliaryLedgers:a}=i,[c,u]=[new se(e.programId),new se(e.id)],l=bt({programId:c,poolId:u,owner:r,version:3}),d=Buffer.alloc(kt.span);kt.encode({instruction:10,amount:Y(s)},d);let m=[A({pubkey:u}),A({pubkey:new se(t.authority),isWritable:!1}),A({pubkey:l}),A({pubkey:r,isWritable:!1,isSigner:!0}),A({pubkey:n}),A({pubkey:new se(t.lpVault)}),A({pubkey:o[0]}),A({pubkey:new se(t.rewardInfos[0].vault)}),A({pubkey:xo,isWritable:!1}),A({pubkey:St,isWritable:!1})];if(a)for(let p of a)m.push(A({pubkey:p}));return new et({programId:c,keys:m,data:d})}function Vc(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:r,amount:s,userAuxiliaryLedgers:a}=i,[c,u]=[new se(e.programId),new se(e.id)],l=bt({programId:c,poolId:u,owner:r,version:5}),d=Buffer.alloc(kt.span);kt.encode({instruction:11,amount:Y(s)},d);let m=[A({pubkey:u}),A({pubkey:new se(t.authority),isWritable:!1}),A({pubkey:l}),A({pubkey:r,isWritable:!1,isSigner:!0}),A({pubkey:n}),A({pubkey:new se(t.lpVault)}),A({pubkey:o[0]}),A({pubkey:new se(t.rewardInfos[0].vault)}),A({pubkey:xo,isWritable:!1}),A({pubkey:St,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)m.push(A({pubkey:o[p]})),m.push(A({pubkey:new se(t.rewardInfos[p].vault)}));if(a)for(let p of a)m.push(A({pubkey:p}));return new et({programId:c,keys:m,data:d})}function Wc(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:r,amount:s}=i,[a,c]=[new se(e.programId),new se(e.id)],u=bt({programId:a,poolId:c,owner:r,version:6}),l=Buffer.alloc(kt.span);kt.encode({instruction:1,amount:Y(s)},l);let d=[A({pubkey:St,isWritable:!1}),A({pubkey:Zn.programId,isWritable:!1}),A({pubkey:c}),A({pubkey:new se(t.authority),isWritable:!1}),A({pubkey:new se(t.lpVault)}),A({pubkey:u}),A({pubkey:r,isWritable:!1,isSigner:!0}),A({pubkey:n})];for(let m=0;m<t.rewardInfos.length;m++)d.push(A({pubkey:new se(t.rewardInfos[m].vault)})),d.push(A({pubkey:o[m]}));return new et({programId:a,keys:d,data:l})}var pi=class extends Ne{async _getUserRewardInfo({payer:e,rewardInfo:t}){if(t.mint.equals(rt)){let n=await _n({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:e,amount:Aa({...t,openTime:t.openTime.toString(),endTime:t.endTime.toString()})});return{rewardPubKey:n.addresses.newAccount,newInstruction:n}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:t.mint,associatedOnly:!1})}}async create({poolInfo:e,rewardInfos:t,payer:n,programId:o=Ao,txVersion:r,feePayer:s}){this.checkDisabled(),this.scope.checkOwner();let c={lpMint:new Ie(e.lpMint.address),lockInfo:{lockMint:Cc,lockVault:Lc},version:6,rewardInfos:t,programId:o},u=this.createTxBuilder(s),l=n??this.scope.ownerPubKey,d=Ue({fromPublicKey:l,programId:c.programId}),m=await this.scope.connection.getMinimumBalanceForRentExemption(ii.span);u.addInstruction({instructions:[Ef.createAccountWithSeed({fromPubkey:l,basePubkey:l,seed:d.seed,newAccountPubkey:d.publicKey,lamports:m,space:ii.span,programId:c.programId})]});let{publicKey:p,nonce:y}=Oc({programId:new Ie(c.programId),poolId:d.publicKey}),f=ai({programId:c.programId,poolId:d.publicKey,mint:c.lpMint,type:"lpVault"}),b=[],g=[];for(let T of c.rewardInfos){T.openTime>=T.endTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",T.openTime.toString()),isNaN(Vn[T.rewardType])&&this.logAndCreateError("rewardType error",T.rewardType),Number(T.perSecond)<=0&&this.logAndCreateError("rewardPerSecond error",T.perSecond),b.push(vc(T));let{rewardPubKey:B,newInstruction:S}=await this._getUserRewardInfo({rewardInfo:T,payer:l});S&&u.addInstruction(S),B||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let I=T.mint.equals(rt)?new Ie(it.address):T.mint;g.push({rewardMint:I,rewardVault:ai({programId:c.programId,poolId:d.publicKey,mint:I,type:"rewardVault"}),userRewardToken:B})}let{account:w,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({mint:new Ie(c.lockInfo.lockMint),owner:this.scope.ownerPubKey,skipCloseAccount:!1,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:!1});k&&u.addInstruction(k),w||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let{instruction:h,instructionType:x}=Mc({farmId:d.publicKey,owner:this.scope.ownerPubKey,farmAuthority:p,lpVault:f,lpMint:c.lpMint,lockVault:c.lockInfo.lockVault,lockMint:c.lockInfo.lockMint,lockUserAccount:w,programId:c.programId,rewardInfo:g,rewardInfoConfig:b,nonce:y});return u.addInstruction({instructions:[h],instructionTypes:[x]}).versionBuild({txVersion:r,extInfo:{farmId:d.publicKey,farmAuthority:p,lpVault:f,lockUserAccount:w,nonce:y}})}async restartReward({farmInfo:e,payer:t,newRewardInfo:n,txVersion:o,feePayer:r}){let s=_t[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Re((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.openTime>=n.endTime&&this.logAndCreateError("start time error","newRewardInfo",n);let u=t||this.scope.ownerPubKey,l=n.mint.equals(rt)?new Ie(it.address):n.mint,d=c.rewardInfos.findIndex(g=>new Ie(g.mint.address).equals(l)),m=a.rewardInfos[d];m||this.logAndCreateError("configuration does not exist","rewardMint",l);let p=m.vault??rt,y=this.createTxBuilder(r),{rewardPubKey:f,newInstruction:b}=await this._getUserRewardInfo({rewardInfo:n,payer:u});return b&&y.addInstruction(b),f||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts),y.addInstruction({instructions:[wa({payer:this.scope.ownerPubKey,rewardVault:p,userRewardTokenPub:f,farmKeys:c,rewardInfo:n})],instructionTypes:[V.FarmV6Restart]}).versionBuild({txVersion:o})}async restartRewards({farmInfo:e,payer:t,newRewardInfos:n,txVersion:o,feePayer:r}){let s=_t[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Re((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.forEach(d=>{d.openTime>=d.endTime&&this.logAndCreateError("start time error","newRewardInfo",d)});let u=t||this.scope.ownerPubKey,l=this.createTxBuilder(r);for(let d of n){let m=d.mint.equals(rt)?new Ie(it.address):d.mint,p=c.rewardInfos.findIndex(k=>new Ie(k.mint.address).equals(m)),y=a.rewardInfos[p];y||this.logAndCreateError("configuration does not exist","rewardMint",m);let f=y.vault??rt,{rewardPubKey:b,newInstruction:g}=await this._getUserRewardInfo({rewardInfo:d,payer:u});g&&l.addInstruction(g),b||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let w=wa({payer:this.scope.ownerPubKey,rewardVault:f,userRewardTokenPub:b,farmKeys:c,rewardInfo:d});l.addInstruction({instructions:[w],instructionTypes:[V.FarmV6Restart]})}return l.versionBuild({txVersion:o})}async addNewRewardToken(e){let{txVersion:t,farmInfo:n,newRewardInfo:o,payer:r,feePayer:s}=e,a=_t[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=Re((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=r??this.scope.ownerPubKey,l=this.createTxBuilder(s),d=o.mint.equals(rt)?new Ie(it.address):o.mint,m=ai({programId:new Ie(n.programId),poolId:new Ie(n.id),mint:d,type:"rewardVault"}),{rewardPubKey:p,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:o,payer:u});return y&&l.addInstruction(y),p||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts),o.mint=d,l.addInstruction({instructions:[ka({payer:this.scope.ownerPubKey,userRewardTokenPub:p,farmKeys:c,rewardVault:m,rewardInfo:o})],instructionTypes:[V.FarmV6CreatorAddReward]}).versionBuild({txVersion:t})}async addNewRewardsToken(e){let{txVersion:t,farmInfo:n,newRewardInfos:o,payer:r,feePayer:s}=e,a=_t[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=Re((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=r??this.scope.ownerPubKey,l=this.createTxBuilder(s);for(let d of o){let m=d.mint.equals(rt)?new Ie(it.address):d.mint,p=ai({programId:new Ie(n.programId),poolId:new Ie(n.id),mint:m,type:"rewardVault"}),{rewardPubKey:y,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:d,payer:u});f&&l.addInstruction(f),y||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let b=ka({payer:this.scope.ownerPubKey,userRewardTokenPub:y,farmKeys:c,rewardVault:p,rewardInfo:{...d,mint:m}});l.addInstruction({instructions:[b],instructionTypes:[V.FarmV6CreatorAddReward]})}return l.versionBuild({txVersion:t})}async deposit(e){let{txVersion:t,farmInfo:n,amount:o,feePayer:r,useSOLBalance:s,associatedOnly:a=!0,checkCreateATAOwner:c=!1,userAuxiliaryLedgers:u,computeBudgetConfig:l,txTipConfig:d}=e;this.scope.availability.addFarm===!1&&this.logAndCreateError("farm deposit feature disabled in your region");let{rewardInfos:m,programId:p}=n,y=_t[p];y===4&&this.logAndCreateError("V4 has suspended deposits:",n.programId),la(y)||this.logAndCreateError("invalid farm program:",n.programId);let[f,b]=[new Ie(n.programId),new Ie(n.id)],g=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],w=bt({programId:f,poolId:b,owner:this.scope.ownerPubKey,version:y}),k=this.createTxBuilder(r);k.addCustomComputeBudget(l),k.addTipInstruction(d);let h={};for(let D of this.scope.account.tokenAccounts)if(a){let q=Z(this.scope.ownerPubKey,D.mint,D.programId).publicKey;D.publicKey&&q.equals(D.publicKey)&&(h[D.mint.toString()]=D.publicKey)}else h[D.mint.toString()]=D.publicKey;let x=g.lpMint,T=h[x.address];T||this.logAndCreateError("you don't have any lp","lp zero",h);let B=[];for(let D of m){let q=s&&D.mint.address===j.toString(),G=h[D.mint.address];if(!G){let{account:ne,instructionParams:ie}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:D.mint.programId,mint:new Ie(D.mint.address),notUseTokenAccount:q,createInfo:{payer:r||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!q,associatedOnly:q?!1:a,checkCreateATAOwner:c});G=ne,ie&&k.addInstruction(ie)}h[D.mint.address]=G,B.push(G)}let S,I=await this.scope.connection.getAccountInfo(w);if(I&&(S=Bo(y).decode(I.data)),n.programId!==Ao.toString()&&!S){let{instruction:D,instructionType:q}=ci({id:b,programId:f,version:y,ledger:w,owner:this.scope.ownerPubKey});k.addInstruction({instructions:[D],instructionTypes:[q]})}let K=ma({version:y,rewardInfos:m,rewardTokenAccountsPublicKeys:B});K&&this.logAndCreateError(K);let O={amount:Y(o),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:g,lpAccount:T,rewardAccounts:B,userAuxiliaryLedgers:u?.map(D=>new Ie(D))},v=y===6?Wc(O):y===5?Vc(O):Fc(O),_={3:V.FarmV3Deposit,5:V.FarmV5Deposit,6:V.FarmV6Deposit};return k.addInstruction({instructions:[v],instructionTypes:[_[y]]}).versionBuild({txVersion:t})}async withdraw(e){let{txVersion:t,farmInfo:n,amount:o,deposited:r,useSOLBalance:s,feePayer:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,userAuxiliaryLedgers:l,computeBudgetConfig:d,txTipConfig:m}=e,{rewardInfos:p}=n;this.scope.availability.removeFarm===!1&&this.logAndCreateError("farm withdraw feature disabled in your region");let y=_t[n.programId];la(y)||this.logAndCreateError("invalid farm program:",n.programId);let f=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],b=this.createTxBuilder(a);b.addCustomComputeBudget(d),b.addTipInstruction(m);let g={};for(let K of this.scope.account.tokenAccounts)if(c){let O=Z(this.scope.ownerPubKey,K.mint).publicKey;K.publicKey&&O.equals(K.publicKey)&&(g[K.mint.toString()]=K.publicKey)}else g[K.mint.toString()]=K.publicKey;if(y!==4){let K=bt({programId:new Ie(n.programId),poolId:new Ie(n.id),owner:this.scope.ownerPubKey,version:y}),O=await this.scope.connection.getAccountInfo(K);if(O)Bo(y).decode(O.data).deposited.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else if(y!==6){let{instruction:v,instructionType:_}=ci({id:new Ie(f.id),programId:new Ie(f.programId),version:y,ledger:K,owner:this.scope.ownerPubKey});b.addInstruction({instructions:[v],instructionTypes:[_]})}}r&&r.isZero()&&!(l||[]).length&&this.logAndCreateError("no deposited lp",{farmId:n.id});let w=f.lpMint.address,k=s&&w===j.toString(),h=g[w.toString()];if(!h){let{account:K,instructionParams:O}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:f.lpMint.programId,mint:new Ie(w),notUseTokenAccount:k,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:k?!1:c,checkCreateATAOwner:u});h=K,O&&b.addInstruction(O)}g[w.toString()]=h;let x=[];for(let K of p){let O=s&&K.mint.address===j.toString(),v=g[K.mint.address];if(!v){let{account:_,instructionParams:D}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:K.mint.programId,mint:new Ie(K.mint.address),notUseTokenAccount:O,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!O,associatedOnly:O?!1:c,checkCreateATAOwner:u});v=_,D&&b.addInstruction(D)}g[K.mint.address]=v,x.push(v)}let T=ma({version:y,rewardInfos:p,rewardTokenAccountsPublicKeys:x});T&&this.logAndCreateError(T);let B={amount:Y(o),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:f,lpAccount:h,rewardAccounts:x,userAuxiliaryLedgers:l?.map(K=>new Ie(K))},S=y===6?li(B):y===5?mi(B):y===4?_c(B):di(B),I={3:V.FarmV3Withdraw,4:V.FarmV4Withdraw,5:V.FarmV5Withdraw,6:V.FarmV6Withdraw};return b.addInstruction({instructions:[S],instructionTypes:[I[y]]}).versionBuild({txVersion:t})}async withdrawFarmReward({farmInfo:e,withdrawMint:t,txVersion:n,computeBudgetConfig:o,txTipConfig:r,feePayer:s}){this.scope.checkOwner();let a=Re((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c=_t[e.programId];c!==6&&this.logAndCreateError("invalid farm version",c);let u=a.rewardInfos.find(f=>ft(f.mint.address).equals(ft(t)));u||this.logAndCreateError("withdraw mint error","rewardInfos",e);let l=u?.vault??rt,d=this.createTxBuilder(s),m;if(t.equals(rt)||t.equals(Ie.default)){let f=await _n({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:Aa({...u,openTime:u.openTime,endTime:u.endTime,perSecond:new C(u.perSecond).mul(10**u.mint.decimals).toString()})});m=f.addresses.newAccount,d.addInstruction(f)}else{let f=await this.scope.account.getCreatedTokenAccount({mint:t});f===null?(m=await this.scope.account.getAssociatedTokenAccount(t),d.addInstruction({instructions:[_f(this.scope.ownerPubKey,m,this.scope.ownerPubKey,t)],instructionTypes:[V.CreateATA]})):m=f}let{instruction:p,instructionType:y}=Ec({programId:a.programId,id:a.id,authority:a.authority,lpVault:a.lpVault,rewardVault:l,userRewardToken:m,owner:this.scope.ownerPubKey});return d.addCustomComputeBudget(o),d.addTipInstruction(r),d.addInstruction({instructions:[p],instructionTypes:[y]}).versionBuild({txVersion:n})}async harvestAllRewards(e){let{farmInfoList:t,useSOLBalance:n,feePayer:o,associatedOnly:r=!0,checkCreateATAOwner:s=!1,userAuxiliaryLedgers:a,txVersion:c,computeBudgetConfig:u}=e,l=this.createTxBuilder(o),d={};for(let y of this.scope.account.tokenAccounts)if(r){let f=Z(this.scope.ownerPubKey,y.mint).publicKey;y.publicKey&&f.equals(y.publicKey)&&(d[y.mint.toString()]=y.publicKey)}else d[y.mint.toString()]=y.publicKey;let p=(await this.scope.api.fetchFarmKeysById({ids:Object.values(t).map(y=>y.id).join(",")})).reduce((y,f)=>({...y,[f.id]:f}),{});for(let y of Object.values(t)){let{programId:f,lpMint:b,rewardInfos:g,id:w}=y,k=_t[f],h=b.address,x=n&&h===j.toString(),T=d[h];if(!T){let{account:v,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:b.programId,mint:new Ie(h),notUseTokenAccount:x,createInfo:{payer:o||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:x?!1:r,checkCreateATAOwner:s});T=v,_&&l.addInstruction(_)}d[h.toString()]=T;let B=[];for(let v of g){let _=n&&v.mint.address===j.toString(),D=d[v.mint.address];if(!D){let{account:q,instructionParams:G}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:v.mint.programId,mint:new Ie(v.mint.address),notUseTokenAccount:_,createInfo:{payer:o||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!_,associatedOnly:_?!1:r,checkCreateATAOwner:s});D=q,G&&l.addInstruction(G)}d[v.mint.address]=D,B.push(D)}let S=p[w],I={amount:ze,owner:this.scope.ownerPubKey,farmInfo:y,farmKeys:S,lpAccount:T,rewardAccounts:B,userAuxiliaryLedgers:a?.map(v=>new Ie(v))},K=k===6?li(I):k===5?mi(I):di(I),O={3:V.FarmV3Withdraw,5:V.FarmV5Withdraw,6:V.FarmV6Withdraw};l.addInstruction({instructions:[K],instructionTypes:[O[k]]})}return c===1?l.sizeCheckBuild({computeBudgetConfig:u}):l.sizeCheckBuildV0({computeBudgetConfig:u})}};import{PublicKey as He}from"@solana/web3.js";import{AccountLayout as Cy,NATIVE_MINT as Ur,TOKEN_PROGRAM_ID as Dn}from"@solana/spl-token";import{Keypair as Er,PublicKey as U,SystemProgram as In,TransactionInstruction as mt}from"@solana/web3.js";import La from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Ti,TOKEN_2022_PROGRAM_ID as Ve,TOKEN_PROGRAM_ID as Be}from"@solana/spl-token";import Yf from"bn.js";import Ft from"bn.js";var be=new Ft(0),Ot=new Ft(1),kn=new Ft(-1),Ye=new Ft(1).shln(64),Lr=new Ft(1).shln(128),fi=Ye.sub(Ot),yi=64,Dc=Lr.subn(1),gt=-443636,ht=-gt,Vt=new Ft("4295048016"),Wt=new Ft("79226673521066979257578248091"),Rr=new Ft("4295048017"),Nr=new Ft("79226673521066979257578248090"),qc=16,Uc="59543866431248",Gc="184467440737095516",Xc="15793534762490258745",Or=new Ft(10).pow(new Ft(6)),Ff=(n=>(n[n.rate_500=500]="rate_500",n[n.rate_3000=3e3]="rate_3000",n[n.rate_10000=1e4]="rate_10000",n))(Ff||{}),LT={[500]:10,[3e3]:60,[1e4]:200},RT={version:6,liquidity:be,tickCurrent:0,feeGrowthGlobalX64A:be,feeGrowthGlobalX64B:be,protocolFeesTokenA:be,protocolFeesTokenB:be,swapInAmountTokenA:be,swapOutAmountTokenB:be,swapInAmountTokenB:be,swapOutAmountTokenA:be,tickArrayBitmap:[],rewardInfos:[],day:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},week:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},month:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},tvl:0},Qc={tvl:0,volumeQuote:0,mintAmountA:0,mintAmountB:0,rewardDefaultInfos:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,day:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},week:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},month:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},pooltype:[]},NT=new Ft("18446744073700000000");import me from"bn.js";function vr(i){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,i,!1),new Uint8Array(e)}function vT(i){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,i,!1),new Uint8Array(e)}function MT(i){let e=new ArrayBuffer(4);return new DataView(e).setUint32(0,i,!1),new Uint8Array(e)}function Mr(i){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,i,!1),new Uint8Array(e)}function ha(i,e){let t=0;for(let n=i-1;n>=0&&!e.testn(n);n--)t++;return t}function Ta(i,e){let t=0;for(let n=0;n<i&&!e.testn(n);n++)t++;return t}function bi(i,e){for(let t=0;t<i;t++)if(e.testn(t))return!1;return!0}function zc(i,e){return bi(i,e)?null:ha(i,e)}function Hc(i,e){return bi(i,e)?null:Ta(i,e)}var Vf=Buffer.from("amm_config","utf8"),Wf=Buffer.from("pool","utf8"),Df=Buffer.from("pool_vault","utf8"),qf=Buffer.from("pool_reward_vault","utf8"),jc=Buffer.from("position","utf8"),Uf=Buffer.from("tick_array","utf8"),Gf=Buffer.from("operation","utf8"),Xf=Buffer.from("pool_tick_array_bitmap_extension","utf8"),Qf=Buffer.from("observation","utf8");function VT(i,e){return ee([Vf,vr(e)],i)}function Yc(i,e,t,n){return ee([Wf,e.toBuffer(),t.toBuffer(),n.toBuffer()],i)}function Ia(i,e,t){return ee([Df,e.toBuffer(),t.toBuffer()],i)}function Zc(i,e,t){return ee([qf,e.toBuffer(),t.toBuffer()],i)}function ge(i,e,t){return ee([Uf,e.toBuffer(),Mr(t)],i)}function tn(i,e,t,n){return ee([jc,e.toBuffer(),Mr(t),Mr(n)],i)}function Tt(i,e){return ee([jc,e.toBuffer()],i)}function hn(i){return ee([Buffer.from("metadata","utf8"),Xt.toBuffer(),i.toBuffer()],Xt)}function gi(i){return ee([Gf],i)}function Ge(i,e){return ee([Xf,e.toBuffer()],i)}function $c(i,e){return ee([Qf,e.toBuffer()],i)}var Jc=Buffer.from("locked_position","utf8");function Ba(i,e){return ee([Jc,e.toBuffer()],i)}function Ai(i,e){return ee([Jc,e.toBuffer()],i)}var zf=Buffer.from("support_mint","utf8");function xa(i,e){return ee([zf,e.toBuffer()],i)}import{PublicKey as vt}from"@solana/web3.js";import{TOKEN_2022_PROGRAM_ID as el}from"@solana/spl-token";import ve from"bn.js";import cn from"bn.js";var Pi=class{static getfeeGrowthInside(e,t,n){let o=new cn(0),r=new cn(0);e.tickCurrent>=t.tick?(o=t.feeGrowthOutsideX64A,r=t.feeGrowthOutsideX64B):(o=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),r=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new cn(0),a=new cn(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let c=ae.wrappingSubU128(ae.wrappingSubU128(e.feeGrowthGlobalX64A,o),s),u=ae.wrappingSubU128(ae.wrappingSubU128(e.feeGrowthGlobalX64B,r),a);return{feeGrowthInsideX64A:c,feeGrowthInsideBX64:u}}static GetPositionFees(e,t,n,o){let{feeGrowthInsideX64A:r,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,o),a=ae.mulDivFloor(ae.wrappingSubU128(r,t.feeGrowthInsideLastX64A),t.liquidity,Ye),c=t.tokenFeesOwedA.add(a),u=ae.mulDivFloor(ae.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,Ye),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,o){let{feeGrowthInsideX64A:r,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,o),a=ae.mulDivFloor(ae.wrappingSubU128(r,t.feeGrowthInsideLastX64A),t.liquidity,Ye),c=t.tokenFeesOwedA.add(a),u=ae.mulDivFloor(ae.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,Ye),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,o){let r=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,o,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=ae.wrappingSubU128(c,u.growthInsideLastX64),d=ae.mulDivFloor(l,t.liquidity,Ye),m=u.rewardAmountOwed.add(d);r.push(m)}return r}static GetPositionRewards(e,t,n,o){let r=[],s=this.getRewardGrowthInside(e.tickCurrent,n,o,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=ae.wrappingSubU128(c,u.growthInsideLastX64),d=ae.mulDivFloor(l,t.liquidity,Ye),m=u.rewardAmountOwed.add(d);r.push(m)}return r}static getRewardGrowthInside(e,t,n,o){let r=[];for(let s=0;s<o.length;s++){let a=new cn(0);t.liquidityGross.eqn(0)?a=o[s].rewardGrowthGlobalX64:e<t.tick?a=o[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new cn(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=o[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),r.push(ae.wrappingSubU128(ae.wrappingSubU128(o[s].rewardGrowthGlobalX64,a),c))}return r}static getRewardGrowthInsideV2(e,t,n,o){let r=[];for(let s=0;s<o.length;s++){let a=new cn(0);t.liquidityGross.eqn(0)?a=o[s].rewardGrowthGlobalX64:e<t.tick?a=o[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new cn(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=o[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),r.push(ae.wrappingSubU128(ae.wrappingSubU128(o[s].rewardGrowthGlobalX64,a),c))}return r}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:o,add:r,epochInfo:s}){let a=te.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),c=te.getSqrtPriceX64FromTick(t.tickLower),u=te.getSqrtPriceX64FromTick(t.tickUpper),l=r?1+o:1-o,d=Ae.getAmountsFromLiquidity(a,c,u,n,r),[m,p]=[ke(d.amountA,e.mintA.extensions?.feeConfig,s,!0),ke(d.amountB,e.mintB.extensions?.feeConfig,s,!0)],[y,f]=[ke(new cn(new C(d.amountA.toString()).mul(l).toFixed(0)),e.mintA.extensions?.feeConfig,s,!0),ke(new cn(new C(d.amountB.toString()).mul(l).toFixed(0)),e.mintB.extensions?.feeConfig,s,!0)];return{liquidity:n,amountA:m,amountB:p,amountSlippageA:y,amountSlippageB:f,expirationTime:jt(m.expirationTime,p.expirationTime)}}};var Hf=15,Pe=class{static async getTickArrays(e,t,n,o,r,s,a){let c=[],u=H.getTickArrayStartIndexByTick(o,r),l=H.getInitializedTickArrayInRange(s,a,r,u,Math.floor(Hf/2));for(let p=0;p<l.length;p++){let{publicKey:y}=ge(t,n,l[p]);c.push(y)}let d=(await qt(e,c)).map(p=>p!==null?wi.decode(p.data):null),m={};for(let p=0;p<c.length;p++){let y=d[p];y!==null&&(m[y.startTickIndex]={...y,address:c[p]})}return m}static nextInitializedTick(e,t,n,o,r,s){let{initializedTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}=this.nextInitializedTickInOneArray(e,t,n,o,r,s);for(;a==null||a.liquidityGross.lten(0);){if(u=H.getNextTickArrayStartIndex(u,r,s),this.checkIsValidStartIndex(u,r))throw new Error("No enough initialized tickArray");let l=n[u];if(l===void 0)continue;let{nextTick:d,tickArrayAddress:m,tickArrayStartTickIndex:p}=this.firstInitializedTickInOneArray(e,t,l,s);[a,c,u]=[d,m,p]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}}static nextInitializedTickArray(e,t,n,o,r){let s=Math.floor(e/Pe.tickCount(t)),a=n?H.searchLowBitFromStart(o,r,s-1,1,t):H.searchHightBitFromStart(o,r,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,o){let r;if(o){let a=tt-1;for(;a>=0;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){r=c;break}a=a-1}}else{let a=0;for(;a<tt;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){r=c;break}a=a+1}}let{publicKey:s}=ge(e,t,n.startTickIndex);return{nextTick:r,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,o,r,s){let a=H.getTickArrayStartIndexByTick(o,r),c=Math.floor((o-a)/r),u=n[a];if(u==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;c>=0;){let m=u.ticks[c];if(m.liquidityGross.gtn(0)){l=m;break}c=c-1}else for(c=c+1;c<tt;){let m=u.ticks[c];if(m.liquidityGross.gtn(0)){l=m;break}c=c+1}let{publicKey:d}=ge(e,t,a);return{initializedTick:l,tickArrayAddress:d,tickArrayStartTickIndex:u.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(H.checkIsOutOfBoundary(e)){if(e>ht)return!1;let n=H.getTickArrayStartIndexByTick(gt,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return tt*e}};var Sa=14,Tn=class{static maxTickInTickarrayBitmap(e){return e*tt*$n}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),o=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(o+=1);let r=n*o;return e<0?{minValue:-r,maxValue:-r+n}:{minValue:r,maxValue:r+n}}static nextInitializedTickArrayStartIndex(e,t,n,o){if(!Pe.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let r=this.maxTickInTickarrayBitmap(n),s=o?t-Pe.tickCount(n):t+Pe.tickCount(n);if(s<-r||s>=r)return{isInit:!1,tickIndex:t};let a=n*tt,c=s/a+512;s<0&&s%a!=0&&c--;let u=Math.abs(c);if(o){let l=e.shln(1024-u-1),d=zc(1024,l);if(d!==null){let m=(u-d-512)*a;return{isInit:!0,tickIndex:m}}else return{isInit:!1,tickIndex:-r}}else{let l=e.shrn(u),d=Hc(1024,l);if(d!==null){let m=(u+d-512)*a;return{isInit:!0,tickIndex:m}}else return{isInit:!1,tickIndex:r-Pe.tickCount(n)}}}},ki=class{static getBitmapOffset(e,t){if(!Pe.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=Tn.maxTickInTickarrayBitmap(t),o=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&o--,o}static getBitmap(e,t,n){let o=this.getBitmapOffset(e,t);return e<0?{offset:o,tickarrayBitmap:n.negativeTickArrayBitmap[o]}:{offset:o,tickarrayBitmap:n.positiveTickArrayBitmap[o]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:o}=this.extensionTickBoundary(t);if(e>=o&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=Tn.maxTickInTickarrayBitmap(e),n=-t;if(ht<=t)throw Error(`extensionTickBoundary check error: ${ht}, ${t}`);if(n<=gt)throw Error(`extensionTickBoundary check error: ${n}, ${gt}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:o}=this.getBitmap(e,t,n),r=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:H.mergeTickArrayBitmap(o).testn(r),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,o){let r=Pe.tickCount(t),s=n?e-r:e+r,{tickarrayBitmap:a}=this.getBitmap(s,t,o);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,o){let{minValue:r,maxValue:s}=Tn.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(o){let c=H.mergeTickArrayBitmap(e).shln($n-1-a),u=bi(512,c)?null:ha(512,c);if(u!==null){let l=t-u*Pe.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:r}}else{let c=H.mergeTickArrayBitmap(e).shrn(a),u=bi(512,c)?null:Ta(512,c);if(u!==null){let l=t+u*Pe.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-Pe.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%Tn.maxTickInTickarrayBitmap(t),o=Math.floor(n/Pe.tickCount(t));return e<0&&n!=0&&(o=$n-o),o}};var Le=class{static getOutputAmountAndRemainAccounts(e,t,n,o,r,s=!1){let a=n.toBase58()===e.mintA.address,c=[],{isExist:u,startIndex:l,nextAccountMeta:d}=this.getFirstInitializedTickArray(e,a);if(!u||l===void 0||!d)throw new Error("Invalid tick array");c.push(d);let{allTrade:m,amountCalculated:p,accounts:y,sqrtPriceX64:f,feeAmount:b}=Jn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,a,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,o,l,r,s);return c.push(...y),{allTrade:m,expectedAmountOut:p.mul(kn),remainingAccounts:c,executionPrice:f,feeAmount:b}}static getInputAmountAndRemainAccounts(e,t,n,o,r){let s=n.toBase58()===e.mintB.address,a=[],{isExist:c,startIndex:u,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!c||u===void 0||!l)throw new Error("Invalid tick array");try{let f=this.preInitializedTickArrayStartIndex(e,s);if(f.isExist){let{publicKey:b}=ge(e.programId,e.id,f.nextStartIndex);a.push(b)}}catch{}a.push(l);let{amountCalculated:d,accounts:m,sqrtPriceX64:p,feeAmount:y}=Jn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,o.mul(kn),u,r);return a.push(...m),{expectedAmountIn:d,remainingAccounts:a,executionPrice:p,feeAmount:y}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:o}=Le.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?ki.checkTickArrayIsInit(Pe.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):H.checkTickArrayIsInitialized(H.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=ge(e.programId,e.id,o);return{isExist:!0,startIndex:o,nextAccountMeta:a}}let{isExist:r,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,Pe.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(r){let{publicKey:a}=ge(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/Pe.tickCount(e.tickSpacing)),o=t?H.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):H.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return o.length>0?{isExist:!0,nextStartIndex:o[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=Pe.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:o,tickIndex:r}=Tn.nextInitializedTickArrayStartIndex(H.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(o)return{isExist:!0,nextStartIndex:r};t=r;let{isInit:s,tickIndex:a}=ki.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<gt||t>ht)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:o,rewardInfos:r}){let s=[];for(let a=0;a<r.length;a++){let c=r[a],u=t.rewardDefaultInfos[a]?.mint.programId??(await e.getAccountInfo(c.tokenMint))?.owner;if(u===void 0)throw Error("get new reward mint info error");let l={...c,perSecond:ae.x64ToDecimal(c.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new vt(u)};if(l.tokenMint.equals(vt.default))continue;if(n<=l.openTime.toNumber()||o.eq(be)){s.push(l);continue}let d=new ve(Math.min(l.endTime.toNumber(),n)),m=d.sub(l.lastUpdateTime),p=ae.mulDivFloor(m,l.emissionsPerSecondX64,o),y=l.rewardGrowthGlobalX64.add(p),f=ae.mulDivFloor(m,l.emissionsPerSecondX64,Ye),b=l.rewardTotalEmissioned.add(f);s.push({...l,rewardGrowthGlobalX64:y,rewardTotalEmissioned:b,lastUpdateTime:d})}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:o}=this.tickRange(e);for(let r of t){let s=H.getTickArrayStartIndexByTick(r,e);if(s>=n||s<o)return!0}return!1}static tickRange(e){let t=Tn.maxTickInTickarrayBitmap(e),n=-t;return t>ht&&(t=Pe.getArrayStartIndex(ht,e)+Pe.tickCount(e)),n<gt&&(n=Pe.getArrayStartIndex(gt,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!Pe.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/Pe.tickCount(t)*$n}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let o=await Ke(e,t.map(s=>({pubkey:s})),{batchRequest:n}),r={};for(let s of o)s.accountInfo!==null&&(r[s.pubkey.toString()]=nl.decode(s.accountInfo.data));return r}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let o={},r=[];for(let c of t){let u=H.getTickArrayStartIndexByTick(c.tickCurrent,c.tickSpacing),l=H.getInitializedTickArrayInRange(c.tickArrayBitmap,c.exBitmapInfo,c.tickSpacing,u,7);for(let d of l){let{publicKey:m}=ge(c.programId,c.id,d);r.push({pubkey:m}),o[m.toString()]=c.id}}let s=await Ke(e,r,{batchRequest:n}),a={};for(let c of s){if(!c.accountInfo)continue;let u=o[c.pubkey.toString()];if(!u)continue;a[u.toString()]===void 0&&(a[u.toString()]={});let l=wi.decode(c.accountInfo.data);a[u.toString()][l.startTickIndex]={...l,address:c.pubkey}}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:o=!1,updateOwnerRewardAndFee:r=!0}){let s=[];for(let a=0;a<e.length;a++){let c=e[a];c!==null&&(s.find(u=>u.equals(c.state.programId))||s.push(c.state.programId))}if(n){let a=n.tokenAccounts.map(d=>d.accountInfo.mint),c=[];for(let d of a)for(let m of s)c.push(Tt(m,d).publicKey);let u=await qt(t,c,{batchRequest:o}),l={};for(let d of u){if(d===null)continue;let m=hi.decode(d.data),p=m.poolId.toString(),y=e.find(B=>B.state.id.toBase58()===p);if(y===void 0)continue;let f=y.state,b=H._getTickPriceLegacy({poolInfo:f,tick:m.tickLower,baseIn:!0}),g=H._getTickPriceLegacy({poolInfo:f,tick:m.tickUpper,baseIn:!0}),{amountA:w,amountB:k}=Ae.getAmountsFromLiquidity(f.sqrtPriceX64,b.tickSqrtPriceX64,g.tickSqrtPriceX64,m.liquidity,!1),h=1/(1-Math.sqrt(Math.sqrt(b.price.div(g.price).toNumber())));y.positionAccount=[...y.positionAccount??[],{poolId:m.poolId,nftMint:m.nftMint,priceLower:b.price,priceUpper:g.price,amountA:w,amountB:k,tickLower:m.tickLower,tickUpper:m.tickUpper,liquidity:m.liquidity,feeGrowthInsideLastX64A:m.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:m.feeGrowthInsideLastX64B,tokenFeesOwedA:m.tokenFeesOwedA,tokenFeesOwedB:m.tokenFeesOwedB,rewardInfos:m.rewardInfos.map(B=>({...B,pendingReward:new ve(0)})),leverage:h,tokenFeeAmountA:new ve(0),tokenFeeAmountB:new ve(0)}];let x=await H.getTickArrayAddressByTick(y.state.programId,m.poolId,m.tickLower,y.state.tickSpacing),T=await H.getTickArrayAddressByTick(y.state.programId,m.poolId,m.tickUpper,y.state.tickSpacing);l[`${y.state.programId.toString()}-${m.poolId.toString()}-${m.tickLower}`]=x,l[`${y.state.programId.toString()}-${m.poolId.toString()}-${m.tickUpper}`]=T}if(r){let d=Object.values(l),m=await qt(t,d,{batchRequest:o}),p={};for(let y=0;y<d.length;y++){let f=m[y];if(f===null)continue;let b=d[y].toString();p[b]=wi.decode(f.data)}for(let{state:y,positionAccount:f}of e)if(!!f)for(let b of f){let g=`${y.programId.toString()}-${y.id.toString()}-${b.tickLower}`,w=`${y.programId.toString()}-${y.id.toString()}-${b.tickUpper}`,k=p[l[g].toString()],h=p[l[w].toString()],x=k.ticks[H.getTickOffsetInArray(b.tickLower,y.tickSpacing)],T=h.ticks[H.getTickOffsetInArray(b.tickUpper,y.tickSpacing)],{tokenFeeAmountA:B,tokenFeeAmountB:S}=await Pi.GetPositionFees(y,b,x,T),I=await Pi.GetPositionRewards(y,b,x,T);b.tokenFeeAmountA=B.gte(new ve(0))?B:new ve(0),b.tokenFeeAmountB=S.gte(new ve(0))?S:new ve(0);for(let K=0;K<I.length;K++)b.rewardInfos[K].pendingReward=I[K].gte(new ve(0))?I[K]:new ve(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:o,amountIn:r,slippage:s,priceLimit:a=new C(0),catchLiquidityInsufficient:c=!1}){let u,l=n.toBase58()===e.mintA.address,[d,m]=l?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];a.equals(new C(0))?u=l?Vt.add(new ve(1)):Wt.sub(new ve(1)):u=te.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let p=ke(r,d,o,!1),{allTrade:y,expectedAmountOut:f,remainingAccounts:b,executionPrice:g,feeAmount:w}=Le.getOutputAmountAndRemainAccounts(e,t,n,p.amount.sub(p.fee??be),u,c),k=ke(f,m,o,!1),h=te.sqrtPriceX64ToPrice(g,e.mintA.decimals,e.mintB.decimals),x=l?h:new C(1).div(h),T=f.mul(new ve(Math.floor((1-s)*1e10))).div(new ve(1e10)),B=ke(T,m,o,!1),S=l?e.currentPrice:new C(1).div(e.currentPrice),I=new C(x).sub(S).abs(),K=S,O=new De(new C(I).mul(10**15).toFixed(0),new C(K).mul(10**15).toFixed(0));return{allTrade:y,realAmountIn:p,amountOut:k,minAmountOut:B,expirationTime:jt(p.expirationTime,k.expirationTime),currentPrice:e.currentPrice,executionPrice:x,priceImpact:O,fee:w,remainingAccounts:b,executionPriceX64:g}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:o,slippage:r,epochInfo:s,catchLiquidityInsufficient:a=!1}){let c=o.address===e.mintB.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA],[d,m]=[new Te({...u,mint:u.address,isToken2022:u.programId===el.toBase58()}),new Te({...l,mint:l.address,isToken2022:l.programId===el.toBase58()})],{allTrade:p,realAmountIn:y,amountOut:f,minAmountOut:b,expirationTime:g,currentPrice:w,executionPrice:k,priceImpact:h,fee:x,remainingAccounts:T,executionPriceX64:B}=Le.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new vt(u.address),amountIn:n,slippage:r,epochInfo:s,catchLiquidityInsufficient:a}),S={...y,amount:new we(d,y.amount),fee:y.fee===void 0?void 0:new we(d,y.fee)},I={...f,amount:new we(m,f.amount),fee:f.fee===void 0?void 0:new we(m,f.fee)},K={...b,amount:new we(m,b.amount),fee:b.fee===void 0?void 0:new we(m,b.fee)},O=new st({baseToken:d,denominator:new ve(10).pow(new ve(20+d.decimals)),quoteToken:m,numerator:w.mul(new C(10**(20+m.decimals))).toFixed(0)}),v=new st({baseToken:d,denominator:new ve(10).pow(new ve(20+d.decimals)),quoteToken:m,numerator:k.mul(new C(10**(20+m.decimals))).toFixed(0)}),_=new we(d,x);return{allTrade:p,realAmountIn:S,amountOut:I,minAmountOut:K,expirationTime:g,currentPrice:O,executionPrice:v,priceImpact:h,fee:_,remainingAccounts:T,executionPriceX64:B}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:o,amountOut:r,slippage:s,priceLimit:a=new C(0)}){let c=n.toBase58()===e.mintA.address,u={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},l;a.equals(new C(0))?l=c?Wt.sub(new ve(1)):Vt.add(new ve(1)):l=te.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let d=ke(r,u[n.toString()],o,!0),{expectedAmountIn:m,remainingAccounts:p,executionPrice:y,feeAmount:f}=Le.getInputAmountAndRemainAccounts(e,t,n,d.amount.sub(d.fee??be),l),b=c?e.mintB.address:e.mintA.address,g=ke(m,u[b],o,!1),w=te.sqrtPriceX64ToPrice(y,e.mintA.decimals,e.mintB.decimals),k=c?w:new C(1).div(w),h=m.mul(new ve(Math.floor((1+s)*1e10))).div(new ve(1e10)),x=ke(h,u[b],o,!0),T=c?e.currentPrice:new C(1).div(e.currentPrice),B=new C(k).sub(T).abs(),S=T,I=new De(new C(B).mul(10**15).toFixed(0),new C(S).mul(10**15).toFixed(0));return{amountIn:g,maxAmountIn:x,realAmountOut:d,expirationTime:jt(g.expirationTime,d.expirationTime),currentPrice:e.currentPrice,executionPrice:k,priceImpact:I,fee:f,remainingAccounts:p}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:o}){let r=e[t],s=H.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=H.getTickPrice({poolInfo:e,tick:o,baseIn:!0}).price.toNumber(),c=Math.max(s,r.priceMin),l=Math.min(a,r.priceMax)-c,d=a-s,m=r.priceMax-r.priceMin,p;return l<=0?p=0:d===l?p=m/l:m===l?p=l/d:p=l/m*(l/d),{feeApr:r.feeApr*p,rewardsApr:[(r.rewardApr[0]??0)*p,(r.rewardApr[1]??0)*p,(r.rewardApr[2]??0)*p],apr:r.apr*p}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:o,liquidity:r,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:c}){let u=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],d=o[ft(e.mintA.address).toString()],m=o[ft(e.mintB.address).toString()],p=e.mintA.decimals,y=e.mintB.decimals;if(!l||!d||!m)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let f=te.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),b=te.getSqrtPriceX64FromTick(s),g=te.getSqrtPriceX64FromTick(a),{amountSlippageA:w,amountSlippageB:k}=Ae.getAmountsFromLiquidityWithSlippage(f,b,g,t,!1,!1,0),{amountSlippageA:h,amountSlippageB:x}=Ae.getAmountsFromLiquidityWithSlippage(f,b,g,r,!1,!1,0),T=new C(w.toString()).div(new C(10).pow(p)).mul(d.value).add(new C(k.toString()).div(new C(10).pow(y)).mul(m.value)),B=new C(h.toString()).div(new C(10).pow(p)).mul(d.value).add(new C(x.toString()).div(new C(10).pow(y)).mul(m.value)),S=new C(1).div(T.add(B)),K=new C(l.volumeFee).mul(365).div(u).mul(S).mul(100).toNumber(),O=3600*24*365,v=e.rewardDefaultInfos.map(_=>{let D=_.mint.decimals,q=o[_.mint.address];return c<(_.startTime??0)||c>(_.endTime??0)||!_.perSecond||!q||D===void 0?0:new C(q.value).mul(new C(_.perSecond).mul(O)).div(new C(10).pow(D)).mul(S).mul(100).toNumber()});return{feeApr:K,rewardsApr:v,apr:K+v.reduce((_,D)=>_+D,0)}}static async getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:o,amount:r,slippage:s,add:a,epochInfo:c,amountHasFee:u}){let l=te.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),d=te.getSqrtPriceX64FromTick(n),m=te.getSqrtPriceX64FromTick(o),p=ke(r,e[t?"mintA":"mintB"].extensions?.feeConfig,c,!u),y=new ve(new C(p.amount.sub(p.fee??be).toString()).toFixed(0)),f;if(l.lte(d))f=t?Ae.getLiquidityFromTokenAmountA(d,m,y,!a):new ve(0);else if(l.lte(m)){let g=Ae.getLiquidityFromTokenAmountA(l,m,y,!a),w=Ae.getLiquidityFromTokenAmountB(d,l,y);f=t?g:w}else f=t?new ve(0):Ae.getLiquidityFromTokenAmountB(d,m,y);let b=await Le.getAmountsFromLiquidity({epochInfo:c,poolInfo:e,tickLower:n,tickUpper:o,liquidity:f,slippage:s,add:a});return{liquidity:f,amountA:t?p:b.amountA,amountB:t?b.amountB:p,amountSlippageA:t?p:b.amountSlippageA,amountSlippageB:t?b.amountSlippageB:p,expirationTime:b.expirationTime}}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:o,liquidity:r,slippage:s,add:a}){let c=te.getSqrtPriceX64FromTick(n),u=te.getSqrtPriceX64FromTick(o),l=a?1+s:1-s,d=Ae.getAmountsFromLiquidity(te.priceToSqrtPriceX64(new C(t.price),t.mintA.decimals,t.mintB.decimals),c,u,r,a),[m,p]=[ke(d.amountA,t.mintA.extensions?.feeConfig,e,!0),ke(d.amountB,t.mintB.extensions?.feeConfig,e,!0)],[y,f]=[ke(d.amountA.muln(l),t.mintA.extensions?.feeConfig,e,!0),ke(d.amountB.muln(l),t.mintB.extensions?.feeConfig,e,!0)];return{liquidity:r,amountA:m,amountB:p,amountSlippageA:y,amountSlippageB:f,expirationTime:jt(m.expirationTime,p.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let o=t.filter(c=>!n[c.id]).map(c=>new vt(c.id));(await qt(e,o)).forEach((c,u)=>{!c||(n[o[u].toBase58()]=eo.decode(c.data))});let s=t.map(c=>Ge(new vt(c.programId),new vt(c.id)).publicKey),a=await Le.fetchExBitmaps({connection:e,exBitmapAddress:s,batchRequest:!1});return t.reduce((c,u)=>({...c,[u.id]:{...n[u.id],id:new vt(u.id),version:6,programId:new vt(u.programId),mintA:u.mintA,mintB:u.mintB,ammConfig:{...u.config,id:new vt(u.config.id),fundOwner:""},currentPrice:new C(u.price),exBitmapAccount:Ge(new vt(u.programId),new vt(u.id)).publicKey,exBitmapInfo:a[Ge(new vt(u.programId),new vt(u.id)).publicKey.toBase58()],startTime:n[u.id].startTime.toNumber(),rewardInfos:n[u.id].rewardInfos}}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};function II({poolInfo:i,tickLower:e,tickUpper:t,amountA:n,amountB:o,slippage:r,add:s,epochInfo:a,amountHasFee:c}){let[u,l,d,m]=e<t?[e,t,n,o]:[t,e,o,n],p=te.priceToSqrtPriceX64(new C(i.price),i.mintA.decimals,i.mintB.decimals),y=te.getSqrtPriceX64FromTick(u),f=te.getSqrtPriceX64FromTick(l),[b,g]=[ke(d,i.mintA.extensions?.feeConfig,a,!c),ke(m,i.mintB.extensions?.feeConfig,a,!c)],w=Ae.getLiquidityFromTokenAmounts(p,y,f,b.amount.sub(b.fee??be),g.amount.sub(g.fee??be));return Ae.getAmountsOutFromLiquidity({poolInfo:i,tickLower:e,tickUpper:t,liquidity:w,slippage:r,add:s,epochInfo:a,amountAddFee:!c})}var Ka={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};function tl(i){return{...i,type:"Concentrated",programId:i.programId.toString(),id:i.id.toString(),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Clmm",price:i.currentPrice.toNumber(),mintAmountA:0,mintAmountB:0,feeRate:i.ammConfig.tradeFeeRate,openTime:i.startTime.toString(),tvl:0,day:Ka,week:Ka,month:Ka,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,burnPercent:0,config:{...i.ammConfig,id:i.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]}}}var ae=class{static mulDivRoundingUp(e,t,n){let o=e.mul(t),r=o.div(n);return o.mod(n).eq(be)||(r=r.add(Ot)),r}static mulDivFloor(e,t,n){if(n.eq(be))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(be))throw new Error("division by 0");return e.mul(t).add(n.sub(Ot)).div(n)}static x64ToDecimal(e,t){return new C(e.toString()).div(C.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new me(e.mul(C.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(Lr).sub(t).mod(Lr)}};function ut(i,e){return Ca(i.mul(e),64,256)}function jf(i,e,t){let n=i.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function Ca(i,e,t){let n=i.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var te=class{static sqrtPriceX64ToPrice(e,t,n){return ae.x64ToDecimal(e).pow(2).mul(C.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return ae.decimalToX64(e.mul(C.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,o){if(!e.gt(be))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(be))throw new Error("liquidity must greater than 0");return o?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,o){if(!e.gt(be))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(be))throw new Error("liquidity must greater than 0");return o?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,o){if(n.eq(be))return e;let r=t.shln(yi);if(o){let s=r,a=r.add(n.mul(e));return a.gte(s)?ae.mulDivCeil(s,e,a):ae.mulDivRoundingUp(s,Ot,s.div(e).add(n))}else{let s=n.mul(e);if(!r.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=r.sub(s);return ae.mulDivCeil(r,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,o){let r=n.shln(yi);if(o)return e.add(r.div(t));{let s=ae.mulDivRoundingUp(r,Ot,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<gt||e>ht)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new me("18445821805675395072"):new me("18446744073709551616");return(t&2)!=0&&(n=ut(n,new me("18444899583751176192"))),(t&4)!=0&&(n=ut(n,new me("18443055278223355904"))),(t&8)!=0&&(n=ut(n,new me("18439367220385607680"))),(t&16)!=0&&(n=ut(n,new me("18431993317065453568"))),(t&32)!=0&&(n=ut(n,new me("18417254355718170624"))),(t&64)!=0&&(n=ut(n,new me("18387811781193609216"))),(t&128)!=0&&(n=ut(n,new me("18329067761203558400"))),(t&256)!=0&&(n=ut(n,new me("18212142134806163456"))),(t&512)!=0&&(n=ut(n,new me("17980523815641700352"))),(t&1024)!=0&&(n=ut(n,new me("17526086738831433728"))),(t&2048)!=0&&(n=ut(n,new me("16651378430235570176"))),(t&4096)!=0&&(n=ut(n,new me("15030750278694412288"))),(t&8192)!=0&&(n=ut(n,new me("12247334978884435968"))),(t&16384)!=0&&(n=ut(n,new me("8131365268886854656"))),(t&32768)!=0&&(n=ut(n,new me("3584323654725218816"))),(t&65536)!=0&&(n=ut(n,new me("696457651848324352"))),(t&131072)!=0&&(n=ut(n,new me("26294789957507116"))),(t&262144)!=0&&(n=ut(n,new me("37481735321082"))),e>0&&(n=Dc.div(n)),n}static getTickFromPrice(e,t,n){return te.getTickFromSqrtPriceX64(te.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(Wt)||e.lt(Vt))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new me(t-64),o=jf(n,32,128),r=new me("8000000000000000","hex"),s=0,a=new me(0),c=t>=64?e.shrn(t-63):e.shln(63-t);for(;r.gt(new me(0))&&s<qc;){c=c.mul(c);let y=c.shrn(127);c=c.shrn(63+y.toNumber()),a=a.add(r.mul(y)),r=r.shrn(1),s+=1}let u=a.shrn(32),d=o.add(u).mul(new me(Uc)),m=Ca(d.sub(new me(Gc)),64,128).toNumber(),p=Ca(d.add(new me(Xc)),64,128).toNumber();return m==p?m:te.getSqrtPriceX64FromTick(p).lte(e)?p:m}},to=class{static getTickWithPriceAndTickspacing(e,t,n,o){let s=te.getTickFromSqrtPriceX64(te.priceToSqrtPriceX64(e,n,o))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,o){let r=to.getTickWithPriceAndTickspacing(e,t,n,o),s=te.getSqrtPriceX64FromTick(r);return te.sqrtPriceX64ToPrice(s,n,o)}},Ae=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,o){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(be))throw new Error("sqrtPriceX64A must greater than 0");let r=n.ushln(yi),s=t.sub(e);return o?ae.mulDivRoundingUp(ae.mulDivCeil(r,s,t),Ot,e):ae.mulDivFloor(r,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,o){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(be))throw new Error("sqrtPriceX64A must greater than 0");return o?ae.mulDivCeil(n,t.sub(e),Ye):ae.mulDivFloor(n,t.sub(e),Ye)}static getLiquidityFromTokenAmountA(e,t,n,o){e.gt(t)&&([e,t]=[t,e]);let r=n.mul(e).mul(t),s=t.sub(e),a=r.div(s);return o?ae.mulDivRoundingUp(a,Ot,fi):a.shrn(yi)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),ae.mulDivFloor(n,fi,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,o,r){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return Ae.getLiquidityFromTokenAmountA(t,n,o,!1);if(e.lt(n)){let s=Ae.getLiquidityFromTokenAmountA(e,n,o,!1),a=Ae.getLiquidityFromTokenAmountB(t,e,r);return s.lt(a)?s:a}else return Ae.getLiquidityFromTokenAmountB(t,n,r)}static getAmountsFromLiquidity(e,t,n,o,r){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:Ae.getTokenAmountAFromLiquidity(t,n,o,r),amountB:new me(0)};if(e.lt(n)){let s=Ae.getTokenAmountAFromLiquidity(e,n,o,r),a=Ae.getTokenAmountBFromLiquidity(t,e,o,r);return{amountA:s,amountB:a}}else return{amountA:new me(0),amountB:Ae.getTokenAmountBFromLiquidity(t,n,o,r)}}static getAmountsFromLiquidityWithSlippage(e,t,n,o,r,s,a){let{amountA:c,amountB:u}=Ae.getAmountsFromLiquidity(e,t,n,o,s),l=r?1+a:1-a,d=new me(new C(c.toString()).mul(l).toFixed(0)),m=new me(new C(u.toString()).mul(l).toFixed(0));return{amountSlippageA:d,amountSlippageB:m}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:o,slippage:r,add:s,epochInfo:a,amountAddFee:c}){let u=te.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),l=te.getSqrtPriceX64FromTick(t),d=te.getSqrtPriceX64FromTick(n),m=s?1+r:1-r,p=Ae.getAmountsFromLiquidity(u,l,d,o,s),[y,f]=[ke(p.amountA,e.mintA.extensions?.feeConfig,a,c),ke(p.amountB,e.mintB.extensions?.feeConfig,a,c)],[b,g]=[ke(new me(new C(p.amountA.toString()).mul(m).toFixed(0)),e.mintA.extensions?.feeConfig,a,c),ke(new me(new C(p.amountB.toString()).mul(m).toFixed(0)),e.mintB.extensions?.feeConfig,a,c)];return{liquidity:o,amountA:y,amountB:f,amountSlippageA:b,amountSlippageB:g,expirationTime:jt(y.expirationTime,f.expirationTime)}}},Jn=class{static swapCompute(e,t,n,o,r,s,a,c,u,l,d,m,p,y,f=!1){if(m.eq(be))throw new Error("amountSpecified must not be 0");if(y||(y=s?Vt.add(Ot):Wt.sub(Ot)),s){if(y.lt(Vt))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(y.gte(d))throw new Error("sqrtPriceX64 must smaller than current")}else{if(y.gt(Wt))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(y.lte(d))throw new Error("sqrtPriceX64 must greater than current")}let b=m.gt(be),g={amountSpecifiedRemaining:m,amountCalculated:be,sqrtPriceX64:d,tick:u>p?Math.min(p+Pe.tickCount(l)-1,u):p,accounts:[],liquidity:c,feeAmount:new me(0)},w=p,k=n[p],h=0,x=!s&&k.startTickIndex===g.tick;for(;!g.amountSpecifiedRemaining.eq(be)&&!g.sqrtPriceX64.eq(y);){h>10;let T={};T.sqrtPriceStartX64=g.sqrtPriceX64;let B=H.nextInitTick(k,g.tick,l,s,x),S=B||null,I=null;if(!S?.liquidityGross.gtn(0)){let O=Le.nextInitializedTickArrayStartIndex({tickCurrent:g.tick,tickSpacing:l,tickArrayBitmap:o,exBitmapInfo:r},w,s);if(!O.isExist){if(f)return{allTrade:!1,amountSpecifiedRemaining:g.amountSpecifiedRemaining,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts};throw Error("swapCompute LiquidityInsufficient")}w=O.nextStartIndex;let{publicKey:v}=ge(e,t,w);I=v,k=n[w];try{S=H.firstInitializedTick(k,s)}catch{throw Error("not found next tick info")}}T.tickNext=S.tick,T.initialized=S.liquidityGross.gtn(0),p!==w&&I&&(g.accounts.push(I),p=w),T.tickNext<gt?T.tickNext=gt:T.tickNext>ht&&(T.tickNext=ht),T.sqrtPriceNextX64=te.getSqrtPriceX64FromTick(T.tickNext);let K;if(s&&T.sqrtPriceNextX64.lt(y)||!s&&T.sqrtPriceNextX64.gt(y)?K=y:K=T.sqrtPriceNextX64,[g.sqrtPriceX64,T.amountIn,T.amountOut,T.feeAmount]=Jn.swapStepCompute(g.sqrtPriceX64,K,g.liquidity,g.amountSpecifiedRemaining,a,s),g.feeAmount=g.feeAmount.add(T.feeAmount),b?(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.sub(T.amountIn.add(T.feeAmount)),g.amountCalculated=g.amountCalculated.sub(T.amountOut)):(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.add(T.amountOut),g.amountCalculated=g.amountCalculated.add(T.amountIn.add(T.feeAmount))),g.sqrtPriceX64.eq(T.sqrtPriceNextX64)){if(T.initialized){let O=S.liquidityNet;s&&(O=O.mul(kn)),g.liquidity=Ae.addDelta(g.liquidity,O)}x=T.tickNext!=g.tick&&!s&&k.startTickIndex===T.tickNext,g.tick=s?T.tickNext-1:T.tickNext}else if(g.sqrtPriceX64!=T.sqrtPriceStartX64){let O=te.getTickFromSqrtPriceX64(g.sqrtPriceX64);x=O!=g.tick&&!s&&k.startTickIndex===O,g.tick=O}++h}try{let{nextStartIndex:T,isExist:B}=Pe.nextInitializedTickArray(g.tick,l,s,o,r);B&&p!==T&&(g.accounts.push(ge(e,t,T).publicKey),p=T)}catch{}return{allTrade:!0,amountSpecifiedRemaining:be,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts}}static swapStepCompute(e,t,n,o,r,s){let a={sqrtPriceX64Next:new me(0),amountIn:new me(0),amountOut:new me(0),feeAmount:new me(0)},c=o.gte(be);if(c){let l=ae.mulDivFloor(o,Or.sub(new me(r.toString())),Or);a.amountIn=s?Ae.getTokenAmountAFromLiquidity(t,e,n,!0):Ae.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(a.amountIn)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=te.getNextSqrtPriceX64FromInput(e,n,l,s)}else a.amountOut=s?Ae.getTokenAmountBFromLiquidity(t,e,n,!1):Ae.getTokenAmountAFromLiquidity(e,t,n,!1),o.mul(kn).gte(a.amountOut)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=te.getNextSqrtPriceX64FromOutput(e,n,o.mul(kn),s);let u=t.eq(a.sqrtPriceX64Next);return s?(u&&c||(a.amountIn=Ae.getTokenAmountAFromLiquidity(a.sqrtPriceX64Next,e,n,!0)),u&&!c||(a.amountOut=Ae.getTokenAmountBFromLiquidity(a.sqrtPriceX64Next,e,n,!1))):(a.amountIn=u&&c?a.amountIn:Ae.getTokenAmountBFromLiquidity(e,a.sqrtPriceX64Next,n,!0),a.amountOut=u&&!c?a.amountOut:Ae.getTokenAmountAFromLiquidity(e,a.sqrtPriceX64Next,n,!1)),!c&&a.amountOut.gt(o.mul(kn))&&(a.amountOut=o.mul(kn)),c&&!a.sqrtPriceX64Next.eq(t)?a.feeAmount=o.sub(a.amountIn):a.feeAmount=ae.mulDivCeil(a.amountIn,new me(r),Or.sub(new me(r))),[a.sqrtPriceX64Next,a.amountIn,a.amountOut,a.feeAmount]}};var tt=60,$n=512,H=class{static getTickArrayAddressByTick(e,t,n,o){let r=H.getTickArrayStartIndexByTick(n,o),{publicKey:s}=ge(e,t,r);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=H.getTickArrayStartIndexByTick(e,t),o=Math.floor((e-n)/t);if(o<0||o>=tt)throw new Error("tick offset in array overflow");return o}static getTickArrayBitIndex(e,t){let n=Pe.tickCount(t),o=e/n;return e<0&&e%n!=0?o=Math.ceil(o)-1:o=Math.floor(o),o}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*Pe.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*tt,o=Math.floor(e/n)+512;return Math.abs(o)}static checkTickArrayIsInitialized(e,t,n){let o=n*tt,r=Math.floor(t/o)+512,s=Math.abs(r);return{isInitialized:e.testn(s),startIndex:(s-512)*o}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*tt:e+t*tt}static mergeTickArrayBitmap(e){let t=new Yf(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,o,r){let s=Math.floor(o/(n*tt));return[...H.searchLowBitFromStart(e,t,s-1,r,n),...H.searchHightBitFromStart(e,t,s,r,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return H.searchHightBitFromStart(e,t,-7680,$n,n)}static getAllInitializedTickArrayInfo(e,t,n,o,r){let s=[],a=H.getAllInitializedTickArrayStartIndex(n,o,r);for(let c of a){let{publicKey:u}=ge(e,t,c);s.push({tickArrayStartIndex:c,tickArrayAddress:u})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,o,r){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>H.mergeTickArrayBitmap(u)),a=[];for(;n>=-7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n--,a.length===o)break}let c=Pe.tickCount(r);return a.map(u=>u*c)}static searchHightBitFromStart(e,t,n,o,r){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>H.mergeTickArrayBitmap(u)),a=[];for(;n<7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n++,a.length===o)break}let c=Pe.tickCount(r);return a.map(u=>u*c)}static checkIsOutOfBoundary(e){return e<gt||e>ht}static nextInitTick(e,t,n,o,r){if(Pe.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(o)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(r||(a=a+1);a<tt;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=tt-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<tt;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let o=te.getSqrtPriceX64FromTick(t),r=te.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:r,tickSqrtPriceX64:o}:{tick:t,price:new C(1).div(r),tickSqrtPriceX64:o}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let o=n?t:new C(1).div(t),r=to.getTickWithPriceAndTickspacing(o,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=te.getSqrtPriceX64FromTick(r),a=te.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:r,price:a}:{tick:r,price:new C(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let o=te.getSqrtPriceX64FromTick(t),r=te.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:r,tickSqrtPriceX64:o}:{tick:t,price:new C(1).div(r),tickSqrtPriceX64:o}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let o=n?t:new C(1).div(t),r=to.getTickWithPriceAndTickspacing(o,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=te.getSqrtPriceX64FromTick(r),a=te.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:r,price:a}:{tick:r,price:new C(1).div(a)}}};var ol=N([he(8),F("bump"),$t("index"),L(""),lt("protocolFeeRate"),lt("tradeFeeRate"),$t("tickSpacing"),X(P(),8,"")]),Zf=N([lt("blockTimestamp"),ho("tickCumulative"),X(P(),4)]),il=N([he(8),_e("initialized"),P("recentEpoch"),$t("observationIndex"),L("poolId"),X(Zf,100,"observations"),X(P(),4)]),$f=N([F("rewardState"),P("openTime"),P("endTime"),P("lastUpdateTime"),$("emissionsPerSecondX64"),P("rewardTotalEmissioned"),P("rewardClaimed"),L("tokenMint"),L("tokenVault"),L("creator"),$("rewardGrowthGlobalX64")]),eo=N([he(8),F("bump"),L("ammConfig"),L("creator"),L("mintA"),L("mintB"),L("vaultA"),L("vaultB"),L("observationId"),F("mintDecimalsA"),F("mintDecimalsB"),$t("tickSpacing"),$("liquidity"),$("sqrtPriceX64"),Oe("tickCurrent"),lt(),$("feeGrowthGlobalX64A"),$("feeGrowthGlobalX64B"),P("protocolFeesTokenA"),P("protocolFeesTokenB"),$("swapInAmountTokenA"),$("swapOutAmountTokenB"),$("swapInAmountTokenB"),$("swapOutAmountTokenA"),F("status"),X(F(),7,""),X($f,3,"rewardInfos"),X(P(),16,"tickArrayBitmap"),P("totalFeesTokenA"),P("totalFeesClaimedTokenA"),P("totalFeesTokenB"),P("totalFeesClaimedTokenB"),P("fundFeesTokenA"),P("fundFeesTokenB"),P("startTime"),X(P(),15*4-3,"padding")]),Jf=N([$("growthInsideLastX64"),P("rewardAmountOwed")]),hi=N([he(8),F("bump"),L("nftMint"),L("poolId"),Oe("tickLower"),Oe("tickUpper"),$("liquidity"),$("feeGrowthInsideLastX64A"),$("feeGrowthInsideLastX64B"),P("tokenFeesOwedA"),P("tokenFeesOwedB"),X(Jf,3,"rewardInfos"),X(P(),8,"")]),HI=N([he(8),F("bump"),L("poolId"),Oe("tickLowerIndex"),Oe("tickUpperIndex"),$("liquidity"),$("feeGrowthInsideLastX64A"),$("feeGrowthInsideLastX64B"),P("tokenFeesOwedA"),P("tokenFeesOwedB"),X($(),3,"rewardGrowthInside"),X(P(),8,"")]),ey=N([Oe("tick"),Ac("liquidityNet"),$("liquidityGross"),$("feeGrowthOutsideX64A"),$("feeGrowthOutsideX64B"),X($(),3,"rewardGrowthsOutsideX64"),X(lt(),13,"")]),wi=N([he(8),L("poolId"),Oe("startTickIndex"),X(ey,tt,"ticks"),F("initializedTickCount"),X(F(),115,"")]),rl=N([he(329),X(L(),100,"whitelistMints")]),nl=N([he(8),L("poolId"),X(X(P(),8),Sa,"positiveTickArrayBitmap"),X(X(P(),8),Sa,"negativeTickArrayBitmap")]),jI=N([P(),F("bump"),L("owner"),L("poolId"),L("positionId"),L("nftAccount"),X(P(),8)]),YI=N([he(8),F("bump"),L("lockOwner"),L("poolId"),L("positionId"),L("nftAccount"),L("lockNftMint"),P("recentEpoch"),X(P(),8)]);il.span;var sl=pe("Raydium_Clmm"),Mt={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],openPositionWithTokenEx:[77,255,174,82,125,29,201,46],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},al=[188,37,179,131,82,150,84,73],ul=[16,72,250,198,14,162,212,19],xe=class{static createPoolInstruction(e,t,n,o,r,s,a,c,u,l,d,m,p,y){let f=N([$("sqrtPriceX64"),P("zero")]),b=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:In.programId,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},...y?.map(k=>({pubkey:k,isSigner:!1,isWritable:!1}))||[]],g=Buffer.alloc(f.span);f.encode({sqrtPriceX64:p,zero:be},g);let w=Buffer.from([...Mt.createPool,...g]);return new mt({keys:b,programId:e,data:w})}static async createPoolInstructions(e){let{programId:t,owner:n,mintA:o,mintB:r,ammConfigId:s,initialPriceX64:a,extendMintAccount:c}=e,[u,l]=[new U(o.address),new U(r.address)],{publicKey:d}=Yc(t,s,u,l),{publicKey:m}=$c(t,d),{publicKey:p}=Ia(t,d,u),{publicKey:y}=Ia(t,d,l),f=Ge(t,d).publicKey,b=[this.createPoolInstruction(t,d,n,s,m,u,p,new U(o.programId||Be),l,y,new U(r.programId||Be),f,a,c)];return{signers:[],instructions:b,instructionTypes:[V.CreateAccount,V.ClmmCreatePool],address:{poolId:d,observationId:m,exBitmapAccount:f,mintAVault:p,mintBVault:y},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I,K){let O=N([Oe("tickLowerIndex"),Oe("tickUpperIndex"),Oe("tickArrayLowerStartIndex"),Oe("tickArrayUpperStartIndex"),$("liquidity"),P("amountMaxA"),P("amountMaxB"),_e("withMetadata"),F("optionBaseFlag"),_e("baseFlag")]),v=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],_=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:In.programId,isSigner:!1,isWritable:!1},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ti,isSigner:!1,isWritable:!1},{pubkey:Xt,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...v],D=Buffer.alloc(O.span);O.encode({tickLowerIndex:w,tickUpperIndex:k,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:x,liquidity:T,amountMaxA:B,amountMaxB:S,withMetadata:I==="create",baseFlag:!1,optionBaseFlag:0},D);let q=Buffer.from([...Mt.openPosition,...D]);return new mt({keys:_,programId:e,data:q})}static openPositionFromLiquidityInstruction22(e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I){let K=N([Oe("tickLowerIndex"),Oe("tickUpperIndex"),Oe("tickArrayLowerStartIndex"),Oe("tickArrayUpperStartIndex"),$("liquidity"),P("amountMaxA"),P("amountMaxB"),_e("withMetadata"),F("optionBaseFlag"),_e("baseFlag")]),O=[...I?[{pubkey:I,isSigner:!1,isWritable:!0}]:[]],v=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:In.programId,isSigner:!1,isWritable:!1},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ti,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...O],_=Buffer.alloc(K.span);K.encode({tickLowerIndex:g,tickUpperIndex:w,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:h,liquidity:x,amountMaxA:T,amountMaxB:B,withMetadata:S==="create",baseFlag:!1,optionBaseFlag:0},_);let D=Buffer.from([...Mt.openPositionWithTokenEx,..._]);return new mt({keys:v,programId:e,data:D})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:r,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:d}){let m=[],[p,y]=[new U(e.programId),new U(e.id)],f;if(l)f=new U((await l(1))[0]);else{let I=Er.generate();m.push(I),f=I.publicKey}let b=H.getTickArrayStartIndexByTick(o,e.config.tickSpacing),g=H.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:w}=ge(p,y,b),{publicKey:k}=ge(p,y,g),{publicKey:h}=d?Z(n.wallet,f,Ve):Z(n.wallet,f,Be),{publicKey:x}=hn(f),{publicKey:T}=Tt(p,f),{publicKey:B}=tn(p,y,o,r),S=d?this.openPositionFromLiquidityInstruction22(p,n.feePayer,y,n.wallet,f,h,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),o,r,b,g,s,a,c,u,Le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ge(p,y).publicKey:void 0):this.openPositionFromLiquidityInstruction(p,n.feePayer,y,n.wallet,f,h,x,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),o,r,b,g,s,a,c,u,Le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ge(p,y).publicKey:void 0);return{signers:m,instructions:[S],instructionTypes:[V.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:f,tickArrayLower:w,tickArrayUpper:k,positionNftAccount:h,metadataAccount:x,personalPosition:T,protocolPosition:B}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:r,base:s,baseAmount:a,otherAmountMax:c,withMetadata:u,getEphemeralSigners:l,nft2022:d}){let m=[],[p,y]=[new U(e.programId),new U(e.id)],f;if(l)f=new U((await l(1))[0]);else{let I=Er.generate();m.push(I),f=I.publicKey}let b=H.getTickArrayStartIndexByTick(o,e.config.tickSpacing),g=H.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:w}=ge(p,y,b),{publicKey:k}=ge(p,y,g),{publicKey:h}=d?Z(n.wallet,f,Ve):Z(n.wallet,f,Be),{publicKey:x}=hn(f),{publicKey:T}=Tt(p,f),{publicKey:B}=tn(p,y,o,r),S=d?this.openPositionFromBaseInstruction22(p,n.feePayer,y,n.wallet,f,h,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),o,r,b,g,u,s,a,c,Le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ge(p,y).publicKey:void 0):this.openPositionFromBaseInstruction(p,n.feePayer,y,n.wallet,f,h,x,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),o,r,b,g,u,s,a,c,Le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ge(p,y).publicKey:void 0);return{address:{nftMint:f,tickArrayLower:w,tickArrayUpper:k,positionNftAccount:h,metadataAccount:x,personalPosition:T,protocolPosition:B},instructions:[S],signers:m,instructionTypes:[V.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I,K){let O=N([Oe("tickLowerIndex"),Oe("tickUpperIndex"),Oe("tickArrayLowerStartIndex"),Oe("tickArrayUpperStartIndex"),$("liquidity"),P("amountMaxA"),P("amountMaxB"),_e("withMetadata"),F("optionBaseFlag"),_e("baseFlag")]),v=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],_=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:In.programId,isSigner:!1,isWritable:!1},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ti,isSigner:!1,isWritable:!1},{pubkey:Xt,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...v],D=Buffer.alloc(O.span);O.encode({tickLowerIndex:w,tickUpperIndex:k,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:x,liquidity:new La(0),amountMaxA:B==="MintA"?S:I,amountMaxB:B==="MintA"?I:S,withMetadata:T==="create",baseFlag:B==="MintA",optionBaseFlag:1},D);let q=Buffer.from([...Mt.openPosition,...D]);return new mt({keys:_,programId:e,data:q})}static openPositionFromBaseInstruction22(e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I){let K=N([Oe("tickLowerIndex"),Oe("tickUpperIndex"),Oe("tickArrayLowerStartIndex"),Oe("tickArrayUpperStartIndex"),$("liquidity"),P("amountMaxA"),P("amountMaxB"),_e("withMetadata"),F("optionBaseFlag"),_e("baseFlag")]),O=[...I?[{pubkey:I,isSigner:!1,isWritable:!0}]:[]],v=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:In.programId,isSigner:!1,isWritable:!1},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ti,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...O],_=Buffer.alloc(K.span);K.encode({tickLowerIndex:g,tickUpperIndex:w,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:h,liquidity:new La(0),amountMaxA:T==="MintA"?B:S,amountMaxB:T==="MintA"?S:B,withMetadata:x==="create",baseFlag:T==="MintA",optionBaseFlag:1},_);let D=Buffer.from([...Mt.openPositionWithTokenEx,..._]);return new mt({keys:v,programId:e,data:D})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:r,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:d}){let m,p=[];if(l)m=new U((await l(1))[0]);else{let I=Er.generate();p.push(I),m=I.publicKey}let[y,f]=[new U(e.programId),new U(e.id)],b=H.getTickArrayStartIndexByTick(o,e.config.tickSpacing),g=H.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:w}=ge(y,f,b),{publicKey:k}=ge(y,f,g),{publicKey:h}=d?Z(n.wallet,m,Ve):Z(n.wallet,m,Be),{publicKey:x}=hn(m),{publicKey:T}=Tt(y,m),{publicKey:B}=tn(y,f,o,r),S=d?this.openPositionFromLiquidityInstruction22(y,n.wallet,f,n.wallet,m,h,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(t.mintA.address),new U(t.mintB.address),o,r,b,g,s,a,c,u,Le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ge(y,f).publicKey:void 0):this.openPositionFromLiquidityInstruction(y,n.wallet,f,n.wallet,m,h,x,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(t.mintA.address),new U(t.mintB.address),o,r,b,g,s,a,c,u,Le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ge(y,f).publicKey:void 0);return{address:{nftMint:m,tickArrayLower:w,tickArrayUpper:k,positionNftAccount:h,metadataAccount:x,personalPosition:T,protocolPosition:B},instructions:[S],signers:p,instructionTypes:[V.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,o,r,s){let a=N([]),c=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:In.programId,isSigner:!1,isWritable:!1},{pubkey:s?Ve:Be,isSigner:!1,isWritable:!1}],u=Buffer.alloc(a.span);a.encode({},u);let l=Buffer.from([...Mt.closePosition,...u]);return new mt({keys:c,programId:e,data:l})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:o,nft2022:r}){let s=new U(e.programId),a=r?Z(n.wallet,o.nftMint,Ve).publicKey:Z(n.wallet,o.nftMint,Be).publicKey,{publicKey:c}=Tt(s,o.nftMint),u=[];return u.push(this.closePositionInstruction(s,n.wallet,o.nftMint,a,c,r)),{address:{positionNftAccount:a,personalPosition:c},signers:[],instructions:u,instructionTypes:[V.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g,w){let k=N([$("liquidity"),P("amountMaxA"),P("amountMaxB"),F("optionBaseFlag"),_e("baseFlag")]),h=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[]],x=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...h],T=Buffer.alloc(k.span);k.encode({liquidity:f,amountMaxA:b,amountMaxB:g,optionBaseFlag:0,baseFlag:!1},T);let B=Buffer.from([...Mt.increaseLiquidity,...T]);return new mt({keys:x,programId:e,data:B})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,liquidity:r,amountMaxA:s,amountMaxB:a,nft2022:c}){let[u,l]=[new U(e.programId),new U(e.id)],d=H.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=H.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=ge(u,l,d),{publicKey:y}=ge(u,l,m),{publicKey:f}=c?Z(o.wallet,n.nftMint,Ve):Z(o.wallet,n.nftMint,Be),{publicKey:b}=Tt(u,n.nftMint),{publicKey:g}=tn(u,l,n.tickLower,n.tickUpper),w=this.increasePositionFromLiquidityInstruction(u,o.wallet,f,b,l,g,p,y,o.tokenAccountA,o.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),r,s,a,Le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[d,m])?Ge(u,l).publicKey:void 0);return{address:{tickArrayLower:p,tickArrayUpper:y,positionNftAccount:f,personalPosition:b,protocolPosition:g},signers:[],instructions:[w],instructionTypes:[V.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,base:r,baseAmount:s,otherAmountMax:a,nft2022:c}){let[u,l]=[new U(e.programId),new U(e.id)],d=H.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=H.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=ge(u,l,d),{publicKey:y}=ge(u,l,m),{publicKey:f}=c?Z(o.wallet,n.nftMint,Ve):Z(o.wallet,n.nftMint,Be),{publicKey:b}=Tt(u,n.nftMint),{publicKey:g}=tn(u,l,n.tickLower,n.tickUpper);return{address:{tickArrayLower:p,tickArrayUpper:y,positionNftAccount:f,personalPosition:b,protocolPosition:g},instructions:[this.increasePositionFromBaseInstruction(u,o.wallet,f,b,l,g,p,y,o.tokenAccountA,o.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),r,s,a,Le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[d,m])?Ge(u,l).publicKey:void 0)],signers:[],instructionTypes:[V.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g,w){let k=N([$("liquidity"),P("amountMaxA"),P("amountMaxB"),F("optionBaseFlag"),_e("baseFlag")]),h=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[]],x=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...h],T=Buffer.alloc(k.span);k.encode({liquidity:new La(0),amountMaxA:f==="MintA"?b:g,amountMaxB:f==="MintA"?g:b,baseFlag:f==="MintA",optionBaseFlag:1},T);let B=Buffer.from([...Mt.increaseLiquidity,...T]);return new mt({keys:x,programId:e,data:B})}static decreaseLiquidityInstruction(e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g,w,k){let h=N([$("liquidity"),P("amountMinA"),P("amountMinB")]),x=[...k?[{pubkey:k,isSigner:!1,isWritable:!0}]:[],...f.map(I=>[{pubkey:I.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:I.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:I.rewardMint,isSigner:!1,isWritable:!1}]).flat()],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:ir,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...x],B=Buffer.alloc(h.span);h.encode({liquidity:b,amountMinA:g,amountMinB:w},B);let S=Buffer.from([...Mt.decreaseLiquidity,...B]);return new mt({keys:T,programId:e,data:S})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,liquidity:r,amountMinA:s,amountMinB:a,programId:c,nft2022:u}){let[l,d]=[new U(e.programId),new U(e.id)],m=H.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),p=H.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:y}=ge(l,d,m),{publicKey:f}=ge(l,d,p),{publicKey:b}=u?Z(o.wallet,n.nftMint,Ve):Z(o.wallet,n.nftMint,c),{publicKey:g}=Tt(l,n.nftMint),{publicKey:w}=tn(l,d,n.tickLower,n.tickUpper),k=[];for(let T=0;T<e.rewardDefaultInfos.length;T++)k.push({poolRewardVault:new U(t.rewardInfos[T].vault),ownerRewardVault:o.rewardAccounts[T],rewardMint:new U(e.rewardDefaultInfos[T].mint.address)});let h=[],x=this.decreaseLiquidityInstruction(l,o.wallet,b,g,d,w,y,f,o.tokenAccountA,o.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),k,r,s,a,Le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,p])?Ge(l,d).publicKey:void 0);return h.push(x),{address:{tickArrayLower:y,tickArrayUpper:f,positionNftAccount:b,personalPosition:g,protocolPosition:w},signers:[],instructions:h,instructionTypes:[V.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g){let w=N([P("amount"),P("otherAmountThreshold"),$("sqrtPriceLimitX64"),_e("isBaseInput")]),k=[...g?[{pubkey:g,isSigner:!1,isWritable:!0}]:[],...d.map(B=>({pubkey:B,isSigner:!1,isWritable:!0}))],h=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:ir,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...k],x=Buffer.alloc(w.span);w.encode({amount:p,otherAmountThreshold:y,sqrtPriceLimitX64:f,isBaseInput:b},x);let T=Buffer.from([...Mt.swap,...x]);return new mt({keys:h,programId:e,data:T})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:o,inputMint:r,amountIn:s,amountOutMin:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,d]=[new U(e.programId),new U(e.id)],[m,p]=[new U(t.vault.A),new U(t.vault.B)],[y,f]=[new U(e.mintA.address),new U(e.mintB.address)],b=e.mintA.address===r.toString(),g=[this.swapInstruction(l,o.wallet,d,new U(e.config.id),b?o.tokenAccountA:o.tokenAccountB,b?o.tokenAccountB:o.tokenAccountA,b?m:p,b?p:m,b?y:f,b?f:y,u,n,s,a,c,!0,Ge(l,d).publicKey)];return{signers:[],instructions:g,instructionTypes:[V.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static makeSwapBaseOutInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:o,outputMint:r,amountOut:s,amountInMax:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,d]=[new U(e.programId),new U(e.id)],[m,p]=[new U(t.vault.A),new U(t.vault.B)],[y,f]=[new U(e.mintA.address),new U(e.mintB.address)],b=e.mintA.address===r.toBase58(),g=[this.swapInstruction(l,o.wallet,d,new U(e.config.id),b?o.tokenAccountB:o.tokenAccountA,b?o.tokenAccountA:o.tokenAccountB,b?p:m,b?m:p,b?f:y,b?y:f,u,n,s,a,c,!1,Ge(l,d).publicKey)];return{signers:[],instructions:g,instructionTypes:[V.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,o,r,s,a,c,u,l,d,m){let p=N([P("openTime"),P("endTime"),$("emissionsPerSecondX64")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:In.programId,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({openTime:Y(l),endTime:Y(d),emissionsPerSecondX64:m},f);let b=Buffer.from([...Mt.initReward,...f]);return new mt({keys:y,programId:e,data:b})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:o}){let[r,s]=[new U(e.programId),new U(e.id)],a=Zc(r,s,o.mint).publicKey,c=gi(r).publicKey,u=[this.initRewardInstruction(r,n.wallet,s,c,new U(e.config.id),n.tokenAccount,o.programId,o.mint,a,o.openTime,o.endTime,o.emissionsPerSecondX64)];return{address:{poolRewardVault:a,operationId:c},signers:[],instructions:u,instructionTypes:[V.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,o,r,s,a,c,u,l,d,m){let p=N([F("rewardIndex"),$("emissionsPerSecondX64"),P("openTime"),P("endTime")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0}],f=Buffer.alloc(p.span);p.encode({rewardIndex:u,emissionsPerSecondX64:m,openTime:Y(l),endTime:Y(d)},f);let b=Buffer.from([...Mt.setRewardEmissions,...f]);return new mt({keys:y,programId:e,data:b})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:o}){let[r,s]=[new U(e.programId),new U(e.id)],a,c,u;for(let m=0;m<e.rewardDefaultInfos.length;m++)e.rewardDefaultInfos[m].mint.address===o.mint.toString()&&(a=m,c=new U(t.rewardInfos[m].vault),u=new U(t.rewardInfos[m].mint.address));(a===void 0||c===void 0)&&sl.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=gi(r).publicKey,d=[this.setRewardInstruction(r,n.wallet,s,l,new U(e.config.id),n.tokenAccount,c,u,a,o.openTime,o.endTime,o.emissionsPerSecondX64)];return{address:{rewardVault:c,operationId:l},signers:[],instructions:d,instructionTypes:[V.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,o,r,s,a){let c=N([F("rewardIndex")]),u=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:ir,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({rewardIndex:a},l);let d=Buffer.from([...Mt.collectReward,...l]);return new mt({keys:u,programId:e,data:d})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:o}){let[r,s]=[new U(e.programId),new U(e.id)],a,c;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===o.toString()&&(a=l,c=new U(t.rewardInfos[l].vault));(a===void 0||c===void 0)&&sl.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let u=[this.collectRewardInstruction(r,n.wallet,s,n.tokenAccount,c,o,a)];return{address:{rewardVault:c},signers:[],instructions:u,instructionTypes:[V.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static async makeLockPositions({programId:e,authProgramId:t,poolProgramId:n,payer:o,wallet:r,nftMint:s,nft2022:a,getEphemeralSigners:c}){let u=[],l;if(c)l=new U((await c(1))[0]);else{let g=Er.generate();u.push(g),l=g.publicKey}let d=a?Z(r,s,Ve).publicKey:Z(r,s,Be).publicKey,{publicKey:m}=Tt(n,s),p=Ai(e,l).publicKey,y=Z(r,l,Be).publicKey,f=hn(l).publicKey,b=xe.lockPositionInstructionV2({programId:e,auth:t,payer:o,positionOwner:r,lockOwner:r,positionNftAccount:d,positionId:m,lockPositionId:p,lockNftMint:l,lockNftAccount:y,metadataAccount:f,withMetadata:!0,nft2022:a,positionNftMint:s,authPositionNftAccount:Z(t,s,a?Ve:Be).publicKey,positionNftProgram:a?Ve:Be});return{address:{positionId:m,lockPositionId:p,lockNftAccount:y,lockNftMint:l,positionNftAccount:d,metadataAccount:f},instructions:[b],signers:u,instructionTypes:[V.ClmmLockPosition],lookupTableAddress:[]}}static lockPositionInstructionV2({programId:e,auth:t,payer:n,positionOwner:o,lockOwner:r,positionNftAccount:s,positionId:a,positionNftMint:c,authPositionNftAccount:u,positionNftProgram:l,lockPositionId:d,lockNftMint:m,lockNftAccount:p,metadataAccount:y,withMetadata:f}){let b=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!0,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:Xt,isSigner:!1,isWritable:!1},{pubkey:Ti,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:In.programId,isSigner:!1,isWritable:!1}],g=N([_e("withMetadata")]),w=Buffer.alloc(g.span);g.encode({withMetadata:f},w);let k=Buffer.from([...al,...w]);return new mt({keys:b,programId:e,data:k})}static lockPositionInstruction({programId:e,authProgramId:t,poolProgramId:n,owner:o,positionNft:r}){let{publicKey:s}=Z(o,r,Be),{publicKey:a}=Tt(n,r),c=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:Ba(e,a).publicKey,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:In.programId,isSigner:!1,isWritable:!1}];return new mt({keys:c,programId:e,data:Buffer.from(al)})}static harvestLockPositionInstruction(e){let[t,n]=[new U(e.poolKeys.programId),new U(e.poolKeys.id)],o=H.getTickArrayStartIndexByTick(e.ownerPosition.tickLower,e.poolKeys.config.tickSpacing),r=H.getTickArrayStartIndexByTick(e.ownerPosition.tickUpper,e.poolKeys.config.tickSpacing),{publicKey:s}=ge(t,n,o),{publicKey:a}=ge(t,n,r),{publicKey:c}=Z(e.owner,e.ownerPosition.nftMint,Be),{publicKey:u}=Tt(t,e.ownerPosition.nftMint),{publicKey:l}=tn(t,n,e.ownerPosition.tickLower,e.ownerPosition.tickUpper),d=[];for(let y=0;y<e.poolKeys.rewardInfos.length;y++)d.push({poolRewardVault:new U(e.poolKeys.rewardInfos[y].vault),ownerRewardVault:e.ownerRewardAccounts[y],rewardMint:new U(e.poolKeys.rewardInfos[y].mint.address)});let m=[...d.map(y=>[{pubkey:y.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:y.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:y.rewardMint,isSigner:!1,isWritable:!1}]).flat()],p=[{pubkey:e.authProgramId,isSigner:!1,isWritable:!1},{pubkey:Ba(e.programId,u).publicKey,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e.owner,isSigner:!0,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:new U(e.poolKeys.vault.A),isSigner:!1,isWritable:!0},{pubkey:new U(e.poolKeys.vault.B),isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:e.userVaultA,isSigner:!1,isWritable:!0},{pubkey:e.userVaultB,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:an,isSigner:!1,isWritable:!1},{pubkey:new U(e.poolKeys.mintA.address),isSigner:!1,isWritable:!1},{pubkey:new U(e.poolKeys.mintB.address),isSigner:!1,isWritable:!1},...m];return new mt({keys:p,programId:e.programId,data:Buffer.from(ul)})}static harvestLockPositionInstructionV2({programId:e,auth:t,lockPositionId:n,clmmProgram:o,lockOwner:r,lockNftMint:s,lockNftAccount:a,positionNftAccount:c,positionId:u,poolId:l,protocolPosition:d,vaultA:m,vaultB:p,tickArrayLower:y,tickArrayUpper:f,userVaultA:b,userVaultB:g,mintA:w,mintB:k,rewardAccounts:h,exTickArrayBitmap:x}){let T=[...x?[{pubkey:x,isSigner:!1,isWritable:!0}]:[],...h.map(S=>[{pubkey:S.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:S.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:S.rewardMint,isSigner:!1,isWritable:!1}]).flat()],B=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:an,isSigner:!1,isWritable:!1},{pubkey:w,isSigner:!1,isWritable:!1},{pubkey:k,isSigner:!1,isWritable:!1},...T];return new mt({keys:B,programId:e,data:Buffer.from(ul)})}};var cl=N([lt("mintAuthorityOption"),L("mintAuthority"),P("supply"),F("decimals"),F("isInitialized"),lt("freezeAuthorityOption"),L("freezeAuthority")]);import{PublicKey as ty}from"@solana/web3.js";import{MintLayout as ll,TOKEN_PROGRAM_ID as ny}from"@solana/spl-token";var TB=async({connection:i,mint:e})=>{let t=await i.getAccountInfo(new ty(e));return!t||t.data.length!==ll.span?void 0:ll.decode(t.data)},IB=({mint:i,decimals:e,programId:t=ny,logoURI:n="",priority:o=3})=>{let r=i.toBase58().substring(0,6);return{address:i.toBase58(),decimals:e,symbol:r,logoURI:n,extensions:{},chainId:101,programId:t.toString(),name:r,tags:[],priority:o}},_r=i=>new Te({mint:i.address,decimals:i.decimals,symbol:i.symbol,name:i.name}),Ii=({amount:i,isRaw:e,name:t,...n})=>new we(new Te({mint:ft(n.address).toBase58(),decimals:n.decimals,symbol:n.symbol,name:t}),i,e,t);function BB(i){return i.address===sn.address?it:i}function xB(i){return i.address===it.address?sn:i}var At=({address:i,programId:e,decimals:t,...n})=>({chainId:101,address:ft(i).toBase58(),programId:e,logoURI:"",symbol:"",name:"",decimals:t,tags:[],extensions:n.extensions||{},...n}),Wn=i=>i?{...i,transferFeeConfigAuthority:i.transferFeeConfigAuthority.toBase58(),withdrawWithheldAuthority:i.withdrawWithheldAuthority.toBase58(),withheldAmount:i.withheldAmount.toString(),olderTransferFee:{...i.olderTransferFee,epoch:i.olderTransferFee.epoch.toString(),maximumFee:i.olderTransferFee.maximumFee.toString()},newerTransferFee:{...i.newerTransferFee,epoch:i.newerTransferFee.epoch.toString(),maximumFee:i.newerTransferFee.maximumFee.toString()}}:void 0;import ml from"bn.js";var Ra=new ml(25),Fr=new ml(1e4),oy={4:3,5:3};import{PublicKey as Se,SystemProgram as Pl,SYSVAR_RENT_PUBKEY as gy,TransactionInstruction as Bn}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Ay,TOKEN_PROGRAM_ID as Co}from"@solana/spl-token";var Na=N([F("instruction"),P("amountIn"),P("minAmountOut")]),Oa=N([F("instruction"),P("maxAmountIn"),P("amountOut")]),_B=N([F("instruction"),F("nonce")]),va=N([F("instruction"),F("nonce"),P("startTime")]),no=N([P("status"),P("nonce"),P("maxOrder"),P("depth"),P("baseDecimal"),P("quoteDecimal"),P("state"),P("resetFlag"),P("minSize"),P("volMaxCutRatio"),P("amountWaveRatio"),P("baseLotSize"),P("quoteLotSize"),P("minPriceMultiplier"),P("maxPriceMultiplier"),P("systemDecimalValue"),P("minSeparateNumerator"),P("minSeparateDenominator"),P("tradeFeeNumerator"),P("tradeFeeDenominator"),P("pnlNumerator"),P("pnlDenominator"),P("swapFeeNumerator"),P("swapFeeDenominator"),P("baseNeedTakePnl"),P("quoteNeedTakePnl"),P("quoteTotalPnl"),P("baseTotalPnl"),P("poolOpenTime"),P("punishPcAmount"),P("punishCoinAmount"),P("orderbookToInitTime"),$("swapBaseInAmount"),$("swapQuoteOutAmount"),P("swapBase2QuoteFee"),$("swapQuoteInAmount"),$("swapBaseOutAmount"),P("swapQuote2BaseFee"),L("baseVault"),L("quoteVault"),L("baseMint"),L("quoteMint"),L("lpMint"),L("openOrders"),L("marketId"),L("marketProgramId"),L("targetOrders"),L("withdrawQueue"),L("lpVault"),L("owner"),P("lpReserve"),X(P(),3,"padding")]),iy=N([P("accountType"),P("status"),P("nonce"),P("maxOrder"),P("depth"),P("baseDecimal"),P("quoteDecimal"),P("state"),P("resetFlag"),P("minSize"),P("volMaxCutRatio"),P("amountWaveRatio"),P("baseLotSize"),P("quoteLotSize"),P("minPriceMultiplier"),P("maxPriceMultiplier"),P("systemDecimalsValue"),P("abortTradeFactor"),P("priceTickMultiplier"),P("priceTick"),P("minSeparateNumerator"),P("minSeparateDenominator"),P("tradeFeeNumerator"),P("tradeFeeDenominator"),P("pnlNumerator"),P("pnlDenominator"),P("swapFeeNumerator"),P("swapFeeDenominator"),P("baseNeedTakePnl"),P("quoteNeedTakePnl"),P("quoteTotalPnl"),P("baseTotalPnl"),P("poolOpenTime"),P("punishPcAmount"),P("punishCoinAmount"),P("orderbookToInitTime"),$("swapBaseInAmount"),$("swapQuoteOutAmount"),$("swapQuoteInAmount"),$("swapBaseOutAmount"),P("swapQuote2BaseFee"),P("swapBase2QuoteFee"),L("baseVault"),L("quoteVault"),L("baseMint"),L("quoteMint"),L("lpMint"),L("modelDataAccount"),L("openOrders"),L("marketId"),L("marketProgramId"),L("targetOrders"),L("owner"),X(P(),64,"padding")]),Ma=N([F("instruction"),P("baseAmountIn"),P("quoteAmountIn"),P("fixedSide"),P("otherAmountMin")]),Ea=N([F("instruction"),P("lpAmount"),P("baseAmountMin"),P("quoteAmountMin")]),FB={4:no,5:iy},dl=N([P("fee")]);import{PublicKey as ry}from"@solana/web3.js";var Ko=new ry("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),io=5e4,sy=N([P("x"),P("y"),P("price")]),ay=N([P("accountType"),P("status"),P("multiplier"),P("validDataCount"),X(sy,io,"DataElement")]);function uy(i,e){return[0,io-2]}function cy(i){return[0,io-2]}function ly(i){return[0,io-2]}function my(i,e,t){let[n,o]=uy(e,t),r=n,s=o,a=0,c=e*i.multiplier/t;for(;r<=s;){if(a=Math.floor((s+r)/2),a===0||a>=io-2)return[a,a,!1];let u=i.DataElement[a].x*i.multiplier/i.DataElement[a].y,l=i.DataElement[a-1].x*i.multiplier/i.DataElement[a-1].y,d=i.DataElement[a+1].x*i.multiplier/i.DataElement[a+1].y;if(c===u)return[a,a,!0];if(c===l)return[a-1,a-1,!0];if(c===d)return[a+1,a+1,!0];if(c<l)s=a-1;else{if(c>l&&c<u)return[a-1,a,!0];if(c>u&&c<d)return[a,a+1,!0];r=a+1}}return[a,a,!1]}function _a(i,e,t){let[n,o,r]=my(i,e,t);if(!r)return 0;if(n===o){let s=i.DataElement[n].x;return e*i.multiplier/s}else{let s=i.DataElement[n].x,a=i.DataElement[n].y,c=i.DataElement[o].x,u=i.DataElement[o].y,l=t*(c*a-s*u),d=s*l,m=(c-s)*(e*a-s*t)*u,p=d+m;return e*i.multiplier*l/p}}function oo(i,e,t){return e*i.multiplier/t}function pl(i,e,t){return e*t/i.multiplier}function dy(i,e){let[t,n]=cy(e),o=t,r=n,s=0,a=e;for(;o<r;){if(s=Math.floor((r+o)/2),s<=0||s>io-2)return[s,s,!1];let c=i.DataElement[s].x,u=i.DataElement[s-1].x,l=i.DataElement[s+1].x;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<u)r=s-1;else{if(a>u&&a<c)return[s-1,s,!0];if(a>c&&a<l)return[s,s+1,!0];o=s+1}}return[s,s,!1]}function py(i,e){let[t,n]=ly(e),o=t,r=n,s=0,a=e;for(;o<=r;){if(s=Math.floor((r+o)/2),s<=0||s>=io-2)return[s,s,!1];let c=i.DataElement[s].y,u=i.DataElement[s-1].y,l=i.DataElement[s+1].y;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<l)o=s+1;else{if(a<u&&a>c)return[s-1,s,!0];if(a<c&&a>l)return[s,s+1,!0];r=s-1}}return[s,s,!1]}function fl(i,e,t,n){let o=n?e+t:e-t,[r,s,a]=dy(i,o);if(!a)return[0,0,!1,a];if(r===s)return[i.DataElement[s].price,i.DataElement[s].y,!1,a];{let c=i.DataElement[r].x,u=i.DataElement[s].x,l=i.DataElement[r].price,d=i.DataElement[s].price,m=i.DataElement[r].y,p=i.DataElement[s].y;if(e>=c&&e<=u)return n?[d,p,!0,a]:[l,m,!0,a];{let y,f;return n?(y=l+(d-l)*(e-c)/(u-c),f=m-(o-c)*i.multiplier/d):(y=l+(d-l)*(e-c)/(u-c),f=p+(u-o)*i.multiplier/l),[y,f,!1,a]}}}function fy(i,e,t,n){let o=n?e-t:e+t,[r,s,a]=py(i,o);if(!a)return[0,0,!1,a];if(r===s)return[i.DataElement[s].price,i.DataElement[s].x,!1,a];{let c=i.DataElement[r].x,u=i.DataElement[s].x,l=i.DataElement[r].price,d=i.DataElement[s].price,m=i.DataElement[r].y,p=i.DataElement[s].y;if(e>=p&&e<=m)return n?[d,u,!0,a]:[l,c,!0,a];{let y,f;return n?(y=l+(d-l)*(m-e)/(m-p),f=c+d*(m-o)/i.multiplier):(y=l+(d-l)*(m-e)/(m-p),f=u-l*(o-p)/i.multiplier),[y,f,!1,a]}}}function yy(i,e){let t=fl(i,e,0,!1);return t[3]?t[0]:0}function yl(i,e,t,n){let o=_a(i,e,t),r=oo(i,e,o),s=oo(i,t,o),a=oo(i,n,o),c=!0,[u,l,d,m]=fl(i,r,a,c);if(!m)return 0;if(d)return n*i.multiplier/u;{let p=s-l;return pl(i,p,o)}}function bl(i,e,t,n){let o=_a(i,e,t),r=oo(i,e,o),s=oo(i,t,o),a=oo(i,n,o),c=!1,[u,l,d,m]=fy(i,s,a,c);if(!m)return 0;if(d)return n*u/i.multiplier;{let p=r-l;return pl(i,p,o)}}function by(i){let e=ay.decode(i);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function gl(i,e,t,n){let o=yy(i,oo(i,e,_a(i,e,t)))/i.multiplier;return n?o:1/o}var So=class{connection;_layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};constructor({connection:e}){this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(Ko);e&&(this._layoutData=by(e?.data))}}};var Al=pe("Raydium_liquidity_instruction");function wl(i){let{poolInfo:e,poolKeys:t,userKeys:n,baseAmountIn:o,quoteAmountIn:r,fixedSide:s,otherAmountMin:a}=i,c=Buffer.alloc(Ma.span);Ma.encode({instruction:3,baseAmountIn:Y(o),quoteAmountIn:Y(r),otherAmountMin:Y(a),fixedSide:s==="base"?ze:_u},c);let u=[A({pubkey:Co,isWritable:!1}),A({pubkey:new Se(e.id)}),A({pubkey:new Se(t.authority),isWritable:!1}),A({pubkey:new Se(t.openOrders),isWritable:!1}),A({pubkey:new Se(t.targetOrders)}),A({pubkey:new Se(e.lpMint.address)}),A({pubkey:new Se(t.vault.A)}),A({pubkey:new Se(t.vault.B)})];return e.pooltype.includes("StablePool")&&u.push(A({pubkey:Ko})),u.push(A({pubkey:new Se(e.marketId),isWritable:!1}),A({pubkey:n.baseTokenAccount}),A({pubkey:n.quoteTokenAccount}),A({pubkey:n.lpTokenAccount}),A({pubkey:n.owner,isWritable:!1,isSigner:!0}),A({pubkey:new Se(t.marketEventQueue),isWritable:!1})),new Bn({programId:new Se(e.programId),keys:u,data:c})}function Fa(i){let{poolInfo:e,poolKeys:t,userKeys:n,lpAmount:o,baseAmountMin:r,quoteAmountMin:s}=i,a=Re(t),c=4;if(e.pooltype.includes("StablePool")&&(c=5),c===4||c===5){let u=Buffer.alloc(Ea.span);Ea.encode({instruction:4,lpAmount:Y(o),baseAmountMin:Y(r),quoteAmountMin:Y(s)},u);let l=[A({pubkey:Co,isWritable:!1}),A({pubkey:a.id}),A({pubkey:a.authority,isWritable:!1}),A({pubkey:a.openOrders}),A({pubkey:a.targetOrders}),A({pubkey:a.mintLp.address}),A({pubkey:a.vault.A}),A({pubkey:a.vault.B})];return c===5?l.push(A({pubkey:Ko})):(l.push(A({pubkey:a.id})),l.push(A({pubkey:a.id}))),l.push(A({pubkey:a.marketProgramId,isWritable:!1}),A({pubkey:a.marketId}),A({pubkey:a.marketBaseVault}),A({pubkey:a.marketQuoteVault}),A({pubkey:a.marketAuthority,isWritable:!1}),A({pubkey:n.lpTokenAccount}),A({pubkey:n.baseTokenAccount}),A({pubkey:n.quoteTokenAccount}),A({pubkey:n.owner,isWritable:!1,isSigner:!0}),A({pubkey:a.marketEventQueue}),A({pubkey:a.marketBids}),A({pubkey:a.marketAsks})),new Bn({programId:a.programId,keys:l,data:u})}return new Bn({programId:a.programId,keys:[]})}function Va({programId:i,ammId:e,ammAuthority:t,ammOpenOrders:n,lpMint:o,coinMint:r,pcMint:s,coinVault:a,pcVault:c,withdrawQueue:u,ammTargetOrders:l,poolTempLp:d,marketProgramId:m,marketId:p,userWallet:y,userCoinVault:f,userPcVault:b,userLpVault:g,nonce:w,openTime:k,coinAmount:h,pcAmount:x,ammConfigId:T,feeDestinationId:B}){let S=N([F("instruction"),F("nonce"),P("openTime"),P("pcAmount"),P("coinAmount")]),I=[{pubkey:Co,isSigner:!1,isWritable:!1},{pubkey:Ay,isSigner:!1,isWritable:!1},{pubkey:Pl.programId,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:T,isSigner:!1,isWritable:!1},{pubkey:B,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!0,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0}],K=Buffer.alloc(S.span);return S.encode({instruction:1,nonce:w,openTime:k,coinAmount:h,pcAmount:x},K),{instruction:new Bn({keys:I,programId:i,data:K}),instructionType:V.AmmV4CreatePool}}function ex(i){let e=N([F("instruction"),F("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[A({pubkey:new Se(i.id),isWritable:!1}),A({pubkey:new Se(i.authority),isWritable:!1}),A({pubkey:new Se(i.openOrders),isWritable:!1}),A({pubkey:new Se(i.vault.A),isWritable:!1}),A({pubkey:new Se(i.vault.B),isWritable:!1}),A({pubkey:new Se(i.mintLp.address),isWritable:!1}),A({pubkey:new Se(i.marketId),isWritable:!1}),A({pubkey:new Se(i.marketEventQueue),isWritable:!1})];return new Bn({programId:new Se(i.programId),keys:n,data:t})}function Py({poolKeys:i,userKeys:e,amountIn:t,minAmountOut:n},o){let r=Re(i),s=Buffer.alloc(Na.span);Na.encode({instruction:9,amountIn:Y(t),minAmountOut:Y(n)},s);let a=[A({pubkey:Co,isWritable:!1}),A({pubkey:r.id}),A({pubkey:r.authority,isWritable:!1}),A({pubkey:r.openOrders})];return o===4&&a.push(A({pubkey:r.targetOrders})),a.push(A({pubkey:r.vault.A}),A({pubkey:r.vault.B})),o===5&&a.push(A({pubkey:Ko})),a.push(A({pubkey:r.marketProgramId,isWritable:!1}),A({pubkey:r.marketId}),A({pubkey:r.marketBids}),A({pubkey:r.marketAsks}),A({pubkey:r.marketEventQueue}),A({pubkey:r.marketBaseVault}),A({pubkey:r.marketQuoteVault}),A({pubkey:r.marketAuthority,isWritable:!1}),A({pubkey:e.tokenAccountIn}),A({pubkey:e.tokenAccountOut}),A({pubkey:e.owner,isWritable:!1,isSigner:!0})),new Bn({programId:r.programId,keys:a,data:s})}function wy({poolKeys:i,userKeys:e,maxAmountIn:t,amountOut:n},o){let r=Re(i),s=Buffer.alloc(Oa.span);Oa.encode({instruction:11,maxAmountIn:Y(t),amountOut:Y(n)},s);let a=[A({pubkey:Co,isWritable:!1}),A({pubkey:r.id}),A({pubkey:r.authority,isWritable:!1}),A({pubkey:r.openOrders}),A({pubkey:r.targetOrders}),A({pubkey:r.vault.A}),A({pubkey:r.vault.B})];return o===5&&a.push(A({pubkey:Ko})),a.push(A({pubkey:r.marketProgramId,isWritable:!1}),A({pubkey:r.marketId}),A({pubkey:r.marketBids}),A({pubkey:r.marketAsks}),A({pubkey:r.marketEventQueue}),A({pubkey:r.marketBaseVault}),A({pubkey:r.marketQuoteVault}),A({pubkey:r.marketAuthority,isWritable:!1}),A({pubkey:e.tokenAccountIn}),A({pubkey:e.tokenAccountOut}),A({pubkey:e.owner,isWritable:!1,isSigner:!0})),new Bn({programId:r.programId,keys:a,data:s})}function Vr(i){let{poolKeys:e,version:t,userKeys:n,amountIn:o,amountOut:r,fixedSide:s}=i;if(t===4||t===5){let a={poolKeys:e,userKeys:n};if(s==="in")return Py({...a,amountIn:o,minAmountOut:r},t);if(s==="out")return wy({...a,maxAmountIn:o,amountOut:r},t);Al.logWithError("invalid params","params",i)}throw Al.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}function tx({poolKeys:i,userKeys:e,startTime:t}){let n=Buffer.alloc(va.span);va.encode({instruction:0,nonce:5,startTime:Y(t)},n);let o=Re(i),r=[A({pubkey:Co,isWritable:!1}),A({pubkey:Pl.programId,isWritable:!1}),A({pubkey:gy,isWritable:!1}),A({pubkey:o.id}),A({pubkey:o.authority,isWritable:!1}),A({pubkey:o.openOrders}),A({pubkey:o.mintLp.address}),A({pubkey:o.mintA.address,isWritable:!1}),A({pubkey:o.mintB.address,isWritable:!1}),A({pubkey:o.vault.A,isWritable:!1}),A({pubkey:o.vault.B,isWritable:!1}),A({pubkey:o.id}),A({pubkey:o.targetOrders}),A({pubkey:e.lpTokenAccount}),A({pubkey:o.id,isWritable:!1}),A({pubkey:o.marketProgramId,isWritable:!1}),A({pubkey:o.marketId,isWritable:!1}),A({pubkey:e.payer,isSigner:!0})];return new Bn({programId:o.programId,keys:r,data:n})}function kl({poolKeys:i}){let e=N([F("instruction"),F("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[A({pubkey:new Se(i.id),isWritable:!1}),A({pubkey:new Se(i.authority),isWritable:!1}),A({pubkey:new Se(i.openOrders),isWritable:!1}),A({pubkey:new Se(i.vault.A),isWritable:!1}),A({pubkey:new Se(i.vault.B),isWritable:!1}),A({pubkey:new Se(i.mintLp.address),isWritable:!1}),A({pubkey:new Se(i.marketId),isWritable:!1}),A({pubkey:new Se(i.marketEventQueue),isWritable:!1})];return{instruction:new Bn({programId:new Se(i.programId),keys:n,data:t})}}import{PublicKey as xi}from"@solana/web3.js";import Bi from"bn.js";import{TOKEN_PROGRAM_ID as Ty}from"@solana/spl-token";import{PublicKey as ky}from"@solana/web3.js";var hy=pe("Raydium_liquidity_serum");function hl({programId:i,marketId:e}){let t=[e.toBuffer()],n=0,o;for(;n<100;){try{let r=t.concat(Buffer.from([n]),Buffer.alloc(7));o=ky.createProgramAddressSync(r,i)}catch(r){if(r instanceof TypeError)throw r;n++;continue}return{publicKey:o,nonce:n}}throw hy.logWithError("unable to find a viable program address nonce","params",{programId:i,marketId:e}),new Error("unable to find a viable program address nonce")}function Wr({programId:i}){let{publicKey:e}=ee([Buffer.from("amm_config_account_seed","utf-8")],i);return e}function ro({name:i,programId:e,marketId:t}){let{publicKey:n}=ee([e.toBuffer(),t.toBuffer(),Buffer.from(i,"utf-8")],e);return n}function Iy({programId:i,marketId:e}){let{publicKey:t}=ee([i.toBuffer(),e.toBuffer(),Buffer.from("open_order_associated_seed","utf-8")],i);return t}function qa({programId:i}){return ee([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],i)}function Ua({version:i,marketVersion:e,marketId:t,baseMint:n,quoteMint:o,baseDecimals:r,quoteDecimals:s,programId:a,marketProgramId:c}){let u=ro({name:"amm_associated_seed",programId:a,marketId:t}),l=ro({name:"lp_mint_associated_seed",programId:a,marketId:t}),{publicKey:d,nonce:m}=qa({programId:a}),p=ro({name:"coin_vault_associated_seed",programId:a,marketId:t}),y=ro({name:"pc_vault_associated_seed",programId:a,marketId:t}),f=ro({name:"temp_lp_token_associated_seed",programId:a,marketId:t}),b=Iy({programId:a,marketId:t}),g=ro({name:"target_associated_seed",programId:a,marketId:t}),w=ro({name:"withdraw_associated_seed",programId:a,marketId:t}),{publicKey:k}=hl({programId:c,marketId:t});return{id:u,baseMint:n,quoteMint:o,lpMint:l,baseDecimals:r,quoteDecimals:s,lpDecimals:r,version:i,programId:a,authority:d,nonce:m,baseVault:p,quoteVault:y,lpVault:f,openOrders:b,targetOrders:g,withdrawQueue:w,marketVersion:e,marketProgramId:c,marketId:t,marketAuthority:k,lookupTableAccount:xi.default,configId:Wr({programId:a})}}var Wa;async function Bx({connection:i,poolKeysList:e,config:t}){return e.find(o=>o.modelDataAccount)&&(Wa||(Wa=new So({connection:i}),await Wa.initStableModelLayout())),await Promise.all(e.map(async o=>{if(o.modelDataAccount){let r=kl({poolKeys:o});return(await zu(i,[r.instruction],"GetPoolData")).map(c=>{let u=Hu(c,"GetPoolData"),l=new Bi(An(u,"status")),d=Number(An(u,"coin_decimals")),m=Number(An(u,"pc_decimals")),p=Number(An(u,"lp_decimals")),y=new Bi(An(u,"pool_coin_amount")),f=new Bi(An(u,"pool_pc_amount")),b=new Bi(An(u,"pool_lp_supply")),g="0";try{g=An(u,"pool_open_time")}catch{}return{status:l,baseDecimals:d,quoteDecimals:m,lpDecimals:p,baseReserve:y,quoteReserve:f,lpSupply:b,startTime:new Bi(g)}})[0]}else{let[r,s,a,c]=await i.getMultipleAccountsInfo([new xi(o.id),new xi(o.vault.A),new xi(o.vault.B),new xi(o.mintLp.address)]);if(r===null)throw Error("fetch pool error");if(s===null)throw Error("fetch vaultAccA error");if(a===null)throw Error("fetch vaultAccB error");if(c===null)throw Error("fetch mintAccLp error");let u=no.decode(r.data),l=en.decode(s.data),d=en.decode(a.data),m=cl.decode(c.data);return{status:u.status,baseDecimals:u.baseDecimal.toNumber(),quoteDecimals:u.quoteDecimal.toNumber(),lpDecimals:m.decimals,baseReserve:l.amount.sub(u.baseNeedTakePnl),quoteReserve:d.amount.sub(u.quoteNeedTakePnl),lpSupply:u.lpReserve,startTime:u.poolOpenTime}}}))}var Da={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]},Dr=i=>{let e={},t=Ty.toBase58();return Object.keys(i).map(n=>{let o=i[n],[r,s]=[o.baseMint.toBase58(),o.quoteMint.toBase58()];e[n]={id:n,version:4,status:o.status.toNumber(),programId:o.programId.toBase58(),mintA:At({address:r,programId:t,decimals:o.baseDecimal.toNumber()}),mintB:At({address:s,programId:t,decimals:o.quoteDecimal.toNumber()}),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:o.poolPrice.toNumber(),mintAmountA:new C(o.mintAAmount.toString()).div(10**o.baseDecimal.toNumber()).toNumber(),mintAmountB:new C(o.mintBAmount.toString()).div(10**o.quoteDecimal.toNumber()).toNumber(),baseReserve:o.baseReserve,quoteReserve:o.quoteReserve,feeRate:new C(o.tradeFeeNumerator.toString()).div(o.tradeFeeDenominator.toString()).toNumber(),openTime:o.poolOpenTime.toString(),tvl:0,day:Da,week:Da,month:Da,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,type:"Standard",marketId:o.marketId.toBase58(),configId:Wr({programId:o.programId}).toBase58(),lpPrice:0,lpAmount:new C(o.lpReserve.toString()).div(10**Math.min(o.baseDecimal.toNumber(),o.quoteDecimal.toNumber())).toNumber(),lpMint:At({address:o.lpMint.toBase58(),programId:t,decimals:Math.min(o.baseDecimal.toNumber(),o.quoteDecimal.toNumber())}),burnPercent:0}}),e};import We from"bn.js";import{PublicKey as Si}from"@solana/web3.js";import Ki from"bn.js";import{TOKEN_PROGRAM_ID as xl}from"@solana/spl-token";import{SystemProgram as so,SYSVAR_RENT_PUBKEY as xy,Transaction as Tl,TransactionInstruction as Sy}from"@solana/web3.js";import{createInitializeAccountInstruction as Il,TOKEN_PROGRAM_ID as Bl}from"@solana/spl-token";function By(i="accountFlags"){let e=new Sr(i);return e.addBoolean("initialized"),e.addBoolean("market"),e.addBoolean("openOrders"),e.addBoolean("requestQueue"),e.addBoolean("eventQueue"),e.addBoolean("bids"),e.addBoolean("asks"),e}var Ga=N([he(5),By("accountFlags"),L("ownAddress"),P("vaultSignerNonce"),L("baseMint"),L("quoteMint"),L("baseVault"),P("baseDepositsTotal"),P("baseFeesAccrued"),L("quoteVault"),P("quoteDepositsTotal"),P("quoteFeesAccrued"),P("quoteDustThreshold"),L("requestQueue"),L("eventQueue"),L("bids"),L("asks"),P("baseLotSize"),P("quoteLotSize"),P("feeRateBps"),P("referrerRebatesAccrued"),he(7)]);function Ky({programId:i,marketInfo:e}){let t=N([F("version"),lt("instruction"),P("baseLotSize"),P("quoteLotSize"),$t("feeRateBps"),P("vaultSignerNonce"),P("quoteDustThreshold")]),n=[{pubkey:e.id,isSigner:!1,isWritable:!0},{pubkey:e.requestQueue,isSigner:!1,isWritable:!0},{pubkey:e.eventQueue,isSigner:!1,isWritable:!0},{pubkey:e.bids,isSigner:!1,isWritable:!0},{pubkey:e.asks,isSigner:!1,isWritable:!0},{pubkey:e.baseVault,isSigner:!1,isWritable:!0},{pubkey:e.quoteVault,isSigner:!1,isWritable:!0},{pubkey:e.baseMint,isSigner:!1,isWritable:!1},{pubkey:e.quoteMint,isSigner:!1,isWritable:!1},{pubkey:e.authority?e.quoteMint:xy,isSigner:!1,isWritable:!1}].concat(e.authority?{pubkey:e.authority,isSigner:!1,isWritable:!1}:[]).concat(e.authority&&e.pruneAuthority?{pubkey:e.pruneAuthority,isSigner:!1,isWritable:!1}:[]),o=Buffer.alloc(t.span);return t.encode({version:0,instruction:0,baseLotSize:e.baseLotSize,quoteLotSize:e.quoteLotSize,feeRateBps:e.feeRateBps,vaultSignerNonce:e.vaultSignerNonce,quoteDustThreshold:e.quoteDustThreshold},o),new Sy({keys:n,programId:i,data:o})}async function qr({connection:i,wallet:e,marketInfo:t}){let n=new Tl,o=await i.getMinimumBalanceForRentExemption(165);n.add(so.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.baseVault.seed,newAccountPubkey:t.baseVault.publicKey,lamports:o,space:165,programId:Bl}),so.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.quoteVault.seed,newAccountPubkey:t.quoteVault.publicKey,lamports:o,space:165,programId:Bl}),Il(t.baseVault.publicKey,t.baseMint,t.vaultOwner),Il(t.quoteVault.publicKey,t.quoteMint,t.vaultOwner),so.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.id.seed,newAccountPubkey:t.id.publicKey,lamports:await i.getMinimumBalanceForRentExemption(Ga.span),space:Ga.span,programId:t.programId}));let r=new Tl;return r.add(so.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.requestQueue.seed,newAccountPubkey:t.requestQueue.publicKey,lamports:t.lowestFeeMarket?6208320:await i.getMinimumBalanceForRentExemption(t.requestQueueSpace??5120+12),space:t.lowestFeeMarket?764:t.requestQueueSpace??5120+12,programId:t.programId}),so.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.eventQueue.seed,newAccountPubkey:t.eventQueue.publicKey,lamports:t.lowestFeeMarket?79594560:await i.getMinimumBalanceForRentExemption(t.eventQueueSpace??262144+12),space:t.lowestFeeMarket?11308:t.eventQueueSpace??262144+12,programId:t.programId}),so.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.bids.seed,newAccountPubkey:t.bids.publicKey,lamports:t.lowestFeeMarket?101977920:await i.getMinimumBalanceForRentExemption(t.orderbookQueueSpace??65536+12),space:t.lowestFeeMarket?14524:t.orderbookQueueSpace??65536+12,programId:t.programId}),so.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.asks.seed,newAccountPubkey:t.asks.publicKey,lamports:t.lowestFeeMarket?101977920:await i.getMinimumBalanceForRentExemption(t.orderbookQueueSpace??65536+12),space:t.lowestFeeMarket?14524:t.orderbookQueueSpace??65536+12,programId:t.programId}),Ky({programId:t.programId,marketInfo:{id:t.id.publicKey,requestQueue:t.requestQueue.publicKey,eventQueue:t.eventQueue.publicKey,bids:t.bids.publicKey,asks:t.asks.publicKey,baseVault:t.baseVault.publicKey,quoteVault:t.quoteVault.publicKey,baseMint:t.baseMint,quoteMint:t.quoteMint,baseLotSize:t.baseLotSize,quoteLotSize:t.quoteLotSize,feeRateBps:t.feeRateBps,vaultSignerNonce:t.vaultSignerNonce,quoteDustThreshold:t.quoteDustThreshold}})),[{transaction:n,signer:[],instructionTypes:[V.CreateAccount,V.CreateAccount,V.InitAccount,V.InitAccount]},{transaction:r,signer:[],instructionTypes:[V.CreateAccount,V.CreateAccount,V.CreateAccount,V.CreateAccount,V.CreateAccount,V.InitMarket]}]}var Lo=class extends Ne{async create({baseInfo:e,quoteInfo:t,lotSize:n,tickSize:o,dexProgramId:r,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u,assignSeed:l,txVersion:d,computeBudgetConfig:m,txTipConfig:p,feePayer:y}){let f=this.scope.ownerPubKey,b=l?`${e.mint.toBase58().slice(0,10)}-${t.mint.toBase58().slice(0,10)}-${l}`:void 0,g=Ue({fromPublicKey:f,programId:r,assignSeed:b&&`${b}-market`}),w=Ue({fromPublicKey:f,programId:r,assignSeed:b&&`${b}-request`}),k=Ue({fromPublicKey:f,programId:r,assignSeed:b&&`${b}-event`}),h=Ue({fromPublicKey:f,programId:r,assignSeed:b&&`${b}-bids`}),x=Ue({fromPublicKey:f,programId:r,assignSeed:b&&`${b}-asks`}),T=Ue({fromPublicKey:f,programId:xl,assignSeed:b&&`${b}-baseVault`}),B=Ue({fromPublicKey:f,programId:xl,assignSeed:b&&`${b}-quoteVault`}),S=0,I=new Ki(100);function K(){let ne=new Ki(0);for(;;)try{return{vaultOwner:Si.createProgramAddressSync([g.publicKey.toBuffer(),ne.toArrayLike(Buffer,"le",8)],r),vaultSignerNonce:ne}}catch{if(ne.iaddn(1),ne.gt(new Ki(25555)))throw Error("find vault owner error")}}let{vaultOwner:O,vaultSignerNonce:v}=K(),_=new Ki(Math.round(10**e.decimals*n)),D=new Ki(Math.round(n*10**t.decimals*o));if(_.eq(ze))throw Error("lot size is too small");if(D.eq(ze))throw Error("tick size or lot size is too small");let q=await qr({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:r,id:g,baseMint:e.mint,quoteMint:t.mint,baseVault:T,quoteVault:B,vaultOwner:O,requestQueue:w,eventQueue:k,bids:h,asks:x,feeRateBps:S,quoteDustThreshold:I,vaultSignerNonce:v,baseLotSize:_,quoteLotSize:D,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u}}),G=this.createTxBuilder(y);G.addInstruction({instructions:q[0].transaction.instructions,signers:q[0].signer});for await(let ne of q.slice(1,q.length))G.addInstruction({instructions:ne.transaction.instructions,signers:ne.signer,instructionTypes:ne.instructionTypes});return d===0?G.sizeCheckBuildV0({computeBudgetConfig:m,address:{marketId:g.publicKey,requestQueue:w.publicKey,eventQueue:k.publicKey,bids:h.publicKey,asks:x.publicKey,baseVault:T.publicKey,quoteVault:B.publicKey,baseMint:new Si(e.mint),quoteMint:new Si(t.mint)}}):G.sizeCheckBuild({computeBudgetConfig:m,address:{marketId:g.publicKey,requestQueue:w.publicKey,eventQueue:k.publicKey,bids:h.publicKey,asks:x.publicKey,baseVault:T.publicKey,quoteVault:B.publicKey,baseMint:new Si(e.mint),quoteMint:new Si(t.mint)}})}};var Ci=class extends Ne{stableLayout;constructor(e){super(e),this.stableLayout=new So({connection:this.scope.connection})}async initLayout(){await this.stableLayout.initStableModelLayout()}async load(){this.checkDisabled()}computePairAmount({poolInfo:e,amount:t,slippage:n,baseIn:o}){let r=new We(new C(t).mul(10**e[o?"mintA":"mintB"].decimals).toFixed(0)),s=_r(e[o?"mintB":"mintA"]),[a,c]=[new We(new C(e.mintAmountA).mul(10**e.mintA.decimals).toString()),new We(new C(e.mintAmountB).mul(10**e.mintB.decimals).toString())],u=new We(new C(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,C.ROUND_DOWN));this.logDebug("baseReserve:",a.toString(),"quoteReserve:",c.toString()),this.logDebug("tokenIn:",o?e.mintA.symbol:e.mintB.symbol,"amountIn:",r.toString(),"anotherToken:",o?e.mintB.symbol:e.mintA.symbol,"slippage:",`${n.toSignificant()}%`,"baseReserve",a.toString(),"quoteReserve",c.toString());let l=o?"base":"quote";this.logDebug("input side:",l);let d=ze;r.isZero()||(d=l==="base"?ar(r.mul(c),a):ar(r.mul(a),c)),this.logDebug("amountRaw:",d.toString(),"lpAmount:",u.toString());let m=ar(r.mul(u),l==="base"?a:c);this.logDebug("liquidity:",m.toString());let p=new De(new We(1)).add(n),y=new De(new We(1)).sub(n),f=p.mul(d).quotient,b=y.mul(d).quotient,g=new we(s,d),w=new we(s,f),k=new we(s,b);return this.logDebug("anotherAmount:",g.toFixed(),"maxAnotherAmount:",w.toFixed()),{anotherAmount:g,maxAnotherAmount:w,minAnotherAmount:k,liquidity:m}}async getAmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async addLiquidity(e){let{poolInfo:t,poolKeys:n,amountInA:o,amountInB:r,otherAmountMin:s,fixedSide:a,config:c,txVersion:u,computeBudgetConfig:l,txTipConfig:d,feePayer:m}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),this.logDebug("amountInA:",o,"amountInB:",r),(o.isZero()||r.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:o.toFixed(),amountInB:r.toFixed()});let{account:p}=this.scope,{bypassAssociatedCheck:y,checkCreateATAOwner:f}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...c},[b,g]=[o.token,r.token],w=await p.getCreatedTokenAccount({mint:b.mint,associatedOnly:!1}),k=await p.getCreatedTokenAccount({mint:g.mint,associatedOnly:!1});!w&&!k&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",p.tokenAccounts);let h=await p.getCreatedTokenAccount({mint:new He(t.lpMint.address)}),x=[b,g],T=[w,k],B=[o.raw,r.raw],S=o.token.mint.toBase58()===t.mintA.address?"base":"quote",I="base";["quote","base"].includes(S)||this.logAndCreateError("invalid fixedSide","fixedSide",a),S==="quote"?(x.reverse(),T.reverse(),B.reverse(),I=a==="a"?"quote":"base"):S==="base"&&(I=a==="a"?"base":"quote");let[K,O]=x,[v,_]=T,[D,q]=B,G=n??await this.getAmmPoolKeys(t.id),ne=this.createTxBuilder(m),{tokenAccount:ie,...de}=await p.handleTokenAccount({side:"in",amount:D,mint:K.mint,tokenAccount:v,bypassAssociatedCheck:y,checkCreateATAOwner:f});ne.addInstruction(de);let{tokenAccount:re,...ye}=await p.handleTokenAccount({side:"in",amount:q,mint:O.mint,tokenAccount:_,bypassAssociatedCheck:y,checkCreateATAOwner:f});ne.addInstruction(ye);let{tokenAccount:dt,...$e}=await p.handleTokenAccount({side:"out",amount:0,mint:new He(t.lpMint.address),tokenAccount:h,bypassAssociatedCheck:y,checkCreateATAOwner:f});return ne.addInstruction($e),ne.addInstruction({instructions:[wl({poolInfo:t,poolKeys:G,userKeys:{baseTokenAccount:ie,quoteTokenAccount:re,lpTokenAccount:dt,owner:this.scope.ownerPubKey},baseAmountIn:D,quoteAmountIn:q,otherAmountMin:s.raw,fixedSide:I})],instructionTypes:[t.pooltype.includes("StablePool")?V.AmmV5AddLiquidity:V.AmmV4AddLiquidity],lookupTableAddress:G.lookupTableAccount?[G.lookupTableAccount]:[]}),ne.addCustomComputeBudget(l),ne.addTipInstruction(d),u===0?await ne.buildV0():ne.build()}async removeLiquidity(e){this.scope.availability.removeStandardPosition===!1&&this.logAndCreateError("remove liquidity feature disabled in your region");let{poolInfo:t,poolKeys:n,lpAmount:o,baseAmountMin:r,quoteAmountMin:s,config:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:d}=e,m=n??await this.getAmmPoolKeys(t.id),[p,y,f]=[new He(t.mintA.address),new He(t.mintB.address),new He(t.lpMint.address)];this.logDebug("lpAmount:",o),this.logDebug("baseAmountMin:",r),this.logDebug("quoteAmountMin:",s),o.isZero()&&this.logAndCreateError("amount must greater than zero","lpAmount",o.toString());let{account:b}=this.scope,g=await b.getCreatedTokenAccount({mint:f,associatedOnly:!1});g||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",b.tokenAccounts);let w=await b.getCreatedTokenAccount({mint:p}),k=await b.getCreatedTokenAccount({mint:y}),h=this.createTxBuilder(d),{bypassAssociatedCheck:x,checkCreateATAOwner:T}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...a},{tokenAccount:B,...S}=await b.handleTokenAccount({side:"out",amount:0,mint:p,tokenAccount:w,bypassAssociatedCheck:x,checkCreateATAOwner:T});h.addInstruction(S);let{tokenAccount:I,...K}=await b.handleTokenAccount({side:"out",amount:0,mint:y,tokenAccount:k,bypassAssociatedCheck:x,checkCreateATAOwner:T});return h.addInstruction(K),h.addInstruction({instructions:[Fa({poolInfo:t,poolKeys:m,userKeys:{lpTokenAccount:g,baseTokenAccount:B,quoteTokenAccount:I,owner:this.scope.ownerPubKey},lpAmount:o,baseAmountMin:r,quoteAmountMin:s})],lookupTableAddress:m.lookupTableAccount?[m.lookupTableAccount]:[],instructionTypes:[t.pooltype.includes("StablePool")?V.AmmV5RemoveLiquidity:V.AmmV4RemoveLiquidity]}),h.addCustomComputeBudget(u),h.addTipInstruction(l),c===0?await h.buildV0():h.build()}async removeAllLpAndCreateClmmPosition({poolInfo:e,clmmPoolInfo:t,removeLpAmount:n,createPositionInfo:o,farmInfo:r,userFarmLpAmount:s,base:a,computeBudgetConfig:c,payer:u,userAuxiliaryLedgers:l,tokenProgram:d=Dn,checkCreateATAOwner:m=!0,getEphemeralSigners:p,txVersion:y,feePayer:f}){if((this.scope.availability.removeStandardPosition===!1||this.scope.availability.createConcentratedPosition===!1)&&this.logAndCreateError("remove liquidity or create position feature disabled in your region"),!(e.mintA.address===t.mintA.address||e.mintA.address===t.mintB.address)||!(e.mintB.address===t.mintA.address||e.mintB.address===t.mintB.address))throw Error("mint check error");let b=this.createTxBuilder(f),g={};for(let G of this.scope.account.tokenAccountRawInfos)(g[G.accountInfo.mint.toString()]===void 0||Z(this.scope.ownerPubKey,G.accountInfo.mint,Dn).publicKey.equals(G.pubkey))&&(g[G.accountInfo.mint.toString()]=G.pubkey);let w=g[e.lpMint.address];if(w===void 0)throw Error("find lp account error in trade accounts");let k=n.add(s??new We(0)),h=e.mintA.address===Te.WSOL.mint.toString(),x=e.mintB.address===Te.WSOL.mint.toString(),{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Dn,mint:new He(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:h?{payer:this.scope.ownerPubKey}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:!0,checkCreateATAOwner:m});if(b.addInstruction(B||{}),T===void 0)throw new Error("base token account not found");let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Dn,mint:new He(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:x?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:!0,checkCreateATAOwner:m});if(b.addInstruction(I||{}),S===void 0)throw new Error("quote token account not found");if(g[e.mintA.address]=T,g[e.mintB.address]=S,r!==void 0&&!s?.isZero()){let G=_t[r.programId],ne=bt({programId:new He(r.programId),poolId:new He(r.id),owner:this.scope.ownerPubKey,version:G}),ie,de=await this.scope.connection.getAccountInfo(ne);if(de&&(ie=Bo(G).decode(de.data)),G!==6&&!ie){let{instruction:Rt,instructionType:nn}=ci({id:new He(r.id),programId:new He(r.programId),version:G,ledger:ne,owner:this.scope.ownerPubKey});b.addInstruction({instructions:[Rt],instructionTypes:[nn]})}let re=[];for(let Rt of r.rewardInfos){let nn=Rt.mint.address===Te.WSOL.mint.toString();if(g[Rt.mint.address])re.push(g[Rt.mint.address]);else{let{account:yn,instructionParams:pt}=await this.scope.account.getOrCreateTokenAccount({mint:new He(Rt.mint.address),tokenProgram:d,owner:this.scope.ownerPubKey,skipCloseAccount:!nn,createInfo:{payer:u||this.scope.ownerPubKey},associatedOnly:!0,checkCreateATAOwner:m});yn||this.logAndCreateError("farm reward account not found:",Rt.mint.address),pt&&b.addInstruction(pt),re.push(yn)}}let ye=(await this.scope.api.fetchFarmKeysById({ids:r.id}))[0],dt={userAuxiliaryLedgers:l,amount:s,owner:this.scope.ownerPubKey,farmInfo:r,farmKeys:ye,lpAccount:w,rewardAccounts:re},$e=_t[r.programId],nt=$e===6?li(dt):$e===5?mi(dt):di(dt),It={3:V.FarmV3Withdraw,5:V.FarmV5Withdraw,6:V.FarmV6Withdraw};b.addInstruction({instructions:[nt],instructionTypes:[It[$e]]})}let K=await this.getAmmPoolKeys(e.id),O=Fa({poolInfo:e,poolKeys:K,userKeys:{lpTokenAccount:w,baseTokenAccount:T,quoteTokenAccount:S,owner:this.scope.ownerPubKey},lpAmount:k,baseAmountMin:0,quoteAmountMin:0});b.addInstruction({instructions:[O],instructionTypes:[e.pooltype.includes("StablePool")?V.AmmV5RemoveLiquidity:V.AmmV4RemoveLiquidity],lookupTableAddress:K.lookupTableAccount?[K.lookupTableAccount]:[]});let[v,_]=e.mintA.address===t.mintA.address?[T,S]:[S,T],D=await this.scope.clmm.getClmmPoolKeys(t.id),q=await xe.openPositionFromBaseInstructions({poolInfo:t,poolKeys:D,ownerInfo:{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:v,tokenAccountB:_},withMetadata:"create",...o,base:a,getEphemeralSigners:p});return b.addInstruction({instructions:[...q.instructions],signers:q.signers,instructionTypes:[...q.instructionTypes],lookupTableAddress:D.lookupTableAccount?[D.lookupTableAccount]:[]}),y===0?b.sizeCheckBuildV0({computeBudgetConfig:c}):b.sizeCheckBuild({computeBudgetConfig:c})}async createPoolV4({programId:e,marketInfo:t,baseMintInfo:n,quoteMintInfo:o,baseAmount:r,quoteAmount:s,startTime:a,ownerInfo:c,associatedOnly:u=!1,checkCreateATAOwner:l=!1,tokenProgram:d,txVersion:m,feeDestinationId:p,computeBudgetConfig:y,txTipConfig:f,feePayer:b}){let g=c.feePayer||this.scope.owner?.publicKey,w=c.useSOLBalance&&n.mint.equals(Ur),k=c.useSOLBalance&&o.mint.equals(Ur),h=this.createTxBuilder(b),{account:x,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({mint:n.mint,owner:this.scope.ownerPubKey,createInfo:w?{payer:g,amount:r}:void 0,notUseTokenAccount:w,skipCloseAccount:!w,associatedOnly:w?!1:u,checkCreateATAOwner:l});h.addInstruction(T||{});let{account:B,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:o.mint,owner:this.scope.ownerPubKey,createInfo:k?{payer:g,amount:s}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:u,checkCreateATAOwner:l});if(h.addInstruction(S||{}),x===void 0||B===void 0)throw Error("you don't has some token account");let I=Ua({version:4,marketVersion:3,marketId:t.marketId,baseMint:n.mint,quoteMint:o.mint,baseDecimals:n.decimals,quoteDecimals:o.decimals,programId:e,marketProgramId:t.programId}),K={programId:e,ammId:I.id,ammAuthority:I.authority,ammOpenOrders:I.openOrders,lpMint:I.lpMint,coinMint:I.baseMint,pcMint:I.quoteMint,coinVault:I.baseVault,pcVault:I.quoteVault,withdrawQueue:I.withdrawQueue,ammTargetOrders:I.targetOrders,poolTempLp:I.lpVault,marketProgramId:I.marketProgramId,marketId:I.marketId,ammConfigId:I.configId,feeDestinationId:p},{instruction:O,instructionType:v}=Va({...K,userWallet:this.scope.ownerPubKey,userCoinVault:x,userPcVault:B,userLpVault:Z(this.scope.ownerPubKey,I.lpMint,d).publicKey,nonce:I.nonce,openTime:a,coinAmount:r,pcAmount:s});return h.addInstruction({instructions:[O],instructionTypes:[v]}),h.addCustomComputeBudget(y),h.addTipInstruction(f),h.versionBuild({txVersion:m,extInfo:{address:K}})}async createMarketAndPoolV4({programId:e=Qo,marketProgram:t=Vs,feeDestinationId:n=Zu,tokenProgram:o,baseMintInfo:r,quoteMintInfo:s,baseAmount:a,quoteAmount:c,startTime:u,ownerInfo:l,lowestFeeMarket:d,assignSeed:m,associatedOnly:p=!1,checkCreateATAOwner:y=!1,lotSize:f=1,tickSize:b=.01,txVersion:g,computeBudgetConfig:w,txTipConfig:k,feePayer:h}){let x=this.scope.ownerPubKey,T=l.feePayer||this.scope.owner?.publicKey,B=l.useSOLBalance&&r.mint.equals(Ur),S=l.useSOLBalance&&s.mint.equals(Ur),I=m?`${r.mint.toBase58().slice(0,7)}-${s.mint.toBase58().slice(0,7)}-${m}`:void 0,K=Ue({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-market`}),O=Ue({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-request`}),v=Ue({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-event`}),_=Ue({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-bids`}),D=Ue({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-asks`}),q=Ue({fromPublicKey:x,programId:Dn,assignSeed:I&&`${I}-baseVault`}),G=Ue({fromPublicKey:x,programId:Dn,assignSeed:I&&`${I}-quoteVault`}),ne=0,ie=new We(100);function de(){let on=new We(0);for(;;)try{return{vaultOwner:He.createProgramAddressSync([K.publicKey.toBuffer(),on.toArrayLike(Buffer,"le",8)],t),vaultSignerNonce:on}}catch{if(on.iaddn(1),on.gt(new We(25555)))throw Error("find vault owner error")}}let{vaultOwner:re,vaultSignerNonce:ye}=de(),dt=new We(Math.round(10**r.decimals*f)),$e=new We(Math.round(f*10**s.decimals*b));if(dt.eq(ze))throw Error("lot size is too small");if($e.eq(ze))throw Error("tick size or lot size is too small");let nt=await qr({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:t,vaultOwner:re,baseMint:r.mint,quoteMint:s.mint,id:K,baseVault:q,quoteVault:G,requestQueue:O,eventQueue:v,bids:_,asks:D,feeRateBps:ne,quoteDustThreshold:ie,vaultSignerNonce:ye,baseLotSize:dt,quoteLotSize:$e,lowestFeeMarket:d}}),It=this.createTxBuilder(h);It.addInstruction({instructions:nt[0].transaction.instructions,signers:nt[0].signer});for await(let on of nt.slice(1,nt.length))It.addInstruction({instructions:on.transaction.instructions,signers:on.signer,instructionTypes:on.instructionTypes});let{account:Rt,instructionParams:nn}=await this.scope.account.getOrCreateTokenAccount({mint:r.mint,owner:this.scope.ownerPubKey,createInfo:B?{payer:T,amount:a}:void 0,notUseTokenAccount:B,skipCloseAccount:!B,associatedOnly:B?!1:p,checkCreateATAOwner:y,assignSeed:B&&I?`${I}-wsol`:void 0});It.addInstruction(nn||{});let{account:yn,instructionParams:pt}=await this.scope.account.getOrCreateTokenAccount({mint:s.mint,owner:this.scope.ownerPubKey,createInfo:S?{payer:T,amount:c}:void 0,notUseTokenAccount:S,skipCloseAccount:!S,associatedOnly:S?!1:p,checkCreateATAOwner:y,assignSeed:S&&I?`${I}-wsol`:void 0});if(It.addInstruction(pt||{}),Rt===void 0)throw Error("you don't has base token account");if(yn===void 0)throw Error("you don't has quote token account");let ot=Ua({version:4,marketVersion:3,marketId:K.publicKey,baseMint:r.mint,quoteMint:s.mint,baseDecimals:r.decimals,quoteDecimals:s.decimals,programId:e,marketProgramId:t}),ms={programId:e,ammId:ot.id,ammAuthority:ot.authority,ammOpenOrders:ot.openOrders,lpMint:ot.lpMint,coinMint:ot.baseMint,pcMint:ot.quoteMint,coinVault:ot.baseVault,pcVault:ot.quoteVault,withdrawQueue:ot.withdrawQueue,ammTargetOrders:ot.targetOrders,poolTempLp:ot.lpVault,marketProgramId:ot.marketProgramId,marketId:ot.marketId,ammConfigId:ot.configId,feeDestinationId:n},{instruction:im,instructionType:rm}=Va({...ms,userWallet:this.scope.ownerPubKey,userCoinVault:Rt,userPcVault:yn,userLpVault:Z(this.scope.ownerPubKey,ot.lpMint,o).publicKey,nonce:ot.nonce,openTime:u,coinAmount:a,pcAmount:c});It.addInstruction({instructions:[im],instructionTypes:[rm]});let mu=B||S?[nn?.instructions?.[0]||pt?.instructions?.[0]].filter(on=>!!on):void 0;return g===0?It.sizeCheckBuildV0({computeBudgetConfig:w,splitIns:mu,address:{requestQueue:O.publicKey,eventQueue:v.publicKey,bids:_.publicKey,asks:D.publicKey,baseVault:q.publicKey,quoteVault:G.publicKey,baseMint:new He(r.mint),quoteMint:new He(s.mint),...ms}}):It.sizeCheckBuild({computeBudgetConfig:w,splitIns:mu,address:{requestQueue:O.publicKey,eventQueue:v.publicKey,bids:_.publicKey,asks:D.publicKey,baseVault:q.publicKey,quoteVault:G.publicKey,baseMint:new He(r.mint),quoteMint:new He(s.mint),...ms}})}async getCreatePoolFee({programId:e}){let t=Wr({programId:e}),n=await this.scope.connection.getAccountInfo(t,{dataSlice:{offset:536,length:8}});if(n===null)throw Error("get config account error");return dl.decode(n.data).fee}computeAmountOut({poolInfo:e,amountIn:t,mintIn:n,mintOut:o,slippage:r}){let[s,a]=[n.toString(),o.toString()];if(s!==e.mintA.address&&s!==e.mintB.address)throw new Error("toke not match");if(a!==e.mintA.address&&a!==e.mintB.address)throw new Error("toke not match");let{baseReserve:c,quoteReserve:u}=e,l=[c,u],d=[e.mintA.decimals,e.mintB.decimals],m=s==e.mintA.address?"base":"quote";m==="quote"&&(l.reverse(),d.reverse());let[p,y]=l,[f,b]=d,g=e.version===4,w;if(g)w=new C(y.toString()).div(10**b).div(new C(p.toString()).div(10**f));else{let v=gl(this.stableLayout.stableModelData,c.toNumber(),u.toNumber(),!1);m==="quote"?w=new C(1e6).div(v*1e6):w=new C(v*1e6).div(1e6)}let k=t,h=new We(0),x=new We(0);if(!k.isZero())if(g){x=Ht(k.mul(Ra),Fr);let v=k.sub(x),_=p.add(v);h=y.mul(v).div(_)}else{x=k.mul(new We(2)).div(new We(1e4));let v=k.sub(x);m==="quote"?h=new We(yl(this.stableLayout.stableModelData,u.toNumber(),c.toNumber(),v.toNumber())):h=new We(bl(this.stableLayout.stableModelData,u.toNumber(),c.toNumber(),v.toNumber()))}let T=new We(new C(h.toString()).mul(1-r).toFixed(0)),B=h,S=T,I=new C(h.toString()).div(new C(k.sub(x).toString()).toFixed(0));!k.isZero()&&!h.isZero()&&(I=new C(h.toString()).div(10**b).div(new C(k.sub(x).toString()).div(10**f)));let K=w.sub(I).div(w).mul(100);return{amountOut:B,minAmountOut:S,currentPrice:w,executionPrice:I,priceImpact:K,fee:x}}computeAmountIn({poolInfo:e,amountOut:t,mintIn:n,mintOut:o,slippage:r}){let{baseReserve:s,quoteReserve:a}=e;n.toString()!==e.mintA.address&&n.toString()!==e.mintB.address&&this.logAndCreateError("mintIn does not match pool"),o.toString()!==e.mintA.address&&o.toString()!==e.mintB.address&&this.logAndCreateError("mintOut does not match pool"),this.logDebug("baseReserve:",s.toString()),this.logDebug("quoteReserve:",a.toString());let c=n.toString()===e.mintA.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA];this.logDebug("currencyOut:",l.symbol||l.address),this.logDebug("amountOut:",new C(t.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString(),u.symbol||u.address),this.logDebug("slippage:",`${r*100}%`);let d=[s,a],m=c?"quote":"base";m==="base"&&d.reverse(),this.logDebug("output side:",m);let[p,y]=d,f=new C(y.toString()).div(10**e[c?"mintB":"mintA"].decimals).div(new C(p.toString()).div(10**e[c?"mintA":"mintB"].decimals));this.logDebug("currentPrice:",`1 ${u.symbol||u.address} \u2248 ${f.toString()} ${l.symbol||l.address}`),this.logDebug("currentPrice invert:",`1 ${l.symbol||l.address} \u2248 ${new C(1).div(f).toString()} ${u.symbol||u.address}`);let b=new We(0),g=t;if(!g.isZero()){g.gt(y)&&(g=y.sub(new We(1)));let S=y.sub(g);b=p.mul(g).div(S).mul(Fr).div(Fr.sub(Ra))}let w=new We(new C(b.toString()).mul(1+r).toFixed(0)),k=b,h=w;this.logDebug("amountIn:",new C(k.toString()).div(10**u.decimals).toDecimalPlaces(u.decimals).toString()),this.logDebug("maxAmountIn:",new C(h.toString()).div(10**u.decimals).toDecimalPlaces(u.decimals).toString());let x=null;!b.isZero()&&!g.isZero()&&(x=new C(g.toString()).div(10**l.decimals).div(new C(b.toString()).div(10**u.decimals)),this.logDebug("executionPrice:",`1 ${l.symbol||l.address} \u2248 ${x.toDecimalPlaces(Math.max(e.mintA.decimals,e.mintB.decimals)).toString()} ${u.symbol||u.address}`),this.logDebug("executionPrice invert:",`1 ${l.symbol||l.address} \u2248 ${new C(1).div(x).toDecimalPlaces(Math.max(e.mintA.decimals,e.mintB.decimals)).toString()} ${u.symbol||u.address}`));let T=f.mul(k.toString()),B=T.sub(t.toString()).abs().div(T);return this.logDebug("priceImpact:",`${B.toString()}%`),{amountIn:k,maxAmountIn:h,currentPrice:f,executionPrice:x,priceImpact:B}}async swap({poolInfo:e,poolKeys:t,amountIn:n,amountOut:o,inputMint:r,fixedSide:s,txVersion:a,config:c,computeBudgetConfig:u,txTipConfig:l,feePayer:d}){let m=this.createTxBuilder(d),{associatedOnly:p=!0,inputUseSolBalance:y=!0,outputUseSolBalance:f=!0}=c||{},[b,g]=r===e.mintA.address?[e.mintA,e.mintB]:[e.mintB,e.mintA],w=y&&b.address===j.toBase58(),k=f&&g.address===j.toBase58(),{account:h,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Dn,mint:new He(b.address),owner:this.scope.ownerPubKey,createInfo:w?{payer:this.scope.ownerPubKey,amount:n}:void 0,skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:p});m.addInstruction(x||{}),h||this.logAndCreateError("input token account not found",{token:b.symbol||b.address,tokenAccountIn:h,inputTokenUseSolBalance:w,associatedOnly:p});let{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Dn,mint:new He(g.address),owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:k?!1:p});m.addInstruction(B||{}),T===void 0&&this.logAndCreateError("output token account not found",{token:g.symbol||g.address,tokenAccountOut:T,outputTokenUseSolBalance:k,associatedOnly:p});let S=t||await this.getAmmPoolKeys(e.id),I=4;return e.pooltype.includes("StablePool")&&(I=5),m.addInstruction({instructions:[Vr({version:I,poolKeys:S,userKeys:{tokenAccountIn:h,tokenAccountOut:T,owner:this.scope.ownerPubKey},amountIn:n,amountOut:o,fixedSide:s})],instructionTypes:[I===4?V.AmmV4SwapBaseIn:V.AmmV5SwapBaseIn]}),m.addCustomComputeBudget(u),m.addTipInstruction(l),m.versionBuild({txVersion:a})}async getRpcPoolInfo(e){return(await this.getRpcPoolInfos([e]))[e]}async getRpcPoolInfos(e,t){let n=await Ke(this.scope.connection,e.map(u=>({pubkey:new He(u)})),t),o={},r=[];for(let u=0;u<e.length;u++){let l=n[u];if(l===null||!l.accountInfo)throw Error("fetch pool info error: "+String(e[u]));let d=no.decode(l.accountInfo.data);o[String(e[u])]={...d,programId:l.accountInfo.owner},r.push(d.baseVault,d.quoteVault)}let s={},a=await Ke(this.scope.connection,r.map(u=>({pubkey:new He(u)})),t);for(let u=0;u<r.length;u++){let l=a[u].accountInfo;if(l===null)throw Error("fetch vault info error: "+r[u]);s[String(r[u])]=new We(Cy.decode(l.data).amount.toString())}let c={};for(let[u,l]of Object.entries(o)){let d=s[l.baseVault.toString()].sub(l.baseNeedTakePnl),m=s[l.quoteVault.toString()].sub(l.quoteNeedTakePnl);c[u]={...l,baseReserve:d,mintAAmount:s[l.baseVault.toString()],mintBAmount:s[l.quoteVault.toString()],quoteReserve:m,poolPrice:new C(m.toString()).div(new C(10).pow(l.quoteDecimal.toString())).div(new C(d.toString()).div(new C(10).pow(l.baseDecimal.toString())))}}return c}async getPoolInfoFromRpc({poolId:e}){let t=await this.getRpcPoolInfo(e),n=Dr({[e]:t}),o=n[e],r=await this.scope.tradeV2.computePoolToPoolKeys({pools:[n[e]],ammRpcData:{[e]:t}});return{poolRpcData:t,poolInfo:o,poolKeys:r[0]}}};import{PublicKey as z}from"@solana/web3.js";import Kt from"bn.js";import{AccountLayout as Sl,TOKEN_2022_PROGRAM_ID as qn,TOKEN_PROGRAM_ID as Li}from"@solana/spl-token";var Ri=class extends Ne{constructor(e){super(e)}async getClmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async createPool(e){let{programId:t,owner:n=this.scope.owner?.publicKey||z.default,mint1:o,mint2:r,ammConfig:s,initialPrice:a,computeBudgetConfig:c,forerunCreate:u,getObserveState:l,txVersion:d,txTipConfig:m,feePayer:p}=e,y=this.createTxBuilder(p),[f,b,g]=new Kt(new z(o.address).toBuffer()).gt(new Kt(new z(r.address).toBuffer()))?[r,o,new C(1).div(a)]:[o,r,a],w=te.priceToSqrtPriceX64(g,f.decimals,b.decimals),k=[],h=[];f.programId===qn.toBase58()&&h.push(xa(t,new z(f.address)).publicKey),b.programId===qn.toBase58()&&h.push(xa(t,new z(b.address)).publicKey),(await this.scope.connection.getMultipleAccountsInfo(h)).forEach((B,S)=>{B&&k.push(h[S])});let T=await xe.createPoolInstructions({connection:this.scope.connection,programId:t,owner:n,mintA:f,mintB:b,ammConfigId:s.id,initialPriceX64:w,forerunCreate:!l&&u,extendMintAccount:k});return y.addInstruction(T),y.addCustomComputeBudget(c),y.addTipInstruction(m),y.versionBuild({txVersion:d,extInfo:{address:{...T.address,observationId:T.address.observationId.toBase58(),exBitmapAccount:T.address.exBitmapAccount.toBase58(),programId:t.toString(),id:T.address.poolId.toString(),mintA:f,mintB:b,openTime:"0",vault:{A:T.address.mintAVault.toString(),B:T.address.mintBVault.toString()},rewardInfos:[],config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}},mockPoolInfo:{type:"Concentrated",rewardDefaultPoolInfos:"Clmm",id:T.address.poolId.toString(),mintA:f,mintB:b,feeRate:s.tradeFeeRate,openTime:"0",programId:t.toString(),price:g.toNumber(),config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]},burnPercent:0,...Qc},forerunCreate:u}})}async openPositionFromBase({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:r,base:s,baseAmount:a,otherAmountMax:c,nft2022:u,associatedOnly:l=!0,checkCreateATAOwner:d=!1,withMetadata:m="create",getEphemeralSigners:p,computeBudgetConfig:y,txTipConfig:f,txVersion:b,feePayer:g}){this.scope.availability.addConcentratedPosition===!1&&this.logAndCreateError("add position feature disabled in your region"),this.scope.checkOwner();let w=this.createTxBuilder(g),k=null,h=null,x=n.useSOLBalance&&e.mintA.address===j.toString(),T=n.useSOLBalance&&e.mintB.address===j.toString(),[B,S]=s==="MintA"?[a,c]:[c,a],{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new z(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:x||B.isZero()?{payer:this.scope.ownerPubKey,amount:B}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:x?!1:l,checkCreateATAOwner:d});I&&(k=I),w.addInstruction(K||{});let{account:O,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new z(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:T||S.isZero()?{payer:this.scope.ownerPubKey,amount:S}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:T?!1:l,checkCreateATAOwner:d});O&&(h=O),w.addInstruction(v||{}),(!k||!h)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",{ownerTokenAccountA:k?.toBase58(),ownerTokenAccountB:h?.toBase58()});let _=t||await this.getClmmPoolKeys(e.id),D=await xe.openPositionFromBaseInstructions({poolInfo:e,poolKeys:_,ownerInfo:{...n,feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:k,tokenAccountB:h},tickLower:o,tickUpper:r,base:s,baseAmount:a,otherAmountMax:c,withMetadata:m,getEphemeralSigners:p,nft2022:u});return w.addInstruction(D),w.addCustomComputeBudget(y),w.addTipInstruction(f),w.versionBuild({txVersion:b,extInfo:{...D.address}})}async openPositionFromLiquidity({poolInfo:e,poolKeys:t,ownerInfo:n,amountMaxA:o,amountMaxB:r,tickLower:s,tickUpper:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,withMetadata:d="create",txVersion:m,computeBudgetConfig:p,txTipConfig:y,getEphemeralSigners:f,nft2022:b,feePayer:g}){this.scope.availability.createConcentratedPosition===!1&&this.logAndCreateError("open position feature disabled in your region");let w=this.createTxBuilder(g),k=null,h=null,x=n.useSOLBalance&&e.mintA.address===j.toBase58(),T=n.useSOLBalance&&e.mintB.address===j.toBase58(),{account:B,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new z(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:x||o.isZero()?{payer:this.scope.ownerPubKey,amount:o}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:x?!1:u,checkCreateATAOwner:l});B&&(k=B),w.addInstruction(S||{});let{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new z(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:T||r.isZero()?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:T?!1:u,checkCreateATAOwner:l});I&&(h=I),w.addInstruction(K||{}),(k===void 0||h===void 0)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let O=t||await this.getClmmPoolKeys(e.id),v=await xe.openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:O,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:k,tokenAccountB:h},tickLower:s,tickUpper:a,liquidity:c,amountMaxA:o,amountMaxB:r,withMetadata:d,getEphemeralSigners:f,nft2022:b});return w.addInstruction(v),w.addCustomComputeBudget(p),w.addTipInstruction(y),w.versionBuild({txVersion:m,extInfo:{address:v.address}})}async increasePositionFromLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:o,amountMaxA:r,amountMaxB:s,liquidity:a,ownerInfo:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:d,txTipConfig:m,txVersion:p,feePayer:y}=e,f=this.createTxBuilder(y),b,g,w=c.useSOLBalance&&t.mintA.address===j.toString(),k=c.useSOLBalance&&t.mintB.address===j.toString(),{account:h,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,createInfo:w||r.isZero()?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!w,associatedOnly:w?!1:u,checkCreateATAOwner:l});h&&(b=h),f.addInstruction(x||{});let{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:k||s.isZero()?{payer:this.scope.ownerPubKey,amount:s}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:u,checkCreateATAOwner:l});T&&(g=T),f.addInstruction(B||{}),!b&&!g&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let S=n??await this.getClmmPoolKeys(t.id),I=xe.increasePositionFromLiquidityInstructions({poolInfo:t,poolKeys:S,ownerPosition:o,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g},liquidity:a,amountMaxA:r,amountMaxB:s,nft2022:(await this.scope.connection.getAccountInfo(o.nftMint))?.owner.equals(qn)});return f.addInstruction(I),f.addCustomComputeBudget(d),f.addTipInstruction(m),f.versionBuild({txVersion:p,extInfo:{address:I.address}})}async increasePositionFromBase(e){let{poolInfo:t,ownerPosition:n,base:o,baseAmount:r,otherAmountMax:s,ownerInfo:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:d,txVersion:m,feePayer:p}=e,y=this.createTxBuilder(p),f,b,g=a.useSOLBalance&&t.mintA.address===j.toString(),w=a.useSOLBalance&&t.mintB.address===j.toString(),{account:k,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:g||(o==="MintA"?r:s).isZero()?{payer:this.scope.ownerPubKey,amount:o==="MintA"?r:s}:void 0,skipCloseAccount:!g,associatedOnly:g?!1:c,checkCreateATAOwner:u});k&&(f=k),y.addInstruction(h||{});let{account:x,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:w||(o==="MintA"?s:r).isZero()?{payer:this.scope.ownerPubKey,amount:o==="MintA"?s:r}:void 0,notUseTokenAccount:w,skipCloseAccount:!w,associatedOnly:w?!1:c,checkCreateATAOwner:u});x&&(b=x),y.addInstruction(T||{}),!f&&!b&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let B=await this.getClmmPoolKeys(t.id),S=xe.increasePositionFromBaseInstructions({poolInfo:t,poolKeys:B,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:b},base:o,baseAmount:r,otherAmountMax:s,nft2022:(await this.scope.connection.getAccountInfo(n.nftMint))?.owner.equals(qn)});return y.addInstruction(S),y.addCustomComputeBudget(l),y.addTipInstruction(d),y.versionBuild({txVersion:m,extInfo:{address:S.address}})}async decreaseLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:o,ownerInfo:r,amountMinA:s,amountMinB:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:d,txTipConfig:m,txVersion:p,feePayer:y}=e;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let f=this.createTxBuilder(y),b=r.useSOLBalance&&t.mintA.address===j.toString(),g=r.useSOLBalance&&t.mintB.address===j.toString(),w,k,{account:h,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:l});w=h,x&&f.addInstruction(x);let{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!g,associatedOnly:g?!1:u,checkCreateATAOwner:l});k=T,B&&f.addInstruction(B);let S=[];for(let _ of t.rewardDefaultInfos){let D=r.useSOLBalance&&_.mint.address===j.toString(),q;if(_.mint.address===t.mintA.address)q=w;else if(_.mint.address===t.mintB.address)q=k;else{let{account:G,instructionParams:ne}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(_.mint.programId),mint:new z(_.mint.address),notUseTokenAccount:D,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!D,associatedOnly:D?!1:u,checkCreateATAOwner:l});q=G,ne&&f.addInstruction(ne)}S.push(q)}!w&&!k&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccountRawInfos);let I=n??await this.getClmmPoolKeys(t.id),K=(await this.scope.connection.getAccountInfo(o.nftMint))?.owner.equals(qn),O=await xe.decreaseLiquidityInstructions({poolInfo:t,poolKeys:I,ownerPosition:o,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:w,tokenAccountB:k,rewardAccounts:S},liquidity:c,amountMinA:s,amountMinB:a,nft2022:K});f.addInstruction({instructions:O.instructions,instructionTypes:[V.ClmmDecreasePosition]});let v={...O.address};if(r.closePosition){let _=await xe.closePositionInstructions({poolInfo:t,poolKeys:I,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:o,nft2022:K});f.addInstruction({endInstructions:_.instructions,endInstructionTypes:_.instructionTypes}),v={...v,..._.address}}return f.addCustomComputeBudget(d),f.addTipInstruction(m),f.versionBuild({txVersion:p,extInfo:{address:v}})}async lockPosition(e){let{programId:t=Po,authProgramId:n=zo,poolProgramId:o=vn,ownerPosition:r,payer:s,computeBudgetConfig:a,txTipConfig:c,txVersion:u,getEphemeralSigners:l,feePayer:d}=e,m=this.createTxBuilder(d),p=await xe.makeLockPositions({programId:t,authProgramId:n,poolProgramId:o,wallet:this.scope.ownerPubKey,payer:s??this.scope.ownerPubKey,nftMint:r.nftMint,getEphemeralSigners:l,nft2022:(await this.scope.connection.getAccountInfo(r.nftMint))?.owner.equals(qn)});return m.addInstruction(p),m.addCustomComputeBudget(a),m.addTipInstruction(c),m.versionBuild({txVersion:u,extInfo:p.address})}async harvestLockPosition(e){let{programId:t=Po,authProgramId:n=zo,clmmProgram:o=vn,poolKeys:r,lockData:s,ownerInfo:a={useSOLBalance:!0},associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:d,txVersion:m,feePayer:p}=e,y=r||await this.getClmmPoolKeys(s.poolId.toString()),f=this.createTxBuilder(p),b=await this.scope.connection.getAccountInfo(s.positionId);b||this.logger.logWithError("position not found",s.positionId);let g=hi.decode(b.data),w=a.useSOLBalance&&y.mintA.address===j.toString(),k=a.useSOLBalance&&y.mintB.address===j.toString(),h,x,{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.mintA.programId,mint:new z(y.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!w,associatedOnly:w?!1:c,checkCreateATAOwner:u});h=T,B&&f.addInstruction(B);let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.mintB.programId,mint:new z(y.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!k,associatedOnly:k?!1:c,checkCreateATAOwner:u});x=S,I&&f.addInstruction(I);let K={},O=[];for(let ye of y.rewardInfos){let dt=a.useSOLBalance&&ye.mint.address===j.toString(),$e=K[ye.mint.address];if(!$e){let{account:nt,instructionParams:It}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(ye.mint.programId),mint:new z(ye.mint.address),notUseTokenAccount:dt,owner:this.scope.ownerPubKey,skipCloseAccount:!dt,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:dt?!1:c});$e=nt,It&&f.addInstruction(It)}K[ye.mint.address]=$e,O.push($e)}let v=Ai(t,s.lockNftMint).publicKey,_=Z(this.scope.ownerPubKey,s.lockNftMint,Li).publicKey,D=H.getTickArrayStartIndexByTick(g.tickLower,y.config.tickSpacing),q=H.getTickArrayStartIndexByTick(g.tickUpper,y.config.tickSpacing),{publicKey:G}=ge(new z(y.programId),s.poolId,D),{publicKey:ne}=ge(new z(y.programId),s.poolId,q),{publicKey:ie}=tn(new z(y.programId),s.poolId,g.tickLower,g.tickUpper),de=[];for(let ye=0;ye<y.rewardInfos.length;ye++)de.push({poolRewardVault:new z(y.rewardInfos[ye].vault),ownerRewardVault:O[ye],rewardMint:new z(y.rewardInfos[ye].mint.address)});let re=await xe.harvestLockPositionInstructionV2({programId:t,auth:n,lockPositionId:v,clmmProgram:o,lockOwner:this.scope.ownerPubKey,lockNftMint:s.lockNftMint,lockNftAccount:_,positionNftAccount:s.nftAccount,positionId:s.positionId,poolId:s.poolId,protocolPosition:ie,vaultA:new z(y.vault.A),vaultB:new z(y.vault.B),tickArrayLower:G,tickArrayUpper:ne,userVaultA:h,userVaultB:x,mintA:new z(y.mintA.address),mintB:new z(y.mintB.address),rewardAccounts:de,exTickArrayBitmap:Ge(o,s.poolId).publicKey});return f.addInstruction({instructions:[re],instructionTypes:[V.ClmmHarvestLockPosition]}),f.addCustomComputeBudget(l),f.addTipInstruction(d),f.versionBuild({txVersion:m})}async closePosition({poolInfo:e,poolKeys:t,ownerPosition:n,txVersion:o,computeBudgetConfig:r,txTipConfig:s,feePayer:a}){this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let c=this.createTxBuilder(a),u=t??await this.getClmmPoolKeys(e.id),l=xe.closePositionInstructions({poolInfo:e,poolKeys:u,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:n,nft2022:(await this.scope.connection.getAccountInfo(n.nftMint))?.owner.equals(qn)});return c.addCustomComputeBudget(r),c.addTipInstruction(s),c.addInstruction(l).versionBuild({txVersion:o,extInfo:{address:l.address}})}async initReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:o=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txVersion:a,feePayer:c}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(c),l=t.useSOLBalance&&n.mint.address.toString()===j.toString(),d=n.perSecond.mul(n.endTime-n.openTime),{account:m,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(n.mint.address),mint:new z(n.mint.address),notUseTokenAccount:!!l,skipCloseAccount:!l,owner:this.scope.ownerPubKey,createInfo:l?{payer:t.feePayer||this.scope.ownerPubKey,amount:new Kt(new C(d.toFixed(0)).gte(d)?d.toFixed(0):d.add(1).toFixed(0))}:void 0,associatedOnly:l?!1:o,checkCreateATAOwner:r});p&&u.addInstruction(p),m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let y=await this.getClmmPoolKeys(e.id),f=xe.initRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardInfo:{programId:new z(n.mint.programId),mint:new z(n.mint.address),openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ae.decimalToX64(n.perSecond)}});return u.addInstruction(f),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:f.address}})}async initRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:o,associatedOnly:r=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){for(let p of o)p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let d=this.createTxBuilder(l),m={};for(let p of o){let y=n.useSOLBalance&&p.mint.address===j.toString(),f=p.perSecond.mul(p.endTime-p.openTime),{account:b,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(p.mint.programId),mint:new z(p.mint.address),notUseTokenAccount:!!y,skipCloseAccount:!y,owner:this.scope.ownerPubKey,createInfo:y?{payer:n.feePayer||this.scope.ownerPubKey,amount:new Kt(new C(f.toFixed(0)).gte(f)?f.toFixed(0):f.add(1).toFixed(0))}:void 0,associatedOnly:y?!1:r,checkCreateATAOwner:s});g&&d.addInstruction(g),b||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let w=t??await this.getClmmPoolKeys(e.id),k=xe.initRewardInstructions({poolInfo:e,poolKeys:w,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:b},rewardInfo:{programId:new z(p.mint.programId),mint:new z(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:ae.decimalToX64(p.perSecond)}});m={...m,...k.address},d.addInstruction(k)}return d.addCustomComputeBudget(a),d.addTipInstruction(c),d.versionBuild({txVersion:u,extInfo:{address:m}})}async setReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:o=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let l=this.createTxBuilder(u),d=t.useSOLBalance&&n.mint.equals(j),{account:m,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n.programId,mint:n.mint,notUseTokenAccount:d,owner:this.scope.ownerPubKey,createInfo:d?{payer:t.feePayer||this.scope.ownerPubKey,amount:new Kt(new C(n.perSecond.mul(n.endTime-n.openTime).toFixed(0)).gte(n.perSecond.mul(n.endTime-n.openTime))?n.perSecond.mul(n.endTime-n.openTime).toFixed(0):n.perSecond.mul(n.endTime-n.openTime).add(1).toFixed(0))}:void 0,associatedOnly:d?!1:o,checkCreateATAOwner:r});p&&l.addInstruction(p),m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let y=await this.getClmmPoolKeys(e.id),f=xe.setRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardInfo:{mint:n.mint,openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ae.decimalToX64(n.perSecond)}});return l.addInstruction(f),l.addCustomComputeBudget(s),l.addTipInstruction(a),l.versionBuild({txVersion:c,extInfo:{address:f.address}})}async setRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:o,associatedOnly:r=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){let d=this.createTxBuilder(l),m={};for(let p of o){p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let y=n.useSOLBalance&&p.mint.address===j.toString(),{account:f,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(p.mint.programId),mint:new z(p.mint.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:y?{payer:n.feePayer||this.scope.ownerPubKey,amount:new Kt(new C(p.perSecond.mul(p.endTime-p.openTime).toFixed(0)).gte(p.perSecond.mul(p.endTime-p.openTime))?p.perSecond.mul(p.endTime-p.openTime).toFixed(0):p.perSecond.mul(p.endTime-p.openTime).add(1).toFixed(0))}:void 0,associatedOnly:y?!1:r,checkCreateATAOwner:s});b&&d.addInstruction(b),f||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let g=t??await this.getClmmPoolKeys(e.id),w=xe.setRewardInstructions({poolInfo:e,poolKeys:g,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:f},rewardInfo:{mint:new z(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:ae.decimalToX64(p.perSecond)}});d.addInstruction(w),m={...m,...w.address}}return d.addCustomComputeBudget(a),d.addTipInstruction(c),d.versionBuild({txVersion:u,extInfo:{address:m}})}async collectReward({poolInfo:e,ownerInfo:t,rewardMint:n,associatedOnly:o=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){let l=e.rewardDefaultInfos.find(g=>g.mint.address===n.toString());l||this.logAndCreateError("reward mint error","not found reward mint",n);let d=this.createTxBuilder(u),m=t.useSOLBalance&&n.equals(j),{account:p,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(l.mint.programId),mint:n,notUseTokenAccount:m,owner:this.scope.ownerPubKey,skipCloseAccount:!m,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:m?!1:o,checkCreateATAOwner:r});y&&d.addInstruction(y),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=await this.getClmmPoolKeys(e.id),b=xe.collectRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardMint:n});return d.addInstruction(b),d.addCustomComputeBudget(s),d.addTipInstruction(a),d.versionBuild({txVersion:c,extInfo:{address:b.address}})}async collectRewards({poolInfo:e,ownerInfo:t,rewardMints:n,associatedOnly:o=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l={};for(let d of n){let m=e.rewardDefaultInfos.find(w=>w.mint.address===d.toString());if(!m){this.logAndCreateError("reward mint error","not found reward mint",d);continue}let p=t.useSOLBalance&&d.equals(j),{account:y,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(m.mint.programId),mint:d,notUseTokenAccount:p,owner:this.scope.ownerPubKey,skipCloseAccount:!p,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:p?!1:o,checkCreateATAOwner:r});y||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos),f&&u.addInstruction(f);let b=await this.getClmmPoolKeys(e.id),g=xe.collectRewardInstructions({poolInfo:e,poolKeys:b,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:y},rewardMint:d});u.addInstruction(g),l={...l,...g.address}}return u.addCustomComputeBudget(s),u.addTipInstruction(a),u.build({address:l})}async swap({poolInfo:e,poolKeys:t,inputMint:n,amountIn:o,amountOutMin:r,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:d=!1,txVersion:m,computeBudgetConfig:p,txTipConfig:y,feePayer:f}){let b=this.createTxBuilder(f),g=n.toString()===e.mintA.address,w=c.useSOLBalance&&e.mintA.address===j.toBase58(),k=c.useSOLBalance&&e.mintB.address===j.toBase58(),h;!s||s.equals(new C(0))?h=g?Vt.add(new Kt(1)):Wt.sub(new Kt(1)):h=te.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let x;if(!x){let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new z(e.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,skipCloseAccount:!w,createInfo:w||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?o:0}:void 0,associatedOnly:w?!1:l,checkCreateATAOwner:d});x=S,I&&b.addInstruction(I)}let T;if(!T){let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new z(e.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,skipCloseAccount:!k,createInfo:k||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:o}:void 0,associatedOnly:k?!1:l,checkCreateATAOwner:d});T=S,I&&b.addInstruction(I)}(!x||!T)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:x,ownerTokenAccountB:T,mintAUseSOLBalance:w,mintBUseSOLBalance:k,associatedOnly:l});let B=t??await this.getClmmPoolKeys(e.id);return b.addInstruction(xe.makeSwapBaseInInstructions({poolInfo:e,poolKeys:B,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:x,tokenAccountB:T},inputMint:new z(n),amountIn:o,amountOutMin:r,sqrtPriceLimitX64:h,remainingAccounts:u})),b.addCustomComputeBudget(p),b.addTipInstruction(y),b.versionBuild({txVersion:m})}async swapBaseOut({poolInfo:e,poolKeys:t,outputMint:n,amountOut:o,amountInMax:r,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:d=!1,txVersion:m,computeBudgetConfig:p,txTipConfig:y,feePayer:f}){let b=this.createTxBuilder(f),g=n.toString()===e.mintB.address,w=c.useSOLBalance&&e.mintA.address===j.toBase58(),k=c.useSOLBalance&&e.mintB.address===j.toBase58(),h;!s||s.equals(new C(0))?h=n.toString()===e.mintB.address?Vt.add(new Kt(1)):Wt.sub(new Kt(1)):h=te.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let x;if(!x){let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new z(e.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,skipCloseAccount:!w,createInfo:w||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?r:0}:void 0,associatedOnly:w?!1:l,checkCreateATAOwner:d});x=S,I&&b.addInstruction(I)}let T;if(!T){let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new z(e.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,skipCloseAccount:!k,createInfo:k||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:r}:void 0,associatedOnly:k?!1:l,checkCreateATAOwner:d});T=S,I&&b.addInstruction(I)}(!x||!T)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:x,ownerTokenAccountB:T,mintAUseSOLBalance:w,mintBUseSOLBalance:k,associatedOnly:l});let B=t??await this.getClmmPoolKeys(e.id);return b.addInstruction(xe.makeSwapBaseOutInstructions({poolInfo:e,poolKeys:B,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:x,tokenAccountB:T},outputMint:new z(n),amountOut:o,amountInMax:r,sqrtPriceLimitX64:h,remainingAccounts:u})),b.addCustomComputeBudget(p),b.addTipInstruction(y),b.versionBuild({txVersion:m})}async harvestAllRewards({allPoolInfo:e,allPositions:t,lockInfo:n,ownerInfo:o,associatedOnly:r=!0,checkCreateATAOwner:s=!1,programId:a,txVersion:c,computeBudgetConfig:u,feePayer:l}){let d={};for(let b of this.scope.account.tokenAccountRawInfos)r?Z(this.scope.ownerPubKey,b.accountInfo.mint,a).publicKey.equals(b.pubkey)&&(d[b.accountInfo.mint.toString()]=b.pubkey):d[b.accountInfo.mint.toString()]=b.pubkey;let m=Object.values(t).flat().map(b=>b.nftMint),p=await Ke(this.scope.connection,m.map(b=>({pubkey:b}))),y={};p.forEach(b=>{y[b.pubkey.toBase58()]=b?.accountInfo?.owner??null});let f=this.createTxBuilder(l);for(let b of Object.values(e)){if(t[b.id]===void 0||!t[b.id].find(I=>!I.liquidity.isZero()||I.rewardInfos.find(K=>!K.rewardAmountOwed.isZero())))continue;let g=b,w=o.useSOLBalance&&g.mintA.address===j.toString(),k=o.useSOLBalance&&g.mintB.address===j.toString(),h=d[g.mintA.address];if(!h){let{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:g.mintA.programId,mint:new z(g.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,skipCloseAccount:!w,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:w?!1:r,checkCreateATAOwner:s});h=I,K&&f.addInstruction(K)}let x=d[g.mintB.address];if(!x){let{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:g.mintB.programId,mint:new z(g.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,skipCloseAccount:!k,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:k?!1:r,checkCreateATAOwner:s});x=I,K&&f.addInstruction(K)}d[g.mintA.address]=h,d[g.mintB.address]=x;let T=[];for(let I of g.rewardDefaultInfos){let K=o.useSOLBalance&&I.mint.address===j.toString(),O=d[I.mint.address];if(!O){let{account:v,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(I.mint.programId),mint:new z(I.mint.address),notUseTokenAccount:K,owner:this.scope.ownerPubKey,skipCloseAccount:!K,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:K?!1:r});O=v,_&&f.addInstruction(_)}d[I.mint.address]=O,T.push(O)}let B=await this.getClmmPoolKeys(g.id),S=[];for(let I=0;I<B.rewardInfos.length;I++)S.push({poolRewardVault:new z(B.rewardInfos[I].vault),ownerRewardVault:T[I],rewardMint:new z(B.rewardInfos[I].mint.address)});for(let I of t[b.id]){let K=n?.[b.id]?.[I.nftMint.toBase58()];if(K){let O=Z(this.scope.ownerPubKey,K.lockNftMint,Li).publicKey,v=H.getTickArrayStartIndexByTick(I.tickLower,B.config.tickSpacing),_=H.getTickArrayStartIndexByTick(I.tickUpper,B.config.tickSpacing),{publicKey:D}=ge(new z(B.programId),K.poolId,v),{publicKey:q}=ge(new z(B.programId),K.poolId,_),{publicKey:G}=tn(new z(B.programId),K.poolId,I.tickLower,I.tickUpper),ne=Ai(Po,K.lockNftMint).publicKey,ie=xe.harvestLockPositionInstructionV2({programId:Po,auth:zo,lockPositionId:ne,clmmProgram:vn,lockOwner:this.scope.ownerPubKey,lockNftMint:K.lockNftMint,lockNftAccount:O,positionNftAccount:K.nftAccount,positionId:K.positionId,poolId:K.poolId,protocolPosition:G,vaultA:new z(B.vault.A),vaultB:new z(B.vault.B),tickArrayLower:D,tickArrayUpper:q,userVaultA:h,userVaultB:x,mintA:new z(B.mintA.address),mintB:new z(B.mintB.address),rewardAccounts:S,exTickArrayBitmap:Ge(vn,K.poolId).publicKey});f.addInstruction({instructions:[ie],instructionTypes:[V.ClmmHarvestLockPosition],lookupTableAddress:B.lookupTableAccount?[B.lookupTableAccount]:[]})}else{let O=xe.decreaseLiquidityInstructions({poolInfo:g,poolKeys:B,ownerPosition:I,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:h,tokenAccountB:x,rewardAccounts:T},liquidity:new Kt(0),amountMinA:new Kt(0),amountMinB:new Kt(0),nft2022:y[I.nftMint.toBase58()]?.equals(qn)});f.addInstruction(O)}}}return c===0?f.sizeCheckBuildV0({computeBudgetConfig:u}):f.sizeCheckBuild({computeBudgetConfig:u})}async getWhiteListMint({programId:e}){let t=await this.scope.connection.getAccountInfo(gi(e).publicKey);return t?rl.decode(t.data).whitelistMints.filter(o=>!o.equals(z.default)):[]}async getOwnerPositionInfo({programId:e}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(s=>s.accountInfo.amount.eq(new Kt(1))).map(s=>Tt(new z(e),s.accountInfo.mint).publicKey),o=await this.scope.connection.getMultipleAccountsInfo(n),r=[];return o.forEach(s=>{if(!s)return;let a=hi.decode(s.data);r.push(a)}),r}async getRpcClmmPoolInfo({poolId:e}){return(await this.getRpcClmmPoolInfos({poolIds:[e]}))[String(e)]}async getRpcClmmPoolInfos({poolIds:e,config:t}){let n=await Ke(this.scope.connection,e.map(r=>({pubkey:new z(r)})),t),o={};for(let r=0;r<e.length;r++){let s=n[r];if(s===null||!s.accountInfo)throw Error("fetch pool info error: "+String(e[r]));let a=eo.decode(s.accountInfo.data),c=te.sqrtPriceX64ToPrice(a.sqrtPriceX64,a.mintDecimalsA,a.mintDecimalsB).toNumber();o[String(e[r])]={...a,currentPrice:c,programId:s.accountInfo.owner}}return o}async getComputeClmmPoolInfos({clmmPoolsRpcInfo:e,mintInfos:t}){let n=new Set(Object.keys(e).map(c=>e[c].ammConfig.toBase58())),o=await Ke(this.scope.connection,Array.from(n).map(c=>({pubkey:new z(c)}))),r={};o.forEach(c=>{!c.accountInfo||(r[c.pubkey.toBase58()]=ol.decode(c.accountInfo.data))});let s=await Le.fetchComputeMultipleClmmInfo({connection:this.scope.connection,rpcDataMap:e,poolList:Object.keys(e).map(c=>{let[u,l]=[e[c].mintA.toBase58(),e[c].mintB.toBase58()];return{id:c,programId:e[c].programId.toBase58(),mintA:At({address:u,decimals:e[c].mintDecimalsA,programId:t[u].programId.toBase58()||Li.toBase58(),extensions:{feeConfig:t[u]?.feeConfig?Wn(t[u]?.feeConfig):void 0}}),mintB:At({address:l,decimals:e[c].mintDecimalsB,programId:t[l].programId.toBase58()||Li.toBase58(),extensions:{feeConfig:t[l]?.feeConfig?Wn(t[l]?.feeConfig):void 0}}),price:e[c].currentPrice,config:{...r[e[c].ammConfig.toBase58()],id:e[c].ammConfig.toBase58(),fundFeeRate:0,description:"",defaultRange:0,defaultRangePoint:[]}}})}),a=await Le.fetchMultiplePoolTickArrays({connection:this.scope.connection,poolKeys:Object.values(s)});return{computeClmmPoolInfo:s,computePoolTickData:a}}async getPoolInfoFromRpc(e){let t=await this.getRpcClmmPoolInfo({poolId:e}),n=new Set([t.mintA.toBase58(),t.mintB.toBase58()]),o=await po({connection:this.scope.connection,mints:Array.from(n).map(l=>new z(l))}),{computeClmmPoolInfo:r,computePoolTickData:s}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:{[e]:t},mintInfos:o}),a=await Ke(this.scope.connection,[{pubkey:t.vaultA},{pubkey:t.vaultB}]),c=tl(r[e]);if(!a[0].accountInfo||!a[1].accountInfo)throw new Error("pool vault data not found");c.mintAmountA=Number(Sl.decode(a[0].accountInfo.data).amount.toString()),c.mintAmountB=Number(Sl.decode(a[1].accountInfo?.data).amount.toString());let u={...r[e],exBitmapAccount:r[e].exBitmapAccount.toBase58(),observationId:r[e].observationId.toBase58(),id:e,programId:t.programId.toBase58(),openTime:t.startTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},config:c.config,rewardInfos:r[e].rewardInfos.filter(l=>!l.tokenVault.equals(z.default)).map(l=>({mint:At({address:l.tokenMint.toBase58(),programId:Li.toBase58(),decimals:10}),vault:l.tokenVault.toBase58()}))};return{poolInfo:c,poolKeys:u,computePoolInfo:r[e],tickData:s}}};import{PublicKey as Q}from"@solana/web3.js";import{AccountLayout as ja,createAssociatedTokenAccountIdempotentInstruction as Fl,getAssociatedTokenAddressSync as Vl,NATIVE_MINT as Oo,TOKEN_PROGRAM_ID as Et}from"@solana/spl-token";import Xa from"bn.js";import zr from"decimal.js-light";import Ni from"bn.js";function Gr(i,e){if(e.isZero())throw Error("divisor is zero");return i.mod(e)}function Ly(i,e){if(e.isZero())throw Error("rhs is zero");let t=i.div(e);if(t.isZero())throw Error("quotient is zero");let n=Gr(i,e);return n.gt(Ro)&&(t=t.add(new Ni(1)),e=i.div(t),n=Gr(i,t),n.gt(Ro)&&(e=e.add(new Ni(1)))),[t,e]}var Ro=new Ni(0),Xr=class{static swapWithoutFees(e,t,n){let o=t.mul(n),r=t.add(e),[s]=Ly(o,r),a=n.sub(s);if(a.isZero())throw Error("destinationAmountSwapped is zero");return{destinationAmountSwapped:a}}static lpTokensToTradingTokens(e,t,n,o,r){let s=e.mul(n).div(t),a=e.mul(o).div(t);if(r===0)return{tokenAmount0:s,tokenAmount1:a};if(r===1)return Gr(e.mul(n),t).gt(Ro)&&s.gt(Ro)&&(s=s.add(new Ni(1))),Gr(e.mul(o),t).gt(Ro)&&a.gt(Ro)&&(a=a.add(new Ni(1))),{tokenAmount0:s,tokenAmount1:a};throw Error("roundDirection value error")}};var Qr=class{static tradingFee(e,t){return ur(e,t,Yt)}static protocolFee(e,t){return Ms(e,t,Yt)}static fundFee(e,t){return Ms(e,t,Yt)}};var Kl=(t=>(t[t.Floor=0]="Floor",t[t.Ceiling=1]="Ceiling",t))(Kl||{}),Hr=class{static validate_supply(e,t){if(e.isZero())throw Error("tokenAmount0 is zero");if(t.isZero())throw Error("tokenAmount1 is zero")}static swap(e,t,n,o){let r=Qr.tradingFee(e,o),s=e.sub(r),{destinationAmountSwapped:a}=Xr.swapWithoutFees(s,t,n);return{newSwapDestinationAmount:n.sub(a),sourceAmountSwapped:e,destinationAmountSwapped:a,tradeFee:r}}static swapBaseOut({poolMintA:e,poolMintB:t,tradeFeeRate:n,baseReserve:o,quoteReserve:r,outputMint:s,outputAmount:a}){let[c,u,l,d,m]=t.address===s.toString()?[o,r,e.decimals,t.decimals,e.address]:[r,o,t.decimals,e.decimals,t.address],p=new zr(u.toString()).div(10**d).div(new zr(c.toString()).div(10**l)),y=a.gte(u)?u.sub(new Xa(1)):a,f=u.sub(y),b=Ht(c.mul(y),f),g=Ht(b.mul(new Xa(1e6)),new Xa(1e6).sub(n)),w=g.sub(b),k=new zr(y.toString()).div(10**d).div(new zr(g.toString()).div(10**l)),h=p.isZero()?0:k.sub(p).div(p).abs().toNumber();return{amountRealOut:y,amountIn:g,amountInWithoutFee:b,tradeFee:w,priceImpact:h}}};import Fe from"bn.js";import{PublicKey as vi,TransactionInstruction as ao,Keypair as Wy,SystemProgram as Dy}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Rl,TOKEN_2022_PROGRAM_ID as za,TOKEN_PROGRAM_ID as Un}from"@solana/spl-token";var Ry=Buffer.from("vault_and_lp_mint_auth_seed","utf8"),Ny=Buffer.from("amm_config","utf8"),Oy=Buffer.from("pool","utf8"),vy=Buffer.from("pool_lp_mint","utf8"),My=Buffer.from("pool_vault","utf8"),Ey=Buffer.from("observation","utf8");function No(i){return ee([Ry],i)}function IK(i,e){return ee([Ny,Fy(e)],i)}function Qa(i,e,t,n){return ee([Oy,e.toBuffer(),t.toBuffer(),n.toBuffer()],i)}function _y(i,e){return ee([vy,e.toBuffer()],i)}function Cl(i,e,t){return ee([My,e.toBuffer(),t.toBuffer()],i)}function Oi(i,e){return ee([Ey,e.toBuffer()],i)}function Fy(i){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,i,!1),new Uint8Array(e)}function Ll({poolId:i,programId:e,configId:t,mintA:n,mintB:o}){let r=No(e).publicKey,s=i||Qa(e,t,n,o).publicKey,a=_y(e,s).publicKey,c=Cl(e,s,n).publicKey,u=Cl(e,s,o).publicKey,l=Oi(e,s).publicKey;return{poolId:s,configId:t,authority:r,lpMint:a,vaultA:c,vaultB:u,observationId:l}}var Vy=Buffer.from("locked_liquidity","utf8");function jr(i,e){return ee([Vy,e.toBuffer()],i)}var qy=pe("Raydium_cpmm"),uo={initialize:[175,175,109,31,13,152,155,237],deposit:[242,35,198,137,82,225,242,182],withdraw:[183,18,70,156,148,109,161,34],swapBaseInput:[143,190,90,218,196,30,51,222],swapBaseOutput:[55,217,98,86,163,74,180,173],lockCpLiquidity:[216,157,29,78,38,51,31,26],collectCpFee:[8,30,51,199,209,184,247,133]};function Nl(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g,w,k){let h=N([P("amountMaxA"),P("amountMaxB"),P("openTime")]),x=Qa(i,t,r,s).publicKey,T=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!o.equals(x),isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:Un,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:Rl,isSigner:!1,isWritable:!1},{pubkey:sr,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1}],B=Buffer.alloc(h.span);return h.encode({amountMaxA:g,amountMaxB:w,openTime:k},B),new ao({keys:T,programId:i,data:Buffer.from([...uo.initialize,...B])})}function Ol(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y){let f=N([P("lpAmount"),P("amountMaxA"),P("amountMaxB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Un,isSigner:!1,isWritable:!1},{pubkey:za,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!0}],g=Buffer.alloc(f.span);return qy.debug("cpmm deposit data",{lpAmount:m.toString(),amountMaxA:p.toString(),amountMaxB:y.toString()}),f.encode({lpAmount:m,amountMaxA:p,amountMaxB:y},g),new ao({keys:b,programId:i,data:Buffer.from([...uo.deposit,...g])})}function vl(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y){let f=N([P("lpAmount"),P("amountMinA"),P("amountMinB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Un,isSigner:!1,isWritable:!1},{pubkey:za,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:an,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);return f.encode({lpAmount:m,amountMinA:p,amountMinB:y},g),new ao({keys:b,programId:i,data:Buffer.from([...uo.withdraw,...g])})}function Yr(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y,f){let b=N([P("amountIn"),P("amounOutMin")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],w=Buffer.alloc(b.span);return b.encode({amountIn:y,amounOutMin:f},w),new ao({keys:g,programId:i,data:Buffer.from([...uo.swapBaseInput,...w])})}function Ml(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y,f){let b=N([P("amountInMax"),P("amountOut")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],w=Buffer.alloc(b.span);return b.encode({amountInMax:y,amountOut:f},w),new ao({keys:g,programId:i,data:Buffer.from([...uo.swapBaseOutput,...w])})}async function El(i){let{ownerInfo:e,poolInfo:t,poolKeys:n,feeNftOwner:o,getEphemeralSigners:r}=i,s=[],[a,c]=[new vi(t.id),new vi(t.lpMint.address)],u;if(r)u=new vi((await r(1))[0]);else{let b=Wy.generate();s.push(b),u=b.publicKey}let{publicKey:l}=Z(o,u,Un),{publicKey:d}=hn(u),{publicKey:m}=jr(i.lockProgram,u),{publicKey:p}=Z(e.wallet,c,Un),{publicKey:y}=Z(i.lockAuthProgram,c,Un),f=Uy({programId:i.lockProgram,auth:i.lockAuthProgram,payer:e.feePayer,liquidityOwner:e.wallet,nftOwner:o,nftMint:u,nftAccount:l,poolId:a,lockPda:m,mintLp:c,userLpVault:p,lockLpVault:y,poolVaultA:new vi(n.vault.A),poolVaultB:new vi(n.vault.B),metadataAccount:d,lpAmount:i.lpAmount,withMetadata:i.withMetadata??!0});return{address:{nftMint:u,nftAccount:l,metadataAccount:d,lockPda:m,userLpVault:p,lockLpVault:y},instructions:[f],signers:s,instructionTypes:[V.CpmmLockLp],lookupTableAddress:[]}}function Uy({programId:i,auth:e,payer:t,liquidityOwner:n,nftOwner:o,nftMint:r,nftAccount:s,poolId:a,lockPda:c,mintLp:u,userLpVault:l,lockLpVault:d,poolVaultA:m,poolVaultB:p,metadataAccount:y,lpAmount:f,withMetadata:b}){let g=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:Dy.programId,isSigner:!1,isWritable:!1},{pubkey:Un,isSigner:!1,isWritable:!1},{pubkey:Rl,isSigner:!1,isWritable:!1},{pubkey:Xt,isSigner:!1,isWritable:!1}],w=N([P("lpAmount"),_e("withMetadata")]),k=Buffer.alloc(w.span);w.encode({lpAmount:f,withMetadata:b},k);let h=Buffer.from([...uo.lockCpLiquidity,...k]);return new ao({keys:g,programId:i,data:h})}function _l({programId:i,nftOwner:e,auth:t,nftAccount:n,lockPda:o,poolId:r,mintLp:s,userVaultA:a,userVaultB:c,poolVaultA:u,poolVaultB:l,mintA:d,mintB:m,lockLpVault:p,lpFeeAmount:y,cpmmProgram:f,cpmmAuthProgram:b}){let g=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:f??Ho,isSigner:!1,isWritable:!1},{pubkey:b??Ws,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:Un,isSigner:!1,isWritable:!1},{pubkey:za,isSigner:!1,isWritable:!1},{pubkey:an,isSigner:!1,isWritable:!1}],w=N([P("lpFeeAmount")]),k=Buffer.alloc(w.span);w.encode({lpFeeAmount:y},k);let h=Buffer.from([...uo.collectCpFee,...k]);return new ao({keys:g,programId:i,data:h})}var Ha=N([he(8),F("bump"),_e("disableCreatePool"),$t("index"),P("tradeFeeRate"),P("protocolFeeRate"),P("fundFeeRate"),P("createPoolFee"),L("protocolOwner"),L("fundOwner"),X(P(),16)]),Mi=N([he(8),L("configId"),L("poolCreator"),L("vaultA"),L("vaultB"),L("mintLp"),L("mintA"),L("mintB"),L("mintProgramA"),L("mintProgramB"),L("observationId"),F("bump"),F("status"),F("lpDecimals"),F("mintDecimalA"),F("mintDecimalB"),P("lpAmount"),P("protocolFeesMintA"),P("protocolFeesMintB"),P("fundFeesMintA"),P("fundFeesMintB"),P("openTime"),X(P(),32)]);var Ze=i=>((performance.now()-i)/1e3).toFixed(2),Ei=class extends Ne{constructor(e){super(e)}async load(){this.checkDisabled()}async getCpmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async getRpcPoolInfo(e,t,n){if(!e&&!t?.marketAccount)throw new Error("Either poolId or accountInfos.marketAccount must be provided");let o=e?(await Ke(this.scope.connection,[{pubkey:new Q(e)}]))[0]:t.marketAccount;if(!o?.accountInfo){let x=e||t?.marketAccount?.pubkey?.toBase58()||"unknown";throw new Error(`Pool account not found: ${x}`)}let r={...Mi.decode(o.accountInfo.data),programId:o.accountInfo.owner},s=[],a=[r.vaultA,r.vaultB];e&&(s.push(...a.map(x=>({pubkey:new Q(x)}))),n&&s.push({pubkey:new Q(r.configId)}));let c=[];e&&s.length>0&&(c=await Ke(this.scope.connection,s));let u;if(n){let x=e?c[c.length-1]:t?.configState;if(!x?.accountInfo)throw new Error(`Config account not found: ${r.configId}`);u=Ha.decode(x.accountInfo.data)}let l=e?c[0]?.accountInfo:t?.vaultAInfo?.accountInfo,d=e?c[1]?.accountInfo:t?.vaultBInfo?.accountInfo;if(!l||!d)throw new Error(`Vault accounts not found: A=${r.vaultA}, B=${r.vaultB}`);let m=new Fe(ja.decode(l.data).amount.toString()),p=new Fe(ja.decode(d.data).amount.toString()),y=m.sub(r.protocolFeesMintA).sub(r.fundFeesMintA),f=p.sub(r.protocolFeesMintB).sub(r.fundFeesMintB),b=new C(10).pow(r.mintDecimalA),g=new C(10).pow(r.mintDecimalB),w=new C(y.toString()).div(b),k=new C(f.toString()).div(g),h=w.isZero()?new C(0):k.div(w);return{...r,baseReserve:y,quoteReserve:f,vaultAAmount:m,vaultBAmount:p,configInfo:u,poolPrice:h}}async getRpcPoolInfos(e,t){let n=await Ke(this.scope.connection,e.map(d=>({pubkey:new Q(d)}))),o={},r=new Set,s=[];for(let d=0;d<e.length;d++){let m=n[d];if(m.accountInfo===null)throw Error("fetch pool info error: "+String(e[d]));let p=Mi.decode(m.accountInfo.data);o[String(e[d])]={...p,programId:m.accountInfo.owner},r.add(String(p.configId)),s.push(p.vaultA,p.vaultB)}let a={};if(t){let d=[...r],m=await Ke(this.scope.connection,d.map(p=>({pubkey:new Q(p)})));for(let p=0;p<d.length;p++){let y=m[p].accountInfo;if(y===null)throw Error("fetch pool config error: "+d[p]);a[d[p]]=Ha.decode(y.data)}}let c={},u=await Ke(this.scope.connection,s.map(d=>({pubkey:new Q(d)})));for(let d=0;d<s.length;d++){let m=u[d].accountInfo;if(m===null)throw Error("fetch vault info error: "+s[d]);c[String(s[d])]=new Fe(ja.decode(m.data).amount.toString())}let l={};for(let[d,m]of Object.entries(o)){let p=c[m.vaultA.toString()].sub(m.protocolFeesMintA).sub(m.fundFeesMintA),y=c[m.vaultB.toString()].sub(m.protocolFeesMintB).sub(m.fundFeesMintB);l[d]={...m,baseReserve:p,quoteReserve:y,vaultAAmount:c[m.vaultA.toString()],vaultBAmount:c[m.vaultB.toString()],configInfo:a[m.configId.toString()],poolPrice:new C(y.toString()).div(new C(10).pow(m.mintDecimalB)).div(new C(p.toString()).div(new C(10).pow(m.mintDecimalA)))}}return l}toComputePoolInfos({pools:e,mintInfos:t}){return Object.keys(e).reduce((n,o)=>{let r=e[o],[s,a]=[r.mintA.toBase58(),r.mintB.toBase58()];return{...n,[o]:{...r,id:new Q(o),configInfo:r.configInfo,version:7,authority:No(r.programId).publicKey,mintA:At({address:s,decimals:r.mintDecimalA,programId:r.mintProgramA.toBase58(),extensions:{feeConfig:t[s]?.feeConfig?Wn(t[s]?.feeConfig):void 0}}),mintB:At({address:a,decimals:r.mintDecimalB,programId:r.mintProgramB.toBase58(),extensions:{feeConfig:t[a]?.feeConfig?Wn(t[a]?.feeConfig):void 0}})}}},{})}async getPoolInfoFromRpc(e,t,n){t=t||await this.getRpcPoolInfo(e,void 0,!0),n=n||await po({connection:this.scope.connection,mints:[t.mintA,t.mintB]});let o=At({address:t.mintA.toBase58(),decimals:t.mintDecimalA,programId:t.mintProgramA.toBase58(),extensions:{feeConfig:n[t.mintA.toBase58()].feeConfig?Wn(n[t.mintA.toBase58()].feeConfig):void 0}}),r=At({address:t.mintB.toBase58(),decimals:t.mintDecimalB,programId:t.mintProgramB.toBase58(),extensions:{feeConfig:n[t.mintB.toBase58()].feeConfig?Wn(n[t.mintB.toBase58()].feeConfig):void 0}}),s=At({address:t.mintLp.toBase58(),decimals:t.lpDecimals,programId:Et.toBase58()}),a={id:t.configId.toBase58(),index:t.configInfo.index,protocolFeeRate:t.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:t.configInfo.tradeFeeRate.toNumber(),fundFeeRate:t.configInfo.fundFeeRate.toNumber(),createPoolFee:t.configInfo.createPoolFee.toString()},c={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};return{poolInfo:{programId:t.programId.toBase58(),id:e,type:"Standard",lpMint:s,lpPrice:0,lpAmount:t.lpAmount.toNumber(),config:a,mintA:o,mintB:r,rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:t.poolPrice.toNumber(),mintAmountA:new C(t.vaultAAmount.toString()).div(10**o.decimals).toNumber(),mintAmountB:new C(t.vaultBAmount.toString()).div(10**r.decimals).toNumber(),feeRate:t.configInfo.tradeFeeRate.toNumber(),openTime:t.openTime.toString(),tvl:0,burnPercent:0,day:c,week:c,month:c,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0},poolKeys:{programId:t.programId.toBase58(),id:e,mintA:o,mintB:r,openTime:t.openTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},authority:No(t.programId).publicKey.toBase58(),mintLp:s,config:a,observationId:Oi(t.programId,new Q(e)).publicKey.toBase58()},rpcData:t}}async createPool({poolId:e,programId:t,poolFeeAccount:n,startTime:o,ownerInfo:r,associatedOnly:s=!1,checkCreateATAOwner:a=!1,txVersion:c,feeConfig:u,computeBudgetConfig:l,txTipConfig:d,feePayer:m,...p}){let y=r.feePayer||this.scope.owner?.publicKey,f=new Fe(new Q(p.mintA.address).toBuffer()).lte(new Fe(new Q(p.mintB.address).toBuffer())),[b,g]=f?[p.mintA,p.mintB]:[p.mintB,p.mintA],[w,k]=f?[p.mintAAmount,p.mintBAmount]:[p.mintBAmount,p.mintAAmount],h=r.useSOLBalance&&b.address===Oo.toBase58(),x=r.useSOLBalance&&g.address===Oo.toBase58(),[T,B]=[new Q(b.address),new Q(g.address)],S=this.createTxBuilder(m),{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:T,tokenProgram:b.programId,owner:this.scope.ownerPubKey,createInfo:h?{payer:y,amount:w}:void 0,notUseTokenAccount:h,skipCloseAccount:!h,associatedOnly:h?!1:s,checkCreateATAOwner:a});S.addInstruction(K||{});let{account:O,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({mint:new Q(g.address),tokenProgram:g.programId,owner:this.scope.ownerPubKey,createInfo:x?{payer:y,amount:k}:void 0,notUseTokenAccount:x,skipCloseAccount:!x,associatedOnly:x?!1:s,checkCreateATAOwner:a});if(S.addInstruction(v||{}),I===void 0||O===void 0)throw Error("you don't has some token account");let _=Ll({poolId:e,programId:t,configId:new Q(u.id),mintA:T,mintB:B});return S.addInstruction({instructions:[Nl(t,this.scope.ownerPubKey,new Q(u.id),_.authority,_.poolId,T,B,_.lpMint,I,O,Z(this.scope.ownerPubKey,_.lpMint).publicKey,_.vaultA,_.vaultB,n,new Q(b.programId??Et),new Q(g.programId??Et),_.observationId,w,k,o)],instructionTypes:[V.CpmmCreatePool]}),S.addCustomComputeBudget(l),S.addTipInstruction(d),S.versionBuild({txVersion:c,extInfo:{address:{..._,mintA:b,mintB:g,programId:t,poolFeeAccount:n,feeConfig:u}}})}async addLiquidity(e){let{poolInfo:t,poolKeys:n,inputAmount:o,baseIn:r,slippage:s,computeResult:a,computeBudgetConfig:c,txTipConfig:u,config:l,txVersion:d,feePayer:m}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),o.isZero()&&this.logAndCreateError("amounts must greater than zero","amountInA",{amountInA:o.toString()});let{account:p}=this.scope,{bypassAssociatedCheck:y,checkCreateATAOwner:f}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...l},b=a?void 0:await this.getRpcPoolInfo(t.id),{liquidity:g,inputAmountFee:w,anotherAmount:k}=a||this.computePairAmount({poolInfo:{...t,lpAmount:new C(b.lpAmount.toString()).div(10**t.lpMint.decimals).toNumber()},baseReserve:b.baseReserve,quoteReserve:b.quoteReserve,slippage:new De(0),baseIn:r,epochInfo:await this.scope.fetchEpochInfo(),amount:new C(o.toString()).div(10**(r?t.mintA.decimals:t.mintB.decimals))}),h=k.amount,x=t.mintA.address===Oo.toString(),T=t.mintB.address===Oo.toString(),B=this.createTxBuilder(m),[S,I]=[new Q(t.mintA.address),new Q(t.mintB.address)],{account:K,instructionParams:O}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Q(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:x||(r?o:h).isZero()?{payer:this.scope.ownerPubKey,amount:r?o:h}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:!1,checkCreateATAOwner:f});B.addInstruction(O||{});let{account:v,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Q(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:T||(r?h:o).isZero()?{payer:this.scope.ownerPubKey,amount:r?h:o}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:!1,checkCreateATAOwner:f});B.addInstruction(_||{}),!K&&!v&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",p.tokenAccounts);let D=await p.getCreatedTokenAccount({mint:new Q(t.lpMint.address)}),{tokenAccount:q,...G}=await p.handleTokenAccount({side:"out",amount:0,mint:new Q(t.lpMint.address),tokenAccount:D,bypassAssociatedCheck:y,checkCreateATAOwner:f});B.addInstruction(G);let ne=n??await this.getCpmmPoolKeys(t.id),ie=new De(new Fe(1)).sub(s);return B.addInstruction({instructions:[Ol(new Q(t.programId),this.scope.ownerPubKey,new Q(ne.authority),new Q(t.id),q,K,v,new Q(ne.vault.A),new Q(ne.vault.B),S,I,new Q(t.lpMint.address),a?a?.liquidity:ie.mul(g).quotient,r?w.amount:h,r?h:w.amount)],instructionTypes:[V.CpmmAddLiquidity],lookupTableAddress:ne.lookupTableAccount?[ne.lookupTableAccount]:[]}),B.addCustomComputeBudget(c),B.addTipInstruction(u),B.versionBuild({txVersion:d})}async withdrawLiquidity(e){let{poolInfo:t,poolKeys:n,lpAmount:o,slippage:r,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u,closeWsol:l=!0}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region");let d=new De(new Fe(1)).sub(r),m=await this.getRpcPoolInfo(t.id),[p,y]=[d.mul(o.mul(m.baseReserve).div(m.lpAmount)).quotient,d.mul(o.mul(m.quoteReserve).div(m.lpAmount)).quotient],f=await this.scope.fetchEpochInfo(),[b,g]=[ke(p,t.mintA.extensions.feeConfig,f,!1),ke(y,t.mintB.extensions.feeConfig,f,!1)],{account:w}=this.scope,k=this.createTxBuilder(u),[h,x]=[new Q(t.mintA.address),new Q(t.mintB.address)],T=h.equals(j),B=x.equals(j),S,I,{account:K,instructionParams:O}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Q(t.mintA.address),notUseTokenAccount:T,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(T&&l),associatedOnly:!T,checkCreateATAOwner:!1});S=K,O&&k.addInstruction(O);let{account:v,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Q(t.mintB.address),notUseTokenAccount:B,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(B&&l),associatedOnly:!B,checkCreateATAOwner:!1});I=v,_&&k.addInstruction(_),(!S||!I)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",w.tokenAccounts);let D=await w.getCreatedTokenAccount({mint:new Q(t.lpMint.address)});D||this.logAndCreateError("cannot found lp token account","tokenAccounts",w.tokenAccounts);let q=n??await this.getCpmmPoolKeys(t.id);return k.addInstruction({instructions:[vl(new Q(t.programId),this.scope.ownerPubKey,new Q(q.authority),new Q(t.id),D,S,I,new Q(q.vault.A),new Q(q.vault.B),h,x,new Q(t.lpMint.address),o,p.sub(b.fee??new Fe(0)),y.sub(g.fee??new Fe(0)))],instructionTypes:[V.CpmmWithdrawLiquidity],lookupTableAddress:q.lookupTableAccount?[q.lookupTableAccount]:[]}),k.addCustomComputeBudget(s),k.addTipInstruction(a),k.versionBuild({txVersion:c})}async swap(e){let{poolInfo:t,poolKeys:n,baseIn:o,fixedOut:r,inputAmount:s,swapResult:a,slippage:c=0,config:u,computeBudgetConfig:l,txTipConfig:d,txVersion:m,feePayer:p,nonce:y}=e,{bypassAssociatedCheck:f,checkCreateATAOwner:b,associatedOnly:g,useIdempotent:w=!1}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,associatedOnly:!0,useIdempotent:!1,...u},k=performance.now();console.log(`Swap start: ${Ze(k)}s, baseIn: ${o}, fixedOut: ${r}, inputAmount: ${s.toString()}`);let h=this.createTxBuilder(p);if(console.log(`TxBuilder created: ${Ze(k)}s`),y&&y?.instruction&&(h.addInstruction({instructions:[y.instruction],instructionTypes:[y.instruction].map(()=>V.NonceAccount)}),console.log(`Nonce instruction added: ${Ze(k)}s`)),l){let{instructions:ie,instructionTypes:de}=bo(l);h.addInstruction({instructions:ie,instructionTypes:de}),console.log(`Compute budget added: ${Ze(k)}s`)}r?a.sourceAmountSwapped=a.sourceAmountSwapped.mul(new Fe((1+c)*1e4)).div(new Fe(1e4)):a.destinationAmountSwapped=a.destinationAmountSwapped.mul(new Fe((1-c)*1e4)).div(new Fe(1e4)),console.log(`Slippage applied: ${Ze(k)}s`);let[x,T]=[new Q(t.mintA.address),new Q(t.mintB.address)],B,S;if(console.log(`Mints prepared: ${Ze(k)}s`),w){let ie=new Q(t.mintA.programId??Et),de=new Q(t.mintB.programId??Et),re=x.equals(Oo),ye=T.equals(Oo);console.log(`${Ze(k)}s: mintAIsSOL: ${re}, mintBIsSOL: ${ye}`),B=Vl(x,this.scope.ownerPubKey,!1,ie),console.log(`${Ze(k)}s: mintATokenAcc prepared: ${B.toBase58()}`),S=Vl(T,this.scope.ownerPubKey,!1,de),console.log(`${Ze(k)}s: mintBTokenAcc prepared: ${S.toBase58()}`),re||(h.addInstruction({instructions:[Fl(this.scope.ownerPubKey,B,this.scope.ownerPubKey,x,ie)],instructionTypes:[V.CreateATA]}),console.log(`Idempotent ATA for mintA added: ${Ze(k)}s`)),ye||(h.addInstruction({instructions:[Fl(this.scope.ownerPubKey,S,this.scope.ownerPubKey,T,de)],instructionTypes:[V.CreateATA]}),console.log(`Idempotent ATA for mintB added: ${Ze(k)}s`))}else{let ie=t.mintA.address===j.toBase58(),de=t.mintB.address===j.toBase58();console.log(`mintAUseSOLBalance: ${ie}, mintBUseSOLBalance: ${de}, ${Ze(k)}s`);let{account:re,instructionParams:ye}=await this.scope.account.getOrCreateTokenAccount({mint:x,tokenProgram:new Q(t.mintA.programId??Et),owner:this.scope.ownerPubKey,createInfo:ie||!o?{payer:this.scope.ownerPubKey,amount:o?a.sourceAmountSwapped:0}:void 0,notUseTokenAccount:ie,skipCloseAccount:!ie,associatedOnly:ie?!1:g,checkCreateATAOwner:b});console.log(`mintATokenAccResult: ${JSON.stringify(re)}, ${Ze(k)}s`),ye&&h.addInstruction(ye),console.log(`mintATokenAccInstruction added: ${Ze(k)}s`),B=re;let{account:dt,instructionParams:$e}=await this.scope.account.getOrCreateTokenAccount({mint:T,tokenProgram:new Q(t.mintB.programId??Et),owner:this.scope.ownerPubKey,createInfo:de||o?{payer:this.scope.ownerPubKey,amount:o?0:a.sourceAmountSwapped}:void 0,notUseTokenAccount:de,skipCloseAccount:!de,associatedOnly:de?!1:g,checkCreateATAOwner:b});console.log(`mintBTokenAccResult: ${JSON.stringify(dt)}, ${Ze(k)}s`),$e&&h.addInstruction($e),console.log(`mintBTokenAccInstruction added: ${Ze(k)}s`),S=dt,(!B||!S)&&this.logAndCreateError("user do not have token account",{mintA:t.mintA.symbol||t.mintA.address,mintB:t.mintB.symbol||t.mintB.address,mintATokenAcc:B,mintBTokenAcc:S,mintAUseSOLBalance:ie,mintBUseSOLBalance:de,associatedOnly:g})}let I=n??await this.getCpmmPoolKeys(t.id);console.log(`Pool keys fetched: ${Ze(k)}s`);let K=o?B:S,O=o?S:B,v=o?x:T,_=o?T:x,D=o?I.vault.A:I.vault.B,q=o?I.vault.B:I.vault.A,G=o?new Q(t.mintA.programId??Et):new Q(t.mintB.programId??Et),ne=o?new Q(t.mintB.programId??Et):new Q(t.mintA.programId??Et);return console.log(`Swap parameters prepared: ${Ze(k)}s`),h.addInstruction({instructions:[r?Ml(new Q(t.programId),this.scope.ownerPubKey,new Q(I.authority),new Q(I.config.id),new Q(t.id),K,O,new Q(D),new Q(q),G,ne,v,_,Oi(new Q(t.programId),new Q(t.id)).publicKey,a.sourceAmountSwapped,a.destinationAmountSwapped):Yr(new Q(t.programId),this.scope.ownerPubKey,new Q(I.authority),new Q(I.config.id),new Q(t.id),K,O,new Q(D),new Q(q),G,ne,v,_,Oi(new Q(t.programId),new Q(t.id)).publicKey,s,a.destinationAmountSwapped)],instructionTypes:[r?V.CpmmSwapBaseOut:V.CpmmSwapBaseIn]}),console.log(`Swap instruction added: ${Ze(k)}s`),h.addTipInstruction(d),console.log(`Tip instruction added: ${Ze(k)}s`),h.versionBuild({txVersion:m},y?.nonce)}async lockLp(e){let{poolInfo:t,lpAmount:n,computeBudgetConfig:o,txTipConfig:r,txVersion:s,feePayer:a,feeNftOwner:c}=e;n.isZero()&&this.logAndCreateError("lpAmount must greater than zero",{lpAmount:n.toString()});let u=this.createTxBuilder(a),l=e.poolKeys??await this.getCpmmPoolKeys(t.id),d=await El({poolInfo:t,poolKeys:l,ownerInfo:{wallet:this.scope.ownerPubKey,feePayer:e.feePayer??this.scope.ownerPubKey},feeNftOwner:c??this.scope.ownerPubKey,lockProgram:e.programId??jo,lockAuthProgram:e.authProgram??Yo,lpAmount:n,withMetadata:e.withMetadata??!0,getEphemeralSigners:e.getEphemeralSigners});return u.addInstruction(d),u.addCustomComputeBudget(o),u.addTipInstruction(r),u.versionBuild({txVersion:s,extInfo:d.address})}async harvestLockLp(e){let{poolInfo:t,lpFeeAmount:n,nftMint:o,programId:r=jo,authProgram:s=Yo,cpmmProgram:a,computeBudgetConfig:c,txTipConfig:u,txVersion:l,closeWsol:d=!0}=e;n.isZero()&&this.logAndCreateError("lpFeeAmount must greater than zero",{lpAmount:n.toString()});let m=e.feePayer||this.scope.ownerPubKey,p=this.createTxBuilder(m),[y,f]=[new Q(t.mintA.address),new Q(t.mintB.address)],b=y.equals(j),g=f.equals(j),w,k,{account:h,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Q(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(b&&d),associatedOnly:!b,checkCreateATAOwner:!1});w=h,x&&p.addInstruction(x);let{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Q(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(g&&d),associatedOnly:!g,checkCreateATAOwner:!1});k=T,B&&p.addInstruction(B),(!w||!k)&&this.logAndCreateError("cannot found target token accounts",{tokenAccountA:w,tokenAccountB:k});let S=e.poolKeys??await this.getCpmmPoolKeys(t.id),{publicKey:I}=Z(m,o,Et),{publicKey:K}=jr(r,o),{publicKey:O}=Z(s,new Q(t.lpMint.address),Et);return p.addInstruction({instructions:[_l({programId:r??jo,nftOwner:this.scope.ownerPubKey,auth:s??Yo,nftMint:o,nftAccount:I,lockPda:K,poolId:new Q(t.id),mintLp:new Q(S.mintLp.address),userVaultA:w,userVaultB:k,poolVaultA:new Q(S.vault.A),poolVaultB:new Q(S.vault.B),mintA:y,mintB:f,lockLpVault:O,lpFeeAmount:n,cpmmProgram:a?.programId,cpmmAuthProgram:a?.authProgram})],instructionTypes:[V.CpmmCollectLockFee]}),p.addCustomComputeBudget(c),p.addTipInstruction(u),p.versionBuild({txVersion:l})}computeSwapAmount({pool:e,amountIn:t,outputMint:n,slippage:o}){let r=n.toString()===e.mintB.address,s=Hr.swap(t,r?e.baseReserve:e.quoteReserve,r?e.quoteReserve:e.baseReserve,e.configInfo.tradeFeeRate),a=new C(s.destinationAmountSwapped.toString()).div(s.sourceAmountSwapped.toString()),c=s.destinationAmountSwapped.mul(new Fe((1-o)*1e4)).div(new Fe(1e4));return{allTrade:s.sourceAmountSwapped.eq(t),amountIn:t,amountOut:s.destinationAmountSwapped,minAmountOut:c,executionPrice:a,fee:s.tradeFee,priceImpact:e.poolPrice.sub(a).div(e.poolPrice)}}computePairAmount({poolInfo:e,baseReserve:t,quoteReserve:n,amount:o,slippage:r,epochInfo:s,baseIn:a}){let c=1-Number(r.toSignificant())/100,u=new Fe(new C(o).mul(10**e[a?"mintA":"mintB"].decimals).mul(c).toFixed(0)),l=ke(u,e[a?"mintA":"mintB"].extensions.feeConfig,s,!1),d=u.sub(l.fee??new Fe(0)),m=new Fe(new C(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,C.ROUND_DOWN));this.logDebug("baseReserve:",t.toString(),"quoteReserve:",n.toString()),this.logDebug("tokenIn:",a?e.mintA.symbol:e.mintB.symbol,"amountIn:",u.toString(),"amountInFee:",l.fee?.toString()??0,"anotherToken:",a?e.mintB.symbol:e.mintA.symbol,"slippage:",`${r.toSignificant()}%`);let p=a?"base":"quote";this.logDebug("input side:",p);let y=d.mul(m).div(p==="base"?t:n),f={amount:ze,fee:void 0,expirationTime:void 0};if(!d.isZero()){let h=Gy(y,t,n,m);this.logDebug("lpAmountData:",{amountA:h.amountA.toString(),amountB:h.amountB.toString()}),f=ke(h[a?"amountB":"amountA"],e[a?"mintB":"mintA"].extensions.feeConfig,s,!0)}let b=new De(new Fe(1)).add(r),g=new De(new Fe(1)).sub(r),w=ke(b.mul(f.amount.sub(f.fee??new Fe(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0),k=ke(g.mul(f.amount.sub(f.fee??new Fe(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0);return this.logDebug("anotherAmount:",f.amount.toString(),"anotherAmountFee:",f.fee?.toString()??0,"maxAnotherAmount:",w.amount.toString(),"maxAnotherAmountFee:",w.fee?.toString()??0),{inputAmountFee:l,anotherAmount:f,maxAnotherAmount:w,minAnotherAmount:k,liquidity:y}}};function Gy(i,e,t,n){let o=i.mul(e).div(n);!o.isZero()&&!i.mul(e).mod(n).isZero()&&(o=o.add(new Fe(1)));let r=i.mul(t).div(n);return!r.isZero()&&!i.mul(t).mod(n).isZero()&&(r=r.add(new Fe(1))),{amountA:o,amountB:r}}import{PublicKey as co}from"@solana/web3.js";import{createTransferInstruction as Xl,TOKEN_PROGRAM_ID as Xe,TOKEN_2022_PROGRAM_ID as Jr}from"@solana/spl-token";import es from"bn.js";var Wl={[pr.toBase58()]:3},Dl={3:pr};var Ya=N([he(5),he(8),L("ownAddress"),P("vaultSignerNonce"),L("baseMint"),L("quoteMint"),L("baseVault"),P("baseDepositsTotal"),P("baseFeesAccrued"),L("quoteVault"),P("quoteDepositsTotal"),P("quoteFeesAccrued"),P("quoteDustThreshold"),L("requestQueue"),L("eventQueue"),L("bids"),L("asks"),P("baseLotSize"),P("quoteLotSize"),P("feeRateBps"),P("referrerRebatesAccrued"),he(7)]),ql={3:Ya};import{PublicKey as Ul}from"@solana/web3.js";var Zr=pe("Serum"),$r=class{static getProgramId(e){let t=Dl[e];return t||Zr.logWithError("invalid version","version",e),t}static getVersion(e){let t=e.toBase58(),n=Wl[t];return n||Zr.logWithError("invalid program id","programId",t),n}static getStateLayout(e){let t=ql[e];return t||Zr.logWithError(!!t,"invalid version","version",e),t}static getLayouts(e){return{state:this.getStateLayout(e)}}static getAssociatedAuthority({programId:e,marketId:t}){let n=[t.toBuffer()],o=0,r;for(;o<100;){try{let s=n.concat(Buffer.from([o]),Buffer.alloc(7));r=Ul.createProgramAddressSync(s,e)}catch(s){if(s instanceof TypeError)throw s;o++;continue}return{publicKey:r,nonce:o}}return Zr.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),{publicKey:Ul.default,nonce:o}}};import{PublicKey as R,SystemProgram as _i,TransactionInstruction as Fi}from"@solana/web3.js";import ln from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Za,TOKEN_2022_PROGRAM_ID as $a,TOKEN_PROGRAM_ID as Gn}from"@solana/spl-token";function QC(i,e,t,n,o,r,s,a,c,u,l,d){let m=N([F("instruction"),P("amountIn"),P("amountOut")]),p=[{pubkey:_i.programId,isSigner:!1,isWritable:!1},{pubkey:Gn,isSigner:!1,isWritable:!1},{pubkey:new R(t.programId),isSigner:!1,isWritable:!1},{pubkey:new R(t.id),isSigner:!1,isWritable:!0},{pubkey:new R(n.id),isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let f=Re(t);p.push({pubkey:f.config.id,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(c)?f.vault.A:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(c)?f.vault.B:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},...d.map(b=>({pubkey:b,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let f=Re(t);p.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:new R("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0})}else{let f=Re(t);p.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},...f.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:f.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:f.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0}])}let y=Buffer.alloc(m.span);return m.encode({instruction:4,amountIn:u,amountOut:l},y),new Fi({keys:p,programId:i,data:y})}function zC(i,e,t,n,o,r,s,a,c,u){let l=N([F("instruction")]),d=[{pubkey:_i.programId,isSigner:!1,isWritable:!1},{pubkey:Gn,isSigner:!1,isWritable:!1},{pubkey:new R(String(n.programId)),isSigner:!1,isWritable:!1},{pubkey:new R(String(n.id)),isSigner:!1,isWritable:!0},{pubkey:new R(String(t.id)),isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let p=Re(n);d.push({pubkey:p.config.id,isSigner:!1,isWritable:!1},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.mintA.address.equals(c)?p.vault.A:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.mintA.address.equals(c)?p.vault.B:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0},...u.map(y=>({pubkey:y,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let p=Re(n);d.push({pubkey:p.authority,isSigner:!1,isWritable:!1},{pubkey:p.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:new R("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:p.openOrders,isSigner:!1,isWritable:!0},{pubkey:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.marketId,isSigner:!1,isWritable:!0},{pubkey:p.marketBids,isSigner:!1,isWritable:!0},{pubkey:p.marketAsks,isSigner:!1,isWritable:!0},{pubkey:p.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0})}else{let p=Re(n);d.push({pubkey:p.authority,isSigner:!1,isWritable:!1},{pubkey:p.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:p.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:p.openOrders,isSigner:!1,isWritable:!0},{pubkey:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.marketId,isSigner:!1,isWritable:!0},{pubkey:p.marketBids,isSigner:!1,isWritable:!0},{pubkey:p.marketAsks,isSigner:!1,isWritable:!0},{pubkey:p.marketEventQueue,isSigner:!1,isWritable:!0},...p.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:p.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:p.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0}])}let m=Buffer.alloc(l.span);return l.encode({instruction:5},m),new Fi({keys:d,programId:i,data:m})}function Xy(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y){let f=[],b=[A({pubkey:Gn,isWritable:!1}),A({pubkey:$a,isWritable:!1}),A({pubkey:Za,isWritable:!1}),A({pubkey:_i.programId,isWritable:!1}),A({pubkey:e,isSigner:!0})];b.push(A({pubkey:t})),b.push(A({pubkey:o}));let g=[c,u],w=[l,d],k=[r,s,a];for(let T=0;T<g.length;T++){let B=g[T],S=k[T]===B.mintA.address;if(b.push(A({pubkey:new R(B.programId),isWritable:!1})),T===g.length-1?b.push(A({pubkey:o})):b.push(A({pubkey:n})),b.push(A({pubkey:new R(k[T])})),b.push(A({pubkey:new R(k[T+1])})),B.version===6){let I=w[T];b.push(A({pubkey:new R(I.config.id)})),b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(S?I.vault.A:I.vault.B)})),b.push(A({pubkey:new R(S?I.vault.B:I.vault.A)})),b.push(A({pubkey:new R(B.observationId)})),b.push(A({pubkey:an})),b.push(A({pubkey:Ge(new R(B.programId),new R(B.id)).publicKey})),f.push(Ja(B.sqrtPriceX64.toString(),S));for(let K of y[T]??[])b.push(A({pubkey:new R(K)}))}else if(B.version===5){let I=w[T];b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(I.authority),isWritable:!1})),b.push(A({pubkey:new R(I.marketProgramId)})),b.push(A({pubkey:new R(I.marketAuthority)})),b.push(A({pubkey:fr,isWritable:!1})),b.push(A({pubkey:new R(I.openOrders)})),b.push(A({pubkey:new R(I.vault.A)})),b.push(A({pubkey:new R(I.vault.B)})),b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(I.marketId)})),b.push(A({pubkey:new R(I.marketBids)})),b.push(A({pubkey:new R(I.marketAsks)})),b.push(A({pubkey:new R(I.marketEventQueue)})),b.push(A({pubkey:new R(I.marketBaseVault)})),b.push(A({pubkey:new R(I.marketQuoteVault)}))}else if(B.version===4){let I=w[T],K=B.status!==1;b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(I.authority),isWritable:!1})),b.push(A({pubkey:new R(K?I.id:I.marketProgramId)})),b.push(A({pubkey:new R(K?I.id:I.marketAuthority)})),b.push(A({pubkey:new R(K?I.id:I.openOrders)})),b.push(A({pubkey:new R(I.vault.A)})),b.push(A({pubkey:new R(I.vault.B)})),b.push(A({pubkey:new R(K?I.id:I.marketId)})),b.push(A({pubkey:new R(K?I.id:I.marketBids)})),b.push(A({pubkey:new R(K?I.id:I.marketAsks)})),b.push(A({pubkey:new R(K?I.id:I.marketEventQueue)})),b.push(A({pubkey:new R(K?I.id:I.marketBaseVault)})),b.push(A({pubkey:new R(K?I.id:I.marketQuoteVault)}))}else if(B.version===7){let I=w[T];b.push(A({pubkey:new R(I.authority)})),b.push(A({pubkey:new R(I.config.id)})),b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(S?I.vault.A:I.vault.B)})),b.push(A({pubkey:new R(S?I.vault.B:I.vault.A)})),b.push(A({pubkey:new R(B.observationId)}))}else throw Error("pool type error")}let h=N([F("insId"),P("amountIn"),P("amountOut"),X($(),f.length,"clmmPriceLimit")]),x=Buffer.alloc(h.span);return h.encode({insId:0,amountIn:m,amountOut:p,clmmPriceLimit:f},x),new Fi({keys:b,programId:i,data:x})}function Ja(i,e){if(i)if(e){let t=new ln(i).div(new ln(25));return t.gt(Rr)?t:Rr}else{let t=new ln(i).mul(new ln(25));return t.lt(Nr)?t:Nr}else return e?Rr:Nr}function Gl({routeProgram:i,ownerInfo:e,inputMint:t,swapInfo:n}){if(n.routeType==="amm")if(n.poolInfo[0].version===6){let o=n.poolKey[0],r=Re(o),s=t.equals(r.mintA.address)?Vt.add(Ot):Wt.sub(Ot);return xe.makeSwapBaseInInstructions({poolInfo:o,poolKeys:o,observationId:n.poolInfo[0].observationId,ownerInfo:{wallet:e.wallet,tokenAccountA:r.mintA.address.equals(t)?e.sourceToken:e.destinationToken,tokenAccountB:r.mintA.address.equals(t)?e.destinationToken:e.sourceToken},inputMint:t,amountIn:n.amountIn.amount.raw,amountOutMin:n.minAmountOut.amount.raw.sub(n.minAmountOut.fee?.raw??new ln(0)),sqrtPriceLimitX64:s,remainingAccounts:n.remainingAccounts[0]??[]})}else if(n.poolInfo[0].version===7){let o=n.poolInfo[0],r=t.toString()===n.poolInfo[0].mintA.address;return{signers:[],instructions:[Yr(o.programId,e.wallet,o.authority,o.configId,o.id,e.sourceToken,e.destinationToken,r?o.vaultA:o.vaultB,r?o.vaultB:o.vaultA,r?o.mintProgramA:o.mintProgramB,r?o.mintProgramB:o.mintProgramA,new R(o[r?"mintA":"mintB"].address),new R(o[r?"mintB":"mintA"].address),o.observationId,n.amountIn.amount.raw,n.minAmountOut.amount.raw)],lookupTableAddress:[],instructionTypes:[r?V.CpmmSwapBaseIn:V.CpmmSwapBaseOut],address:{}}}else{let o=n.poolKey[0];return{signers:[],instructions:[Vr({poolKeys:o,version:n.poolInfo[0].pooltype.includes("StablePool")?5:4,userKeys:{tokenAccountIn:e.sourceToken,tokenAccountOut:e.destinationToken,owner:e.wallet},amountIn:n.amountIn.amount.raw,amountOut:n.minAmountOut.amount.raw.sub(n.minAmountOut.fee?.raw??new ln(0)),fixedSide:"in"})],lookupTableAddress:o.lookupTableAccount?[o.lookupTableAccount]:[],instructionTypes:[n.poolInfo[0].pooltype.includes("StablePool")?V.AmmV5SwapBaseIn:V.AmmV4SwapBaseIn],address:{}}}else if(n.routeType==="route"){let o=n.poolInfo[0],r=n.poolInfo[1],s=n.poolKey[0],a=n.poolKey[1];if(e.routeToken===void 0)throw Error("owner route token account check error");return{signers:[],instructions:[Xy(i,e.wallet,e.sourceToken,e.routeToken,e.destinationToken,t.toString(),n.middleToken.mint.toString(),n.outputMint.toString(),o,r,s,a,n.amountIn.amount.raw,n.minAmountOut.amount.raw.sub(n.minAmountOut.fee?.raw??new ln(0)),n.remainingAccounts)],instructionTypes:[V.RouteSwap],lookupTableAddress:[s.lookupTableAccount,a.lookupTableAccount].filter(c=>c!==void 0),address:{}}}else throw Error("route type error")}function HC({programId:i,wallet:e,amount:t,inputAccount:n,outputAccount:o,routeInfo:r,poolKeys:s}){if(r.success===!1)throw Error("route info error");let a=[],c=[A({pubkey:Gn,isWritable:!1}),A({pubkey:$a,isWritable:!1}),A({pubkey:Za,isWritable:!1}),A({pubkey:_i.programId,isWritable:!1}),A({pubkey:e,isSigner:!0})],u={[r.data.inputMint]:n,[r.data.outputMint]:o};c.push(A({pubkey:u[r.data.inputMint]})),c.push(A({pubkey:u[r.data.outputMint]}));for(let m=0;m<s.length;m++){let p=r.data.routePlan[m],y=s[m],f=p.inputMint===y.mintA.address;if(c.push(A({pubkey:new R(y.programId),isWritable:!1})),m===s.length-1)c.push(A({pubkey:u[p.outputMint]}));else{let b=p.outputMint;if(u[b]===void 0){let g=Z(e,new R(b),y.programId===wt.CLMM_PROGRAM_ID.toBase58()||y.programId===wt.CREATE_CPMM_POOL_PROGRAM.toBase58()?new R(f?y.mintB.programId:y.mintA.programId):Gn).publicKey;u[b]=g}c.push(A({pubkey:u[b]}))}if(c.push(A({pubkey:new R(p.inputMint)})),c.push(A({pubkey:new R(p.outputMint)})),y.programId===wt.CLMM_PROGRAM_ID.toBase58()){let b=y;c.push(A({pubkey:new R(b.config.id)})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(f?b.vault.A:b.vault.B)})),c.push(A({pubkey:new R(f?b.vault.B:b.vault.A)})),c.push(A({pubkey:new R(b.observationId)})),c.push(A({pubkey:an,isWritable:!1})),c.push(A({pubkey:new R(b.exBitmapAccount)})),a.push(Ja(p.lastPoolPriceX64,f));for(let g of p.remainingAccounts??[])c.push(A({pubkey:new R(g)}))}else if(y.programId===wt.AMM_STABLE.toBase58()){let b=y;c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.authority),isWritable:!1})),c.push(A({pubkey:new R(b.marketProgramId),isWritable:!1})),c.push(A({pubkey:new R(b.marketAuthority),isWritable:!1})),c.push(A({pubkey:fr,isWritable:!1})),c.push(A({pubkey:new R(b.openOrders)})),c.push(A({pubkey:new R(b.vault.A)})),c.push(A({pubkey:new R(b.vault.B)})),c.push(A({pubkey:new R(b.marketId)})),c.push(A({pubkey:new R(b.marketBids)})),c.push(A({pubkey:new R(b.marketAsks)})),c.push(A({pubkey:new R(b.marketEventQueue)})),c.push(A({pubkey:new R(b.marketBaseVault)})),c.push(A({pubkey:new R(b.marketQuoteVault)}))}else if(y.programId===wt.AMM_V4.toBase58()){let b=y;c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.authority),isWritable:!1})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.vault.A)})),c.push(A({pubkey:new R(b.vault.B)})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.id)}))}else if(y.programId===wt.CREATE_CPMM_POOL_PROGRAM.toBase58()){let b=y;c.push(A({pubkey:new R(b.authority)})),c.push(A({pubkey:new R(b.config.id)})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(f?b.vault.A:b.vault.B)})),c.push(A({pubkey:new R(f?b.vault.B:b.vault.A)})),c.push(A({pubkey:new R(b.observationId)}))}else throw Error("pool type error")}let l=N([F("insId"),P("amountIn"),P("amountOut"),X($(),a.length,"clmmPriceLimit")]),d=Buffer.alloc(l.span);return l.encode({insId:0,amountIn:t,amountOut:new ln(r.data.otherAmountThreshold),clmmPriceLimit:a},d),new Fi({keys:c,programId:i,data:d})}function jC({programId:i,wallet:e,inputAccount:t,outputAccount:n,routeInfo:o,poolKeys:r}){if(o.success===!1)throw Error("route info error");let s=[],a=[A({pubkey:Gn,isWritable:!1}),A({pubkey:$a,isWritable:!1}),A({pubkey:Za,isWritable:!1}),A({pubkey:_i.programId,isWritable:!1}),A({pubkey:e,isSigner:!0})],c={[o.data.inputMint]:t,[o.data.outputMint]:n};for(let d=r.length-1;d>=0;d--){let m=o.data.routePlan[d],p=r[d],y=m.inputMint===p.mintA.address;if(a.push(A({pubkey:new R(p.programId)})),d===0)a.push(A({pubkey:c[m.inputMint]}));else{let f=m.inputMint;if(c[f]===void 0){let b=Z(e,new R(f),p.programId===wt.CLMM_PROGRAM_ID.toBase58()||p.programId===wt.CREATE_CPMM_POOL_PROGRAM.toBase58()?new R(y?p.mintA.programId:p.mintB.programId):Gn).publicKey;c[f]=b}a.push(A({pubkey:c[f]}))}if(d===r.length-1)a.push(A({pubkey:c[m.outputMint]}));else{let f=m.outputMint;if(c[f]===void 0){let b=Z(e,new R(f),p.programId===wt.CLMM_PROGRAM_ID.toBase58()||p.programId===wt.CREATE_CPMM_POOL_PROGRAM.toBase58()?new R(y?p.mintB.programId:p.mintA.programId):Gn).publicKey;c[f]=b}a.push(A({pubkey:c[f]}))}if(a.push(A({pubkey:new R(m.inputMint)})),a.push(A({pubkey:new R(m.outputMint)})),p.programId===wt.CLMM_PROGRAM_ID.toBase58()){let f=p;a.push(A({pubkey:new R(f.config.id)})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(y?f.vault.A:f.vault.B)})),a.push(A({pubkey:new R(y?f.vault.B:f.vault.A)})),a.push(A({pubkey:new R(f.observationId)})),a.push(A({pubkey:an,isWritable:!1})),a.push(A({pubkey:new R(f.exBitmapAccount)})),s.push(Ja(m.lastPoolPriceX64,y));for(let b of m.remainingAccounts??[])a.push(A({pubkey:new R(b)}))}else if(p.programId===wt.AMM_STABLE.toBase58()){let f=p;a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.authority),isWritable:!1})),a.push(A({pubkey:new R(f.marketProgramId),isWritable:!1})),a.push(A({pubkey:new R(f.marketAuthority),isWritable:!1})),a.push(A({pubkey:fr,isWritable:!1})),a.push(A({pubkey:new R(f.openOrders)})),a.push(A({pubkey:new R(f.vault.A)})),a.push(A({pubkey:new R(f.vault.B)})),a.push(A({pubkey:new R(f.marketId)})),a.push(A({pubkey:new R(f.marketBids)})),a.push(A({pubkey:new R(f.marketAsks)})),a.push(A({pubkey:new R(f.marketEventQueue)})),a.push(A({pubkey:new R(f.marketBaseVault)})),a.push(A({pubkey:new R(f.marketQuoteVault)}))}else if(p.programId===wt.AMM_V4.toBase58()){let f=p;a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.authority),isWritable:!1})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.vault.A)})),a.push(A({pubkey:new R(f.vault.B)})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.id)}))}else if(p.programId===wt.CREATE_CPMM_POOL_PROGRAM.toBase58()){let f=p;a.push(A({pubkey:new R(f.authority)})),a.push(A({pubkey:new R(f.config.id)})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(y?f.vault.A:f.vault.B)})),a.push(A({pubkey:new R(y?f.vault.B:f.vault.A)})),a.push(A({pubkey:new R(f.observationId)}))}else throw Error("pool type error")}let u=N([F("insId"),P("amountIn"),P("amountOut"),X($(),s.length,"clmmPriceLimit")]),l=Buffer.alloc(u.span);return u.encode({insId:1,amountIn:new ln(o.data.otherAmountThreshold),amountOut:new ln(o.data.outputAmount),clmmPriceLimit:s},l),new Fi({keys:a,programId:i,data:l})}var xn=new es(0),Vi=class extends Ne{constructor(e){super(e)}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals(j));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n,txVersion:o=1,feePayer:r}=e,s=await this.getWSolAccounts(),a=this.createTxBuilder(r);a.addCustomComputeBudget(e.computeBudgetConfig);let c=Y(t);for(let u=0;u<s.length;u++)c.gte(s[u].amount)?(a.addInstruction({instructions:[wn({tokenAccount:s[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),c.sub(s[u].amount)):a.addInstruction({instructions:[wn({tokenAccount:s[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]});return a.versionBuild({txVersion:o})}async wrapWSol(e,t,n,o){let r=this.createTxBuilder(o),s=await _n({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return r.addInstruction(s),r.versionBuild({txVersion:n??1})}async swap({swapInfo:e,swapPoolKeys:t,ownerInfo:n,computeBudgetConfig:o,routeProgram:r,txVersion:s,feePayer:a}){let c=this.createTxBuilder(a),u=e.amountIn,l=e.amountOut,d=u.amount.token.mint.equals(j),m=l.amount.token.mint.equals(j),p=u.amount.token.mint,y=l.amount.token.mint,{account:f,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.amount.token.isToken2022?Jr:Xe,mint:p,notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!d,createInfo:d?{payer:this.scope.ownerPubKey,amount:u.amount.raw}:void 0,associatedOnly:d?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});if(b&&c.addInstruction(b),f===void 0)throw Error("input account check error");let g;if(e.routeType==="route"&&!m)g=this.scope.account.getAssociatedTokenAccount(y,l.amount.token.isToken2022?Jr:Xe);else{let{account:x,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:l.amount.token.isToken2022?Jr:Xe,mint:y,notUseTokenAccount:m,owner:this.scope.ownerPubKey,skipCloseAccount:!0,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:m?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});g=x,T&&c.addInstruction(T)}m&&c.addInstruction({endInstructions:[wn({owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,tokenAccount:g,programId:Xe})],endInstructionTypes:[V.CloseAccount]});let w;if(e.routeType==="route"){let x=e.middleToken;w=this.scope.account.getAssociatedTokenAccount(x.mint,x.isToken2022?Jr:Xe)}let k=t||await this.computePoolToPoolKeys({pools:e.poolInfoList}),h=Gl({routeProgram:r,inputMint:p,swapInfo:{...e,poolInfo:[...e.poolInfoList],poolKey:k,outputMint:y},ownerInfo:{wallet:this.scope.ownerPubKey,sourceToken:f,routeToken:w,destinationToken:g}});if(e.feeConfig!==void 0){let x=this.createTxBuilder();x.addInstruction({instructions:[Xl(f,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[V.TransferAmount]}),x.addInstruction(h);let{transactions:T}=s===0?await x.sizeCheckBuildV0():await x.sizeCheckBuild();T.length<2&&c.addInstruction({instructions:[Xl(f,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[V.TransferAmount]})}return c.addInstruction(h),s===0?c.sizeCheckBuildV0({computeBudgetConfig:o,address:h.address}):c.sizeCheckBuild({computeBudgetConfig:o,address:h.address})}async fetchRoutePoolBasicInfo(e){let{amm:t=Qo,clmm:n=vn,cpmm:o=Ho}=e||{},r=await this.scope.connection.getProgramAccounts(t,{dataSlice:{offset:no.offsetOf("baseMint"),length:64}}),s=N([L("baseMint"),L("quoteMint")]),a=r.map(p=>({id:p.pubkey,version:4,mintA:s.decode(p.account.data).baseMint,mintB:s.decode(p.account.data).quoteMint})),c=N([L("mintA"),L("mintB")]),l=(await this.scope.connection.getProgramAccounts(n,{filters:[{dataSize:eo.span}],dataSlice:{offset:eo.offsetOf("mintA"),length:64}})).map(p=>{let y=c.decode(p.account.data);return{id:p.pubkey,version:6,mintA:y.mintA,mintB:y.mintB}}),m=(await this.scope.connection.getProgramAccounts(o,{dataSlice:{offset:Mi.offsetOf("mintA"),length:64}})).map(p=>{let y=c.decode(p.account.data);return{id:p.pubkey,version:7,mintA:y.mintA,mintB:y.mintB}});return{clmmPools:l,ammPools:a,cpmmPools:m}}getAllRoute({inputMint:e,outputMint:t,clmmPools:n,ammPools:o,cpmmPools:r}){e=e.toString()===co.default.toString()?j:e,t=t.toString()===co.default.toString()?j:t;let s={},a={},c={},u=[],l={};for(let m of n??[]){if((m.mintA.equals(e)&&m.mintB.equals(t)||m.mintA.equals(t)&&m.mintB.equals(e))&&(u.push(m),a[m.id.toString()]=m),m.mintA.equals(e)){let p=m.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[p].in.push(m)}if(m.mintB.equals(e)){let p=m.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[p].in.push(m)}if(m.mintA.equals(t)){let p=m.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[p].out.push(m)}if(m.mintB.equals(t)){let p=m.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[p].out.push(m)}}let d=[];for(let m of o)(m.mintA.equals(e)&&m.mintB.equals(t)||m.mintA.equals(t)&&m.mintB.equals(e))&&(u.push(m),s[m.id.toBase58()]=m,d.push(m)),m.mintA.equals(e)&&(l[m.mintB.toBase58()]===void 0&&(l[m.mintB.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[m.mintB.toBase58()].in.push(m)),m.mintB.equals(e)&&(l[m.mintA.toBase58()]===void 0&&(l[m.mintA.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[m.mintA.toBase58()].in.push(m)),m.mintA.equals(t)&&(l[m.mintB.toBase58()]===void 0&&(l[m.mintB.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[m.mintB.toBase58()].out.push(m)),m.mintB.equals(t)&&(l[m.mintA.toBase58()]===void 0&&(l[m.mintA.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[m.mintA.toBase58()].out.push(m));for(let m of r)(m.mintA.equals(e)&&m.mintB.equals(t)||m.mintA.equals(t)&&m.mintB.equals(e))&&(u.push(m),c[m.id.toBase58()]=m),m.mintA.equals(e)&&(l[m.mintB.toBase58()]===void 0&&(l[m.mintB.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[m.mintB.toBase58()].in.push(m)),m.mintB.equals(e)&&(l[m.mintA.toBase58()]===void 0&&(l[m.mintA.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[m.mintA.toBase58()].in.push(m)),m.mintA.equals(t)&&(l[m.mintB.toBase58()]===void 0&&(l[m.mintB.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[m.mintB.toBase58()].out.push(m)),m.mintB.equals(t)&&(l[m.mintA.toBase58()]===void 0&&(l[m.mintA.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[m.mintA.toBase58()].out.push(m));for(let m of Object.keys(l)){if(l[m].in.length===1&&l[m].out.length===1&&l[m].in[0].id.equals(l[m].out[0].id)){delete l[m];continue}if(l[m].in.length===0||l[m].out.length===0){delete l[m];continue}let p=l[m];for(let y of p.in)for(let f of p.out)y.version===6&&a[y.id.toString()]===void 0?a[y.id.toString()]=y:y.version===7&&c[y.id.toString()]===void 0?c[y.id.toString()]=y:(y.version===4||y.version===5)&&s[y.id.toString()]===void 0&&(s[y.id.toString()]=y),f.version===6&&a[f.id.toString()]===void 0?a[f.id.toString()]=f:f.version===7&&c[f.id.toString()]===void 0?c[f.id.toString()]=f:(f.version===4||f.version===5)&&s[f.id.toString()]===void 0&&(s[f.id.toString()]=f)}return{directPath:u,addLiquidityPools:d,routePathDict:l,needSimulate:Object.values(s),needTickArray:Object.values(a),cpmmPoolList:Object.values(c)}}async fetchSwapRoutesData({routes:e,inputMint:t,outputMint:n}){let o=new Set([...e.needTickArray.map(f=>[f.mintA.toBase58(),f.mintB.toBase58()]).flat(),t.toString(),n.toString()]);console.log("fetching amm pools info, total: ",e.needSimulate.length);let r=await this.scope.liquidity.getRpcPoolInfos(e.needSimulate.map(f=>f.id)),s=Dr(r),a={};Object.values(s).forEach(f=>{o.delete(f.mintA.address),a[f.mintA.address]={address:new co(f.mintA.address),programId:Xe,mintAuthority:null,supply:BigInt(0),decimals:f.mintA.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0},o.delete(f.mintB.address),a[f.mintB.address]={address:new co(f.mintB.address),programId:Xe,mintAuthority:null,supply:BigInt(0),decimals:f.mintB.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}}),console.log("fetching cpmm pools info, total: ",e.cpmmPoolList.length);let c=await this.scope.cpmm.getRpcPoolInfos(e.cpmmPoolList.map(f=>f.id.toBase58()),!0);Object.values(c).forEach(f=>{let[b,g]=[f.mintA.toBase58(),f.mintB.toBase58()];f.mintProgramA.equals(Xe)?(o.delete(b),a[b]={address:f.mintA,programId:f.mintProgramA,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalA,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):o.add(b),f.mintProgramB.equals(Xe)?(o.delete(g),a[g]={address:f.mintB,programId:f.mintProgramB,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalB,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):o.add(g)}),console.log("fetching mints info, total: ",o.size);let u=await po({connection:this.scope.connection,mints:Array.from(o).map(f=>new co(f))});a={...a,...u};let l=this.scope.cpmm.toComputePoolInfos({pools:c,mintInfos:a});console.log("fetching clmm pools info, total:",e.needTickArray.length);let d=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:e.needTickArray.map(f=>f.id)}),{computeClmmPoolInfo:m,computePoolTickData:p}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:d,mintInfos:a}),y=Object.keys(e.routePathDict).reduce((f,b)=>({...f,[b]:{...e.routePathDict[b],mintProgram:a[b].programId,mDecimals:a[b].decimals,in:e.routePathDict[b].in.map(g=>s[g.id.toBase58()]||m[g.id.toBase58()]||l[g.id.toBase58()]),out:e.routePathDict[b].out.map(g=>s[g.id.toBase58()]||m[g.id.toBase58()]||l[g.id.toBase58()])}}),{});return{mintInfos:a,ammPoolsRpcInfo:r,ammSimulateCache:s,clmmPoolsRpcInfo:d,computeClmmPoolInfo:m,computePoolTickData:p,computeCpmmData:l,routePathDict:y}}getAllRouteComputeAmountOut({inputTokenAmount:e,outputToken:t,directPath:n,routePathDict:o,simulateCache:r,tickCache:s,slippage:a,chainTime:c,epochInfo:u,feeConfig:l}){let d=l===void 0?new es(0):e.raw.mul(new es(l.feeBps.toNumber())).div(new es(1e4)),m=e.raw.sub(d),p=new we(e.token,m),y=l===void 0?void 0:{feeAmount:d,feeAccount:l.feeAccount},f={...t,address:ft(t.address).toString()},b=[];for(let g of n)try{b.push({...this.computeAmountOut({itemPool:g,tickCache:s,simulateCache:r,chainTime:c,epochInfo:u,slippage:a,outputToken:f,amountIn:p}),feeConfig:y})}catch(w){this.logDebug("direct error",g.version,g.id.toString(),w.message)}this.logDebug("direct done");for(let[g,w]of Object.entries(o)){let k={chainId:101,address:g,programId:w.mintProgram.toBase58(),logoURI:"",symbol:"",name:"",decimals:w.mDecimals,tags:[],extensions:{}},h=w.in.map(T=>{try{return{pool:T,data:this.computeAmountOut({itemPool:T,tickCache:s,simulateCache:r,chainTime:c,epochInfo:u,slippage:a,outputToken:k,amountIn:p})}}catch(B){this.logDebug("route in error",T.version,T.id.toString(),B.message);return}}).sort((T,B)=>{let S=T===void 0?xn:T.data.amountOut.amount.raw.sub(T.data.amountOut.fee?.raw??xn),I=B===void 0?xn:B.data.amountOut.amount.raw.sub(B.data.amountOut.fee?.raw??xn);return S.lt(I)?1:-1})[0];if(h===void 0)continue;let x=new we(_r(k),h.data.amountOut.amount.raw.sub(h.data.amountOut.fee?.raw??xn));for(let T of w.out)try{let B=this.computeAmountOut({itemPool:T,tickCache:s,simulateCache:r,chainTime:c,epochInfo:u,slippage:a,outputToken:f,amountIn:x});b.push({...B,allTrade:!!(h.data.allTrade&&B.allTrade),amountIn:h.data.amountIn,amountOut:B.amountOut,minAmountOut:B.minAmountOut,currentPrice:void 0,executionPrice:new C(new st({baseToken:h.data.amountIn.amount.token,denominator:h.data.amountIn.amount.raw,quoteToken:B.amountOut.amount.token,numerator:B.amountOut.amount.raw.sub(B.amountOut.fee?.raw??xn)}).toFixed()),priceImpact:new C(h.data.priceImpact.add(B.priceImpact).toFixed()),fee:[h.data.fee[0],B.fee[0]],routeType:"route",poolInfoList:[h.pool,T],remainingAccounts:[h.data.remainingAccounts[0],B.remainingAccounts[0]],minMiddleAmountFee:B.amountOut.fee?.raw?new we(h.data.amountOut.amount.token,(h.data.amountOut.fee?.raw??xn).add(B.amountOut.fee?.raw??xn)):void 0,middleToken:h.data.amountOut.amount.token,poolReady:h.data.poolReady&&B.poolReady,poolType:[h.data.poolType,B.poolType],feeConfig:y,expirationTime:jt(h.data.expirationTime,B.expirationTime)})}catch(B){this.logDebug("route out error",T.version,T.id.toString(),B.message)}}return b.filter(g=>(g.allTrade||this.logDebug(`pool ${g.poolInfoList.map(w=>w.id.toString()).join(",")} filter out since not all trade`),g.allTrade)).sort((g,w)=>g.amountOut.amount.raw.sub(w.amountOut.amount.raw).gt(xn)?-1:1)}computeAmountOut({itemPool:e,tickCache:t,simulateCache:n,chainTime:o,epochInfo:r,slippage:s,outputToken:a,amountIn:c}){if(e.version===6){let{allTrade:u,realAmountIn:l,amountOut:d,minAmountOut:m,expirationTime:p,currentPrice:y,executionPrice:f,priceImpact:b,fee:g,remainingAccounts:w,executionPriceX64:k}=Le.computeAmountOutFormat({poolInfo:e,tickArrayCache:t[e.id.toString()],amountIn:c.raw,tokenOut:a,slippage:s,epochInfo:r,catchLiquidityInsufficient:!0});return{allTrade:u,amountIn:l,amountOut:d,minAmountOut:m,currentPrice:new C(y.toFixed()),executionPrice:new C(f.toFixed()),priceImpact:new C(b.toFixed()),fee:[g],remainingAccounts:[w],routeType:"amm",poolInfoList:[e],poolReady:e.startTime<o,poolType:"CLMM",slippage:s,clmmExPriceX64:[k],expirationTime:jt(l.expirationTime,p)}}else if(e.version===7){let{allTrade:u,executionPrice:l,amountOut:d,minAmountOut:m,priceImpact:p,fee:y}=this.scope.cpmm.computeSwapAmount({pool:e,outputMint:a.address,amountIn:c.raw,slippage:s});return{allTrade:u,amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:Ii({...a,amount:d}),fee:void 0,expirationTime:void 0},minAmountOut:{amount:Ii({...a,amount:m}),fee:void 0,expirationTime:void 0},currentPrice:e.poolPrice,executionPrice:l,priceImpact:p,fee:[new we(c.token,y)],remainingAccounts:[],routeType:"amm",poolInfoList:[e],poolReady:e.openTime.toNumber()<o,poolType:"CPMM",slippage:s,clmmExPriceX64:[void 0],expirationTime:void 0}}else{if(![1,6,7].includes(n[e.id.toString()].status))throw Error("swap error");let{amountOut:u,minAmountOut:l,currentPrice:d,executionPrice:m,priceImpact:p,fee:y}=this.scope.liquidity.computeAmountOut({poolInfo:n[e.id.toString()],amountIn:c.raw,mintIn:c.token.mint,mintOut:a.address,slippage:s});return{amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:Ii({...a,amount:u}),fee:void 0,expirationTime:void 0},minAmountOut:{amount:Ii({...a,amount:l}),fee:void 0,expirationTime:void 0},currentPrice:d,executionPrice:m,priceImpact:p,fee:[new we(c.token,y)],routeType:"amm",poolInfoList:[e],remainingAccounts:[],poolReady:Number(n[e.id].openTime)<o,poolType:e.version===5?"STABLE":void 0,expirationTime:void 0,allTrade:!0,slippage:s,clmmExPriceX64:[void 0]}}}async computePoolToPoolKeys({pools:e,clmmRpcData:t={},ammRpcData:n={}}){let o=new Set(e.filter(u=>u.version===6&&!t[u.id.toString()]).map(u=>u.id.toString()));if(o.size>0){let u=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:Array.from(o)});Object.keys(u).forEach(l=>{t[l]=u[l]})}let r=new Set(e.filter(u=>u.version===4&&!n[u.id.toString()]).map(u=>u.id.toString()));if(r.size>0){let u=await this.scope.liquidity.getRpcPoolInfos(Array.from(r));Object.keys(u).forEach(l=>{n[l]=u[l]})}let s=new Set(e.filter(u=>u.version===4).map(u=>u.marketId)),a={};s.size>0&&(await Ke(this.scope.connection,Array.from(s).map(l=>({pubkey:new co(l)})))).forEach(l=>{if(!l.accountInfo)return;let d=Ya.decode(l.accountInfo.data);a[l.pubkey.toBase58()]={marketId:l.pubkey.toString(),marketProgramId:l.accountInfo.owner.toString(),marketAuthority:$r.getAssociatedAuthority({programId:l.accountInfo.owner,marketId:l.pubkey}).publicKey.toString(),marketBaseVault:d.baseVault.toString(),marketQuoteVault:d.quoteVault.toString(),marketBids:d.bids.toString(),marketAsks:d.asks.toString(),marketEventQueue:d.eventQueue.toString()}});let c=[];return e.forEach(u=>{if(u.version===6){let l=t[u.id.toString()],d={programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.startTime),vault:{A:l.vaultA.toBase58(),B:l.vaultB.toBase58()},config:{...u.ammConfig,id:u.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]},rewardInfos:[],observationId:u.observationId.toBase58(),exBitmapAccount:u.exBitmapAccount.toBase58()};c.push(d)}else if(u.version===4){let l=n[u.id.toString()],d={programId:u.programId,id:u.id,mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),vault:{A:l.baseVault.toBase58(),B:l.quoteVault.toBase58()},authority:qa({programId:new co(u.programId)}).publicKey.toString(),openOrders:l.openOrders.toBase58(),targetOrders:l.targetOrders.toBase58(),mintLp:u.lpMint,...a[u.marketId]};c.push(d)}else u.version===7&&c.push({observationId:u.observationId.toBase58(),programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),authority:No(u.programId).publicKey.toBase58(),vault:{A:u.vaultA.toBase58(),B:u.vaultB.toBase58()},mintLp:At({address:u.mintLp.toBase58(),programId:Xe.toBase58(),decimals:u.lpDecimals}),config:{id:u.configId.toBase58(),...u.configInfo,protocolFeeRate:u.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:u.configInfo.tradeFeeRate.toNumber(),fundFeeRate:u.configInfo.fundFeeRate.toNumber(),createPoolFee:u.configInfo.createPoolFee.toString()}})}),c}};import{PublicKey as Qy,Transaction as eu,TransactionInstruction as zy}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Hy}from"@solana/spl-token";import Ql from"bn.js";var Pt=class extends Ne{static getPdaPoolId(e,t){return ee([Pt.SEED_CONFIG.pool.id,t.toBuffer()],e)}static getPdaOwnerId(e,t,n,o){return ee([Pt.SEED_CONFIG.owner.id,t.toBuffer(),n.toBuffer(),Buffer.from(new Ql(o).toArray())],e)}static async getAllInfo({connection:e,programId:t,poolIds:n,wallet:o,chainTime:r}){if(n.length===0)return[];let s=n.map(l=>Pt.getPdaPoolId(t,l).publicKey),a=[];for(let l=0;l<Pt.VERSION_PROJECT.length;l++)a.push(...s.map(d=>Pt.getPdaOwnerId(t,d,o,l).publicKey));let c=await qt(e,[...s,...a]),u=[];for(let l=0;l<c.length;l++){let d=Math.floor(l/n.length),m=l%n.length,p=s[m],y=a[l],f=c[m],b=c[n.length+l];if(!(f&&b)||f.data.length!==Pt.POOL_LAYOUT.span||b.data.length!==Pt.OWNER_LAYOUT.span)continue;let g=Pt.POOL_LAYOUT.decode(f.data),w=Pt.OWNER_LAYOUT.decode(b.data),k=g.openTime.toNumber(),h=g.endTime.toNumber(),x=w.tokenInfo.map(S=>S.debtAmount.gt(new Ql(0))).filter(S=>!S).length!==3,T=r>k&&r<h&&g.status===1,B=x&&T;u.push({programId:t,poolId:p,ammId:g.ammId,ownerAccountId:y,snapshotLpAmount:w.lpAmount,project:Pt.VERSION_PROJECT[d],openTime:k,endTime:h,canClaim:B,canClaimErrorType:x?T?void 0:"outOfOperationalTime":"alreadyClaimIt",tokenInfo:g.tokenInfo.map((S,I)=>({mintAddress:S.mintAddress,mintVault:S.mintVault,mintDecimals:S.mintDecimals,perLpLoss:S.perLpLoss,debtAmount:w.tokenInfo[I].debtAmount.add(w.tokenInfo[I].claimedAmount)}))})}return u}async makeClaimTransaction({poolInfo:e,ownerInfo:t,feePayer:n}){t.wallet||this.scope.checkOwner();let o=this.createTxBuilder(n),r=t.wallet||this.scope.ownerPubKey,s=[];for(let u of e.tokenInfo){let{account:l,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({mint:u.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:u.mintAddress.equals(Te.WSOL.mint),createInfo:{payer:r,amount:0},skipCloseAccount:!u.mintAddress.equals(Te.WSOL.mint),associatedOnly:u.mintAddress.equals(Te.WSOL.mint)?!1:t.associatedOnly});d&&o.addInstruction(d),s.push(l)}o.addInstruction({instructions:[Pt.makeClaimInstruction({programId:e.programId,poolInfo:e,ownerInfo:{wallet:r,ownerPda:e.ownerAccountId,claimAddress:s}})]});let{transaction:a,signers:c}=o.build();return[{transaction:a,signer:c}]}async makeClaimAllTransaction({poolInfos:e,ownerInfo:t,feePayer:n}){let o=this.createTxBuilder(n),r=t.wallet||this.scope.ownerPubKey,s={};for(let l of e){let d=[];for(let m of l.tokenInfo){let{account:p,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({mint:m.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:m.mintAddress.equals(Te.WSOL.mint),createInfo:{payer:r,amount:0},skipCloseAccount:!m.mintAddress.equals(Te.WSOL.mint),associatedOnly:m.mintAddress.equals(Te.WSOL.mint)?!1:t.associatedOnly});y&&o.addInstruction(y),p&&(s[m.mintAddress.toString()]=p,d.push(p))}o.addInstruction({instructions:[Pt.makeClaimInstruction({programId:l.programId,poolInfo:l,ownerInfo:{wallet:r,ownerPda:l.ownerAccountId,claimAddress:d}})]})}let{transaction:a,signers:c}=o.build(),u=o.allInstructions;return dr(u,[r,...c.map(l=>l.publicKey)])?[{transaction:a,signer:c}]:[{transaction:new eu().add(...u.slice(0,o.AllTxData.instructions.length-1)),signer:c},{transaction:new eu().add(...u.slice(o.AllTxData.instructions.length-1)),signer:[]},{transaction:new eu().add(...o.AllTxData.endInstructions),signer:[]}]}static makeClaimInstruction({programId:e,poolInfo:t,ownerInfo:n}){let o=N([]),r=[{pubkey:n.wallet,isSigner:!0,isWritable:!0},{pubkey:t.poolId,isSigner:!1,isWritable:!0},{pubkey:n.ownerPda,isSigner:!1,isWritable:!0},...n.claimAddress.map(c=>({pubkey:c,isSigner:!1,isWritable:!0})),...t.tokenInfo.map(({mintVault:c})=>({pubkey:c,isSigner:!1,isWritable:!0})),{pubkey:Hy,isSigner:!1,isWritable:!1}],s=Buffer.alloc(o.span);o.encode({},s);let a=Buffer.from([10,66,208,184,161,6,191,98,...s]);return new zy({keys:r,programId:e,data:a})}},Dt=Pt;Nt(Dt,"CLAIMED_NUM",3),Nt(Dt,"POOL_LAYOUT",N([he(8),F("bump"),F("status"),P("openTime"),P("endTime"),L("ammId"),X(N([F("mintDecimals"),L("mintAddress"),L("mintVault"),P("perLpLoss"),P("totalClaimedAmount")]),Pt.CLAIMED_NUM,"tokenInfo"),X(P(),10,"padding")])),Nt(Dt,"OWNER_LAYOUT",N([he(8),F("bump"),F("version"),L("poolId"),L("owner"),P("lpAmount"),X(N([L("mintAddress"),P("debtAmount"),P("claimedAmount")]),Pt.CLAIMED_NUM,"tokenInfo"),X(P(),4,"padding")])),Nt(Dt,"DEFAULT_POOL_ID",["58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2","6UmmUiYoBjSrhakAobJw8BvkmJtDVxaeBtbt7rxWo1mg","AVs9TA4nWDzfPJE9gGVNJMVhcQy3V9PGazuz33BfG2RA","DVa7Qmb5ct9RCpaU7UTpSaf3GVMYz17vNVU67XpdCRut","7XawhbbxtsRcQA8KTkHT9f9nc6d69UwqCDh6U5EEbEmX","6a1CsrpeZubDjEJE9s1CMVheB6HWM5d7m1cj2jkhyXhj","EoNrn8iUhwgJySD1pHu8Qxm5gSQqLK3za4m8xzD2RuEb","AceAyRTWt4PyB2pHqf2qhDgNZDtKVNaxgL8Ru3V4aN1P","6tmFJbMk5yVHFcFy7X2K8RwHjKLr6KVFLYXpgpBNeAxB"].map(e=>new Qy(e))),Nt(Dt,"SEED_CONFIG",{pool:{id:Buffer.from("pool_seed","utf8")},owner:{id:Buffer.from("user_claim_seed","utf8")}}),Nt(Dt,"VERSION_PROJECT",[void 0,"Francium","Tulip","Larix"]);import{PublicKey as Di}from"@solana/web3.js";import zl from"bn.js";import{SYSVAR_CLOCK_PUBKEY as jy,TransactionInstruction as nu}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ou}from"@solana/spl-token";var tu=N([F("instruction"),dc("amount")]),Wi=N([F("instruction")]);function q0({programId:i,amount:e,instructionKeys:t}){let n=[{pubkey:sr,isSigner:!1,isWritable:!1},{pubkey:ou,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:Ks,isSigner:!1,isWritable:!1},...Object.entries(t).map(([r,s])=>({pubkey:s,isSigner:r==="userOwner",isWritable:!["authority","userOwner","userIdoCheck","userStakeInfo"].includes(r)}))],o=Buffer.alloc(tu.span);return tu.encode({instruction:1,amount:Number(e)},o),new nu({keys:n,programId:i,data:o})}function ts({programId:i},e){let t=[{pubkey:ou,isSigner:!1,isWritable:!1},{pubkey:Ks,isSigner:!1,isWritable:!1},...Object.entries(e).map(([o,r])=>({pubkey:r,isSigner:o==="userOwner",isWritable:!["authority","userOwner"].includes(o)}))],n=Buffer.alloc(Wi.span);return Wi.encode({instruction:2},n),new nu({keys:t,programId:i,data:n})}function iu(i){let{poolConfig:e,userKeys:t,side:n}=i,o=n==="base"?t.baseTokenAccount:t.quoteTokenAccount,r=n==="base"?e.baseVault:e.quoteVault,s=Buffer.alloc(Wi.span);Wi.encode({instruction:2},s);let a=[{pubkey:ou,isWritable:!1,isSigner:!1},{pubkey:jy,isWritable:!1,isSigner:!1},{pubkey:e.id,isWritable:!0,isSigner:!1},{pubkey:e.authority,isWritable:!1,isSigner:!1},{pubkey:r,isWritable:!0,isSigner:!1},{pubkey:o,isWritable:!0,isSigner:!1},{pubkey:t.ledgerAccount,isWritable:!0,isSigner:!1},{pubkey:t.owner,isWritable:!1,isSigner:!0}];return new nu({programId:e.programId,keys:a,data:s})}var Yy={[Zo.IDO_PROGRAM_ID_V1.toString()]:1,[Zo.IDO_PROGRAM_ID_V2.toString()]:2,[Zo.IDO_PROGRAM_ID_V3.toString()]:3,[Zo.IDO_PROGRAM_ID_V4.toString()]:4},vo=class extends Ne{async claim({ownerInfo:e,idoKeys:t,associatedOnly:n=!0,checkCreateATAOwner:o=!1,txVersion:r,feePayer:s}){let a=this.createTxBuilder(s),c=Yy[t.programId];c||this.logAndCreateError("invalid version",c);let u=Re(t),[l,d]=[!new zl(e.coin).isZero(),!new zl(e.pc).isZero()],m=u.projectInfo.mint.address.equals(j),{account:p,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.projectInfo.mint.programId,mint:u.projectInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!m,notUseTokenAccount:m,associatedOnly:m?!1:n,checkCreateATAOwner:o});!p&&l&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),l&&y&&a.addInstruction(y);let f=u.buyInfo.mint.address.equals(j),{account:b,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.buyInfo.mint.programId,mint:u.buyInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!f,notUseTokenAccount:f,associatedOnly:f?!1:n,checkCreateATAOwner:o});if(!p&&d&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),d&&g&&a.addInstruction(g),(!p||!b)&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address,t.buyInfo.mint.address),c===3)return a.addInstruction({instructions:[...l?[ts({programId:u.programId},{idoId:u.id,authority:u.authority,poolTokenAccount:u.projectInfo.vault,userTokenAccount:p,userIdoInfo:new Di(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[],...d?[ts({programId:new Di(t.programId)},{idoId:u.id,authority:u.authority,poolTokenAccount:u.buyInfo.vault,userTokenAccount:b,userIdoInfo:new Di(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[]]}).versionBuild({txVersion:r});if(c<3)return!l&&!d&&this.logAndCreateError("no claimable rewards"),a.addInstruction({instructions:[ts({programId:u.programId},{idoId:u.id,authority:u.authority,poolQuoteTokenAccount:u.buyInfo.vault,poolBaseTokenAccount:u.projectInfo.vault,userQuoteTokenAccount:b,userBaseTokenAccount:p,userIdoInfo:new Di(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]}).versionBuild({txVersion:r});let w={poolConfig:{id:u.id,programId:u.programId,authority:u.authority,baseVault:u.projectInfo.vault,quoteVault:u.buyInfo.vault,baseToken:t.projectInfo.mint,quoteToken:t.buyInfo.mint},userKeys:{baseTokenAccount:p,quoteTokenAccount:b,ledgerAccount:new Di(e.userIdoInfo),owner:this.scope.ownerPubKey}};return a.addInstruction({instructions:[...l?[iu({...w,side:"base"})]:[],...d?[iu({...w,side:"quote"})]:[]]}).versionBuild({txVersion:r})}};var Zy=Buffer.from("vault_auth_seed","utf8"),$y=Buffer.from("global_config","utf8"),Jy=Buffer.from("pool","utf8"),eb=Buffer.from("pool_vault","utf8"),tb=Buffer.from("pool_vesting","utf8"),nb=Buffer.from("platform_config","utf8");function lo(i){return ee([Zy],i)}function a1(i,e,t,n){return ee([$y,e.toBuffer(),ob(t),vr(n)],i)}function ns(i,e,t){return ee([Jy,e.toBuffer(),t.toBuffer()],i)}function ru(i,e,t){return ee([eb,e.toBuffer(),t.toBuffer()],i)}function ob(i){let e=new ArrayBuffer(1);return new DataView(e).setUint8(0,i),new Uint8Array(e)}function Mo(i){return ee([Buffer.from("__event_authority","utf8")],i)}function su(i,e){return ee([nb,e.toBuffer()],i)}function au(i,e,t){return ee([tb,e.toBuffer(),t.toBuffer()],i)}import{SystemProgram as qi,TransactionInstruction as mn}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Hl}from"@solana/spl-token";import os from"bn.js";var dn={initialize:Buffer.from([175,175,109,31,13,152,155,237]),buyExactIn:Buffer.from([250,234,13,123,213,156,19,236]),buyExactOut:Buffer.from([24,211,116,40,105,3,153,56]),sellExactIn:Buffer.from([149,39,222,155,211,124,152,26]),sellExactOut:Buffer.from([95,200,71,34,8,9,11,166]),createVestingAccount:Buffer.from([129,178,2,13,217,172,230,218]),claimVestedToken:Buffer.from([49,33,104,30,189,157,79,35]),createPlatformConfig:Buffer.from([176,90,196,175,253,113,220,20]),claimPlatformFee:Buffer.from([156,39,208,135,76,237,61,72]),updatePlaformConfig:Buffer.from([195,60,76,129,146,45,67,143])};function jl(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x){let T=N([F("decimals"),Jt("name"),Jt("symbol"),Jt("uri")]),B=N([P("totalLockedAmount"),P("cliffPeriod"),P("unlockPeriod")]),S=N([F("index"),P("supply"),P("totalFundRaisingB"),F("migrateType")]),I=N([F("index"),P("supply"),P("totalSellA"),P("totalFundRaisingB"),F("migrateType")]),K=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Xt,isSigner:!1,isWritable:!1},{pubkey:qi.programId,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:Mo(i).publicKey,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1}],O=Buffer.alloc(Buffer.from(f,"utf-8").length+Buffer.from(b,"utf-8").length+Buffer.from(g,"utf-8").length+4*3+1),v=Buffer.alloc(B.span),_=Buffer.alloc(w.type==="ConstantCurve"?I.span:S.span);return T.encode({decimals:y,name:f,symbol:b,uri:g},O),w.type==="ConstantCurve"?I.encode({index:0,...w,migrateType:w.migrateType==="amm"?0:1},_):w.type==="FixedCurve"?S.encode({index:1,...w,migrateType:w.migrateType==="amm"?0:1},_):w.type==="LinearCurve"&&S.encode({index:2,...w,migrateType:w.migrateType==="amm"?0:1},_),B.encode({totalLockedAmount:k,cliffPeriod:h,unlockPeriod:x},v),new mn({keys:K,programId:i,data:Buffer.from([...dn.initialize,...O,..._,...v])})}function Yl(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g){let w=N([P("amountB"),P("minAmountA"),P("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Mo(i).publicKey,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0}),console.log({amountB:y.toString(),minAmountA:f.toString()});let h=Buffer.alloc(w.span);return w.encode({amountB:y,minAmountA:f,shareFeeRate:b??new os(0)},h),new mn({keys:k,programId:i,data:Buffer.from([...dn.buyExactIn,...h])})}function g1(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g){let w=N([P("amountA"),P("maxAmountB"),P("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Mo(i).publicKey,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let h=Buffer.alloc(w.span);return w.encode({amountA:y,maxAmountB:f,shareFeeRate:b??new os(0)},h),new mn({keys:k,programId:i,data:Buffer.from([...dn.buyExactOut,...h])})}function Zl(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g){let w=N([P("amountA"),P("minAmountB"),P("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Mo(i).publicKey,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let h=Buffer.alloc(w.span);return w.encode({amountA:y,minAmountB:f,shareFeeRate:b??new os(0)},h),new mn({keys:k,programId:i,data:Buffer.from([...dn.sellExactIn,...h])})}function A1(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g){let w=N([P("amountB"),P("maxAmountA"),P("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Mo(i).publicKey,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let h=Buffer.alloc(w.span);return w.encode({amountB:y,maxAmountA:f,shareFeeRate:b??new os(0)},h),new mn({keys:k,programId:i,data:Buffer.from([...dn.sellExactOut,...h])})}function $l(i,e,t,n,o,r,s,a,c){let u=N([]),l=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:qi.programId,isSigner:!1,isWritable:!1},{pubkey:Hl,isSigner:!1,isWritable:!1}],d=Buffer.alloc(u.span);return u.encode({},d),new mn({keys:l,programId:i,data:Buffer.from([...dn.claimVestedToken,...d])})}function Jl(i,e,t,n,o,r){let s=N([P("shareAmount")]),a=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:qi.programId,isSigner:!1,isWritable:!1}],c=Buffer.alloc(s.span);return s.encode({shareAmount:r},c),new mn({keys:a,programId:i,data:Buffer.from([...dn.createVestingAccount,...c])})}function uu(i,e,t,n,o,r,s,a,c){let u=[{pubkey:e,isSigner:!0,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:qi.programId,isSigner:!1,isWritable:!0},{pubkey:Hl,isSigner:!1,isWritable:!0}];return new mn({keys:u,programId:i,data:dn.claimPlatformFee})}function em(i,e,t,n,o,r,s,a,c,u,l){let d=N([P("platformScale"),P("creatorScale"),P("burnScale"),P("feeRate"),Jt("name"),Jt("web"),Jt("img")]),m=[{pubkey:e,isSigner:!0,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:qi.programId,isSigner:!1,isWritable:!1}],p=Buffer.alloc(8*4+Buffer.from(c,"utf-8").length+Buffer.from(u,"utf-8").length+Buffer.from(l,"utf-8").length+4*3);return d.encode({platformScale:s.platformScale,creatorScale:s.creatorScale,burnScale:s.burnScale,feeRate:a,name:c,web:u,img:l},p),new mn({keys:m,programId:i,data:Buffer.from([...dn.createPlatformConfig,...p])})}function tm(i,e,t,n){let o=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0}],r;if(n.type==="updateClaimFeeWallet"){let s=N([F("index"),L("value")]);r=Buffer.alloc(s.span),s.encode({index:0,value:n.value},r)}else if(n.type==="updateLockNftWallet"){let s=N([F("index"),L("value")]);r=Buffer.alloc(s.span),s.encode({index:1,value:n.value},r)}else if(n.type==="migrateCpLockNftScale"){let s=N([F("index"),P("platformScale"),P("creatorScale"),P("burnScale")]);r=Buffer.alloc(s.span),s.encode({index:2,...n.value},r)}else if(n.type==="updateFeeRate"){let s=N([F("index"),P("value")]);r=Buffer.alloc(s.span),s.encode({index:3,value:n.value},r)}else if(n.type==="updateImg"||n.type==="updateName"||n.type==="updateWeb"){let s=N([F("index"),Jt("value")]);r=Buffer.alloc(Buffer.from(n.value,"utf-8").length+4+1*1),n.type==="updateName"?s.encode({index:4,value:n.value},r):n.type==="updateWeb"?s.encode({index:5,value:n.value},r):n.type==="updateImg"&&s.encode({index:6,value:n.value},r)}else if(n.type==="updateCpConfigId"){o.push({pubkey:n.value,isSigner:!1,isWritable:!1});let s=N([F("index")]);r=Buffer.alloc(s.span),s.encode({index:7},r)}else if(n.type==="updateAll"){console.log("Please note that this update will overwrite all data in the platform account with the new data."),o.push({pubkey:n.value.cpConfigId,isSigner:!1,isWritable:!1});let s=N([F("index"),L("platformClaimFeeWallet"),L("platformLockNftWallet"),P("platformScale"),P("creatorScale"),P("burnScale"),P("feeRate"),Jt("name"),Jt("web"),Jt("img")]);r=Buffer.alloc(1+32+32+8*4+4*3+Buffer.from(n.value.name,"utf-8").length+Buffer.from(n.value.web,"utf-8").length+Buffer.from(n.value.img,"utf-8").length),s.encode({index:8,platformClaimFeeWallet:n.value.platformClaimFeeWallet,platformLockNftWallet:n.value.platformLockNftWallet,platformScale:n.value.migrateCpLockNftScale.platformScale,creatorScale:n.value.migrateCpLockNftScale.creatorScale,burnScale:n.value.migrateCpLockNftScale.burnScale,feeRate:n.value.feeRate,name:n.value.name,web:n.value.web,img:n.value.img},r)}else throw Error("updateInfo params type error");return new mn({keys:o,programId:i,data:Buffer.from([...dn.updatePlaformConfig,...r])})}import{NATIVE_MINT as us,TOKEN_PROGRAM_ID as Lt,createAssociatedTokenAccountIdempotentInstruction as Xi}from"@solana/spl-token";import fe from"bn.js";import{PublicKey as om}from"@solana/web3.js";var Eo=N([P(),P("epoch"),F("curveType"),$t("index"),P("migrateFee"),P("tradeFeeRate"),P("maxShareFeeRate"),P("minSupplyA"),P("maxLockRate"),P("minSellRateA"),P("minMigrateRateA"),P("minFundRaisingB"),L("mintB"),L("protocolFeeOwner"),L("migrateFeeOwner"),L("migrateToAmmWallet"),L("migrateToCpmmWallet"),X(P(),16)]),ib=N([P("totalLockedAmount"),P("cliffPeriod"),P("unlockPeriod"),P("startTime"),P("totalAllocatedShare")]),Sn=N([P(),P("epoch"),F("bump"),F("status"),F("mintDecimalsA"),F("mintDecimalsB"),F("migrateType"),P("supply"),P("totalSellA"),P("virtualA"),P("virtualB"),P("realA"),P("realB"),P("totalFundRaisingB"),P("protocolFee"),P("platformFee"),P("migrateFee"),ib.replicate("vestingSchedule"),L("configId"),L("platformId"),L("mintA"),L("mintB"),L("vaultA"),L("vaultB"),L("creator"),X(P(),8)]),k1=N([P(),P("epoch"),L("poolId"),L("beneficiary"),P("claimedAmount"),P("tokenShareAmount"),X(P(),8)]),is=N([P(),P("epoch"),L("platformClaimFeeWallet"),L("platformLockNftWallet"),P("platformScale"),P("creatorScale"),P("burnScale"),P("feeRate"),X(F(),64,"name"),X(F(),256,"web"),X(F(),256,"img"),L("cpConfigId"),X(F(),224)]);import pn from"bn.js";import Ui from"bn.js";var Xn=class{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){throw Error()}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:r,decimalA:s,decimalB:a}){throw Error()}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:r}){throw Error()}static buyExactIn({poolInfo:e,amount:t}){throw Error()}static buyExactOut({poolInfo:e,amount:t}){throw Error()}static sellExactIn({poolInfo:e,amount:t}){throw Error()}static sellExactOut({poolInfo:e,amount:t}){throw Error()}};var rs=class extends Xn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){return new C(t.toString()).div(e.toString()).mul(10**(n-o))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualB.add(e.realB).toString()).div(e.virtualA.sub(e.realA).toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:r,decimalA:s,decimalB:a}){return new C(o.sub(r).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let o=e.totalSellA.sub(e.realA),r=e.totalFundRaisingB.sub(e.realB);return new C(e.virtualB.add(e.realB.add(r)).toString()).div(e.virtualA.sub(e.realA.add(o)).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:r}){if(e.lte(n))throw Error("supply need gt total sell");let s=e.sub(n).sub(o);if(s.lte(new Ui(0)))throw Error("supplyMinusSellLocked <= 0");let a=t.sub(r);if(a.lte(new Ui(0)))throw Error("tfMinusMf <= 0");let c=a.mul(n).mul(n).div(s),u=a.mul(n).div(s).sub(t);if(u.lt(new Ui(0)))throw Error("supply/totalSell/totalLockedAmount diff too high");let l=c.div(u),d=t.mul(t).div(u);if(l.lt(new Ui(0))||d.lt(new Ui(0)))throw Error("invalid input 0");return{a:l,b:d,c:n}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static getAmountOut({amountIn:e,inputReserve:t,outputReserve:n}){let o=e.mul(n),r=t.add(e);return o.div(r)}static getAmountIn({amountOut:e,inputReserve:t,outputReserve:n}){let o=t.mul(e),r=n.sub(e);return yr(o,r)}};import nm from"bn.js";var ss=class extends Xn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){return new C(t.toString()).div(e.toString()).mul(10**(n-o))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:r,decimalA:s,decimalB:a}){return new C(o.sub(r).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let o=e.totalSellA.sub(e.realA),r=e.totalFundRaisingB.sub(e.realB);return new C(e.virtualB.add(e.realB).add(r).toString()).div(e.virtualA.sub(e.realA).add(o).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:r}){let s=e.sub(o);if(s.lte(new nm(0)))throw Error("invalid input 1");let a=new nm(2).mul(t).sub(r),u=t.mul(s).div(a);return{a:u,b:t,c:u}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualB,initOutput:e.virtualA})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualB,initOutput:e.virtualA})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualA,initOutput:e.virtualB})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualA,initOutput:e.virtualB})}static getAmountOut({amountIn:e,initInput:t,initOutput:n}){return n.mul(e).div(t)}static getAmountIn({amountOut:e,initInput:t,initOutput:n}){let o=t.mul(e);return yr(o,n)}};import Ct from"bn.js";import _o from"bn.js";var Gi=class{static _multipler(e){return new C(10).pow(e)}static getPrice({priceX64:e,decimalA:t,decimalB:n}){return new C(e.toString()).div(this._Q64).mul(this._multipler(t)).div(this._multipler(n))}static getPriceX64({price:e,decimalA:t,decimalB:n}){let o=e.mul(this._multipler(n)).div(this._multipler(t));return new _o(o.mul(this._Q64).toFixed(0))}};Nt(Gi,"_Q64",new C(new _o(1).shln(64).toString()));function V1({supply:i,totalFundRaisingB:e,totalLockedAmount:t,totalSellA:n,migrateType:o,decimalsA:r}){let s=i.sub(n).sub(t),a=new _o(new C(s.mul(e).toString()).sqrt().toFixed(0));if(o==="amm"){if(a.gt(new _o(10).pow(new _o(r))))return!0}else if(o==="cpmm"){if(a.gt(new _o(100)))return!0}else throw Error("migrate type error");return!1}var as=class extends Xn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new C(0)}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){return new C(0)}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualA.mul(e.realA).toString()).div(Gi._Q64).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:r,decimalA:s,decimalB:a}){return new C(o.sub(r).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let o=e.totalSellA.sub(e.realA),r=e.totalFundRaisingB.sub(e.realB);return new C(e.virtualB.add(e.realB).add(r).toString()).div(e.virtualA.sub(e.realA).add(o).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:r}){let s=e.sub(o);if(s.lte(new Ct(0)))throw Error("supplyMinusLocked need gt 0");let a=t.mul(new Ct(3)).sub(r),u=t.mul(new Ct(2)).mul(s).div(a),l=u.mul(u),d=t.mul(new Ct(2)).mul(Ye).div(l);if(!d.gt(new Ct(0)))throw Error("a need gt 0");if(!fi.gt(d))throw Error("a need lt u64 max");return{a:d,b:new Ct(0),c:u}}static buyExactIn({poolInfo:e,amount:t}){let n=e.realB.add(t),o=new Ct(2).mul(n).mul(Ye).div(e.virtualA);return new Ct(new C(o.toString()).sqrt().toFixed(0)).sub(e.realA)}static buyExactOut({poolInfo:e,amount:t}){let n=e.realA.add(t),o=n.mul(n),{div:r,mod:s}=e.virtualA.mul(o).divmod(new Ct(2).mul(Ye));return(s.isZero()?r:r.add(new Ct(1))).sub(e.realB)}static sellExactIn({poolInfo:e,amount:t}){let n=e.realA.sub(t),o=n.mul(n),{div:r,mod:s}=e.virtualA.mul(o).divmod(new Ct(2).mul(Ye)),a=s.isZero()?r:r.add(new Ct(1));return e.realB.sub(a)}static sellExactOut({poolInfo:e,amount:t}){let n=e.realB.sub(t),o=new Ct(2).mul(n).mul(Ye).div(e.virtualA),r=new Ct(new C(o.toString()).sqrt().toFixed(0));return e.realA.sub(r)}};var fn=class{static getPoolCurvePointByPoolInfo({curveType:e,pointCount:t,poolInfo:n}){return this.getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n.supply,totalFundRaising:n.totalFundRaisingB,totalSell:n.totalSellA,totalLockedAmount:n.vestingSchedule.totalLockedAmount,migrateFee:n.migrateFee,decimalA:n.mintDecimalsA,decimalB:n.mintDecimalsB})}static getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n,totalFundRaising:o,totalSell:r,totalLockedAmount:s,migrateFee:a,decimalA:c,decimalB:u}){if(t<3)throw Error("point count < 3");let l=this.getCurve(e),d=l.getInitParam({supply:n,totalFundRaising:o,totalSell:r,totalLockedAmount:s,migrateFee:a}),m=l.getPoolInitPriceByInit({...d,decimalA:c,decimalB:u}),p=o.div(new pn(t-1)),y=new pn(0),f=[{price:m,totalSellSupply:0}],{a:b,b:g}=d,w=y,k=y;for(let h=1;h<t;h++){let x=h!==t-1?p:o.sub(k),T=this.buyExactIn({poolInfo:{virtualA:b,virtualB:g,realA:w,realB:k,totalFundRaisingB:o,totalSellA:r},amountB:x,protocolFeeRate:y,platformFeeRate:y,curveType:e,shareFeeRate:y});w=w.add(T.amountA),k=k.add(T.amountB);let B=this.getPrice({poolInfo:{virtualA:b,virtualB:g,realA:w,realB:k},decimalA:c,decimalB:u,curveType:e});f.push({price:B,totalSellSupply:new C(w.toString()).div(10**c).toNumber()})}return f}static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n,curveType:o}){return this.getCurve(o).getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n})}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o,curveType:r}){return this.getCurve(r).getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o})}static getPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:o}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:o})}static getEndPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:o}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:o})}static getPoolEndPriceReal({poolInfo:e,curveType:t,decimalA:n,decimalB:o}){return this.getCurve(t).getPoolEndPriceReal({poolInfo:e,decimalA:n,decimalB:o})}static checkParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,decimals:r,config:s,migrateType:a}){if(Number(r)!==6)throw Error("decimals = 6");if(e.mul(s.maxLockRate).div(Yt).lt(o))throw Error("total lock amount gte max lock amount");if(e.lt(s.minSupplyA.mul(new pn(10**r))))throw Error("supply lt min supply");let u=e.mul(s.minSellRateA).div(Yt);if(n.lt(u))throw Error("invalid input");if(t.lt(s.minFundRaisingB))throw Error("total fund raising lt min fund raising");let l=e.sub(n).sub(o),d=e.mul(s.minMigrateRateA).div(Yt);if(l.lt(d))throw Error("migrate lt min migrate amount");let m=e.sub(n).sub(o),p=new pn(new C(m.mul(t).toString()).sqrt().toFixed(0));if(a==="amm"){let y=new pn(10).pow(new pn(r));if(p.lte(y))throw Error("check migrate lp error")}else if(a==="cpmm"){let y=new pn(100);if(p.lte(y))throw Error("check migrate lp error")}else throw Error("migrate type error")}static buyExactIn({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:o,curveType:r,shareFeeRate:s}){let a=n.add(s).add(o),c=this.calculateFee({amount:t,feeRate:a}),u=t.sub(c),l=this.getCurve(r),d=l.buyExactIn({poolInfo:e,amount:u}),m=e.totalSellA.sub(e.realA),p,y,f;if(d.gt(m)){p=m;let g=l.buyExactOut({poolInfo:e,amount:p});y=this.calculatePreFee({postFeeAmount:g,feeRate:a}),f=y.sub(g)}else p=d,y=t,f=c;let b=this.splitFee({totalFee:f,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:p,amountB:y,splitFee:b}}static buyExactOut({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:o,curveType:r,shareFeeRate:s}){let a=e.totalSellA.sub(e.realA),c=t;t.gt(a)&&(c=a);let l=this.getCurve(r).buyExactOut({poolInfo:e,amount:t}),d=n.add(s).add(o),m=this.calculatePreFee({postFeeAmount:l,feeRate:d}),p=m.sub(l),y=this.splitFee({totalFee:p,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:c,amountB:m,splitFee:y}}static sellExactIn({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:o,curveType:r,shareFeeRate:s}){let c=this.getCurve(r).sellExactIn({poolInfo:e,amount:t}),u=this.calculateFee({amount:c,feeRate:n.add(s).add(o)}),l=this.splitFee({totalFee:u,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:t,amountB:c.sub(u),splitFee:l}}static sellExactOut({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:o,curveType:r,shareFeeRate:s}){let a=n.add(s).add(o),c=this.calculatePreFee({postFeeAmount:t,feeRate:a});if(e.realB.lt(c))throw Error("Insufficient liquidity");let u=c.sub(t),d=fn.getCurve(r).sellExactOut({poolInfo:e,amount:c});if(d.gt(e.realA))throw Error();let m=this.splitFee({totalFee:u,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:d,amountB:t,splitFee:m}}static splitFee({totalFee:e,protocolFeeRate:t,platformFeeRate:n,shareFeeRate:o}){let r=t.add(n).add(o),s=r.isZero()?new pn(0):e.mul(n).div(r),a=r.isZero()?new pn(0):e.mul(o).div(r),c=e.sub(s).sub(a);return{platformFee:s,shareFee:a,protocolFee:c}}static calculateFee({amount:e,feeRate:t}){return ur(e,t,Yt)}static calculatePreFee({postFeeAmount:e,feeRate:t}){if(t.isZero())return e;let n=e.mul(Yt),o=Yt.sub(t);return n.add(o).sub(new pn(1)).div(o)}static getCurve(e){switch(e){case 0:return rs;case 1:return ss;case 2:return as}throw Error("find curve error")}};var mo={initPriceX64:new fe("515752397214619"),supply:new fe(1e15),totalSellA:new fe(7931e11),totalFundRaisingB:new fe(85e9),totalLockedAmount:new fe("0"),cliffPeriod:new fe("0"),unlockPeriod:new fe("0"),decimals:6,virtualA:new fe("1073471847374405"),virtualB:new fe("30050573465"),realA:new fe(0),realB:new fe(0),protocolFee:new fe(0),platformId:new om("4Bu96XjU84XjPDSpveTVf6LYGCkfW5FK7SNkREWcEfV4"),vestingSchedule:{totalLockedAmount:new fe(0),cliffPeriod:new fe(0),unlockPeriod:new fe(0),startTime:new fe(0),totalAllocatedShare:new fe(0)}},cs=new fe(1e4),Qi=class extends Ne{constructor(e){super(e)}async createLaunchpad({programId:e=zt,authProgramId:t,platformId:n=mo.platformId,mintA:o,decimals:r=6,mintBDecimals:s=9,name:a,symbol:c,uri:u,migrateType:l,configId:d,configInfo:m,platformFeeRate:p,txVersion:y,computeBudgetConfig:f,txTipConfig:b,feePayer:g,buyAmount:w,minMintAAmount:k,slippage:h,associatedOnly:x=!0,checkCreateATAOwner:T=!1,extraSigners:B,...S}){let I=this.createTxBuilder(g);t=t??lo(e).publicKey;let K=m;if(!K&&d){let pt=await this.scope.connection.getAccountInfo(d);pt&&(K=Eo.decode(pt.data))}K||this.logAndCreateError("config not found");let O=K.mintB,v=K.curveType,{publicKey:_}=ns(e,o,O),{publicKey:D}=ru(e,_,o),{publicKey:q}=ru(e,_,O),{publicKey:G}=hn(o);console.log(`create token: ${o.toBase58()}, mintB: ${O.toBase58()}, decimals A:${r}/B:${s}, config:${d.toBase58()}`),c.length>10&&this.logAndCreateError("Symbol length should shorter than 11"),u||this.logAndCreateError("uri should not empty"),w.lte(new fe(0))&&this.logAndCreateError("buy amount should gt 0:",w.toString());let ne=S?.supply??mo.supply,ie=S?.totalSellA??mo.totalSellA,de=S?.totalFundRaisingB??mo.totalFundRaisingB,re=S?.totalLockedAmount??new fe(0),ye=p;if(!p){let pt=await this.scope.connection.getAccountInfo(n);pt||this.logAndCreateError("platform id not found:",n.toString()),ye=is.decode(pt.data).feeRate}let $e=fn.getCurve(K.curveType).getInitParam({supply:ne,totalFundRaising:de,totalSell:ie,totalLockedAmount:re,migrateFee:K.migrateFee}),nt={epoch:new fe(896),bump:254,status:0,mintDecimalsA:r,mintDecimalsB:s,supply:ne,totalSellA:ie,mintA:new om(o),mintB:O,virtualA:$e.a,virtualB:$e.b,realA:mo.realA,realB:mo.realB,migrateFee:K.migrateFee,migrateType:l==="amm"?0:1,protocolFee:mo.protocolFee,platformFee:ye,platformId:n,configId:d,vaultA:D,vaultB:q,creator:this.scope.ownerPubKey,totalFundRaisingB:de,vestingSchedule:{totalLockedAmount:re,cliffPeriod:new fe(0),unlockPeriod:new fe(0),startTime:new fe(0),totalAllocatedShare:new fe(0)}},It=fn.getCurve(K.curveType),{c:Rt}=It.getInitParam({supply:nt.supply,totalFundRaising:nt.totalFundRaisingB,totalLockedAmount:re,totalSell:K.curveType===0?nt.totalSellA:new fe(0),migrateFee:K.migrateFee});try{fn.checkParam({supply:nt.supply,totalFundRaising:nt.totalFundRaisingB,totalSell:Rt,totalLockedAmount:re,decimals:nt.mintDecimalsA,config:K,migrateType:l}),console.log("check init params success")}catch(pt){this.logAndCreateError(`check create mint params failed, ${pt.message}`)}I.addInstruction({instructions:[jl(e,g??this.scope.ownerPubKey,this.scope.ownerPubKey,d,n,t,_,o,O,D,q,G,Lt,Lt,r,a,c,u||"https://",{type:v===0?"ConstantCurve":v===1?"FixedCurve":v===2?"LinearCurve":"ConstantCurve",totalSellA:ie,migrateType:l,supply:ne,totalFundRaisingB:de},re,S?.cliffPeriod??new fe(0),S?.unlockPeriod??new fe(0))]});let nn=new fe(0),yn;if(B?.length&&I.addInstruction({signers:B}),!S.createOnly){let{builder:pt,extInfo:ot}=await this.buyToken({programId:e,authProgramId:t,mintA:o,mintB:O,poolInfo:nt,buyAmount:w,minMintAAmount:k,shareFeeRate:S.shareFeeRate,shareFeeReceiver:S.shareFeeReceiver,configInfo:K,platformFeeRate:ye,slippage:h,associatedOnly:x,checkCreateATAOwner:T});I.addInstruction({...pt.AllTxData}),nn=ot.outAmount,yn=(this.scope.cluster==="devnet"||y===1)&&S.shareFeeReceiver?[pt.allInstructions[0]]:void 0}return I.addTipInstruction(b),y===0?I.sizeCheckBuildV0({computeBudgetConfig:f,outAmount:nn,splitIns:yn,address:{...nt,poolId:_}}):I.sizeCheckBuild({computeBudgetConfig:f,outAmount:nn,splitIns:yn,address:{...nt,poolId:_}})}async buyToken({programId:e=zt,authProgramId:t,mintA:n,mintB:o=us,poolInfo:r,configInfo:s,platformFeeRate:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:d,buyAmount:m,minMintAAmount:p,slippage:y,shareFeeRate:f=new fe(0),shareFeeReceiver:b,associatedOnly:g=!0,checkCreateATAOwner:w=!1}){m.lte(new fe(0))&&this.logAndCreateError("buy amount should gt 0:",m.toString());let k=this.createTxBuilder(d),{publicKey:h}=ns(e,n,o);t=t??lo(e).publicKey;let x=null,T=null,B=o.equals(us),{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:n,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:g,checkCreateATAOwner:w});S&&(x=S),k.addInstruction(I||{}),x===void 0&&this.logAndCreateError(`cannot found mintA(${n.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let{account:K,instructionParams:O}=await this.scope.account.getOrCreateTokenAccount({mint:o,owner:this.scope.ownerPubKey,createInfo:B?{payer:this.scope.ownerPubKey,amount:m}:void 0,skipCloseAccount:!B,notUseTokenAccount:B,associatedOnly:B?!1:g,checkCreateATAOwner:w});K&&(T=K),k.addInstruction(O||{}),T===void 0&&this.logAndCreateError(`cannot found mintB(${o.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let v=r;if(!v){let re=await this.scope.connection.getAccountInfo(h,{commitment:"processed"});re||this.logAndCreateError("cannot found pool:",h.toBase58()),v=Sn.decode(re.data)}let _=s,D=await Ke(this.scope.connection,[_?void 0:v.configId,a?void 0:v.platformId].filter(Boolean).map(re=>({pubkey:re})));if(!_){let re=D.find(ye=>ye.pubkey.equals(v.configId));(!re||!re.accountInfo)&&this.logAndCreateError("config not found: ",v.configId.toBase58()),_=Eo.decode(re.accountInfo.data)}if(!a){let re=D.find(ye=>ye.pubkey.equals(v.platformId));(!re||!re.accountInfo)&&this.logAndCreateError("platform info not found: ",v.configId.toBase58()),a=is.decode(re.accountInfo.data).feeRate}let q=fn.buyExactIn({poolInfo:v,amountB:m,protocolFeeRate:_.tradeFeeRate,platformFeeRate:a,curveType:_.curveType,shareFeeRate:f}),G=new C(q.amountA.toString()),ne=y?new C(cs.sub(y).toNumber()/cs.toNumber()).clampedTo(0,1):new C(1),ie=p??(y?new fe(G.mul(ne).toFixed(0)):q.amountA);q.amountB.lt(m)&&console.log(`maximum ${n.toBase58()} amount can buy is ${q.amountA.toString()}, input ${o.toBase58()} amount: ${q.amountB.toString()}`);let de=b?Z(b,o,Lt).publicKey:void 0;return de&&k.addInstruction({instructions:[Xi(this.scope.ownerPubKey,de,b,o)]}),k.addInstruction({instructions:[Yl(e,this.scope.ownerPubKey,t,v.configId,v.platformId,h,x,T,v.vaultA,v.vaultB,n,o,Lt,Lt,q.amountB.lt(m)?q.amountB:m,ie,f,de)]}),k.addCustomComputeBudget(u),k.addTipInstruction(l),k.versionBuild({txVersion:c,extInfo:{outAmount:ie}})}async sellToken({programId:e=zt,authProgramId:t,mintA:n,mintB:o=us,poolInfo:r,configInfo:s,platformFeeRate:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:d,sellAmount:m,minAmountB:p,slippage:y,shareFeeRate:f=new fe(0),shareFeeReceiver:b,associatedOnly:g=!0,checkCreateATAOwner:w=!1}){t=t??lo(e).publicKey;let k=this.createTxBuilder(d);m.lte(new fe(0))&&this.logAndCreateError("sell amount should be gt 0");let{publicKey:h}=ns(e,n,o),x=null,T=null,B=o.equals(us),{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:n,owner:this.scope.ownerPubKey,createInfo:void 0,skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:g,checkCreateATAOwner:w});S&&(x=S),k.addInstruction(I||{}),x===void 0&&this.logAndCreateError("cannot found mintA token accounts","tokenAccounts",this.scope.account.tokenAccounts);let{account:K,instructionParams:O}=await this.scope.account.getOrCreateTokenAccount({mint:o,owner:this.scope.ownerPubKey,createInfo:B?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!B,notUseTokenAccount:B,associatedOnly:B?!1:g,checkCreateATAOwner:w});K&&(T=K),k.addInstruction(O||{}),T===void 0&&this.logAndCreateError("cannot found mintB token accounts","tokenAccounts",this.scope.account.tokenAccounts);let v=r;if(!v){let re=await this.scope.connection.getAccountInfo(h,{commitment:"processed"});re||this.logAndCreateError("cannot found pool",h.toBase58()),v=Sn.decode(re.data)}let _=s,D=await Ke(this.scope.connection,[_?void 0:v.configId,a?void 0:v.platformId].filter(Boolean).map(re=>({pubkey:re})));if(!_){let re=D.find(ye=>ye.pubkey.equals(v.configId));(!re||!re.accountInfo)&&this.logAndCreateError("config not found: ",v.configId.toBase58()),_=Eo.decode(re.accountInfo.data)}if(!a){let re=D.find(ye=>ye.pubkey.equals(v.platformId));(!re||!re.accountInfo)&&this.logAndCreateError("platform info not found: ",v.configId.toBase58()),a=is.decode(re.accountInfo.data).feeRate}let q=fn.sellExactIn({poolInfo:v,amountA:m,protocolFeeRate:_.tradeFeeRate,platformFeeRate:a,curveType:_.curveType,shareFeeRate:f}),G=new C(q.amountB.toString()),ne=y?new C(cs.sub(y).toNumber()/cs.toNumber()).clampedTo(0,1):new C(1),ie=p??(y?new fe(G.mul(ne).toFixed(0)):q.amountB);ie.lte(new fe(0))&&this.logAndCreateError(`out ${o.toBase58()} amount should be gt 0`);let de=b?Z(b,o,Lt).publicKey:void 0;return de&&k.addInstruction({instructions:[Xi(this.scope.ownerPubKey,de,b,o)]}),k.addInstruction({instructions:[Zl(e,this.scope.ownerPubKey,t,v.configId,v.platformId,h,x,T,v.vaultA,v.vaultB,n,o,Lt,Lt,q.amountA.lt(m)?q.amountA:m,ie,f,de)]}),k.addCustomComputeBudget(u),k.addTipInstruction(l),k.versionBuild({txVersion:c,extInfo:{outAmount:ie}})}async createPlatformConfig({programId:e=zt,platformAdmin:t,platformClaimFeeWallet:n,platformLockNftWallet:o,cpConfigId:r,migrateCpLockNftScale:s,feeRate:a,name:c,web:u,img:l,txVersion:d,computeBudgetConfig:m,txTipConfig:p,feePayer:y}){let f=this.createTxBuilder(y),{publicKey:b}=su(e,t);return f.addInstruction({instructions:[em(e,t,n,o,b,r,s,a,c,u,l)]}),f.addCustomComputeBudget(m),f.addTipInstruction(p),f.versionBuild({txVersion:d,extInfo:{platformId:b}})}async updatePlatformConfig({programId:e=zt,platformAdmin:t,platformId:n,updateInfo:o,txVersion:r,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l=n??su(e,t).publicKey;return u.addInstruction({instructions:[tm(e,t,l,o)]}),u.addCustomComputeBudget(s),u.addTipInstruction(a),u.versionBuild({txVersion:r})}async claimPlatformFee({programId:e=zt,authProgramId:t,platformId:n,poolId:o,platformClaimFeeWallet:r,mintB:s,vaultB:a,mintBProgram:c=Lt,txVersion:u,computeBudgetConfig:l,txTipConfig:d,feePayer:m}){let p=this.createTxBuilder(m);t=t??lo(e).publicKey;let y=s,f=a;if(!y){let g=await this.scope.connection.getAccountInfo(o,{commitment:"processed"});g||this.logAndCreateError("cannot found pool:",o.toBase58());let w=Sn.decode(g.data),k=await this.scope.connection.getAccountInfo(w.configId,{commitment:"processed"});k||this.logAndCreateError("cannot found config:",w.configId.toBase58()),y=Eo.decode(k.data).mintB,f=f??w.vaultB}(!y||!f)&&this.logAndCreateError("cannot found mint info, mintB: ",y.toBase58(),", vaultB: ",f?.toBase58()??"");let b=Z(this.scope.ownerPubKey,y,Lt).publicKey;return p.addInstruction({instructions:[Xi(this.scope.ownerPubKey,b,this.scope.ownerPubKey,y)]}),p.addInstruction({instructions:[uu(e,r,t,o,n,f,b,y,c)]}),p.addCustomComputeBudget(l),p.addTipInstruction(d),p.versionBuild({txVersion:u})}async claimAllPlatformFee({programId:e=zt,authProgramId:t,platformId:n,platformClaimFeeWallet:o,txVersion:r,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c);return t=t??lo(e).publicKey,(await this.scope.connection.getProgramAccounts(e,{filters:[{dataSize:Sn.span},{memcmp:{offset:Sn.offsetOf("platformId"),bytes:n.toString()}}]})).forEach(d=>{let m=Sn.decode(d.account.data),p=Z(this.scope.ownerPubKey,m.mintB,Lt).publicKey;u.addInstruction({instructions:[Xi(this.scope.ownerPubKey,p,this.scope.ownerPubKey,m.mintB)]}),u.addInstruction({instructions:[uu(e,o,t,d.pubkey,n,m.vaultB,p,m.mintB,Lt)]})}),u.addTipInstruction(a),r===0?u.sizeCheckBuildV0({computeBudgetConfig:s}):u.sizeCheckBuild({computeBudgetConfig:s})}async createVesting({programId:e=zt,poolId:t,beneficiary:n,shareAmount:o,txVersion:r,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l=au(e,t,n).publicKey;return u.addInstruction({instructions:[Jl(e,this.scope.ownerPubKey,n,t,l,o)]}),u.addCustomComputeBudget(s),u.addTipInstruction(a),u.versionBuild({txVersion:r})}async claimVesting({programId:e=zt,poolId:t,poolInfo:n,txVersion:o,computeBudgetConfig:r,txTipConfig:s,feePayer:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1}){let l=this.createTxBuilder(a),d=lo(e).publicKey,m=au(e,t,this.scope.ownerPubKey).publicKey,p=n;if(!p){let f=await this.scope.connection.getAccountInfo(t);f||this.logAndCreateError("pool not found"),p=Sn.decode(f.data)}let y=Z(this.scope.ownerPubKey,p.mintA,Lt).publicKey;return l.addInstruction({instructions:[Xi(this.scope.ownerPubKey,y,this.scope.ownerPubKey,p.mintA)]}),l.addInstruction({instructions:[$l(e,this.scope.ownerPubKey,d,t,m,y,p.vaultA,p.mintA,Lt)]}),l.addCustomComputeBudget(r),l.addTipInstruction(s),l.versionBuild({txVersion:o})}async getRpcPoolInfo({poolId:e}){return(await this.getRpcPoolsInfo({poolIdList:[e]})).poolInfoMap[e.toBase58()]}async getRpcPoolsInfo({poolIdList:e,config:t}){let n=await Ke(this.scope.connection,e.map(c=>({pubkey:c})),t),o={},r=[];for(let c=0;c<e.length;c++){let u=n[c];if(u===null||!u.accountInfo)throw Error("fetch pool info error: "+e[c].toBase58());let l=Sn.decode(u.accountInfo.data);o[e[c].toBase58()]={...l,poolId:u.accountInfo.owner},r.push(l.configId)}let s=await Ke(this.scope.connection,r.map(c=>({pubkey:c})),t),a={};for(let c=0;c<r.length;c++){let u=s[c];if(u===null||!u.accountInfo)throw Error("fetch config info error: "+r[c].toBase58());let l=Eo.decode(u.accountInfo.data);a[r[c].toBase58()]={...l,configId:u.accountInfo.owner}}return{poolInfoMap:Object.keys(o).reduce((c,u)=>({...c,[u]:{...o[u],configInfo:a[o[u].configId.toBase58()]}}),{})}}};import{PublicKey as rb}from"@solana/web3.js";import{MintLayout as sb,TOKEN_2022_PROGRAM_ID as cu,TOKEN_PROGRAM_ID as lu}from"@solana/spl-token";var zi=class extends Ne{_tokenList=[];_tokenMap=new Map;_blackTokenMap=new Set;_mintGroup={official:new Set,jup:new Set,extra:new Set};_whiteMap=new Set;_extraTokenList=[];constructor(e){super(e)}async load(e){this.checkDisabled();let{forceUpdate:t=!1,type:n="strict"}=e||{},{mintList:o,blacklist:r,whiteList:s}=await this.scope.fetchV3TokenList(t),a=await this.scope.fetchJupTokenList(t);this._tokenList=[],this._tokenMap=new Map,this._blackTokenMap=new Set(r),this._mintGroup={official:new Set,jup:new Set,extra:new Set},this._whiteMap=new Set(s),this._tokenMap.set(sn.address,sn),this._mintGroup.official.add(sn.address),o.forEach(c=>{this._blackTokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"raydium",priority:2,programId:c.programId??(c.tags.includes("token-2022")?cu.toBase58():lu.toBase58())}),this._mintGroup.official.add(c.address))}),a.forEach(c=>{this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"jupiter",priority:1,programId:c.programId??(c.tags.includes("token-2022")?cu.toBase58():lu.toBase58()),tags:c.freezeAuthority?[...c.tags||[],"hasFreeze"]:c.tags}),this._mintGroup.jup.add(c.address))}),this._extraTokenList.forEach(c=>{this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"extra",priority:1,programId:c.programId||c.tags.includes("token-2022")?cu.toBase58():lu.toBase58()}),this._mintGroup.extra.add(c.address))}),this._tokenList=Array.from(this._tokenMap).map(c=>c[1])}get tokenList(){return this._tokenList}get tokenMap(){return this._tokenMap}get blackTokenMap(){return this._blackTokenMap}get mintGroup(){return this._mintGroup}get whiteListMap(){return this._whiteMap}async getTokenInfo(e){if(!e)throw new Error("please input mint");let t=e.toString(),n=this._tokenMap.get(t);if(n)return n;if(t.toLocaleUpperCase()==="SOL")return sn;let o=(await this.scope.api.getTokenInfo([t]))[0];if(o)return this._mintGroup.extra.add(t),this._tokenMap.set(t,{...o,priority:2}),o;let r=await this.scope.connection.getAccountInfo(new rb(t));if(!r)throw new Error(`mint address not found: ${t}`);let s=sb.decode(r.data),a=t.toString().substring(0,6),c={chainId:101,address:t,programId:r.owner.toBase58(),logoURI:"",symbol:a,name:a,decimals:s.decimals,tags:[],extensions:{},priority:0,type:"unknown"};return this._mintGroup.extra.add(t),this._tokenMap.set(t,c),c}};var ls=class{cluster;farm;account;liquidity;clmm;cpmm;tradeV2;utils1216;marketV2;ido;token;launchpad;rawBalances=new Map;apiData;availability;blockhashCommitment;loopMultiTxStatus;_connection;_owner;api;_apiCacheTime;_signAllTransactions;logger;_chainTime;_epochInfo;constructor(e){let{connection:t,cluster:n,owner:o,api:r,defaultChainTime:s,defaultChainTimeOffset:a,apiCacheTime:c,blockhashCommitment:u="confirmed",loopMultiTxStatus:l}=e;this._connection=t,this.cluster=n||"mainnet",this._owner=o?new Qt(o):void 0,this._signAllTransactions=e.signAllTransactions,this.blockhashCommitment=u,this.loopMultiTxStatus=l,this.api=r,this._apiCacheTime=c||5*60*1e3,this.logger=pe("Raydium"),this.farm=new pi({scope:this,moduleName:"Raydium_Farm"}),this.account=new oi({scope:this,moduleName:"Raydium_Account",tokenAccounts:e.tokenAccounts,tokenAccountRawInfos:e.tokenAccountRawInfos}),this.liquidity=new Ci({scope:this,moduleName:"Raydium_LiquidityV2"}),this.token=new zi({scope:this,moduleName:"Raydium_tokenV2"}),this.tradeV2=new Vi({scope:this,moduleName:"Raydium_tradeV2"}),this.clmm=new Ri({scope:this,moduleName:"Raydium_clmm"}),this.cpmm=new Ei({scope:this,moduleName:"Raydium_cpmm"}),this.utils1216=new Dt({scope:this,moduleName:"Raydium_utils1216"}),this.marketV2=new Lo({scope:this,moduleName:"Raydium_marketV2"}),this.ido=new vo({scope:this,moduleName:"Raydium_ido"}),this.launchpad=new Qi({scope:this,moduleName:"Raydium_lauchpad"}),this.availability={};let d=new Date().getTime();this.apiData={},a&&(this._chainTime={fetched:d,value:{chainTime:s||Date.now()-a,offset:a}})}static async load(e){let t=ab({cluster:"mainnet",owner:null,apiRequestInterval:3e5,apiRequestTimeout:1e4},e),{cluster:n,apiRequestTimeout:o,logCount:r,logRequests:s,urlConfigs:a}=t,c=new kr({cluster:n,timeout:o,urlConfigs:a,logCount:r,logRequests:s}),u=new ls({...t,api:c});return await u.fetchAvailabilityStatus(e.disableFeatureCheck??!0),e.disableLoadToken||await u.token.load({type:e.jupTokenType}),u}get owner(){return this._owner}get ownerPubKey(){if(!this._owner)throw new Error(hr);return this._owner.publicKey}setOwner(e){return this._owner=e?new Qt(e):void 0,this.account.resetTokenAccounts(),this}get connection(){if(!this._connection)throw new Error(oc);return this._connection}setConnection(e){return this._connection=e,this}get signAllTransactions(){return this._signAllTransactions}setSignAllTransactions(e){return this._signAllTransactions=e,this}checkOwner(){if(!this.owner)throw console.error(hr),new Error(hr)}isCacheInvalidate(e){return new Date().getTime()-e>this._apiCacheTime}async fetchChainTime(){try{let e=await this.api.getChainTimeOffset();this._chainTime={fetched:Date.now(),value:{chainTime:Date.now()+e.offset*1e3,offset:e.offset*1e3}}}catch{this._chainTime=void 0}}async fetchV3TokenList(e){if(this.apiData.tokenList&&!this.isCacheInvalidate(this.apiData.tokenList.fetched)&&!e)return this.apiData.tokenList.data;try{let t=await this.api.getTokenList(),n={fetched:Date.now(),data:t};return this.apiData.tokenList=n,n.data}catch(t){return console.error(t),{mintList:[],blacklist:[],whiteList:[]}}}async fetchJupTokenList(e){let t=this.apiData.jupTokenList;if(t&&!this.isCacheInvalidate(t.fetched)&&!e)return t.data;try{let n=await this.api.getJupTokenList();return this.apiData.jupTokenList={fetched:Date.now(),data:n.map(o=>({...o,mintAuthority:o.mint_authority||void 0,freezeAuthority:o.freeze_authority||void 0}))},this.apiData.jupTokenList.data}catch(n){return console.error(n),[]}}get chainTimeData(){return this._chainTime?.value}async chainTimeOffset(){return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.offset:(await this.fetchChainTime(),this._chainTime?.value.offset||0)}async currentBlockChainTime(){return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.chainTime:(await this.fetchChainTime(),this._chainTime?.value.chainTime||Date.now())}async fetchEpochInfo(){return this._epochInfo&&Date.now()-this._epochInfo.fetched<=1e3*30?this._epochInfo.value:(this._epochInfo={fetched:Date.now(),value:await this.connection.getEpochInfo()},this._epochInfo.value)}async fetchAvailabilityStatus(e){if(e)return{};try{let t=await this.api.fetchAvailabilityStatus(),n=t.all===!1;return this.availability={all:t.all,swap:n?!1:t.swap,createConcentratedPosition:n?!1:t.createConcentratedPosition,addConcentratedPosition:n?!1:t.addConcentratedPosition,addStandardPosition:n?!1:t.addStandardPosition,removeConcentratedPosition:n?!1:t.removeConcentratedPosition,removeStandardPosition:n?!1:t.removeStandardPosition,addFarm:n?!1:t.addFarm,removeFarm:n?!1:t.removeFarm},t}catch{return{}}}};var eR=i=>i;export{Pb as ACCOUNT_TYPE_SIZE,wt as ALL_PROGRAM_ID,Vf as AMM_CONFIG_SEED,_d as AMM_STABLE,Qo as AMM_V4,ag as ANAMint,at as API_URLS,fm as AccountType,kr as Api,qc as BIT_PRECISION,Ht as BNDivCeil,Yn as BNLayout,fA as BN_100,yA as BN_1000,bA as BN_10000,pA as BN_FIVE,_u as BN_ONE,zn as BN_TEN,dA as BN_THREE,mA as BN_TWO,ze as BN_ZERO,Lw as BitStructure,mc as Blob,zo as CLMM_LOCK_AUTH_ID,Po as CLMM_LOCK_PROGRAM_ID,vn as CLMM_PROGRAM_ID,Ks as CLOCK_PROGRAM_ID,Ws as CREATE_CPMM_POOL_AUTH,Ud as CREATE_CPMM_POOL_FEE_ACC,Ho as CREATE_CPMM_POOL_PROGRAM,Ri as Clmm,ol as ClmmConfigLayout,xe as ClmmInstrument,Xr as ConstantProductCurve,Ha as CpmmConfigInfoLayout,Qr as CpmmFee,Mi as CpmmPoolInfoLayout,Uo as Currency,Qn as CurrencyAmount,fn as Curve,Xn as CurveBase,Hr as CurveCalculator,QA as DEVNET_PROGRAM_ID,MP as DEV_API_URLS,Xd as DEV_CREATE_CPMM_POOL_AUTH,Qd as DEV_CREATE_CPMM_POOL_FEE_ACC,Gd as DEV_CREATE_CPMM_POOL_PROGRAM,Zd as DEV_LAUNCHPAD_AUTH,Yd as DEV_LAUNCHPAD_PROGRAM,Hd as DEV_LOCK_CPMM_AUTH,zd as DEV_LOCK_CPMM_PROGRAM,sy as DataElement,ug as ETHMint,Sa as EXTENSION_TICKARRAY_BITMAP_SIZE,Cc as FARM_LOCK_MINT,Lc as FARM_LOCK_VAULT,_s as FARM_PROGRAM_ID_V3,Yu as FARM_PROGRAM_ID_V4,Fs as FARM_PROGRAM_ID_V5,Ao as FARM_PROGRAM_ID_V6,_t as FARM_PROGRAM_TO_VERSION,Nc as FARM_VERSION_TO_LEDGER_LAYOUT,Rc as FARM_VERSION_TO_STATE_LAYOUT,Zu as FEE_DESTINATION_ID,Or as FEE_RATE_DENOMINATOR,Yt as FEE_RATE_DENOMINATOR_VALUE,Hf as FETCH_TICKARRAY_COUNT,Ff as Fee,ss as FixedPriceCurve,le as Fraction,Zo as IDO_ALL_PROGRAM,Vd as IDO_PROGRAM_ID_V1,Wd as IDO_PROGRAM_ID_V2,Dd as IDO_PROGRAM_ID_V3,qd as IDO_PROGRAM_ID_V4,rr as INSTRUCTION_PROGRAM_ID,V as InstructionType,Ju as JupTokenType,jd as LAUNCHPAD_AUTH,Zy as LAUNCHPAD_AUTH_SEED,$y as LAUNCHPAD_CONFIG_SEED,nb as LAUNCHPAD_POOL_PLATFORM_SEED,Jy as LAUNCHPAD_POOL_SEED,eb as LAUNCHPAD_POOL_VAULT_SEED,tb as LAUNCHPAD_POOL_VESTING_SEED,zt as LAUNCHPAD_PROGRAM,Fr as LIQUIDITY_FEES_DENOMINATOR,Ra as LIQUIDITY_FEES_NUMERATOR,fr as LIQUIDITY_POOL_PROGRAM_ID_V5_MODEL,oy as LIQUIDITY_VERSION_TO_SERUM_VERSION,FB as LIQUIDITY_VERSION_TO_STATE_LAYOUT,Yo as LOCK_CPMM_AUTH,jo as LOCK_CPMM_PROGRAM,Vy as LOCK_LIQUIDITY_SEED,Uc as LOG_B_2_X32,Gc as LOG_B_P_ERR_MARGIN_LOWER_X64,Xc as LOG_B_P_ERR_MARGIN_UPPER_X64,gr as LOOKUP_TABLE_CACHE,rs as LaunchPadConstantProductCurve,Eo as LaunchpadConfig,Sn as LaunchpadPool,mo as LaunchpadPoolInitParam,k1 as LaunchpadVesting,ib as LaunchpadVestingSchedule,ti as Layout,as as LinearPriceCurve,Ae as LiquidityMath,YI as LockClPositionLayoutV2,jI as LockPositionLayout,cm as LogLevel,ps as Logger,Ga as MARKET_STATE_LAYOUT_V2,Ya as MARKET_STATE_LAYOUT_V3,ql as MARKET_VERSION_TO_STATE_LAYOUT,Qu as MAX_BASE64_SIZE,Wt as MAX_SQRT_PRICE_X64,Nr as MAX_SQRT_PRICE_X64_SUB_ONE,ht as MAX_TICK,ir as MEMO_PROGRAM_ID,an as MEMO_PROGRAM_ID2,Xt as METADATA_PROGRAM_ID,Vt as MIN_SQRT_PRICE_X64,Rr as MIN_SQRT_PRICE_X64_ADD_ONE,gt as MIN_TICK,Ko as MODEL_DATA_PUBKEY,$r as Market,Gi as MathLaunch,ae as MathUtil,fi as MaxU64,Dc as MaxUint128,kn as NEGATIVE_ONE,sg as NRVMint,Qf as OBSERVATION_SEED,Ot as ONE,Vs as OPEN_BOOK_PROGRAM,Gf as OPERATION_SEED,il as ObservationInfoLayout,Zf as ObservationLayout,rl as OperationLayout,Js as OptionLayout,Qt as Owner,Jb as PAIMint,Jc as POOL_LOCK_ID_SEED,qf as POOL_REWARD_VAULT_SEED,Wf as POOL_SEED,Xf as POOL_TICK_ARRAY_BITMAP_SEED,Df as POOL_VAULT_SEED,jc as POSITION_SEED,De as Percent,is as PlatformConfig,ec as PoolFetchType,eo as PoolInfoLayout,Le as PoolUtils,hi as PositionInfoLayout,Jf as PositionRewardInfoLayout,Pi as PositionUtils,st as Price,HI as ProtocolPositionLayout,Lr as Q128,Ye as Q64,$b as RAYMint,je as RENT_PROGRAM_ID,ls as Raydium,$f as RewardInfo,Kl as RoundDirection,Ts as Rounding,Fd as Router,Wl as SERUM_PROGRAMID_TO_VERSION,pr as SERUM_PROGRAM_ID_V3,Dl as SERUM_VERSION_TO_PROGRAMID,tc as SESSION_KEY,rt as SOLMint,sn as SOL_INFO,cl as SPL_MINT_LAYOUT,eg as SRMMint,Us as STORAGE_KEY,zf as SUPPORT_MINT_SEED,sr as SYSTEM_PROGRAM_ID,te as SqrtPriceMath,So as StableLayout,ea as Structure,Jn as SwapMath,$n as TICK_ARRAY_BITMAP_SIZE,Uf as TICK_ARRAY_SEED,tt as TICK_ARRAY_SIZE,LT as TICK_SPACINGS,it as TOKEN_WSOL,Tn as TickArrayBitmap,nl as TickArrayBitmapExtensionLayout,ki as TickArrayBitmapExtensionUtils,wi as TickArrayLayout,ey as TickLayout,to as TickMath,Pe as TickQuery,H as TickUtils,Te as Token,we as TokenAmount,Pr as TxBuilder,On as TxVersion,yi as U64Resolution,NT as U64_IGNORE_RANGE,Ys as UInt,tg as USDCMint,rg as USDHMint,ng as USDTMint,Ed as UTIL1216,ta as Union,Sc as Voter,Tf as VoterDepositEntry,hf as VoterLockup,xc as VoterRegistrar,kf as VoterVotingMintConfig,j as WSOLMint,Sr as WideBits,Pn as WrappedLayout,be as ZERO,Ou as _100_PERCENT,A as accountMeta,Qg as add,bo as addComputeBudget,Ma as addLiquidityLayout,dn as anchorDataBuf,fk as array,ra as associatedLedgerAccountLayout,Zs as bits,he as blob,_e as bool,Yl as buyExactInInstruction,g1 as buyExactOutInstruction,Aa as calFarmRewardAmount,ur as ceilDiv,yr as ceilDivBN,Go as checkLegacyTxSize,V1 as checkPoolToAmm,Xo as checkV0TxSize,bs as chunkArray,Wi as claimLayout,uu as claimPlatformFee,$l as claimVestedToken,tl as clmmComputeInfoToApiInfo,wn as closeAccountInstruction,_l as collectCpFeeInstruction,Bs as commonSystemAccountMeta,mr as confirmTransaction,Uy as cpmmLockPositionInstruction,ci as createAssociatedLedgerAccountInstruction,pe as createLogger,em as createPlatformConfig,dl as createPoolFeeLayout,Va as createPoolV4InstructionV2,_B as createPoolV4Layout,Jl as createVestingAccount,_n as createWSolAccountInstructions,ik as cstr,gg as currencyEquals,Sd as decimalToFraction,ef as decodeBool,qg as div,ar as divCeil,kt as dwLayout,tf as encodeBool,rw as endlessRetry,hd as eq,Jw as f32,ek as f32be,tk as f64,nk as f64be,ca as farmAddRewardLayout,uh as farmLedgerLayoutV3_1,ri as farmLedgerLayoutV3_2,ch as farmLedgerLayoutV5_1,Ic as farmLedgerLayoutV5_2,Bc as farmLedgerLayoutV6_1,vc as farmRewardInfoToConfig,aa as farmRewardLayout,ua as farmRewardRestartLayout,wf as farmRewardTimeInfoLayout,hc as farmStateV3Layout,Tc as farmStateV5Layout,ii as farmStateV6Layout,vh as fetchMultipleFarmInfoAndUpdate,Bx as fetchMultipleInfo,po as fetchMultipleMintInfos,ee as findProgramAddress,Na as fixedSwapInLayout,Oa as fixedSwapOutLayout,Ms as floorDiv,dr as forecastTransactionSize,by as formatLayout,Ue as generatePubKey,Z as getATAAddress,Oc as getAssociatedAuthority,Wr as getAssociatedConfigId,bt as getAssociatedLedgerAccount,ai as getAssociatedLedgerPoolAccount,Iy as getAssociatedOpenOrders,Ua as getAssociatedPoolKeys,jr as getCpLockPda,IK as getCpmmPdaAmmConfigId,Qa as getCpmmPdaPoolId,Ll as getCreatePoolKeys,Wu as getDate,Pa as getDepositEntryIndex,bl as getDxByDyBaseIn,yl as getDyByDxBaseIn,FA as getEpochInfo,Bo as getFarmLedgerLayout,If as getFarmStateLayout,qa as getLiquidityAssociatedAuthority,ro as getLiquidityAssociatedId,II as getLiquidityFromAmounts,Xg as getMax,qt as getMultipleAccountsInfo,Ke as getMultipleAccountsInfoWithCustomFlags,Ds as getMultipleLookupTableInfo,VT as getPdaAmmConfigId,Mo as getPdaCpiEvent,Ge as getPdaExBitmapAccount,lo as getPdaLaunchpadAuth,a1 as getPdaLaunchpadConfigId,ns as getPdaLaunchpadPoolId,ru as getPdaLaunchpadVaultId,Ai as getPdaLockClPositionIdV2,Ba as getPdaLockPositionId,_y as getPdaLpMint,hn as getPdaMetadataKey,xa as getPdaMintExAccount,$c as getPdaObservationAccount,Oi as getPdaObservationId,gi as getPdaOperationAccount,Tt as getPdaPersonalPositionAddress,su as getPdaPlatformId,No as getPdaPoolAuthority,Yc as getPdaPoolId,Zc as getPdaPoolRewardVaulId,Ia as getPdaPoolVaultId,tn as getPdaProtocolPositionAddress,ge as getPdaTickArrayAddress,Cl as getPdaVault,au as getPdaVestId,go as getRecentBlockHash,da as getRegistrarAddress,tp as getSessionKey,gl as getStablePrice,Cd as getTime,$g as getTimestamp,ga as getTokenOwnerRecordAddress,jA as getTransferAmountFee,ke as getTransferAmountFeeV2,ya as getVoterAddress,ba as getVoterWeightRecordAddress,fa as getVotingMintAuthority,pa as getVotingTokenMint,Of as governanceCreateTokenOwnerRecord,Rw as greedy,kd as gt,Dg as gte,Ac as i128,vT as i16ToBytes,Mr as i32ToBytes,ho as i64,gc as i8,va as initPoolLayout,oa as initTokenAccountInstruction,jl as initialize,Ky as initializeMarket,TA as intersection,qu as isDateAfter,Du as isDateBefore,Kd as isDecimal,Gg as isMeaningfulNumber,Vu as isNumber,la as isValidFarmVersion,bi as isZero,Re as jsonInfo2PoolKeys,Mh as judgeFarmType,ha as leadingZeros,Hc as leastSignificantBit,no as liquidityStateV4Layout,iy as liquidityStateV5Layout,Vg as lt,Wg as lte,og as mSOLMint,Vr as makeAMMSwapInstruction,wl as makeAddLiquidityInstruction,ka as makeAddNewRewardInstruction,ts as makeClaimInstruction,iu as makeClaimInstructionV4,El as makeCpmmLockInstruction,Nl as makeCreateCpmmPoolInInstruction,Mc as makeCreateFarmInstruction,qr as makeCreateMarketInstruction,Ec as makeCreatorWithdrawFarmRewardInstruction,Ol as makeDepositCpmmInInstruction,Fc as makeDepositInstructionV3,Vc as makeDepositInstructionV5,Wc as makeDepositInstructionV6,Zh as makeDepositTokenInstruction,Jh as makeDepositWithdrawInstruction,tx as makeInitPoolInstructionV4,q0 as makePurchaseInstruction,wa as makeRestartRewardInstruction,kl as makeSimulatePoolInfoInstruction,Yr as makeSwapCpmmBaseInInstruction,Ml as makeSwapCpmmBaseOutInstruction,Py as makeSwapFixedInInstruction,wy as makeSwapFixedOutInstruction,Gl as makeSwapInstruction,kc as makeTransferInstruction,vl as makeWithdrawCpmmInInstruction,di as makeWithdrawInstructionV3,_c as makeWithdrawInstructionV4,mi as makeWithdrawInstructionV5,li as makeWithdrawInstructionV6,$h as makeWithdrawTokenInstruction,jt as minExpirationTime,RT as mockCreatePoolInfo,Qc as mockV3CreatePoolInfo,ay as modelDataInfoLayout,zc as mostSignificantBit,Os as mul,vs as notInnerObject,Qw as ns64,$w as ns64be,dc as nu64,Ww as nu64be,$s as offset,kA as offsetDateTime,lk as option,Y as parseBigNumberish,Hn as parseNumberInfo,Hu as parseSimulateLogToJson,An as parseSimulateValue,wc as parseTokenAccountResp,TB as parseTokenInfo,Vn as poolTypeV6,jn as printSimulate,L as publicKey,tu as purchaseLayout,gf as realFarmStateV3Layout,Af as realFarmStateV5Layout,Pf as realFarmV6Layout,Eu as recursivelyDecimalToFraction,Fa as removeLiquidityInstruction,Ea as removeLiquidityLayout,QC as route1Instruction,zC as route2Instruction,Xy as routeInstruction,pk as rustEnum,qw as s16,zw as s16be,Uw as s24,Hw as s24be,Oe as s32,jw as s32be,Gw as s40,Yw as s40be,Xw as s48,Zw as s48be,Dw as s8,Zl as sellExactInInstruction,A1 as sellExactOut,X as seq,lb as setLoggerLevel,Bd as shakeFractionDecimal,zu as simulateMultipleInstruction,ex as simulatePoolInfoInstruction,Nd as simulateTransaction,vu as sleep,ft as solToWSol,BB as solToWSolToken,en as splAccountLayout,Lu as splitNumber,ig as stSOLMint,Jt as str,N as struct,Ug as sub,HC as swapBaseInAutoAccount,jC as swapBaseOutAutoAccount,dk as tagged,Ns as tenExponential,Dr as toAmmComputePoolInfo,At as toApiV3Token,xd as toBN,ju as toBuffer,Wn as toFeeConfig,Fu as toFraction,Fg as toFractionWithDecimals,gA as toPercent,_r as toToken,Ii as toTokenAmount,IB as toTokenInfo,AA as toTokenPrice,PA as toTotalPrice,Mu as toUsdCurrency,Ta as trailingZeros,VA as transformTxToBase64,Ss as tryParsePublicKey,Od as txToBase64,$ as u128,$t as u16,vr as u16ToBytes,Mw as u16be,Nw as u24,Ew as u24be,lt as u32,MT as u32ToBytes,_w as u32be,Ow as u40,Fw as u40be,vw as u48,Vw as u48be,P as u64,F as u8,ob as u8ToBytes,yk as union,eR as unionArr,ok as unionLayoutDiscriminator,BA as uniq,Bf as updateFarmPoolInfo,tm as updatePlatformConfig,wr as updateReqHistory,rk as utf8,xs as validateAndParsePublicKey,ma as validateFarmRewards,mk as vec,nf as vecU8,Mf as voterStakeRegistryCreateDepositEntry,vf as voterStakeRegistryCreateVoter,Lf as voterStakeRegistryDeposit,Rf as voterStakeRegistryUpdateVoterWeightRecord,Nf as voterStakeRegistryWithdraw,xB as wSolToSolToken,sa as withdrawRewardLayout,IA as xor,bk as zeros};
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=index.mjs.map