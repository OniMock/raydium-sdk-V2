var sm=Object.defineProperty;var am=(i,e,t)=>e in i?sm(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var Rt=(i,e,t)=>(am(i,typeof e!="symbol"?e+"":e,t),t);import tc from"axios";import{PublicKey as pu}from"@solana/web3.js";import{get as ms,set as mu}from"lodash";var um=(o=>(o[o.Error=0]="Error",o[o.Warning=1]="Warning",o[o.Info=2]="Info",o[o.Debug=3]="Debug",o))(um||{}),ds=class{logLevel;name;constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},ps={},du={};function de(i){let e=ms(ps,i);if(!e){let t=ms(du,i);e=new ds({name:i,logLevel:t}),mu(ps,i,e)}return e}function cb(i,e){mu(du,i,e);let t=ms(ps,i);t&&(t.level=e)}import{MINT_SIZE as cm,TOKEN_PROGRAM_ID as lm,getTransferFeeConfig as mm,unpackMint as dm}from"@solana/spl-token";var fs=de("Raydium_accountInfo_util");async function Dt(i,e,t){let{batchRequest:n,commitment:o="confirmed",chunkCount:r=100}={batchRequest:!1,...t},s=ys(e,r),a=new Array(s.length).fill([]);if(n){let c=s.map(d=>{let m=i._buildArgs([d.map(p=>p.toBase58())],o,"base64");return{methodName:"getMultipleAccounts",args:m}}),u=ys(c,10);a=(await(await Promise.all(u.map(async d=>await i._rpcBatchRequest(d)))).flat()).map(d=>(d.error&&fs.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${d.error.message}`),d.result.value.map(m=>{if(m){let{data:p,executable:y,lamports:f,owner:b,rentEpoch:g}=m;return p.length!==2&&p[1]!=="base64"&&fs.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(p[0],"base64"),executable:y,lamports:f,owner:new pu(b),rentEpoch:g}}return null})))}else try{a=await Promise.all(s.map(c=>i.getMultipleAccountsInfo(c,o)))}catch(c){c instanceof Error&&fs.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${c.message}`)}return a.flat()}async function Ke(i,e,t){let n=await Dt(i,e.map(o=>o.pubkey),t);return e.map((o,r)=>({...o,accountInfo:n[r]}))}var pm=(n=>(n[n.Uninitialized=0]="Uninitialized",n[n.Mint=1]="Mint",n[n.Account=2]="Account",n))(pm||{}),Pb=1;async function mo({connection:i,mints:e,config:t}){if(e.length===0)return{};let n=await Ke(i,e.map(r=>({pubkey:pt(r)})),t),o={};for(let r of n){if(!r.accountInfo||r.accountInfo.data.length<cm){console.log("invalid mint account",r.pubkey.toBase58());continue}let s=dm(r.pubkey,r.accountInfo,r.accountInfo?.owner);o[r.pubkey.toString()]={...s,programId:r.accountInfo?.owner||lm,feeConfig:mm(s)??void 0}}return o[pu.default.toBase58()]=o[j.toBase58()],o}import qe from"bn.js";var po=9e15,Ln=1e9,bs="0123456789abcdef",Hi="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",ji="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",gs={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-po,maxE:po,crypto:!1},gu,yn,ue=!0,Zi="[DecimalError] ",Cn=Zi+"Invalid argument: ",Pu=Zi+"Precision limit exceeded",Au=Zi+"crypto unavailable",wu="[object Decimal]",ft=Math.floor,Ze=Math.pow,fm=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,ym=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,bm=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,ku=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,Ut=1e7,oe=7,gm=9007199254740991,Pm=Hi.length-1,Ps=ji.length-1,W={toStringTag:wu};W.absoluteValue=W.abs=function(){var i=new this.constructor(this);return i.s<0&&(i.s=1),ee(i)};W.ceil=function(){return ee(new this.constructor(this),this.e+1,2)};W.clampedTo=W.clamp=function(i,e){var t,n=this,o=n.constructor;if(i=new o(i),e=new o(e),!i.s||!e.s)return new o(NaN);if(i.gt(e))throw Error(Cn+e);return t=n.cmp(i),t<0?i:n.cmp(e)>0?e:new o(n)};W.comparedTo=W.cmp=function(i){var e,t,n,o,r=this,s=r.d,a=(i=new r.constructor(i)).d,c=r.s,u=i.s;if(!s||!a)return!c||!u?NaN:c!==u?c:s===a?0:!s^c<0?1:-1;if(!s[0]||!a[0])return s[0]?c:a[0]?-u:0;if(c!==u)return c;if(r.e!==i.e)return r.e>i.e^c<0?1:-1;for(n=s.length,o=a.length,e=0,t=n<o?n:o;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^c<0?1:-1;return n===o?0:n>o^c<0?1:-1};W.cosine=W.cos=function(){var i,e,t=this,n=t.constructor;return t.d?t.d[0]?(i=n.precision,e=n.rounding,n.precision=i+Math.max(t.e,t.sd())+oe,n.rounding=1,t=Am(n,xu(n,t)),n.precision=i,n.rounding=e,ee(yn==2||yn==3?t.neg():t,i,e,!0)):new n(1):new n(NaN)};W.cubeRoot=W.cbrt=function(){var i,e,t,n,o,r,s,a,c,u,l=this,d=l.constructor;if(!l.isFinite()||l.isZero())return new d(l);for(ue=!1,r=l.s*Ze(l.s*l,1/3),!r||Math.abs(r)==1/0?(t=at(l.d),i=l.e,(r=(i-t.length+1)%3)&&(t+=r==1||r==-2?"0":"00"),r=Ze(t,1/3),i=ft((i+1)/3)-(i%3==(i<0?-1:2)),r==1/0?t="5e"+i:(t=r.toExponential(),t=t.slice(0,t.indexOf("e")+1)+i),n=new d(t),n.s=l.s):n=new d(r.toString()),s=(i=d.precision)+3;;)if(a=n,c=a.times(a).times(a),u=c.plus(l),n=Ce(u.plus(l).times(a),u.plus(c),s+2,1),at(a.d).slice(0,s)===(t=at(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!o&&t=="4999"){if(!o&&(ee(a,i+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,o=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&(ee(n,i+1,1),e=!n.times(n).times(n).eq(l));break}return ue=!0,ee(n,i,d.rounding,e)};W.decimalPlaces=W.dp=function(){var i,e=this.d,t=NaN;if(e){if(i=e.length-1,t=(i-ft(this.e/oe))*oe,i=e[i],i)for(;i%10==0;i/=10)t--;t<0&&(t=0)}return t};W.dividedBy=W.div=function(i){return Ce(this,new this.constructor(i))};W.dividedToIntegerBy=W.divToInt=function(i){var e=this,t=e.constructor;return ee(Ce(e,new t(i),0,1,1),t.precision,t.rounding)};W.equals=W.eq=function(i){return this.cmp(i)===0};W.floor=function(){return ee(new this.constructor(this),this.e+1,3)};W.greaterThan=W.gt=function(i){return this.cmp(i)>0};W.greaterThanOrEqualTo=W.gte=function(i){var e=this.cmp(i);return e==1||e===0};W.hyperbolicCosine=W.cosh=function(){var i,e,t,n,o,r=this,s=r.constructor,a=new s(1);if(!r.isFinite())return new s(r.s?1/0:NaN);if(r.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(r.e,r.sd())+4,s.rounding=1,o=r.d.length,o<32?(i=Math.ceil(o/3),e=(1/Ji(4,i)).toString()):(i=16,e="2.3283064365386962890625e-10"),r=fo(s,1,r.times(e),new s(1),!0);for(var c,u=i,l=new s(8);u--;)c=r.times(r),r=a.minus(c.times(l.minus(c.times(l))));return ee(r,s.precision=t,s.rounding=n,!0)};W.hyperbolicSine=W.sinh=function(){var i,e,t,n,o=this,r=o.constructor;if(!o.isFinite()||o.isZero())return new r(o);if(e=r.precision,t=r.rounding,r.precision=e+Math.max(o.e,o.sd())+4,r.rounding=1,n=o.d.length,n<3)o=fo(r,2,o,o,!0);else{i=1.4*Math.sqrt(n),i=i>16?16:i|0,o=o.times(1/Ji(5,i)),o=fo(r,2,o,o,!0);for(var s,a=new r(5),c=new r(16),u=new r(20);i--;)s=o.times(o),o=o.times(a.plus(s.times(c.times(s).plus(u))))}return r.precision=e,r.rounding=t,ee(o,e,t,!0)};W.hyperbolicTangent=W.tanh=function(){var i,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+7,n.rounding=1,Ce(t.sinh(),t.cosh(),n.precision=i,n.rounding=e)):new n(t.s)};W.inverseCosine=W.acos=function(){var i,e=this,t=e.constructor,n=e.abs().cmp(1),o=t.precision,r=t.rounding;return n!==-1?n===0?e.isNeg()?qt(t,o,r):new t(0):new t(NaN):e.isZero()?qt(t,o+4,r).times(.5):(t.precision=o+6,t.rounding=1,e=e.asin(),i=qt(t,o+4,r).times(.5),t.precision=o,t.rounding=r,i.minus(e))};W.inverseHyperbolicCosine=W.acosh=function(){var i,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(i=n.precision,e=n.rounding,n.precision=i+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,ue=!1,t=t.times(t).minus(1).sqrt().plus(t),ue=!0,n.precision=i,n.rounding=e,t.ln()):new n(t)};W.inverseHyperbolicSine=W.asinh=function(){var i,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,ue=!1,t=t.times(t).plus(1).sqrt().plus(t),ue=!0,n.precision=i,n.rounding=e,t.ln())};W.inverseHyperbolicTangent=W.atanh=function(){var i,e,t,n,o=this,r=o.constructor;return o.isFinite()?o.e>=0?new r(o.abs().eq(1)?o.s/0:o.isZero()?o:NaN):(i=r.precision,e=r.rounding,n=o.sd(),Math.max(n,i)<2*-o.e-1?ee(new r(o),i,e,!0):(r.precision=t=n-o.e,o=Ce(o.plus(1),new r(1).minus(o),t+i,1),r.precision=i+4,r.rounding=1,o=o.ln(),r.precision=i,r.rounding=e,o.times(.5))):new r(NaN)};W.inverseSine=W.asin=function(){var i,e,t,n,o=this,r=o.constructor;return o.isZero()?new r(o):(e=o.abs().cmp(1),t=r.precision,n=r.rounding,e!==-1?e===0?(i=qt(r,t+4,n).times(.5),i.s=o.s,i):new r(NaN):(r.precision=t+6,r.rounding=1,o=o.div(new r(1).minus(o.times(o)).sqrt().plus(1)).atan(),r.precision=t,r.rounding=n,o.times(2)))};W.inverseTangent=W.atan=function(){var i,e,t,n,o,r,s,a,c,u=this,l=u.constructor,d=l.precision,m=l.rounding;if(u.isFinite()){if(u.isZero())return new l(u);if(u.abs().eq(1)&&d+4<=Ps)return s=qt(l,d+4,m).times(.25),s.s=u.s,s}else{if(!u.s)return new l(NaN);if(d+4<=Ps)return s=qt(l,d+4,m).times(.5),s.s=u.s,s}for(l.precision=a=d+10,l.rounding=1,t=Math.min(28,a/oe+2|0),i=t;i;--i)u=u.div(u.times(u).plus(1).sqrt().plus(1));for(ue=!1,e=Math.ceil(a/oe),n=1,c=u.times(u),s=new l(u),o=u;i!==-1;)if(o=o.times(c),r=s.minus(o.div(n+=2)),o=o.times(c),s=r.plus(o.div(n+=2)),s.d[e]!==void 0)for(i=e;s.d[i]===r.d[i]&&i--;);return t&&(s=s.times(2<<t-1)),ue=!0,ee(s,l.precision=d,l.rounding=m,!0)};W.isFinite=function(){return!!this.d};W.isInteger=W.isInt=function(){return!!this.d&&ft(this.e/oe)>this.d.length-2};W.isNaN=function(){return!this.s};W.isNegative=W.isNeg=function(){return this.s<0};W.isPositive=W.isPos=function(){return this.s>0};W.isZero=function(){return!!this.d&&this.d[0]===0};W.lessThan=W.lt=function(i){return this.cmp(i)<0};W.lessThanOrEqualTo=W.lte=function(i){return this.cmp(i)<1};W.logarithm=W.log=function(i){var e,t,n,o,r,s,a,c,u=this,l=u.constructor,d=l.precision,m=l.rounding,p=5;if(i==null)i=new l(10),e=!0;else{if(i=new l(i),t=i.d,i.s<0||!t||!t[0]||i.eq(1))return new l(NaN);e=i.eq(10)}if(t=u.d,u.s<0||!t||!t[0]||u.eq(1))return new l(t&&!t[0]?-1/0:u.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)r=!0;else{for(o=t[0];o%10===0;)o/=10;r=o!==1}if(ue=!1,a=d+p,s=Kn(u,a),n=e?Yi(l,a+10):Kn(i,a),c=Ce(s,n,a,1),_o(c.d,o=d,m))do if(a+=10,s=Kn(u,a),n=e?Yi(l,a+10):Kn(i,a),c=Ce(s,n,a,1),!r){+at(c.d).slice(o+1,o+15)+1==1e14&&(c=ee(c,d+1,0));break}while(_o(c.d,o+=10,m));return ue=!0,ee(c,d,m)};W.minus=W.sub=function(i){var e,t,n,o,r,s,a,c,u,l,d,m,p=this,y=p.constructor;if(i=new y(i),!p.d||!i.d)return!p.s||!i.s?i=new y(NaN):p.d?i.s=-i.s:i=new y(i.d||p.s!==i.s?p:NaN),i;if(p.s!=i.s)return i.s=-i.s,p.plus(i);if(u=p.d,m=i.d,a=y.precision,c=y.rounding,!u[0]||!m[0]){if(m[0])i.s=-i.s;else if(u[0])i=new y(p);else return new y(c===3?-0:0);return ue?ee(i,a,c):i}if(t=ft(i.e/oe),l=ft(p.e/oe),u=u.slice(),r=l-t,r){for(d=r<0,d?(e=u,r=-r,s=m.length):(e=m,t=l,s=u.length),n=Math.max(Math.ceil(a/oe),s)+2,r>n&&(r=n,e.length=1),e.reverse(),n=r;n--;)e.push(0);e.reverse()}else{for(n=u.length,s=m.length,d=n<s,d&&(s=n),n=0;n<s;n++)if(u[n]!=m[n]){d=u[n]<m[n];break}r=0}for(d&&(e=u,u=m,m=e,i.s=-i.s),s=u.length,n=m.length-s;n>0;--n)u[s++]=0;for(n=m.length;n>r;){if(u[--n]<m[n]){for(o=n;o&&u[--o]===0;)u[o]=Ut-1;--u[o],u[n]+=Ut}u[n]-=m[n]}for(;u[--s]===0;)u.pop();for(;u[0]===0;u.shift())--t;return u[0]?(i.d=u,i.e=$i(u,t),ue?ee(i,a,c):i):new y(c===3?-0:0)};W.modulo=W.mod=function(i){var e,t=this,n=t.constructor;return i=new n(i),!t.d||!i.s||i.d&&!i.d[0]?new n(NaN):!i.d||t.d&&!t.d[0]?ee(new n(t),n.precision,n.rounding):(ue=!1,n.modulo==9?(e=Ce(t,i.abs(),0,3,1),e.s*=i.s):e=Ce(t,i,0,n.modulo,1),e=e.times(i),ue=!0,t.minus(e))};W.naturalExponential=W.exp=function(){return As(this)};W.naturalLogarithm=W.ln=function(){return Kn(this)};W.negated=W.neg=function(){var i=new this.constructor(this);return i.s=-i.s,ee(i)};W.plus=W.add=function(i){var e,t,n,o,r,s,a,c,u,l,d=this,m=d.constructor;if(i=new m(i),!d.d||!i.d)return!d.s||!i.s?i=new m(NaN):d.d||(i=new m(i.d||d.s===i.s?d:NaN)),i;if(d.s!=i.s)return i.s=-i.s,d.minus(i);if(u=d.d,l=i.d,a=m.precision,c=m.rounding,!u[0]||!l[0])return l[0]||(i=new m(d)),ue?ee(i,a,c):i;if(r=ft(d.e/oe),n=ft(i.e/oe),u=u.slice(),o=r-n,o){for(o<0?(t=u,o=-o,s=l.length):(t=l,n=r,s=u.length),r=Math.ceil(a/oe),s=r>s?r+1:s+1,o>s&&(o=s,t.length=1),t.reverse();o--;)t.push(0);t.reverse()}for(s=u.length,o=l.length,s-o<0&&(o=s,t=l,l=u,u=t),e=0;o;)e=(u[--o]=u[o]+l[o]+e)/Ut|0,u[o]%=Ut;for(e&&(u.unshift(e),++n),s=u.length;u[--s]==0;)u.pop();return i.d=u,i.e=$i(u,n),ue?ee(i,a,c):i};W.precision=W.sd=function(i){var e,t=this;if(i!==void 0&&i!==!!i&&i!==1&&i!==0)throw Error(Cn+i);return t.d?(e=hu(t.d),i&&t.e+1>e&&(e=t.e+1)):e=NaN,e};W.round=function(){var i=this,e=i.constructor;return ee(new e(i),i.e+1,e.rounding)};W.sine=W.sin=function(){var i,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+Math.max(t.e,t.sd())+oe,n.rounding=1,t=km(n,xu(n,t)),n.precision=i,n.rounding=e,ee(yn>2?t.neg():t,i,e,!0)):new n(NaN)};W.squareRoot=W.sqrt=function(){var i,e,t,n,o,r,s=this,a=s.d,c=s.e,u=s.s,l=s.constructor;if(u!==1||!a||!a[0])return new l(!u||u<0&&(!a||a[0])?NaN:a?s:1/0);for(ue=!1,u=Math.sqrt(+s),u==0||u==1/0?(e=at(a),(e.length+c)%2==0&&(e+="0"),u=Math.sqrt(e),c=ft((c+1)/2)-(c<0||c%2),u==1/0?e="5e"+c:(e=u.toExponential(),e=e.slice(0,e.indexOf("e")+1)+c),n=new l(e)):n=new l(u.toString()),t=(c=l.precision)+3;;)if(r=n,n=r.plus(Ce(s,r,t+2,1)).times(.5),at(r.d).slice(0,t)===(e=at(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!o&&e=="4999"){if(!o&&(ee(r,c+1,0),r.times(r).eq(s))){n=r;break}t+=4,o=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&(ee(n,c+1,1),i=!n.times(n).eq(s));break}return ue=!0,ee(n,c,l.rounding,i)};W.tangent=W.tan=function(){var i,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(i=n.precision,e=n.rounding,n.precision=i+10,n.rounding=1,t=t.sin(),t.s=1,t=Ce(t,new n(1).minus(t.times(t)).sqrt(),i+10,0),n.precision=i,n.rounding=e,ee(yn==2||yn==4?t.neg():t,i,e,!0)):new n(NaN)};W.times=W.mul=function(i){var e,t,n,o,r,s,a,c,u,l=this,d=l.constructor,m=l.d,p=(i=new d(i)).d;if(i.s*=l.s,!m||!m[0]||!p||!p[0])return new d(!i.s||m&&!m[0]&&!p||p&&!p[0]&&!m?NaN:!m||!p?i.s/0:i.s*0);for(t=ft(l.e/oe)+ft(i.e/oe),c=m.length,u=p.length,c<u&&(r=m,m=p,p=r,s=c,c=u,u=s),r=[],s=c+u,n=s;n--;)r.push(0);for(n=u;--n>=0;){for(e=0,o=c+n;o>n;)a=r[o]+p[n]*m[o-n-1]+e,r[o--]=a%Ut|0,e=a/Ut|0;r[o]=(r[o]+e)%Ut|0}for(;!r[--s];)r.pop();return e?++t:r.shift(),i.d=r,i.e=$i(r,t),ue?ee(i,d.precision,d.rounding):i};W.toBinary=function(i,e){return ks(this,2,i,e)};W.toDecimalPlaces=W.toDP=function(i,e){var t=this,n=t.constructor;return t=new n(t),i===void 0?t:(It(i,0,Ln),e===void 0?e=n.rounding:It(e,0,8),ee(t,i+t.e+1,e))};W.toExponential=function(i,e){var t,n=this,o=n.constructor;return i===void 0?t=on(n,!0):(It(i,0,Ln),e===void 0?e=o.rounding:It(e,0,8),n=ee(new o(n),i+1,e),t=on(n,!0,i+1)),n.isNeg()&&!n.isZero()?"-"+t:t};W.toFixed=function(i,e){var t,n,o=this,r=o.constructor;return i===void 0?t=on(o):(It(i,0,Ln),e===void 0?e=r.rounding:It(e,0,8),n=ee(new r(o),i+o.e+1,e),t=on(n,!1,i+n.e+1)),o.isNeg()&&!o.isZero()?"-"+t:t};W.toFraction=function(i){var e,t,n,o,r,s,a,c,u,l,d,m,p=this,y=p.d,f=p.constructor;if(!y)return new f(p);if(u=t=new f(1),n=c=new f(0),e=new f(n),r=e.e=hu(y)-p.e-1,s=r%oe,e.d[0]=Ze(10,s<0?oe+s:s),i==null)i=r>0?e:u;else{if(a=new f(i),!a.isInt()||a.lt(u))throw Error(Cn+a);i=a.gt(e)?r>0?e:u:a}for(ue=!1,a=new f(at(y)),l=f.precision,f.precision=r=y.length*oe*2;d=Ce(a,e,0,1,1),o=t.plus(d.times(n)),o.cmp(i)!=1;)t=n,n=o,o=u,u=c.plus(d.times(o)),c=o,o=e,e=a.minus(d.times(o)),a=o;return o=Ce(i.minus(t),n,0,1,1),c=c.plus(o.times(u)),t=t.plus(o.times(n)),c.s=u.s=p.s,m=Ce(u,n,r,1).minus(p).abs().cmp(Ce(c,t,r,1).minus(p).abs())<1?[u,n]:[c,t],f.precision=l,ue=!0,m};W.toHexadecimal=W.toHex=function(i,e){return ks(this,16,i,e)};W.toNearest=function(i,e){var t=this,n=t.constructor;if(t=new n(t),i==null){if(!t.d)return t;i=new n(1),e=n.rounding}else{if(i=new n(i),e===void 0?e=n.rounding:It(e,0,8),!t.d)return i.s?t:i;if(!i.d)return i.s&&(i.s=t.s),i}return i.d[0]?(ue=!1,t=Ce(t,i,0,e,1).times(i),ue=!0,ee(t)):(i.s=t.s,t=i),t};W.toNumber=function(){return+this};W.toOctal=function(i,e){return ks(this,8,i,e)};W.toPower=W.pow=function(i){var e,t,n,o,r,s,a=this,c=a.constructor,u=+(i=new c(i));if(!a.d||!i.d||!a.d[0]||!i.d[0])return new c(Ze(+a,u));if(a=new c(a),a.eq(1))return a;if(n=c.precision,r=c.rounding,i.eq(1))return ee(a,n,r);if(e=ft(i.e/oe),e>=i.d.length-1&&(t=u<0?-u:u)<=gm)return o=Tu(c,a,t,n),i.s<0?new c(1).div(o):ee(o,n,r);if(s=a.s,s<0){if(e<i.d.length-1)return new c(NaN);if((i.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=Ze(+a,u),e=t==0||!isFinite(t)?ft(u*(Math.log("0."+at(a.d))/Math.LN10+a.e+1)):new c(t+"").e,e>c.maxE+1||e<c.minE-1?new c(e>0?s/0:0):(ue=!1,c.rounding=a.s=1,t=Math.min(12,(e+"").length),o=As(i.times(Kn(a,n+t)),n),o.d&&(o=ee(o,n+5,1),_o(o.d,n,r)&&(e=n+10,o=ee(As(i.times(Kn(a,e+t)),e),e+5,1),+at(o.d).slice(n+1,n+15)+1==1e14&&(o=ee(o,n+1,0)))),o.s=s,ue=!0,c.rounding=r,ee(o,n,r))};W.toPrecision=function(i,e){var t,n=this,o=n.constructor;return i===void 0?t=on(n,n.e<=o.toExpNeg||n.e>=o.toExpPos):(It(i,1,Ln),e===void 0?e=o.rounding:It(e,0,8),n=ee(new o(n),i,e),t=on(n,i<=n.e||n.e<=o.toExpNeg,i)),n.isNeg()&&!n.isZero()?"-"+t:t};W.toSignificantDigits=W.toSD=function(i,e){var t=this,n=t.constructor;return i===void 0?(i=n.precision,e=n.rounding):(It(i,1,Ln),e===void 0?e=n.rounding:It(e,0,8)),ee(new n(t),i,e)};W.toString=function(){var i=this,e=i.constructor,t=on(i,i.e<=e.toExpNeg||i.e>=e.toExpPos);return i.isNeg()&&!i.isZero()?"-"+t:t};W.truncated=W.trunc=function(){return ee(new this.constructor(this),this.e+1,1)};W.valueOf=W.toJSON=function(){var i=this,e=i.constructor,t=on(i,i.e<=e.toExpNeg||i.e>=e.toExpPos);return i.isNeg()?"-"+t:t};function at(i){var e,t,n,o=i.length-1,r="",s=i[0];if(o>0){for(r+=s,e=1;e<o;e++)n=i[e]+"",t=oe-n.length,t&&(r+=Sn(t)),r+=n;s=i[e],n=s+"",t=oe-n.length,t&&(r+=Sn(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return r+s}function It(i,e,t){if(i!==~~i||i<e||i>t)throw Error(Cn+i)}function _o(i,e,t,n){var o,r,s,a;for(r=i[0];r>=10;r/=10)--e;return--e<0?(e+=oe,o=0):(o=Math.ceil((e+1)/oe),e%=oe),r=Ze(10,oe-e),a=i[o]%r|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==r||t>3&&a+1==r/2)&&(i[o+1]/r/100|0)==Ze(10,e-2)-1||(a==r/2||a==0)&&(i[o+1]/r/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==r||!n&&t>3&&a+1==r/2)&&(i[o+1]/r/1e3|0)==Ze(10,e-3)-1,s}function zi(i,e,t){for(var n,o=[0],r,s=0,a=i.length;s<a;){for(r=o.length;r--;)o[r]*=e;for(o[0]+=bs.indexOf(i.charAt(s++)),n=0;n<o.length;n++)o[n]>t-1&&(o[n+1]===void 0&&(o[n+1]=0),o[n+1]+=o[n]/t|0,o[n]%=t)}return o.reverse()}function Am(i,e){var t,n,o;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),o=(1/Ji(4,t)).toString()):(t=16,o="2.3283064365386962890625e-10"),i.precision+=t,e=fo(i,1,e.times(o),new i(1));for(var r=t;r--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return i.precision-=t,e}var Ce=function(){function i(n,o,r){var s,a=0,c=n.length;for(n=n.slice();c--;)s=n[c]*o+a,n[c]=s%r|0,a=s/r|0;return a&&n.unshift(a),n}function e(n,o,r,s){var a,c;if(r!=s)c=r>s?1:-1;else for(a=c=0;a<r;a++)if(n[a]!=o[a]){c=n[a]>o[a]?1:-1;break}return c}function t(n,o,r,s){for(var a=0;r--;)n[r]-=a,a=n[r]<o[r]?1:0,n[r]=a*s+n[r]-o[r];for(;!n[0]&&n.length>1;)n.shift()}return function(n,o,r,s,a,c){var u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I,K,O,v,_=n.constructor,D=n.s==o.s?1:-1,q=n.d,G=o.d;if(!q||!q[0]||!G||!G[0])return new _(!n.s||!o.s||(q?G&&q[0]==G[0]:!G)?NaN:q&&q[0]==0||!G?D*0:D/0);for(c?(p=1,l=n.e-o.e):(c=Ut,p=oe,l=ft(n.e/p)-ft(o.e/p)),O=G.length,I=q.length,g=new _(D),w=g.d=[],d=0;G[d]==(q[d]||0);d++);if(G[d]>(q[d]||0)&&l--,r==null?(T=r=_.precision,s=_.rounding):a?T=r+(n.e-o.e)+1:T=r,T<0)w.push(1),y=!0;else{if(T=T/p+2|0,d=0,O==1){for(m=0,G=G[0],T++;(d<I||m)&&T--;d++)B=m*c+(q[d]||0),w[d]=B/G|0,m=B%G|0;y=m||d<I}else{for(m=c/(G[0]+1)|0,m>1&&(G=i(G,m,c),q=i(q,m,c),O=G.length,I=q.length),S=O,k=q.slice(0,O),h=k.length;h<O;)k[h++]=0;v=G.slice(),v.unshift(0),K=G[0],G[1]>=c/2&&++K;do m=0,u=e(G,k,O,h),u<0?(x=k[0],O!=h&&(x=x*c+(k[1]||0)),m=x/K|0,m>1?(m>=c&&(m=c-1),f=i(G,m,c),b=f.length,h=k.length,u=e(f,k,b,h),u==1&&(m--,t(f,O<b?v:G,b,c))):(m==0&&(u=m=1),f=G.slice()),b=f.length,b<h&&f.unshift(0),t(k,f,h,c),u==-1&&(h=k.length,u=e(G,k,O,h),u<1&&(m++,t(k,O<h?v:G,h,c))),h=k.length):u===0&&(m++,k=[0]),w[d++]=m,u&&k[0]?k[h++]=q[S]||0:(k=[q[S]],h=1);while((S++<I||k[0]!==void 0)&&T--);y=k[0]!==void 0}w[0]||w.shift()}if(p==1)g.e=l,gu=y;else{for(d=1,m=w[0];m>=10;m/=10)d++;g.e=d+l*p-1,ee(g,a?r+g.e+1:r,s,y)}return g}}();function ee(i,e,t,n){var o,r,s,a,c,u,l,d,m,p=i.constructor;e:if(e!=null){if(d=i.d,!d)return i;for(o=1,a=d[0];a>=10;a/=10)o++;if(r=e-o,r<0)r+=oe,s=e,l=d[m=0],c=l/Ze(10,o-s-1)%10|0;else if(m=Math.ceil((r+1)/oe),a=d.length,m>=a)if(n){for(;a++<=m;)d.push(0);l=c=0,o=1,r%=oe,s=r-oe+1}else break e;else{for(l=a=d[m],o=1;a>=10;a/=10)o++;r%=oe,s=r-oe+o,c=s<0?0:l/Ze(10,o-s-1)%10|0}if(n=n||e<0||d[m+1]!==void 0||(s<0?l:l%Ze(10,o-s-1)),u=t<4?(c||n)&&(t==0||t==(i.s<0?3:2)):c>5||c==5&&(t==4||n||t==6&&(r>0?s>0?l/Ze(10,o-s):0:d[m-1])%10&1||t==(i.s<0?8:7)),e<1||!d[0])return d.length=0,u?(e-=i.e+1,d[0]=Ze(10,(oe-e%oe)%oe),i.e=-e||0):d[0]=i.e=0,i;if(r==0?(d.length=m,a=1,m--):(d.length=m+1,a=Ze(10,oe-r),d[m]=s>0?(l/Ze(10,o-s)%Ze(10,s)|0)*a:0),u)for(;;)if(m==0){for(r=1,s=d[0];s>=10;s/=10)r++;for(s=d[0]+=a,a=1;s>=10;s/=10)a++;r!=a&&(i.e++,d[0]==Ut&&(d[0]=1));break}else{if(d[m]+=a,d[m]!=Ut)break;d[m--]=0,a=1}for(r=d.length;d[--r]===0;)d.pop()}return ue&&(i.e>p.maxE?(i.d=null,i.e=NaN):i.e<p.minE&&(i.e=0,i.d=[0])),i}function on(i,e,t){if(!i.isFinite())return Bu(i);var n,o=i.e,r=at(i.d),s=r.length;return e?(t&&(n=t-s)>0?r=r.charAt(0)+"."+r.slice(1)+Sn(n):s>1&&(r=r.charAt(0)+"."+r.slice(1)),r=r+(i.e<0?"e":"e+")+i.e):o<0?(r="0."+Sn(-o-1)+r,t&&(n=t-s)>0&&(r+=Sn(n))):o>=s?(r+=Sn(o+1-s),t&&(n=t-o-1)>0&&(r=r+"."+Sn(n))):((n=o+1)<s&&(r=r.slice(0,n)+"."+r.slice(n)),t&&(n=t-s)>0&&(o+1===s&&(r+="."),r+=Sn(n))),r}function $i(i,e){var t=i[0];for(e*=oe;t>=10;t/=10)e++;return e}function Yi(i,e,t){if(e>Pm)throw ue=!0,t&&(i.precision=t),Error(Pu);return ee(new i(Hi),e,1,!0)}function qt(i,e,t){if(e>Ps)throw Error(Pu);return ee(new i(ji),e,t,!0)}function hu(i){var e=i.length-1,t=e*oe+1;if(e=i[e],e){for(;e%10==0;e/=10)t--;for(e=i[0];e>=10;e/=10)t++}return t}function Sn(i){for(var e="";i--;)e+="0";return e}function Tu(i,e,t,n){var o,r=new i(1),s=Math.ceil(n/oe+4);for(ue=!1;;){if(t%2&&(r=r.times(e),yu(r.d,s)&&(o=!0)),t=ft(t/2),t===0){t=r.d.length-1,o&&r.d[t]===0&&++r.d[t];break}e=e.times(e),yu(e.d,s)}return ue=!0,r}function fu(i){return i.d[i.d.length-1]&1}function Iu(i,e,t){for(var n,o=new i(e[0]),r=0;++r<e.length;)if(n=new i(e[r]),n.s)o[t](n)&&(o=n);else{o=n;break}return o}function As(i,e){var t,n,o,r,s,a,c,u=0,l=0,d=0,m=i.constructor,p=m.rounding,y=m.precision;if(!i.d||!i.d[0]||i.e>17)return new m(i.d?i.d[0]?i.s<0?0:1/0:1:i.s?i.s<0?0:i:0/0);for(e==null?(ue=!1,c=y):c=e,a=new m(.03125);i.e>-2;)i=i.times(a),d+=5;for(n=Math.log(Ze(2,d))/Math.LN10*2+5|0,c+=n,t=r=s=new m(1),m.precision=c;;){if(r=ee(r.times(i),c,1),t=t.times(++l),a=s.plus(Ce(r,t,c,1)),at(a.d).slice(0,c)===at(s.d).slice(0,c)){for(o=d;o--;)s=ee(s.times(s),c,1);if(e==null)if(u<3&&_o(s.d,c-n,p,u))m.precision=c+=10,t=r=a=new m(1),l=0,u++;else return ee(s,m.precision=y,p,ue=!0);else return m.precision=y,s}s=a}}function Kn(i,e){var t,n,o,r,s,a,c,u,l,d,m,p=1,y=10,f=i,b=f.d,g=f.constructor,w=g.rounding,k=g.precision;if(f.s<0||!b||!b[0]||!f.e&&b[0]==1&&b.length==1)return new g(b&&!b[0]?-1/0:f.s!=1?NaN:b?0:f);if(e==null?(ue=!1,l=k):l=e,g.precision=l+=y,t=at(b),n=t.charAt(0),Math.abs(r=f.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)f=f.times(i),t=at(f.d),n=t.charAt(0),p++;r=f.e,n>1?(f=new g("0."+t),r++):f=new g(n+"."+t.slice(1))}else return u=Yi(g,l+2,k).times(r+""),f=Kn(new g(n+"."+t.slice(1)),l-y).plus(u),g.precision=k,e==null?ee(f,k,w,ue=!0):f;for(d=f,c=s=f=Ce(f.minus(1),f.plus(1),l,1),m=ee(f.times(f),l,1),o=3;;){if(s=ee(s.times(m),l,1),u=c.plus(Ce(s,new g(o),l,1)),at(u.d).slice(0,l)===at(c.d).slice(0,l))if(c=c.times(2),r!==0&&(c=c.plus(Yi(g,l+2,k).times(r+""))),c=Ce(c,new g(p),l,1),e==null)if(_o(c.d,l-y,w,a))g.precision=l+=y,u=s=f=Ce(d.minus(1),d.plus(1),l,1),m=ee(f.times(f),l,1),o=a=1;else return ee(c,g.precision=k,w,ue=!0);else return g.precision=k,c;c=u,o+=2}}function Bu(i){return String(i.s*i.s/0)}function ws(i,e){var t,n,o;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(o=e.length;e.charCodeAt(o-1)===48;--o);if(e=e.slice(n,o),e){if(o-=n,i.e=t=t-n-1,i.d=[],n=(t+1)%oe,t<0&&(n+=oe),n<o){for(n&&i.d.push(+e.slice(0,n)),o-=oe;n<o;)i.d.push(+e.slice(n,n+=oe));e=e.slice(n),n=oe-e.length}else n-=o;for(;n--;)e+="0";i.d.push(+e),ue&&(i.e>i.constructor.maxE?(i.d=null,i.e=NaN):i.e<i.constructor.minE&&(i.e=0,i.d=[0]))}else i.e=0,i.d=[0];return i}function wm(i,e){var t,n,o,r,s,a,c,u,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),ku.test(e))return ws(i,e)}else if(e==="Infinity"||e==="NaN")return+e||(i.s=NaN),i.e=NaN,i.d=null,i;if(ym.test(e))t=16,e=e.toLowerCase();else if(fm.test(e))t=2;else if(bm.test(e))t=8;else throw Error(Cn+e);for(r=e.search(/p/i),r>0?(c=+e.slice(r+1),e=e.substring(2,r)):e=e.slice(2),r=e.indexOf("."),s=r>=0,n=i.constructor,s&&(e=e.replace(".",""),a=e.length,r=a-r,o=Tu(n,new n(t),r,r*2)),u=zi(e,t,Ut),l=u.length-1,r=l;u[r]===0;--r)u.pop();return r<0?new n(i.s*0):(i.e=$i(u,l),i.d=u,ue=!1,s&&(i=Ce(i,o,a*4)),c&&(i=i.times(Math.abs(c)<54?Ze(2,c):Fo.pow(2,c))),ue=!0,i)}function km(i,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:fo(i,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/Ji(5,t)),e=fo(i,2,e,e);for(var o,r=new i(5),s=new i(16),a=new i(20);t--;)o=e.times(e),e=e.times(r.plus(o.times(s.times(o).minus(a))));return e}function fo(i,e,t,n,o){var r,s,a,c,u=1,l=i.precision,d=Math.ceil(l/oe);for(ue=!1,c=t.times(t),a=new i(n);;){if(s=Ce(a.times(c),new i(e++*e++),l,1),a=o?n.plus(s):n.minus(s),n=Ce(s.times(c),new i(e++*e++),l,1),s=a.plus(n),s.d[d]!==void 0){for(r=d;s.d[r]===a.d[r]&&r--;);if(r==-1)break}r=a,a=n,n=s,s=r,u++}return ue=!0,s.d.length=d+1,s}function Ji(i,e){for(var t=i;--e;)t*=i;return t}function xu(i,e){var t,n=e.s<0,o=qt(i,i.precision,1),r=o.times(.5);if(e=e.abs(),e.lte(r))return yn=n?4:1,e;if(t=e.divToInt(o),t.isZero())yn=n?3:2;else{if(e=e.minus(t.times(o)),e.lte(r))return yn=fu(t)?n?2:3:n?4:1,e;yn=fu(t)?n?1:4:n?3:2}return e.minus(o).abs()}function ks(i,e,t,n){var o,r,s,a,c,u,l,d,m,p=i.constructor,y=t!==void 0;if(y?(It(t,1,Ln),n===void 0?n=p.rounding:It(n,0,8)):(t=p.precision,n=p.rounding),!i.isFinite())l=Bu(i);else{for(l=on(i),s=l.indexOf("."),y?(o=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):o=e,s>=0&&(l=l.replace(".",""),m=new p(1),m.e=l.length-s,m.d=zi(on(m),10,o),m.e=m.d.length),d=zi(l,10,o),r=c=d.length;d[--c]==0;)d.pop();if(!d[0])l=y?"0p+0":"0";else{if(s<0?r--:(i=new p(i),i.d=d,i.e=r,i=Ce(i,m,t,n,0,o),d=i.d,r=i.e,u=gu),s=d[t],a=o/2,u=u||d[t+1]!==void 0,u=n<4?(s!==void 0||u)&&(n===0||n===(i.s<0?3:2)):s>a||s===a&&(n===4||u||n===6&&d[t-1]&1||n===(i.s<0?8:7)),d.length=t,u)for(;++d[--t]>o-1;)d[t]=0,t||(++r,d.unshift(1));for(c=d.length;!d[c-1];--c);for(s=0,l="";s<c;s++)l+=bs.charAt(d[s]);if(y){if(c>1)if(e==16||e==8){for(s=e==16?4:3,--c;c%s;c++)l+="0";for(d=zi(l,o,e),c=d.length;!d[c-1];--c);for(s=1,l="1.";s<c;s++)l+=bs.charAt(d[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(r<0?"p":"p+")+r}else if(r<0){for(;++r;)l="0"+l;l="0."+l}else if(++r>c)for(r-=c;r--;)l+="0";else r<c&&(l=l.slice(0,r)+"."+l.slice(r))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return i.s<0?"-"+l:l}function yu(i,e){if(i.length>e)return i.length=e,!0}function hm(i){return new this(i).abs()}function Tm(i){return new this(i).acos()}function Im(i){return new this(i).acosh()}function Bm(i,e){return new this(i).plus(e)}function xm(i){return new this(i).asin()}function Sm(i){return new this(i).asinh()}function Km(i){return new this(i).atan()}function Cm(i){return new this(i).atanh()}function Lm(i,e){i=new this(i),e=new this(e);var t,n=this.precision,o=this.rounding,r=n+4;return!i.s||!e.s?t=new this(NaN):!i.d&&!e.d?(t=qt(this,r,1).times(e.s>0?.25:.75),t.s=i.s):!e.d||i.isZero()?(t=e.s<0?qt(this,n,o):new this(0),t.s=i.s):!i.d||e.isZero()?(t=qt(this,r,1).times(.5),t.s=i.s):e.s<0?(this.precision=r,this.rounding=1,t=this.atan(Ce(i,e,r,1)),e=qt(this,r,1),this.precision=n,this.rounding=o,t=i.s<0?t.minus(e):t.plus(e)):t=this.atan(Ce(i,e,r,1)),t}function Rm(i){return new this(i).cbrt()}function Nm(i){return ee(i=new this(i),i.e+1,2)}function Om(i,e,t){return new this(i).clamp(e,t)}function vm(i){if(!i||typeof i!="object")throw Error(Zi+"Object expected");var e,t,n,o=i.defaults===!0,r=["precision",1,Ln,"rounding",0,8,"toExpNeg",-po,0,"toExpPos",0,po,"maxE",0,po,"minE",-po,0,"modulo",0,9];for(e=0;e<r.length;e+=3)if(t=r[e],o&&(this[t]=gs[t]),(n=i[t])!==void 0)if(ft(n)===n&&n>=r[e+1]&&n<=r[e+2])this[t]=n;else throw Error(Cn+t+": "+n);if(t="crypto",o&&(this[t]=gs[t]),(n=i[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(Au);else this[t]=!1;else throw Error(Cn+t+": "+n);return this}function Mm(i){return new this(i).cos()}function Em(i){return new this(i).cosh()}function Su(i){var e,t,n;function o(r){var s,a,c,u=this;if(!(u instanceof o))return new o(r);if(u.constructor=o,bu(r)){u.s=r.s,ue?!r.d||r.e>o.maxE?(u.e=NaN,u.d=null):r.e<o.minE?(u.e=0,u.d=[0]):(u.e=r.e,u.d=r.d.slice()):(u.e=r.e,u.d=r.d?r.d.slice():r.d);return}if(c=typeof r,c==="number"){if(r===0){u.s=1/r<0?-1:1,u.e=0,u.d=[0];return}if(r<0?(r=-r,u.s=-1):u.s=1,r===~~r&&r<1e7){for(s=0,a=r;a>=10;a/=10)s++;ue?s>o.maxE?(u.e=NaN,u.d=null):s<o.minE?(u.e=0,u.d=[0]):(u.e=s,u.d=[r]):(u.e=s,u.d=[r]);return}else if(r*0!==0){r||(u.s=NaN),u.e=NaN,u.d=null;return}return ws(u,r.toString())}else if(c!=="string")throw Error(Cn+r);return(a=r.charCodeAt(0))===45?(r=r.slice(1),u.s=-1):(a===43&&(r=r.slice(1)),u.s=1),ku.test(r)?ws(u,r):wm(u,r)}if(o.prototype=W,o.ROUND_UP=0,o.ROUND_DOWN=1,o.ROUND_CEIL=2,o.ROUND_FLOOR=3,o.ROUND_HALF_UP=4,o.ROUND_HALF_DOWN=5,o.ROUND_HALF_EVEN=6,o.ROUND_HALF_CEIL=7,o.ROUND_HALF_FLOOR=8,o.EUCLID=9,o.config=o.set=vm,o.clone=Su,o.isDecimal=bu,o.abs=hm,o.acos=Tm,o.acosh=Im,o.add=Bm,o.asin=xm,o.asinh=Sm,o.atan=Km,o.atanh=Cm,o.atan2=Lm,o.cbrt=Rm,o.ceil=Nm,o.clamp=Om,o.cos=Mm,o.cosh=Em,o.div=_m,o.exp=Fm,o.floor=Vm,o.hypot=Wm,o.ln=Dm,o.log=qm,o.log10=Gm,o.log2=Um,o.max=Xm,o.min=Qm,o.mod=zm,o.mul=Hm,o.pow=jm,o.random=Ym,o.round=Zm,o.sign=$m,o.sin=Jm,o.sinh=ed,o.sqrt=td,o.sub=nd,o.sum=od,o.tan=id,o.tanh=rd,o.trunc=sd,i===void 0&&(i={}),i&&i.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)i.hasOwnProperty(t=n[e++])||(i[t]=this[t]);return o.config(i),o}function _m(i,e){return new this(i).div(e)}function Fm(i){return new this(i).exp()}function Vm(i){return ee(i=new this(i),i.e+1,3)}function Wm(){var i,e,t=new this(0);for(ue=!1,i=0;i<arguments.length;)if(e=new this(arguments[i++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return ue=!0,new this(1/0);t=e}return ue=!0,t.sqrt()}function bu(i){return i instanceof Fo||i&&i.toStringTag===wu||!1}function Dm(i){return new this(i).ln()}function qm(i,e){return new this(i).log(e)}function Um(i){return new this(i).log(2)}function Gm(i){return new this(i).log(10)}function Xm(){return Iu(this,arguments,"lt")}function Qm(){return Iu(this,arguments,"gt")}function zm(i,e){return new this(i).mod(e)}function Hm(i,e){return new this(i).mul(e)}function jm(i,e){return new this(i).pow(e)}function Ym(i){var e,t,n,o,r=0,s=new this(1),a=[];if(i===void 0?i=this.precision:It(i,1,Ln),n=Math.ceil(i/oe),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));r<n;)o=e[r],o>=429e7?e[r]=crypto.getRandomValues(new Uint32Array(1))[0]:a[r++]=o%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);r<n;)o=e[r]+(e[r+1]<<8)+(e[r+2]<<16)+((e[r+3]&127)<<24),o>=214e7?crypto.randomBytes(4).copy(e,r):(a.push(o%1e7),r+=4);r=n/4}else throw Error(Au);else for(;r<n;)a[r++]=Math.random()*1e7|0;for(n=a[--r],i%=oe,n&&i&&(o=Ze(10,oe-i),a[r]=(n/o|0)*o);a[r]===0;r--)a.pop();if(r<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=oe)a.shift();for(n=1,o=a[0];o>=10;o/=10)n++;n<oe&&(t-=oe-n)}return s.e=t,s.d=a,s}function Zm(i){return ee(i=new this(i),i.e+1,this.rounding)}function $m(i){return i=new this(i),i.d?i.d[0]?i.s:0*i.s:i.s||NaN}function Jm(i){return new this(i).sin()}function ed(i){return new this(i).sinh()}function td(i){return new this(i).sqrt()}function nd(i,e){return new this(i).sub(e)}function od(){var i=0,e=arguments,t=new this(e[i]);for(ue=!1;t.s&&++i<e.length;)t=t.plus(e[i]);return ue=!0,ee(t,this.precision,this.rounding)}function id(i){return new this(i).tan()}function rd(i){return new this(i).tanh()}function sd(i){return ee(i=new this(i),i.e+1,1)}W[Symbol.for("nodejs.util.inspect.custom")]=W.toString;W[Symbol.toStringTag]="Decimal";var Fo=W.constructor=Su(gs);Hi=new Fo(Hi);ji=new Fo(ji);var C=Fo;import pd from"big.js";import Rn from"bn.js";import ad from"toformat";var ud=ad,Vo=ud;import tr from"big.js";import cd from"bn.js";import ld from"decimal.js-light";import Wo from"bn.js";var hs=(n=>(n[n.ROUND_DOWN=0]="ROUND_DOWN",n[n.ROUND_HALF_UP=1]="ROUND_HALF_UP",n[n.ROUND_UP=2]="ROUND_UP",n))(hs||{}),Ku=9007199254740991;function Y(i){let e=de("Raydium_parseBigNumberish");if(i instanceof Wo)return i;if(typeof i=="string"){if(i.match(/^-?[0-9]+$/))return new Wo(i);e.logWithError(`invalid BigNumberish string: ${i}`)}return typeof i=="number"?(i%1&&e.logWithError(`BigNumberish number underflow: ${i}`),(i>=Ku||i<=-Ku)&&e.logWithError(`BigNumberish number overflow: ${i}`),new Wo(String(i))):typeof i=="bigint"?new Wo(i.toString()):(e.error(`invalid BigNumberish value: ${i}`),new Wo(0))}var er=de("module/fraction"),Ts=Vo(tr),Do=Vo(ld),md={[0]:Do.ROUND_DOWN,[1]:Do.ROUND_HALF_UP,[2]:Do.ROUND_UP},dd={[0]:tr.roundDown,[1]:tr.roundHalfUp,[2]:tr.roundUp},le=class{numerator;denominator;constructor(e,t=new cd(1)){this.numerator=Y(e),this.denominator=Y(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new le(this.denominator,this.numerator)}add(e){let t=e instanceof le?e:new le(Y(e));return this.denominator.eq(t.denominator)?new le(this.numerator.add(t.numerator),this.denominator):new le(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof le?e:new le(Y(e));return this.denominator.eq(t.denominator)?new le(this.numerator.sub(t.numerator),this.denominator):new le(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof le?e:new le(Y(e));return new le(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof le?e:new le(Y(e));return new le(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||er.logWithError(`${e} is not an integer.`),e<=0&&er.logWithError(`${e} is not positive.`),Do.set({precision:e+1,rounding:md[n]});let o=new Do(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return o.toFormat(o.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||er.logWithError(`${e} is not an integer.`),e<0&&er.logWithError(`${e} is negative.`),Ts.DP=e,Ts.RM=dd[n]||1,new Ts(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var fd=de("Raydium_amount"),nr=Vo(pd);function Cu(i,e){let t="0",n="0";if(i.includes(".")){let o=i.split(".");o.length===2?([t,n]=o,n=n.padEnd(e,"0")):fd.logWithError(`invalid number string, num: ${i}`)}else t=i;return[t,n.slice(0,e)||n]}var Pe=class extends le{token;logger;constructor(e,t,n=!0,o){let r=new Rn(0),s=Qn.pow(new Rn(e.decimals));if(n)r=Y(t);else{let a=new Rn(0),c=new Rn(0);if(typeof t=="string"||typeof t=="number"||typeof t=="bigint"){let[u,l]=Cu(t.toString(),e.decimals);a=Y(u),c=Y(l)}a=a.mul(s),r=a.add(c)}super(r,s),this.logger=de(o||"TokenAmount"),this.token=e}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(e){return this.token.equals(e.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(e.raw)}lt(e){return this.token.equals(e.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(e.raw)}add(e){return this.token.equals(e.token)||this.logger.logWithError("add token not equals"),new Pe(this.token,this.raw.add(e.raw))}subtract(e){return this.token.equals(e.token)||this.logger.logWithError("sub token not equals"),new Pe(this.token,this.raw.sub(e.raw))}toSignificant(e=this.token.decimals,t,n=0){return super.toSignificant(e,t,n)}toFixed(e=this.token.decimals,t,n=0){return e>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(e,t,n)}toExact(e={groupSeparator:""}){return nr.DP=this.token.decimals,new nr(this.numerator.toString()).div(this.denominator.toString()).toFormat(e)}},Xn=class extends le{currency;logger;constructor(e,t,n=!0,o){let r=new Rn(0),s=Qn.pow(new Rn(e.decimals));if(n)r=Y(t);else{let a=new Rn(0),c=new Rn(0);if(typeof t=="string"||typeof t=="number"||typeof t=="bigint"){let[u,l]=Cu(t.toString(),e.decimals);a=Y(u),c=Y(l)}a=a.mul(s),r=a.add(c)}super(r,s),this.logger=de(o||"TokenAmount"),this.currency=e}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(e){return this.currency.equals(e.currency)||this.logger.logWithError("gt currency not equals"),this.raw.gt(e.raw)}lt(e){return this.currency.equals(e.currency)||this.logger.logWithError("lt currency not equals"),this.raw.lt(e.raw)}add(e){return this.currency.equals(e.currency)||this.logger.logWithError("add currency not equals"),new Xn(this.currency,this.raw.add(e.raw))}sub(e){return this.currency.equals(e.currency)||this.logger.logWithError("sub currency not equals"),new Xn(this.currency,this.raw.sub(e.raw))}toSignificant(e=this.currency.decimals,t,n=0){return super.toSignificant(e,t,n)}toFixed(e=this.currency.decimals,t,n=0){return e>this.currency.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(e,t,n)}toExact(e={groupSeparator:""}){return nr.DP=this.currency.decimals,new nr(this.numerator.toString()).div(this.denominator.toString()).toFormat(e)}};import{PublicKey as yd}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Lu}from"@solana/spl-token";var rn={chainId:101,address:yd.default.toBase58(),programId:Lu.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},nt={chainId:101,address:"So11111111111111111111111111111111111111112",programId:Lu.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};import{PublicKey as Ks}from"@solana/web3.js";import{PublicKey as Me,SystemProgram as Ru,SYSVAR_RENT_PUBKEY as bd}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as gd}from"@solana/spl-token";function P({pubkey:i,isSigner:e=!1,isWritable:t=!0}){return{pubkey:i,isWritable:t,isSigner:e}}var Is=[P({pubkey:gd,isWritable:!1}),P({pubkey:Ru.programId,isWritable:!1}),P({pubkey:bd,isWritable:!1})];function Bs({publicKey:i,transformSol:e}){let t=xs(i.toString());if(t instanceof Me)return e&&t.equals(ot)?j:t;if(e&&t.toString()===ot.toBase58())return j;if(typeof t=="string"){if(t===Me.default.toBase58())return Me.default;try{return new Me(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function xs(i){try{return new Me(i)}catch{return i}}var or=new Me("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),sn=new Me("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),je=new Me("SysvarRent111111111111111111111111111111111"),Ss=new Me("SysvarC1ock11111111111111111111111111111111"),Gt=new Me("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),ir=new Me("Sysvar1nstructions1111111111111111111111111"),rr=Ru.programId,Zb=new Me("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),$b=new Me("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),Jb=new Me("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),eg=new Me("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),tg=new Me("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),ng=new Me("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),og=new Me("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),ig=new Me("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),rg=new Me("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),sg=new Me("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),ag=new Me("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),j=new Me("So11111111111111111111111111111111111111112"),ot=Me.default;function pt(i){return Bs({publicKey:i,transformSol:!0})}var Cs=class{symbol;name;decimals;isToken2022;mint;constructor({mint:e,decimals:t,symbol:n,name:o,skipMint:r=!1,isToken2022:s=!1}){if(e===ot.toBase58()||e instanceof Ks&&ot.equals(e)){this.decimals=nt.decimals,this.symbol=nt.symbol,this.name=nt.name,this.mint=new Ks(nt.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=o||e.toString().substring(0,6),this.mint=r?Ks.default:Bs({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Te=Cs;Rt(Te,"WSOL",new Cs({...nt,mint:nt.address}));var Ls=class{symbol;name;decimals;constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},qo=Ls;Rt(qo,"SOL",new Ls(rn));function bg(i,e){return i instanceof Te&&e instanceof Te?i.equals(e):i instanceof Te||e instanceof Te?!1:i===e}import Pd from"bn.js";var Nu=new le(new Pd(100)),De=class extends le{toSignificant(e=5,t,n){return this.mul(Nu).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(Nu).toFixed(e,t,n)}};var Ad=de("Raydium_price"),it=class extends le{baseToken;quoteToken;scalar;constructor(e){let{baseToken:t,quoteToken:n,numerator:o,denominator:r}=e;super(o,r),this.baseToken=t,this.quoteToken=n,this.scalar=new le(Rs(t.decimals),Rs(n.decimals))}get raw(){return new le(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new it({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(e){this.quoteToken!==e.baseToken&&Ad.logWithError("mul token not equals");let t=super.mul(e);return new it({baseToken:this.baseToken,quoteToken:e.quoteToken,denominator:t.denominator,numerator:t.numerator})}toSignificant(e=this.quoteToken.decimals,t,n){return this.adjusted.toSignificant(e,t,n)}toFixed(e=this.quoteToken.decimals,t,n){return this.adjusted.toFixed(e,t,n)}};function Qe(i){if(i instanceof De)return new le(i.numerator,i.denominator);if(i instanceof it)return i.adjusted;if(i instanceof Pe)try{return Qe(i.toExact())}catch{return new le(ze)}if(i instanceof le)return i;let e=String(i),t=zn(e);return new le(t.numerator,t.denominator)}function _g(i){if(i instanceof De)return{fr:new le(i.numerator,i.denominator)};if(i instanceof it)return{fr:i.adjusted};if(i instanceof Pe)return{fr:Qe(i.toExact()),decimals:i.token.decimals};if(i instanceof le)return{fr:i};let e=String(i),t=zn(e);return{fr:new le(t.numerator,t.denominator),decimals:t.dec?.length}}function Fg(i,e){if(i==null||e==null)return!1;let t=Qe(i),n=Qe(e);return t.sub(n).numerator,t.sub(n).numerator.lt(ze)}function wd(i,e){if(i==null||e==null)return!1;let t=Qe(i),n=Qe(e);return t.sub(n).numerator.gt(ze)}function Vg(i,e){if(i==null||e==null)return!1;let t=Qe(i),n=Qe(e);return t.sub(n).numerator.lte(ze)}function Wg(i,e){if(i==null||e==null)return!1;let t=Qe(i),n=Qe(e);return t.sub(n).numerator.gte(ze)}function kd(i,e){if(i==null||e==null)return!1;let t=Qe(i),n=Qe(e);return t.sub(n).numerator.eq(ze)}function Dg(i,e){if(i==null||e==null)return;let t=Qe(i),n=Qe(e);try{return t.div(n)}catch{return t}}function qg(i,e){if(i==null||e==null)return;let t=Qe(i),n=Qe(e);return t.sub(n)}function Ug(i){return i==null?!1:!kd(i,0)}function Gg(i,e){return wd(e,i)?e:i}function Ns(i,e){if(i==null||e==null)return;let t=Qe(i),n=Qe(e);return t.mul(n)}function Xg(i,e){if(i==null||e==null)return;let t=Qe(i),n=Qe(e);return t.add(n)}import{PublicKey as hd}from"@solana/web3.js";import Td from"bn.js";async function Ou(i){new Promise(e=>setTimeout(e,i))}function Zg(){return new Date().getTime()}function Os(i){return typeof i=="object"&&i!==null&&![Te,Pe,hd,le,Td,it,De].some(e=>typeof e=="object"&&i instanceof e)}function Re(i){return typeof i=="string"?xs(i):Array.isArray(i)?i.map(e=>Re(e)):Os(i)?Object.fromEntries(Object.entries(i).map(([e,t])=>[e,Re(t)])):i}var ze=new qe(0),Eu=new qe(1),lP=new qe(2),mP=new qe(3),dP=new qe(5),Qn=new qe(10),pP=new qe(100),fP=new qe(1e3),yP=new qe(1e4);function Rs(i){return Qn.pow(Y(i))}function zn(i){if(i===void 0)return{denominator:"1",numerator:"0"};if(i instanceof qe)return{numerator:i.toString(),denominator:"1"};if(i instanceof le)return{denominator:i.denominator.toString(),numerator:i.numerator.toString()};let e=String(i),[,t="",n="",o=""]=e.replace(",","").match(/(-?)(\d*)\.?(\d*)/)??[],r="1"+"0".repeat(o.length),s=t+(n==="0"?"":n)+o||"0";return{denominator:r,numerator:s,sign:t,int:n,dec:o}}function sr(i,e){let t=i.divmod(e);return t.mod.isZero()?t.div:t.div.isNeg()?t.div.isubn(1):t.div.iaddn(1)}function Id(i){let[,e="",t=""]=i.toFixed(2).match(/(-?)(\d*)\.?(\d*)/)??[];return`${e}${t}`}function Bd(i,e=0){return i instanceof qe?i:new qe(Id(_u(i).mul(Qn.pow(new qe(String(e))))))}function _u(i){if(i instanceof De)return new le(i.numerator,i.denominator);if(i instanceof it)return i.adjusted;if(i instanceof Pe)try{return _u(i.toExact())}catch{return new le(ze)}if(i instanceof le)return i;let e=String(i),t=zn(e);return new le(t.numerator,t.denominator)}function ar(i,e,t){return i.mul(e).add(t).sub(new qe(1)).div(t)}function vs(i,e,t){return i.mul(e).div(t)}function bP(i,e){let{numerator:t,denominator:n}=zn(i);return new De(new qe(t),new qe(n).mul(e?.alreadyDecimaled?new qe(100):new qe(1)))}function gP(i){let{token:e,numberPrice:t,decimalDone:n}=i,o=new Te({mint:"",decimals:6,symbol:"usd",name:"usd",skipMint:!0}),{numerator:r,denominator:s}=zn(t),a=n?new qe(r).mul(Qn.pow(new qe(e.decimals))):r,c=new qe(s).mul(Qn.pow(new qe(o.decimals)));return new it({baseToken:o,denominator:c.toString(),quoteToken:new Te({...e,skipMint:!0,mint:""}),numerator:a.toString()})}function vu(i){let e=new qo({decimals:6,symbol:"usd",name:"usd"}),t=Bd(Ns(i,10**e.decimals));return new Xn(e,t)}function PP(i,e){return vu(!e||!i?0:Ns(i,e))}function xd(i){if(i==null)return;let{numerator:e,denominator:t}=zn(i.toString());return new le(e,t)}function Sd(i){return i instanceof C}function Mu(i){return Sd(i)?xd(i):Array.isArray(i)?i.map(e=>Mu(e)):Os(i)?Object.fromEntries(Object.entries(i).map(([e,t])=>[e,Mu(t)])):i}var Fu=i=>typeof i=="number",Vu=i=>i?new Date(i):new Date,Kd=i=>Vu(i).getTime();function Wu(i,e,t){let n=Fu(e)?e*(t?.unit==="s"?1e3:1):e;return new Date(i).getTime()<=n}function Du(i,e,t){let n=Fu(e)?e*(t?.unit==="s"?1e3:1):e;return new Date(i).getTime()>n}function wP(i,e){let n=Kd(i)+(e.days?e.days*24*60*60*1e3:0)+(e.hours?e.hours*60*60*1e3:0)+(e.minutes?e.minutes*60*1e3:0)+(e.seconds?e.seconds*1e3:0)+(e.milliseconds?e.milliseconds:0);return Vu(n)}function ys(i,e=1,t=[]){let n=[...i];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}function hP(i,...e){return i.filter(t=>e.every(n=>n.includes(t)))}function TP(i,...e){return i.filter(t=>e.every(n=>!n.includes(t)))}function IP(i){return[...new Set(i)]}var Xt=class{_owner;constructor(e){this._owner=e}get publicKey(){return Xt.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return Xt.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return Xt.isKeyPair(this._owner)}get isPublicKey(){return Xt.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!Xt.isKeyPair(e)}};import{PublicKey as Od}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as vd}from"@solana/spl-token";import{ComputeBudgetProgram as qu,Keypair as Uu,PublicKey as Gu,Transaction as cr,TransactionMessage as Cd,VersionedTransaction as Ms}from"@solana/web3.js";var Nn=(t=>(t[t.V0=0]="V0",t[t.LEGACY=1]="LEGACY",t))(Nn||{}),V={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",ClmmLockPosition:"ClmmLockPosition",ClmmHarvestLockPosition:"ClmmHarvestLockPosition",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV4Withdraw:"FarmV4Withdraw",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut",CpmmLockLp:"CpmmLockLp",CpmmCollectLockFee:"CpmmCollectLockFee",TransferTip:"TransferTip",NonceAccount:"NonceAccount"};import{TOKEN_PROGRAM_ID as Ld}from"@solana/spl-token";var bn=de("Raydium_txUtil"),Xu=1644;function yo(i){let e=[],t=[];return i.microLamports&&(e.push(qu.setComputeUnitPrice({microLamports:i.microLamports})),t.push(V.SetComputeUnitPrice)),i.units&&(e.push(qu.setComputeUnitLimit({units:i.units})),t.push(V.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function bo(i,e){let t=e??"confirmed";return(await i.getLatestBlockhash?.({commitment:t}))?.blockhash}async function lr(i,e){return i.getSignatureStatuses([e]),new Promise((t,n)=>{let o=setTimeout(n,6e4);i.onSignature(e,r=>{if(clearTimeout(o),!r.err){t("");return}n(Object.assign(r.err,{txId:e}))},"confirmed")})}function mr(i,e){i.length<1&&bn.logWithError(`no instructions provided: ${i.toString()}`),e.length<1&&bn.logWithError(`no signers provided:, ${e.toString()}`);let t=new cr;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...i);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<Xu}catch{return!1}}async function Qu(i,e,t,n=!0){let o=new Gu("RaydiumSimuLateTransaction11111111111111111"),r=[],s=new cr;s.feePayer=o;for(let u of e)mr([...s.instructions,u],[o])||(r.push(s),s=new cr,s.feePayer=o),s.add(u);s.instructions.length>0&&r.push(s);let a=[];try{if(a=await Rd(i,r,n),a.find(u=>u.err!==null))throw Error("rpc simulateTransaction error")}catch(u){u instanceof Error&&bn.logWithError("failed to simulate for instructions","RPC_ERROR",{message:u.message})}let c=[];for(let u of a)if(bn.debug("simulate result:",u),u.logs){let l=u.logs.filter(d=>d&&d.includes(t));bn.debug("filteredLog:",c),l.length||bn.logWithError("simulate log not match keyword","keyword",t),c.push(...l)}return c}function zu(i,e){let t=i.match(/{["\w:,]+}/g);return!t||t.length!==1?bn.logWithError(`simulate log fail to match json, keyword: ${e}`):t[0]}function gn(i,e){let n=new RegExp(`"${e}":(\\d+)`,"g").exec(i);return!n||n.length!==2?bn.logWithError(`simulate log fail to match key", key: ${e}`):n[1]}function te(i,e){let[t,n]=Gu.findProgramAddressSync(i,e);return{publicKey:t,nonce:n}}async function Rd(i,e,t){let n=[];if(t){let o=await i.getLatestBlockhash(),r=[];for(let u of e){u.recentBlockhash=o.blockhash,u.lastValidBlockHeight=o.lastValidBlockHeight;let d=u._compile().serialize(),p=u._serialize(d).toString("base64");r.push(p)}let s=r.map(u=>{let l=i._buildArgs([u],void 0,"base64");return{methodName:"simulateTransaction",args:l}}),a=[],c=20;for(let u=0;u<Math.ceil(s.length/c);u++)a.push(s.slice(u*c,(u+1)*c));n=await(await Promise.all(a.map(async u=>(await i._rpcBatchRequest(u)).map(l=>l.result.value)))).flat()}else try{n=await Promise.all(e.map(async o=>await(await i.simulateTransaction(o)).value))}catch(o){o instanceof Error&&bn.logWithError("failed to get info for multiple accounts","RPC_ERROR",{message:o.message})}return n}function Uo({instructions:i,payer:e,signers:t}){return mr(i,[e,...t])}function Go({instructions:i,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=Uu.generate().publicKey.toString()}){let r=new Cd({payerKey:e,recentBlockhash:n,instructions:i}).compileToV0Message(Object.values(t??{}));try{return Buffer.from(new Ms(r).serialize()).toString("base64").length<Xu}catch{return!1}}var ur={time:0,data:void 0};async function _P(i){if(!ur.data||(Date.now()-ur.time)/1e3>30){let e=await i.getEpochInfo();return ur={time:Date.now(),data:e},e}else return ur.data}var Hu=i=>Buffer.isBuffer(i)?i:i instanceof Uint8Array?Buffer.from(i.buffer,i.byteOffset,i.byteLength):Buffer.from(i),Nd=i=>{let e=i.serialize({requireAllSignatures:!1,verifySignatures:!1});i instanceof Ms&&(e=Hu(e));try{return e instanceof Buffer?e.toString("base64"):Buffer.from(e).toString("base64")}catch{return e.toString("base64")}};function Hn(i){let e=[];return i.forEach(t=>{t instanceof cr&&(t.recentBlockhash||(t.recentBlockhash=Ld.toBase58()),t.feePayer||(t.feePayer=Uu.generate().publicKey)),e.push(Nd(t))}),console.log("simulate tx string:",e),e}function FP(i){let e=i.serialize({requireAllSignatures:!1,verifySignatures:!1});return i instanceof Ms&&(e=Hu(e)),e.toString("base64")}function $(i,e,t){return te([i.toBuffer(),(t??vd).toBuffer(),e.toBuffer()],new Od("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import{PublicKey as ce}from"@solana/web3.js";var Es=new ce("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),ju=new ce("CBuCnLe26faBpcBP2fktp4rp8abpcAnTWft6ZrP5Q4T"),_s=new ce("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),go=new ce("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),Md=new ce("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),Fs=new ce("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),dr=new ce("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),Xo=new ce("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),Ed=new ce("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),pr=new ce("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),On=new ce("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),Po=new ce("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Qo=new ce("kN1kEznaF5Xbd8LYuqtEFcxzWSBk5Fv6ygX6SqEGJVy"),_d=new ce("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),Yu=new ce("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),Fd=new ce("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),Vd=new ce("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),Wd=new ce("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),Dd=new ce("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),zo=new ce("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),Vs=new ce("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),qd=new ce("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),Ud=new ce("CPMDWBwJDtYax9qW7AyRuVC19Cc4L4Vcy4n2BHAbHkCW"),Gd=new ce("7rQ1QFNosMkUCuh7Z7fPbTHvh73b68sQYdirycEzJVuw"),Xd=new ce("G11FKBRaAkHAKuLCgLM6K6NUc9rTjPAznRCjZifrTQe2"),Ho=new ce("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Qd=new ce("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),jo=new ce("3f7GcQFG397GAaEnv51zR6tsTVihYRydnydDD1cXekxH"),zd=new ce("7AFUeLVRjBfzqK3tTGw8hN48KLQWSk6DTE8xprWdPqix"),Qt=new ce("LanMV9sAd7wArD4vJFi2qDdfnVhFxYSUg6eADduJ3uj"),Hd=new ce("WLHv2UAZm6z4KyaaELi5pjdbJh6RESMva1Rnn8pJVVh"),jd=new ce("LanD8FpTBBvzZFXjTxsAoipkFsxPUCDB4qAqKxYDiNP"),Yd=new ce("HYNHiyKJ3gGVFvyxJAurK7qr7P2o5J9THmvCGMdULtpW"),Yo={IDO_PROGRAM_ID_V1:Fd,IDO_PROGRAM_ID_V2:Vd,IDO_PROGRAM_ID_V3:Wd,IDO_PROGRAM_ID_V4:Dd},At={AMM_V4:Xo,AMM_STABLE:Ed,CLMM_PROGRAM_ID:On,CLMM_LOCK_PROGRAM_ID:Po,CLMM_LOCK_AUTH_ID:Qo,FARM_PROGRAM_ID_V3:Es,FARM_PROGRAM_ID_V5:_s,FARM_PROGRAM_ID_V6:go,OPEN_BOOK_PROGRAM:Fs,SERUM_PROGRAM_ID_V3:dr,UTIL1216:Md,Router:_d,CREATE_CPMM_POOL_PROGRAM:zo,CREATE_CPMM_POOL_AUTH:Vs,CREATE_CPMM_POOL_FEE_ACC:qd,LOCK_CPMM_PROGRAM:Ho,LOCK_CPMM_AUTH:jo,LAUNCHPAD_PROGRAM:Qt,LAUNCHPAD_AUTH:Hd},XP={SERUM_MARKET:ce.default,OPENBOOK_MARKET:new ce("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),UTIL1216:ce.default,FarmV3:new ce("85BFyr98MbCUU9MVTEgzx1nbhWACbJqLzho6zd6DZcWL"),FarmV5:new ce("EcLzTrNg9V7qhcdyXDe2qjtPkiGzDM2UbdRaeaadU5r2"),FarmV6:new ce("Farm2hJLcqPtPg8M4rR6DMrsRNc5TPm5Cs4bVQrMe2T7"),AmmV4:new ce("HWy1jotHpo6UqeQxx49dpYYdQB8wj9Qk9MdxwjLvDHB8"),AmmStable:new ce("DDg4VmQaJV9ogWce7LpcjBA9bv22wRp5uaTPa5pGjijF"),CLMM:new ce("devi51mZmdwUJGU9hjN27vEz64Gps7uUefqxg27EAtH"),CLMM_LOCK_PROGRAM_ID:new ce("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),CLMM_LOCK_AUTH_ID:new ce("8qmHNvu2Kr2C7U8mJL4Vz1vTDxMhVuXKREwU7TNoaVEo"),Router:new ce("BVChZ3XFEwTMUk1o9i3HAf91H6mFxSwa5X2wFAWhYPhU"),CREATE_CPMM_POOL_PROGRAM:Ud,CREATE_CPMM_POOL_AUTH:Gd,CREATE_CPMM_POOL_FEE_ACC:Xd,FEE_DESTINATION_ID:new ce("3XMrhbv989VxAMi3DErLV9eJht1pHppW5LbKxe9fkEFR"),LOCK_CPMM_PROGRAM:Qd,LCOK_CPMM_AUTH:zd,LAUNCHPAD_PROGRAM:jd,LAUNCHPAD_AUTH:Yd};import Ee from"bn.js";var an=1e4;function HP(i,e,t,n){if(e===void 0)return{amount:i,fee:void 0,expirationTime:void 0};let o=t.epoch<e.newerTransferFee.epoch?e.olderTransferFee:e.newerTransferFee,r=new Ee(o.maximumFee.toString()),s=t.epoch<e.newerTransferFee.epoch?(Number(e.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(o.transferFeeBasisPoints===an){let a=new Ee(o.maximumFee.toString());return{amount:i.add(a),fee:a,expirationTime:s}}else{let a=zt(i.mul(new Ee(an)),new Ee(an-o.transferFeeBasisPoints)),c=new Ee(o.maximumFee.toString()),u=a.sub(i).gt(c)?i.add(c):a,l=zt(u.mul(new Ee(o.transferFeeBasisPoints)),new Ee(an)),d=l.gt(r)?r:l;return{amount:u,fee:d,expirationTime:s}}else{let a=zt(i.mul(new Ee(o.transferFeeBasisPoints)),new Ee(an)),c=a.gt(r)?r:a;return{amount:i,fee:c,expirationTime:s}}}function we(i,e,t,n){if(e===void 0)return{amount:i,fee:void 0,expirationTime:void 0};let o={...e,olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}},r=t.epoch<o.newerTransferFee.epoch?o.olderTransferFee:o.newerTransferFee,s=new Ee(r.maximumFee.toString()),a=t.epoch<o.newerTransferFee.epoch?(Number(o.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(r.transferFeeBasisPoints===an){let c=new Ee(r.maximumFee.toString());return{amount:i.add(c),fee:c,expirationTime:a}}else{let c=zt(i.mul(new Ee(an)),new Ee(an-r.transferFeeBasisPoints)),u=new Ee(r.maximumFee.toString()),l=c.sub(i).gt(u)?i.add(u):c,d=zt(l.mul(new Ee(r.transferFeeBasisPoints)),new Ee(an)),m=d.gt(s)?s:d;return{amount:l,fee:m,expirationTime:a}}else{let c=zt(i.mul(new Ee(r.transferFeeBasisPoints)),new Ee(an)),u=c.gt(s)?s:c;return{amount:i,fee:u,expirationTime:a}}}function Ht(i,e){return i===void 0?e:e===void 0?i:Math.min(i,e)}function zt(i,e){let{div:t,mod:n}=i.divmod(e);return n.gt(new Ee(0))?t.add(new Ee(1)):t}function fr(i,e){if(i.isZero())return new Ee(0);let t=i.div(e);return t.isZero()?new Ee(1):i.mod(e).gt(new Ee(0))?t.add(new Ee(1)):t}import{PublicKey as Zu,AddressLookupTableAccount as yr}from"@solana/web3.js";async function Ws({connection:i,address:e}){let t=await Dt(i,[...new Set(e.map(o=>o.toString()))].map(o=>new Zu(o))),n={};for(let o=0;o<e.length;o++){let r=t[o],s=e[o];if(!r)continue;let a=new yr({key:s,state:yr.deserialize(r.data)});n[s.toString()]=a,br[s.toString()]=a}return n}var br={AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU:new yr({key:new Zu("AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU"),state:yr.deserialize(Buffer.from("AQAAAP//////////I1rcEwAAAAAvAQYwun9CU6c5Ikm2pAj+D9IEnCOR45nK+SFTGSdpd6J6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAbd9uHXZaGT2cvhRs7reawctIXtX1s3kTqM9YV+/wCpBt324e51j94YQl285GzN2rYa/E2DuQ0n/r35KNihi/wFSlNQ+F3IgtYUpVZyeIopbd8eq6vQpgZ4iEky9O72oAVKU1qZKSEGTSTocWDaOHx8NbXdvJK7geQfqEBBBUSNBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvBkX2T9y7AHdNGviJAqQNtlDUDCnauQRWybsLji6nPM8Qkw5asQRvCdB3MbX6IEBwytOrpM32l4jQygKG9TKgR0vZScQ2AsM/IHeQ7RajUkyhuZdc8SGiqQz/7H34torNR/Wir3sl0ruUrVxJWEZfUg+QLNAxxODdBi53/OP7Ioil1cqeBM9dtZC3FLov4yyxWRM/wcGStyJX/QfTnLBAHqkqWotPKVlShCVQqpP9W5W1rOao65IMk5QuQ2kMIOxzDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu/YsA/yfEEFGcr8Z57VKDw8uQzpiru7g4lvjnfapW62W030syevD8k07SGoxUHiuT/ai7gAHWWhDsVmg/C63ajgpkH7Sn3GdutArDTfyqOkdqv4/IPC/EFFy7mGkfDd2C57N5a/4jC+BbmJy7wQaSEZr0CQU88lPtUxIVvzGjC95b8Ooss2TqmkrayGKofkPMGQn7Ux+9lfwBSNfxwH8NgbpqC/7LNlV4I7nCvsXf3p+ohQk9NrAJb2KAFpUqEIJ9ZBV7BYDzHF/ORKYlgtvPnXjudZQ6CEo5OzUDaNIomTCCsvhD16TxJjsbgne1kGnQPCFSoaxUbq2V1bPMFQ3VYP6wDZ9bKStCFKx9A3tNbwZFC5ZGAN83MFK7XoTy+OmmcFEr6rLOjfSuTfPvHJkSVxW6Qllwkl67XcBi5v00u2gQsbu+38sp+rd5pA/LvyWj4P94ZGZwc1tE2P88xekCLcAwZGb+UhFzL/7K26csOb57yM5bvF9xJrLEObOkAAAAAn+HWRkdcPKyFFMnVwEoD7vnD0jCKFIU1sImubYCxNTSVzsKpaQX+fzNxrLAI3L14JQnJx/D6Uk2LADIHGqnGELzjEbkBDAlaM77NkXMPfqXNLSveCkWI7UEgNs31WEWB6XHSYI/v5DklHOb4QTtDOR804PVbi3fjloZeLR2F8d4FuZmMMO7ck3Fnkn2zEMG5gOmqsygb6PjTitArVl52NhcSznTxVnguaIJxiZkAnurDmn3MWR0PC2GLghp2KJqHCc6QQ85odeIjFHKOlRlJyeSXVJmL8vb1UgOzsbJPVP8p6zM4M3C1Sd7uWIHP33G42AP2Zg8ucn/n6meQjjD266JgCWdxZD6PXs9CsnIeL7SSG0/6lGb9xfP0ZcWkCXB/3hjxHYVXjra/GPOeXGk0fLLKjCbk+mgs2w6d2oCwimBipTzuoZ30GiI8ij8VRzD5CzMWtu2m21eDBIfjGAEo4pQeNNonKcqzV/cleX8ySZLOHsz8PtBCrLqF+VkLm9hOzIT+6i/nIf6keR4GWKMOD4AvqfpjHoD4DuhBpz8P28+DxkGrDXXr/nr20x291VPvcTU/b+b+o2kC9G0kcXeTlLjU6a2TQXWlZ4gBUdBl1jgT7mObSTpLblNiXZsLkbmVXZwvFKXua5cUKlWed/w30skmEUraTuQqtqr5fHZPW9n57EmeTif6LjHL2YJFZkQU+TrJmFzqzmF4/b8OwrPQAprl8mX3q4LUIdAS/a+11B6DWD1Xk2++Sn94dLC4xjkO4Wtlw8c4XuzciVbepHOmnoWzVu/0y3KCrLCSfQxQ3br8DJCoVzhgtPsS2nZZjsBGIZgnU0QpMv+2MnRsnKwdp1VsrCX84j/qvaZn4WhKunippgTbN2EUs0tPTP55Qfgj+nKmjtWW5IYs72FrEwJKYoNfsmqaF4o5pf4v9zgPwVwY/5I4XJKUL2L25m9kAQcW/K+H1RTFEUoj8Z4ajpOmAB/dG0COmCphVMW2CCMvnxhcGiSgPnpDuWu6qiJ7NG7ye5kvHgefgqPLeicspNJ5EpL3XiRNLM2tmJLI1awAwOyd6iHv0dCkMYRKaa6rcaZeYwmKCkckm0kM2JNmnmmAaBQQ7mwmIM0IMxX4f5W6j9PqZWcJxF7r17T/lQBAmcjoupRiJifbnXCNUv9GhpRF19WcBdeKbivRJVlGop6I2RS6lGImJ9udcI1S/0aGlEXX1ZwF14puK9ElWUainojZFYVHLHD6dIP2ESjqBzg3ol1/wB7+/ylGwd9LS7wSZ2A630CJSVKwH47K9P4bB8PEQP8BwjMFa7xQHOqZFP1XqaQ==","base64"))})};import{PublicKey as Ao,sendAndConfirmTransaction as Ds,SystemProgram as Zd,Transaction as Zo,TransactionMessage as $o,VersionedTransaction as Jo}from"@solana/web3.js";import $d from"axios";var gr=2e3,Pr=class{connection;owner;instructions=[];endInstructions=[];lookupTableAddress=[];signers=[];instructionTypes=[];endInstructionTypes=[];feePayer;cluster;signAllTransactions;blockhashCommitment;loopMultiTxStatus;constructor(e){this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster,this.blockhashCommitment=e.blockhashCommitment,this.loopMultiTxStatus=!!e.loopMultiTxStatus}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){let e=(await $d.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=e?.[15]??{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=yo(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}addTipInstruction(e){return e?(this.endInstructions.push(Zd.transfer({fromPubkey:e.feePayer??this.feePayer,toPubkey:new Ao(e.address),lamports:BigInt(e.amount.toString())})),this.endInstructionTypes.push(V.TransferTip),!0):!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:o=[],endInstructionTypes:r=[],lookupTableAddress:s=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...o),this.endInstructionTypes.push(...r),this.lookupTableAddress.push(...s.filter(a=>a!==Ao.default.toString())),this}async versionBuild({txVersion:e,extInfo:t},n){return e===0?await this.buildV0({...t||{}},n):this.build(t,n)}build(e,t){let n=new Zo;return this.allInstructions.length&&n.add(...this.allInstructions),n.feePayer=this.feePayer,this.owner?.signer&&!this.signers.some(o=>o.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer),{builder:this,transaction:n,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async o=>{let{recentBlockHash:r,skipPreflight:s=!0,sendAndConfirm:a,notSendToRpc:c}=o||{},u=r??t??await bo(this.connection,this.blockhashCommitment);if(n.recentBlockhash=u,this.signers.length&&n.sign(...this.signers),Hn([n]),this.owner?.isKeyPair)return{txId:a?await Ds(this.connection,n,this.signers.find(d=>d.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:s}):await this.connection.sendRawTransaction(n.serialize(),{skipPreflight:s}),signedTx:n};if(this.signAllTransactions){let l=await this.signAllTransactions([n]);if(this.signers.length)for(let d of l)try{d.sign(...this.signers)}catch{}return{txId:c?"":await this.connection.sendRawTransaction(l[0].serialize(),{skipPreflight:s}),signedTx:l[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:o}=this.build(n),r=t.filter(u=>u.transaction.instructions.length>0),s=[o,...r.map(u=>u.transaction)],a=[this.signers,...r.map(u=>u.signers)],c=[...this.instructionTypes,...r.map(u=>u.instructionTypes).flat()];return this.owner?.signer&&a.forEach(u=>{u.some(l=>l.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:c,execute:async u=>{let{sequentially:l,onTxUpdate:d,skipTxCount:m=0,recentBlockHash:p,skipPreflight:y=!0}=u||{},f=p??await bo(this.connection,this.blockhashCommitment);if(this.owner?.isKeyPair){if(l){let b=[],g=0;for(let w of s){if(++g,g<=m)continue;let k=await Ds(this.connection,w,this.signers.find(h=>h.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:y});b.push(k)}return{txIds:b,signedTxs:s}}return{txIds:await await Promise.all(s.map(async b=>(b.recentBlockhash=f,await this.connection.sendRawTransaction(b.serialize(),{skipPreflight:y})))),signedTxs:s}}if(this.signAllTransactions){let b=s.map((w,k)=>(w.recentBlockhash=f,a[k].length&&w.sign(...a[k]),w));Hn(b);let g=await this.signAllTransactions(b);if(l){let w=0,k=[],h=async()=>{if(!g[w])return;let x=await this.connection.sendRawTransaction(g[w].serialize(),{skipPreflight:y});k.push({txId:x,status:"sent",signedTx:g[w]}),d?.([...k]),w++;let T=!1,B=null,S=null,I=K=>{B!==null&&clearInterval(B),S!==null&&this.connection.removeSignatureListener(S);let O=k.findIndex(v=>v.txId===x);if(O>-1){if(k[O].status==="error"||k[O].status==="success")return;k[O].status=K.err?"error":"success"}d?.([...k]),K.err||h()};this.loopMultiTxStatus&&(B=setInterval(async()=>{if(T){clearInterval(B);return}try{let K=await this.connection.getTransaction(x,{commitment:"confirmed",maxSupportedTransactionVersion:0});K&&(T=!0,clearInterval(B),I({err:K.meta?.err||null}),console.log("tx status from getTransaction:",x))}catch(K){T=!0,clearInterval(B),console.error("getTransaction timeout:",K,x)}},gr)),S=this.connection.onSignature(x,K=>{if(T){this.connection.removeSignatureListener(S);return}T=!0,I(K)},"confirmed"),this.connection.getSignatureStatus(x)};return await h(),{txIds:k.map(x=>x.txId),signedTxs:g}}else{let w=[];for(let k=0;k<g.length;k+=1){let h=await this.connection.sendRawTransaction(g[k].serialize(),{skipPreflight:y});w.push(h)}return{txIds:w,signedTxs:g}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e,t){let{lookupTableCache:n={},lookupTableAddress:o=[],forerunCreate:r,recentBlockhash:s,...a}=e||{},c={...this.cluster==="devnet"?{}:br,...n},u=Array.from(new Set([...o,...this.lookupTableAddress])),l=[];for(let y of u)c[y]===void 0&&l.push(new Ao(y));if(l.length>0){let y=await Ws({connection:this.connection,address:l});for(let[f,b]of Object.entries(y))c[f]=b}let d=t??(r?Ao.default.toBase58():s??await bo(this.connection,this.blockhashCommitment)),m=new $o({payerKey:this.feePayer,recentBlockhash:d,instructions:[...this.allInstructions]}).compileToV0Message(Object.values(c));this.owner?.signer&&!this.signers.some(y=>y.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer);let p=new Jo(m);return p.sign(this.signers),{builder:this,transaction:p,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async y=>{let{skipPreflight:f=!0,sendAndConfirm:b,notSendToRpc:g}=y||{};if(Hn([p]),this.owner?.isKeyPair){let w=await this.connection.sendTransaction(p,{skipPreflight:f});return b&&await lr(this.connection,w),{txId:w,signedTx:p}}if(this.signAllTransactions){let w=await this.signAllTransactions([p]);if(this.signers.length)for(let k of w)try{k.sign(this.signers)}catch{}return{txId:g?"":await this.connection.sendTransaction(w[0],{skipPreflight:f}),signedTx:w[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:a||{}}}async buildV0MultiTx(e){let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:o}=await this.buildV0(n),r=t.filter(u=>u.builder.instructions.length>0),s=[o,...r.map(u=>u.transaction)],a=[this.signers,...r.map(u=>u.signers)],c=[...this.instructionTypes,...r.map(u=>u.instructionTypes).flat()];return this.owner?.signer&&a.forEach(u=>{u.some(l=>l.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),s.forEach(async(u,l)=>{u.sign(a[l])}),{builder:this,transactions:s,signers:a,instructionTypes:c,buildProps:n,execute:async u=>{let{sequentially:l,onTxUpdate:d,recentBlockHash:m,skipPreflight:p=!0}=u||{};if(m&&s.forEach(y=>y.message.recentBlockhash=m),Hn(s),this.owner?.isKeyPair){if(l){let y=[];for(let f of s){let b=await this.connection.sendTransaction(f,{skipPreflight:p});await lr(this.connection,b),y.push(b)}return{txIds:y,signedTxs:s}}return{txIds:await Promise.all(s.map(async y=>await this.connection.sendTransaction(y,{skipPreflight:p}))),signedTxs:s}}if(this.signAllTransactions){let y=await this.signAllTransactions(s);if(l){let f=0,b=[],g=async()=>{if(!y[f])return;let w=await this.connection.sendTransaction(y[f],{skipPreflight:p});b.push({txId:w,status:"sent",signedTx:y[f]}),d?.([...b]),f++;let k=!1,h=null,x=null,T=B=>{h!==null&&clearInterval(h),x!==null&&this.connection.removeSignatureListener(x);let S=b.findIndex(I=>I.txId===w);if(S>-1){if(b[S].status==="error"||b[S].status==="success")return;b[S].status=B.err?"error":"success"}d?.([...b]),B.err||g()};this.loopMultiTxStatus&&(h=setInterval(async()=>{if(k){clearInterval(h);return}try{let B=await this.connection.getTransaction(w,{commitment:"confirmed",maxSupportedTransactionVersion:0});B&&(k=!0,clearInterval(h),T({err:B.meta?.err||null}),console.log("tx status from getTransaction:",w))}catch(B){k=!0,clearInterval(h),console.error("getTransaction timeout:",B,w)}},gr)),x=this.connection.onSignature(w,B=>{if(k){this.connection.removeSignatureListener(x);return}k=!0,T(B)},"confirmed"),this.connection.getSignatureStatus(w)};return g(),{txIds:[],signedTxs:y}}else{let f=[];for(let b=0;b<y.length;b+=1){let g=await this.connection.sendTransaction(y[b],{skipPreflight:p});f.push(g)}return{txIds:f,signedTxs:y}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){let{splitIns:t=[],computeBudgetConfig:n,...o}=e||{},r=n?yo(n):{instructions:[],instructionTypes:[]},s=this.signers.reduce((d,m)=>({...d,[m.publicKey.toBase58()]:m}),{}),a=[],c=[],u=[],l=0;if(this.allInstructions.forEach(d=>{let m=[...u,d],p=n?[...r.instructions,...m]:m,f=[...new Set(m.map(b=>b.keys.filter(g=>g.isSigner).map(g=>g.pubkey.toString())).flat()).values()].map(b=>new Ao(b));if(d!==t[l]&&u.length<12&&(Uo({instructions:p,payer:this.feePayer,signers:f})||Uo({instructions:m,payer:this.feePayer,signers:f})))u.push(d);else{if(u.length===0)throw Error("item ins too big");l+=d===t[l]?1:0,Uo({instructions:n?[...r.instructions,...u]:[...u],payer:this.feePayer,signers:f})?a.push(new Zo().add(...r.instructions,...u)):a.push(new Zo().add(...u)),c.push(Array.from(new Set(u.map(b=>b.keys.filter(g=>g.isSigner).map(g=>g.pubkey.toString())).flat())).map(b=>s[b]).filter(b=>b!==void 0)),u=[d]}}),u.length>0){let m=[...new Set(u.map(p=>p.keys.filter(y=>y.isSigner).map(y=>y.pubkey.toString())).flat()).values()].map(p=>s[p]).filter(p=>p!==void 0);Uo({instructions:n?[...r.instructions,...u]:[...u],payer:this.feePayer,signers:m.map(p=>p.publicKey)})?a.push(new Zo().add(...r.instructions,...u)):a.push(new Zo().add(...u)),c.push(m)}return a.forEach(d=>d.feePayer=this.feePayer),this.owner?.signer&&c.forEach(d=>{d.some(m=>m.publicKey.equals(this.owner.publicKey))||d.push(this.owner.signer)}),{builder:this,transactions:a,signers:c,instructionTypes:this.instructionTypes,execute:async d=>{let{sequentially:m,onTxUpdate:p,skipTxCount:y=0,recentBlockHash:f,skipPreflight:b=!0}=d||{},g=f??await bo(this.connection,this.blockhashCommitment);if(a.forEach(async(w,k)=>{w.recentBlockhash=g,c[k].length&&w.sign(...c[k])}),Hn(a),this.owner?.isKeyPair){if(m){let w=0,k=[];for(let h of a){if(++w,w<=y){k.push("tx skipped");continue}let x=await Ds(this.connection,h,this.signers.find(T=>T.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:b});k.push(x)}return{txIds:k,signedTxs:a}}return{txIds:await Promise.all(a.map(async w=>await this.connection.sendRawTransaction(w.serialize(),{skipPreflight:b}))),signedTxs:a}}if(this.signAllTransactions){let w=await this.signAllTransactions(a.slice(y,a.length)),k=[...a.slice(0,y),...w];if(m){let h=0,x=[],T=async()=>{if(!k[h])return;h<y&&(x.push({txId:"",status:"success",signedTx:k[h]}),p?.([...x]),h++,T());let B=await this.connection.sendRawTransaction(k[h].serialize(),{skipPreflight:b});x.push({txId:B,status:"sent",signedTx:k[h]}),p?.([...x]),h++;let S=!1,I=null,K=null,O=v=>{I!==null&&clearInterval(I),K!==null&&this.connection.removeSignatureListener(K);let _=x.findIndex(D=>D.txId===B);if(_>-1){if(x[_].status==="error"||x[_].status==="success")return;x[_].status=v.err?"error":"success"}p?.([...x]),v.err||T()};this.loopMultiTxStatus&&(I=setInterval(async()=>{if(S){clearInterval(I);return}try{let v=await this.connection.getTransaction(B,{commitment:"confirmed",maxSupportedTransactionVersion:0});v&&(S=!0,clearInterval(I),O({err:v.meta?.err||null}),console.log("tx status from getTransaction:",B))}catch(v){S=!0,clearInterval(I),console.error("getTransaction timeout:",v,B)}},gr)),K=this.connection.onSignature(B,v=>{if(S){this.connection.removeSignatureListener(K);return}S=!0,O(v)},"confirmed"),this.connection.getSignatureStatus(B)};return await T(),{txIds:x.map(B=>B.txId),signedTxs:k}}else{let h=[];for(let x=0;x<k.length;x+=1){let T=await this.connection.sendRawTransaction(k[x].serialize(),{skipPreflight:b});h.push(T)}return{txIds:h,signedTxs:k}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:o||{}}}async sizeCheckBuildV0(e){let{computeBudgetConfig:t,splitIns:n=[],lookupTableCache:o={},lookupTableAddress:r=[],...s}=e||{},a={...this.cluster==="devnet"?{}:br,...o},c=Array.from(new Set([...this.lookupTableAddress,...r])),u=[];for(let w of c)a[w]===void 0&&u.push(new Ao(w));let l=await Ws({connection:this.connection,address:u});for(let[w,k]of Object.entries(l))a[w]=k;let d=t?yo(t):{instructions:[],instructionTypes:[]},m=await bo(this.connection,this.blockhashCommitment),p=this.signers.reduce((w,k)=>({...w,[k.publicKey.toBase58()]:k}),{}),y=[],f=[],b=[],g=0;if(this.allInstructions.forEach(w=>{let k=[...b,w],h=t?[...d.instructions,...k]:k;if(w!==n[g]&&b.length<12&&(Go({instructions:h,payer:this.feePayer,lookupTableAddressAccount:a})||Go({instructions:k,payer:this.feePayer,lookupTableAddressAccount:a})))b.push(w);else{if(b.length===0)throw Error("item ins too big");g+=w===n[g]?1:0;let x={};for(let T of[...new Set(c)])a[T]!==void 0&&(x[T]=a[T]);if(t&&Go({instructions:[...d.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:a,recentBlockhash:m})){let T=new $o({payerKey:this.feePayer,recentBlockhash:m,instructions:[...d.instructions,...b]}).compileToV0Message(Object.values(a));y.push(new Jo(T))}else{let T=new $o({payerKey:this.feePayer,recentBlockhash:m,instructions:[...b]}).compileToV0Message(Object.values(a));y.push(new Jo(T))}f.push(Array.from(new Set(b.map(T=>T.keys.filter(B=>B.isSigner).map(B=>B.pubkey.toString())).flat())).map(T=>p[T]).filter(T=>T!==void 0)),b=[w]}}),b.length>0){let k=[...new Set(b.map(h=>h.keys.filter(x=>x.isSigner).map(x=>x.pubkey.toString())).flat()).values()].map(h=>p[h]).filter(h=>h!==void 0);if(t&&Go({instructions:[...d.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:a,recentBlockhash:m})){let h=new $o({payerKey:this.feePayer,recentBlockhash:m,instructions:[...d.instructions,...b]}).compileToV0Message(Object.values(a));y.push(new Jo(h))}else{let h=new $o({payerKey:this.feePayer,recentBlockhash:m,instructions:[...b]}).compileToV0Message(Object.values(a));y.push(new Jo(h))}f.push(k)}return this.owner?.signer&&f.forEach(w=>{w.some(k=>k.publicKey.equals(this.owner.publicKey))||w.push(this.owner.signer)}),y.forEach((w,k)=>{w.sign(f[k])}),{builder:this,transactions:y,buildProps:e,signers:f,instructionTypes:this.instructionTypes,execute:async w=>{let{sequentially:k,onTxUpdate:h,skipTxCount:x=0,recentBlockHash:T,skipPreflight:B=!0}=w||{};if(y.map(async(S,I)=>{f[I].length&&S.sign(f[I]),T&&(S.message.recentBlockhash=T)}),Hn(y),this.owner?.isKeyPair){if(k){let S=0,I=[];for(let K of y){if(++S,S<=x){console.log("skip tx: ",S),I.push("tx skipped");continue}let O=await this.connection.sendTransaction(K,{skipPreflight:B});await lr(this.connection,O),I.push(O)}return{txIds:I,signedTxs:y}}return{txIds:await Promise.all(y.map(async S=>await this.connection.sendTransaction(S,{skipPreflight:B}))),signedTxs:y}}if(this.signAllTransactions){let S=await this.signAllTransactions(y.slice(x,y.length)),I=[...y.slice(0,x),...S];if(k){let K=0,O=[],v=async()=>{if(!I[K])return;if(K<x){O.push({txId:"",status:"success",signedTx:I[K]}),h?.([...O]),K++,v();return}let _=await this.connection.sendTransaction(I[K],{skipPreflight:B});O.push({txId:_,status:"sent",signedTx:I[K]}),h?.([...O]),K++;let D=!1,q=null,G=null,Z=ie=>{q!==null&&clearInterval(q),G!==null&&this.connection.removeSignatureListener(G);let he=O.findIndex(re=>re.txId===_);if(he>-1){if(O[he].status==="error"||O[he].status==="success")return;O[he].status=ie.err?"error":"success"}h?.([...O]),ie.err||v()};this.loopMultiTxStatus&&(q=setInterval(async()=>{if(D){clearInterval(q);return}try{let ie=await this.connection.getTransaction(_,{commitment:"confirmed",maxSupportedTransactionVersion:0});ie&&(D=!0,clearInterval(q),Z({err:ie.meta?.err||null}),console.log("tx status from getTransaction:",_))}catch(ie){D=!0,clearInterval(q),console.error("getTransaction timeout:",ie,_)}},gr)),G=this.connection.onSignature(_,ie=>{if(D){this.connection.removeSignatureListener(G);return}D=!0,Z(ie)},"confirmed"),this.connection.getSignatureStatus(_)};return v(),{txIds:[],signedTxs:I}}else{let K=[];for(let O=0;O<I.length;O+=1){let v=await this.connection.sendTransaction(I[O],{skipPreflight:B});K.push(v)}return{txIds:K,signedTxs:I}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}};import Jd from"bn.js";var jt=new Jd(1e6);var $u=(t=>(t.ALL="all",t.Strict="strict",t))($u||{}),Ju=(s=>(s.All="all",s.Standard="standard",s.Concentrated="concentrated",s.AllFarm="allFarm",s.StandardFarm="standardFarm",s.ConcentratedFarm="concentratedFarm",s))(Ju||{});var rt={BASE_HOST:"https://api-v3.raydium.io",OWNER_BASE_HOST:"https://owner-v1.raydium.io",SERVICE_BASE_HOST:"https://service.raydium.io",MONITOR_BASE_HOST:"https://monitor.raydium.io",SERVICE_1_BASE_HOST:"https://service-v1.raydium.io",SEND_TRANSACTION:"/send-transaction",FARM_ARP:"/main/farm/info",FARM_ARP_LINE:"/main/farm-apr-tv",CLMM_CONFIG:"/main/clmm-config",CPMM_CONFIG:"/main/cpmm-config",VERSION:"/main/version",CHECK_AVAILABILITY:"/v3/main/AvailabilityCheckAPI",RPCS:"/main/rpcs",INFO:"/main/info",STAKE_POOLS:"/main/stake-pools",CHAIN_TIME:"/main/chain-time",TOKEN_LIST:"/mint/list",MINT_INFO_ID:"/mint/ids",JUP_TOKEN_LIST:"https://lite-api.jup.ag/tokens/v1/tagged/verified",POOL_LIST:"/pools/info/list",POOL_SEARCH_BY_ID:"/pools/info/ids",POOL_SEARCH_MINT:"/pools/info/mint",POOL_SEARCH_LP:"/pools/info/lps",POOL_KEY_BY_ID:"/pools/key/ids",POOL_LIQUIDITY_LINE:"/pools/line/liquidity",POOL_POSITION_LINE:"/pools/line/position",FARM_INFO:"/farms/info/ids",FARM_LP_INFO:"/farms/info/lp",FARM_KEYS:"/farms/key/ids",OWNER_CREATED_FARM:"/create-pool/{owner}",OWNER_IDO:"/main/ido/{owner}",OWNER_STAKE_FARMS:"/position/stake/{owner}",OWNER_LOCK_POSITION:"/position/clmm-lock/{owner}",IDO_KEYS:"/ido/key/ids",SWAP_HOST:"https://transaction-v1.raydium.io",SWAP_COMPUTE:"/compute/",SWAP_TX:"/transaction/",MINT_PRICE:"/mint/price",MIGRATE_CONFIG:"/main/migrate-lp",PRIORITY_FEE:"/main/auto-fee",CPMM_LOCK:"https://dynamic-ipfs.raydium.io/lock/cpmm/position"},vA={...rt};var ec="ray_tab_hash",qs="ray_req_hash",ep=()=>{if(typeof window===void 0)return"";let i=sessionStorage.getItem(ec);return i||(i=`ray-${Date.now()}`,sessionStorage.setItem(ec,i)),i},Ar=async({logCount:i=1e3,removeLastLog:e,...t})=>{if(typeof window===void 0)return new Promise(o=>o());let n=JSON.parse(localStorage.getItem(qs)||"[]").slice(0,i-1);e&&n.pop(),new Blob([JSON.stringify(t.data)]).size>1024&&(t.data=JSON.stringify(t.data).substring(0,200)+"..."),n.unshift({...t,time:Date.now(),session:ep()});try{localStorage.setItem(qs,JSON.stringify(n))}catch{if(e){let o=!1,r=JSON.stringify(t.data).substring(0,100);for(n[0].data=r+(r.length>100?"...":"");!o;){n.pop();let s=JSON.stringify(t.data).substring(0,100);n[0].data=s+(s.length>100?"...":"");try{localStorage.setItem(qs,JSON.stringify(n)),o=!0}catch{o=!1}}return new Promise(s=>s())}return Ar({...t,logCount:i,removeLastLog:!0})}};import{TOKEN_2022_PROGRAM_ID as tp,TOKEN_PROGRAM_ID as np}from"@solana/spl-token";var wo=de("Raydium_Api"),Us=new Map;async function iw(i,e,t=1e3){let n;for(;n==null;)try{wo.debug(`Request ${i} through endlessRetry`),n=await e()}catch(o){wo.error(`Request ${i} failed, retry after ${t} ms`,o),await Ou(t)}return n}var wr=class{cluster;api;logCount;urlConfigs;constructor({cluster:e,timeout:t,logRequests:n,logCount:o,urlConfigs:r}){this.cluster=e,this.urlConfigs=r||{},this.logCount=o||1e3,this.api=tc.create({baseURL:this.urlConfigs.BASE_HOST||rt.BASE_HOST,timeout:t}),this.api.interceptors.request.use(s=>{let{method:a,baseURL:c,url:u}=s;return wo.debug(`${a?.toUpperCase()} ${c}${u}`),s},s=>(wo.error("Request failed"),Promise.reject(s))),this.api.interceptors.response.use(s=>{let{config:a,data:c,status:u}=s,{method:l,baseURL:d,url:m}=a;return n&&Ar({status:u,url:`${d}${m}`,params:a.params,data:c,logCount:this.logCount}),wo.debug(`${l?.toUpperCase()} ${d}${m}  ${u}`),c},s=>{let{config:a,response:c={}}=s,{status:u}=c,{method:l,baseURL:d,url:m}=a;return n&&Ar({status:u,url:`${d}${m}`,params:a.params,data:s.message,logCount:this.logCount}),wo.error(`${l.toUpperCase()} ${d}${m} ${u||s.message}`),Promise.reject(s)})}async getClmmConfigs(){return(await this.api.get(this.urlConfigs.CLMM_CONFIG||rt.CLMM_CONFIG)).data}async getCpmmConfigs(){return(await this.api.get(this.urlConfigs.CPMM_CONFIG||rt.CPMM_CONFIG)).data}async getClmmPoolLines(e){return(await this.api.get(`${this.urlConfigs.POOL_LIQUIDITY_LINE||rt.POOL_LIQUIDITY_LINE}?pool_id=${e}`)).data}async getBlockSlotCountForSecond(e){if(!e)return 2;let n=(await tc.post(e,{id:"getRecentPerformanceSamples",jsonrpc:"2.0",method:"getRecentPerformanceSamples",params:[4]})).result.map(o=>o.numSlots);return n.reduce((o,r)=>o+r,0)/n.length/60}async getChainTimeOffset(){return(await this.api.get(this.urlConfigs.CHAIN_TIME||rt.CHAIN_TIME)).data}async getRpcs(){return this.api.get(this.urlConfigs.RPCS||rt.RPCS)}async getTokenList(){return(await this.api.get(this.urlConfigs.TOKEN_LIST||rt.TOKEN_LIST)).data}async getJupTokenList(){return(await this.api.get("",{baseURL:this.urlConfigs.JUP_TOKEN_LIST||rt.JUP_TOKEN_LIST})).map(t=>({...t,chainId:101,programId:t.tags.includes("token-2022")?tp.toBase58():np.toBase58()}))}async getTokenInfo(e){return(await this.api.get((this.urlConfigs.MINT_INFO_ID||rt.MINT_INFO_ID)+`?mints=${e.map(n=>n.toString()).join(",")}`)).data}async getPoolList(e={}){let{type:t="all",sort:n="liquidity",order:o="desc",page:r=0,pageSize:s=100}=e;return(await this.api.get((this.urlConfigs.POOL_LIST||rt.POOL_LIST)+`?poolType=${t}&poolSortField=${n}&sortType=${o}&page=${r}&pageSize=${s}`)).data}async fetchPoolById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.POOL_SEARCH_BY_ID||rt.POOL_SEARCH_BY_ID)+`?ids=${t}`)).data}async fetchPoolKeysById(e){let{idList:t}=e,n=[],o=t.filter(s=>Us.has(s)?(n.push(Us.get(s)),!1):!0),r=[];return o.length&&(r=(await this.api.get((this.urlConfigs.POOL_KEY_BY_ID||rt.POOL_KEY_BY_ID)+`?ids=${o.join(",")}`)).data.filter(Boolean),r.forEach(a=>{Us.set(a.id,a)})),n.concat(r)}async fetchPoolByMints(e){let{mint1:t,mint2:n,type:o="all",sort:r="default",order:s="desc",page:a=1}=e,[c,u]=[t&&pt(t).toBase58(),n&&n!=="undefined"?pt(n).toBase58():""],[l,d]=u&&c>u?[u,c]:[c,u];return(await this.api.get((this.urlConfigs.POOL_SEARCH_MINT||rt.POOL_SEARCH_MINT)+`?mint1=${l}&mint2=${d}&poolType=${o}&poolSortField=${r}&sortType=${s}&pageSize=100&page=${a}`)).data}async fetchFarmInfoById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_INFO||rt.FARM_INFO)+`?ids=${t}`)).data}async fetchFarmKeysById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_KEYS||rt.FARM_KEYS)+`?ids=${t}`)).data}async fetchAvailabilityStatus(){return(await this.api.get(this.urlConfigs.CHECK_AVAILABILITY||rt.CHECK_AVAILABILITY)).data}};import{merge as sb}from"lodash";var kr="please provide owner in load() initialization or you can set by calling raydium.setOwner(owner)",nc="please provide connection in load() initialization or set it by raydium.setConnection(connection)";import{PublicKey as Sr,SystemProgram as pf}from"@solana/web3.js";import{AccountLayout as To,createAssociatedTokenAccountInstruction as oa,TOKEN_PROGRAM_ID as _n,TOKEN_2022_PROGRAM_ID as ff}from"@solana/spl-token";var Gs=(...i)=>i.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Ne=class{scope;disabled=!1;logger;constructor({scope:e,moduleName:t}){this.scope=e,this.logger=de(t)}createTxBuilder(e){return this.scope.checkOwner(),new Pr({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,blockhashCommitment:this.scope.blockhashCommitment,loopMultiTxStatus:this.scope.loopMultiTxStatus,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(Gs(e))}logInfo(...e){this.logger.info(Gs(e))}logAndCreateError(...e){let t=Gs(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as af,SystemProgram as uf}from"@solana/web3.js";import cf from"bn.js";import{createCloseAccountInstruction as lf,createInitializeAccountInstruction as mf,createTransferInstruction as df,TOKEN_PROGRAM_ID as ho}from"@solana/spl-token";import{Keypair as nf,PublicKey as Pc}from"@solana/web3.js";import of from"bn.js";import{TOKEN_PROGRAM_ID as rf}from"@solana/spl-token";function op(i){return i instanceof Uint8Array||i!=null&&typeof i=="object"&&i.constructor.name==="Uint8Array"}function Xs(i,...e){if(!op(i))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(i.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${i.length}`)}function Qs(i,e=!0){if(i.destroyed)throw new Error("Hash instance has been destroyed");if(e&&i.finished)throw new Error("Hash#digest() has already been called")}function oc(i,e){Xs(i);let t=e.outputLen;if(i.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var Tr=i=>new DataView(i.buffer,i.byteOffset,i.byteLength),Yt=(i,e)=>i<<32-e|i>>>e;var Pw=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function ip(i){if(typeof i!="string")throw new Error(`utf8ToBytes expected string, got ${typeof i}`);return new Uint8Array(new TextEncoder().encode(i))}function zs(i){return typeof i=="string"&&(i=ip(i)),Xs(i),i}var hr=class{clone(){return this._cloneInto()}},Aw={}.toString;function ic(i){let e=n=>i().update(zs(n)).digest(),t=i();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>i(),e}function rp(i,e,t,n){if(typeof i.setBigUint64=="function")return i.setBigUint64(e,t,n);let o=BigInt(32),r=BigInt(4294967295),s=Number(t>>o&r),a=Number(t&r),c=n?4:0,u=n?0:4;i.setUint32(e+c,s,n),i.setUint32(e+u,a,n)}var rc=(i,e,t)=>i&e^~i&t,sc=(i,e,t)=>i&e^i&t^e&t,Ir=class extends hr{constructor(e,t,n,o){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=o,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Tr(this.buffer)}update(e){Qs(this);let{view:t,buffer:n,blockLen:o}=this;e=zs(e);let r=e.length;for(let s=0;s<r;){let a=Math.min(o-this.pos,r-s);if(a===o){let c=Tr(e);for(;o<=r-s;s+=o)this.process(c,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===o&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Qs(this),oc(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:o,isLE:r}=this,{pos:s}=this;t[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>o-s&&(this.process(n,0),s=0);for(let d=s;d<o;d++)t[d]=0;rp(n,o-8,BigInt(this.length*8),r),this.process(n,0);let a=Tr(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let u=c/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let d=0;d<u;d++)a.setUint32(4*d,l[d],r)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:o,finished:r,destroyed:s,pos:a}=this;return e.length=o,e.pos=a,e.finished=r,e.destroyed=s,o%t&&e.buffer.set(n),e}};var sp=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),vn=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Mn=new Uint32Array(64),Hs=class extends Ir{constructor(){super(64,32,8,!1),this.A=vn[0]|0,this.B=vn[1]|0,this.C=vn[2]|0,this.D=vn[3]|0,this.E=vn[4]|0,this.F=vn[5]|0,this.G=vn[6]|0,this.H=vn[7]|0}get(){let{A:e,B:t,C:n,D:o,E:r,F:s,G:a,H:c}=this;return[e,t,n,o,r,s,a,c]}set(e,t,n,o,r,s,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=o|0,this.E=r|0,this.F=s|0,this.G=a|0,this.H=c|0}process(e,t){for(let d=0;d<16;d++,t+=4)Mn[d]=e.getUint32(t,!1);for(let d=16;d<64;d++){let m=Mn[d-15],p=Mn[d-2],y=Yt(m,7)^Yt(m,18)^m>>>3,f=Yt(p,17)^Yt(p,19)^p>>>10;Mn[d]=f+Mn[d-7]+y+Mn[d-16]|0}let{A:n,B:o,C:r,D:s,E:a,F:c,G:u,H:l}=this;for(let d=0;d<64;d++){let m=Yt(a,6)^Yt(a,11)^Yt(a,25),p=l+m+rc(a,c,u)+sp[d]+Mn[d]|0,f=(Yt(n,2)^Yt(n,13)^Yt(n,22))+sc(n,o,r)|0;l=u,u=c,c=a,a=s+p|0,s=r,r=o,o=n,n=p+f|0}n=n+this.A|0,o=o+this.B|0,r=r+this.C|0,s=s+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(n,o,r,s,a,c,u,l)}roundClean(){Mn.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var ac=ic(()=>new Hs);import{PublicKey as $p}from"@solana/web3.js";import fc,{isBN as yc}from"bn.js";import{bits as ap,BitStructure as up,blob as cp,Blob as lp,cstr as mp,f32 as dp,f32be as pp,f64 as fp,f64be as yp,greedy as bp,Layout as gp,ns64 as Pp,ns64be as Ap,nu64 as wp,nu64be as kp,offset as hp,s16 as Tp,s16be as Ip,s24 as Bp,s24be as xp,s32 as Sp,s32be as Kp,s40 as Cp,s40be as Lp,s48 as Rp,s48be as Np,s8 as Op,seq as vp,struct as Kw,Structure as Mp,u16 as Ep,u16be as _p,u24 as Fp,u24be as Vp,u32 as Wp,u32be as Dp,u40 as qp,u40be as Up,u48 as Gp,u48be as Xp,u8 as Qp,UInt as zp,union as Hp,Union as jp,unionLayoutDiscriminator as Yp,utf8 as Zp}from"@solana/buffer-layout";var ei=gp,uc=Mp,cc=jp,Cw=up,js=zp,lc=lp,Lw=bp,Br=Qp,Zt=Ep,Rw=Fp,ti=Wp,Nw=qp,Ow=Gp,mc=wp,vw=_p,Mw=Vp,Ew=Dp,_w=Up,Fw=Xp,Vw=kp,Ww=Op,Dw=Tp,qw=Bp,Oe=Sp,Uw=Cp,Gw=Rp,Xw=Pp,Qw=Ip,zw=xp,Hw=Kp,jw=Lp,Yw=Np,Zw=Ap,$w=dp,Jw=pp,ek=fp,tk=yp;var dc=vp,pc=Hp,nk=Yp,ke=cp,ok=mp,ik=Zp,Ys=ap,Zs=hp;var jn=class extends ei{blob;signed;constructor(e,t,n){super(e,n),this.blob=ke(e),this.signed=t}decode(e,t=0){let n=new fc(this.blob.decode(e,t),10,"le");return this.signed?n.fromTwos(this.span*8).clone():n}encode(e,t,n=0){return typeof e=="number"&&(e=new fc(e)),this.signed&&(e=e.toTwos(this.span*8)),this.blob.encode(e.toArrayLike(Buffer,"le",this.span),t,n)}},xr=class extends ei{_lower;_upper;constructor(e){super(8,e),this._lower=Ys(ti(),!1),this._upper=Ys(ti(),!1)}addBoolean(e){this._lower.fields.length<32?this._lower.addBoolean(e):this._upper.addBoolean(e)}decode(e,t=0){let n=this._lower.decode(e,t),o=this._upper.decode(e,t+this._lower.span);return{...n,...o}}encode(e,t,n=0){return this._lower.encode(e,t,n)+this._upper.encode(e,t,n+this._lower.span)}};function F(i){return new js(1,i)}function ut(i){return new js(4,i)}function A(i){return new jn(8,!1,i)}function J(i){return new jn(16,!1,i)}function bc(i){return new jn(1,!0,i)}function ko(i){return new jn(8,!0,i)}function gc(i){return new jn(16,!0,i)}var Pn=class extends ei{layout;decoder;encoder;constructor(e,t,n,o){super(e.span,o),this.layout=e,this.decoder=t,this.encoder=n}decode(e,t){return this.decoder(this.layout.decode(e,t))}encode(e,t,n){return this.layout.encode(this.encoder(e),t,n)}getSpan(e,t){return this.layout.getSpan(e,t)}};function L(i){return new Pn(ke(32),e=>new $p(e),e=>e.toBuffer(),i)}var $s=class extends ei{layout;discriminator;constructor(e,t){super(-1,t),this.layout=e,this.discriminator=Br()}encode(e,t,n=0){return e==null?this.discriminator.encode(0,t,n):(this.discriminator.encode(1,t,n),this.layout.encode(e,t,n+1)+1)}decode(e,t=0){let n=this.discriminator.decode(e,t);if(n===0)return null;if(n===1)return this.layout.decode(e,t+1);throw new Error("Invalid option "+this.property)}getSpan(e,t=0){let n=this.discriminator.decode(e,t);if(n===0)return 1;if(n===1)return this.layout.getSpan(e,t+1)+1;throw new Error("Invalid option "+this.property)}};function ck(i,e){return new $s(i,e)}function _e(i){return new Pn(Br(),Jp,ef,i)}function Jp(i){if(i===0)return!1;if(i===1)return!0;throw new Error("Invalid bool: "+i)}function ef(i){return i?1:0}function lk(i,e){let t=ti("length"),n=N([t,X(i,Zs(t,-t.span),"values")]);return new Pn(n,({values:o})=>o,o=>({values:o}),e)}function mk(i,e,t){let n=N([A("tag"),e.replicate("data")]);function o({tag:r,data:s}){if(!r.eq(i))throw new Error("Invalid tag, expected: "+i.toString("hex")+", got: "+r.toString("hex"));return s}return new Pn(n,o,r=>({tag:i,data:r}),t)}function tf(i){let e=ti("length"),t=N([e,ke(Zs(e,-e.span),"data")]);return new Pn(t,({data:n})=>n,n=>({data:n}),i)}function $t(i){return new Pn(tf(),e=>e.toString("utf-8"),e=>Buffer.from(e,"utf-8"),i)}function dk(i,e){let t=pc(Br(),e);return i.forEach((n,o)=>t.addVariant(o,n,n.property)),t}function pk(i,e,t){let n=N([X(i,e,"values")]);return new Pn(n,({values:o})=>o,o=>({values:o}),t)}var Js=class extends uc{decode(e,t){return super.decode(e,t)}};function N(i,e,t){return new Js(i,e,t)}var ea=class extends cc{encodeInstruction(e){let t=Math.max(...Object.values(this.registry).map(o=>o.span)),n=Buffer.alloc(t);return n.slice(0,this.encode(e,n))}decodeInstruction(e){return this.decode(e)}};function fk(i,e,t){return new ea(i,e,t)}var ta=class extends lc{decode(e,t){let n=super.decode(e,t);if(!n.every(o=>o===0))throw new Error("nonzero padding bytes");return n}};function yk(i){return new ta(i)}function X(i,e,t){let n,o=typeof e=="number"?e:yc(e)?e.toNumber():new Proxy(e,{get(r,s){if(!n){let a=Reflect.get(r,"count");n=yc(a)?a.toNumber():a,Reflect.set(r,"count",n)}return Reflect.get(r,s)},set(r,s,a){return s==="count"&&(n=a),Reflect.set(r,s,a)}});return dc(i,o,t)}var Jt=N([L("mint"),L("owner"),A("amount"),ut("delegateOption"),L("delegate"),F("state"),ut("isNativeOption"),A("isNative"),A("delegatedAmount"),ut("closeAuthorityOption"),L("closeAuthority")]);var Ck=de("Raydium_Util");function Ac({owner:i,solAccountResp:e,tokenAccountResp:t}){let n=[],o=[];for(let{pubkey:r,account:s}of t.value){let a=Jt.decode(s.data),{mint:c,amount:u}=a;n.push({publicKey:r,mint:c,amount:u,isAssociated:$(i,c,s.owner).publicKey.equals(r),isNative:!1,programId:s.owner}),o.push({pubkey:r,accountInfo:a,programId:s.owner})}return e&&n.push({mint:Pc.default,amount:new of(String(e.lamports)),isNative:!0,programId:e.owner}),{tokenAccounts:n,tokenAccountRawInfos:o}}function Ue({fromPublicKey:i,programId:e=rf,assignSeed:t}){let n=t?btoa(t).slice(0,32):nf.generate().publicKey.toBase58().slice(0,32);return{publicKey:sf(i,n,e),seed:n}}function sf(i,e,t){let n=Buffer.concat([i.toBuffer(),Buffer.from(e),t.toBuffer()]),o=ac(n);return new Pc(o)}function na(i){let{mint:e,tokenAccount:t,owner:n,programId:o=ho}=i;return mf(t,e,n,o)}function An(i){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:o,programId:r=ho}=i;return lf(e,t,o,n,r)}async function En(i){let{connection:e,amount:t,commitment:n,payer:o,owner:r,skipCloseAccount:s}=i,a=await e.getMinimumBalanceForRentExemption(Jt.span,n),c=Y(t).add(new cf(a)),u=Ue({fromPublicKey:o,programId:ho});return{addresses:{newAccount:u.publicKey},signers:[],instructions:[uf.createAccountWithSeed({fromPubkey:o,basePubkey:o,seed:u.seed,newAccountPubkey:u.publicKey,lamports:c.toNumber(),space:Jt.span,programId:ho}),na({mint:new af(nt.address),tokenAccount:u.publicKey,owner:r,programId:ho})],instructionTypes:[V.CreateAccount,V.InitAccount],endInstructionTypes:s?[]:[V.CloseAccount],endInstructions:s?[]:[An({tokenAccount:u.publicKey,payer:o,owner:r})]}}function wc({source:i,destination:e,owner:t,amount:n,multiSigners:o=[],tokenProgram:r=ho}){return df(i,e,t,BigInt(String(n)),o,r)}var ni=class extends Ne{_tokenAccounts=[];_tokenAccountRawInfos=[];_accountChangeListenerId;_accountListener=[];_clientOwnedToken=!1;_notSubscribeAccountChange=!1;_accountFetchTime=0;constructor(e){super(e);let{tokenAccounts:t,tokenAccountRawInfos:n,notSubscribeAccountChange:o}=e;this._tokenAccounts=t||[],this._tokenAccountRawInfos=n||[],this._notSubscribeAccountChange=o??!0,this._clientOwnedToken=!!(t||n)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}set notSubscribeAccountChange(e){this._notSubscribeAccountChange=e}updateTokenAccount({tokenAccounts:e,tokenAccountRawInfos:t}){return e&&(this._tokenAccounts=e),t&&(this._tokenAccountRawInfos=t),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(e){return this._accountListener.push(e),this}removeAccountChangeListener(e){return this._accountListener=this._accountListener.filter(t=>t!==e),this}getAssociatedTokenAccount(e,t){return $(this.scope.ownerPubKey,e,t).publicKey}resetTokenAccounts(){this._clientOwnedToken||(this._tokenAccounts=[],this._tokenAccountRawInfos=[])}async fetchWalletTokenAccounts(e){if(this._clientOwnedToken||!e?.forceUpdate&&this._tokenAccounts.length&&Date.now()-this._accountFetchTime<(this._notSubscribeAccountChange?1e3*5:1e3*60*3))return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let n={...{},...e},[o,r,s]=await Promise.all([this.scope.connection.getAccountInfo(this.scope.ownerPubKey,n.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:_n},n.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:ff},n.commitment)]),{tokenAccounts:a,tokenAccountRawInfos:c}=Ac({owner:this.scope.ownerPubKey,solAccountResp:o,tokenAccountResp:{context:r.context,value:[...r.value,...s.value]}});return this._tokenAccounts=a,this._tokenAccountRawInfos=c,this._accountFetchTime=Date.now(),this._notSubscribeAccountChange||(this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>{this.fetchWalletTokenAccounts({forceUpdate:!0}),this._accountListener.forEach(u=>u({tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos}))},{commitment:e?.commitment})),{tokenAccounts:a,tokenAccountRawInfos:c}}clearAccountChangeCkb(){this._accountChangeListenerId!==void 0&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId)}async getCreatedTokenAccount({mint:e,programId:t=_n,associatedOnly:n=!0}){await this.fetchWalletTokenAccounts();let o=this._tokenAccounts.filter(({mint:s})=>s?.equals(e)).sort((s,a)=>s.amount.lt(a.amount)?1:-1),r=this.getAssociatedTokenAccount(e,t);for(let s of o){let{publicKey:a}=s;if(a&&(!n||n&&r.equals(a)))return a}}async getOrCreateTokenAccount(e){await this.fetchWalletTokenAccounts();let{mint:t,createInfo:n,associatedOnly:o,owner:r,notUseTokenAccount:s=!1,skipCloseAccount:a=!1,checkCreateATAOwner:c=!1,assignSeed:u}=e,l=new Sr(e.tokenProgram||_n),d=this.getAssociatedTokenAccount(t,new Sr(l)),m=(s?[]:this.tokenAccountRawInfos).filter(y=>y.accountInfo.mint.equals(t)&&(!o||y.pubkey.equals(d))).sort((y,f)=>y.accountInfo.amount.lt(f.accountInfo.amount)?1:-1);n===void 0||m.length>0;let p={instructions:[],endInstructions:[],signers:[],instructionTypes:[],endInstructionTypes:[]};if(o){let y=oa(r,d,r,t,l),f=this.tokenAccountRawInfos.find(b=>b.pubkey.equals(d));if(c){let b=await this.scope.connection.getAccountInfo(d);if(b===null)p.instructions?.push(y),p.instructionTypes.push(V.CreateATA);else if(!(b.owner.equals(l)&&To.decode(b.data).mint.equals(t)&&To.decode(b.data).owner.equals(r)))throw Error(`create ata check error -> mint: ${t.toString()}, ata: ${d.toString()}`)}else f===void 0&&(p.instructions.push(y),p.instructionTypes.push(V.CreateATA));if(t.equals(j)&&n?.amount){let b=await En({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:n.payer||this.scope.ownerPubKey,amount:n.amount??0,skipCloseAccount:a});p.instructions.push(...b.instructions||[]),p.endInstructions.push(...b.endInstructions||[]),p.instructionTypes.push(...b.instructionTypes||[]),p.endInstructionTypes.push(...b.endInstructionTypes||[]),n.amount&&(p.instructions.push(wc({source:b.addresses.newAccount,destination:d,owner:this.scope.ownerPubKey,amount:n.amount,tokenProgram:_n})),p.instructionTypes.push(V.TransferAmount))}return!a&&f===void 0&&(p.endInstructions.push(An({owner:r,payer:n?.payer||r,tokenAccount:d,programId:l})),p.endInstructionTypes.push(V.CloseAccount)),{account:d,instructionParams:p}}else{let y=Ue({fromPublicKey:r,programId:l,assignSeed:u}),f=await this.scope.connection.getMinimumBalanceForRentExemption(To.span),b=pf.createAccountWithSeed({fromPubkey:r,basePubkey:r,seed:y.seed,newAccountPubkey:y.publicKey,lamports:f+Number(n?.amount?.toString()??0),space:To.span,programId:l});return p.instructions.push(b,na({mint:t,tokenAccount:y.publicKey,owner:this.scope.ownerPubKey,programId:l})),p.instructionTypes.push(V.CreateAccount),p.instructionTypes.push(V.InitAccount),a||(p.endInstructions.push(An({owner:r,payer:n?.payer||r,tokenAccount:y.publicKey,programId:l})),p.endInstructionTypes.push(V.CloseAccount)),{account:y.publicKey,instructionParams:p}}}async checkOrCreateAta({mint:e,programId:t=_n,autoUnwrapWSOLToSOL:n}){await this.fetchWalletTokenAccounts();let o=this.scope.account.tokenAccounts.find(({mint:a})=>a?.toBase58()===e.toBase58())?.publicKey,r=this.scope.ownerPubKey,s={};if(!o){let a=this.getAssociatedTokenAccount(e,t),c=await oa(r,a,r,e,t);s.instructions=[c],s.instructionTypes=[V.CreateATA],o=a}return n&&j.toBase58()===e.toBase58()&&(s.endInstructions=[An({owner:r,payer:r,tokenAccount:o,programId:t})],s.endInstructionTypes=[V.CloseAccount]),{pubKey:o,newInstructions:s}}async handleTokenAccount(e){let{side:t,amount:n,mint:o,programId:r=_n,tokenAccount:s,payer:a=this.scope.ownerPubKey,bypassAssociatedCheck:c,skipCloseAccount:u,checkCreateATAOwner:l}=e,d=this.getAssociatedTokenAccount(o,r);if(new Sr(j).equals(o)){let m=await En({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:a,amount:n,skipCloseAccount:u});return{tokenAccount:m.addresses.newAccount,...m}}else if(!s||t==="out"&&!d.equals(s)&&!c){let m=[],p=oa(this.scope.ownerPubKey,d,this.scope.ownerPubKey,o,r);if(l){let y=await this.scope.connection.getAccountInfo(d);if(y===null)m.push(p);else if(!(y.owner.equals(_n)&&To.decode(y.data).mint.equals(o)&&To.decode(y.data).owner.equals(this.scope.ownerPubKey)))throw Error(`create ata check error -> mint: ${o.toString()}, ata: ${d.toString()}`)}else m.push(p);return{tokenAccount:d,instructions:m,instructionTypes:[V.CreateATA]}}return{tokenAccount:s}}async processTokenAccount(e){let{mint:t,programId:n=_n,amount:o,useSOLBalance:r,handleTokenAccount:s,feePayer:a}=e,c,u=this.createTxBuilder(a);if(t.equals(new Sr(j))&&r){let{tokenAccount:l,...d}=await this.handleTokenAccount({side:"in",amount:o||0,mint:t,bypassAssociatedCheck:!0,programId:n});c=l,u.addInstruction(d)}else if(c=await this.getCreatedTokenAccount({mint:t,associatedOnly:!1,programId:n}),!c&&s){let{tokenAccount:l,...d}=await this.scope.account.handleTokenAccount({side:"in",amount:0,mint:t,bypassAssociatedCheck:!0,programId:n});c=l,u.addInstruction(d)}return{tokenAccount:c,...u.AllTxData}}};import{PublicKey as Ie,SystemProgram as Mf}from"@solana/web3.js";import{createAssociatedTokenAccountInstruction as Ef}from"@solana/spl-token";import{PublicKey as Sc}from"@solana/web3.js";var ia=N([F("instruction")]),ra=N([F("instruction")]),yf=N([A("rewardState"),A("rewardOpenTime"),A("rewardEndTime"),A("rewardLastUpdateTime"),A("totalReward"),A("totalRewardEmissioned"),A("rewardClaimed"),A("rewardPerSecond"),J("accRewardPerShare"),L("rewardVault"),L("rewardMint"),L("rewardSender"),A("rewardType"),X(A(),15,"padding")]),bf=N([A("state"),A("nonce"),L("lpVault"),L("rewardVault"),L(),L(),A(),A(),A("totalReward"),J("perShareReward"),A("lastSlot"),A("perSlotReward")]),gf=N([A("state"),A("nonce"),L("lpVault"),L("rewardVaultA"),A("totalRewardA"),J("perShareRewardA"),A("perSlotRewardA"),F("option"),L("rewardVaultB"),ke(7),A("totalRewardB"),J("perShareRewardB"),A("perSlotRewardB"),A("lastSlot"),L()]),Pf=N([A(),A("state"),A("nonce"),A("validRewardTokenNum"),J("rewardMultiplier"),A("rewardPeriodMax"),A("rewardPeriodMin"),A("rewardPeriodExtend"),L("lpMint"),L("lpVault"),X(yf,5,"rewardInfos"),L("creator"),L(),X(A(),32,"padding")]),kc=new Proxy(bf,{get(i,e,t){return e==="decode"?(...n)=>{let o=i.decode(...n);return{...o,version:3,rewardInfos:[{rewardVault:o.rewardVault,totalReward:o.totalReward,perSlotReward:o.perSlotReward,perShareReward:o.perShareReward}]}}:Reflect.get(i,e,t)}}),hc=new Proxy(gf,{get(i,e,t){return e==="decode"?(...n)=>{let o=i.decode(...n);return{...o,version:5,rewardInfos:[{rewardVault:o.rewardVaultA,totalReward:o.totalRewardA,perSlotReward:o.perSlotRewardA,perShareReward:o.perShareRewardA},{rewardVault:o.rewardVaultB,totalReward:o.totalRewardB,perSlotReward:o.perSlotRewardB,perShareReward:o.perShareRewardB}]}}:Reflect.get(i,e,t)}}),oi=new Proxy(Pf,{get(i,e,t){return e==="decode"?(...n)=>{let o=i.decode(...n);return{...o,version:6,rewardInfos:o.rewardInfos.map(r=>({...r,rewardType:(Object.entries(Fn).find(s=>String(s[1])===r.rewardType.toString())??["Standard SPL"])[0]}))}}:Reflect.get(i,e,t)}}),Af=N([A("isSet"),A("rewardPerSecond"),A("rewardOpenTime"),A("rewardEndTime"),A("rewardType")]),sa=N([F("instruction"),A("nonce"),X(Af,5,"rewardTimeInfo")]),aa=N([F("instruction"),A("rewardReopenTime"),A("rewardEndTime"),A("rewardPerSecond")]),ua=N([F("instruction"),A("isSet"),A("rewardPerSecond"),A("rewardOpenTime"),A("rewardEndTime"),A("rewardType")]),ah=N([A("state"),L("id"),L("owner"),A("deposited"),X(A(),1,"rewardDebts")]),ii=N([A("state"),L("id"),L("owner"),A("deposited"),X(J(),1,"rewardDebts"),A(""),A("voteLockedBalance"),X(A(),15)]),uh=N([A("state"),L("id"),L("owner"),A("deposited"),X(A(),2,"rewardDebts")]),Tc=N([A("state"),L("id"),L("owner"),A("deposited"),X(J(),2,"rewardDebts"),X(A(),17)]),Ic=N([A(),A("state"),L("id"),L("owner"),A("deposited"),X(J(),5,"rewardDebts"),X(A(),16)]),wt=N([F("instruction"),A("amount")]),wf=N([L("mint"),L("grantAuthority"),A("baselineVoteWeightScaledFactor"),A("maxExtraLockupVoteWeightScaledFactor"),A("lockupSaturationSecs"),bc("digitShift"),X(F(),7,"reserved1"),X(A(),7,"reserved2")]),Bc=N([ke(8),L("governanceProgramId"),L("realm"),L("realmGoverningTokenMint"),L("realmAuthority"),X(F(),32,"reserved1"),X(wf,4,"votingMints"),ko("timeOffset"),F("bump"),X(F(),7,"reserved2"),X(A(),11,"reserved3")]),kf=N([ko("startTime"),ko("endTime"),F("kind"),X(F(),15,"reserved")]),hf=N([X(kf,1,"lockup"),A("amountDeposited_native"),A("amountInitiallyLockedNative"),_e("isUsed"),_e("allowClawback"),F("votingMintConfigIdx"),X(F(),29,"reserved")]),xc=N([ke(8),L("voterAuthority"),L("registrar"),X(hf,32,"deposits"),F("voterBump"),F("voterWweightRecordBump"),X(F(),94,"reserved")]);var bh=de("Raydium_farm_config"),Kc=new Sc("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Cc=new Sc("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1"),Lc={3:kc,5:hc,6:oi},Rc={3:ii,5:Tc,6:Ic},ca=i=>[3,4,5,6].indexOf(i)!==-1,la=i=>{let{version:e,rewardInfos:t,rewardTokenAccountsPublicKeys:n}=i,o=`rewardInfo:${JSON.stringify(t)}, rewardAccount:${JSON.stringify(n)}`;return{3:()=>{if(t.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${o}`},5:()=>{if(t.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${o}`},6:()=>{if(!n.length||t.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${o}`}}[e]?.()},Fn={"Standard SPL":0,"Option tokens":1},Et={[Es.toString()]:3,[ju.toString()]:4,[_s.toString()]:5,[go.toString()]:6};import{PublicKey as se,SystemProgram as Yn,SYSVAR_CLOCK_PUBKEY as Bo,SYSVAR_RENT_PUBKEY as Bf,TransactionInstruction as $e}from"@solana/web3.js";import Kr from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as xf,createAssociatedTokenAccountInstruction as Sf,TOKEN_PROGRAM_ID as xt}from"@solana/spl-token";function ma(i,e,t){return te([e.toBuffer(),Buffer.from("registrar","utf8"),t.toBuffer()],i)}function da(i,e){return te([e.toBuffer(),Buffer.from("voting_mint_seed","utf8")],i)}function pa(i,e){return te([e.toBuffer()],i)}function fa(i,e,t){return te([e.toBuffer(),Buffer.from("voter","utf8"),t.toBuffer()],i)}function ya(i,e,t){return te([e.toBuffer(),Buffer.from("voter-weight-record","utf8"),t.toBuffer()],i)}function ba(i,e,t,n){return te([Buffer.from("governance","utf8"),e.toBuffer(),t.toBuffer(),n.toBuffer()],i)}import Bt from"bn.js";var ri=de("Raydium.farm.util");function si({programId:i,poolId:e,mint:t,type:n}){let{publicKey:o}=te([e.toBuffer(),t.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],i);return o}function yt({programId:i,poolId:e,owner:t,version:n}){let{publicKey:o}=te([e.toBuffer(),t.toBuffer(),Buffer.from(n===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],i);return o}var Nc=({programId:i,poolId:e})=>te([e.toBuffer()],i);function Oc(i){return{isSet:new Bt(1),rewardPerSecond:Y(i.perSecond),rewardOpenTime:Y(i.openTime),rewardEndTime:Y(i.endTime),rewardType:Y(Fn[i.rewardType])}}function ga(i){return Y(i.endTime).sub(Y(i.openTime)).mul(Y(i.perSecond))}function Io(i){let e=Rc[i];return e||ri.logWithError("invalid version",i),e}function Tf(i){let e=Lc[i];return e||ri.logWithError("invalid version",i),e}function If(i,e,t,n){if(i.version===3||i.version===5){if(i.lastSlot.gte(new Bt(t)))return i;let o=new Bt(t).sub(i.lastSlot);i.lastSlot=new Bt(t);for(let r of i.rewardInfos){if(e.amount.eq(new Bt(0)))continue;let s=r.perSlotReward.mul(o);r.perShareReward=r.perShareReward.add(s.mul(new Bt(10).pow(new Bt(i.version===3?9:15))).div(e.amount)),r.totalReward=r.totalReward.add(s)}}else if(i.version===6)for(let o of i.rewardInfos){if(o.rewardState.eq(new Bt(0)))continue;let r=Bt.min(new Bt(n),o.rewardEndTime);if(o.rewardOpenTime.gte(r))continue;let a=r.sub(o.rewardLastUpdateTime).mul(o.rewardPerSecond),c=o.totalReward.sub(o.totalRewardEmissioned);c.lt(a)?(a=c,o.rewardLastUpdateTime=o.rewardLastUpdateTime.add(c.div(o.rewardPerSecond))):o.rewardLastUpdateTime=r,!e.amount.eq(new Bt(0))&&(o.accRewardPerShare=o.accRewardPerShare.add(a.mul(i.rewardMultiplier).div(e.amount)),o.totalRewardEmissioned=o.totalRewardEmissioned.add(a))}return i}async function Oh({connection:i,farmPools:e,owner:t,config:n,chainTime:o}){let r=!1,s=!1,a=new Bt(10),c=[];for(let m of e){let p=Re(m);p.version===6?s=!0:r=!0,c.push({pubkey:p.id,version:p.version,key:"state",poolId:p.id},{pubkey:p.lpVault,version:p.version,key:"lpVault",poolId:p.id}),t&&c.push({pubkey:yt({programId:p.programId,poolId:p.id,owner:t,version:m.version}),version:p.version,key:"ledger",poolId:p.id})}let u={},l=await Ke(i,c,n);for(let{pubkey:m,version:p,key:y,poolId:f,accountInfo:b}of l){let g=f.toBase58();if(u[g]={...u[g]},y==="state"){let w=Tf(p);(!b||!b.data||b.data.length!==w.span)&&ri.logWithError(`invalid farm state account info, pools.id, ${m}`),u[g].state=w.decode(b.data)}else if(y==="lpVault")(!b||!b.data||b.data.length!==Jt.span)&&ri.logWithError(`invalid farm lp vault account info, pools.lpVault, ${m}`),u[g].lpVault=Jt.decode(b.data);else if(y==="ledger"){let w=Io(p);b&&b.data&&(b.data.length!==w.span&&ri.logWithError(`invalid farm ledger account info, ledger, ${m}`),u[g].ledger=w.decode(b.data))}}let d=s||r?await i.getSlot():0;for(let m of Object.keys(u))u[m]!==void 0&&(u[m].state=If(u[m].state,u[m].lpVault,d,o));for(let[m,{state:p,ledger:y}]of Object.entries(u))if(y){let f=p.version===6?p.rewardMultiplier:p.rewardInfos.length===1?a.pow(new Bt(9)):a.pow(new Bt(15)),b=p.rewardInfos.map((g,w)=>{let k=y.rewardDebts[w];return y.deposited.mul(p.version===6?g.accRewardPerShare:g.perShareReward).div(f).sub(k)});u[m].wrapped={...u[m].wrapped,pendingRewards:b}}return u}function vh(i,e=Date.now()){if(i.version===6){let t=i.state.rewardInfos;if(t.every(({rewardOpenTime:n})=>Wu(e,n.toNumber(),{unit:"s"})))return"upcoming pool";if(t.every(({rewardEndTime:n})=>Du(e,n.toNumber(),{unit:"s"})))return"closed pool"}else{let t=i.state.rewardInfos.map(({perSlotReward:n})=>n);if(t.length===2){if(String(t[0])==="0"&&String(t[1])!=="0")return"normal fusion pool";if(String(t[0])!=="0"&&String(t[1])!=="0")return"dual fusion pool";if(String(t[0])==="0"&&String(t[1])==="0")return"closed pool"}else if(t.length===1&&String(t[0])==="0")return"closed pool"}}async function Pa(i,e,t,n){let o=await i.getAccountInfo(e);if(o===null)throw Error("registrar info check error");let s=Bc.decode(o.data).votingMints.findIndex(l=>l.mint.equals(n));if(s===-1)throw Error("find voter mint error");let a=await i.getAccountInfo(t);if(a===null)return{index:s,isInit:!1};let u=xc.decode(a.data).deposits.findIndex(l=>l.isUsed&&l.votingMintConfigIdx===s);return u===-1?{index:s,isInit:!1}:{index:u,isInit:!0}}var Kf=de("Raydium_farm_instruction"),ai={voterStakeRegistryCreateVoter:Buffer.from([6,24,245,52,243,255,148,25]),voterStakeRegistryCreateDepositEntry:Buffer.from([185,131,167,186,159,125,19,67]),voterStakeRegistryDeposit:Buffer.from([242,35,198,137,82,225,242,182]),voterStakeRegistryWithdraw:Buffer.from([183,18,70,156,148,109,161,34]),voterStakeRegistryUpdateVoterWeightRecord:Buffer.from([45,185,3,36,109,190,115,169])};function ui(i){let{version:e,id:t,ledger:n,programId:o,owner:r}=i,s={3:9,5:10}[e];s||Kf.logWithError(`invalid farm pool version: ${e}`);let a=Buffer.alloc(ia.span);ia.encode({instruction:s},a);let c=[P({pubkey:t}),P({pubkey:n}),P({pubkey:r,isWritable:!1}),P({pubkey:Yn.programId,isWritable:!1}),P({pubkey:Bf,isWritable:!1})];return{instruction:new $e({programId:o,keys:c,data:a}),instructionType:V.FarmV3CreateLedger}}function vc(i){let e=Buffer.alloc(sa.span);sa.encode({instruction:0,nonce:new Kr(i.nonce),rewardTimeInfo:i.rewardInfoConfig},e);let t=[...Is,P({pubkey:i.farmId}),P({pubkey:i.farmAuthority,isWritable:!1}),P({pubkey:i.lpVault}),P({pubkey:i.lpMint,isWritable:!1}),P({pubkey:i.lockVault}),P({pubkey:i.lockMint,isWritable:!1}),P({pubkey:i.lockUserAccount??ot}),P({pubkey:i.owner,isWritable:!1,isSigner:!0})];for(let n of i.rewardInfo)t.push(P({pubkey:n.rewardMint,isWritable:!1}),P({pubkey:n.rewardVault}),P({pubkey:n.userRewardToken}));return{instruction:new $e({programId:i.programId,keys:t,data:e}),instructionType:V.FarmV6Create}}function Mc(i){let e=Buffer.alloc(ra.span);ra.encode({instruction:5},e);let t=[P({pubkey:xt,isWritable:!1}),P({pubkey:i.id}),P({pubkey:i.authority,isWritable:!1}),P({pubkey:i.lpVault,isWritable:!1}),P({pubkey:i.rewardVault}),P({pubkey:i.userRewardToken}),P({pubkey:i.owner,isWritable:!1,isSigner:!0})];return{instruction:new $e({programId:i.programId,keys:t,data:e}),instructionType:V.FarmV6CreatorWithdraw}}function Cf(i,e,t,n,o,r,s,a,c,u,l,d,m){let p=N([F("depositEntryIndex"),A("amount")]),y=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:xt,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:ir,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({depositEntryIndex:d,amount:m},f);let b=Buffer.from([...ai.voterStakeRegistryDeposit,...f]);return new $e({keys:y,programId:i,data:b})}function Lf(i,e,t,n){let o=N([]),r=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:Yn.programId,isSigner:!1,isWritable:!1}],s=Buffer.alloc(o.span);o.encode({},s);let a=Buffer.from([...ai.voterStakeRegistryUpdateVoterWeightRecord,...s]);return new $e({keys:r,programId:i,data:a})}function Rf(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y){let f=N([F("depositEntryIndex"),A("amount")]),b=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:xt,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:ir,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);f.encode({depositEntryIndex:p,amount:y},g);let w=Buffer.from([...ai.voterStakeRegistryWithdraw,...g]);return new $e({keys:b,programId:i,data:w})}function Nf(i,e,t,n,o,r){let s=N([F("ins")]),a=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:Yn.programId,isSigner:!1,isWritable:!1}],c=Buffer.alloc(s.span);return s.encode({ins:23},c),new $e({keys:a,programId:i,data:c})}function Of(i,e,t,n,o,r,s,a){let c=N([F("voterBump"),F("voterWeightRecordBump")]),u=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:Yn.programId,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:ir,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({voterBump:s,voterWeightRecordBump:a},l);let d=Buffer.from([...ai.voterStakeRegistryCreateVoter,...l]);return new $e({keys:u,programId:i,data:d})}function vf(i,e,t,n,o,r,s,a,c,u,l,d){let m=N([F("depositEntryIndex"),F("kind"),F("option"),A("startTs"),ut("periods"),_e("allowClawback")]),p=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:Yn.programId,isSigner:!1,isWritable:!1},{pubkey:xt,isSigner:!1,isWritable:!1},{pubkey:xf,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1}],y=Buffer.alloc(m.span);m.encode({depositEntryIndex:a,kind:c,option:u===void 0?0:1,startTs:u,periods:l,allowClawback:d},y);let f=Buffer.from([...ai.voterStakeRegistryCreateDepositEntry,...y]);return new $e({keys:p,programId:i,data:f})}async function Yh({connection:i,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:o,communityTokenMint:r,owner:s,poolId:a,tokenProgram:c}){let u=ma(n,o,r).publicKey,l=yt({programId:e,poolId:a,owner:s,version:3}),d=await i.getAccountInfo(l);if(d===null)throw Error("user is not staker");let m=ii.decode(d.data),p=m.deposited.sub(m.voteLockedBalance);if(console.log("amount",p.toString()),p.eq(new Kr(0)))throw Error("user do not has new stake amount");let y=da(e,a).publicKey,f=pa(e,a).publicKey,{publicKey:b,nonce:g}=fa(n,u,s),w=$(b,y,c).publicKey,{publicKey:k,nonce:h}=ya(n,u,s),x=ba(t,o,r,s).publicKey,T=[],B=$(s,y,c).publicKey;if(await i.getAccountInfo(B)===null&&T.push(Sf(s,B,s,y)),await i.getAccountInfo(b)===null){let v=Nf(t,o,s,r,s,x);T.push(v,Of(n,u,b,k,s,s,g,h))}let{index:K,isInit:O}=await Pa(i,u,b,y);return O||T.push(vf(n,u,b,w,s,s,y,K,0,void 0,0,!1)),T.push(Cf(n,u,b,w,B,s,l,a,y,f,e,K,p),Lf(n,u,b,k)),T}async function Zh({connection:i,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:o,communityTokenMint:r,owner:s,poolId:a,tokenProgram:c}){let u=ma(n,o,r).publicKey,l=yt({programId:e,poolId:a,owner:s,version:3}),d=await i.getAccountInfo(l);if(d===null)throw Error("user is not staker");let m=ii.decode(d.data);if(m.voteLockedBalance.eq(new Kr(0)))throw Error("user has vote locked balance = 0");let p=da(e,a).publicKey,y=pa(e,a).publicKey,{publicKey:f}=fa(n,u,s),b=$(f,p,c).publicKey,{publicKey:g}=ya(n,u,s),w=ba(t,o,r,s).publicKey,k=[],{index:h,isInit:x}=await Pa(i,u,f,p);if(!x)throw Error("deposit entry index check error");return k.push(Rf(n,u,f,s,w,g,b,$(s,p,c).publicKey,l,a,p,y,e,h,m.voteLockedBalance)),k}function Aa({payer:i,rewardVault:e,userRewardTokenPub:t,farmKeys:n,rewardInfo:o}){let r=Buffer.alloc(aa.span);aa.encode({instruction:3,rewardReopenTime:Y(o.openTime),rewardEndTime:Y(o.endTime),rewardPerSecond:Y(o.perSecond)},r);let s=[P({pubkey:xt,isWritable:!1}),P({pubkey:n.id}),P({pubkey:n.lpVault,isWritable:!1}),P({pubkey:e}),P({pubkey:t}),P({pubkey:i,isWritable:!1,isSigner:!0})];return new $e({programId:n.programId,keys:s,data:r})}function wa({payer:i,userRewardTokenPub:e,farmKeys:t,rewardVault:n,rewardInfo:o}){let r=Buffer.alloc(ua.span);ua.encode({instruction:4,isSet:new Kr(1),rewardPerSecond:Y(o.perSecond),rewardOpenTime:Y(o.openTime),rewardEndTime:Y(o.endTime),rewardType:Y(Fn[o.rewardType])},r);let s=[...Is,P({pubkey:t.id}),P({pubkey:t.authority,isWritable:!1}),P({pubkey:o.mint,isWritable:!1}),P({pubkey:n}),P({pubkey:e}),P({pubkey:i,isWritable:!1,isSigner:!0})];return new $e({programId:t.programId,keys:s,data:r})}function $h(i){let{farmInfo:e,farmKeys:t,version:n,lpAccount:o,rewardAccounts:r,owner:s,instruction:a,amount:c,deposit:u}=i,[l,d]=[new se(e.programId),new se(e.id)],m=yt({programId:l,poolId:d,owner:s,version:n}),p=Buffer.alloc(wt.span);wt.encode({instruction:a,amount:c},p);let y=n===6?[P({pubkey:xt,isWritable:!1}),...u?[P({pubkey:Yn.programId,isWritable:!1})]:[],P({pubkey:d}),P({pubkey:new se(t.authority),isWritable:!1}),P({pubkey:new se(t.lpVault)}),P({pubkey:m}),P({pubkey:s,isWritable:!1,isSigner:!0}),P({pubkey:o})]:[P({pubkey:d}),P({pubkey:new se(t.authority),isWritable:!1}),P({pubkey:m}),P({pubkey:s,isWritable:!1,isSigner:!0}),P({pubkey:o}),P({pubkey:new se(t.lpVault)}),P({pubkey:r[0]}),P({pubkey:new se(t.rewardInfos[0].vault)}),P({pubkey:Bo,isWritable:!1}),P({pubkey:xt,isWritable:!1})];if(n===5)for(let f=1;f<t.rewardInfos.length;f++)y.push(P({pubkey:r[f]})),y.push(P({pubkey:new se(t.rewardInfos[f].vault)}));if(n===6)for(let f=0;f<t.rewardInfos.length;f++)y.push(P({pubkey:new se(t.rewardInfos[f].vault)})),y.push(P({pubkey:r[f]}));return new $e({programId:l,keys:y,data:p})}function ci(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:r,amount:s}=i,[a,c]=[new se(e.programId),new se(e.id)],u=yt({programId:a,poolId:c,owner:r,version:6}),l=Buffer.alloc(wt.span);wt.encode({instruction:2,amount:Y(s)},l);let d=[P({pubkey:xt,isWritable:!1}),P({pubkey:c}),P({pubkey:new se(t.authority),isWritable:!1}),P({pubkey:new se(t.lpVault)}),P({pubkey:u}),P({pubkey:r,isWritable:!1,isSigner:!0}),P({pubkey:n})];for(let m=0;m<t.rewardInfos.length;m++)d.push(P({pubkey:new se(t.rewardInfos[m].vault)})),d.push(P({pubkey:o[m]}));return new $e({programId:a,keys:d,data:l})}function li(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:r,amount:s,userAuxiliaryLedgers:a}=i,[c,u]=[new se(e.programId),new se(e.id)],l=yt({programId:c,poolId:u,owner:r,version:5}),d=Buffer.alloc(wt.span);wt.encode({instruction:12,amount:Y(s)},d);let m=[P({pubkey:u}),P({pubkey:new se(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:r,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new se(t.lpVault)}),P({pubkey:o[0]}),P({pubkey:new se(t.rewardInfos[0].vault)}),P({pubkey:Bo,isWritable:!1}),P({pubkey:xt,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)m.push(P({pubkey:o[p]})),m.push(P({pubkey:new se(t.rewardInfos[p].vault)}));if(a)for(let p of a)m.push(P({pubkey:p}));return new $e({programId:c,keys:m,data:d})}function Ec(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:r,amount:s,userAuxiliaryLedgers:a}=i,[c,u]=[new se(e.programId),new se(e.id)],l=N([F("instruction"),A("amount")]),d=[P({pubkey:u}),P({pubkey:new se(t.authority),isWritable:!1}),P({pubkey:a[0]}),P({pubkey:r,isSigner:!0,isWritable:!1}),P({pubkey:n}),P({pubkey:new se(t.lpVault)}),P({pubkey:o[0]}),P({pubkey:new se(t.rewardInfos[0].vault)}),P({pubkey:Bo,isWritable:!1}),P({pubkey:xt,isWritable:!1}),P({pubkey:o[1]}),P({pubkey:new se(t.rewardInfos[1].vault)})],m=Buffer.alloc(l.span);return l.encode({instruction:2,amount:s},m),new $e({keys:d,programId:c,data:m})}function mi(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:r,amount:s,userAuxiliaryLedgers:a}=i,[c,u]=[new se(e.programId),new se(e.id)],l=yt({programId:c,poolId:u,owner:r,version:3}),d=Buffer.alloc(wt.span);wt.encode({instruction:11,amount:Y(s)},d);let m=[P({pubkey:u}),P({pubkey:new se(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:r,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new se(t.lpVault)}),P({pubkey:o[0]}),P({pubkey:new se(t.rewardInfos[0].vault)}),P({pubkey:Bo,isWritable:!1}),P({pubkey:xt,isWritable:!1})];if(a)for(let p of a)m.push(P({pubkey:p}));return new $e({programId:c,keys:m,data:d})}function _c(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:r,amount:s,userAuxiliaryLedgers:a}=i,[c,u]=[new se(e.programId),new se(e.id)],l=yt({programId:c,poolId:u,owner:r,version:3}),d=Buffer.alloc(wt.span);wt.encode({instruction:10,amount:Y(s)},d);let m=[P({pubkey:u}),P({pubkey:new se(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:r,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new se(t.lpVault)}),P({pubkey:o[0]}),P({pubkey:new se(t.rewardInfos[0].vault)}),P({pubkey:Bo,isWritable:!1}),P({pubkey:xt,isWritable:!1})];if(a)for(let p of a)m.push(P({pubkey:p}));return new $e({programId:c,keys:m,data:d})}function Fc(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:r,amount:s,userAuxiliaryLedgers:a}=i,[c,u]=[new se(e.programId),new se(e.id)],l=yt({programId:c,poolId:u,owner:r,version:5}),d=Buffer.alloc(wt.span);wt.encode({instruction:11,amount:Y(s)},d);let m=[P({pubkey:u}),P({pubkey:new se(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:r,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new se(t.lpVault)}),P({pubkey:o[0]}),P({pubkey:new se(t.rewardInfos[0].vault)}),P({pubkey:Bo,isWritable:!1}),P({pubkey:xt,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)m.push(P({pubkey:o[p]})),m.push(P({pubkey:new se(t.rewardInfos[p].vault)}));if(a)for(let p of a)m.push(P({pubkey:p}));return new $e({programId:c,keys:m,data:d})}function Vc(i){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:r,amount:s}=i,[a,c]=[new se(e.programId),new se(e.id)],u=yt({programId:a,poolId:c,owner:r,version:6}),l=Buffer.alloc(wt.span);wt.encode({instruction:1,amount:Y(s)},l);let d=[P({pubkey:xt,isWritable:!1}),P({pubkey:Yn.programId,isWritable:!1}),P({pubkey:c}),P({pubkey:new se(t.authority),isWritable:!1}),P({pubkey:new se(t.lpVault)}),P({pubkey:u}),P({pubkey:r,isWritable:!1,isSigner:!0}),P({pubkey:n})];for(let m=0;m<t.rewardInfos.length;m++)d.push(P({pubkey:new se(t.rewardInfos[m].vault)})),d.push(P({pubkey:o[m]}));return new $e({programId:a,keys:d,data:l})}var di=class extends Ne{async _getUserRewardInfo({payer:e,rewardInfo:t}){if(t.mint.equals(ot)){let n=await En({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:e,amount:ga({...t,openTime:t.openTime.toString(),endTime:t.endTime.toString()})});return{rewardPubKey:n.addresses.newAccount,newInstruction:n}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:t.mint,associatedOnly:!1})}}async create({poolInfo:e,rewardInfos:t,payer:n,programId:o=go,txVersion:r,feePayer:s}){this.checkDisabled(),this.scope.checkOwner();let c={lpMint:new Ie(e.lpMint.address),lockInfo:{lockMint:Kc,lockVault:Cc},version:6,rewardInfos:t,programId:o},u=this.createTxBuilder(s),l=n??this.scope.ownerPubKey,d=Ue({fromPublicKey:l,programId:c.programId}),m=await this.scope.connection.getMinimumBalanceForRentExemption(oi.span);u.addInstruction({instructions:[Mf.createAccountWithSeed({fromPubkey:l,basePubkey:l,seed:d.seed,newAccountPubkey:d.publicKey,lamports:m,space:oi.span,programId:c.programId})]});let{publicKey:p,nonce:y}=Nc({programId:new Ie(c.programId),poolId:d.publicKey}),f=si({programId:c.programId,poolId:d.publicKey,mint:c.lpMint,type:"lpVault"}),b=[],g=[];for(let T of c.rewardInfos){T.openTime>=T.endTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",T.openTime.toString()),isNaN(Fn[T.rewardType])&&this.logAndCreateError("rewardType error",T.rewardType),Number(T.perSecond)<=0&&this.logAndCreateError("rewardPerSecond error",T.perSecond),b.push(Oc(T));let{rewardPubKey:B,newInstruction:S}=await this._getUserRewardInfo({rewardInfo:T,payer:l});S&&u.addInstruction(S),B||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let I=T.mint.equals(ot)?new Ie(nt.address):T.mint;g.push({rewardMint:I,rewardVault:si({programId:c.programId,poolId:d.publicKey,mint:I,type:"rewardVault"}),userRewardToken:B})}let{account:w,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({mint:new Ie(c.lockInfo.lockMint),owner:this.scope.ownerPubKey,skipCloseAccount:!1,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:!1});k&&u.addInstruction(k),w||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let{instruction:h,instructionType:x}=vc({farmId:d.publicKey,owner:this.scope.ownerPubKey,farmAuthority:p,lpVault:f,lpMint:c.lpMint,lockVault:c.lockInfo.lockVault,lockMint:c.lockInfo.lockMint,lockUserAccount:w,programId:c.programId,rewardInfo:g,rewardInfoConfig:b,nonce:y});return u.addInstruction({instructions:[h],instructionTypes:[x]}).versionBuild({txVersion:r,extInfo:{farmId:d.publicKey,farmAuthority:p,lpVault:f,lockUserAccount:w,nonce:y}})}async restartReward({farmInfo:e,payer:t,newRewardInfo:n,txVersion:o,feePayer:r}){let s=Et[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Re((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.openTime>=n.endTime&&this.logAndCreateError("start time error","newRewardInfo",n);let u=t||this.scope.ownerPubKey,l=n.mint.equals(ot)?new Ie(nt.address):n.mint,d=c.rewardInfos.findIndex(g=>new Ie(g.mint.address).equals(l)),m=a.rewardInfos[d];m||this.logAndCreateError("configuration does not exist","rewardMint",l);let p=m.vault??ot,y=this.createTxBuilder(r),{rewardPubKey:f,newInstruction:b}=await this._getUserRewardInfo({rewardInfo:n,payer:u});return b&&y.addInstruction(b),f||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts),y.addInstruction({instructions:[Aa({payer:this.scope.ownerPubKey,rewardVault:p,userRewardTokenPub:f,farmKeys:c,rewardInfo:n})],instructionTypes:[V.FarmV6Restart]}).versionBuild({txVersion:o})}async restartRewards({farmInfo:e,payer:t,newRewardInfos:n,txVersion:o,feePayer:r}){let s=Et[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Re((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.forEach(d=>{d.openTime>=d.endTime&&this.logAndCreateError("start time error","newRewardInfo",d)});let u=t||this.scope.ownerPubKey,l=this.createTxBuilder(r);for(let d of n){let m=d.mint.equals(ot)?new Ie(nt.address):d.mint,p=c.rewardInfos.findIndex(k=>new Ie(k.mint.address).equals(m)),y=a.rewardInfos[p];y||this.logAndCreateError("configuration does not exist","rewardMint",m);let f=y.vault??ot,{rewardPubKey:b,newInstruction:g}=await this._getUserRewardInfo({rewardInfo:d,payer:u});g&&l.addInstruction(g),b||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let w=Aa({payer:this.scope.ownerPubKey,rewardVault:f,userRewardTokenPub:b,farmKeys:c,rewardInfo:d});l.addInstruction({instructions:[w],instructionTypes:[V.FarmV6Restart]})}return l.versionBuild({txVersion:o})}async addNewRewardToken(e){let{txVersion:t,farmInfo:n,newRewardInfo:o,payer:r,feePayer:s}=e,a=Et[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=Re((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=r??this.scope.ownerPubKey,l=this.createTxBuilder(s),d=o.mint.equals(ot)?new Ie(nt.address):o.mint,m=si({programId:new Ie(n.programId),poolId:new Ie(n.id),mint:d,type:"rewardVault"}),{rewardPubKey:p,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:o,payer:u});return y&&l.addInstruction(y),p||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts),o.mint=d,l.addInstruction({instructions:[wa({payer:this.scope.ownerPubKey,userRewardTokenPub:p,farmKeys:c,rewardVault:m,rewardInfo:o})],instructionTypes:[V.FarmV6CreatorAddReward]}).versionBuild({txVersion:t})}async addNewRewardsToken(e){let{txVersion:t,farmInfo:n,newRewardInfos:o,payer:r,feePayer:s}=e,a=Et[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=Re((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=r??this.scope.ownerPubKey,l=this.createTxBuilder(s);for(let d of o){let m=d.mint.equals(ot)?new Ie(nt.address):d.mint,p=si({programId:new Ie(n.programId),poolId:new Ie(n.id),mint:m,type:"rewardVault"}),{rewardPubKey:y,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:d,payer:u});f&&l.addInstruction(f),y||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let b=wa({payer:this.scope.ownerPubKey,userRewardTokenPub:y,farmKeys:c,rewardVault:p,rewardInfo:{...d,mint:m}});l.addInstruction({instructions:[b],instructionTypes:[V.FarmV6CreatorAddReward]})}return l.versionBuild({txVersion:t})}async deposit(e){let{txVersion:t,farmInfo:n,amount:o,feePayer:r,useSOLBalance:s,associatedOnly:a=!0,checkCreateATAOwner:c=!1,userAuxiliaryLedgers:u,computeBudgetConfig:l,txTipConfig:d}=e;this.scope.availability.addFarm===!1&&this.logAndCreateError("farm deposit feature disabled in your region");let{rewardInfos:m,programId:p}=n,y=Et[p];y===4&&this.logAndCreateError("V4 has suspended deposits:",n.programId),ca(y)||this.logAndCreateError("invalid farm program:",n.programId);let[f,b]=[new Ie(n.programId),new Ie(n.id)],g=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],w=yt({programId:f,poolId:b,owner:this.scope.ownerPubKey,version:y}),k=this.createTxBuilder(r);k.addCustomComputeBudget(l),k.addTipInstruction(d);let h={};for(let D of this.scope.account.tokenAccounts)if(a){let q=$(this.scope.ownerPubKey,D.mint,D.programId).publicKey;D.publicKey&&q.equals(D.publicKey)&&(h[D.mint.toString()]=D.publicKey)}else h[D.mint.toString()]=D.publicKey;let x=g.lpMint,T=h[x.address];T||this.logAndCreateError("you don't have any lp","lp zero",h);let B=[];for(let D of m){let q=s&&D.mint.address===j.toString(),G=h[D.mint.address];if(!G){let{account:Z,instructionParams:ie}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:D.mint.programId,mint:new Ie(D.mint.address),notUseTokenAccount:q,createInfo:{payer:r||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!q,associatedOnly:q?!1:a,checkCreateATAOwner:c});G=Z,ie&&k.addInstruction(ie)}h[D.mint.address]=G,B.push(G)}let S,I=await this.scope.connection.getAccountInfo(w);if(I&&(S=Io(y).decode(I.data)),n.programId!==go.toString()&&!S){let{instruction:D,instructionType:q}=ui({id:b,programId:f,version:y,ledger:w,owner:this.scope.ownerPubKey});k.addInstruction({instructions:[D],instructionTypes:[q]})}let K=la({version:y,rewardInfos:m,rewardTokenAccountsPublicKeys:B});K&&this.logAndCreateError(K);let O={amount:Y(o),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:g,lpAccount:T,rewardAccounts:B,userAuxiliaryLedgers:u?.map(D=>new Ie(D))},v=y===6?Vc(O):y===5?Fc(O):_c(O),_={3:V.FarmV3Deposit,5:V.FarmV5Deposit,6:V.FarmV6Deposit};return k.addInstruction({instructions:[v],instructionTypes:[_[y]]}).versionBuild({txVersion:t})}async withdraw(e){let{txVersion:t,farmInfo:n,amount:o,deposited:r,useSOLBalance:s,feePayer:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,userAuxiliaryLedgers:l,computeBudgetConfig:d,txTipConfig:m}=e,{rewardInfos:p}=n;this.scope.availability.removeFarm===!1&&this.logAndCreateError("farm withdraw feature disabled in your region");let y=Et[n.programId];ca(y)||this.logAndCreateError("invalid farm program:",n.programId);let f=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],b=this.createTxBuilder(a);b.addCustomComputeBudget(d),b.addTipInstruction(m);let g={};for(let K of this.scope.account.tokenAccounts)if(c){let O=$(this.scope.ownerPubKey,K.mint).publicKey;K.publicKey&&O.equals(K.publicKey)&&(g[K.mint.toString()]=K.publicKey)}else g[K.mint.toString()]=K.publicKey;if(y!==4){let K=yt({programId:new Ie(n.programId),poolId:new Ie(n.id),owner:this.scope.ownerPubKey,version:y}),O=await this.scope.connection.getAccountInfo(K);if(O)Io(y).decode(O.data).deposited.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else if(y!==6){let{instruction:v,instructionType:_}=ui({id:new Ie(f.id),programId:new Ie(f.programId),version:y,ledger:K,owner:this.scope.ownerPubKey});b.addInstruction({instructions:[v],instructionTypes:[_]})}}r&&r.isZero()&&!(l||[]).length&&this.logAndCreateError("no deposited lp",{farmId:n.id});let w=f.lpMint.address,k=s&&w===j.toString(),h=g[w.toString()];if(!h){let{account:K,instructionParams:O}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:f.lpMint.programId,mint:new Ie(w),notUseTokenAccount:k,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:k?!1:c,checkCreateATAOwner:u});h=K,O&&b.addInstruction(O)}g[w.toString()]=h;let x=[];for(let K of p){let O=s&&K.mint.address===j.toString(),v=g[K.mint.address];if(!v){let{account:_,instructionParams:D}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:K.mint.programId,mint:new Ie(K.mint.address),notUseTokenAccount:O,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!O,associatedOnly:O?!1:c,checkCreateATAOwner:u});v=_,D&&b.addInstruction(D)}g[K.mint.address]=v,x.push(v)}let T=la({version:y,rewardInfos:p,rewardTokenAccountsPublicKeys:x});T&&this.logAndCreateError(T);let B={amount:Y(o),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:f,lpAccount:h,rewardAccounts:x,userAuxiliaryLedgers:l?.map(K=>new Ie(K))},S=y===6?ci(B):y===5?li(B):y===4?Ec(B):mi(B),I={3:V.FarmV3Withdraw,4:V.FarmV4Withdraw,5:V.FarmV5Withdraw,6:V.FarmV6Withdraw};return b.addInstruction({instructions:[S],instructionTypes:[I[y]]}).versionBuild({txVersion:t})}async withdrawFarmReward({farmInfo:e,withdrawMint:t,txVersion:n,computeBudgetConfig:o,txTipConfig:r,feePayer:s}){this.scope.checkOwner();let a=Re((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c=Et[e.programId];c!==6&&this.logAndCreateError("invalid farm version",c);let u=a.rewardInfos.find(f=>pt(f.mint.address).equals(pt(t)));u||this.logAndCreateError("withdraw mint error","rewardInfos",e);let l=u?.vault??ot,d=this.createTxBuilder(s),m;if(t.equals(ot)||t.equals(Ie.default)){let f=await En({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:ga({...u,openTime:u.openTime,endTime:u.endTime,perSecond:new C(u.perSecond).mul(10**u.mint.decimals).toString()})});m=f.addresses.newAccount,d.addInstruction(f)}else{let f=await this.scope.account.getCreatedTokenAccount({mint:t});f===null?(m=await this.scope.account.getAssociatedTokenAccount(t),d.addInstruction({instructions:[Ef(this.scope.ownerPubKey,m,this.scope.ownerPubKey,t)],instructionTypes:[V.CreateATA]})):m=f}let{instruction:p,instructionType:y}=Mc({programId:a.programId,id:a.id,authority:a.authority,lpVault:a.lpVault,rewardVault:l,userRewardToken:m,owner:this.scope.ownerPubKey});return d.addCustomComputeBudget(o),d.addTipInstruction(r),d.addInstruction({instructions:[p],instructionTypes:[y]}).versionBuild({txVersion:n})}async harvestAllRewards(e){let{farmInfoList:t,useSOLBalance:n,feePayer:o,associatedOnly:r=!0,checkCreateATAOwner:s=!1,userAuxiliaryLedgers:a,txVersion:c,computeBudgetConfig:u}=e,l=this.createTxBuilder(o),d={};for(let y of this.scope.account.tokenAccounts)if(r){let f=$(this.scope.ownerPubKey,y.mint).publicKey;y.publicKey&&f.equals(y.publicKey)&&(d[y.mint.toString()]=y.publicKey)}else d[y.mint.toString()]=y.publicKey;let p=(await this.scope.api.fetchFarmKeysById({ids:Object.values(t).map(y=>y.id).join(",")})).reduce((y,f)=>({...y,[f.id]:f}),{});for(let y of Object.values(t)){let{programId:f,lpMint:b,rewardInfos:g,id:w}=y,k=Et[f],h=b.address,x=n&&h===j.toString(),T=d[h];if(!T){let{account:v,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:b.programId,mint:new Ie(h),notUseTokenAccount:x,createInfo:{payer:o||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:x?!1:r,checkCreateATAOwner:s});T=v,_&&l.addInstruction(_)}d[h.toString()]=T;let B=[];for(let v of g){let _=n&&v.mint.address===j.toString(),D=d[v.mint.address];if(!D){let{account:q,instructionParams:G}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:v.mint.programId,mint:new Ie(v.mint.address),notUseTokenAccount:_,createInfo:{payer:o||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!_,associatedOnly:_?!1:r,checkCreateATAOwner:s});D=q,G&&l.addInstruction(G)}d[v.mint.address]=D,B.push(D)}let S=p[w],I={amount:ze,owner:this.scope.ownerPubKey,farmInfo:y,farmKeys:S,lpAccount:T,rewardAccounts:B,userAuxiliaryLedgers:a?.map(v=>new Ie(v))},K=k===6?ci(I):k===5?li(I):mi(I),O={3:V.FarmV3Withdraw,5:V.FarmV5Withdraw,6:V.FarmV6Withdraw};l.addInstruction({instructions:[K],instructionTypes:[O[k]]})}return c===1?l.sizeCheckBuild({computeBudgetConfig:u}):l.sizeCheckBuildV0({computeBudgetConfig:u})}};import{PublicKey as He}from"@solana/web3.js";import{AccountLayout as Ky,NATIVE_MINT as qr,TOKEN_PROGRAM_ID as Wn}from"@solana/spl-token";import{Keypair as Mr,PublicKey as U,SystemProgram as Tn,TransactionInstruction as ct}from"@solana/web3.js";import Ca from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as hi,TOKEN_2022_PROGRAM_ID as Ve,TOKEN_PROGRAM_ID as Be}from"@solana/spl-token";import jf from"bn.js";import _t from"bn.js";var fe=new _t(0),Nt=new _t(1),wn=new _t(-1),Ye=new _t(1).shln(64),Cr=new _t(1).shln(128),pi=Ye.sub(Nt),fi=64,Wc=Cr.subn(1),bt=-443636,kt=-bt,Ft=new _t("4295048016"),Vt=new _t("79226673521066979257578248091"),Lr=new _t("4295048017"),Rr=new _t("79226673521066979257578248090"),Dc=16,qc="59543866431248",Uc="184467440737095516",Gc="15793534762490258745",Nr=new _t(10).pow(new _t(6)),_f=(n=>(n[n.rate_500=500]="rate_500",n[n.rate_3000=3e3]="rate_3000",n[n.rate_10000=1e4]="rate_10000",n))(_f||{}),CT={[500]:10,[3e3]:60,[1e4]:200},LT={version:6,liquidity:fe,tickCurrent:0,feeGrowthGlobalX64A:fe,feeGrowthGlobalX64B:fe,protocolFeesTokenA:fe,protocolFeesTokenB:fe,swapInAmountTokenA:fe,swapOutAmountTokenB:fe,swapInAmountTokenB:fe,swapOutAmountTokenA:fe,tickArrayBitmap:[],rewardInfos:[],day:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},week:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},month:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},tvl:0},Xc={tvl:0,volumeQuote:0,mintAmountA:0,mintAmountB:0,rewardDefaultInfos:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,day:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},week:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},month:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},pooltype:[]},RT=new _t("18446744073700000000");import me from"bn.js";function Or(i){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,i,!1),new Uint8Array(e)}function OT(i){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,i,!1),new Uint8Array(e)}function vT(i){let e=new ArrayBuffer(4);return new DataView(e).setUint32(0,i,!1),new Uint8Array(e)}function vr(i){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,i,!1),new Uint8Array(e)}function ka(i,e){let t=0;for(let n=i-1;n>=0&&!e.testn(n);n--)t++;return t}function ha(i,e){let t=0;for(let n=0;n<i&&!e.testn(n);n++)t++;return t}function yi(i,e){for(let t=0;t<i;t++)if(e.testn(t))return!1;return!0}function Qc(i,e){return yi(i,e)?null:ka(i,e)}function zc(i,e){return yi(i,e)?null:ha(i,e)}var Ff=Buffer.from("amm_config","utf8"),Vf=Buffer.from("pool","utf8"),Wf=Buffer.from("pool_vault","utf8"),Df=Buffer.from("pool_reward_vault","utf8"),Hc=Buffer.from("position","utf8"),qf=Buffer.from("tick_array","utf8"),Uf=Buffer.from("operation","utf8"),Gf=Buffer.from("pool_tick_array_bitmap_extension","utf8"),Xf=Buffer.from("observation","utf8");function FT(i,e){return te([Ff,Or(e)],i)}function jc(i,e,t,n){return te([Vf,e.toBuffer(),t.toBuffer(),n.toBuffer()],i)}function Ta(i,e,t){return te([Wf,e.toBuffer(),t.toBuffer()],i)}function Yc(i,e,t){return te([Df,e.toBuffer(),t.toBuffer()],i)}function ye(i,e,t){return te([qf,e.toBuffer(),vr(t)],i)}function en(i,e,t,n){return te([Hc,e.toBuffer(),vr(t),vr(n)],i)}function ht(i,e){return te([Hc,e.toBuffer()],i)}function kn(i){return te([Buffer.from("metadata","utf8"),Gt.toBuffer(),i.toBuffer()],Gt)}function bi(i){return te([Uf],i)}function Ge(i,e){return te([Gf,e.toBuffer()],i)}function Zc(i,e){return te([Xf,e.toBuffer()],i)}var $c=Buffer.from("locked_position","utf8");function Ia(i,e){return te([$c,e.toBuffer()],i)}function gi(i,e){return te([$c,e.toBuffer()],i)}var Qf=Buffer.from("support_mint","utf8");function Ba(i,e){return te([Qf,e.toBuffer()],i)}import{PublicKey as Ot}from"@solana/web3.js";import{TOKEN_2022_PROGRAM_ID as Jc}from"@solana/spl-token";import ve from"bn.js";import un from"bn.js";var Pi=class{static getfeeGrowthInside(e,t,n){let o=new un(0),r=new un(0);e.tickCurrent>=t.tick?(o=t.feeGrowthOutsideX64A,r=t.feeGrowthOutsideX64B):(o=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),r=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new un(0),a=new un(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let c=ae.wrappingSubU128(ae.wrappingSubU128(e.feeGrowthGlobalX64A,o),s),u=ae.wrappingSubU128(ae.wrappingSubU128(e.feeGrowthGlobalX64B,r),a);return{feeGrowthInsideX64A:c,feeGrowthInsideBX64:u}}static GetPositionFees(e,t,n,o){let{feeGrowthInsideX64A:r,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,o),a=ae.mulDivFloor(ae.wrappingSubU128(r,t.feeGrowthInsideLastX64A),t.liquidity,Ye),c=t.tokenFeesOwedA.add(a),u=ae.mulDivFloor(ae.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,Ye),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,o){let{feeGrowthInsideX64A:r,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,o),a=ae.mulDivFloor(ae.wrappingSubU128(r,t.feeGrowthInsideLastX64A),t.liquidity,Ye),c=t.tokenFeesOwedA.add(a),u=ae.mulDivFloor(ae.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,Ye),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,o){let r=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,o,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=ae.wrappingSubU128(c,u.growthInsideLastX64),d=ae.mulDivFloor(l,t.liquidity,Ye),m=u.rewardAmountOwed.add(d);r.push(m)}return r}static GetPositionRewards(e,t,n,o){let r=[],s=this.getRewardGrowthInside(e.tickCurrent,n,o,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=ae.wrappingSubU128(c,u.growthInsideLastX64),d=ae.mulDivFloor(l,t.liquidity,Ye),m=u.rewardAmountOwed.add(d);r.push(m)}return r}static getRewardGrowthInside(e,t,n,o){let r=[];for(let s=0;s<o.length;s++){let a=new un(0);t.liquidityGross.eqn(0)?a=o[s].rewardGrowthGlobalX64:e<t.tick?a=o[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new un(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=o[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),r.push(ae.wrappingSubU128(ae.wrappingSubU128(o[s].rewardGrowthGlobalX64,a),c))}return r}static getRewardGrowthInsideV2(e,t,n,o){let r=[];for(let s=0;s<o.length;s++){let a=new un(0);t.liquidityGross.eqn(0)?a=o[s].rewardGrowthGlobalX64:e<t.tick?a=o[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new un(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=o[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),r.push(ae.wrappingSubU128(ae.wrappingSubU128(o[s].rewardGrowthGlobalX64,a),c))}return r}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:o,add:r,epochInfo:s}){let a=ne.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),c=ne.getSqrtPriceX64FromTick(t.tickLower),u=ne.getSqrtPriceX64FromTick(t.tickUpper),l=r?1+o:1-o,d=be.getAmountsFromLiquidity(a,c,u,n,r),[m,p]=[we(d.amountA,e.mintA.extensions?.feeConfig,s,!0),we(d.amountB,e.mintB.extensions?.feeConfig,s,!0)],[y,f]=[we(new un(new C(d.amountA.toString()).mul(l).toFixed(0)),e.mintA.extensions?.feeConfig,s,!0),we(new un(new C(d.amountB.toString()).mul(l).toFixed(0)),e.mintB.extensions?.feeConfig,s,!0)];return{liquidity:n,amountA:m,amountB:p,amountSlippageA:y,amountSlippageB:f,expirationTime:Ht(m.expirationTime,p.expirationTime)}}};var zf=15,ge=class{static async getTickArrays(e,t,n,o,r,s,a){let c=[],u=H.getTickArrayStartIndexByTick(o,r),l=H.getInitializedTickArrayInRange(s,a,r,u,Math.floor(zf/2));for(let p=0;p<l.length;p++){let{publicKey:y}=ye(t,n,l[p]);c.push(y)}let d=(await Dt(e,c)).map(p=>p!==null?Ai.decode(p.data):null),m={};for(let p=0;p<c.length;p++){let y=d[p];y!==null&&(m[y.startTickIndex]={...y,address:c[p]})}return m}static nextInitializedTick(e,t,n,o,r,s){let{initializedTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}=this.nextInitializedTickInOneArray(e,t,n,o,r,s);for(;a==null||a.liquidityGross.lten(0);){if(u=H.getNextTickArrayStartIndex(u,r,s),this.checkIsValidStartIndex(u,r))throw new Error("No enough initialized tickArray");let l=n[u];if(l===void 0)continue;let{nextTick:d,tickArrayAddress:m,tickArrayStartTickIndex:p}=this.firstInitializedTickInOneArray(e,t,l,s);[a,c,u]=[d,m,p]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}}static nextInitializedTickArray(e,t,n,o,r){let s=Math.floor(e/ge.tickCount(t)),a=n?H.searchLowBitFromStart(o,r,s-1,1,t):H.searchHightBitFromStart(o,r,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,o){let r;if(o){let a=Je-1;for(;a>=0;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){r=c;break}a=a-1}}else{let a=0;for(;a<Je;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){r=c;break}a=a+1}}let{publicKey:s}=ye(e,t,n.startTickIndex);return{nextTick:r,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,o,r,s){let a=H.getTickArrayStartIndexByTick(o,r),c=Math.floor((o-a)/r),u=n[a];if(u==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;c>=0;){let m=u.ticks[c];if(m.liquidityGross.gtn(0)){l=m;break}c=c-1}else for(c=c+1;c<Je;){let m=u.ticks[c];if(m.liquidityGross.gtn(0)){l=m;break}c=c+1}let{publicKey:d}=ye(e,t,a);return{initializedTick:l,tickArrayAddress:d,tickArrayStartTickIndex:u.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(H.checkIsOutOfBoundary(e)){if(e>kt)return!1;let n=H.getTickArrayStartIndexByTick(bt,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return Je*e}};var xa=14,hn=class{static maxTickInTickarrayBitmap(e){return e*Je*Zn}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),o=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(o+=1);let r=n*o;return e<0?{minValue:-r,maxValue:-r+n}:{minValue:r,maxValue:r+n}}static nextInitializedTickArrayStartIndex(e,t,n,o){if(!ge.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let r=this.maxTickInTickarrayBitmap(n),s=o?t-ge.tickCount(n):t+ge.tickCount(n);if(s<-r||s>=r)return{isInit:!1,tickIndex:t};let a=n*Je,c=s/a+512;s<0&&s%a!=0&&c--;let u=Math.abs(c);if(o){let l=e.shln(1024-u-1),d=Qc(1024,l);if(d!==null){let m=(u-d-512)*a;return{isInit:!0,tickIndex:m}}else return{isInit:!1,tickIndex:-r}}else{let l=e.shrn(u),d=zc(1024,l);if(d!==null){let m=(u+d-512)*a;return{isInit:!0,tickIndex:m}}else return{isInit:!1,tickIndex:r-ge.tickCount(n)}}}},wi=class{static getBitmapOffset(e,t){if(!ge.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=hn.maxTickInTickarrayBitmap(t),o=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&o--,o}static getBitmap(e,t,n){let o=this.getBitmapOffset(e,t);return e<0?{offset:o,tickarrayBitmap:n.negativeTickArrayBitmap[o]}:{offset:o,tickarrayBitmap:n.positiveTickArrayBitmap[o]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:o}=this.extensionTickBoundary(t);if(e>=o&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=hn.maxTickInTickarrayBitmap(e),n=-t;if(kt<=t)throw Error(`extensionTickBoundary check error: ${kt}, ${t}`);if(n<=bt)throw Error(`extensionTickBoundary check error: ${n}, ${bt}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:o}=this.getBitmap(e,t,n),r=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:H.mergeTickArrayBitmap(o).testn(r),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,o){let r=ge.tickCount(t),s=n?e-r:e+r,{tickarrayBitmap:a}=this.getBitmap(s,t,o);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,o){let{minValue:r,maxValue:s}=hn.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(o){let c=H.mergeTickArrayBitmap(e).shln(Zn-1-a),u=yi(512,c)?null:ka(512,c);if(u!==null){let l=t-u*ge.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:r}}else{let c=H.mergeTickArrayBitmap(e).shrn(a),u=yi(512,c)?null:ha(512,c);if(u!==null){let l=t+u*ge.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-ge.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%hn.maxTickInTickarrayBitmap(t),o=Math.floor(n/ge.tickCount(t));return e<0&&n!=0&&(o=Zn-o),o}};var Le=class{static getOutputAmountAndRemainAccounts(e,t,n,o,r,s=!1){let a=n.toBase58()===e.mintA.address,c=[],{isExist:u,startIndex:l,nextAccountMeta:d}=this.getFirstInitializedTickArray(e,a);if(!u||l===void 0||!d)throw new Error("Invalid tick array");c.push(d);let{allTrade:m,amountCalculated:p,accounts:y,sqrtPriceX64:f,feeAmount:b}=$n.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,a,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,o,l,r,s);return c.push(...y),{allTrade:m,expectedAmountOut:p.mul(wn),remainingAccounts:c,executionPrice:f,feeAmount:b}}static getInputAmountAndRemainAccounts(e,t,n,o,r){let s=n.toBase58()===e.mintB.address,a=[],{isExist:c,startIndex:u,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!c||u===void 0||!l)throw new Error("Invalid tick array");try{let f=this.preInitializedTickArrayStartIndex(e,s);if(f.isExist){let{publicKey:b}=ye(e.programId,e.id,f.nextStartIndex);a.push(b)}}catch{}a.push(l);let{amountCalculated:d,accounts:m,sqrtPriceX64:p,feeAmount:y}=$n.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,o.mul(wn),u,r);return a.push(...m),{expectedAmountIn:d,remainingAccounts:a,executionPrice:p,feeAmount:y}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:o}=Le.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?wi.checkTickArrayIsInit(ge.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):H.checkTickArrayIsInitialized(H.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=ye(e.programId,e.id,o);return{isExist:!0,startIndex:o,nextAccountMeta:a}}let{isExist:r,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,ge.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(r){let{publicKey:a}=ye(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/ge.tickCount(e.tickSpacing)),o=t?H.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):H.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return o.length>0?{isExist:!0,nextStartIndex:o[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=ge.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:o,tickIndex:r}=hn.nextInitializedTickArrayStartIndex(H.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(o)return{isExist:!0,nextStartIndex:r};t=r;let{isInit:s,tickIndex:a}=wi.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<bt||t>kt)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:o,rewardInfos:r}){let s=[];for(let a=0;a<r.length;a++){let c=r[a],u=t.rewardDefaultInfos[a]?.mint.programId??(await e.getAccountInfo(c.tokenMint))?.owner;if(u===void 0)throw Error("get new reward mint info error");let l={...c,perSecond:ae.x64ToDecimal(c.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new Ot(u)};if(l.tokenMint.equals(Ot.default))continue;if(n<=l.openTime.toNumber()||o.eq(fe)){s.push(l);continue}let d=new ve(Math.min(l.endTime.toNumber(),n)),m=d.sub(l.lastUpdateTime),p=ae.mulDivFloor(m,l.emissionsPerSecondX64,o),y=l.rewardGrowthGlobalX64.add(p),f=ae.mulDivFloor(m,l.emissionsPerSecondX64,Ye),b=l.rewardTotalEmissioned.add(f);s.push({...l,rewardGrowthGlobalX64:y,rewardTotalEmissioned:b,lastUpdateTime:d})}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:o}=this.tickRange(e);for(let r of t){let s=H.getTickArrayStartIndexByTick(r,e);if(s>=n||s<o)return!0}return!1}static tickRange(e){let t=hn.maxTickInTickarrayBitmap(e),n=-t;return t>kt&&(t=ge.getArrayStartIndex(kt,e)+ge.tickCount(e)),n<bt&&(n=ge.getArrayStartIndex(bt,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!ge.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/ge.tickCount(t)*Zn}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let o=await Ke(e,t.map(s=>({pubkey:s})),{batchRequest:n}),r={};for(let s of o)s.accountInfo!==null&&(r[s.pubkey.toString()]=tl.decode(s.accountInfo.data));return r}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let o={},r=[];for(let c of t){let u=H.getTickArrayStartIndexByTick(c.tickCurrent,c.tickSpacing),l=H.getInitializedTickArrayInRange(c.tickArrayBitmap,c.exBitmapInfo,c.tickSpacing,u,7);for(let d of l){let{publicKey:m}=ye(c.programId,c.id,d);r.push({pubkey:m}),o[m.toString()]=c.id}}let s=await Ke(e,r,{batchRequest:n}),a={};for(let c of s){if(!c.accountInfo)continue;let u=o[c.pubkey.toString()];if(!u)continue;a[u.toString()]===void 0&&(a[u.toString()]={});let l=Ai.decode(c.accountInfo.data);a[u.toString()][l.startTickIndex]={...l,address:c.pubkey}}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:o=!1,updateOwnerRewardAndFee:r=!0}){let s=[];for(let a=0;a<e.length;a++){let c=e[a];c!==null&&(s.find(u=>u.equals(c.state.programId))||s.push(c.state.programId))}if(n){let a=n.tokenAccounts.map(d=>d.accountInfo.mint),c=[];for(let d of a)for(let m of s)c.push(ht(m,d).publicKey);let u=await Dt(t,c,{batchRequest:o}),l={};for(let d of u){if(d===null)continue;let m=ki.decode(d.data),p=m.poolId.toString(),y=e.find(B=>B.state.id.toBase58()===p);if(y===void 0)continue;let f=y.state,b=H._getTickPriceLegacy({poolInfo:f,tick:m.tickLower,baseIn:!0}),g=H._getTickPriceLegacy({poolInfo:f,tick:m.tickUpper,baseIn:!0}),{amountA:w,amountB:k}=be.getAmountsFromLiquidity(f.sqrtPriceX64,b.tickSqrtPriceX64,g.tickSqrtPriceX64,m.liquidity,!1),h=1/(1-Math.sqrt(Math.sqrt(b.price.div(g.price).toNumber())));y.positionAccount=[...y.positionAccount??[],{poolId:m.poolId,nftMint:m.nftMint,priceLower:b.price,priceUpper:g.price,amountA:w,amountB:k,tickLower:m.tickLower,tickUpper:m.tickUpper,liquidity:m.liquidity,feeGrowthInsideLastX64A:m.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:m.feeGrowthInsideLastX64B,tokenFeesOwedA:m.tokenFeesOwedA,tokenFeesOwedB:m.tokenFeesOwedB,rewardInfos:m.rewardInfos.map(B=>({...B,pendingReward:new ve(0)})),leverage:h,tokenFeeAmountA:new ve(0),tokenFeeAmountB:new ve(0)}];let x=await H.getTickArrayAddressByTick(y.state.programId,m.poolId,m.tickLower,y.state.tickSpacing),T=await H.getTickArrayAddressByTick(y.state.programId,m.poolId,m.tickUpper,y.state.tickSpacing);l[`${y.state.programId.toString()}-${m.poolId.toString()}-${m.tickLower}`]=x,l[`${y.state.programId.toString()}-${m.poolId.toString()}-${m.tickUpper}`]=T}if(r){let d=Object.values(l),m=await Dt(t,d,{batchRequest:o}),p={};for(let y=0;y<d.length;y++){let f=m[y];if(f===null)continue;let b=d[y].toString();p[b]=Ai.decode(f.data)}for(let{state:y,positionAccount:f}of e)if(!!f)for(let b of f){let g=`${y.programId.toString()}-${y.id.toString()}-${b.tickLower}`,w=`${y.programId.toString()}-${y.id.toString()}-${b.tickUpper}`,k=p[l[g].toString()],h=p[l[w].toString()],x=k.ticks[H.getTickOffsetInArray(b.tickLower,y.tickSpacing)],T=h.ticks[H.getTickOffsetInArray(b.tickUpper,y.tickSpacing)],{tokenFeeAmountA:B,tokenFeeAmountB:S}=await Pi.GetPositionFees(y,b,x,T),I=await Pi.GetPositionRewards(y,b,x,T);b.tokenFeeAmountA=B.gte(new ve(0))?B:new ve(0),b.tokenFeeAmountB=S.gte(new ve(0))?S:new ve(0);for(let K=0;K<I.length;K++)b.rewardInfos[K].pendingReward=I[K].gte(new ve(0))?I[K]:new ve(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:o,amountIn:r,slippage:s,priceLimit:a=new C(0),catchLiquidityInsufficient:c=!1}){let u,l=n.toBase58()===e.mintA.address,[d,m]=l?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];a.equals(new C(0))?u=l?Ft.add(new ve(1)):Vt.sub(new ve(1)):u=ne.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let p=we(r,d,o,!1),{allTrade:y,expectedAmountOut:f,remainingAccounts:b,executionPrice:g,feeAmount:w}=Le.getOutputAmountAndRemainAccounts(e,t,n,p.amount.sub(p.fee??fe),u,c),k=we(f,m,o,!1),h=ne.sqrtPriceX64ToPrice(g,e.mintA.decimals,e.mintB.decimals),x=l?h:new C(1).div(h),T=f.mul(new ve(Math.floor((1-s)*1e10))).div(new ve(1e10)),B=we(T,m,o,!1),S=l?e.currentPrice:new C(1).div(e.currentPrice),I=new C(x).sub(S).abs(),K=S,O=new De(new C(I).mul(10**15).toFixed(0),new C(K).mul(10**15).toFixed(0));return{allTrade:y,realAmountIn:p,amountOut:k,minAmountOut:B,expirationTime:Ht(p.expirationTime,k.expirationTime),currentPrice:e.currentPrice,executionPrice:x,priceImpact:O,fee:w,remainingAccounts:b,executionPriceX64:g}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:o,slippage:r,epochInfo:s,catchLiquidityInsufficient:a=!1}){let c=o.address===e.mintB.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA],[d,m]=[new Te({...u,mint:u.address,isToken2022:u.programId===Jc.toBase58()}),new Te({...l,mint:l.address,isToken2022:l.programId===Jc.toBase58()})],{allTrade:p,realAmountIn:y,amountOut:f,minAmountOut:b,expirationTime:g,currentPrice:w,executionPrice:k,priceImpact:h,fee:x,remainingAccounts:T,executionPriceX64:B}=Le.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new Ot(u.address),amountIn:n,slippage:r,epochInfo:s,catchLiquidityInsufficient:a}),S={...y,amount:new Pe(d,y.amount),fee:y.fee===void 0?void 0:new Pe(d,y.fee)},I={...f,amount:new Pe(m,f.amount),fee:f.fee===void 0?void 0:new Pe(m,f.fee)},K={...b,amount:new Pe(m,b.amount),fee:b.fee===void 0?void 0:new Pe(m,b.fee)},O=new it({baseToken:d,denominator:new ve(10).pow(new ve(20+d.decimals)),quoteToken:m,numerator:w.mul(new C(10**(20+m.decimals))).toFixed(0)}),v=new it({baseToken:d,denominator:new ve(10).pow(new ve(20+d.decimals)),quoteToken:m,numerator:k.mul(new C(10**(20+m.decimals))).toFixed(0)}),_=new Pe(d,x);return{allTrade:p,realAmountIn:S,amountOut:I,minAmountOut:K,expirationTime:g,currentPrice:O,executionPrice:v,priceImpact:h,fee:_,remainingAccounts:T,executionPriceX64:B}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:o,amountOut:r,slippage:s,priceLimit:a=new C(0)}){let c=n.toBase58()===e.mintA.address,u={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},l;a.equals(new C(0))?l=c?Vt.sub(new ve(1)):Ft.add(new ve(1)):l=ne.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let d=we(r,u[n.toString()],o,!0),{expectedAmountIn:m,remainingAccounts:p,executionPrice:y,feeAmount:f}=Le.getInputAmountAndRemainAccounts(e,t,n,d.amount.sub(d.fee??fe),l),b=c?e.mintB.address:e.mintA.address,g=we(m,u[b],o,!1),w=ne.sqrtPriceX64ToPrice(y,e.mintA.decimals,e.mintB.decimals),k=c?w:new C(1).div(w),h=m.mul(new ve(Math.floor((1+s)*1e10))).div(new ve(1e10)),x=we(h,u[b],o,!0),T=c?e.currentPrice:new C(1).div(e.currentPrice),B=new C(k).sub(T).abs(),S=T,I=new De(new C(B).mul(10**15).toFixed(0),new C(S).mul(10**15).toFixed(0));return{amountIn:g,maxAmountIn:x,realAmountOut:d,expirationTime:Ht(g.expirationTime,d.expirationTime),currentPrice:e.currentPrice,executionPrice:k,priceImpact:I,fee:f,remainingAccounts:p}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:o}){let r=e[t],s=H.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=H.getTickPrice({poolInfo:e,tick:o,baseIn:!0}).price.toNumber(),c=Math.max(s,r.priceMin),l=Math.min(a,r.priceMax)-c,d=a-s,m=r.priceMax-r.priceMin,p;return l<=0?p=0:d===l?p=m/l:m===l?p=l/d:p=l/m*(l/d),{feeApr:r.feeApr*p,rewardsApr:[(r.rewardApr[0]??0)*p,(r.rewardApr[1]??0)*p,(r.rewardApr[2]??0)*p],apr:r.apr*p}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:o,liquidity:r,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:c}){let u=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],d=o[pt(e.mintA.address).toString()],m=o[pt(e.mintB.address).toString()],p=e.mintA.decimals,y=e.mintB.decimals;if(!l||!d||!m)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let f=ne.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),b=ne.getSqrtPriceX64FromTick(s),g=ne.getSqrtPriceX64FromTick(a),{amountSlippageA:w,amountSlippageB:k}=be.getAmountsFromLiquidityWithSlippage(f,b,g,t,!1,!1,0),{amountSlippageA:h,amountSlippageB:x}=be.getAmountsFromLiquidityWithSlippage(f,b,g,r,!1,!1,0),T=new C(w.toString()).div(new C(10).pow(p)).mul(d.value).add(new C(k.toString()).div(new C(10).pow(y)).mul(m.value)),B=new C(h.toString()).div(new C(10).pow(p)).mul(d.value).add(new C(x.toString()).div(new C(10).pow(y)).mul(m.value)),S=new C(1).div(T.add(B)),K=new C(l.volumeFee).mul(365).div(u).mul(S).mul(100).toNumber(),O=3600*24*365,v=e.rewardDefaultInfos.map(_=>{let D=_.mint.decimals,q=o[_.mint.address];return c<(_.startTime??0)||c>(_.endTime??0)||!_.perSecond||!q||D===void 0?0:new C(q.value).mul(new C(_.perSecond).mul(O)).div(new C(10).pow(D)).mul(S).mul(100).toNumber()});return{feeApr:K,rewardsApr:v,apr:K+v.reduce((_,D)=>_+D,0)}}static async getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:o,amount:r,slippage:s,add:a,epochInfo:c,amountHasFee:u}){let l=ne.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),d=ne.getSqrtPriceX64FromTick(n),m=ne.getSqrtPriceX64FromTick(o),p=we(r,e[t?"mintA":"mintB"].extensions?.feeConfig,c,!u),y=new ve(new C(p.amount.sub(p.fee??fe).toString()).toFixed(0)),f;if(l.lte(d))f=t?be.getLiquidityFromTokenAmountA(d,m,y,!a):new ve(0);else if(l.lte(m)){let g=be.getLiquidityFromTokenAmountA(l,m,y,!a),w=be.getLiquidityFromTokenAmountB(d,l,y);f=t?g:w}else f=t?new ve(0):be.getLiquidityFromTokenAmountB(d,m,y);let b=await Le.getAmountsFromLiquidity({epochInfo:c,poolInfo:e,tickLower:n,tickUpper:o,liquidity:f,slippage:s,add:a});return{liquidity:f,amountA:t?p:b.amountA,amountB:t?b.amountB:p,amountSlippageA:t?p:b.amountSlippageA,amountSlippageB:t?b.amountSlippageB:p,expirationTime:b.expirationTime}}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:o,liquidity:r,slippage:s,add:a}){let c=ne.getSqrtPriceX64FromTick(n),u=ne.getSqrtPriceX64FromTick(o),l=a?1+s:1-s,d=be.getAmountsFromLiquidity(ne.priceToSqrtPriceX64(new C(t.price),t.mintA.decimals,t.mintB.decimals),c,u,r,a),[m,p]=[we(d.amountA,t.mintA.extensions?.feeConfig,e,!0),we(d.amountB,t.mintB.extensions?.feeConfig,e,!0)],[y,f]=[we(d.amountA.muln(l),t.mintA.extensions?.feeConfig,e,!0),we(d.amountB.muln(l),t.mintB.extensions?.feeConfig,e,!0)];return{liquidity:r,amountA:m,amountB:p,amountSlippageA:y,amountSlippageB:f,expirationTime:Ht(m.expirationTime,p.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let o=t.filter(c=>!n[c.id]).map(c=>new Ot(c.id));(await Dt(e,o)).forEach((c,u)=>{!c||(n[o[u].toBase58()]=Jn.decode(c.data))});let s=t.map(c=>Ge(new Ot(c.programId),new Ot(c.id)).publicKey),a=await Le.fetchExBitmaps({connection:e,exBitmapAddress:s,batchRequest:!1});return t.reduce((c,u)=>({...c,[u.id]:{...n[u.id],id:new Ot(u.id),version:6,programId:new Ot(u.programId),mintA:u.mintA,mintB:u.mintB,ammConfig:{...u.config,id:new Ot(u.config.id),fundOwner:""},currentPrice:new C(u.price),exBitmapAccount:Ge(new Ot(u.programId),new Ot(u.id)).publicKey,exBitmapInfo:a[Ge(new Ot(u.programId),new Ot(u.id)).publicKey.toBase58()],startTime:n[u.id].startTime.toNumber(),rewardInfos:n[u.id].rewardInfos}}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};function TI({poolInfo:i,tickLower:e,tickUpper:t,amountA:n,amountB:o,slippage:r,add:s,epochInfo:a,amountHasFee:c}){let[u,l,d,m]=e<t?[e,t,n,o]:[t,e,o,n],p=ne.priceToSqrtPriceX64(new C(i.price),i.mintA.decimals,i.mintB.decimals),y=ne.getSqrtPriceX64FromTick(u),f=ne.getSqrtPriceX64FromTick(l),[b,g]=[we(d,i.mintA.extensions?.feeConfig,a,!c),we(m,i.mintB.extensions?.feeConfig,a,!c)],w=be.getLiquidityFromTokenAmounts(p,y,f,b.amount.sub(b.fee??fe),g.amount.sub(g.fee??fe));return be.getAmountsOutFromLiquidity({poolInfo:i,tickLower:e,tickUpper:t,liquidity:w,slippage:r,add:s,epochInfo:a,amountAddFee:!c})}var Sa={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};function el(i){return{...i,type:"Concentrated",programId:i.programId.toString(),id:i.id.toString(),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Clmm",price:i.currentPrice.toNumber(),mintAmountA:0,mintAmountB:0,feeRate:i.ammConfig.tradeFeeRate,openTime:i.startTime.toString(),tvl:0,day:Sa,week:Sa,month:Sa,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,burnPercent:0,config:{...i.ammConfig,id:i.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]}}}var ae=class{static mulDivRoundingUp(e,t,n){let o=e.mul(t),r=o.div(n);return o.mod(n).eq(fe)||(r=r.add(Nt)),r}static mulDivFloor(e,t,n){if(n.eq(fe))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(fe))throw new Error("division by 0");return e.mul(t).add(n.sub(Nt)).div(n)}static x64ToDecimal(e,t){return new C(e.toString()).div(C.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new me(e.mul(C.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(Cr).sub(t).mod(Cr)}};function st(i,e){return Ka(i.mul(e),64,256)}function Hf(i,e,t){let n=i.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function Ka(i,e,t){let n=i.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var ne=class{static sqrtPriceX64ToPrice(e,t,n){return ae.x64ToDecimal(e).pow(2).mul(C.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return ae.decimalToX64(e.mul(C.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,o){if(!e.gt(fe))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(fe))throw new Error("liquidity must greater than 0");return o?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,o){if(!e.gt(fe))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(fe))throw new Error("liquidity must greater than 0");return o?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,o){if(n.eq(fe))return e;let r=t.shln(fi);if(o){let s=r,a=r.add(n.mul(e));return a.gte(s)?ae.mulDivCeil(s,e,a):ae.mulDivRoundingUp(s,Nt,s.div(e).add(n))}else{let s=n.mul(e);if(!r.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=r.sub(s);return ae.mulDivCeil(r,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,o){let r=n.shln(fi);if(o)return e.add(r.div(t));{let s=ae.mulDivRoundingUp(r,Nt,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<bt||e>kt)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new me("18445821805675395072"):new me("18446744073709551616");return(t&2)!=0&&(n=st(n,new me("18444899583751176192"))),(t&4)!=0&&(n=st(n,new me("18443055278223355904"))),(t&8)!=0&&(n=st(n,new me("18439367220385607680"))),(t&16)!=0&&(n=st(n,new me("18431993317065453568"))),(t&32)!=0&&(n=st(n,new me("18417254355718170624"))),(t&64)!=0&&(n=st(n,new me("18387811781193609216"))),(t&128)!=0&&(n=st(n,new me("18329067761203558400"))),(t&256)!=0&&(n=st(n,new me("18212142134806163456"))),(t&512)!=0&&(n=st(n,new me("17980523815641700352"))),(t&1024)!=0&&(n=st(n,new me("17526086738831433728"))),(t&2048)!=0&&(n=st(n,new me("16651378430235570176"))),(t&4096)!=0&&(n=st(n,new me("15030750278694412288"))),(t&8192)!=0&&(n=st(n,new me("12247334978884435968"))),(t&16384)!=0&&(n=st(n,new me("8131365268886854656"))),(t&32768)!=0&&(n=st(n,new me("3584323654725218816"))),(t&65536)!=0&&(n=st(n,new me("696457651848324352"))),(t&131072)!=0&&(n=st(n,new me("26294789957507116"))),(t&262144)!=0&&(n=st(n,new me("37481735321082"))),e>0&&(n=Wc.div(n)),n}static getTickFromPrice(e,t,n){return ne.getTickFromSqrtPriceX64(ne.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(Vt)||e.lt(Ft))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new me(t-64),o=Hf(n,32,128),r=new me("8000000000000000","hex"),s=0,a=new me(0),c=t>=64?e.shrn(t-63):e.shln(63-t);for(;r.gt(new me(0))&&s<Dc;){c=c.mul(c);let y=c.shrn(127);c=c.shrn(63+y.toNumber()),a=a.add(r.mul(y)),r=r.shrn(1),s+=1}let u=a.shrn(32),d=o.add(u).mul(new me(qc)),m=Ka(d.sub(new me(Uc)),64,128).toNumber(),p=Ka(d.add(new me(Gc)),64,128).toNumber();return m==p?m:ne.getSqrtPriceX64FromTick(p).lte(e)?p:m}},eo=class{static getTickWithPriceAndTickspacing(e,t,n,o){let s=ne.getTickFromSqrtPriceX64(ne.priceToSqrtPriceX64(e,n,o))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,o){let r=eo.getTickWithPriceAndTickspacing(e,t,n,o),s=ne.getSqrtPriceX64FromTick(r);return ne.sqrtPriceX64ToPrice(s,n,o)}},be=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,o){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(fe))throw new Error("sqrtPriceX64A must greater than 0");let r=n.ushln(fi),s=t.sub(e);return o?ae.mulDivRoundingUp(ae.mulDivCeil(r,s,t),Nt,e):ae.mulDivFloor(r,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,o){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(fe))throw new Error("sqrtPriceX64A must greater than 0");return o?ae.mulDivCeil(n,t.sub(e),Ye):ae.mulDivFloor(n,t.sub(e),Ye)}static getLiquidityFromTokenAmountA(e,t,n,o){e.gt(t)&&([e,t]=[t,e]);let r=n.mul(e).mul(t),s=t.sub(e),a=r.div(s);return o?ae.mulDivRoundingUp(a,Nt,pi):a.shrn(fi)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),ae.mulDivFloor(n,pi,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,o,r){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return be.getLiquidityFromTokenAmountA(t,n,o,!1);if(e.lt(n)){let s=be.getLiquidityFromTokenAmountA(e,n,o,!1),a=be.getLiquidityFromTokenAmountB(t,e,r);return s.lt(a)?s:a}else return be.getLiquidityFromTokenAmountB(t,n,r)}static getAmountsFromLiquidity(e,t,n,o,r){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:be.getTokenAmountAFromLiquidity(t,n,o,r),amountB:new me(0)};if(e.lt(n)){let s=be.getTokenAmountAFromLiquidity(e,n,o,r),a=be.getTokenAmountBFromLiquidity(t,e,o,r);return{amountA:s,amountB:a}}else return{amountA:new me(0),amountB:be.getTokenAmountBFromLiquidity(t,n,o,r)}}static getAmountsFromLiquidityWithSlippage(e,t,n,o,r,s,a){let{amountA:c,amountB:u}=be.getAmountsFromLiquidity(e,t,n,o,s),l=r?1+a:1-a,d=new me(new C(c.toString()).mul(l).toFixed(0)),m=new me(new C(u.toString()).mul(l).toFixed(0));return{amountSlippageA:d,amountSlippageB:m}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:o,slippage:r,add:s,epochInfo:a,amountAddFee:c}){let u=ne.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),l=ne.getSqrtPriceX64FromTick(t),d=ne.getSqrtPriceX64FromTick(n),m=s?1+r:1-r,p=be.getAmountsFromLiquidity(u,l,d,o,s),[y,f]=[we(p.amountA,e.mintA.extensions?.feeConfig,a,c),we(p.amountB,e.mintB.extensions?.feeConfig,a,c)],[b,g]=[we(new me(new C(p.amountA.toString()).mul(m).toFixed(0)),e.mintA.extensions?.feeConfig,a,c),we(new me(new C(p.amountB.toString()).mul(m).toFixed(0)),e.mintB.extensions?.feeConfig,a,c)];return{liquidity:o,amountA:y,amountB:f,amountSlippageA:b,amountSlippageB:g,expirationTime:Ht(y.expirationTime,f.expirationTime)}}},$n=class{static swapCompute(e,t,n,o,r,s,a,c,u,l,d,m,p,y,f=!1){if(m.eq(fe))throw new Error("amountSpecified must not be 0");if(y||(y=s?Ft.add(Nt):Vt.sub(Nt)),s){if(y.lt(Ft))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(y.gte(d))throw new Error("sqrtPriceX64 must smaller than current")}else{if(y.gt(Vt))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(y.lte(d))throw new Error("sqrtPriceX64 must greater than current")}let b=m.gt(fe),g={amountSpecifiedRemaining:m,amountCalculated:fe,sqrtPriceX64:d,tick:u>p?Math.min(p+ge.tickCount(l)-1,u):p,accounts:[],liquidity:c,feeAmount:new me(0)},w=p,k=n[p],h=0,x=!s&&k.startTickIndex===g.tick;for(;!g.amountSpecifiedRemaining.eq(fe)&&!g.sqrtPriceX64.eq(y);){h>10;let T={};T.sqrtPriceStartX64=g.sqrtPriceX64;let B=H.nextInitTick(k,g.tick,l,s,x),S=B||null,I=null;if(!S?.liquidityGross.gtn(0)){let O=Le.nextInitializedTickArrayStartIndex({tickCurrent:g.tick,tickSpacing:l,tickArrayBitmap:o,exBitmapInfo:r},w,s);if(!O.isExist){if(f)return{allTrade:!1,amountSpecifiedRemaining:g.amountSpecifiedRemaining,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts};throw Error("swapCompute LiquidityInsufficient")}w=O.nextStartIndex;let{publicKey:v}=ye(e,t,w);I=v,k=n[w];try{S=H.firstInitializedTick(k,s)}catch{throw Error("not found next tick info")}}T.tickNext=S.tick,T.initialized=S.liquidityGross.gtn(0),p!==w&&I&&(g.accounts.push(I),p=w),T.tickNext<bt?T.tickNext=bt:T.tickNext>kt&&(T.tickNext=kt),T.sqrtPriceNextX64=ne.getSqrtPriceX64FromTick(T.tickNext);let K;if(s&&T.sqrtPriceNextX64.lt(y)||!s&&T.sqrtPriceNextX64.gt(y)?K=y:K=T.sqrtPriceNextX64,[g.sqrtPriceX64,T.amountIn,T.amountOut,T.feeAmount]=$n.swapStepCompute(g.sqrtPriceX64,K,g.liquidity,g.amountSpecifiedRemaining,a,s),g.feeAmount=g.feeAmount.add(T.feeAmount),b?(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.sub(T.amountIn.add(T.feeAmount)),g.amountCalculated=g.amountCalculated.sub(T.amountOut)):(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.add(T.amountOut),g.amountCalculated=g.amountCalculated.add(T.amountIn.add(T.feeAmount))),g.sqrtPriceX64.eq(T.sqrtPriceNextX64)){if(T.initialized){let O=S.liquidityNet;s&&(O=O.mul(wn)),g.liquidity=be.addDelta(g.liquidity,O)}x=T.tickNext!=g.tick&&!s&&k.startTickIndex===T.tickNext,g.tick=s?T.tickNext-1:T.tickNext}else if(g.sqrtPriceX64!=T.sqrtPriceStartX64){let O=ne.getTickFromSqrtPriceX64(g.sqrtPriceX64);x=O!=g.tick&&!s&&k.startTickIndex===O,g.tick=O}++h}try{let{nextStartIndex:T,isExist:B}=ge.nextInitializedTickArray(g.tick,l,s,o,r);B&&p!==T&&(g.accounts.push(ye(e,t,T).publicKey),p=T)}catch{}return{allTrade:!0,amountSpecifiedRemaining:fe,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts}}static swapStepCompute(e,t,n,o,r,s){let a={sqrtPriceX64Next:new me(0),amountIn:new me(0),amountOut:new me(0),feeAmount:new me(0)},c=o.gte(fe);if(c){let l=ae.mulDivFloor(o,Nr.sub(new me(r.toString())),Nr);a.amountIn=s?be.getTokenAmountAFromLiquidity(t,e,n,!0):be.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(a.amountIn)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=ne.getNextSqrtPriceX64FromInput(e,n,l,s)}else a.amountOut=s?be.getTokenAmountBFromLiquidity(t,e,n,!1):be.getTokenAmountAFromLiquidity(e,t,n,!1),o.mul(wn).gte(a.amountOut)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=ne.getNextSqrtPriceX64FromOutput(e,n,o.mul(wn),s);let u=t.eq(a.sqrtPriceX64Next);return s?(u&&c||(a.amountIn=be.getTokenAmountAFromLiquidity(a.sqrtPriceX64Next,e,n,!0)),u&&!c||(a.amountOut=be.getTokenAmountBFromLiquidity(a.sqrtPriceX64Next,e,n,!1))):(a.amountIn=u&&c?a.amountIn:be.getTokenAmountBFromLiquidity(e,a.sqrtPriceX64Next,n,!0),a.amountOut=u&&!c?a.amountOut:be.getTokenAmountAFromLiquidity(e,a.sqrtPriceX64Next,n,!1)),!c&&a.amountOut.gt(o.mul(wn))&&(a.amountOut=o.mul(wn)),c&&!a.sqrtPriceX64Next.eq(t)?a.feeAmount=o.sub(a.amountIn):a.feeAmount=ae.mulDivCeil(a.amountIn,new me(r),Nr.sub(new me(r))),[a.sqrtPriceX64Next,a.amountIn,a.amountOut,a.feeAmount]}};var Je=60,Zn=512,H=class{static getTickArrayAddressByTick(e,t,n,o){let r=H.getTickArrayStartIndexByTick(n,o),{publicKey:s}=ye(e,t,r);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=H.getTickArrayStartIndexByTick(e,t),o=Math.floor((e-n)/t);if(o<0||o>=Je)throw new Error("tick offset in array overflow");return o}static getTickArrayBitIndex(e,t){let n=ge.tickCount(t),o=e/n;return e<0&&e%n!=0?o=Math.ceil(o)-1:o=Math.floor(o),o}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*ge.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*Je,o=Math.floor(e/n)+512;return Math.abs(o)}static checkTickArrayIsInitialized(e,t,n){let o=n*Je,r=Math.floor(t/o)+512,s=Math.abs(r);return{isInitialized:e.testn(s),startIndex:(s-512)*o}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*Je:e+t*Je}static mergeTickArrayBitmap(e){let t=new jf(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,o,r){let s=Math.floor(o/(n*Je));return[...H.searchLowBitFromStart(e,t,s-1,r,n),...H.searchHightBitFromStart(e,t,s,r,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return H.searchHightBitFromStart(e,t,-7680,Zn,n)}static getAllInitializedTickArrayInfo(e,t,n,o,r){let s=[],a=H.getAllInitializedTickArrayStartIndex(n,o,r);for(let c of a){let{publicKey:u}=ye(e,t,c);s.push({tickArrayStartIndex:c,tickArrayAddress:u})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,o,r){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>H.mergeTickArrayBitmap(u)),a=[];for(;n>=-7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n--,a.length===o)break}let c=ge.tickCount(r);return a.map(u=>u*c)}static searchHightBitFromStart(e,t,n,o,r){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>H.mergeTickArrayBitmap(u)),a=[];for(;n<7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n++,a.length===o)break}let c=ge.tickCount(r);return a.map(u=>u*c)}static checkIsOutOfBoundary(e){return e<bt||e>kt}static nextInitTick(e,t,n,o,r){if(ge.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(o)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(r||(a=a+1);a<Je;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=Je-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<Je;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let o=ne.getSqrtPriceX64FromTick(t),r=ne.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:r,tickSqrtPriceX64:o}:{tick:t,price:new C(1).div(r),tickSqrtPriceX64:o}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let o=n?t:new C(1).div(t),r=eo.getTickWithPriceAndTickspacing(o,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=ne.getSqrtPriceX64FromTick(r),a=ne.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:r,price:a}:{tick:r,price:new C(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let o=ne.getSqrtPriceX64FromTick(t),r=ne.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:r,tickSqrtPriceX64:o}:{tick:t,price:new C(1).div(r),tickSqrtPriceX64:o}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let o=n?t:new C(1).div(t),r=eo.getTickWithPriceAndTickspacing(o,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=ne.getSqrtPriceX64FromTick(r),a=ne.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:r,price:a}:{tick:r,price:new C(1).div(a)}}};var nl=N([ke(8),F("bump"),Zt("index"),L(""),ut("protocolFeeRate"),ut("tradeFeeRate"),Zt("tickSpacing"),X(A(),8,"")]),Yf=N([ut("blockTimestamp"),ko("tickCumulative"),X(A(),4)]),ol=N([ke(8),_e("initialized"),A("recentEpoch"),Zt("observationIndex"),L("poolId"),X(Yf,100,"observations"),X(A(),4)]),Zf=N([F("rewardState"),A("openTime"),A("endTime"),A("lastUpdateTime"),J("emissionsPerSecondX64"),A("rewardTotalEmissioned"),A("rewardClaimed"),L("tokenMint"),L("tokenVault"),L("creator"),J("rewardGrowthGlobalX64")]),Jn=N([ke(8),F("bump"),L("ammConfig"),L("creator"),L("mintA"),L("mintB"),L("vaultA"),L("vaultB"),L("observationId"),F("mintDecimalsA"),F("mintDecimalsB"),Zt("tickSpacing"),J("liquidity"),J("sqrtPriceX64"),Oe("tickCurrent"),ut(),J("feeGrowthGlobalX64A"),J("feeGrowthGlobalX64B"),A("protocolFeesTokenA"),A("protocolFeesTokenB"),J("swapInAmountTokenA"),J("swapOutAmountTokenB"),J("swapInAmountTokenB"),J("swapOutAmountTokenA"),F("status"),X(F(),7,""),X(Zf,3,"rewardInfos"),X(A(),16,"tickArrayBitmap"),A("totalFeesTokenA"),A("totalFeesClaimedTokenA"),A("totalFeesTokenB"),A("totalFeesClaimedTokenB"),A("fundFeesTokenA"),A("fundFeesTokenB"),A("startTime"),X(A(),15*4-3,"padding")]),$f=N([J("growthInsideLastX64"),A("rewardAmountOwed")]),ki=N([ke(8),F("bump"),L("nftMint"),L("poolId"),Oe("tickLower"),Oe("tickUpper"),J("liquidity"),J("feeGrowthInsideLastX64A"),J("feeGrowthInsideLastX64B"),A("tokenFeesOwedA"),A("tokenFeesOwedB"),X($f,3,"rewardInfos"),X(A(),8,"")]),zI=N([ke(8),F("bump"),L("poolId"),Oe("tickLowerIndex"),Oe("tickUpperIndex"),J("liquidity"),J("feeGrowthInsideLastX64A"),J("feeGrowthInsideLastX64B"),A("tokenFeesOwedA"),A("tokenFeesOwedB"),X(J(),3,"rewardGrowthInside"),X(A(),8,"")]),Jf=N([Oe("tick"),gc("liquidityNet"),J("liquidityGross"),J("feeGrowthOutsideX64A"),J("feeGrowthOutsideX64B"),X(J(),3,"rewardGrowthsOutsideX64"),X(ut(),13,"")]),Ai=N([ke(8),L("poolId"),Oe("startTickIndex"),X(Jf,Je,"ticks"),F("initializedTickCount"),X(F(),115,"")]),il=N([ke(329),X(L(),100,"whitelistMints")]),tl=N([ke(8),L("poolId"),X(X(A(),8),xa,"positiveTickArrayBitmap"),X(X(A(),8),xa,"negativeTickArrayBitmap")]),HI=N([A(),F("bump"),L("owner"),L("poolId"),L("positionId"),L("nftAccount"),X(A(),8)]),jI=N([ke(8),F("bump"),L("lockOwner"),L("poolId"),L("positionId"),L("nftAccount"),L("lockNftMint"),A("recentEpoch"),X(A(),8)]);ol.span;var rl=de("Raydium_Clmm"),vt={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],openPositionWithTokenEx:[77,255,174,82,125,29,201,46],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},sl=[188,37,179,131,82,150,84,73],al=[16,72,250,198,14,162,212,19],xe=class{static createPoolInstruction(e,t,n,o,r,s,a,c,u,l,d,m,p,y){let f=N([J("sqrtPriceX64"),A("zero")]),b=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},...y?.map(k=>({pubkey:k,isSigner:!1,isWritable:!1}))||[]],g=Buffer.alloc(f.span);f.encode({sqrtPriceX64:p,zero:fe},g);let w=Buffer.from([...vt.createPool,...g]);return new ct({keys:b,programId:e,data:w})}static async createPoolInstructions(e){let{programId:t,owner:n,mintA:o,mintB:r,ammConfigId:s,initialPriceX64:a,extendMintAccount:c}=e,[u,l]=[new U(o.address),new U(r.address)],{publicKey:d}=jc(t,s,u,l),{publicKey:m}=Zc(t,d),{publicKey:p}=Ta(t,d,u),{publicKey:y}=Ta(t,d,l),f=Ge(t,d).publicKey,b=[this.createPoolInstruction(t,d,n,s,m,u,p,new U(o.programId||Be),l,y,new U(r.programId||Be),f,a,c)];return{signers:[],instructions:b,instructionTypes:[V.CreateAccount,V.ClmmCreatePool],address:{poolId:d,observationId:m,exBitmapAccount:f,mintAVault:p,mintBVault:y},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I,K){let O=N([Oe("tickLowerIndex"),Oe("tickUpperIndex"),Oe("tickArrayLowerStartIndex"),Oe("tickArrayUpperStartIndex"),J("liquidity"),A("amountMaxA"),A("amountMaxB"),_e("withMetadata"),F("optionBaseFlag"),_e("baseFlag")]),v=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],_=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:hi,isSigner:!1,isWritable:!1},{pubkey:Gt,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...v],D=Buffer.alloc(O.span);O.encode({tickLowerIndex:w,tickUpperIndex:k,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:x,liquidity:T,amountMaxA:B,amountMaxB:S,withMetadata:I==="create",baseFlag:!1,optionBaseFlag:0},D);let q=Buffer.from([...vt.openPosition,...D]);return new ct({keys:_,programId:e,data:q})}static openPositionFromLiquidityInstruction22(e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I){let K=N([Oe("tickLowerIndex"),Oe("tickUpperIndex"),Oe("tickArrayLowerStartIndex"),Oe("tickArrayUpperStartIndex"),J("liquidity"),A("amountMaxA"),A("amountMaxB"),_e("withMetadata"),F("optionBaseFlag"),_e("baseFlag")]),O=[...I?[{pubkey:I,isSigner:!1,isWritable:!0}]:[]],v=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:hi,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...O],_=Buffer.alloc(K.span);K.encode({tickLowerIndex:g,tickUpperIndex:w,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:h,liquidity:x,amountMaxA:T,amountMaxB:B,withMetadata:S==="create",baseFlag:!1,optionBaseFlag:0},_);let D=Buffer.from([...vt.openPositionWithTokenEx,..._]);return new ct({keys:v,programId:e,data:D})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:r,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:d}){let m=[],[p,y]=[new U(e.programId),new U(e.id)],f;if(l)f=new U((await l(1))[0]);else{let I=Mr.generate();m.push(I),f=I.publicKey}let b=H.getTickArrayStartIndexByTick(o,e.config.tickSpacing),g=H.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:w}=ye(p,y,b),{publicKey:k}=ye(p,y,g),{publicKey:h}=d?$(n.wallet,f,Ve):$(n.wallet,f,Be),{publicKey:x}=kn(f),{publicKey:T}=ht(p,f),{publicKey:B}=en(p,y,o,r),S=d?this.openPositionFromLiquidityInstruction22(p,n.feePayer,y,n.wallet,f,h,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),o,r,b,g,s,a,c,u,Le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ge(p,y).publicKey:void 0):this.openPositionFromLiquidityInstruction(p,n.feePayer,y,n.wallet,f,h,x,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),o,r,b,g,s,a,c,u,Le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ge(p,y).publicKey:void 0);return{signers:m,instructions:[S],instructionTypes:[V.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:f,tickArrayLower:w,tickArrayUpper:k,positionNftAccount:h,metadataAccount:x,personalPosition:T,protocolPosition:B}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:r,base:s,baseAmount:a,otherAmountMax:c,withMetadata:u,getEphemeralSigners:l,nft2022:d}){let m=[],[p,y]=[new U(e.programId),new U(e.id)],f;if(l)f=new U((await l(1))[0]);else{let I=Mr.generate();m.push(I),f=I.publicKey}let b=H.getTickArrayStartIndexByTick(o,e.config.tickSpacing),g=H.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:w}=ye(p,y,b),{publicKey:k}=ye(p,y,g),{publicKey:h}=d?$(n.wallet,f,Ve):$(n.wallet,f,Be),{publicKey:x}=kn(f),{publicKey:T}=ht(p,f),{publicKey:B}=en(p,y,o,r),S=d?this.openPositionFromBaseInstruction22(p,n.feePayer,y,n.wallet,f,h,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),o,r,b,g,u,s,a,c,Le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ge(p,y).publicKey:void 0):this.openPositionFromBaseInstruction(p,n.feePayer,y,n.wallet,f,h,x,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),o,r,b,g,u,s,a,c,Le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ge(p,y).publicKey:void 0);return{address:{nftMint:f,tickArrayLower:w,tickArrayUpper:k,positionNftAccount:h,metadataAccount:x,personalPosition:T,protocolPosition:B},instructions:[S],signers:m,instructionTypes:[V.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I,K){let O=N([Oe("tickLowerIndex"),Oe("tickUpperIndex"),Oe("tickArrayLowerStartIndex"),Oe("tickArrayUpperStartIndex"),J("liquidity"),A("amountMaxA"),A("amountMaxB"),_e("withMetadata"),F("optionBaseFlag"),_e("baseFlag")]),v=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],_=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:hi,isSigner:!1,isWritable:!1},{pubkey:Gt,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...v],D=Buffer.alloc(O.span);O.encode({tickLowerIndex:w,tickUpperIndex:k,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:x,liquidity:new Ca(0),amountMaxA:B==="MintA"?S:I,amountMaxB:B==="MintA"?I:S,withMetadata:T==="create",baseFlag:B==="MintA",optionBaseFlag:1},D);let q=Buffer.from([...vt.openPosition,...D]);return new ct({keys:_,programId:e,data:q})}static openPositionFromBaseInstruction22(e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I){let K=N([Oe("tickLowerIndex"),Oe("tickUpperIndex"),Oe("tickArrayLowerStartIndex"),Oe("tickArrayUpperStartIndex"),J("liquidity"),A("amountMaxA"),A("amountMaxB"),_e("withMetadata"),F("optionBaseFlag"),_e("baseFlag")]),O=[...I?[{pubkey:I,isSigner:!1,isWritable:!0}]:[]],v=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:hi,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...O],_=Buffer.alloc(K.span);K.encode({tickLowerIndex:g,tickUpperIndex:w,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:h,liquidity:new Ca(0),amountMaxA:T==="MintA"?B:S,amountMaxB:T==="MintA"?S:B,withMetadata:x==="create",baseFlag:T==="MintA",optionBaseFlag:1},_);let D=Buffer.from([...vt.openPositionWithTokenEx,..._]);return new ct({keys:v,programId:e,data:D})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:r,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:d}){let m,p=[];if(l)m=new U((await l(1))[0]);else{let I=Mr.generate();p.push(I),m=I.publicKey}let[y,f]=[new U(e.programId),new U(e.id)],b=H.getTickArrayStartIndexByTick(o,e.config.tickSpacing),g=H.getTickArrayStartIndexByTick(r,e.config.tickSpacing),{publicKey:w}=ye(y,f,b),{publicKey:k}=ye(y,f,g),{publicKey:h}=d?$(n.wallet,m,Ve):$(n.wallet,m,Be),{publicKey:x}=kn(m),{publicKey:T}=ht(y,m),{publicKey:B}=en(y,f,o,r),S=d?this.openPositionFromLiquidityInstruction22(y,n.wallet,f,n.wallet,m,h,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(t.mintA.address),new U(t.mintB.address),o,r,b,g,s,a,c,u,Le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ge(y,f).publicKey:void 0):this.openPositionFromLiquidityInstruction(y,n.wallet,f,n.wallet,m,h,x,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(t.mintA.address),new U(t.mintB.address),o,r,b,g,s,a,c,u,Le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ge(y,f).publicKey:void 0);return{address:{nftMint:m,tickArrayLower:w,tickArrayUpper:k,positionNftAccount:h,metadataAccount:x,personalPosition:T,protocolPosition:B},instructions:[S],signers:p,instructionTypes:[V.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,o,r,s){let a=N([]),c=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:Tn.programId,isSigner:!1,isWritable:!1},{pubkey:s?Ve:Be,isSigner:!1,isWritable:!1}],u=Buffer.alloc(a.span);a.encode({},u);let l=Buffer.from([...vt.closePosition,...u]);return new ct({keys:c,programId:e,data:l})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:o,nft2022:r}){let s=new U(e.programId),a=r?$(n.wallet,o.nftMint,Ve).publicKey:$(n.wallet,o.nftMint,Be).publicKey,{publicKey:c}=ht(s,o.nftMint),u=[];return u.push(this.closePositionInstruction(s,n.wallet,o.nftMint,a,c,r)),{address:{positionNftAccount:a,personalPosition:c},signers:[],instructions:u,instructionTypes:[V.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g,w){let k=N([J("liquidity"),A("amountMaxA"),A("amountMaxB"),F("optionBaseFlag"),_e("baseFlag")]),h=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[]],x=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...h],T=Buffer.alloc(k.span);k.encode({liquidity:f,amountMaxA:b,amountMaxB:g,optionBaseFlag:0,baseFlag:!1},T);let B=Buffer.from([...vt.increaseLiquidity,...T]);return new ct({keys:x,programId:e,data:B})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,liquidity:r,amountMaxA:s,amountMaxB:a,nft2022:c}){let[u,l]=[new U(e.programId),new U(e.id)],d=H.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=H.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=ye(u,l,d),{publicKey:y}=ye(u,l,m),{publicKey:f}=c?$(o.wallet,n.nftMint,Ve):$(o.wallet,n.nftMint,Be),{publicKey:b}=ht(u,n.nftMint),{publicKey:g}=en(u,l,n.tickLower,n.tickUpper),w=this.increasePositionFromLiquidityInstruction(u,o.wallet,f,b,l,g,p,y,o.tokenAccountA,o.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),r,s,a,Le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[d,m])?Ge(u,l).publicKey:void 0);return{address:{tickArrayLower:p,tickArrayUpper:y,positionNftAccount:f,personalPosition:b,protocolPosition:g},signers:[],instructions:[w],instructionTypes:[V.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,base:r,baseAmount:s,otherAmountMax:a,nft2022:c}){let[u,l]=[new U(e.programId),new U(e.id)],d=H.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=H.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=ye(u,l,d),{publicKey:y}=ye(u,l,m),{publicKey:f}=c?$(o.wallet,n.nftMint,Ve):$(o.wallet,n.nftMint,Be),{publicKey:b}=ht(u,n.nftMint),{publicKey:g}=en(u,l,n.tickLower,n.tickUpper);return{address:{tickArrayLower:p,tickArrayUpper:y,positionNftAccount:f,personalPosition:b,protocolPosition:g},instructions:[this.increasePositionFromBaseInstruction(u,o.wallet,f,b,l,g,p,y,o.tokenAccountA,o.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),r,s,a,Le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[d,m])?Ge(u,l).publicKey:void 0)],signers:[],instructionTypes:[V.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g,w){let k=N([J("liquidity"),A("amountMaxA"),A("amountMaxB"),F("optionBaseFlag"),_e("baseFlag")]),h=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[]],x=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...h],T=Buffer.alloc(k.span);k.encode({liquidity:new Ca(0),amountMaxA:f==="MintA"?b:g,amountMaxB:f==="MintA"?g:b,baseFlag:f==="MintA",optionBaseFlag:1},T);let B=Buffer.from([...vt.increaseLiquidity,...T]);return new ct({keys:x,programId:e,data:B})}static decreaseLiquidityInstruction(e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g,w,k){let h=N([J("liquidity"),A("amountMinA"),A("amountMinB")]),x=[...k?[{pubkey:k,isSigner:!1,isWritable:!0}]:[],...f.map(I=>[{pubkey:I.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:I.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:I.rewardMint,isSigner:!1,isWritable:!1}]).flat()],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:or,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...x],B=Buffer.alloc(h.span);h.encode({liquidity:b,amountMinA:g,amountMinB:w},B);let S=Buffer.from([...vt.decreaseLiquidity,...B]);return new ct({keys:T,programId:e,data:S})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,liquidity:r,amountMinA:s,amountMinB:a,programId:c,nft2022:u}){let[l,d]=[new U(e.programId),new U(e.id)],m=H.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),p=H.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:y}=ye(l,d,m),{publicKey:f}=ye(l,d,p),{publicKey:b}=u?$(o.wallet,n.nftMint,Ve):$(o.wallet,n.nftMint,c),{publicKey:g}=ht(l,n.nftMint),{publicKey:w}=en(l,d,n.tickLower,n.tickUpper),k=[];for(let T=0;T<e.rewardDefaultInfos.length;T++)k.push({poolRewardVault:new U(t.rewardInfos[T].vault),ownerRewardVault:o.rewardAccounts[T],rewardMint:new U(e.rewardDefaultInfos[T].mint.address)});let h=[],x=this.decreaseLiquidityInstruction(l,o.wallet,b,g,d,w,y,f,o.tokenAccountA,o.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),k,r,s,a,Le.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,p])?Ge(l,d).publicKey:void 0);return h.push(x),{address:{tickArrayLower:y,tickArrayUpper:f,positionNftAccount:b,personalPosition:g,protocolPosition:w},signers:[],instructions:h,instructionTypes:[V.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g){let w=N([A("amount"),A("otherAmountThreshold"),J("sqrtPriceLimitX64"),_e("isBaseInput")]),k=[...g?[{pubkey:g,isSigner:!1,isWritable:!0}]:[],...d.map(B=>({pubkey:B,isSigner:!1,isWritable:!0}))],h=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:or,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...k],x=Buffer.alloc(w.span);w.encode({amount:p,otherAmountThreshold:y,sqrtPriceLimitX64:f,isBaseInput:b},x);let T=Buffer.from([...vt.swap,...x]);return new ct({keys:h,programId:e,data:T})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:o,inputMint:r,amountIn:s,amountOutMin:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,d]=[new U(e.programId),new U(e.id)],[m,p]=[new U(t.vault.A),new U(t.vault.B)],[y,f]=[new U(e.mintA.address),new U(e.mintB.address)],b=e.mintA.address===r.toString(),g=[this.swapInstruction(l,o.wallet,d,new U(e.config.id),b?o.tokenAccountA:o.tokenAccountB,b?o.tokenAccountB:o.tokenAccountA,b?m:p,b?p:m,b?y:f,b?f:y,u,n,s,a,c,!0,Ge(l,d).publicKey)];return{signers:[],instructions:g,instructionTypes:[V.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static makeSwapBaseOutInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:o,outputMint:r,amountOut:s,amountInMax:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,d]=[new U(e.programId),new U(e.id)],[m,p]=[new U(t.vault.A),new U(t.vault.B)],[y,f]=[new U(e.mintA.address),new U(e.mintB.address)],b=e.mintA.address===r.toBase58(),g=[this.swapInstruction(l,o.wallet,d,new U(e.config.id),b?o.tokenAccountB:o.tokenAccountA,b?o.tokenAccountA:o.tokenAccountB,b?p:m,b?m:p,b?f:y,b?y:f,u,n,s,a,c,!1,Ge(l,d).publicKey)];return{signers:[],instructions:g,instructionTypes:[V.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,o,r,s,a,c,u,l,d,m){let p=N([A("openTime"),A("endTime"),J("emissionsPerSecondX64")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({openTime:Y(l),endTime:Y(d),emissionsPerSecondX64:m},f);let b=Buffer.from([...vt.initReward,...f]);return new ct({keys:y,programId:e,data:b})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:o}){let[r,s]=[new U(e.programId),new U(e.id)],a=Yc(r,s,o.mint).publicKey,c=bi(r).publicKey,u=[this.initRewardInstruction(r,n.wallet,s,c,new U(e.config.id),n.tokenAccount,o.programId,o.mint,a,o.openTime,o.endTime,o.emissionsPerSecondX64)];return{address:{poolRewardVault:a,operationId:c},signers:[],instructions:u,instructionTypes:[V.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,o,r,s,a,c,u,l,d,m){let p=N([F("rewardIndex"),J("emissionsPerSecondX64"),A("openTime"),A("endTime")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0}],f=Buffer.alloc(p.span);p.encode({rewardIndex:u,emissionsPerSecondX64:m,openTime:Y(l),endTime:Y(d)},f);let b=Buffer.from([...vt.setRewardEmissions,...f]);return new ct({keys:y,programId:e,data:b})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:o}){let[r,s]=[new U(e.programId),new U(e.id)],a,c,u;for(let m=0;m<e.rewardDefaultInfos.length;m++)e.rewardDefaultInfos[m].mint.address===o.mint.toString()&&(a=m,c=new U(t.rewardInfos[m].vault),u=new U(t.rewardInfos[m].mint.address));(a===void 0||c===void 0)&&rl.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=bi(r).publicKey,d=[this.setRewardInstruction(r,n.wallet,s,l,new U(e.config.id),n.tokenAccount,c,u,a,o.openTime,o.endTime,o.emissionsPerSecondX64)];return{address:{rewardVault:c,operationId:l},signers:[],instructions:d,instructionTypes:[V.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,o,r,s,a){let c=N([F("rewardIndex")]),u=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:or,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({rewardIndex:a},l);let d=Buffer.from([...vt.collectReward,...l]);return new ct({keys:u,programId:e,data:d})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:o}){let[r,s]=[new U(e.programId),new U(e.id)],a,c;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===o.toString()&&(a=l,c=new U(t.rewardInfos[l].vault));(a===void 0||c===void 0)&&rl.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let u=[this.collectRewardInstruction(r,n.wallet,s,n.tokenAccount,c,o,a)];return{address:{rewardVault:c},signers:[],instructions:u,instructionTypes:[V.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static async makeLockPositions({programId:e,authProgramId:t,poolProgramId:n,payer:o,wallet:r,nftMint:s,nft2022:a,getEphemeralSigners:c}){let u=[],l;if(c)l=new U((await c(1))[0]);else{let g=Mr.generate();u.push(g),l=g.publicKey}let d=a?$(r,s,Ve).publicKey:$(r,s,Be).publicKey,{publicKey:m}=ht(n,s),p=gi(e,l).publicKey,y=$(r,l,Be).publicKey,f=kn(l).publicKey,b=xe.lockPositionInstructionV2({programId:e,auth:t,payer:o,positionOwner:r,lockOwner:r,positionNftAccount:d,positionId:m,lockPositionId:p,lockNftMint:l,lockNftAccount:y,metadataAccount:f,withMetadata:!0,nft2022:a,positionNftMint:s,authPositionNftAccount:$(t,s,a?Ve:Be).publicKey,positionNftProgram:a?Ve:Be});return{address:{positionId:m,lockPositionId:p,lockNftAccount:y,lockNftMint:l,positionNftAccount:d,metadataAccount:f},instructions:[b],signers:u,instructionTypes:[V.ClmmLockPosition],lookupTableAddress:[]}}static lockPositionInstructionV2({programId:e,auth:t,payer:n,positionOwner:o,lockOwner:r,positionNftAccount:s,positionId:a,positionNftMint:c,authPositionNftAccount:u,positionNftProgram:l,lockPositionId:d,lockNftMint:m,lockNftAccount:p,metadataAccount:y,withMetadata:f}){let b=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!0,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:Gt,isSigner:!1,isWritable:!1},{pubkey:hi,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1}],g=N([_e("withMetadata")]),w=Buffer.alloc(g.span);g.encode({withMetadata:f},w);let k=Buffer.from([...sl,...w]);return new ct({keys:b,programId:e,data:k})}static lockPositionInstruction({programId:e,authProgramId:t,poolProgramId:n,owner:o,positionNft:r}){let{publicKey:s}=$(o,r,Be),{publicKey:a}=ht(n,r),c=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:Ia(e,a).publicKey,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Tn.programId,isSigner:!1,isWritable:!1}];return new ct({keys:c,programId:e,data:Buffer.from(sl)})}static harvestLockPositionInstruction(e){let[t,n]=[new U(e.poolKeys.programId),new U(e.poolKeys.id)],o=H.getTickArrayStartIndexByTick(e.ownerPosition.tickLower,e.poolKeys.config.tickSpacing),r=H.getTickArrayStartIndexByTick(e.ownerPosition.tickUpper,e.poolKeys.config.tickSpacing),{publicKey:s}=ye(t,n,o),{publicKey:a}=ye(t,n,r),{publicKey:c}=$(e.owner,e.ownerPosition.nftMint,Be),{publicKey:u}=ht(t,e.ownerPosition.nftMint),{publicKey:l}=en(t,n,e.ownerPosition.tickLower,e.ownerPosition.tickUpper),d=[];for(let y=0;y<e.poolKeys.rewardInfos.length;y++)d.push({poolRewardVault:new U(e.poolKeys.rewardInfos[y].vault),ownerRewardVault:e.ownerRewardAccounts[y],rewardMint:new U(e.poolKeys.rewardInfos[y].mint.address)});let m=[...d.map(y=>[{pubkey:y.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:y.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:y.rewardMint,isSigner:!1,isWritable:!1}]).flat()],p=[{pubkey:e.authProgramId,isSigner:!1,isWritable:!1},{pubkey:Ia(e.programId,u).publicKey,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e.owner,isSigner:!0,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:new U(e.poolKeys.vault.A),isSigner:!1,isWritable:!0},{pubkey:new U(e.poolKeys.vault.B),isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:e.userVaultA,isSigner:!1,isWritable:!0},{pubkey:e.userVaultB,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:sn,isSigner:!1,isWritable:!1},{pubkey:new U(e.poolKeys.mintA.address),isSigner:!1,isWritable:!1},{pubkey:new U(e.poolKeys.mintB.address),isSigner:!1,isWritable:!1},...m];return new ct({keys:p,programId:e.programId,data:Buffer.from(al)})}static harvestLockPositionInstructionV2({programId:e,auth:t,lockPositionId:n,clmmProgram:o,lockOwner:r,lockNftMint:s,lockNftAccount:a,positionNftAccount:c,positionId:u,poolId:l,protocolPosition:d,vaultA:m,vaultB:p,tickArrayLower:y,tickArrayUpper:f,userVaultA:b,userVaultB:g,mintA:w,mintB:k,rewardAccounts:h,exTickArrayBitmap:x}){let T=[...x?[{pubkey:x,isSigner:!1,isWritable:!0}]:[],...h.map(S=>[{pubkey:S.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:S.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:S.rewardMint,isSigner:!1,isWritable:!1}]).flat()],B=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0},{pubkey:Be,isSigner:!1,isWritable:!1},{pubkey:Ve,isSigner:!1,isWritable:!1},{pubkey:sn,isSigner:!1,isWritable:!1},{pubkey:w,isSigner:!1,isWritable:!1},{pubkey:k,isSigner:!1,isWritable:!1},...T];return new ct({keys:B,programId:e,data:Buffer.from(al)})}};var ul=N([ut("mintAuthorityOption"),L("mintAuthority"),A("supply"),F("decimals"),F("isInitialized"),ut("freezeAuthorityOption"),L("freezeAuthority")]);import{PublicKey as ey}from"@solana/web3.js";import{MintLayout as cl,TOKEN_PROGRAM_ID as ty}from"@solana/spl-token";var hB=async({connection:i,mint:e})=>{let t=await i.getAccountInfo(new ey(e));return!t||t.data.length!==cl.span?void 0:cl.decode(t.data)},TB=({mint:i,decimals:e,programId:t=ty,logoURI:n="",priority:o=3})=>{let r=i.toBase58().substring(0,6);return{address:i.toBase58(),decimals:e,symbol:r,logoURI:n,extensions:{},chainId:101,programId:t.toString(),name:r,tags:[],priority:o}},Er=i=>new Te({mint:i.address,decimals:i.decimals,symbol:i.symbol,name:i.name}),Ti=({amount:i,isRaw:e,name:t,...n})=>new Pe(new Te({mint:pt(n.address).toBase58(),decimals:n.decimals,symbol:n.symbol,name:t}),i,e,t);function IB(i){return i.address===rn.address?nt:i}function BB(i){return i.address===nt.address?rn:i}var gt=({address:i,programId:e,decimals:t,...n})=>({chainId:101,address:pt(i).toBase58(),programId:e,logoURI:"",symbol:"",name:"",decimals:t,tags:[],extensions:n.extensions||{},...n}),Vn=i=>i?{...i,transferFeeConfigAuthority:i.transferFeeConfigAuthority.toBase58(),withdrawWithheldAuthority:i.withdrawWithheldAuthority.toBase58(),withheldAmount:i.withheldAmount.toString(),olderTransferFee:{...i.olderTransferFee,epoch:i.olderTransferFee.epoch.toString(),maximumFee:i.olderTransferFee.maximumFee.toString()},newerTransferFee:{...i.newerTransferFee,epoch:i.newerTransferFee.epoch.toString(),maximumFee:i.newerTransferFee.maximumFee.toString()}}:void 0;import ll from"bn.js";var La=new ll(25),_r=new ll(1e4),ny={4:3,5:3};import{PublicKey as Se,SystemProgram as Pl,SYSVAR_RENT_PUBKEY as by,TransactionInstruction as In}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as gy,TOKEN_PROGRAM_ID as Ko}from"@solana/spl-token";var Ra=N([F("instruction"),A("amountIn"),A("minAmountOut")]),Na=N([F("instruction"),A("maxAmountIn"),A("amountOut")]),EB=N([F("instruction"),F("nonce")]),Oa=N([F("instruction"),F("nonce"),A("startTime")]),to=N([A("status"),A("nonce"),A("maxOrder"),A("depth"),A("baseDecimal"),A("quoteDecimal"),A("state"),A("resetFlag"),A("minSize"),A("volMaxCutRatio"),A("amountWaveRatio"),A("baseLotSize"),A("quoteLotSize"),A("minPriceMultiplier"),A("maxPriceMultiplier"),A("systemDecimalValue"),A("minSeparateNumerator"),A("minSeparateDenominator"),A("tradeFeeNumerator"),A("tradeFeeDenominator"),A("pnlNumerator"),A("pnlDenominator"),A("swapFeeNumerator"),A("swapFeeDenominator"),A("baseNeedTakePnl"),A("quoteNeedTakePnl"),A("quoteTotalPnl"),A("baseTotalPnl"),A("poolOpenTime"),A("punishPcAmount"),A("punishCoinAmount"),A("orderbookToInitTime"),J("swapBaseInAmount"),J("swapQuoteOutAmount"),A("swapBase2QuoteFee"),J("swapQuoteInAmount"),J("swapBaseOutAmount"),A("swapQuote2BaseFee"),L("baseVault"),L("quoteVault"),L("baseMint"),L("quoteMint"),L("lpMint"),L("openOrders"),L("marketId"),L("marketProgramId"),L("targetOrders"),L("withdrawQueue"),L("lpVault"),L("owner"),A("lpReserve"),X(A(),3,"padding")]),oy=N([A("accountType"),A("status"),A("nonce"),A("maxOrder"),A("depth"),A("baseDecimal"),A("quoteDecimal"),A("state"),A("resetFlag"),A("minSize"),A("volMaxCutRatio"),A("amountWaveRatio"),A("baseLotSize"),A("quoteLotSize"),A("minPriceMultiplier"),A("maxPriceMultiplier"),A("systemDecimalsValue"),A("abortTradeFactor"),A("priceTickMultiplier"),A("priceTick"),A("minSeparateNumerator"),A("minSeparateDenominator"),A("tradeFeeNumerator"),A("tradeFeeDenominator"),A("pnlNumerator"),A("pnlDenominator"),A("swapFeeNumerator"),A("swapFeeDenominator"),A("baseNeedTakePnl"),A("quoteNeedTakePnl"),A("quoteTotalPnl"),A("baseTotalPnl"),A("poolOpenTime"),A("punishPcAmount"),A("punishCoinAmount"),A("orderbookToInitTime"),J("swapBaseInAmount"),J("swapQuoteOutAmount"),J("swapQuoteInAmount"),J("swapBaseOutAmount"),A("swapQuote2BaseFee"),A("swapBase2QuoteFee"),L("baseVault"),L("quoteVault"),L("baseMint"),L("quoteMint"),L("lpMint"),L("modelDataAccount"),L("openOrders"),L("marketId"),L("marketProgramId"),L("targetOrders"),L("owner"),X(A(),64,"padding")]),va=N([F("instruction"),A("baseAmountIn"),A("quoteAmountIn"),A("fixedSide"),A("otherAmountMin")]),Ma=N([F("instruction"),A("lpAmount"),A("baseAmountMin"),A("quoteAmountMin")]),_B={4:to,5:oy},ml=N([A("fee")]);import{PublicKey as iy}from"@solana/web3.js";var So=new iy("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),oo=5e4,ry=N([A("x"),A("y"),A("price")]),sy=N([A("accountType"),A("status"),A("multiplier"),A("validDataCount"),X(ry,oo,"DataElement")]);function ay(i,e){return[0,oo-2]}function uy(i){return[0,oo-2]}function cy(i){return[0,oo-2]}function ly(i,e,t){let[n,o]=ay(e,t),r=n,s=o,a=0,c=e*i.multiplier/t;for(;r<=s;){if(a=Math.floor((s+r)/2),a===0||a>=oo-2)return[a,a,!1];let u=i.DataElement[a].x*i.multiplier/i.DataElement[a].y,l=i.DataElement[a-1].x*i.multiplier/i.DataElement[a-1].y,d=i.DataElement[a+1].x*i.multiplier/i.DataElement[a+1].y;if(c===u)return[a,a,!0];if(c===l)return[a-1,a-1,!0];if(c===d)return[a+1,a+1,!0];if(c<l)s=a-1;else{if(c>l&&c<u)return[a-1,a,!0];if(c>u&&c<d)return[a,a+1,!0];r=a+1}}return[a,a,!1]}function Ea(i,e,t){let[n,o,r]=ly(i,e,t);if(!r)return 0;if(n===o){let s=i.DataElement[n].x;return e*i.multiplier/s}else{let s=i.DataElement[n].x,a=i.DataElement[n].y,c=i.DataElement[o].x,u=i.DataElement[o].y,l=t*(c*a-s*u),d=s*l,m=(c-s)*(e*a-s*t)*u,p=d+m;return e*i.multiplier*l/p}}function no(i,e,t){return e*i.multiplier/t}function dl(i,e,t){return e*t/i.multiplier}function my(i,e){let[t,n]=uy(e),o=t,r=n,s=0,a=e;for(;o<r;){if(s=Math.floor((r+o)/2),s<=0||s>oo-2)return[s,s,!1];let c=i.DataElement[s].x,u=i.DataElement[s-1].x,l=i.DataElement[s+1].x;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<u)r=s-1;else{if(a>u&&a<c)return[s-1,s,!0];if(a>c&&a<l)return[s,s+1,!0];o=s+1}}return[s,s,!1]}function dy(i,e){let[t,n]=cy(e),o=t,r=n,s=0,a=e;for(;o<=r;){if(s=Math.floor((r+o)/2),s<=0||s>=oo-2)return[s,s,!1];let c=i.DataElement[s].y,u=i.DataElement[s-1].y,l=i.DataElement[s+1].y;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<l)o=s+1;else{if(a<u&&a>c)return[s-1,s,!0];if(a<c&&a>l)return[s,s+1,!0];r=s-1}}return[s,s,!1]}function pl(i,e,t,n){let o=n?e+t:e-t,[r,s,a]=my(i,o);if(!a)return[0,0,!1,a];if(r===s)return[i.DataElement[s].price,i.DataElement[s].y,!1,a];{let c=i.DataElement[r].x,u=i.DataElement[s].x,l=i.DataElement[r].price,d=i.DataElement[s].price,m=i.DataElement[r].y,p=i.DataElement[s].y;if(e>=c&&e<=u)return n?[d,p,!0,a]:[l,m,!0,a];{let y,f;return n?(y=l+(d-l)*(e-c)/(u-c),f=m-(o-c)*i.multiplier/d):(y=l+(d-l)*(e-c)/(u-c),f=p+(u-o)*i.multiplier/l),[y,f,!1,a]}}}function py(i,e,t,n){let o=n?e-t:e+t,[r,s,a]=dy(i,o);if(!a)return[0,0,!1,a];if(r===s)return[i.DataElement[s].price,i.DataElement[s].x,!1,a];{let c=i.DataElement[r].x,u=i.DataElement[s].x,l=i.DataElement[r].price,d=i.DataElement[s].price,m=i.DataElement[r].y,p=i.DataElement[s].y;if(e>=p&&e<=m)return n?[d,u,!0,a]:[l,c,!0,a];{let y,f;return n?(y=l+(d-l)*(m-e)/(m-p),f=c+d*(m-o)/i.multiplier):(y=l+(d-l)*(m-e)/(m-p),f=u-l*(o-p)/i.multiplier),[y,f,!1,a]}}}function fy(i,e){let t=pl(i,e,0,!1);return t[3]?t[0]:0}function fl(i,e,t,n){let o=Ea(i,e,t),r=no(i,e,o),s=no(i,t,o),a=no(i,n,o),c=!0,[u,l,d,m]=pl(i,r,a,c);if(!m)return 0;if(d)return n*i.multiplier/u;{let p=s-l;return dl(i,p,o)}}function yl(i,e,t,n){let o=Ea(i,e,t),r=no(i,e,o),s=no(i,t,o),a=no(i,n,o),c=!1,[u,l,d,m]=py(i,s,a,c);if(!m)return 0;if(d)return n*u/i.multiplier;{let p=r-l;return dl(i,p,o)}}function yy(i){let e=sy.decode(i);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function bl(i,e,t,n){let o=fy(i,no(i,e,Ea(i,e,t)))/i.multiplier;return n?o:1/o}var xo=class{connection;_layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};constructor({connection:e}){this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(So);e&&(this._layoutData=yy(e?.data))}}};var gl=de("Raydium_liquidity_instruction");function Al(i){let{poolInfo:e,poolKeys:t,userKeys:n,baseAmountIn:o,quoteAmountIn:r,fixedSide:s,otherAmountMin:a}=i,c=Buffer.alloc(va.span);va.encode({instruction:3,baseAmountIn:Y(o),quoteAmountIn:Y(r),otherAmountMin:Y(a),fixedSide:s==="base"?ze:Eu},c);let u=[P({pubkey:Ko,isWritable:!1}),P({pubkey:new Se(e.id)}),P({pubkey:new Se(t.authority),isWritable:!1}),P({pubkey:new Se(t.openOrders),isWritable:!1}),P({pubkey:new Se(t.targetOrders)}),P({pubkey:new Se(e.lpMint.address)}),P({pubkey:new Se(t.vault.A)}),P({pubkey:new Se(t.vault.B)})];return e.pooltype.includes("StablePool")&&u.push(P({pubkey:So})),u.push(P({pubkey:new Se(e.marketId),isWritable:!1}),P({pubkey:n.baseTokenAccount}),P({pubkey:n.quoteTokenAccount}),P({pubkey:n.lpTokenAccount}),P({pubkey:n.owner,isWritable:!1,isSigner:!0}),P({pubkey:new Se(t.marketEventQueue),isWritable:!1})),new In({programId:new Se(e.programId),keys:u,data:c})}function _a(i){let{poolInfo:e,poolKeys:t,userKeys:n,lpAmount:o,baseAmountMin:r,quoteAmountMin:s}=i,a=Re(t),c=4;if(e.pooltype.includes("StablePool")&&(c=5),c===4||c===5){let u=Buffer.alloc(Ma.span);Ma.encode({instruction:4,lpAmount:Y(o),baseAmountMin:Y(r),quoteAmountMin:Y(s)},u);let l=[P({pubkey:Ko,isWritable:!1}),P({pubkey:a.id}),P({pubkey:a.authority,isWritable:!1}),P({pubkey:a.openOrders}),P({pubkey:a.targetOrders}),P({pubkey:a.mintLp.address}),P({pubkey:a.vault.A}),P({pubkey:a.vault.B})];return c===5?l.push(P({pubkey:So})):(l.push(P({pubkey:a.id})),l.push(P({pubkey:a.id}))),l.push(P({pubkey:a.marketProgramId,isWritable:!1}),P({pubkey:a.marketId}),P({pubkey:a.marketBaseVault}),P({pubkey:a.marketQuoteVault}),P({pubkey:a.marketAuthority,isWritable:!1}),P({pubkey:n.lpTokenAccount}),P({pubkey:n.baseTokenAccount}),P({pubkey:n.quoteTokenAccount}),P({pubkey:n.owner,isWritable:!1,isSigner:!0}),P({pubkey:a.marketEventQueue}),P({pubkey:a.marketBids}),P({pubkey:a.marketAsks})),new In({programId:a.programId,keys:l,data:u})}return new In({programId:a.programId,keys:[]})}function Fa({programId:i,ammId:e,ammAuthority:t,ammOpenOrders:n,lpMint:o,coinMint:r,pcMint:s,coinVault:a,pcVault:c,withdrawQueue:u,ammTargetOrders:l,poolTempLp:d,marketProgramId:m,marketId:p,userWallet:y,userCoinVault:f,userPcVault:b,userLpVault:g,nonce:w,openTime:k,coinAmount:h,pcAmount:x,ammConfigId:T,feeDestinationId:B}){let S=N([F("instruction"),F("nonce"),A("openTime"),A("pcAmount"),A("coinAmount")]),I=[{pubkey:Ko,isSigner:!1,isWritable:!1},{pubkey:gy,isSigner:!1,isWritable:!1},{pubkey:Pl.programId,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:T,isSigner:!1,isWritable:!1},{pubkey:B,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!0,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0}],K=Buffer.alloc(S.span);return S.encode({instruction:1,nonce:w,openTime:k,coinAmount:h,pcAmount:x},K),{instruction:new In({keys:I,programId:i,data:K}),instructionType:V.AmmV4CreatePool}}function JB(i){let e=N([F("instruction"),F("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[P({pubkey:new Se(i.id),isWritable:!1}),P({pubkey:new Se(i.authority),isWritable:!1}),P({pubkey:new Se(i.openOrders),isWritable:!1}),P({pubkey:new Se(i.vault.A),isWritable:!1}),P({pubkey:new Se(i.vault.B),isWritable:!1}),P({pubkey:new Se(i.mintLp.address),isWritable:!1}),P({pubkey:new Se(i.marketId),isWritable:!1}),P({pubkey:new Se(i.marketEventQueue),isWritable:!1})];return new In({programId:new Se(i.programId),keys:n,data:t})}function Py({poolKeys:i,userKeys:e,amountIn:t,minAmountOut:n},o){let r=Re(i),s=Buffer.alloc(Ra.span);Ra.encode({instruction:9,amountIn:Y(t),minAmountOut:Y(n)},s);let a=[P({pubkey:Ko,isWritable:!1}),P({pubkey:r.id}),P({pubkey:r.authority,isWritable:!1}),P({pubkey:r.openOrders})];return o===4&&a.push(P({pubkey:r.targetOrders})),a.push(P({pubkey:r.vault.A}),P({pubkey:r.vault.B})),o===5&&a.push(P({pubkey:So})),a.push(P({pubkey:r.marketProgramId,isWritable:!1}),P({pubkey:r.marketId}),P({pubkey:r.marketBids}),P({pubkey:r.marketAsks}),P({pubkey:r.marketEventQueue}),P({pubkey:r.marketBaseVault}),P({pubkey:r.marketQuoteVault}),P({pubkey:r.marketAuthority,isWritable:!1}),P({pubkey:e.tokenAccountIn}),P({pubkey:e.tokenAccountOut}),P({pubkey:e.owner,isWritable:!1,isSigner:!0})),new In({programId:r.programId,keys:a,data:s})}function Ay({poolKeys:i,userKeys:e,maxAmountIn:t,amountOut:n},o){let r=Re(i),s=Buffer.alloc(Na.span);Na.encode({instruction:11,maxAmountIn:Y(t),amountOut:Y(n)},s);let a=[P({pubkey:Ko,isWritable:!1}),P({pubkey:r.id}),P({pubkey:r.authority,isWritable:!1}),P({pubkey:r.openOrders}),P({pubkey:r.targetOrders}),P({pubkey:r.vault.A}),P({pubkey:r.vault.B})];return o===5&&a.push(P({pubkey:So})),a.push(P({pubkey:r.marketProgramId,isWritable:!1}),P({pubkey:r.marketId}),P({pubkey:r.marketBids}),P({pubkey:r.marketAsks}),P({pubkey:r.marketEventQueue}),P({pubkey:r.marketBaseVault}),P({pubkey:r.marketQuoteVault}),P({pubkey:r.marketAuthority,isWritable:!1}),P({pubkey:e.tokenAccountIn}),P({pubkey:e.tokenAccountOut}),P({pubkey:e.owner,isWritable:!1,isSigner:!0})),new In({programId:r.programId,keys:a,data:s})}function Fr(i){let{poolKeys:e,version:t,userKeys:n,amountIn:o,amountOut:r,fixedSide:s}=i;if(t===4||t===5){let a={poolKeys:e,userKeys:n};if(s==="in")return Py({...a,amountIn:o,minAmountOut:r},t);if(s==="out")return Ay({...a,maxAmountIn:o,amountOut:r},t);gl.logWithError("invalid params","params",i)}throw gl.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}function ex({poolKeys:i,userKeys:e,startTime:t}){let n=Buffer.alloc(Oa.span);Oa.encode({instruction:0,nonce:5,startTime:Y(t)},n);let o=Re(i),r=[P({pubkey:Ko,isWritable:!1}),P({pubkey:Pl.programId,isWritable:!1}),P({pubkey:by,isWritable:!1}),P({pubkey:o.id}),P({pubkey:o.authority,isWritable:!1}),P({pubkey:o.openOrders}),P({pubkey:o.mintLp.address}),P({pubkey:o.mintA.address,isWritable:!1}),P({pubkey:o.mintB.address,isWritable:!1}),P({pubkey:o.vault.A,isWritable:!1}),P({pubkey:o.vault.B,isWritable:!1}),P({pubkey:o.id}),P({pubkey:o.targetOrders}),P({pubkey:e.lpTokenAccount}),P({pubkey:o.id,isWritable:!1}),P({pubkey:o.marketProgramId,isWritable:!1}),P({pubkey:o.marketId,isWritable:!1}),P({pubkey:e.payer,isSigner:!0})];return new In({programId:o.programId,keys:r,data:n})}function wl({poolKeys:i}){let e=N([F("instruction"),F("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[P({pubkey:new Se(i.id),isWritable:!1}),P({pubkey:new Se(i.authority),isWritable:!1}),P({pubkey:new Se(i.openOrders),isWritable:!1}),P({pubkey:new Se(i.vault.A),isWritable:!1}),P({pubkey:new Se(i.vault.B),isWritable:!1}),P({pubkey:new Se(i.mintLp.address),isWritable:!1}),P({pubkey:new Se(i.marketId),isWritable:!1}),P({pubkey:new Se(i.marketEventQueue),isWritable:!1})];return{instruction:new In({programId:new Se(i.programId),keys:n,data:t})}}import{PublicKey as Bi}from"@solana/web3.js";import Ii from"bn.js";import{TOKEN_PROGRAM_ID as hy}from"@solana/spl-token";import{PublicKey as wy}from"@solana/web3.js";var ky=de("Raydium_liquidity_serum");function kl({programId:i,marketId:e}){let t=[e.toBuffer()],n=0,o;for(;n<100;){try{let r=t.concat(Buffer.from([n]),Buffer.alloc(7));o=wy.createProgramAddressSync(r,i)}catch(r){if(r instanceof TypeError)throw r;n++;continue}return{publicKey:o,nonce:n}}throw ky.logWithError("unable to find a viable program address nonce","params",{programId:i,marketId:e}),new Error("unable to find a viable program address nonce")}function Vr({programId:i}){let{publicKey:e}=te([Buffer.from("amm_config_account_seed","utf-8")],i);return e}function io({name:i,programId:e,marketId:t}){let{publicKey:n}=te([e.toBuffer(),t.toBuffer(),Buffer.from(i,"utf-8")],e);return n}function Ty({programId:i,marketId:e}){let{publicKey:t}=te([i.toBuffer(),e.toBuffer(),Buffer.from("open_order_associated_seed","utf-8")],i);return t}function Da({programId:i}){return te([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],i)}function qa({version:i,marketVersion:e,marketId:t,baseMint:n,quoteMint:o,baseDecimals:r,quoteDecimals:s,programId:a,marketProgramId:c}){let u=io({name:"amm_associated_seed",programId:a,marketId:t}),l=io({name:"lp_mint_associated_seed",programId:a,marketId:t}),{publicKey:d,nonce:m}=Da({programId:a}),p=io({name:"coin_vault_associated_seed",programId:a,marketId:t}),y=io({name:"pc_vault_associated_seed",programId:a,marketId:t}),f=io({name:"temp_lp_token_associated_seed",programId:a,marketId:t}),b=Ty({programId:a,marketId:t}),g=io({name:"target_associated_seed",programId:a,marketId:t}),w=io({name:"withdraw_associated_seed",programId:a,marketId:t}),{publicKey:k}=kl({programId:c,marketId:t});return{id:u,baseMint:n,quoteMint:o,lpMint:l,baseDecimals:r,quoteDecimals:s,lpDecimals:r,version:i,programId:a,authority:d,nonce:m,baseVault:p,quoteVault:y,lpVault:f,openOrders:b,targetOrders:g,withdrawQueue:w,marketVersion:e,marketProgramId:c,marketId:t,marketAuthority:k,lookupTableAccount:Bi.default,configId:Vr({programId:a})}}var Va;async function Ix({connection:i,poolKeysList:e,config:t}){return e.find(o=>o.modelDataAccount)&&(Va||(Va=new xo({connection:i}),await Va.initStableModelLayout())),await Promise.all(e.map(async o=>{if(o.modelDataAccount){let r=wl({poolKeys:o});return(await Qu(i,[r.instruction],"GetPoolData")).map(c=>{let u=zu(c,"GetPoolData"),l=new Ii(gn(u,"status")),d=Number(gn(u,"coin_decimals")),m=Number(gn(u,"pc_decimals")),p=Number(gn(u,"lp_decimals")),y=new Ii(gn(u,"pool_coin_amount")),f=new Ii(gn(u,"pool_pc_amount")),b=new Ii(gn(u,"pool_lp_supply")),g="0";try{g=gn(u,"pool_open_time")}catch{}return{status:l,baseDecimals:d,quoteDecimals:m,lpDecimals:p,baseReserve:y,quoteReserve:f,lpSupply:b,startTime:new Ii(g)}})[0]}else{let[r,s,a,c]=await i.getMultipleAccountsInfo([new Bi(o.id),new Bi(o.vault.A),new Bi(o.vault.B),new Bi(o.mintLp.address)]);if(r===null)throw Error("fetch pool error");if(s===null)throw Error("fetch vaultAccA error");if(a===null)throw Error("fetch vaultAccB error");if(c===null)throw Error("fetch mintAccLp error");let u=to.decode(r.data),l=Jt.decode(s.data),d=Jt.decode(a.data),m=ul.decode(c.data);return{status:u.status,baseDecimals:u.baseDecimal.toNumber(),quoteDecimals:u.quoteDecimal.toNumber(),lpDecimals:m.decimals,baseReserve:l.amount.sub(u.baseNeedTakePnl),quoteReserve:d.amount.sub(u.quoteNeedTakePnl),lpSupply:u.lpReserve,startTime:u.poolOpenTime}}}))}var Wa={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]},Wr=i=>{let e={},t=hy.toBase58();return Object.keys(i).map(n=>{let o=i[n],[r,s]=[o.baseMint.toBase58(),o.quoteMint.toBase58()];e[n]={id:n,version:4,status:o.status.toNumber(),programId:o.programId.toBase58(),mintA:gt({address:r,programId:t,decimals:o.baseDecimal.toNumber()}),mintB:gt({address:s,programId:t,decimals:o.quoteDecimal.toNumber()}),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:o.poolPrice.toNumber(),mintAmountA:new C(o.mintAAmount.toString()).div(10**o.baseDecimal.toNumber()).toNumber(),mintAmountB:new C(o.mintBAmount.toString()).div(10**o.quoteDecimal.toNumber()).toNumber(),baseReserve:o.baseReserve,quoteReserve:o.quoteReserve,feeRate:new C(o.tradeFeeNumerator.toString()).div(o.tradeFeeDenominator.toString()).toNumber(),openTime:o.poolOpenTime.toString(),tvl:0,day:Wa,week:Wa,month:Wa,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,type:"Standard",marketId:o.marketId.toBase58(),configId:Vr({programId:o.programId}).toBase58(),lpPrice:0,lpAmount:new C(o.lpReserve.toString()).div(10**Math.min(o.baseDecimal.toNumber(),o.quoteDecimal.toNumber())).toNumber(),lpMint:gt({address:o.lpMint.toBase58(),programId:t,decimals:Math.min(o.baseDecimal.toNumber(),o.quoteDecimal.toNumber())}),burnPercent:0}}),e};import We from"bn.js";import{PublicKey as xi}from"@solana/web3.js";import Si from"bn.js";import{TOKEN_PROGRAM_ID as Bl}from"@solana/spl-token";import{SystemProgram as ro,SYSVAR_RENT_PUBKEY as By,Transaction as hl,TransactionInstruction as xy}from"@solana/web3.js";import{createInitializeAccountInstruction as Tl,TOKEN_PROGRAM_ID as Il}from"@solana/spl-token";function Iy(i="accountFlags"){let e=new xr(i);return e.addBoolean("initialized"),e.addBoolean("market"),e.addBoolean("openOrders"),e.addBoolean("requestQueue"),e.addBoolean("eventQueue"),e.addBoolean("bids"),e.addBoolean("asks"),e}var Ua=N([ke(5),Iy("accountFlags"),L("ownAddress"),A("vaultSignerNonce"),L("baseMint"),L("quoteMint"),L("baseVault"),A("baseDepositsTotal"),A("baseFeesAccrued"),L("quoteVault"),A("quoteDepositsTotal"),A("quoteFeesAccrued"),A("quoteDustThreshold"),L("requestQueue"),L("eventQueue"),L("bids"),L("asks"),A("baseLotSize"),A("quoteLotSize"),A("feeRateBps"),A("referrerRebatesAccrued"),ke(7)]);function Sy({programId:i,marketInfo:e}){let t=N([F("version"),ut("instruction"),A("baseLotSize"),A("quoteLotSize"),Zt("feeRateBps"),A("vaultSignerNonce"),A("quoteDustThreshold")]),n=[{pubkey:e.id,isSigner:!1,isWritable:!0},{pubkey:e.requestQueue,isSigner:!1,isWritable:!0},{pubkey:e.eventQueue,isSigner:!1,isWritable:!0},{pubkey:e.bids,isSigner:!1,isWritable:!0},{pubkey:e.asks,isSigner:!1,isWritable:!0},{pubkey:e.baseVault,isSigner:!1,isWritable:!0},{pubkey:e.quoteVault,isSigner:!1,isWritable:!0},{pubkey:e.baseMint,isSigner:!1,isWritable:!1},{pubkey:e.quoteMint,isSigner:!1,isWritable:!1},{pubkey:e.authority?e.quoteMint:By,isSigner:!1,isWritable:!1}].concat(e.authority?{pubkey:e.authority,isSigner:!1,isWritable:!1}:[]).concat(e.authority&&e.pruneAuthority?{pubkey:e.pruneAuthority,isSigner:!1,isWritable:!1}:[]),o=Buffer.alloc(t.span);return t.encode({version:0,instruction:0,baseLotSize:e.baseLotSize,quoteLotSize:e.quoteLotSize,feeRateBps:e.feeRateBps,vaultSignerNonce:e.vaultSignerNonce,quoteDustThreshold:e.quoteDustThreshold},o),new xy({keys:n,programId:i,data:o})}async function Dr({connection:i,wallet:e,marketInfo:t}){let n=new hl,o=await i.getMinimumBalanceForRentExemption(165);n.add(ro.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.baseVault.seed,newAccountPubkey:t.baseVault.publicKey,lamports:o,space:165,programId:Il}),ro.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.quoteVault.seed,newAccountPubkey:t.quoteVault.publicKey,lamports:o,space:165,programId:Il}),Tl(t.baseVault.publicKey,t.baseMint,t.vaultOwner),Tl(t.quoteVault.publicKey,t.quoteMint,t.vaultOwner),ro.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.id.seed,newAccountPubkey:t.id.publicKey,lamports:await i.getMinimumBalanceForRentExemption(Ua.span),space:Ua.span,programId:t.programId}));let r=new hl;return r.add(ro.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.requestQueue.seed,newAccountPubkey:t.requestQueue.publicKey,lamports:t.lowestFeeMarket?6208320:await i.getMinimumBalanceForRentExemption(t.requestQueueSpace??5120+12),space:t.lowestFeeMarket?764:t.requestQueueSpace??5120+12,programId:t.programId}),ro.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.eventQueue.seed,newAccountPubkey:t.eventQueue.publicKey,lamports:t.lowestFeeMarket?79594560:await i.getMinimumBalanceForRentExemption(t.eventQueueSpace??262144+12),space:t.lowestFeeMarket?11308:t.eventQueueSpace??262144+12,programId:t.programId}),ro.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.bids.seed,newAccountPubkey:t.bids.publicKey,lamports:t.lowestFeeMarket?101977920:await i.getMinimumBalanceForRentExemption(t.orderbookQueueSpace??65536+12),space:t.lowestFeeMarket?14524:t.orderbookQueueSpace??65536+12,programId:t.programId}),ro.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.asks.seed,newAccountPubkey:t.asks.publicKey,lamports:t.lowestFeeMarket?101977920:await i.getMinimumBalanceForRentExemption(t.orderbookQueueSpace??65536+12),space:t.lowestFeeMarket?14524:t.orderbookQueueSpace??65536+12,programId:t.programId}),Sy({programId:t.programId,marketInfo:{id:t.id.publicKey,requestQueue:t.requestQueue.publicKey,eventQueue:t.eventQueue.publicKey,bids:t.bids.publicKey,asks:t.asks.publicKey,baseVault:t.baseVault.publicKey,quoteVault:t.quoteVault.publicKey,baseMint:t.baseMint,quoteMint:t.quoteMint,baseLotSize:t.baseLotSize,quoteLotSize:t.quoteLotSize,feeRateBps:t.feeRateBps,vaultSignerNonce:t.vaultSignerNonce,quoteDustThreshold:t.quoteDustThreshold}})),[{transaction:n,signer:[],instructionTypes:[V.CreateAccount,V.CreateAccount,V.InitAccount,V.InitAccount]},{transaction:r,signer:[],instructionTypes:[V.CreateAccount,V.CreateAccount,V.CreateAccount,V.CreateAccount,V.CreateAccount,V.InitMarket]}]}var Co=class extends Ne{async create({baseInfo:e,quoteInfo:t,lotSize:n,tickSize:o,dexProgramId:r,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u,assignSeed:l,txVersion:d,computeBudgetConfig:m,txTipConfig:p,feePayer:y}){let f=this.scope.ownerPubKey,b=l?`${e.mint.toBase58().slice(0,10)}-${t.mint.toBase58().slice(0,10)}-${l}`:void 0,g=Ue({fromPublicKey:f,programId:r,assignSeed:b&&`${b}-market`}),w=Ue({fromPublicKey:f,programId:r,assignSeed:b&&`${b}-request`}),k=Ue({fromPublicKey:f,programId:r,assignSeed:b&&`${b}-event`}),h=Ue({fromPublicKey:f,programId:r,assignSeed:b&&`${b}-bids`}),x=Ue({fromPublicKey:f,programId:r,assignSeed:b&&`${b}-asks`}),T=Ue({fromPublicKey:f,programId:Bl,assignSeed:b&&`${b}-baseVault`}),B=Ue({fromPublicKey:f,programId:Bl,assignSeed:b&&`${b}-quoteVault`}),S=0,I=new Si(100);function K(){let Z=new Si(0);for(;;)try{return{vaultOwner:xi.createProgramAddressSync([g.publicKey.toBuffer(),Z.toArrayLike(Buffer,"le",8)],r),vaultSignerNonce:Z}}catch{if(Z.iaddn(1),Z.gt(new Si(25555)))throw Error("find vault owner error")}}let{vaultOwner:O,vaultSignerNonce:v}=K(),_=new Si(Math.round(10**e.decimals*n)),D=new Si(Math.round(n*10**t.decimals*o));if(_.eq(ze))throw Error("lot size is too small");if(D.eq(ze))throw Error("tick size or lot size is too small");let q=await Dr({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:r,id:g,baseMint:e.mint,quoteMint:t.mint,baseVault:T,quoteVault:B,vaultOwner:O,requestQueue:w,eventQueue:k,bids:h,asks:x,feeRateBps:S,quoteDustThreshold:I,vaultSignerNonce:v,baseLotSize:_,quoteLotSize:D,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u}}),G=this.createTxBuilder(y);G.addInstruction({instructions:q[0].transaction.instructions,signers:q[0].signer});for await(let Z of q.slice(1,q.length))G.addInstruction({instructions:Z.transaction.instructions,signers:Z.signer,instructionTypes:Z.instructionTypes});return d===0?G.sizeCheckBuildV0({computeBudgetConfig:m,address:{marketId:g.publicKey,requestQueue:w.publicKey,eventQueue:k.publicKey,bids:h.publicKey,asks:x.publicKey,baseVault:T.publicKey,quoteVault:B.publicKey,baseMint:new xi(e.mint),quoteMint:new xi(t.mint)}}):G.sizeCheckBuild({computeBudgetConfig:m,address:{marketId:g.publicKey,requestQueue:w.publicKey,eventQueue:k.publicKey,bids:h.publicKey,asks:x.publicKey,baseVault:T.publicKey,quoteVault:B.publicKey,baseMint:new xi(e.mint),quoteMint:new xi(t.mint)}})}};var Ki=class extends Ne{stableLayout;constructor(e){super(e),this.stableLayout=new xo({connection:this.scope.connection})}async initLayout(){await this.stableLayout.initStableModelLayout()}async load(){this.checkDisabled()}computePairAmount({poolInfo:e,amount:t,slippage:n,baseIn:o}){let r=new We(new C(t).mul(10**e[o?"mintA":"mintB"].decimals).toFixed(0)),s=Er(e[o?"mintB":"mintA"]),[a,c]=[new We(new C(e.mintAmountA).mul(10**e.mintA.decimals).toString()),new We(new C(e.mintAmountB).mul(10**e.mintB.decimals).toString())],u=new We(new C(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,C.ROUND_DOWN));this.logDebug("baseReserve:",a.toString(),"quoteReserve:",c.toString()),this.logDebug("tokenIn:",o?e.mintA.symbol:e.mintB.symbol,"amountIn:",r.toString(),"anotherToken:",o?e.mintB.symbol:e.mintA.symbol,"slippage:",`${n.toSignificant()}%`,"baseReserve",a.toString(),"quoteReserve",c.toString());let l=o?"base":"quote";this.logDebug("input side:",l);let d=ze;r.isZero()||(d=l==="base"?sr(r.mul(c),a):sr(r.mul(a),c)),this.logDebug("amountRaw:",d.toString(),"lpAmount:",u.toString());let m=sr(r.mul(u),l==="base"?a:c);this.logDebug("liquidity:",m.toString());let p=new De(new We(1)).add(n),y=new De(new We(1)).sub(n),f=p.mul(d).quotient,b=y.mul(d).quotient,g=new Pe(s,d),w=new Pe(s,f),k=new Pe(s,b);return this.logDebug("anotherAmount:",g.toFixed(),"maxAnotherAmount:",w.toFixed()),{anotherAmount:g,maxAnotherAmount:w,minAnotherAmount:k,liquidity:m}}async getAmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async addLiquidity(e){let{poolInfo:t,poolKeys:n,amountInA:o,amountInB:r,otherAmountMin:s,fixedSide:a,config:c,txVersion:u,computeBudgetConfig:l,txTipConfig:d,feePayer:m}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),this.logDebug("amountInA:",o,"amountInB:",r),(o.isZero()||r.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:o.toFixed(),amountInB:r.toFixed()});let{account:p}=this.scope,{bypassAssociatedCheck:y,checkCreateATAOwner:f}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...c},[b,g]=[o.token,r.token],w=await p.getCreatedTokenAccount({mint:b.mint,associatedOnly:!1}),k=await p.getCreatedTokenAccount({mint:g.mint,associatedOnly:!1});!w&&!k&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",p.tokenAccounts);let h=await p.getCreatedTokenAccount({mint:new He(t.lpMint.address)}),x=[b,g],T=[w,k],B=[o.raw,r.raw],S=o.token.mint.toBase58()===t.mintA.address?"base":"quote",I="base";["quote","base"].includes(S)||this.logAndCreateError("invalid fixedSide","fixedSide",a),S==="quote"?(x.reverse(),T.reverse(),B.reverse(),I=a==="a"?"quote":"base"):S==="base"&&(I=a==="a"?"base":"quote");let[K,O]=x,[v,_]=T,[D,q]=B,G=n??await this.getAmmPoolKeys(t.id),Z=this.createTxBuilder(m),{tokenAccount:ie,...he}=await p.handleTokenAccount({side:"in",amount:D,mint:K.mint,tokenAccount:v,bypassAssociatedCheck:y,checkCreateATAOwner:f});Z.addInstruction(he);let{tokenAccount:re,...Ae}=await p.handleTokenAccount({side:"in",amount:q,mint:O.mint,tokenAccount:_,bypassAssociatedCheck:y,checkCreateATAOwner:f});Z.addInstruction(Ae);let{tokenAccount:lt,...mt}=await p.handleTokenAccount({side:"out",amount:0,mint:new He(t.lpMint.address),tokenAccount:h,bypassAssociatedCheck:y,checkCreateATAOwner:f});return Z.addInstruction(mt),Z.addInstruction({instructions:[Al({poolInfo:t,poolKeys:G,userKeys:{baseTokenAccount:ie,quoteTokenAccount:re,lpTokenAccount:lt,owner:this.scope.ownerPubKey},baseAmountIn:D,quoteAmountIn:q,otherAmountMin:s.raw,fixedSide:I})],instructionTypes:[t.pooltype.includes("StablePool")?V.AmmV5AddLiquidity:V.AmmV4AddLiquidity],lookupTableAddress:G.lookupTableAccount?[G.lookupTableAccount]:[]}),Z.addCustomComputeBudget(l),Z.addTipInstruction(d),u===0?await Z.buildV0():Z.build()}async removeLiquidity(e){this.scope.availability.removeStandardPosition===!1&&this.logAndCreateError("remove liquidity feature disabled in your region");let{poolInfo:t,poolKeys:n,lpAmount:o,baseAmountMin:r,quoteAmountMin:s,config:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:d}=e,m=n??await this.getAmmPoolKeys(t.id),[p,y,f]=[new He(t.mintA.address),new He(t.mintB.address),new He(t.lpMint.address)];this.logDebug("lpAmount:",o),this.logDebug("baseAmountMin:",r),this.logDebug("quoteAmountMin:",s),o.isZero()&&this.logAndCreateError("amount must greater than zero","lpAmount",o.toString());let{account:b}=this.scope,g=await b.getCreatedTokenAccount({mint:f,associatedOnly:!1});g||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",b.tokenAccounts);let w=await b.getCreatedTokenAccount({mint:p}),k=await b.getCreatedTokenAccount({mint:y}),h=this.createTxBuilder(d),{bypassAssociatedCheck:x,checkCreateATAOwner:T}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...a},{tokenAccount:B,...S}=await b.handleTokenAccount({side:"out",amount:0,mint:p,tokenAccount:w,bypassAssociatedCheck:x,checkCreateATAOwner:T});h.addInstruction(S);let{tokenAccount:I,...K}=await b.handleTokenAccount({side:"out",amount:0,mint:y,tokenAccount:k,bypassAssociatedCheck:x,checkCreateATAOwner:T});return h.addInstruction(K),h.addInstruction({instructions:[_a({poolInfo:t,poolKeys:m,userKeys:{lpTokenAccount:g,baseTokenAccount:B,quoteTokenAccount:I,owner:this.scope.ownerPubKey},lpAmount:o,baseAmountMin:r,quoteAmountMin:s})],lookupTableAddress:m.lookupTableAccount?[m.lookupTableAccount]:[],instructionTypes:[t.pooltype.includes("StablePool")?V.AmmV5RemoveLiquidity:V.AmmV4RemoveLiquidity]}),h.addCustomComputeBudget(u),h.addTipInstruction(l),c===0?await h.buildV0():h.build()}async removeAllLpAndCreateClmmPosition({poolInfo:e,clmmPoolInfo:t,removeLpAmount:n,createPositionInfo:o,farmInfo:r,userFarmLpAmount:s,base:a,computeBudgetConfig:c,payer:u,userAuxiliaryLedgers:l,tokenProgram:d=Wn,checkCreateATAOwner:m=!0,getEphemeralSigners:p,txVersion:y,feePayer:f}){if((this.scope.availability.removeStandardPosition===!1||this.scope.availability.createConcentratedPosition===!1)&&this.logAndCreateError("remove liquidity or create position feature disabled in your region"),!(e.mintA.address===t.mintA.address||e.mintA.address===t.mintB.address)||!(e.mintB.address===t.mintA.address||e.mintB.address===t.mintB.address))throw Error("mint check error");let b=this.createTxBuilder(f),g={};for(let G of this.scope.account.tokenAccountRawInfos)(g[G.accountInfo.mint.toString()]===void 0||$(this.scope.ownerPubKey,G.accountInfo.mint,Wn).publicKey.equals(G.pubkey))&&(g[G.accountInfo.mint.toString()]=G.pubkey);let w=g[e.lpMint.address];if(w===void 0)throw Error("find lp account error in trade accounts");let k=n.add(s??new We(0)),h=e.mintA.address===Te.WSOL.mint.toString(),x=e.mintB.address===Te.WSOL.mint.toString(),{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Wn,mint:new He(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:h?{payer:this.scope.ownerPubKey}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:!0,checkCreateATAOwner:m});if(b.addInstruction(B||{}),T===void 0)throw new Error("base token account not found");let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Wn,mint:new He(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:x?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:!0,checkCreateATAOwner:m});if(b.addInstruction(I||{}),S===void 0)throw new Error("quote token account not found");if(g[e.mintA.address]=T,g[e.mintB.address]=S,r!==void 0&&!s?.isZero()){let G=Et[r.programId],Z=yt({programId:new He(r.programId),poolId:new He(r.id),owner:this.scope.ownerPubKey,version:G}),ie,he=await this.scope.connection.getAccountInfo(Z);if(he&&(ie=Io(G).decode(he.data)),G!==6&&!ie){let{instruction:Lt,instructionType:tn}=ui({id:new He(r.id),programId:new He(r.programId),version:G,ledger:Z,owner:this.scope.ownerPubKey});b.addInstruction({instructions:[Lt],instructionTypes:[tn]})}let re=[];for(let Lt of r.rewardInfos){let tn=Lt.mint.address===Te.WSOL.mint.toString();if(g[Lt.mint.address])re.push(g[Lt.mint.address]);else{let{account:fn,instructionParams:dt}=await this.scope.account.getOrCreateTokenAccount({mint:new He(Lt.mint.address),tokenProgram:d,owner:this.scope.ownerPubKey,skipCloseAccount:!tn,createInfo:{payer:u||this.scope.ownerPubKey},associatedOnly:!0,checkCreateATAOwner:m});fn||this.logAndCreateError("farm reward account not found:",Lt.mint.address),dt&&b.addInstruction(dt),re.push(fn)}}let Ae=(await this.scope.api.fetchFarmKeysById({ids:r.id}))[0],lt={userAuxiliaryLedgers:l,amount:s,owner:this.scope.ownerPubKey,farmInfo:r,farmKeys:Ae,lpAccount:w,rewardAccounts:re},mt=Et[r.programId],et=mt===6?ci(lt):mt===5?li(lt):mi(lt),Tt={3:V.FarmV3Withdraw,5:V.FarmV5Withdraw,6:V.FarmV6Withdraw};b.addInstruction({instructions:[et],instructionTypes:[Tt[mt]]})}let K=await this.getAmmPoolKeys(e.id),O=_a({poolInfo:e,poolKeys:K,userKeys:{lpTokenAccount:w,baseTokenAccount:T,quoteTokenAccount:S,owner:this.scope.ownerPubKey},lpAmount:k,baseAmountMin:0,quoteAmountMin:0});b.addInstruction({instructions:[O],instructionTypes:[e.pooltype.includes("StablePool")?V.AmmV5RemoveLiquidity:V.AmmV4RemoveLiquidity],lookupTableAddress:K.lookupTableAccount?[K.lookupTableAccount]:[]});let[v,_]=e.mintA.address===t.mintA.address?[T,S]:[S,T],D=await this.scope.clmm.getClmmPoolKeys(t.id),q=await xe.openPositionFromBaseInstructions({poolInfo:t,poolKeys:D,ownerInfo:{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:v,tokenAccountB:_},withMetadata:"create",...o,base:a,getEphemeralSigners:p});return b.addInstruction({instructions:[...q.instructions],signers:q.signers,instructionTypes:[...q.instructionTypes],lookupTableAddress:D.lookupTableAccount?[D.lookupTableAccount]:[]}),y===0?b.sizeCheckBuildV0({computeBudgetConfig:c}):b.sizeCheckBuild({computeBudgetConfig:c})}async createPoolV4({programId:e,marketInfo:t,baseMintInfo:n,quoteMintInfo:o,baseAmount:r,quoteAmount:s,startTime:a,ownerInfo:c,associatedOnly:u=!1,checkCreateATAOwner:l=!1,tokenProgram:d,txVersion:m,feeDestinationId:p,computeBudgetConfig:y,txTipConfig:f,feePayer:b}){let g=c.feePayer||this.scope.owner?.publicKey,w=c.useSOLBalance&&n.mint.equals(qr),k=c.useSOLBalance&&o.mint.equals(qr),h=this.createTxBuilder(b),{account:x,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({mint:n.mint,owner:this.scope.ownerPubKey,createInfo:w?{payer:g,amount:r}:void 0,notUseTokenAccount:w,skipCloseAccount:!w,associatedOnly:w?!1:u,checkCreateATAOwner:l});h.addInstruction(T||{});let{account:B,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:o.mint,owner:this.scope.ownerPubKey,createInfo:k?{payer:g,amount:s}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:u,checkCreateATAOwner:l});if(h.addInstruction(S||{}),x===void 0||B===void 0)throw Error("you don't has some token account");let I=qa({version:4,marketVersion:3,marketId:t.marketId,baseMint:n.mint,quoteMint:o.mint,baseDecimals:n.decimals,quoteDecimals:o.decimals,programId:e,marketProgramId:t.programId}),K={programId:e,ammId:I.id,ammAuthority:I.authority,ammOpenOrders:I.openOrders,lpMint:I.lpMint,coinMint:I.baseMint,pcMint:I.quoteMint,coinVault:I.baseVault,pcVault:I.quoteVault,withdrawQueue:I.withdrawQueue,ammTargetOrders:I.targetOrders,poolTempLp:I.lpVault,marketProgramId:I.marketProgramId,marketId:I.marketId,ammConfigId:I.configId,feeDestinationId:p},{instruction:O,instructionType:v}=Fa({...K,userWallet:this.scope.ownerPubKey,userCoinVault:x,userPcVault:B,userLpVault:$(this.scope.ownerPubKey,I.lpMint,d).publicKey,nonce:I.nonce,openTime:a,coinAmount:r,pcAmount:s});return h.addInstruction({instructions:[O],instructionTypes:[v]}),h.addCustomComputeBudget(y),h.addTipInstruction(f),h.versionBuild({txVersion:m,extInfo:{address:K}})}async createMarketAndPoolV4({programId:e=Xo,marketProgram:t=Fs,feeDestinationId:n=Yu,tokenProgram:o,baseMintInfo:r,quoteMintInfo:s,baseAmount:a,quoteAmount:c,startTime:u,ownerInfo:l,lowestFeeMarket:d,assignSeed:m,associatedOnly:p=!1,checkCreateATAOwner:y=!1,lotSize:f=1,tickSize:b=.01,txVersion:g,computeBudgetConfig:w,txTipConfig:k,feePayer:h}){let x=this.scope.ownerPubKey,T=l.feePayer||this.scope.owner?.publicKey,B=l.useSOLBalance&&r.mint.equals(qr),S=l.useSOLBalance&&s.mint.equals(qr),I=m?`${r.mint.toBase58().slice(0,7)}-${s.mint.toBase58().slice(0,7)}-${m}`:void 0,K=Ue({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-market`}),O=Ue({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-request`}),v=Ue({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-event`}),_=Ue({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-bids`}),D=Ue({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-asks`}),q=Ue({fromPublicKey:x,programId:Wn,assignSeed:I&&`${I}-baseVault`}),G=Ue({fromPublicKey:x,programId:Wn,assignSeed:I&&`${I}-quoteVault`}),Z=0,ie=new We(100);function he(){let nn=new We(0);for(;;)try{return{vaultOwner:He.createProgramAddressSync([K.publicKey.toBuffer(),nn.toArrayLike(Buffer,"le",8)],t),vaultSignerNonce:nn}}catch{if(nn.iaddn(1),nn.gt(new We(25555)))throw Error("find vault owner error")}}let{vaultOwner:re,vaultSignerNonce:Ae}=he(),lt=new We(Math.round(10**r.decimals*f)),mt=new We(Math.round(f*10**s.decimals*b));if(lt.eq(ze))throw Error("lot size is too small");if(mt.eq(ze))throw Error("tick size or lot size is too small");let et=await Dr({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:t,vaultOwner:re,baseMint:r.mint,quoteMint:s.mint,id:K,baseVault:q,quoteVault:G,requestQueue:O,eventQueue:v,bids:_,asks:D,feeRateBps:Z,quoteDustThreshold:ie,vaultSignerNonce:Ae,baseLotSize:lt,quoteLotSize:mt,lowestFeeMarket:d}}),Tt=this.createTxBuilder(h);Tt.addInstruction({instructions:et[0].transaction.instructions,signers:et[0].signer});for await(let nn of et.slice(1,et.length))Tt.addInstruction({instructions:nn.transaction.instructions,signers:nn.signer,instructionTypes:nn.instructionTypes});let{account:Lt,instructionParams:tn}=await this.scope.account.getOrCreateTokenAccount({mint:r.mint,owner:this.scope.ownerPubKey,createInfo:B?{payer:T,amount:a}:void 0,notUseTokenAccount:B,skipCloseAccount:!B,associatedOnly:B?!1:p,checkCreateATAOwner:y,assignSeed:B&&I?`${I}-wsol`:void 0});Tt.addInstruction(tn||{});let{account:fn,instructionParams:dt}=await this.scope.account.getOrCreateTokenAccount({mint:s.mint,owner:this.scope.ownerPubKey,createInfo:S?{payer:T,amount:c}:void 0,notUseTokenAccount:S,skipCloseAccount:!S,associatedOnly:S?!1:p,checkCreateATAOwner:y,assignSeed:S&&I?`${I}-wsol`:void 0});if(Tt.addInstruction(dt||{}),Lt===void 0)throw Error("you don't has base token account");if(fn===void 0)throw Error("you don't has quote token account");let tt=qa({version:4,marketVersion:3,marketId:K.publicKey,baseMint:r.mint,quoteMint:s.mint,baseDecimals:r.decimals,quoteDecimals:s.decimals,programId:e,marketProgramId:t}),ls={programId:e,ammId:tt.id,ammAuthority:tt.authority,ammOpenOrders:tt.openOrders,lpMint:tt.lpMint,coinMint:tt.baseMint,pcMint:tt.quoteMint,coinVault:tt.baseVault,pcVault:tt.quoteVault,withdrawQueue:tt.withdrawQueue,ammTargetOrders:tt.targetOrders,poolTempLp:tt.lpVault,marketProgramId:tt.marketProgramId,marketId:tt.marketId,ammConfigId:tt.configId,feeDestinationId:n},{instruction:om,instructionType:im}=Fa({...ls,userWallet:this.scope.ownerPubKey,userCoinVault:Lt,userPcVault:fn,userLpVault:$(this.scope.ownerPubKey,tt.lpMint,o).publicKey,nonce:tt.nonce,openTime:u,coinAmount:a,pcAmount:c});Tt.addInstruction({instructions:[om],instructionTypes:[im]});let lu=B||S?[tn?.instructions?.[0]||dt?.instructions?.[0]].filter(nn=>!!nn):void 0;return g===0?Tt.sizeCheckBuildV0({computeBudgetConfig:w,splitIns:lu,address:{requestQueue:O.publicKey,eventQueue:v.publicKey,bids:_.publicKey,asks:D.publicKey,baseVault:q.publicKey,quoteVault:G.publicKey,baseMint:new He(r.mint),quoteMint:new He(s.mint),...ls}}):Tt.sizeCheckBuild({computeBudgetConfig:w,splitIns:lu,address:{requestQueue:O.publicKey,eventQueue:v.publicKey,bids:_.publicKey,asks:D.publicKey,baseVault:q.publicKey,quoteVault:G.publicKey,baseMint:new He(r.mint),quoteMint:new He(s.mint),...ls}})}async getCreatePoolFee({programId:e}){let t=Vr({programId:e}),n=await this.scope.connection.getAccountInfo(t,{dataSlice:{offset:536,length:8}});if(n===null)throw Error("get config account error");return ml.decode(n.data).fee}computeAmountOut({poolInfo:e,amountIn:t,mintIn:n,mintOut:o,slippage:r}){let[s,a]=[n.toString(),o.toString()];if(s!==e.mintA.address&&s!==e.mintB.address)throw new Error("toke not match");if(a!==e.mintA.address&&a!==e.mintB.address)throw new Error("toke not match");let{baseReserve:c,quoteReserve:u}=e,l=[c,u],d=[e.mintA.decimals,e.mintB.decimals],m=s==e.mintA.address?"base":"quote";m==="quote"&&(l.reverse(),d.reverse());let[p,y]=l,[f,b]=d,g=e.version===4,w;if(g)w=new C(y.toString()).div(10**b).div(new C(p.toString()).div(10**f));else{let v=bl(this.stableLayout.stableModelData,c.toNumber(),u.toNumber(),!1);m==="quote"?w=new C(1e6).div(v*1e6):w=new C(v*1e6).div(1e6)}let k=t,h=new We(0),x=new We(0);if(!k.isZero())if(g){x=zt(k.mul(La),_r);let v=k.sub(x),_=p.add(v);h=y.mul(v).div(_)}else{x=k.mul(new We(2)).div(new We(1e4));let v=k.sub(x);m==="quote"?h=new We(fl(this.stableLayout.stableModelData,u.toNumber(),c.toNumber(),v.toNumber())):h=new We(yl(this.stableLayout.stableModelData,u.toNumber(),c.toNumber(),v.toNumber()))}let T=new We(new C(h.toString()).mul(1-r).toFixed(0)),B=h,S=T,I=new C(h.toString()).div(new C(k.sub(x).toString()).toFixed(0));!k.isZero()&&!h.isZero()&&(I=new C(h.toString()).div(10**b).div(new C(k.sub(x).toString()).div(10**f)));let K=w.sub(I).div(w).mul(100);return{amountOut:B,minAmountOut:S,currentPrice:w,executionPrice:I,priceImpact:K,fee:x}}computeAmountIn({poolInfo:e,amountOut:t,mintIn:n,mintOut:o,slippage:r}){let{baseReserve:s,quoteReserve:a}=e;n.toString()!==e.mintA.address&&n.toString()!==e.mintB.address&&this.logAndCreateError("mintIn does not match pool"),o.toString()!==e.mintA.address&&o.toString()!==e.mintB.address&&this.logAndCreateError("mintOut does not match pool"),this.logDebug("baseReserve:",s.toString()),this.logDebug("quoteReserve:",a.toString());let c=n.toString()===e.mintA.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA];this.logDebug("currencyOut:",l.symbol||l.address),this.logDebug("amountOut:",new C(t.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString(),u.symbol||u.address),this.logDebug("slippage:",`${r*100}%`);let d=[s,a],m=c?"quote":"base";m==="base"&&d.reverse(),this.logDebug("output side:",m);let[p,y]=d,f=new C(y.toString()).div(10**e[c?"mintB":"mintA"].decimals).div(new C(p.toString()).div(10**e[c?"mintA":"mintB"].decimals));this.logDebug("currentPrice:",`1 ${u.symbol||u.address} \u2248 ${f.toString()} ${l.symbol||l.address}`),this.logDebug("currentPrice invert:",`1 ${l.symbol||l.address} \u2248 ${new C(1).div(f).toString()} ${u.symbol||u.address}`);let b=new We(0),g=t;if(!g.isZero()){g.gt(y)&&(g=y.sub(new We(1)));let S=y.sub(g);b=p.mul(g).div(S).mul(_r).div(_r.sub(La))}let w=new We(new C(b.toString()).mul(1+r).toFixed(0)),k=b,h=w;this.logDebug("amountIn:",new C(k.toString()).div(10**u.decimals).toDecimalPlaces(u.decimals).toString()),this.logDebug("maxAmountIn:",new C(h.toString()).div(10**u.decimals).toDecimalPlaces(u.decimals).toString());let x=null;!b.isZero()&&!g.isZero()&&(x=new C(g.toString()).div(10**l.decimals).div(new C(b.toString()).div(10**u.decimals)),this.logDebug("executionPrice:",`1 ${l.symbol||l.address} \u2248 ${x.toDecimalPlaces(Math.max(e.mintA.decimals,e.mintB.decimals)).toString()} ${u.symbol||u.address}`),this.logDebug("executionPrice invert:",`1 ${l.symbol||l.address} \u2248 ${new C(1).div(x).toDecimalPlaces(Math.max(e.mintA.decimals,e.mintB.decimals)).toString()} ${u.symbol||u.address}`));let T=f.mul(k.toString()),B=T.sub(t.toString()).abs().div(T);return this.logDebug("priceImpact:",`${B.toString()}%`),{amountIn:k,maxAmountIn:h,currentPrice:f,executionPrice:x,priceImpact:B}}async swap({poolInfo:e,poolKeys:t,amountIn:n,amountOut:o,inputMint:r,fixedSide:s,txVersion:a,config:c,computeBudgetConfig:u,txTipConfig:l,feePayer:d}){let m=this.createTxBuilder(d),{associatedOnly:p=!0,inputUseSolBalance:y=!0,outputUseSolBalance:f=!0}=c||{},[b,g]=r===e.mintA.address?[e.mintA,e.mintB]:[e.mintB,e.mintA],w=y&&b.address===j.toBase58(),k=f&&g.address===j.toBase58(),{account:h,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Wn,mint:new He(b.address),owner:this.scope.ownerPubKey,createInfo:w?{payer:this.scope.ownerPubKey,amount:n}:void 0,skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:p});m.addInstruction(x||{}),h||this.logAndCreateError("input token account not found",{token:b.symbol||b.address,tokenAccountIn:h,inputTokenUseSolBalance:w,associatedOnly:p});let{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Wn,mint:new He(g.address),owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:k?!1:p});m.addInstruction(B||{}),T===void 0&&this.logAndCreateError("output token account not found",{token:g.symbol||g.address,tokenAccountOut:T,outputTokenUseSolBalance:k,associatedOnly:p});let S=t||await this.getAmmPoolKeys(e.id),I=4;return e.pooltype.includes("StablePool")&&(I=5),m.addInstruction({instructions:[Fr({version:I,poolKeys:S,userKeys:{tokenAccountIn:h,tokenAccountOut:T,owner:this.scope.ownerPubKey},amountIn:n,amountOut:o,fixedSide:s})],instructionTypes:[I===4?V.AmmV4SwapBaseIn:V.AmmV5SwapBaseIn]}),m.addCustomComputeBudget(u),m.addTipInstruction(l),m.versionBuild({txVersion:a})}async getRpcPoolInfo(e){return(await this.getRpcPoolInfos([e]))[e]}async getRpcPoolInfos(e,t){let n=await Ke(this.scope.connection,e.map(u=>({pubkey:new He(u)})),t),o={},r=[];for(let u=0;u<e.length;u++){let l=n[u];if(l===null||!l.accountInfo)throw Error("fetch pool info error: "+String(e[u]));let d=to.decode(l.accountInfo.data);o[String(e[u])]={...d,programId:l.accountInfo.owner},r.push(d.baseVault,d.quoteVault)}let s={},a=await Ke(this.scope.connection,r.map(u=>({pubkey:new He(u)})),t);for(let u=0;u<r.length;u++){let l=a[u].accountInfo;if(l===null)throw Error("fetch vault info error: "+r[u]);s[String(r[u])]=new We(Ky.decode(l.data).amount.toString())}let c={};for(let[u,l]of Object.entries(o)){let d=s[l.baseVault.toString()].sub(l.baseNeedTakePnl),m=s[l.quoteVault.toString()].sub(l.quoteNeedTakePnl);c[u]={...l,baseReserve:d,mintAAmount:s[l.baseVault.toString()],mintBAmount:s[l.quoteVault.toString()],quoteReserve:m,poolPrice:new C(m.toString()).div(new C(10).pow(l.quoteDecimal.toString())).div(new C(d.toString()).div(new C(10).pow(l.baseDecimal.toString())))}}return c}async getPoolInfoFromRpc({poolId:e}){let t=await this.getRpcPoolInfo(e),n=Wr({[e]:t}),o=n[e],r=await this.scope.tradeV2.computePoolToPoolKeys({pools:[n[e]],ammRpcData:{[e]:t}});return{poolRpcData:t,poolInfo:o,poolKeys:r[0]}}};import{PublicKey as z}from"@solana/web3.js";import St from"bn.js";import{AccountLayout as xl,TOKEN_2022_PROGRAM_ID as Dn,TOKEN_PROGRAM_ID as Ci}from"@solana/spl-token";var Li=class extends Ne{constructor(e){super(e)}async getClmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async createPool(e){let{programId:t,owner:n=this.scope.owner?.publicKey||z.default,mint1:o,mint2:r,ammConfig:s,initialPrice:a,computeBudgetConfig:c,forerunCreate:u,getObserveState:l,txVersion:d,txTipConfig:m,feePayer:p}=e,y=this.createTxBuilder(p),[f,b,g]=new St(new z(o.address).toBuffer()).gt(new St(new z(r.address).toBuffer()))?[r,o,new C(1).div(a)]:[o,r,a],w=ne.priceToSqrtPriceX64(g,f.decimals,b.decimals),k=[],h=[];f.programId===Dn.toBase58()&&h.push(Ba(t,new z(f.address)).publicKey),b.programId===Dn.toBase58()&&h.push(Ba(t,new z(b.address)).publicKey),(await this.scope.connection.getMultipleAccountsInfo(h)).forEach((B,S)=>{B&&k.push(h[S])});let T=await xe.createPoolInstructions({connection:this.scope.connection,programId:t,owner:n,mintA:f,mintB:b,ammConfigId:s.id,initialPriceX64:w,forerunCreate:!l&&u,extendMintAccount:k});return y.addInstruction(T),y.addCustomComputeBudget(c),y.addTipInstruction(m),y.versionBuild({txVersion:d,extInfo:{address:{...T.address,observationId:T.address.observationId.toBase58(),exBitmapAccount:T.address.exBitmapAccount.toBase58(),programId:t.toString(),id:T.address.poolId.toString(),mintA:f,mintB:b,openTime:"0",vault:{A:T.address.mintAVault.toString(),B:T.address.mintBVault.toString()},rewardInfos:[],config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}},mockPoolInfo:{type:"Concentrated",rewardDefaultPoolInfos:"Clmm",id:T.address.poolId.toString(),mintA:f,mintB:b,feeRate:s.tradeFeeRate,openTime:"0",programId:t.toString(),price:g.toNumber(),config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]},burnPercent:0,...Xc},forerunCreate:u}})}async openPositionFromBase({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:r,base:s,baseAmount:a,otherAmountMax:c,nft2022:u,associatedOnly:l=!0,checkCreateATAOwner:d=!1,withMetadata:m="create",getEphemeralSigners:p,computeBudgetConfig:y,txTipConfig:f,txVersion:b,feePayer:g}){this.scope.availability.addConcentratedPosition===!1&&this.logAndCreateError("add position feature disabled in your region"),this.scope.checkOwner();let w=this.createTxBuilder(g),k=null,h=null,x=n.useSOLBalance&&e.mintA.address===j.toString(),T=n.useSOLBalance&&e.mintB.address===j.toString(),[B,S]=s==="MintA"?[a,c]:[c,a],{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new z(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:x||B.isZero()?{payer:this.scope.ownerPubKey,amount:B}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:x?!1:l,checkCreateATAOwner:d});I&&(k=I),w.addInstruction(K||{});let{account:O,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new z(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:T||S.isZero()?{payer:this.scope.ownerPubKey,amount:S}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:T?!1:l,checkCreateATAOwner:d});O&&(h=O),w.addInstruction(v||{}),(!k||!h)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",{ownerTokenAccountA:k?.toBase58(),ownerTokenAccountB:h?.toBase58()});let _=t||await this.getClmmPoolKeys(e.id),D=await xe.openPositionFromBaseInstructions({poolInfo:e,poolKeys:_,ownerInfo:{...n,feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:k,tokenAccountB:h},tickLower:o,tickUpper:r,base:s,baseAmount:a,otherAmountMax:c,withMetadata:m,getEphemeralSigners:p,nft2022:u});return w.addInstruction(D),w.addCustomComputeBudget(y),w.addTipInstruction(f),w.versionBuild({txVersion:b,extInfo:{...D.address}})}async openPositionFromLiquidity({poolInfo:e,poolKeys:t,ownerInfo:n,amountMaxA:o,amountMaxB:r,tickLower:s,tickUpper:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,withMetadata:d="create",txVersion:m,computeBudgetConfig:p,txTipConfig:y,getEphemeralSigners:f,nft2022:b,feePayer:g}){this.scope.availability.createConcentratedPosition===!1&&this.logAndCreateError("open position feature disabled in your region");let w=this.createTxBuilder(g),k=null,h=null,x=n.useSOLBalance&&e.mintA.address===j.toBase58(),T=n.useSOLBalance&&e.mintB.address===j.toBase58(),{account:B,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new z(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:x||o.isZero()?{payer:this.scope.ownerPubKey,amount:o}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:x?!1:u,checkCreateATAOwner:l});B&&(k=B),w.addInstruction(S||{});let{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new z(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:T||r.isZero()?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:T?!1:u,checkCreateATAOwner:l});I&&(h=I),w.addInstruction(K||{}),(k===void 0||h===void 0)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let O=t||await this.getClmmPoolKeys(e.id),v=await xe.openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:O,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:k,tokenAccountB:h},tickLower:s,tickUpper:a,liquidity:c,amountMaxA:o,amountMaxB:r,withMetadata:d,getEphemeralSigners:f,nft2022:b});return w.addInstruction(v),w.addCustomComputeBudget(p),w.addTipInstruction(y),w.versionBuild({txVersion:m,extInfo:{address:v.address}})}async increasePositionFromLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:o,amountMaxA:r,amountMaxB:s,liquidity:a,ownerInfo:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:d,txTipConfig:m,txVersion:p,feePayer:y}=e,f=this.createTxBuilder(y),b,g,w=c.useSOLBalance&&t.mintA.address===j.toString(),k=c.useSOLBalance&&t.mintB.address===j.toString(),{account:h,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,createInfo:w||r.isZero()?{payer:this.scope.ownerPubKey,amount:r}:void 0,skipCloseAccount:!w,associatedOnly:w?!1:u,checkCreateATAOwner:l});h&&(b=h),f.addInstruction(x||{});let{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:k||s.isZero()?{payer:this.scope.ownerPubKey,amount:s}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:u,checkCreateATAOwner:l});T&&(g=T),f.addInstruction(B||{}),!b&&!g&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let S=n??await this.getClmmPoolKeys(t.id),I=xe.increasePositionFromLiquidityInstructions({poolInfo:t,poolKeys:S,ownerPosition:o,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g},liquidity:a,amountMaxA:r,amountMaxB:s,nft2022:(await this.scope.connection.getAccountInfo(o.nftMint))?.owner.equals(Dn)});return f.addInstruction(I),f.addCustomComputeBudget(d),f.addTipInstruction(m),f.versionBuild({txVersion:p,extInfo:{address:I.address}})}async increasePositionFromBase(e){let{poolInfo:t,ownerPosition:n,base:o,baseAmount:r,otherAmountMax:s,ownerInfo:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:d,txVersion:m,feePayer:p}=e,y=this.createTxBuilder(p),f,b,g=a.useSOLBalance&&t.mintA.address===j.toString(),w=a.useSOLBalance&&t.mintB.address===j.toString(),{account:k,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:g||(o==="MintA"?r:s).isZero()?{payer:this.scope.ownerPubKey,amount:o==="MintA"?r:s}:void 0,skipCloseAccount:!g,associatedOnly:g?!1:c,checkCreateATAOwner:u});k&&(f=k),y.addInstruction(h||{});let{account:x,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:w||(o==="MintA"?s:r).isZero()?{payer:this.scope.ownerPubKey,amount:o==="MintA"?s:r}:void 0,notUseTokenAccount:w,skipCloseAccount:!w,associatedOnly:w?!1:c,checkCreateATAOwner:u});x&&(b=x),y.addInstruction(T||{}),!f&&!b&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let B=await this.getClmmPoolKeys(t.id),S=xe.increasePositionFromBaseInstructions({poolInfo:t,poolKeys:B,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:b},base:o,baseAmount:r,otherAmountMax:s,nft2022:(await this.scope.connection.getAccountInfo(n.nftMint))?.owner.equals(Dn)});return y.addInstruction(S),y.addCustomComputeBudget(l),y.addTipInstruction(d),y.versionBuild({txVersion:m,extInfo:{address:S.address}})}async decreaseLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:o,ownerInfo:r,amountMinA:s,amountMinB:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:d,txTipConfig:m,txVersion:p,feePayer:y}=e;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let f=this.createTxBuilder(y),b=r.useSOLBalance&&t.mintA.address===j.toString(),g=r.useSOLBalance&&t.mintB.address===j.toString(),w,k,{account:h,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:l});w=h,x&&f.addInstruction(x);let{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!g,associatedOnly:g?!1:u,checkCreateATAOwner:l});k=T,B&&f.addInstruction(B);let S=[];for(let _ of t.rewardDefaultInfos){let D=r.useSOLBalance&&_.mint.address===j.toString(),q;if(_.mint.address===t.mintA.address)q=w;else if(_.mint.address===t.mintB.address)q=k;else{let{account:G,instructionParams:Z}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(_.mint.programId),mint:new z(_.mint.address),notUseTokenAccount:D,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!D,associatedOnly:D?!1:u,checkCreateATAOwner:l});q=G,Z&&f.addInstruction(Z)}S.push(q)}!w&&!k&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccountRawInfos);let I=n??await this.getClmmPoolKeys(t.id),K=(await this.scope.connection.getAccountInfo(o.nftMint))?.owner.equals(Dn),O=await xe.decreaseLiquidityInstructions({poolInfo:t,poolKeys:I,ownerPosition:o,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:w,tokenAccountB:k,rewardAccounts:S},liquidity:c,amountMinA:s,amountMinB:a,nft2022:K});f.addInstruction({instructions:O.instructions,instructionTypes:[V.ClmmDecreasePosition]});let v={...O.address};if(r.closePosition){let _=await xe.closePositionInstructions({poolInfo:t,poolKeys:I,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:o,nft2022:K});f.addInstruction({endInstructions:_.instructions,endInstructionTypes:_.instructionTypes}),v={...v,..._.address}}return f.addCustomComputeBudget(d),f.addTipInstruction(m),f.versionBuild({txVersion:p,extInfo:{address:v}})}async lockPosition(e){let{programId:t=Po,authProgramId:n=Qo,poolProgramId:o=On,ownerPosition:r,payer:s,computeBudgetConfig:a,txTipConfig:c,txVersion:u,getEphemeralSigners:l,feePayer:d}=e,m=this.createTxBuilder(d),p=await xe.makeLockPositions({programId:t,authProgramId:n,poolProgramId:o,wallet:this.scope.ownerPubKey,payer:s??this.scope.ownerPubKey,nftMint:r.nftMint,getEphemeralSigners:l,nft2022:(await this.scope.connection.getAccountInfo(r.nftMint))?.owner.equals(Dn)});return m.addInstruction(p),m.addCustomComputeBudget(a),m.addTipInstruction(c),m.versionBuild({txVersion:u,extInfo:p.address})}async harvestLockPosition(e){let{programId:t=Po,authProgramId:n=Qo,clmmProgram:o=On,poolKeys:r,lockData:s,ownerInfo:a={useSOLBalance:!0},associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:d,txVersion:m,feePayer:p}=e,y=r||await this.getClmmPoolKeys(s.poolId.toString()),f=this.createTxBuilder(p),b=await this.scope.connection.getAccountInfo(s.positionId);b||this.logger.logWithError("position not found",s.positionId);let g=ki.decode(b.data),w=a.useSOLBalance&&y.mintA.address===j.toString(),k=a.useSOLBalance&&y.mintB.address===j.toString(),h,x,{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.mintA.programId,mint:new z(y.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!w,associatedOnly:w?!1:c,checkCreateATAOwner:u});h=T,B&&f.addInstruction(B);let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.mintB.programId,mint:new z(y.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!k,associatedOnly:k?!1:c,checkCreateATAOwner:u});x=S,I&&f.addInstruction(I);let K={},O=[];for(let Ae of y.rewardInfos){let lt=a.useSOLBalance&&Ae.mint.address===j.toString(),mt=K[Ae.mint.address];if(!mt){let{account:et,instructionParams:Tt}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(Ae.mint.programId),mint:new z(Ae.mint.address),notUseTokenAccount:lt,owner:this.scope.ownerPubKey,skipCloseAccount:!lt,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:lt?!1:c});mt=et,Tt&&f.addInstruction(Tt)}K[Ae.mint.address]=mt,O.push(mt)}let v=gi(t,s.lockNftMint).publicKey,_=$(this.scope.ownerPubKey,s.lockNftMint,Ci).publicKey,D=H.getTickArrayStartIndexByTick(g.tickLower,y.config.tickSpacing),q=H.getTickArrayStartIndexByTick(g.tickUpper,y.config.tickSpacing),{publicKey:G}=ye(new z(y.programId),s.poolId,D),{publicKey:Z}=ye(new z(y.programId),s.poolId,q),{publicKey:ie}=en(new z(y.programId),s.poolId,g.tickLower,g.tickUpper),he=[];for(let Ae=0;Ae<y.rewardInfos.length;Ae++)he.push({poolRewardVault:new z(y.rewardInfos[Ae].vault),ownerRewardVault:O[Ae],rewardMint:new z(y.rewardInfos[Ae].mint.address)});let re=await xe.harvestLockPositionInstructionV2({programId:t,auth:n,lockPositionId:v,clmmProgram:o,lockOwner:this.scope.ownerPubKey,lockNftMint:s.lockNftMint,lockNftAccount:_,positionNftAccount:s.nftAccount,positionId:s.positionId,poolId:s.poolId,protocolPosition:ie,vaultA:new z(y.vault.A),vaultB:new z(y.vault.B),tickArrayLower:G,tickArrayUpper:Z,userVaultA:h,userVaultB:x,mintA:new z(y.mintA.address),mintB:new z(y.mintB.address),rewardAccounts:he,exTickArrayBitmap:Ge(o,s.poolId).publicKey});return f.addInstruction({instructions:[re],instructionTypes:[V.ClmmHarvestLockPosition]}),f.addCustomComputeBudget(l),f.addTipInstruction(d),f.versionBuild({txVersion:m})}async closePosition({poolInfo:e,poolKeys:t,ownerPosition:n,txVersion:o,computeBudgetConfig:r,txTipConfig:s,feePayer:a}){this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let c=this.createTxBuilder(a),u=t??await this.getClmmPoolKeys(e.id),l=xe.closePositionInstructions({poolInfo:e,poolKeys:u,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:n,nft2022:(await this.scope.connection.getAccountInfo(n.nftMint))?.owner.equals(Dn)});return c.addCustomComputeBudget(r),c.addTipInstruction(s),c.addInstruction(l).versionBuild({txVersion:o,extInfo:{address:l.address}})}async initReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:o=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txVersion:a,feePayer:c}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(c),l=t.useSOLBalance&&n.mint.address.toString()===j.toString(),d=n.perSecond.mul(n.endTime-n.openTime),{account:m,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(n.mint.address),mint:new z(n.mint.address),notUseTokenAccount:!!l,skipCloseAccount:!l,owner:this.scope.ownerPubKey,createInfo:l?{payer:t.feePayer||this.scope.ownerPubKey,amount:new St(new C(d.toFixed(0)).gte(d)?d.toFixed(0):d.add(1).toFixed(0))}:void 0,associatedOnly:l?!1:o,checkCreateATAOwner:r});p&&u.addInstruction(p),m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let y=await this.getClmmPoolKeys(e.id),f=xe.initRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardInfo:{programId:new z(n.mint.programId),mint:new z(n.mint.address),openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ae.decimalToX64(n.perSecond)}});return u.addInstruction(f),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:f.address}})}async initRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:o,associatedOnly:r=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){for(let p of o)p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let d=this.createTxBuilder(l),m={};for(let p of o){let y=n.useSOLBalance&&p.mint.address===j.toString(),f=p.perSecond.mul(p.endTime-p.openTime),{account:b,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(p.mint.programId),mint:new z(p.mint.address),notUseTokenAccount:!!y,skipCloseAccount:!y,owner:this.scope.ownerPubKey,createInfo:y?{payer:n.feePayer||this.scope.ownerPubKey,amount:new St(new C(f.toFixed(0)).gte(f)?f.toFixed(0):f.add(1).toFixed(0))}:void 0,associatedOnly:y?!1:r,checkCreateATAOwner:s});g&&d.addInstruction(g),b||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let w=t??await this.getClmmPoolKeys(e.id),k=xe.initRewardInstructions({poolInfo:e,poolKeys:w,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:b},rewardInfo:{programId:new z(p.mint.programId),mint:new z(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:ae.decimalToX64(p.perSecond)}});m={...m,...k.address},d.addInstruction(k)}return d.addCustomComputeBudget(a),d.addTipInstruction(c),d.versionBuild({txVersion:u,extInfo:{address:m}})}async setReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:o=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let l=this.createTxBuilder(u),d=t.useSOLBalance&&n.mint.equals(j),{account:m,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n.programId,mint:n.mint,notUseTokenAccount:d,owner:this.scope.ownerPubKey,createInfo:d?{payer:t.feePayer||this.scope.ownerPubKey,amount:new St(new C(n.perSecond.mul(n.endTime-n.openTime).toFixed(0)).gte(n.perSecond.mul(n.endTime-n.openTime))?n.perSecond.mul(n.endTime-n.openTime).toFixed(0):n.perSecond.mul(n.endTime-n.openTime).add(1).toFixed(0))}:void 0,associatedOnly:d?!1:o,checkCreateATAOwner:r});p&&l.addInstruction(p),m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let y=await this.getClmmPoolKeys(e.id),f=xe.setRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardInfo:{mint:n.mint,openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ae.decimalToX64(n.perSecond)}});return l.addInstruction(f),l.addCustomComputeBudget(s),l.addTipInstruction(a),l.versionBuild({txVersion:c,extInfo:{address:f.address}})}async setRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:o,associatedOnly:r=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){let d=this.createTxBuilder(l),m={};for(let p of o){p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let y=n.useSOLBalance&&p.mint.address===j.toString(),{account:f,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(p.mint.programId),mint:new z(p.mint.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:y?{payer:n.feePayer||this.scope.ownerPubKey,amount:new St(new C(p.perSecond.mul(p.endTime-p.openTime).toFixed(0)).gte(p.perSecond.mul(p.endTime-p.openTime))?p.perSecond.mul(p.endTime-p.openTime).toFixed(0):p.perSecond.mul(p.endTime-p.openTime).add(1).toFixed(0))}:void 0,associatedOnly:y?!1:r,checkCreateATAOwner:s});b&&d.addInstruction(b),f||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let g=t??await this.getClmmPoolKeys(e.id),w=xe.setRewardInstructions({poolInfo:e,poolKeys:g,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:f},rewardInfo:{mint:new z(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:ae.decimalToX64(p.perSecond)}});d.addInstruction(w),m={...m,...w.address}}return d.addCustomComputeBudget(a),d.addTipInstruction(c),d.versionBuild({txVersion:u,extInfo:{address:m}})}async collectReward({poolInfo:e,ownerInfo:t,rewardMint:n,associatedOnly:o=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){let l=e.rewardDefaultInfos.find(g=>g.mint.address===n.toString());l||this.logAndCreateError("reward mint error","not found reward mint",n);let d=this.createTxBuilder(u),m=t.useSOLBalance&&n.equals(j),{account:p,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(l.mint.programId),mint:n,notUseTokenAccount:m,owner:this.scope.ownerPubKey,skipCloseAccount:!m,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:m?!1:o,checkCreateATAOwner:r});y&&d.addInstruction(y),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=await this.getClmmPoolKeys(e.id),b=xe.collectRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardMint:n});return d.addInstruction(b),d.addCustomComputeBudget(s),d.addTipInstruction(a),d.versionBuild({txVersion:c,extInfo:{address:b.address}})}async collectRewards({poolInfo:e,ownerInfo:t,rewardMints:n,associatedOnly:o=!0,checkCreateATAOwner:r=!1,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l={};for(let d of n){let m=e.rewardDefaultInfos.find(w=>w.mint.address===d.toString());if(!m){this.logAndCreateError("reward mint error","not found reward mint",d);continue}let p=t.useSOLBalance&&d.equals(j),{account:y,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(m.mint.programId),mint:d,notUseTokenAccount:p,owner:this.scope.ownerPubKey,skipCloseAccount:!p,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:p?!1:o,checkCreateATAOwner:r});y||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos),f&&u.addInstruction(f);let b=await this.getClmmPoolKeys(e.id),g=xe.collectRewardInstructions({poolInfo:e,poolKeys:b,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:y},rewardMint:d});u.addInstruction(g),l={...l,...g.address}}return u.addCustomComputeBudget(s),u.addTipInstruction(a),u.build({address:l})}async swap({poolInfo:e,poolKeys:t,inputMint:n,amountIn:o,amountOutMin:r,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:d=!1,txVersion:m,computeBudgetConfig:p,txTipConfig:y,feePayer:f}){let b=this.createTxBuilder(f),g=n.toString()===e.mintA.address,w=c.useSOLBalance&&e.mintA.address===j.toBase58(),k=c.useSOLBalance&&e.mintB.address===j.toBase58(),h;!s||s.equals(new C(0))?h=g?Ft.add(new St(1)):Vt.sub(new St(1)):h=ne.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let x;if(!x){let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new z(e.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,skipCloseAccount:!w,createInfo:w||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?o:0}:void 0,associatedOnly:w?!1:l,checkCreateATAOwner:d});x=S,I&&b.addInstruction(I)}let T;if(!T){let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new z(e.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,skipCloseAccount:!k,createInfo:k||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:o}:void 0,associatedOnly:k?!1:l,checkCreateATAOwner:d});T=S,I&&b.addInstruction(I)}(!x||!T)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:x,ownerTokenAccountB:T,mintAUseSOLBalance:w,mintBUseSOLBalance:k,associatedOnly:l});let B=t??await this.getClmmPoolKeys(e.id);return b.addInstruction(xe.makeSwapBaseInInstructions({poolInfo:e,poolKeys:B,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:x,tokenAccountB:T},inputMint:new z(n),amountIn:o,amountOutMin:r,sqrtPriceLimitX64:h,remainingAccounts:u})),b.addCustomComputeBudget(p),b.addTipInstruction(y),b.versionBuild({txVersion:m})}async swapBaseOut({poolInfo:e,poolKeys:t,outputMint:n,amountOut:o,amountInMax:r,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:d=!1,txVersion:m,computeBudgetConfig:p,txTipConfig:y,feePayer:f}){let b=this.createTxBuilder(f),g=n.toString()===e.mintB.address,w=c.useSOLBalance&&e.mintA.address===j.toBase58(),k=c.useSOLBalance&&e.mintB.address===j.toBase58(),h;!s||s.equals(new C(0))?h=n.toString()===e.mintB.address?Ft.add(new St(1)):Vt.sub(new St(1)):h=ne.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let x;if(!x){let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new z(e.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,skipCloseAccount:!w,createInfo:w||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?r:0}:void 0,associatedOnly:w?!1:l,checkCreateATAOwner:d});x=S,I&&b.addInstruction(I)}let T;if(!T){let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new z(e.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,skipCloseAccount:!k,createInfo:k||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:r}:void 0,associatedOnly:k?!1:l,checkCreateATAOwner:d});T=S,I&&b.addInstruction(I)}(!x||!T)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:x,ownerTokenAccountB:T,mintAUseSOLBalance:w,mintBUseSOLBalance:k,associatedOnly:l});let B=t??await this.getClmmPoolKeys(e.id);return b.addInstruction(xe.makeSwapBaseOutInstructions({poolInfo:e,poolKeys:B,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:x,tokenAccountB:T},outputMint:new z(n),amountOut:o,amountInMax:r,sqrtPriceLimitX64:h,remainingAccounts:u})),b.addCustomComputeBudget(p),b.addTipInstruction(y),b.versionBuild({txVersion:m})}async harvestAllRewards({allPoolInfo:e,allPositions:t,lockInfo:n,ownerInfo:o,associatedOnly:r=!0,checkCreateATAOwner:s=!1,programId:a,txVersion:c,computeBudgetConfig:u,feePayer:l}){let d={};for(let b of this.scope.account.tokenAccountRawInfos)r?$(this.scope.ownerPubKey,b.accountInfo.mint,a).publicKey.equals(b.pubkey)&&(d[b.accountInfo.mint.toString()]=b.pubkey):d[b.accountInfo.mint.toString()]=b.pubkey;let m=Object.values(t).flat().map(b=>b.nftMint),p=await Ke(this.scope.connection,m.map(b=>({pubkey:b}))),y={};p.forEach(b=>{y[b.pubkey.toBase58()]=b?.accountInfo?.owner??null});let f=this.createTxBuilder(l);for(let b of Object.values(e)){if(t[b.id]===void 0||!t[b.id].find(I=>!I.liquidity.isZero()||I.rewardInfos.find(K=>!K.rewardAmountOwed.isZero())))continue;let g=b,w=o.useSOLBalance&&g.mintA.address===j.toString(),k=o.useSOLBalance&&g.mintB.address===j.toString(),h=d[g.mintA.address];if(!h){let{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:g.mintA.programId,mint:new z(g.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,skipCloseAccount:!w,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:w?!1:r,checkCreateATAOwner:s});h=I,K&&f.addInstruction(K)}let x=d[g.mintB.address];if(!x){let{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:g.mintB.programId,mint:new z(g.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,skipCloseAccount:!k,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:k?!1:r,checkCreateATAOwner:s});x=I,K&&f.addInstruction(K)}d[g.mintA.address]=h,d[g.mintB.address]=x;let T=[];for(let I of g.rewardDefaultInfos){let K=o.useSOLBalance&&I.mint.address===j.toString(),O=d[I.mint.address];if(!O){let{account:v,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(I.mint.programId),mint:new z(I.mint.address),notUseTokenAccount:K,owner:this.scope.ownerPubKey,skipCloseAccount:!K,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:K?!1:r});O=v,_&&f.addInstruction(_)}d[I.mint.address]=O,T.push(O)}let B=await this.getClmmPoolKeys(g.id),S=[];for(let I=0;I<B.rewardInfos.length;I++)S.push({poolRewardVault:new z(B.rewardInfos[I].vault),ownerRewardVault:T[I],rewardMint:new z(B.rewardInfos[I].mint.address)});for(let I of t[b.id]){let K=n?.[b.id]?.[I.nftMint.toBase58()];if(K){let O=$(this.scope.ownerPubKey,K.lockNftMint,Ci).publicKey,v=H.getTickArrayStartIndexByTick(I.tickLower,B.config.tickSpacing),_=H.getTickArrayStartIndexByTick(I.tickUpper,B.config.tickSpacing),{publicKey:D}=ye(new z(B.programId),K.poolId,v),{publicKey:q}=ye(new z(B.programId),K.poolId,_),{publicKey:G}=en(new z(B.programId),K.poolId,I.tickLower,I.tickUpper),Z=gi(Po,K.lockNftMint).publicKey,ie=xe.harvestLockPositionInstructionV2({programId:Po,auth:Qo,lockPositionId:Z,clmmProgram:On,lockOwner:this.scope.ownerPubKey,lockNftMint:K.lockNftMint,lockNftAccount:O,positionNftAccount:K.nftAccount,positionId:K.positionId,poolId:K.poolId,protocolPosition:G,vaultA:new z(B.vault.A),vaultB:new z(B.vault.B),tickArrayLower:D,tickArrayUpper:q,userVaultA:h,userVaultB:x,mintA:new z(B.mintA.address),mintB:new z(B.mintB.address),rewardAccounts:S,exTickArrayBitmap:Ge(On,K.poolId).publicKey});f.addInstruction({instructions:[ie],instructionTypes:[V.ClmmHarvestLockPosition],lookupTableAddress:B.lookupTableAccount?[B.lookupTableAccount]:[]})}else{let O=xe.decreaseLiquidityInstructions({poolInfo:g,poolKeys:B,ownerPosition:I,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:h,tokenAccountB:x,rewardAccounts:T},liquidity:new St(0),amountMinA:new St(0),amountMinB:new St(0),nft2022:y[I.nftMint.toBase58()]?.equals(Dn)});f.addInstruction(O)}}}return c===0?f.sizeCheckBuildV0({computeBudgetConfig:u}):f.sizeCheckBuild({computeBudgetConfig:u})}async getWhiteListMint({programId:e}){let t=await this.scope.connection.getAccountInfo(bi(e).publicKey);return t?il.decode(t.data).whitelistMints.filter(o=>!o.equals(z.default)):[]}async getOwnerPositionInfo({programId:e}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(s=>s.accountInfo.amount.eq(new St(1))).map(s=>ht(new z(e),s.accountInfo.mint).publicKey),o=await this.scope.connection.getMultipleAccountsInfo(n),r=[];return o.forEach(s=>{if(!s)return;let a=ki.decode(s.data);r.push(a)}),r}async getRpcClmmPoolInfo({poolId:e}){return(await this.getRpcClmmPoolInfos({poolIds:[e]}))[String(e)]}async getRpcClmmPoolInfos({poolIds:e,config:t}){let n=await Ke(this.scope.connection,e.map(r=>({pubkey:new z(r)})),t),o={};for(let r=0;r<e.length;r++){let s=n[r];if(s===null||!s.accountInfo)throw Error("fetch pool info error: "+String(e[r]));let a=Jn.decode(s.accountInfo.data),c=ne.sqrtPriceX64ToPrice(a.sqrtPriceX64,a.mintDecimalsA,a.mintDecimalsB).toNumber();o[String(e[r])]={...a,currentPrice:c,programId:s.accountInfo.owner}}return o}async getComputeClmmPoolInfos({clmmPoolsRpcInfo:e,mintInfos:t}){let n=new Set(Object.keys(e).map(c=>e[c].ammConfig.toBase58())),o=await Ke(this.scope.connection,Array.from(n).map(c=>({pubkey:new z(c)}))),r={};o.forEach(c=>{!c.accountInfo||(r[c.pubkey.toBase58()]=nl.decode(c.accountInfo.data))});let s=await Le.fetchComputeMultipleClmmInfo({connection:this.scope.connection,rpcDataMap:e,poolList:Object.keys(e).map(c=>{let[u,l]=[e[c].mintA.toBase58(),e[c].mintB.toBase58()];return{id:c,programId:e[c].programId.toBase58(),mintA:gt({address:u,decimals:e[c].mintDecimalsA,programId:t[u].programId.toBase58()||Ci.toBase58(),extensions:{feeConfig:t[u]?.feeConfig?Vn(t[u]?.feeConfig):void 0}}),mintB:gt({address:l,decimals:e[c].mintDecimalsB,programId:t[l].programId.toBase58()||Ci.toBase58(),extensions:{feeConfig:t[l]?.feeConfig?Vn(t[l]?.feeConfig):void 0}}),price:e[c].currentPrice,config:{...r[e[c].ammConfig.toBase58()],id:e[c].ammConfig.toBase58(),fundFeeRate:0,description:"",defaultRange:0,defaultRangePoint:[]}}})}),a=await Le.fetchMultiplePoolTickArrays({connection:this.scope.connection,poolKeys:Object.values(s)});return{computeClmmPoolInfo:s,computePoolTickData:a}}async getPoolInfoFromRpc(e){let t=await this.getRpcClmmPoolInfo({poolId:e}),n=new Set([t.mintA.toBase58(),t.mintB.toBase58()]),o=await mo({connection:this.scope.connection,mints:Array.from(n).map(l=>new z(l))}),{computeClmmPoolInfo:r,computePoolTickData:s}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:{[e]:t},mintInfos:o}),a=await Ke(this.scope.connection,[{pubkey:t.vaultA},{pubkey:t.vaultB}]),c=el(r[e]);if(!a[0].accountInfo||!a[1].accountInfo)throw new Error("pool vault data not found");c.mintAmountA=Number(xl.decode(a[0].accountInfo.data).amount.toString()),c.mintAmountB=Number(xl.decode(a[1].accountInfo?.data).amount.toString());let u={...r[e],exBitmapAccount:r[e].exBitmapAccount.toBase58(),observationId:r[e].observationId.toBase58(),id:e,programId:t.programId.toBase58(),openTime:t.startTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},config:c.config,rewardInfos:r[e].rewardInfos.filter(l=>!l.tokenVault.equals(z.default)).map(l=>({mint:gt({address:l.tokenMint.toBase58(),programId:Ci.toBase58(),decimals:10}),vault:l.tokenVault.toBase58()}))};return{poolInfo:c,poolKeys:u,computePoolInfo:r[e],tickData:s}}};import{PublicKey as Q}from"@solana/web3.js";import{AccountLayout as Ha,createAssociatedTokenAccountIdempotentInstruction as _l,getAssociatedTokenAddressSync as Fl,NATIVE_MINT as No,TOKEN_PROGRAM_ID as Mt}from"@solana/spl-token";import Ga from"bn.js";import Qr from"decimal.js-light";import Ri from"bn.js";function Ur(i,e){if(e.isZero())throw Error("divisor is zero");return i.mod(e)}function Cy(i,e){if(e.isZero())throw Error("rhs is zero");let t=i.div(e);if(t.isZero())throw Error("quotient is zero");let n=Ur(i,e);return n.gt(Lo)&&(t=t.add(new Ri(1)),e=i.div(t),n=Ur(i,t),n.gt(Lo)&&(e=e.add(new Ri(1)))),[t,e]}var Lo=new Ri(0),Gr=class{static swapWithoutFees(e,t,n){let o=t.mul(n),r=t.add(e),[s]=Cy(o,r),a=n.sub(s);if(a.isZero())throw Error("destinationAmountSwapped is zero");return{destinationAmountSwapped:a}}static lpTokensToTradingTokens(e,t,n,o,r){let s=e.mul(n).div(t),a=e.mul(o).div(t);if(r===0)return{tokenAmount0:s,tokenAmount1:a};if(r===1)return Ur(e.mul(n),t).gt(Lo)&&s.gt(Lo)&&(s=s.add(new Ri(1))),Ur(e.mul(o),t).gt(Lo)&&a.gt(Lo)&&(a=a.add(new Ri(1))),{tokenAmount0:s,tokenAmount1:a};throw Error("roundDirection value error")}};var Xr=class{static tradingFee(e,t){return ar(e,t,jt)}static protocolFee(e,t){return vs(e,t,jt)}static fundFee(e,t){return vs(e,t,jt)}};var Sl=(t=>(t[t.Floor=0]="Floor",t[t.Ceiling=1]="Ceiling",t))(Sl||{}),zr=class{static validate_supply(e,t){if(e.isZero())throw Error("tokenAmount0 is zero");if(t.isZero())throw Error("tokenAmount1 is zero")}static swap(e,t,n,o){let r=Xr.tradingFee(e,o),s=e.sub(r),{destinationAmountSwapped:a}=Gr.swapWithoutFees(s,t,n);return{newSwapDestinationAmount:n.sub(a),sourceAmountSwapped:e,destinationAmountSwapped:a,tradeFee:r}}static swapBaseOut({poolMintA:e,poolMintB:t,tradeFeeRate:n,baseReserve:o,quoteReserve:r,outputMint:s,outputAmount:a}){let[c,u,l,d,m]=t.address===s.toString()?[o,r,e.decimals,t.decimals,e.address]:[r,o,t.decimals,e.decimals,t.address],p=new Qr(u.toString()).div(10**d).div(new Qr(c.toString()).div(10**l)),y=a.gte(u)?u.sub(new Ga(1)):a,f=u.sub(y),b=zt(c.mul(y),f),g=zt(b.mul(new Ga(1e6)),new Ga(1e6).sub(n)),w=g.sub(b),k=new Qr(y.toString()).div(10**d).div(new Qr(g.toString()).div(10**l)),h=p.isZero()?0:k.sub(p).div(p).abs().toNumber();return{amountRealOut:y,amountIn:g,amountInWithoutFee:b,tradeFee:w,priceImpact:h}}};import Fe from"bn.js";import{PublicKey as Oi,TransactionInstruction as so,Keypair as Vy,SystemProgram as Wy}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Ll,TOKEN_2022_PROGRAM_ID as Qa,TOKEN_PROGRAM_ID as qn}from"@solana/spl-token";var Ly=Buffer.from("vault_and_lp_mint_auth_seed","utf8"),Ry=Buffer.from("amm_config","utf8"),Ny=Buffer.from("pool","utf8"),Oy=Buffer.from("pool_lp_mint","utf8"),vy=Buffer.from("pool_vault","utf8"),My=Buffer.from("observation","utf8");function Ro(i){return te([Ly],i)}function TK(i,e){return te([Ry,_y(e)],i)}function Xa(i,e,t,n){return te([Ny,e.toBuffer(),t.toBuffer(),n.toBuffer()],i)}function Ey(i,e){return te([Oy,e.toBuffer()],i)}function Kl(i,e,t){return te([vy,e.toBuffer(),t.toBuffer()],i)}function Ni(i,e){return te([My,e.toBuffer()],i)}function _y(i){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,i,!1),new Uint8Array(e)}function Cl({poolId:i,programId:e,configId:t,mintA:n,mintB:o}){let r=Ro(e).publicKey,s=i||Xa(e,t,n,o).publicKey,a=Ey(e,s).publicKey,c=Kl(e,s,n).publicKey,u=Kl(e,s,o).publicKey,l=Ni(e,s).publicKey;return{poolId:s,configId:t,authority:r,lpMint:a,vaultA:c,vaultB:u,observationId:l}}var Fy=Buffer.from("locked_liquidity","utf8");function Hr(i,e){return te([Fy,e.toBuffer()],i)}var Dy=de("Raydium_cpmm"),ao={initialize:[175,175,109,31,13,152,155,237],deposit:[242,35,198,137,82,225,242,182],withdraw:[183,18,70,156,148,109,161,34],swapBaseInput:[143,190,90,218,196,30,51,222],swapBaseOutput:[55,217,98,86,163,74,180,173],lockCpLiquidity:[216,157,29,78,38,51,31,26],collectCpFee:[8,30,51,199,209,184,247,133]};function Rl(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g,w,k){let h=N([A("amountMaxA"),A("amountMaxB"),A("openTime")]),x=Xa(i,t,r,s).publicKey,T=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!o.equals(x),isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:qn,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:Ll,isSigner:!1,isWritable:!1},{pubkey:rr,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1}],B=Buffer.alloc(h.span);return h.encode({amountMaxA:g,amountMaxB:w,openTime:k},B),new so({keys:T,programId:i,data:Buffer.from([...ao.initialize,...B])})}function Nl(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y){let f=N([A("lpAmount"),A("amountMaxA"),A("amountMaxB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:qn,isSigner:!1,isWritable:!1},{pubkey:Qa,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!0}],g=Buffer.alloc(f.span);return Dy.debug("cpmm deposit data",{lpAmount:m.toString(),amountMaxA:p.toString(),amountMaxB:y.toString()}),f.encode({lpAmount:m,amountMaxA:p,amountMaxB:y},g),new so({keys:b,programId:i,data:Buffer.from([...ao.deposit,...g])})}function Ol(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y){let f=N([A("lpAmount"),A("amountMinA"),A("amountMinB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:qn,isSigner:!1,isWritable:!1},{pubkey:Qa,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:sn,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);return f.encode({lpAmount:m,amountMinA:p,amountMinB:y},g),new so({keys:b,programId:i,data:Buffer.from([...ao.withdraw,...g])})}function jr(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y,f){let b=N([A("amountIn"),A("amounOutMin")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],w=Buffer.alloc(b.span);return b.encode({amountIn:y,amounOutMin:f},w),new so({keys:g,programId:i,data:Buffer.from([...ao.swapBaseInput,...w])})}function vl(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y,f){let b=N([A("amountInMax"),A("amountOut")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],w=Buffer.alloc(b.span);return b.encode({amountInMax:y,amountOut:f},w),new so({keys:g,programId:i,data:Buffer.from([...ao.swapBaseOutput,...w])})}async function Ml(i){let{ownerInfo:e,poolInfo:t,poolKeys:n,feeNftOwner:o,getEphemeralSigners:r}=i,s=[],[a,c]=[new Oi(t.id),new Oi(t.lpMint.address)],u;if(r)u=new Oi((await r(1))[0]);else{let b=Vy.generate();s.push(b),u=b.publicKey}let{publicKey:l}=$(o,u,qn),{publicKey:d}=kn(u),{publicKey:m}=Hr(i.lockProgram,u),{publicKey:p}=$(e.wallet,c,qn),{publicKey:y}=$(i.lockAuthProgram,c,qn),f=qy({programId:i.lockProgram,auth:i.lockAuthProgram,payer:e.feePayer,liquidityOwner:e.wallet,nftOwner:o,nftMint:u,nftAccount:l,poolId:a,lockPda:m,mintLp:c,userLpVault:p,lockLpVault:y,poolVaultA:new Oi(n.vault.A),poolVaultB:new Oi(n.vault.B),metadataAccount:d,lpAmount:i.lpAmount,withMetadata:i.withMetadata??!0});return{address:{nftMint:u,nftAccount:l,metadataAccount:d,lockPda:m,userLpVault:p,lockLpVault:y},instructions:[f],signers:s,instructionTypes:[V.CpmmLockLp],lookupTableAddress:[]}}function qy({programId:i,auth:e,payer:t,liquidityOwner:n,nftOwner:o,nftMint:r,nftAccount:s,poolId:a,lockPda:c,mintLp:u,userLpVault:l,lockLpVault:d,poolVaultA:m,poolVaultB:p,metadataAccount:y,lpAmount:f,withMetadata:b}){let g=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:Wy.programId,isSigner:!1,isWritable:!1},{pubkey:qn,isSigner:!1,isWritable:!1},{pubkey:Ll,isSigner:!1,isWritable:!1},{pubkey:Gt,isSigner:!1,isWritable:!1}],w=N([A("lpAmount"),_e("withMetadata")]),k=Buffer.alloc(w.span);w.encode({lpAmount:f,withMetadata:b},k);let h=Buffer.from([...ao.lockCpLiquidity,...k]);return new so({keys:g,programId:i,data:h})}function El({programId:i,nftOwner:e,auth:t,nftAccount:n,lockPda:o,poolId:r,mintLp:s,userVaultA:a,userVaultB:c,poolVaultA:u,poolVaultB:l,mintA:d,mintB:m,lockLpVault:p,lpFeeAmount:y,cpmmProgram:f,cpmmAuthProgram:b}){let g=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:f??zo,isSigner:!1,isWritable:!1},{pubkey:b??Vs,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:qn,isSigner:!1,isWritable:!1},{pubkey:Qa,isSigner:!1,isWritable:!1},{pubkey:sn,isSigner:!1,isWritable:!1}],w=N([A("lpFeeAmount")]),k=Buffer.alloc(w.span);w.encode({lpFeeAmount:y},k);let h=Buffer.from([...ao.collectCpFee,...k]);return new so({keys:g,programId:i,data:h})}var za=N([ke(8),F("bump"),_e("disableCreatePool"),Zt("index"),A("tradeFeeRate"),A("protocolFeeRate"),A("fundFeeRate"),A("createPoolFee"),L("protocolOwner"),L("fundOwner"),X(A(),16)]),vi=N([ke(8),L("configId"),L("poolCreator"),L("vaultA"),L("vaultB"),L("mintLp"),L("mintA"),L("mintB"),L("mintProgramA"),L("mintProgramB"),L("observationId"),F("bump"),F("status"),F("lpDecimals"),F("mintDecimalA"),F("mintDecimalB"),A("lpAmount"),A("protocolFeesMintA"),A("protocolFeesMintB"),A("fundFeesMintA"),A("fundFeesMintB"),A("openTime"),X(A(),32)]);var Mi=class extends Ne{constructor(e){super(e)}async load(){this.checkDisabled()}async getCpmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async getRpcPoolInfo(e,t,n){if(!e&&!t?.marketAccount)throw new Error("Either poolId or accountInfos.marketAccount must be provided");let o=e?(await Ke(this.scope.connection,[{pubkey:new Q(e)}]))[0]:t.marketAccount;if(!o?.accountInfo){let x=e||t?.marketAccount?.pubkey?.toBase58()||"unknown";throw new Error(`Pool account not found: ${x}`)}let r={...vi.decode(o.accountInfo.data),programId:o.accountInfo.owner},s=[],a=[r.vaultA,r.vaultB];e&&(s.push(...a.map(x=>({pubkey:new Q(x)}))),n&&s.push({pubkey:new Q(r.configId)}));let c=[];e&&s.length>0&&(c=await Ke(this.scope.connection,s));let u;if(n){let x=e?c[c.length-1]:t?.configState;if(!x?.accountInfo)throw new Error(`Config account not found: ${r.configId}`);u=za.decode(x.accountInfo.data)}let l=e?c[0]?.accountInfo:t?.vaultAInfo?.accountInfo,d=e?c[1]?.accountInfo:t?.vaultBInfo?.accountInfo;if(!l||!d)throw new Error(`Vault accounts not found: A=${r.vaultA}, B=${r.vaultB}`);let m=new Fe(Ha.decode(l.data).amount.toString()),p=new Fe(Ha.decode(d.data).amount.toString()),y=m.sub(r.protocolFeesMintA).sub(r.fundFeesMintA),f=p.sub(r.protocolFeesMintB).sub(r.fundFeesMintB),b=new C(10).pow(r.mintDecimalA),g=new C(10).pow(r.mintDecimalB),w=new C(y.toString()).div(b),k=new C(f.toString()).div(g),h=w.isZero()?new C(0):k.div(w);return{...r,baseReserve:y,quoteReserve:f,vaultAAmount:m,vaultBAmount:p,configInfo:u,poolPrice:h}}async getRpcPoolInfos(e,t){let n=await Ke(this.scope.connection,e.map(d=>({pubkey:new Q(d)}))),o={},r=new Set,s=[];for(let d=0;d<e.length;d++){let m=n[d];if(m.accountInfo===null)throw Error("fetch pool info error: "+String(e[d]));let p=vi.decode(m.accountInfo.data);o[String(e[d])]={...p,programId:m.accountInfo.owner},r.add(String(p.configId)),s.push(p.vaultA,p.vaultB)}let a={};if(t){let d=[...r],m=await Ke(this.scope.connection,d.map(p=>({pubkey:new Q(p)})));for(let p=0;p<d.length;p++){let y=m[p].accountInfo;if(y===null)throw Error("fetch pool config error: "+d[p]);a[d[p]]=za.decode(y.data)}}let c={},u=await Ke(this.scope.connection,s.map(d=>({pubkey:new Q(d)})));for(let d=0;d<s.length;d++){let m=u[d].accountInfo;if(m===null)throw Error("fetch vault info error: "+s[d]);c[String(s[d])]=new Fe(Ha.decode(m.data).amount.toString())}let l={};for(let[d,m]of Object.entries(o)){let p=c[m.vaultA.toString()].sub(m.protocolFeesMintA).sub(m.fundFeesMintA),y=c[m.vaultB.toString()].sub(m.protocolFeesMintB).sub(m.fundFeesMintB);l[d]={...m,baseReserve:p,quoteReserve:y,vaultAAmount:c[m.vaultA.toString()],vaultBAmount:c[m.vaultB.toString()],configInfo:a[m.configId.toString()],poolPrice:new C(y.toString()).div(new C(10).pow(m.mintDecimalB)).div(new C(p.toString()).div(new C(10).pow(m.mintDecimalA)))}}return l}toComputePoolInfos({pools:e,mintInfos:t}){return Object.keys(e).reduce((n,o)=>{let r=e[o],[s,a]=[r.mintA.toBase58(),r.mintB.toBase58()];return{...n,[o]:{...r,id:new Q(o),configInfo:r.configInfo,version:7,authority:Ro(r.programId).publicKey,mintA:gt({address:s,decimals:r.mintDecimalA,programId:r.mintProgramA.toBase58(),extensions:{feeConfig:t[s]?.feeConfig?Vn(t[s]?.feeConfig):void 0}}),mintB:gt({address:a,decimals:r.mintDecimalB,programId:r.mintProgramB.toBase58(),extensions:{feeConfig:t[a]?.feeConfig?Vn(t[a]?.feeConfig):void 0}})}}},{})}async getPoolInfoFromRpc(e,t,n){t=t||await this.getRpcPoolInfo(e,void 0,!0),n=n||await mo({connection:this.scope.connection,mints:[t.mintA,t.mintB]});let o=gt({address:t.mintA.toBase58(),decimals:t.mintDecimalA,programId:t.mintProgramA.toBase58(),extensions:{feeConfig:n[t.mintA.toBase58()].feeConfig?Vn(n[t.mintA.toBase58()].feeConfig):void 0}}),r=gt({address:t.mintB.toBase58(),decimals:t.mintDecimalB,programId:t.mintProgramB.toBase58(),extensions:{feeConfig:n[t.mintB.toBase58()].feeConfig?Vn(n[t.mintB.toBase58()].feeConfig):void 0}}),s=gt({address:t.mintLp.toBase58(),decimals:t.lpDecimals,programId:Mt.toBase58()}),a={id:t.configId.toBase58(),index:t.configInfo.index,protocolFeeRate:t.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:t.configInfo.tradeFeeRate.toNumber(),fundFeeRate:t.configInfo.fundFeeRate.toNumber(),createPoolFee:t.configInfo.createPoolFee.toString()},c={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};return{poolInfo:{programId:t.programId.toBase58(),id:e,type:"Standard",lpMint:s,lpPrice:0,lpAmount:t.lpAmount.toNumber(),config:a,mintA:o,mintB:r,rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:t.poolPrice.toNumber(),mintAmountA:new C(t.vaultAAmount.toString()).div(10**o.decimals).toNumber(),mintAmountB:new C(t.vaultBAmount.toString()).div(10**r.decimals).toNumber(),feeRate:t.configInfo.tradeFeeRate.toNumber(),openTime:t.openTime.toString(),tvl:0,burnPercent:0,day:c,week:c,month:c,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0},poolKeys:{programId:t.programId.toBase58(),id:e,mintA:o,mintB:r,openTime:t.openTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},authority:Ro(t.programId).publicKey.toBase58(),mintLp:s,config:a,observationId:Ni(t.programId,new Q(e)).publicKey.toBase58()},rpcData:t}}async createPool({poolId:e,programId:t,poolFeeAccount:n,startTime:o,ownerInfo:r,associatedOnly:s=!1,checkCreateATAOwner:a=!1,txVersion:c,feeConfig:u,computeBudgetConfig:l,txTipConfig:d,feePayer:m,...p}){let y=r.feePayer||this.scope.owner?.publicKey,f=new Fe(new Q(p.mintA.address).toBuffer()).lte(new Fe(new Q(p.mintB.address).toBuffer())),[b,g]=f?[p.mintA,p.mintB]:[p.mintB,p.mintA],[w,k]=f?[p.mintAAmount,p.mintBAmount]:[p.mintBAmount,p.mintAAmount],h=r.useSOLBalance&&b.address===No.toBase58(),x=r.useSOLBalance&&g.address===No.toBase58(),[T,B]=[new Q(b.address),new Q(g.address)],S=this.createTxBuilder(m),{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:T,tokenProgram:b.programId,owner:this.scope.ownerPubKey,createInfo:h?{payer:y,amount:w}:void 0,notUseTokenAccount:h,skipCloseAccount:!h,associatedOnly:h?!1:s,checkCreateATAOwner:a});S.addInstruction(K||{});let{account:O,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({mint:new Q(g.address),tokenProgram:g.programId,owner:this.scope.ownerPubKey,createInfo:x?{payer:y,amount:k}:void 0,notUseTokenAccount:x,skipCloseAccount:!x,associatedOnly:x?!1:s,checkCreateATAOwner:a});if(S.addInstruction(v||{}),I===void 0||O===void 0)throw Error("you don't has some token account");let _=Cl({poolId:e,programId:t,configId:new Q(u.id),mintA:T,mintB:B});return S.addInstruction({instructions:[Rl(t,this.scope.ownerPubKey,new Q(u.id),_.authority,_.poolId,T,B,_.lpMint,I,O,$(this.scope.ownerPubKey,_.lpMint).publicKey,_.vaultA,_.vaultB,n,new Q(b.programId??Mt),new Q(g.programId??Mt),_.observationId,w,k,o)],instructionTypes:[V.CpmmCreatePool]}),S.addCustomComputeBudget(l),S.addTipInstruction(d),S.versionBuild({txVersion:c,extInfo:{address:{..._,mintA:b,mintB:g,programId:t,poolFeeAccount:n,feeConfig:u}}})}async addLiquidity(e){let{poolInfo:t,poolKeys:n,inputAmount:o,baseIn:r,slippage:s,computeResult:a,computeBudgetConfig:c,txTipConfig:u,config:l,txVersion:d,feePayer:m}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),o.isZero()&&this.logAndCreateError("amounts must greater than zero","amountInA",{amountInA:o.toString()});let{account:p}=this.scope,{bypassAssociatedCheck:y,checkCreateATAOwner:f}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...l},b=a?void 0:await this.getRpcPoolInfo(t.id),{liquidity:g,inputAmountFee:w,anotherAmount:k}=a||this.computePairAmount({poolInfo:{...t,lpAmount:new C(b.lpAmount.toString()).div(10**t.lpMint.decimals).toNumber()},baseReserve:b.baseReserve,quoteReserve:b.quoteReserve,slippage:new De(0),baseIn:r,epochInfo:await this.scope.fetchEpochInfo(),amount:new C(o.toString()).div(10**(r?t.mintA.decimals:t.mintB.decimals))}),h=k.amount,x=t.mintA.address===No.toString(),T=t.mintB.address===No.toString(),B=this.createTxBuilder(m),[S,I]=[new Q(t.mintA.address),new Q(t.mintB.address)],{account:K,instructionParams:O}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Q(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:x||(r?o:h).isZero()?{payer:this.scope.ownerPubKey,amount:r?o:h}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:!1,checkCreateATAOwner:f});B.addInstruction(O||{});let{account:v,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Q(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:T||(r?h:o).isZero()?{payer:this.scope.ownerPubKey,amount:r?h:o}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:!1,checkCreateATAOwner:f});B.addInstruction(_||{}),!K&&!v&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",p.tokenAccounts);let D=await p.getCreatedTokenAccount({mint:new Q(t.lpMint.address)}),{tokenAccount:q,...G}=await p.handleTokenAccount({side:"out",amount:0,mint:new Q(t.lpMint.address),tokenAccount:D,bypassAssociatedCheck:y,checkCreateATAOwner:f});B.addInstruction(G);let Z=n??await this.getCpmmPoolKeys(t.id),ie=new De(new Fe(1)).sub(s);return B.addInstruction({instructions:[Nl(new Q(t.programId),this.scope.ownerPubKey,new Q(Z.authority),new Q(t.id),q,K,v,new Q(Z.vault.A),new Q(Z.vault.B),S,I,new Q(t.lpMint.address),a?a?.liquidity:ie.mul(g).quotient,r?w.amount:h,r?h:w.amount)],instructionTypes:[V.CpmmAddLiquidity],lookupTableAddress:Z.lookupTableAccount?[Z.lookupTableAccount]:[]}),B.addCustomComputeBudget(c),B.addTipInstruction(u),B.versionBuild({txVersion:d})}async withdrawLiquidity(e){let{poolInfo:t,poolKeys:n,lpAmount:o,slippage:r,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u,closeWsol:l=!0}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region");let d=new De(new Fe(1)).sub(r),m=await this.getRpcPoolInfo(t.id),[p,y]=[d.mul(o.mul(m.baseReserve).div(m.lpAmount)).quotient,d.mul(o.mul(m.quoteReserve).div(m.lpAmount)).quotient],f=await this.scope.fetchEpochInfo(),[b,g]=[we(p,t.mintA.extensions.feeConfig,f,!1),we(y,t.mintB.extensions.feeConfig,f,!1)],{account:w}=this.scope,k=this.createTxBuilder(u),[h,x]=[new Q(t.mintA.address),new Q(t.mintB.address)],T=h.equals(j),B=x.equals(j),S,I,{account:K,instructionParams:O}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Q(t.mintA.address),notUseTokenAccount:T,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(T&&l),associatedOnly:!T,checkCreateATAOwner:!1});S=K,O&&k.addInstruction(O);let{account:v,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Q(t.mintB.address),notUseTokenAccount:B,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(B&&l),associatedOnly:!B,checkCreateATAOwner:!1});I=v,_&&k.addInstruction(_),(!S||!I)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",w.tokenAccounts);let D=await w.getCreatedTokenAccount({mint:new Q(t.lpMint.address)});D||this.logAndCreateError("cannot found lp token account","tokenAccounts",w.tokenAccounts);let q=n??await this.getCpmmPoolKeys(t.id);return k.addInstruction({instructions:[Ol(new Q(t.programId),this.scope.ownerPubKey,new Q(q.authority),new Q(t.id),D,S,I,new Q(q.vault.A),new Q(q.vault.B),h,x,new Q(t.lpMint.address),o,p.sub(b.fee??new Fe(0)),y.sub(g.fee??new Fe(0)))],instructionTypes:[V.CpmmWithdrawLiquidity],lookupTableAddress:q.lookupTableAccount?[q.lookupTableAccount]:[]}),k.addCustomComputeBudget(s),k.addTipInstruction(a),k.versionBuild({txVersion:c})}async swap(e){await new Promise(Z=>setImmediate(Z));let{poolInfo:t,poolKeys:n,baseIn:o,fixedOut:r,inputAmount:s,swapResult:a,slippage:c=0,config:u,computeBudgetConfig:l,txTipConfig:d,txVersion:m,feePayer:p,nonce:y}=e,{bypassAssociatedCheck:f,checkCreateATAOwner:b,associatedOnly:g,useIdempotent:w=!1}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,associatedOnly:!0,useIdempotent:!1,...u},k=this.createTxBuilder(p);if(y&&y?.instruction&&k.addInstruction({instructions:[y.instruction],instructionTypes:[y.instruction].map(()=>V.NonceAccount)}),l){let{instructions:Z,instructionTypes:ie}=yo(l);k.addInstruction({instructions:Z,instructionTypes:ie})}r?a.sourceAmountSwapped=a.sourceAmountSwapped.mul(new Fe((1+c)*1e4)).div(new Fe(1e4)):a.destinationAmountSwapped=a.destinationAmountSwapped.mul(new Fe((1-c)*1e4)).div(new Fe(1e4));let[h,x]=[new Q(t.mintA.address),new Q(t.mintB.address)],T,B;if(w){let Z=new Q(t.mintA.programId??Mt),ie=new Q(t.mintB.programId??Mt),he=h.equals(No),re=x.equals(No);T=Fl(h,this.scope.ownerPubKey,!1,Z),B=Fl(x,this.scope.ownerPubKey,!1,ie),he||k.addInstruction({instructions:[_l(this.scope.ownerPubKey,T,this.scope.ownerPubKey,h,Z)],instructionTypes:[V.CreateATA]}),re||k.addInstruction({instructions:[_l(this.scope.ownerPubKey,B,this.scope.ownerPubKey,x,ie)],instructionTypes:[V.CreateATA]})}else{let Z=t.mintA.address===j.toBase58(),ie=t.mintB.address===j.toBase58(),{account:he,instructionParams:re}=await this.scope.account.getOrCreateTokenAccount({mint:h,tokenProgram:new Q(t.mintA.programId??Mt),owner:this.scope.ownerPubKey,createInfo:Z||!o?{payer:this.scope.ownerPubKey,amount:o?a.sourceAmountSwapped:0}:void 0,notUseTokenAccount:Z,skipCloseAccount:!Z,associatedOnly:Z?!1:g,checkCreateATAOwner:b});re&&k.addInstruction(re),T=he;let{account:Ae,instructionParams:lt}=await this.scope.account.getOrCreateTokenAccount({mint:x,tokenProgram:new Q(t.mintB.programId??Mt),owner:this.scope.ownerPubKey,createInfo:ie||o?{payer:this.scope.ownerPubKey,amount:o?0:a.sourceAmountSwapped}:void 0,notUseTokenAccount:ie,skipCloseAccount:!ie,associatedOnly:ie?!1:g,checkCreateATAOwner:b});lt&&k.addInstruction(lt),B=Ae,(!T||!B)&&this.logAndCreateError("user do not have token account",{mintA:t.mintA.symbol||t.mintA.address,mintB:t.mintB.symbol||t.mintB.address,mintATokenAcc:T,mintBTokenAcc:B,mintAUseSOLBalance:Z,mintBUseSOLBalance:ie,associatedOnly:g})}let S=n??await this.getCpmmPoolKeys(t.id),I=o?T:B,K=o?B:T,O=o?h:x,v=o?x:h,_=o?S.vault.A:S.vault.B,D=o?S.vault.B:S.vault.A,q=o?new Q(t.mintA.programId??Mt):new Q(t.mintB.programId??Mt),G=o?new Q(t.mintB.programId??Mt):new Q(t.mintA.programId??Mt);return k.addInstruction({instructions:[r?vl(new Q(t.programId),this.scope.ownerPubKey,new Q(S.authority),new Q(S.config.id),new Q(t.id),I,K,new Q(_),new Q(D),q,G,O,v,Ni(new Q(t.programId),new Q(t.id)).publicKey,a.sourceAmountSwapped,a.destinationAmountSwapped):jr(new Q(t.programId),this.scope.ownerPubKey,new Q(S.authority),new Q(S.config.id),new Q(t.id),I,K,new Q(_),new Q(D),q,G,O,v,Ni(new Q(t.programId),new Q(t.id)).publicKey,s,a.destinationAmountSwapped)],instructionTypes:[r?V.CpmmSwapBaseOut:V.CpmmSwapBaseIn]}),k.addTipInstruction(d),k.versionBuild({txVersion:m},y?.nonce)}async lockLp(e){let{poolInfo:t,lpAmount:n,computeBudgetConfig:o,txTipConfig:r,txVersion:s,feePayer:a,feeNftOwner:c}=e;n.isZero()&&this.logAndCreateError("lpAmount must greater than zero",{lpAmount:n.toString()});let u=this.createTxBuilder(a),l=e.poolKeys??await this.getCpmmPoolKeys(t.id),d=await Ml({poolInfo:t,poolKeys:l,ownerInfo:{wallet:this.scope.ownerPubKey,feePayer:e.feePayer??this.scope.ownerPubKey},feeNftOwner:c??this.scope.ownerPubKey,lockProgram:e.programId??Ho,lockAuthProgram:e.authProgram??jo,lpAmount:n,withMetadata:e.withMetadata??!0,getEphemeralSigners:e.getEphemeralSigners});return u.addInstruction(d),u.addCustomComputeBudget(o),u.addTipInstruction(r),u.versionBuild({txVersion:s,extInfo:d.address})}async harvestLockLp(e){let{poolInfo:t,lpFeeAmount:n,nftMint:o,programId:r=Ho,authProgram:s=jo,cpmmProgram:a,computeBudgetConfig:c,txTipConfig:u,txVersion:l,closeWsol:d=!0}=e;n.isZero()&&this.logAndCreateError("lpFeeAmount must greater than zero",{lpAmount:n.toString()});let m=e.feePayer||this.scope.ownerPubKey,p=this.createTxBuilder(m),[y,f]=[new Q(t.mintA.address),new Q(t.mintB.address)],b=y.equals(j),g=f.equals(j),w,k,{account:h,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Q(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(b&&d),associatedOnly:!b,checkCreateATAOwner:!1});w=h,x&&p.addInstruction(x);let{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Q(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(g&&d),associatedOnly:!g,checkCreateATAOwner:!1});k=T,B&&p.addInstruction(B),(!w||!k)&&this.logAndCreateError("cannot found target token accounts",{tokenAccountA:w,tokenAccountB:k});let S=e.poolKeys??await this.getCpmmPoolKeys(t.id),{publicKey:I}=$(m,o,Mt),{publicKey:K}=Hr(r,o),{publicKey:O}=$(s,new Q(t.lpMint.address),Mt);return p.addInstruction({instructions:[El({programId:r??Ho,nftOwner:this.scope.ownerPubKey,auth:s??jo,nftMint:o,nftAccount:I,lockPda:K,poolId:new Q(t.id),mintLp:new Q(S.mintLp.address),userVaultA:w,userVaultB:k,poolVaultA:new Q(S.vault.A),poolVaultB:new Q(S.vault.B),mintA:y,mintB:f,lockLpVault:O,lpFeeAmount:n,cpmmProgram:a?.programId,cpmmAuthProgram:a?.authProgram})],instructionTypes:[V.CpmmCollectLockFee]}),p.addCustomComputeBudget(c),p.addTipInstruction(u),p.versionBuild({txVersion:l})}computeSwapAmount({pool:e,amountIn:t,outputMint:n,slippage:o}){let r=n.toString()===e.mintB.address,s=zr.swap(t,r?e.baseReserve:e.quoteReserve,r?e.quoteReserve:e.baseReserve,e.configInfo.tradeFeeRate),a=new C(s.destinationAmountSwapped.toString()).div(s.sourceAmountSwapped.toString()),c=s.destinationAmountSwapped.mul(new Fe((1-o)*1e4)).div(new Fe(1e4));return{allTrade:s.sourceAmountSwapped.eq(t),amountIn:t,amountOut:s.destinationAmountSwapped,minAmountOut:c,executionPrice:a,fee:s.tradeFee,priceImpact:e.poolPrice.sub(a).div(e.poolPrice)}}computePairAmount({poolInfo:e,baseReserve:t,quoteReserve:n,amount:o,slippage:r,epochInfo:s,baseIn:a}){let c=1-Number(r.toSignificant())/100,u=new Fe(new C(o).mul(10**e[a?"mintA":"mintB"].decimals).mul(c).toFixed(0)),l=we(u,e[a?"mintA":"mintB"].extensions.feeConfig,s,!1),d=u.sub(l.fee??new Fe(0)),m=new Fe(new C(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,C.ROUND_DOWN));this.logDebug("baseReserve:",t.toString(),"quoteReserve:",n.toString()),this.logDebug("tokenIn:",a?e.mintA.symbol:e.mintB.symbol,"amountIn:",u.toString(),"amountInFee:",l.fee?.toString()??0,"anotherToken:",a?e.mintB.symbol:e.mintA.symbol,"slippage:",`${r.toSignificant()}%`);let p=a?"base":"quote";this.logDebug("input side:",p);let y=d.mul(m).div(p==="base"?t:n),f={amount:ze,fee:void 0,expirationTime:void 0};if(!d.isZero()){let h=Uy(y,t,n,m);this.logDebug("lpAmountData:",{amountA:h.amountA.toString(),amountB:h.amountB.toString()}),f=we(h[a?"amountB":"amountA"],e[a?"mintB":"mintA"].extensions.feeConfig,s,!0)}let b=new De(new Fe(1)).add(r),g=new De(new Fe(1)).sub(r),w=we(b.mul(f.amount.sub(f.fee??new Fe(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0),k=we(g.mul(f.amount.sub(f.fee??new Fe(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0);return this.logDebug("anotherAmount:",f.amount.toString(),"anotherAmountFee:",f.fee?.toString()??0,"maxAnotherAmount:",w.amount.toString(),"maxAnotherAmountFee:",w.fee?.toString()??0),{inputAmountFee:l,anotherAmount:f,maxAnotherAmount:w,minAnotherAmount:k,liquidity:y}}};function Uy(i,e,t,n){let o=i.mul(e).div(n);!o.isZero()&&!i.mul(e).mod(n).isZero()&&(o=o.add(new Fe(1)));let r=i.mul(t).div(n);return!r.isZero()&&!i.mul(t).mod(n).isZero()&&(r=r.add(new Fe(1))),{amountA:o,amountB:r}}import{PublicKey as uo}from"@solana/web3.js";import{createTransferInstruction as Gl,TOKEN_PROGRAM_ID as Xe,TOKEN_2022_PROGRAM_ID as $r}from"@solana/spl-token";import Jr from"bn.js";var Vl={[dr.toBase58()]:3},Wl={3:dr};var ja=N([ke(5),ke(8),L("ownAddress"),A("vaultSignerNonce"),L("baseMint"),L("quoteMint"),L("baseVault"),A("baseDepositsTotal"),A("baseFeesAccrued"),L("quoteVault"),A("quoteDepositsTotal"),A("quoteFeesAccrued"),A("quoteDustThreshold"),L("requestQueue"),L("eventQueue"),L("bids"),L("asks"),A("baseLotSize"),A("quoteLotSize"),A("feeRateBps"),A("referrerRebatesAccrued"),ke(7)]),Dl={3:ja};import{PublicKey as ql}from"@solana/web3.js";var Yr=de("Serum"),Zr=class{static getProgramId(e){let t=Wl[e];return t||Yr.logWithError("invalid version","version",e),t}static getVersion(e){let t=e.toBase58(),n=Vl[t];return n||Yr.logWithError("invalid program id","programId",t),n}static getStateLayout(e){let t=Dl[e];return t||Yr.logWithError(!!t,"invalid version","version",e),t}static getLayouts(e){return{state:this.getStateLayout(e)}}static getAssociatedAuthority({programId:e,marketId:t}){let n=[t.toBuffer()],o=0,r;for(;o<100;){try{let s=n.concat(Buffer.from([o]),Buffer.alloc(7));r=ql.createProgramAddressSync(s,e)}catch(s){if(s instanceof TypeError)throw s;o++;continue}return{publicKey:r,nonce:o}}return Yr.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),{publicKey:ql.default,nonce:o}}};import{PublicKey as R,SystemProgram as Ei,TransactionInstruction as _i}from"@solana/web3.js";import cn from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Ya,TOKEN_2022_PROGRAM_ID as Za,TOKEN_PROGRAM_ID as Un}from"@solana/spl-token";function XC(i,e,t,n,o,r,s,a,c,u,l,d){let m=N([F("instruction"),A("amountIn"),A("amountOut")]),p=[{pubkey:Ei.programId,isSigner:!1,isWritable:!1},{pubkey:Un,isSigner:!1,isWritable:!1},{pubkey:new R(t.programId),isSigner:!1,isWritable:!1},{pubkey:new R(t.id),isSigner:!1,isWritable:!0},{pubkey:new R(n.id),isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let f=Re(t);p.push({pubkey:f.config.id,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(c)?f.vault.A:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(c)?f.vault.B:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},...d.map(b=>({pubkey:b,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let f=Re(t);p.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:new R("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0})}else{let f=Re(t);p.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},...f.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:f.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:f.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0}])}let y=Buffer.alloc(m.span);return m.encode({instruction:4,amountIn:u,amountOut:l},y),new _i({keys:p,programId:i,data:y})}function QC(i,e,t,n,o,r,s,a,c,u){let l=N([F("instruction")]),d=[{pubkey:Ei.programId,isSigner:!1,isWritable:!1},{pubkey:Un,isSigner:!1,isWritable:!1},{pubkey:new R(String(n.programId)),isSigner:!1,isWritable:!1},{pubkey:new R(String(n.id)),isSigner:!1,isWritable:!0},{pubkey:new R(String(t.id)),isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let p=Re(n);d.push({pubkey:p.config.id,isSigner:!1,isWritable:!1},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.mintA.address.equals(c)?p.vault.A:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.mintA.address.equals(c)?p.vault.B:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0},...u.map(y=>({pubkey:y,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let p=Re(n);d.push({pubkey:p.authority,isSigner:!1,isWritable:!1},{pubkey:p.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:new R("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:p.openOrders,isSigner:!1,isWritable:!0},{pubkey:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.marketId,isSigner:!1,isWritable:!0},{pubkey:p.marketBids,isSigner:!1,isWritable:!0},{pubkey:p.marketAsks,isSigner:!1,isWritable:!0},{pubkey:p.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0})}else{let p=Re(n);d.push({pubkey:p.authority,isSigner:!1,isWritable:!1},{pubkey:p.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:p.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:p.openOrders,isSigner:!1,isWritable:!0},{pubkey:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.marketId,isSigner:!1,isWritable:!0},{pubkey:p.marketBids,isSigner:!1,isWritable:!0},{pubkey:p.marketAsks,isSigner:!1,isWritable:!0},{pubkey:p.marketEventQueue,isSigner:!1,isWritable:!0},...p.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:p.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:p.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0}])}let m=Buffer.alloc(l.span);return l.encode({instruction:5},m),new _i({keys:d,programId:i,data:m})}function Gy(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y){let f=[],b=[P({pubkey:Un,isWritable:!1}),P({pubkey:Za,isWritable:!1}),P({pubkey:Ya,isWritable:!1}),P({pubkey:Ei.programId,isWritable:!1}),P({pubkey:e,isSigner:!0})];b.push(P({pubkey:t})),b.push(P({pubkey:o}));let g=[c,u],w=[l,d],k=[r,s,a];for(let T=0;T<g.length;T++){let B=g[T],S=k[T]===B.mintA.address;if(b.push(P({pubkey:new R(B.programId),isWritable:!1})),T===g.length-1?b.push(P({pubkey:o})):b.push(P({pubkey:n})),b.push(P({pubkey:new R(k[T])})),b.push(P({pubkey:new R(k[T+1])})),B.version===6){let I=w[T];b.push(P({pubkey:new R(I.config.id)})),b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(S?I.vault.A:I.vault.B)})),b.push(P({pubkey:new R(S?I.vault.B:I.vault.A)})),b.push(P({pubkey:new R(B.observationId)})),b.push(P({pubkey:sn})),b.push(P({pubkey:Ge(new R(B.programId),new R(B.id)).publicKey})),f.push($a(B.sqrtPriceX64.toString(),S));for(let K of y[T]??[])b.push(P({pubkey:new R(K)}))}else if(B.version===5){let I=w[T];b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(I.authority),isWritable:!1})),b.push(P({pubkey:new R(I.marketProgramId)})),b.push(P({pubkey:new R(I.marketAuthority)})),b.push(P({pubkey:pr,isWritable:!1})),b.push(P({pubkey:new R(I.openOrders)})),b.push(P({pubkey:new R(I.vault.A)})),b.push(P({pubkey:new R(I.vault.B)})),b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(I.marketId)})),b.push(P({pubkey:new R(I.marketBids)})),b.push(P({pubkey:new R(I.marketAsks)})),b.push(P({pubkey:new R(I.marketEventQueue)})),b.push(P({pubkey:new R(I.marketBaseVault)})),b.push(P({pubkey:new R(I.marketQuoteVault)}))}else if(B.version===4){let I=w[T],K=B.status!==1;b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(I.authority),isWritable:!1})),b.push(P({pubkey:new R(K?I.id:I.marketProgramId)})),b.push(P({pubkey:new R(K?I.id:I.marketAuthority)})),b.push(P({pubkey:new R(K?I.id:I.openOrders)})),b.push(P({pubkey:new R(I.vault.A)})),b.push(P({pubkey:new R(I.vault.B)})),b.push(P({pubkey:new R(K?I.id:I.marketId)})),b.push(P({pubkey:new R(K?I.id:I.marketBids)})),b.push(P({pubkey:new R(K?I.id:I.marketAsks)})),b.push(P({pubkey:new R(K?I.id:I.marketEventQueue)})),b.push(P({pubkey:new R(K?I.id:I.marketBaseVault)})),b.push(P({pubkey:new R(K?I.id:I.marketQuoteVault)}))}else if(B.version===7){let I=w[T];b.push(P({pubkey:new R(I.authority)})),b.push(P({pubkey:new R(I.config.id)})),b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(S?I.vault.A:I.vault.B)})),b.push(P({pubkey:new R(S?I.vault.B:I.vault.A)})),b.push(P({pubkey:new R(B.observationId)}))}else throw Error("pool type error")}let h=N([F("insId"),A("amountIn"),A("amountOut"),X(J(),f.length,"clmmPriceLimit")]),x=Buffer.alloc(h.span);return h.encode({insId:0,amountIn:m,amountOut:p,clmmPriceLimit:f},x),new _i({keys:b,programId:i,data:x})}function $a(i,e){if(i)if(e){let t=new cn(i).div(new cn(25));return t.gt(Lr)?t:Lr}else{let t=new cn(i).mul(new cn(25));return t.lt(Rr)?t:Rr}else return e?Lr:Rr}function Ul({routeProgram:i,ownerInfo:e,inputMint:t,swapInfo:n}){if(n.routeType==="amm")if(n.poolInfo[0].version===6){let o=n.poolKey[0],r=Re(o),s=t.equals(r.mintA.address)?Ft.add(Nt):Vt.sub(Nt);return xe.makeSwapBaseInInstructions({poolInfo:o,poolKeys:o,observationId:n.poolInfo[0].observationId,ownerInfo:{wallet:e.wallet,tokenAccountA:r.mintA.address.equals(t)?e.sourceToken:e.destinationToken,tokenAccountB:r.mintA.address.equals(t)?e.destinationToken:e.sourceToken},inputMint:t,amountIn:n.amountIn.amount.raw,amountOutMin:n.minAmountOut.amount.raw.sub(n.minAmountOut.fee?.raw??new cn(0)),sqrtPriceLimitX64:s,remainingAccounts:n.remainingAccounts[0]??[]})}else if(n.poolInfo[0].version===7){let o=n.poolInfo[0],r=t.toString()===n.poolInfo[0].mintA.address;return{signers:[],instructions:[jr(o.programId,e.wallet,o.authority,o.configId,o.id,e.sourceToken,e.destinationToken,r?o.vaultA:o.vaultB,r?o.vaultB:o.vaultA,r?o.mintProgramA:o.mintProgramB,r?o.mintProgramB:o.mintProgramA,new R(o[r?"mintA":"mintB"].address),new R(o[r?"mintB":"mintA"].address),o.observationId,n.amountIn.amount.raw,n.minAmountOut.amount.raw)],lookupTableAddress:[],instructionTypes:[r?V.CpmmSwapBaseIn:V.CpmmSwapBaseOut],address:{}}}else{let o=n.poolKey[0];return{signers:[],instructions:[Fr({poolKeys:o,version:n.poolInfo[0].pooltype.includes("StablePool")?5:4,userKeys:{tokenAccountIn:e.sourceToken,tokenAccountOut:e.destinationToken,owner:e.wallet},amountIn:n.amountIn.amount.raw,amountOut:n.minAmountOut.amount.raw.sub(n.minAmountOut.fee?.raw??new cn(0)),fixedSide:"in"})],lookupTableAddress:o.lookupTableAccount?[o.lookupTableAccount]:[],instructionTypes:[n.poolInfo[0].pooltype.includes("StablePool")?V.AmmV5SwapBaseIn:V.AmmV4SwapBaseIn],address:{}}}else if(n.routeType==="route"){let o=n.poolInfo[0],r=n.poolInfo[1],s=n.poolKey[0],a=n.poolKey[1];if(e.routeToken===void 0)throw Error("owner route token account check error");return{signers:[],instructions:[Gy(i,e.wallet,e.sourceToken,e.routeToken,e.destinationToken,t.toString(),n.middleToken.mint.toString(),n.outputMint.toString(),o,r,s,a,n.amountIn.amount.raw,n.minAmountOut.amount.raw.sub(n.minAmountOut.fee?.raw??new cn(0)),n.remainingAccounts)],instructionTypes:[V.RouteSwap],lookupTableAddress:[s.lookupTableAccount,a.lookupTableAccount].filter(c=>c!==void 0),address:{}}}else throw Error("route type error")}function zC({programId:i,wallet:e,amount:t,inputAccount:n,outputAccount:o,routeInfo:r,poolKeys:s}){if(r.success===!1)throw Error("route info error");let a=[],c=[P({pubkey:Un,isWritable:!1}),P({pubkey:Za,isWritable:!1}),P({pubkey:Ya,isWritable:!1}),P({pubkey:Ei.programId,isWritable:!1}),P({pubkey:e,isSigner:!0})],u={[r.data.inputMint]:n,[r.data.outputMint]:o};c.push(P({pubkey:u[r.data.inputMint]})),c.push(P({pubkey:u[r.data.outputMint]}));for(let m=0;m<s.length;m++){let p=r.data.routePlan[m],y=s[m],f=p.inputMint===y.mintA.address;if(c.push(P({pubkey:new R(y.programId),isWritable:!1})),m===s.length-1)c.push(P({pubkey:u[p.outputMint]}));else{let b=p.outputMint;if(u[b]===void 0){let g=$(e,new R(b),y.programId===At.CLMM_PROGRAM_ID.toBase58()||y.programId===At.CREATE_CPMM_POOL_PROGRAM.toBase58()?new R(f?y.mintB.programId:y.mintA.programId):Un).publicKey;u[b]=g}c.push(P({pubkey:u[b]}))}if(c.push(P({pubkey:new R(p.inputMint)})),c.push(P({pubkey:new R(p.outputMint)})),y.programId===At.CLMM_PROGRAM_ID.toBase58()){let b=y;c.push(P({pubkey:new R(b.config.id)})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(f?b.vault.A:b.vault.B)})),c.push(P({pubkey:new R(f?b.vault.B:b.vault.A)})),c.push(P({pubkey:new R(b.observationId)})),c.push(P({pubkey:sn,isWritable:!1})),c.push(P({pubkey:new R(b.exBitmapAccount)})),a.push($a(p.lastPoolPriceX64,f));for(let g of p.remainingAccounts??[])c.push(P({pubkey:new R(g)}))}else if(y.programId===At.AMM_STABLE.toBase58()){let b=y;c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.authority),isWritable:!1})),c.push(P({pubkey:new R(b.marketProgramId),isWritable:!1})),c.push(P({pubkey:new R(b.marketAuthority),isWritable:!1})),c.push(P({pubkey:pr,isWritable:!1})),c.push(P({pubkey:new R(b.openOrders)})),c.push(P({pubkey:new R(b.vault.A)})),c.push(P({pubkey:new R(b.vault.B)})),c.push(P({pubkey:new R(b.marketId)})),c.push(P({pubkey:new R(b.marketBids)})),c.push(P({pubkey:new R(b.marketAsks)})),c.push(P({pubkey:new R(b.marketEventQueue)})),c.push(P({pubkey:new R(b.marketBaseVault)})),c.push(P({pubkey:new R(b.marketQuoteVault)}))}else if(y.programId===At.AMM_V4.toBase58()){let b=y;c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.authority),isWritable:!1})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.vault.A)})),c.push(P({pubkey:new R(b.vault.B)})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.id)}))}else if(y.programId===At.CREATE_CPMM_POOL_PROGRAM.toBase58()){let b=y;c.push(P({pubkey:new R(b.authority)})),c.push(P({pubkey:new R(b.config.id)})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(f?b.vault.A:b.vault.B)})),c.push(P({pubkey:new R(f?b.vault.B:b.vault.A)})),c.push(P({pubkey:new R(b.observationId)}))}else throw Error("pool type error")}let l=N([F("insId"),A("amountIn"),A("amountOut"),X(J(),a.length,"clmmPriceLimit")]),d=Buffer.alloc(l.span);return l.encode({insId:0,amountIn:t,amountOut:new cn(r.data.otherAmountThreshold),clmmPriceLimit:a},d),new _i({keys:c,programId:i,data:d})}function HC({programId:i,wallet:e,inputAccount:t,outputAccount:n,routeInfo:o,poolKeys:r}){if(o.success===!1)throw Error("route info error");let s=[],a=[P({pubkey:Un,isWritable:!1}),P({pubkey:Za,isWritable:!1}),P({pubkey:Ya,isWritable:!1}),P({pubkey:Ei.programId,isWritable:!1}),P({pubkey:e,isSigner:!0})],c={[o.data.inputMint]:t,[o.data.outputMint]:n};for(let d=r.length-1;d>=0;d--){let m=o.data.routePlan[d],p=r[d],y=m.inputMint===p.mintA.address;if(a.push(P({pubkey:new R(p.programId)})),d===0)a.push(P({pubkey:c[m.inputMint]}));else{let f=m.inputMint;if(c[f]===void 0){let b=$(e,new R(f),p.programId===At.CLMM_PROGRAM_ID.toBase58()||p.programId===At.CREATE_CPMM_POOL_PROGRAM.toBase58()?new R(y?p.mintA.programId:p.mintB.programId):Un).publicKey;c[f]=b}a.push(P({pubkey:c[f]}))}if(d===r.length-1)a.push(P({pubkey:c[m.outputMint]}));else{let f=m.outputMint;if(c[f]===void 0){let b=$(e,new R(f),p.programId===At.CLMM_PROGRAM_ID.toBase58()||p.programId===At.CREATE_CPMM_POOL_PROGRAM.toBase58()?new R(y?p.mintB.programId:p.mintA.programId):Un).publicKey;c[f]=b}a.push(P({pubkey:c[f]}))}if(a.push(P({pubkey:new R(m.inputMint)})),a.push(P({pubkey:new R(m.outputMint)})),p.programId===At.CLMM_PROGRAM_ID.toBase58()){let f=p;a.push(P({pubkey:new R(f.config.id)})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(y?f.vault.A:f.vault.B)})),a.push(P({pubkey:new R(y?f.vault.B:f.vault.A)})),a.push(P({pubkey:new R(f.observationId)})),a.push(P({pubkey:sn,isWritable:!1})),a.push(P({pubkey:new R(f.exBitmapAccount)})),s.push($a(m.lastPoolPriceX64,y));for(let b of m.remainingAccounts??[])a.push(P({pubkey:new R(b)}))}else if(p.programId===At.AMM_STABLE.toBase58()){let f=p;a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.authority),isWritable:!1})),a.push(P({pubkey:new R(f.marketProgramId),isWritable:!1})),a.push(P({pubkey:new R(f.marketAuthority),isWritable:!1})),a.push(P({pubkey:pr,isWritable:!1})),a.push(P({pubkey:new R(f.openOrders)})),a.push(P({pubkey:new R(f.vault.A)})),a.push(P({pubkey:new R(f.vault.B)})),a.push(P({pubkey:new R(f.marketId)})),a.push(P({pubkey:new R(f.marketBids)})),a.push(P({pubkey:new R(f.marketAsks)})),a.push(P({pubkey:new R(f.marketEventQueue)})),a.push(P({pubkey:new R(f.marketBaseVault)})),a.push(P({pubkey:new R(f.marketQuoteVault)}))}else if(p.programId===At.AMM_V4.toBase58()){let f=p;a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.authority),isWritable:!1})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.vault.A)})),a.push(P({pubkey:new R(f.vault.B)})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.id)}))}else if(p.programId===At.CREATE_CPMM_POOL_PROGRAM.toBase58()){let f=p;a.push(P({pubkey:new R(f.authority)})),a.push(P({pubkey:new R(f.config.id)})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(y?f.vault.A:f.vault.B)})),a.push(P({pubkey:new R(y?f.vault.B:f.vault.A)})),a.push(P({pubkey:new R(f.observationId)}))}else throw Error("pool type error")}let u=N([F("insId"),A("amountIn"),A("amountOut"),X(J(),s.length,"clmmPriceLimit")]),l=Buffer.alloc(u.span);return u.encode({insId:1,amountIn:new cn(o.data.otherAmountThreshold),amountOut:new cn(o.data.outputAmount),clmmPriceLimit:s},l),new _i({keys:a,programId:i,data:l})}var Bn=new Jr(0),Fi=class extends Ne{constructor(e){super(e)}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals(j));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n,txVersion:o=1,feePayer:r}=e,s=await this.getWSolAccounts(),a=this.createTxBuilder(r);a.addCustomComputeBudget(e.computeBudgetConfig);let c=Y(t);for(let u=0;u<s.length;u++)c.gte(s[u].amount)?(a.addInstruction({instructions:[An({tokenAccount:s[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),c.sub(s[u].amount)):a.addInstruction({instructions:[An({tokenAccount:s[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]});return a.versionBuild({txVersion:o})}async wrapWSol(e,t,n,o){let r=this.createTxBuilder(o),s=await En({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return r.addInstruction(s),r.versionBuild({txVersion:n??1})}async swap({swapInfo:e,swapPoolKeys:t,ownerInfo:n,computeBudgetConfig:o,routeProgram:r,txVersion:s,feePayer:a}){let c=this.createTxBuilder(a),u=e.amountIn,l=e.amountOut,d=u.amount.token.mint.equals(j),m=l.amount.token.mint.equals(j),p=u.amount.token.mint,y=l.amount.token.mint,{account:f,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.amount.token.isToken2022?$r:Xe,mint:p,notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!d,createInfo:d?{payer:this.scope.ownerPubKey,amount:u.amount.raw}:void 0,associatedOnly:d?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});if(b&&c.addInstruction(b),f===void 0)throw Error("input account check error");let g;if(e.routeType==="route"&&!m)g=this.scope.account.getAssociatedTokenAccount(y,l.amount.token.isToken2022?$r:Xe);else{let{account:x,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:l.amount.token.isToken2022?$r:Xe,mint:y,notUseTokenAccount:m,owner:this.scope.ownerPubKey,skipCloseAccount:!0,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:m?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});g=x,T&&c.addInstruction(T)}m&&c.addInstruction({endInstructions:[An({owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,tokenAccount:g,programId:Xe})],endInstructionTypes:[V.CloseAccount]});let w;if(e.routeType==="route"){let x=e.middleToken;w=this.scope.account.getAssociatedTokenAccount(x.mint,x.isToken2022?$r:Xe)}let k=t||await this.computePoolToPoolKeys({pools:e.poolInfoList}),h=Ul({routeProgram:r,inputMint:p,swapInfo:{...e,poolInfo:[...e.poolInfoList],poolKey:k,outputMint:y},ownerInfo:{wallet:this.scope.ownerPubKey,sourceToken:f,routeToken:w,destinationToken:g}});if(e.feeConfig!==void 0){let x=this.createTxBuilder();x.addInstruction({instructions:[Gl(f,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[V.TransferAmount]}),x.addInstruction(h);let{transactions:T}=s===0?await x.sizeCheckBuildV0():await x.sizeCheckBuild();T.length<2&&c.addInstruction({instructions:[Gl(f,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[V.TransferAmount]})}return c.addInstruction(h),s===0?c.sizeCheckBuildV0({computeBudgetConfig:o,address:h.address}):c.sizeCheckBuild({computeBudgetConfig:o,address:h.address})}async fetchRoutePoolBasicInfo(e){let{amm:t=Xo,clmm:n=On,cpmm:o=zo}=e||{},r=await this.scope.connection.getProgramAccounts(t,{dataSlice:{offset:to.offsetOf("baseMint"),length:64}}),s=N([L("baseMint"),L("quoteMint")]),a=r.map(p=>({id:p.pubkey,version:4,mintA:s.decode(p.account.data).baseMint,mintB:s.decode(p.account.data).quoteMint})),c=N([L("mintA"),L("mintB")]),l=(await this.scope.connection.getProgramAccounts(n,{filters:[{dataSize:Jn.span}],dataSlice:{offset:Jn.offsetOf("mintA"),length:64}})).map(p=>{let y=c.decode(p.account.data);return{id:p.pubkey,version:6,mintA:y.mintA,mintB:y.mintB}}),m=(await this.scope.connection.getProgramAccounts(o,{dataSlice:{offset:vi.offsetOf("mintA"),length:64}})).map(p=>{let y=c.decode(p.account.data);return{id:p.pubkey,version:7,mintA:y.mintA,mintB:y.mintB}});return{clmmPools:l,ammPools:a,cpmmPools:m}}getAllRoute({inputMint:e,outputMint:t,clmmPools:n,ammPools:o,cpmmPools:r}){e=e.toString()===uo.default.toString()?j:e,t=t.toString()===uo.default.toString()?j:t;let s={},a={},c={},u=[],l={};for(let m of n??[]){if((m.mintA.equals(e)&&m.mintB.equals(t)||m.mintA.equals(t)&&m.mintB.equals(e))&&(u.push(m),a[m.id.toString()]=m),m.mintA.equals(e)){let p=m.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[p].in.push(m)}if(m.mintB.equals(e)){let p=m.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[p].in.push(m)}if(m.mintA.equals(t)){let p=m.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[p].out.push(m)}if(m.mintB.equals(t)){let p=m.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[p].out.push(m)}}let d=[];for(let m of o)(m.mintA.equals(e)&&m.mintB.equals(t)||m.mintA.equals(t)&&m.mintB.equals(e))&&(u.push(m),s[m.id.toBase58()]=m,d.push(m)),m.mintA.equals(e)&&(l[m.mintB.toBase58()]===void 0&&(l[m.mintB.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[m.mintB.toBase58()].in.push(m)),m.mintB.equals(e)&&(l[m.mintA.toBase58()]===void 0&&(l[m.mintA.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[m.mintA.toBase58()].in.push(m)),m.mintA.equals(t)&&(l[m.mintB.toBase58()]===void 0&&(l[m.mintB.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[m.mintB.toBase58()].out.push(m)),m.mintB.equals(t)&&(l[m.mintA.toBase58()]===void 0&&(l[m.mintA.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[m.mintA.toBase58()].out.push(m));for(let m of r)(m.mintA.equals(e)&&m.mintB.equals(t)||m.mintA.equals(t)&&m.mintB.equals(e))&&(u.push(m),c[m.id.toBase58()]=m),m.mintA.equals(e)&&(l[m.mintB.toBase58()]===void 0&&(l[m.mintB.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[m.mintB.toBase58()].in.push(m)),m.mintB.equals(e)&&(l[m.mintA.toBase58()]===void 0&&(l[m.mintA.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[m.mintA.toBase58()].in.push(m)),m.mintA.equals(t)&&(l[m.mintB.toBase58()]===void 0&&(l[m.mintB.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[m.mintB.toBase58()].out.push(m)),m.mintB.equals(t)&&(l[m.mintA.toBase58()]===void 0&&(l[m.mintA.toBase58()]={mintProgram:Xe,in:[],out:[],mDecimals:0}),l[m.mintA.toBase58()].out.push(m));for(let m of Object.keys(l)){if(l[m].in.length===1&&l[m].out.length===1&&l[m].in[0].id.equals(l[m].out[0].id)){delete l[m];continue}if(l[m].in.length===0||l[m].out.length===0){delete l[m];continue}let p=l[m];for(let y of p.in)for(let f of p.out)y.version===6&&a[y.id.toString()]===void 0?a[y.id.toString()]=y:y.version===7&&c[y.id.toString()]===void 0?c[y.id.toString()]=y:(y.version===4||y.version===5)&&s[y.id.toString()]===void 0&&(s[y.id.toString()]=y),f.version===6&&a[f.id.toString()]===void 0?a[f.id.toString()]=f:f.version===7&&c[f.id.toString()]===void 0?c[f.id.toString()]=f:(f.version===4||f.version===5)&&s[f.id.toString()]===void 0&&(s[f.id.toString()]=f)}return{directPath:u,addLiquidityPools:d,routePathDict:l,needSimulate:Object.values(s),needTickArray:Object.values(a),cpmmPoolList:Object.values(c)}}async fetchSwapRoutesData({routes:e,inputMint:t,outputMint:n}){let o=new Set([...e.needTickArray.map(f=>[f.mintA.toBase58(),f.mintB.toBase58()]).flat(),t.toString(),n.toString()]);console.log("fetching amm pools info, total: ",e.needSimulate.length);let r=await this.scope.liquidity.getRpcPoolInfos(e.needSimulate.map(f=>f.id)),s=Wr(r),a={};Object.values(s).forEach(f=>{o.delete(f.mintA.address),a[f.mintA.address]={address:new uo(f.mintA.address),programId:Xe,mintAuthority:null,supply:BigInt(0),decimals:f.mintA.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0},o.delete(f.mintB.address),a[f.mintB.address]={address:new uo(f.mintB.address),programId:Xe,mintAuthority:null,supply:BigInt(0),decimals:f.mintB.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}}),console.log("fetching cpmm pools info, total: ",e.cpmmPoolList.length);let c=await this.scope.cpmm.getRpcPoolInfos(e.cpmmPoolList.map(f=>f.id.toBase58()),!0);Object.values(c).forEach(f=>{let[b,g]=[f.mintA.toBase58(),f.mintB.toBase58()];f.mintProgramA.equals(Xe)?(o.delete(b),a[b]={address:f.mintA,programId:f.mintProgramA,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalA,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):o.add(b),f.mintProgramB.equals(Xe)?(o.delete(g),a[g]={address:f.mintB,programId:f.mintProgramB,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalB,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):o.add(g)}),console.log("fetching mints info, total: ",o.size);let u=await mo({connection:this.scope.connection,mints:Array.from(o).map(f=>new uo(f))});a={...a,...u};let l=this.scope.cpmm.toComputePoolInfos({pools:c,mintInfos:a});console.log("fetching clmm pools info, total:",e.needTickArray.length);let d=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:e.needTickArray.map(f=>f.id)}),{computeClmmPoolInfo:m,computePoolTickData:p}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:d,mintInfos:a}),y=Object.keys(e.routePathDict).reduce((f,b)=>({...f,[b]:{...e.routePathDict[b],mintProgram:a[b].programId,mDecimals:a[b].decimals,in:e.routePathDict[b].in.map(g=>s[g.id.toBase58()]||m[g.id.toBase58()]||l[g.id.toBase58()]),out:e.routePathDict[b].out.map(g=>s[g.id.toBase58()]||m[g.id.toBase58()]||l[g.id.toBase58()])}}),{});return{mintInfos:a,ammPoolsRpcInfo:r,ammSimulateCache:s,clmmPoolsRpcInfo:d,computeClmmPoolInfo:m,computePoolTickData:p,computeCpmmData:l,routePathDict:y}}getAllRouteComputeAmountOut({inputTokenAmount:e,outputToken:t,directPath:n,routePathDict:o,simulateCache:r,tickCache:s,slippage:a,chainTime:c,epochInfo:u,feeConfig:l}){let d=l===void 0?new Jr(0):e.raw.mul(new Jr(l.feeBps.toNumber())).div(new Jr(1e4)),m=e.raw.sub(d),p=new Pe(e.token,m),y=l===void 0?void 0:{feeAmount:d,feeAccount:l.feeAccount},f={...t,address:pt(t.address).toString()},b=[];for(let g of n)try{b.push({...this.computeAmountOut({itemPool:g,tickCache:s,simulateCache:r,chainTime:c,epochInfo:u,slippage:a,outputToken:f,amountIn:p}),feeConfig:y})}catch(w){this.logDebug("direct error",g.version,g.id.toString(),w.message)}this.logDebug("direct done");for(let[g,w]of Object.entries(o)){let k={chainId:101,address:g,programId:w.mintProgram.toBase58(),logoURI:"",symbol:"",name:"",decimals:w.mDecimals,tags:[],extensions:{}},h=w.in.map(T=>{try{return{pool:T,data:this.computeAmountOut({itemPool:T,tickCache:s,simulateCache:r,chainTime:c,epochInfo:u,slippage:a,outputToken:k,amountIn:p})}}catch(B){this.logDebug("route in error",T.version,T.id.toString(),B.message);return}}).sort((T,B)=>{let S=T===void 0?Bn:T.data.amountOut.amount.raw.sub(T.data.amountOut.fee?.raw??Bn),I=B===void 0?Bn:B.data.amountOut.amount.raw.sub(B.data.amountOut.fee?.raw??Bn);return S.lt(I)?1:-1})[0];if(h===void 0)continue;let x=new Pe(Er(k),h.data.amountOut.amount.raw.sub(h.data.amountOut.fee?.raw??Bn));for(let T of w.out)try{let B=this.computeAmountOut({itemPool:T,tickCache:s,simulateCache:r,chainTime:c,epochInfo:u,slippage:a,outputToken:f,amountIn:x});b.push({...B,allTrade:!!(h.data.allTrade&&B.allTrade),amountIn:h.data.amountIn,amountOut:B.amountOut,minAmountOut:B.minAmountOut,currentPrice:void 0,executionPrice:new C(new it({baseToken:h.data.amountIn.amount.token,denominator:h.data.amountIn.amount.raw,quoteToken:B.amountOut.amount.token,numerator:B.amountOut.amount.raw.sub(B.amountOut.fee?.raw??Bn)}).toFixed()),priceImpact:new C(h.data.priceImpact.add(B.priceImpact).toFixed()),fee:[h.data.fee[0],B.fee[0]],routeType:"route",poolInfoList:[h.pool,T],remainingAccounts:[h.data.remainingAccounts[0],B.remainingAccounts[0]],minMiddleAmountFee:B.amountOut.fee?.raw?new Pe(h.data.amountOut.amount.token,(h.data.amountOut.fee?.raw??Bn).add(B.amountOut.fee?.raw??Bn)):void 0,middleToken:h.data.amountOut.amount.token,poolReady:h.data.poolReady&&B.poolReady,poolType:[h.data.poolType,B.poolType],feeConfig:y,expirationTime:Ht(h.data.expirationTime,B.expirationTime)})}catch(B){this.logDebug("route out error",T.version,T.id.toString(),B.message)}}return b.filter(g=>(g.allTrade||this.logDebug(`pool ${g.poolInfoList.map(w=>w.id.toString()).join(",")} filter out since not all trade`),g.allTrade)).sort((g,w)=>g.amountOut.amount.raw.sub(w.amountOut.amount.raw).gt(Bn)?-1:1)}computeAmountOut({itemPool:e,tickCache:t,simulateCache:n,chainTime:o,epochInfo:r,slippage:s,outputToken:a,amountIn:c}){if(e.version===6){let{allTrade:u,realAmountIn:l,amountOut:d,minAmountOut:m,expirationTime:p,currentPrice:y,executionPrice:f,priceImpact:b,fee:g,remainingAccounts:w,executionPriceX64:k}=Le.computeAmountOutFormat({poolInfo:e,tickArrayCache:t[e.id.toString()],amountIn:c.raw,tokenOut:a,slippage:s,epochInfo:r,catchLiquidityInsufficient:!0});return{allTrade:u,amountIn:l,amountOut:d,minAmountOut:m,currentPrice:new C(y.toFixed()),executionPrice:new C(f.toFixed()),priceImpact:new C(b.toFixed()),fee:[g],remainingAccounts:[w],routeType:"amm",poolInfoList:[e],poolReady:e.startTime<o,poolType:"CLMM",slippage:s,clmmExPriceX64:[k],expirationTime:Ht(l.expirationTime,p)}}else if(e.version===7){let{allTrade:u,executionPrice:l,amountOut:d,minAmountOut:m,priceImpact:p,fee:y}=this.scope.cpmm.computeSwapAmount({pool:e,outputMint:a.address,amountIn:c.raw,slippage:s});return{allTrade:u,amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:Ti({...a,amount:d}),fee:void 0,expirationTime:void 0},minAmountOut:{amount:Ti({...a,amount:m}),fee:void 0,expirationTime:void 0},currentPrice:e.poolPrice,executionPrice:l,priceImpact:p,fee:[new Pe(c.token,y)],remainingAccounts:[],routeType:"amm",poolInfoList:[e],poolReady:e.openTime.toNumber()<o,poolType:"CPMM",slippage:s,clmmExPriceX64:[void 0],expirationTime:void 0}}else{if(![1,6,7].includes(n[e.id.toString()].status))throw Error("swap error");let{amountOut:u,minAmountOut:l,currentPrice:d,executionPrice:m,priceImpact:p,fee:y}=this.scope.liquidity.computeAmountOut({poolInfo:n[e.id.toString()],amountIn:c.raw,mintIn:c.token.mint,mintOut:a.address,slippage:s});return{amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:Ti({...a,amount:u}),fee:void 0,expirationTime:void 0},minAmountOut:{amount:Ti({...a,amount:l}),fee:void 0,expirationTime:void 0},currentPrice:d,executionPrice:m,priceImpact:p,fee:[new Pe(c.token,y)],routeType:"amm",poolInfoList:[e],remainingAccounts:[],poolReady:Number(n[e.id].openTime)<o,poolType:e.version===5?"STABLE":void 0,expirationTime:void 0,allTrade:!0,slippage:s,clmmExPriceX64:[void 0]}}}async computePoolToPoolKeys({pools:e,clmmRpcData:t={},ammRpcData:n={}}){let o=new Set(e.filter(u=>u.version===6&&!t[u.id.toString()]).map(u=>u.id.toString()));if(o.size>0){let u=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:Array.from(o)});Object.keys(u).forEach(l=>{t[l]=u[l]})}let r=new Set(e.filter(u=>u.version===4&&!n[u.id.toString()]).map(u=>u.id.toString()));if(r.size>0){let u=await this.scope.liquidity.getRpcPoolInfos(Array.from(r));Object.keys(u).forEach(l=>{n[l]=u[l]})}let s=new Set(e.filter(u=>u.version===4).map(u=>u.marketId)),a={};s.size>0&&(await Ke(this.scope.connection,Array.from(s).map(l=>({pubkey:new uo(l)})))).forEach(l=>{if(!l.accountInfo)return;let d=ja.decode(l.accountInfo.data);a[l.pubkey.toBase58()]={marketId:l.pubkey.toString(),marketProgramId:l.accountInfo.owner.toString(),marketAuthority:Zr.getAssociatedAuthority({programId:l.accountInfo.owner,marketId:l.pubkey}).publicKey.toString(),marketBaseVault:d.baseVault.toString(),marketQuoteVault:d.quoteVault.toString(),marketBids:d.bids.toString(),marketAsks:d.asks.toString(),marketEventQueue:d.eventQueue.toString()}});let c=[];return e.forEach(u=>{if(u.version===6){let l=t[u.id.toString()],d={programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.startTime),vault:{A:l.vaultA.toBase58(),B:l.vaultB.toBase58()},config:{...u.ammConfig,id:u.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]},rewardInfos:[],observationId:u.observationId.toBase58(),exBitmapAccount:u.exBitmapAccount.toBase58()};c.push(d)}else if(u.version===4){let l=n[u.id.toString()],d={programId:u.programId,id:u.id,mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),vault:{A:l.baseVault.toBase58(),B:l.quoteVault.toBase58()},authority:Da({programId:new uo(u.programId)}).publicKey.toString(),openOrders:l.openOrders.toBase58(),targetOrders:l.targetOrders.toBase58(),mintLp:u.lpMint,...a[u.marketId]};c.push(d)}else u.version===7&&c.push({observationId:u.observationId.toBase58(),programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),authority:Ro(u.programId).publicKey.toBase58(),vault:{A:u.vaultA.toBase58(),B:u.vaultB.toBase58()},mintLp:gt({address:u.mintLp.toBase58(),programId:Xe.toBase58(),decimals:u.lpDecimals}),config:{id:u.configId.toBase58(),...u.configInfo,protocolFeeRate:u.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:u.configInfo.tradeFeeRate.toNumber(),fundFeeRate:u.configInfo.fundFeeRate.toNumber(),createPoolFee:u.configInfo.createPoolFee.toString()}})}),c}};import{PublicKey as Xy,Transaction as Ja,TransactionInstruction as Qy}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as zy}from"@solana/spl-token";import Xl from"bn.js";var Pt=class extends Ne{static getPdaPoolId(e,t){return te([Pt.SEED_CONFIG.pool.id,t.toBuffer()],e)}static getPdaOwnerId(e,t,n,o){return te([Pt.SEED_CONFIG.owner.id,t.toBuffer(),n.toBuffer(),Buffer.from(new Xl(o).toArray())],e)}static async getAllInfo({connection:e,programId:t,poolIds:n,wallet:o,chainTime:r}){if(n.length===0)return[];let s=n.map(l=>Pt.getPdaPoolId(t,l).publicKey),a=[];for(let l=0;l<Pt.VERSION_PROJECT.length;l++)a.push(...s.map(d=>Pt.getPdaOwnerId(t,d,o,l).publicKey));let c=await Dt(e,[...s,...a]),u=[];for(let l=0;l<c.length;l++){let d=Math.floor(l/n.length),m=l%n.length,p=s[m],y=a[l],f=c[m],b=c[n.length+l];if(!(f&&b)||f.data.length!==Pt.POOL_LAYOUT.span||b.data.length!==Pt.OWNER_LAYOUT.span)continue;let g=Pt.POOL_LAYOUT.decode(f.data),w=Pt.OWNER_LAYOUT.decode(b.data),k=g.openTime.toNumber(),h=g.endTime.toNumber(),x=w.tokenInfo.map(S=>S.debtAmount.gt(new Xl(0))).filter(S=>!S).length!==3,T=r>k&&r<h&&g.status===1,B=x&&T;u.push({programId:t,poolId:p,ammId:g.ammId,ownerAccountId:y,snapshotLpAmount:w.lpAmount,project:Pt.VERSION_PROJECT[d],openTime:k,endTime:h,canClaim:B,canClaimErrorType:x?T?void 0:"outOfOperationalTime":"alreadyClaimIt",tokenInfo:g.tokenInfo.map((S,I)=>({mintAddress:S.mintAddress,mintVault:S.mintVault,mintDecimals:S.mintDecimals,perLpLoss:S.perLpLoss,debtAmount:w.tokenInfo[I].debtAmount.add(w.tokenInfo[I].claimedAmount)}))})}return u}async makeClaimTransaction({poolInfo:e,ownerInfo:t,feePayer:n}){t.wallet||this.scope.checkOwner();let o=this.createTxBuilder(n),r=t.wallet||this.scope.ownerPubKey,s=[];for(let u of e.tokenInfo){let{account:l,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({mint:u.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:u.mintAddress.equals(Te.WSOL.mint),createInfo:{payer:r,amount:0},skipCloseAccount:!u.mintAddress.equals(Te.WSOL.mint),associatedOnly:u.mintAddress.equals(Te.WSOL.mint)?!1:t.associatedOnly});d&&o.addInstruction(d),s.push(l)}o.addInstruction({instructions:[Pt.makeClaimInstruction({programId:e.programId,poolInfo:e,ownerInfo:{wallet:r,ownerPda:e.ownerAccountId,claimAddress:s}})]});let{transaction:a,signers:c}=o.build();return[{transaction:a,signer:c}]}async makeClaimAllTransaction({poolInfos:e,ownerInfo:t,feePayer:n}){let o=this.createTxBuilder(n),r=t.wallet||this.scope.ownerPubKey,s={};for(let l of e){let d=[];for(let m of l.tokenInfo){let{account:p,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({mint:m.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:m.mintAddress.equals(Te.WSOL.mint),createInfo:{payer:r,amount:0},skipCloseAccount:!m.mintAddress.equals(Te.WSOL.mint),associatedOnly:m.mintAddress.equals(Te.WSOL.mint)?!1:t.associatedOnly});y&&o.addInstruction(y),p&&(s[m.mintAddress.toString()]=p,d.push(p))}o.addInstruction({instructions:[Pt.makeClaimInstruction({programId:l.programId,poolInfo:l,ownerInfo:{wallet:r,ownerPda:l.ownerAccountId,claimAddress:d}})]})}let{transaction:a,signers:c}=o.build(),u=o.allInstructions;return mr(u,[r,...c.map(l=>l.publicKey)])?[{transaction:a,signer:c}]:[{transaction:new Ja().add(...u.slice(0,o.AllTxData.instructions.length-1)),signer:c},{transaction:new Ja().add(...u.slice(o.AllTxData.instructions.length-1)),signer:[]},{transaction:new Ja().add(...o.AllTxData.endInstructions),signer:[]}]}static makeClaimInstruction({programId:e,poolInfo:t,ownerInfo:n}){let o=N([]),r=[{pubkey:n.wallet,isSigner:!0,isWritable:!0},{pubkey:t.poolId,isSigner:!1,isWritable:!0},{pubkey:n.ownerPda,isSigner:!1,isWritable:!0},...n.claimAddress.map(c=>({pubkey:c,isSigner:!1,isWritable:!0})),...t.tokenInfo.map(({mintVault:c})=>({pubkey:c,isSigner:!1,isWritable:!0})),{pubkey:zy,isSigner:!1,isWritable:!1}],s=Buffer.alloc(o.span);o.encode({},s);let a=Buffer.from([10,66,208,184,161,6,191,98,...s]);return new Qy({keys:r,programId:e,data:a})}},Wt=Pt;Rt(Wt,"CLAIMED_NUM",3),Rt(Wt,"POOL_LAYOUT",N([ke(8),F("bump"),F("status"),A("openTime"),A("endTime"),L("ammId"),X(N([F("mintDecimals"),L("mintAddress"),L("mintVault"),A("perLpLoss"),A("totalClaimedAmount")]),Pt.CLAIMED_NUM,"tokenInfo"),X(A(),10,"padding")])),Rt(Wt,"OWNER_LAYOUT",N([ke(8),F("bump"),F("version"),L("poolId"),L("owner"),A("lpAmount"),X(N([L("mintAddress"),A("debtAmount"),A("claimedAmount")]),Pt.CLAIMED_NUM,"tokenInfo"),X(A(),4,"padding")])),Rt(Wt,"DEFAULT_POOL_ID",["58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2","6UmmUiYoBjSrhakAobJw8BvkmJtDVxaeBtbt7rxWo1mg","AVs9TA4nWDzfPJE9gGVNJMVhcQy3V9PGazuz33BfG2RA","DVa7Qmb5ct9RCpaU7UTpSaf3GVMYz17vNVU67XpdCRut","7XawhbbxtsRcQA8KTkHT9f9nc6d69UwqCDh6U5EEbEmX","6a1CsrpeZubDjEJE9s1CMVheB6HWM5d7m1cj2jkhyXhj","EoNrn8iUhwgJySD1pHu8Qxm5gSQqLK3za4m8xzD2RuEb","AceAyRTWt4PyB2pHqf2qhDgNZDtKVNaxgL8Ru3V4aN1P","6tmFJbMk5yVHFcFy7X2K8RwHjKLr6KVFLYXpgpBNeAxB"].map(e=>new Xy(e))),Rt(Wt,"SEED_CONFIG",{pool:{id:Buffer.from("pool_seed","utf8")},owner:{id:Buffer.from("user_claim_seed","utf8")}}),Rt(Wt,"VERSION_PROJECT",[void 0,"Francium","Tulip","Larix"]);import{PublicKey as Wi}from"@solana/web3.js";import Ql from"bn.js";import{SYSVAR_CLOCK_PUBKEY as Hy,TransactionInstruction as tu}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as nu}from"@solana/spl-token";var eu=N([F("instruction"),mc("amount")]),Vi=N([F("instruction")]);function D0({programId:i,amount:e,instructionKeys:t}){let n=[{pubkey:rr,isSigner:!1,isWritable:!1},{pubkey:nu,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:Ss,isSigner:!1,isWritable:!1},...Object.entries(t).map(([r,s])=>({pubkey:s,isSigner:r==="userOwner",isWritable:!["authority","userOwner","userIdoCheck","userStakeInfo"].includes(r)}))],o=Buffer.alloc(eu.span);return eu.encode({instruction:1,amount:Number(e)},o),new tu({keys:n,programId:i,data:o})}function es({programId:i},e){let t=[{pubkey:nu,isSigner:!1,isWritable:!1},{pubkey:Ss,isSigner:!1,isWritable:!1},...Object.entries(e).map(([o,r])=>({pubkey:r,isSigner:o==="userOwner",isWritable:!["authority","userOwner"].includes(o)}))],n=Buffer.alloc(Vi.span);return Vi.encode({instruction:2},n),new tu({keys:t,programId:i,data:n})}function ou(i){let{poolConfig:e,userKeys:t,side:n}=i,o=n==="base"?t.baseTokenAccount:t.quoteTokenAccount,r=n==="base"?e.baseVault:e.quoteVault,s=Buffer.alloc(Vi.span);Vi.encode({instruction:2},s);let a=[{pubkey:nu,isWritable:!1,isSigner:!1},{pubkey:Hy,isWritable:!1,isSigner:!1},{pubkey:e.id,isWritable:!0,isSigner:!1},{pubkey:e.authority,isWritable:!1,isSigner:!1},{pubkey:r,isWritable:!0,isSigner:!1},{pubkey:o,isWritable:!0,isSigner:!1},{pubkey:t.ledgerAccount,isWritable:!0,isSigner:!1},{pubkey:t.owner,isWritable:!1,isSigner:!0}];return new tu({programId:e.programId,keys:a,data:s})}var jy={[Yo.IDO_PROGRAM_ID_V1.toString()]:1,[Yo.IDO_PROGRAM_ID_V2.toString()]:2,[Yo.IDO_PROGRAM_ID_V3.toString()]:3,[Yo.IDO_PROGRAM_ID_V4.toString()]:4},Oo=class extends Ne{async claim({ownerInfo:e,idoKeys:t,associatedOnly:n=!0,checkCreateATAOwner:o=!1,txVersion:r,feePayer:s}){let a=this.createTxBuilder(s),c=jy[t.programId];c||this.logAndCreateError("invalid version",c);let u=Re(t),[l,d]=[!new Ql(e.coin).isZero(),!new Ql(e.pc).isZero()],m=u.projectInfo.mint.address.equals(j),{account:p,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.projectInfo.mint.programId,mint:u.projectInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!m,notUseTokenAccount:m,associatedOnly:m?!1:n,checkCreateATAOwner:o});!p&&l&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),l&&y&&a.addInstruction(y);let f=u.buyInfo.mint.address.equals(j),{account:b,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.buyInfo.mint.programId,mint:u.buyInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!f,notUseTokenAccount:f,associatedOnly:f?!1:n,checkCreateATAOwner:o});if(!p&&d&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),d&&g&&a.addInstruction(g),(!p||!b)&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address,t.buyInfo.mint.address),c===3)return a.addInstruction({instructions:[...l?[es({programId:u.programId},{idoId:u.id,authority:u.authority,poolTokenAccount:u.projectInfo.vault,userTokenAccount:p,userIdoInfo:new Wi(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[],...d?[es({programId:new Wi(t.programId)},{idoId:u.id,authority:u.authority,poolTokenAccount:u.buyInfo.vault,userTokenAccount:b,userIdoInfo:new Wi(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[]]}).versionBuild({txVersion:r});if(c<3)return!l&&!d&&this.logAndCreateError("no claimable rewards"),a.addInstruction({instructions:[es({programId:u.programId},{idoId:u.id,authority:u.authority,poolQuoteTokenAccount:u.buyInfo.vault,poolBaseTokenAccount:u.projectInfo.vault,userQuoteTokenAccount:b,userBaseTokenAccount:p,userIdoInfo:new Wi(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]}).versionBuild({txVersion:r});let w={poolConfig:{id:u.id,programId:u.programId,authority:u.authority,baseVault:u.projectInfo.vault,quoteVault:u.buyInfo.vault,baseToken:t.projectInfo.mint,quoteToken:t.buyInfo.mint},userKeys:{baseTokenAccount:p,quoteTokenAccount:b,ledgerAccount:new Wi(e.userIdoInfo),owner:this.scope.ownerPubKey}};return a.addInstruction({instructions:[...l?[ou({...w,side:"base"})]:[],...d?[ou({...w,side:"quote"})]:[]]}).versionBuild({txVersion:r})}};var Yy=Buffer.from("vault_auth_seed","utf8"),Zy=Buffer.from("global_config","utf8"),$y=Buffer.from("pool","utf8"),Jy=Buffer.from("pool_vault","utf8"),eb=Buffer.from("pool_vesting","utf8"),tb=Buffer.from("platform_config","utf8");function co(i){return te([Yy],i)}function s1(i,e,t,n){return te([Zy,e.toBuffer(),nb(t),Or(n)],i)}function ts(i,e,t){return te([$y,e.toBuffer(),t.toBuffer()],i)}function iu(i,e,t){return te([Jy,e.toBuffer(),t.toBuffer()],i)}function nb(i){let e=new ArrayBuffer(1);return new DataView(e).setUint8(0,i),new Uint8Array(e)}function vo(i){return te([Buffer.from("__event_authority","utf8")],i)}function ru(i,e){return te([tb,e.toBuffer()],i)}function su(i,e,t){return te([eb,e.toBuffer(),t.toBuffer()],i)}import{SystemProgram as Di,TransactionInstruction as ln}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as zl}from"@solana/spl-token";import ns from"bn.js";var mn={initialize:Buffer.from([175,175,109,31,13,152,155,237]),buyExactIn:Buffer.from([250,234,13,123,213,156,19,236]),buyExactOut:Buffer.from([24,211,116,40,105,3,153,56]),sellExactIn:Buffer.from([149,39,222,155,211,124,152,26]),sellExactOut:Buffer.from([95,200,71,34,8,9,11,166]),createVestingAccount:Buffer.from([129,178,2,13,217,172,230,218]),claimVestedToken:Buffer.from([49,33,104,30,189,157,79,35]),createPlatformConfig:Buffer.from([176,90,196,175,253,113,220,20]),claimPlatformFee:Buffer.from([156,39,208,135,76,237,61,72]),updatePlaformConfig:Buffer.from([195,60,76,129,146,45,67,143])};function Hl(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x){let T=N([F("decimals"),$t("name"),$t("symbol"),$t("uri")]),B=N([A("totalLockedAmount"),A("cliffPeriod"),A("unlockPeriod")]),S=N([F("index"),A("supply"),A("totalFundRaisingB"),F("migrateType")]),I=N([F("index"),A("supply"),A("totalSellA"),A("totalFundRaisingB"),F("migrateType")]),K=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Gt,isSigner:!1,isWritable:!1},{pubkey:Di.programId,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:vo(i).publicKey,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1}],O=Buffer.alloc(Buffer.from(f,"utf-8").length+Buffer.from(b,"utf-8").length+Buffer.from(g,"utf-8").length+4*3+1),v=Buffer.alloc(B.span),_=Buffer.alloc(w.type==="ConstantCurve"?I.span:S.span);return T.encode({decimals:y,name:f,symbol:b,uri:g},O),w.type==="ConstantCurve"?I.encode({index:0,...w,migrateType:w.migrateType==="amm"?0:1},_):w.type==="FixedCurve"?S.encode({index:1,...w,migrateType:w.migrateType==="amm"?0:1},_):w.type==="LinearCurve"&&S.encode({index:2,...w,migrateType:w.migrateType==="amm"?0:1},_),B.encode({totalLockedAmount:k,cliffPeriod:h,unlockPeriod:x},v),new ln({keys:K,programId:i,data:Buffer.from([...mn.initialize,...O,..._,...v])})}function jl(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g){let w=N([A("amountB"),A("minAmountA"),A("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:vo(i).publicKey,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0}),console.log({amountB:y.toString(),minAmountA:f.toString()});let h=Buffer.alloc(w.span);return w.encode({amountB:y,minAmountA:f,shareFeeRate:b??new ns(0)},h),new ln({keys:k,programId:i,data:Buffer.from([...mn.buyExactIn,...h])})}function b1(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g){let w=N([A("amountA"),A("maxAmountB"),A("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:vo(i).publicKey,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let h=Buffer.alloc(w.span);return w.encode({amountA:y,maxAmountB:f,shareFeeRate:b??new ns(0)},h),new ln({keys:k,programId:i,data:Buffer.from([...mn.buyExactOut,...h])})}function Yl(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g){let w=N([A("amountA"),A("minAmountB"),A("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:vo(i).publicKey,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let h=Buffer.alloc(w.span);return w.encode({amountA:y,minAmountB:f,shareFeeRate:b??new ns(0)},h),new ln({keys:k,programId:i,data:Buffer.from([...mn.sellExactIn,...h])})}function g1(i,e,t,n,o,r,s,a,c,u,l,d,m,p,y,f,b,g){let w=N([A("amountB"),A("maxAmountA"),A("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:vo(i).publicKey,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let h=Buffer.alloc(w.span);return w.encode({amountB:y,maxAmountA:f,shareFeeRate:b??new ns(0)},h),new ln({keys:k,programId:i,data:Buffer.from([...mn.sellExactOut,...h])})}function Zl(i,e,t,n,o,r,s,a,c){let u=N([]),l=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:Di.programId,isSigner:!1,isWritable:!1},{pubkey:zl,isSigner:!1,isWritable:!1}],d=Buffer.alloc(u.span);return u.encode({},d),new ln({keys:l,programId:i,data:Buffer.from([...mn.claimVestedToken,...d])})}function $l(i,e,t,n,o,r){let s=N([A("shareAmount")]),a=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:Di.programId,isSigner:!1,isWritable:!1}],c=Buffer.alloc(s.span);return s.encode({shareAmount:r},c),new ln({keys:a,programId:i,data:Buffer.from([...mn.createVestingAccount,...c])})}function au(i,e,t,n,o,r,s,a,c){let u=[{pubkey:e,isSigner:!0,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Di.programId,isSigner:!1,isWritable:!0},{pubkey:zl,isSigner:!1,isWritable:!0}];return new ln({keys:u,programId:i,data:mn.claimPlatformFee})}function Jl(i,e,t,n,o,r,s,a,c,u,l){let d=N([A("platformScale"),A("creatorScale"),A("burnScale"),A("feeRate"),$t("name"),$t("web"),$t("img")]),m=[{pubkey:e,isSigner:!0,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:r,isSigner:!1,isWritable:!0},{pubkey:Di.programId,isSigner:!1,isWritable:!1}],p=Buffer.alloc(8*4+Buffer.from(c,"utf-8").length+Buffer.from(u,"utf-8").length+Buffer.from(l,"utf-8").length+4*3);return d.encode({platformScale:s.platformScale,creatorScale:s.creatorScale,burnScale:s.burnScale,feeRate:a,name:c,web:u,img:l},p),new ln({keys:m,programId:i,data:Buffer.from([...mn.createPlatformConfig,...p])})}function em(i,e,t,n){let o=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0}],r;if(n.type==="updateClaimFeeWallet"){let s=N([F("index"),L("value")]);r=Buffer.alloc(s.span),s.encode({index:0,value:n.value},r)}else if(n.type==="updateLockNftWallet"){let s=N([F("index"),L("value")]);r=Buffer.alloc(s.span),s.encode({index:1,value:n.value},r)}else if(n.type==="migrateCpLockNftScale"){let s=N([F("index"),A("platformScale"),A("creatorScale"),A("burnScale")]);r=Buffer.alloc(s.span),s.encode({index:2,...n.value},r)}else if(n.type==="updateFeeRate"){let s=N([F("index"),A("value")]);r=Buffer.alloc(s.span),s.encode({index:3,value:n.value},r)}else if(n.type==="updateImg"||n.type==="updateName"||n.type==="updateWeb"){let s=N([F("index"),$t("value")]);r=Buffer.alloc(Buffer.from(n.value,"utf-8").length+4+1*1),n.type==="updateName"?s.encode({index:4,value:n.value},r):n.type==="updateWeb"?s.encode({index:5,value:n.value},r):n.type==="updateImg"&&s.encode({index:6,value:n.value},r)}else if(n.type==="updateCpConfigId"){o.push({pubkey:n.value,isSigner:!1,isWritable:!1});let s=N([F("index")]);r=Buffer.alloc(s.span),s.encode({index:7},r)}else if(n.type==="updateAll"){console.log("Please note that this update will overwrite all data in the platform account with the new data."),o.push({pubkey:n.value.cpConfigId,isSigner:!1,isWritable:!1});let s=N([F("index"),L("platformClaimFeeWallet"),L("platformLockNftWallet"),A("platformScale"),A("creatorScale"),A("burnScale"),A("feeRate"),$t("name"),$t("web"),$t("img")]);r=Buffer.alloc(1+32+32+8*4+4*3+Buffer.from(n.value.name,"utf-8").length+Buffer.from(n.value.web,"utf-8").length+Buffer.from(n.value.img,"utf-8").length),s.encode({index:8,platformClaimFeeWallet:n.value.platformClaimFeeWallet,platformLockNftWallet:n.value.platformLockNftWallet,platformScale:n.value.migrateCpLockNftScale.platformScale,creatorScale:n.value.migrateCpLockNftScale.creatorScale,burnScale:n.value.migrateCpLockNftScale.burnScale,feeRate:n.value.feeRate,name:n.value.name,web:n.value.web,img:n.value.img},r)}else throw Error("updateInfo params type error");return new ln({keys:o,programId:i,data:Buffer.from([...mn.updatePlaformConfig,...r])})}import{NATIVE_MINT as as,TOKEN_PROGRAM_ID as Ct,createAssociatedTokenAccountIdempotentInstruction as Gi}from"@solana/spl-token";import pe from"bn.js";import{PublicKey as nm}from"@solana/web3.js";var Mo=N([A(),A("epoch"),F("curveType"),Zt("index"),A("migrateFee"),A("tradeFeeRate"),A("maxShareFeeRate"),A("minSupplyA"),A("maxLockRate"),A("minSellRateA"),A("minMigrateRateA"),A("minFundRaisingB"),L("mintB"),L("protocolFeeOwner"),L("migrateFeeOwner"),L("migrateToAmmWallet"),L("migrateToCpmmWallet"),X(A(),16)]),ob=N([A("totalLockedAmount"),A("cliffPeriod"),A("unlockPeriod"),A("startTime"),A("totalAllocatedShare")]),xn=N([A(),A("epoch"),F("bump"),F("status"),F("mintDecimalsA"),F("mintDecimalsB"),F("migrateType"),A("supply"),A("totalSellA"),A("virtualA"),A("virtualB"),A("realA"),A("realB"),A("totalFundRaisingB"),A("protocolFee"),A("platformFee"),A("migrateFee"),ob.replicate("vestingSchedule"),L("configId"),L("platformId"),L("mintA"),L("mintB"),L("vaultA"),L("vaultB"),L("creator"),X(A(),8)]),w1=N([A(),A("epoch"),L("poolId"),L("beneficiary"),A("claimedAmount"),A("tokenShareAmount"),X(A(),8)]),os=N([A(),A("epoch"),L("platformClaimFeeWallet"),L("platformLockNftWallet"),A("platformScale"),A("creatorScale"),A("burnScale"),A("feeRate"),X(F(),64,"name"),X(F(),256,"web"),X(F(),256,"img"),L("cpConfigId"),X(F(),224)]);import dn from"bn.js";import qi from"bn.js";var Gn=class{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){throw Error()}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:r,decimalA:s,decimalB:a}){throw Error()}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:r}){throw Error()}static buyExactIn({poolInfo:e,amount:t}){throw Error()}static buyExactOut({poolInfo:e,amount:t}){throw Error()}static sellExactIn({poolInfo:e,amount:t}){throw Error()}static sellExactOut({poolInfo:e,amount:t}){throw Error()}};var is=class extends Gn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){return new C(t.toString()).div(e.toString()).mul(10**(n-o))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualB.add(e.realB).toString()).div(e.virtualA.sub(e.realA).toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:r,decimalA:s,decimalB:a}){return new C(o.sub(r).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let o=e.totalSellA.sub(e.realA),r=e.totalFundRaisingB.sub(e.realB);return new C(e.virtualB.add(e.realB.add(r)).toString()).div(e.virtualA.sub(e.realA.add(o)).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:r}){if(e.lte(n))throw Error("supply need gt total sell");let s=e.sub(n).sub(o);if(s.lte(new qi(0)))throw Error("supplyMinusSellLocked <= 0");let a=t.sub(r);if(a.lte(new qi(0)))throw Error("tfMinusMf <= 0");let c=a.mul(n).mul(n).div(s),u=a.mul(n).div(s).sub(t);if(u.lt(new qi(0)))throw Error("supply/totalSell/totalLockedAmount diff too high");let l=c.div(u),d=t.mul(t).div(u);if(l.lt(new qi(0))||d.lt(new qi(0)))throw Error("invalid input 0");return{a:l,b:d,c:n}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static getAmountOut({amountIn:e,inputReserve:t,outputReserve:n}){let o=e.mul(n),r=t.add(e);return o.div(r)}static getAmountIn({amountOut:e,inputReserve:t,outputReserve:n}){let o=t.mul(e),r=n.sub(e);return fr(o,r)}};import tm from"bn.js";var rs=class extends Gn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){return new C(t.toString()).div(e.toString()).mul(10**(n-o))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:r,decimalA:s,decimalB:a}){return new C(o.sub(r).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let o=e.totalSellA.sub(e.realA),r=e.totalFundRaisingB.sub(e.realB);return new C(e.virtualB.add(e.realB).add(r).toString()).div(e.virtualA.sub(e.realA).add(o).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:r}){let s=e.sub(o);if(s.lte(new tm(0)))throw Error("invalid input 1");let a=new tm(2).mul(t).sub(r),u=t.mul(s).div(a);return{a:u,b:t,c:u}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualB,initOutput:e.virtualA})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualB,initOutput:e.virtualA})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualA,initOutput:e.virtualB})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualA,initOutput:e.virtualB})}static getAmountOut({amountIn:e,initInput:t,initOutput:n}){return n.mul(e).div(t)}static getAmountIn({amountOut:e,initInput:t,initOutput:n}){let o=t.mul(e);return fr(o,n)}};import Kt from"bn.js";import Eo from"bn.js";var Ui=class{static _multipler(e){return new C(10).pow(e)}static getPrice({priceX64:e,decimalA:t,decimalB:n}){return new C(e.toString()).div(this._Q64).mul(this._multipler(t)).div(this._multipler(n))}static getPriceX64({price:e,decimalA:t,decimalB:n}){let o=e.mul(this._multipler(n)).div(this._multipler(t));return new Eo(o.mul(this._Q64).toFixed(0))}};Rt(Ui,"_Q64",new C(new Eo(1).shln(64).toString()));function F1({supply:i,totalFundRaisingB:e,totalLockedAmount:t,totalSellA:n,migrateType:o,decimalsA:r}){let s=i.sub(n).sub(t),a=new Eo(new C(s.mul(e).toString()).sqrt().toFixed(0));if(o==="amm"){if(a.gt(new Eo(10).pow(new Eo(r))))return!0}else if(o==="cpmm"){if(a.gt(new Eo(100)))return!0}else throw Error("migrate type error");return!1}var ss=class extends Gn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new C(0)}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){return new C(0)}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualA.mul(e.realA).toString()).div(Ui._Q64).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:r,decimalA:s,decimalB:a}){return new C(o.sub(r).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let o=e.totalSellA.sub(e.realA),r=e.totalFundRaisingB.sub(e.realB);return new C(e.virtualB.add(e.realB).add(r).toString()).div(e.virtualA.sub(e.realA).add(o).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:r}){let s=e.sub(o);if(s.lte(new Kt(0)))throw Error("supplyMinusLocked need gt 0");let a=t.mul(new Kt(3)).sub(r),u=t.mul(new Kt(2)).mul(s).div(a),l=u.mul(u),d=t.mul(new Kt(2)).mul(Ye).div(l);if(!d.gt(new Kt(0)))throw Error("a need gt 0");if(!pi.gt(d))throw Error("a need lt u64 max");return{a:d,b:new Kt(0),c:u}}static buyExactIn({poolInfo:e,amount:t}){let n=e.realB.add(t),o=new Kt(2).mul(n).mul(Ye).div(e.virtualA);return new Kt(new C(o.toString()).sqrt().toFixed(0)).sub(e.realA)}static buyExactOut({poolInfo:e,amount:t}){let n=e.realA.add(t),o=n.mul(n),{div:r,mod:s}=e.virtualA.mul(o).divmod(new Kt(2).mul(Ye));return(s.isZero()?r:r.add(new Kt(1))).sub(e.realB)}static sellExactIn({poolInfo:e,amount:t}){let n=e.realA.sub(t),o=n.mul(n),{div:r,mod:s}=e.virtualA.mul(o).divmod(new Kt(2).mul(Ye)),a=s.isZero()?r:r.add(new Kt(1));return e.realB.sub(a)}static sellExactOut({poolInfo:e,amount:t}){let n=e.realB.sub(t),o=new Kt(2).mul(n).mul(Ye).div(e.virtualA),r=new Kt(new C(o.toString()).sqrt().toFixed(0));return e.realA.sub(r)}};var pn=class{static getPoolCurvePointByPoolInfo({curveType:e,pointCount:t,poolInfo:n}){return this.getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n.supply,totalFundRaising:n.totalFundRaisingB,totalSell:n.totalSellA,totalLockedAmount:n.vestingSchedule.totalLockedAmount,migrateFee:n.migrateFee,decimalA:n.mintDecimalsA,decimalB:n.mintDecimalsB})}static getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n,totalFundRaising:o,totalSell:r,totalLockedAmount:s,migrateFee:a,decimalA:c,decimalB:u}){if(t<3)throw Error("point count < 3");let l=this.getCurve(e),d=l.getInitParam({supply:n,totalFundRaising:o,totalSell:r,totalLockedAmount:s,migrateFee:a}),m=l.getPoolInitPriceByInit({...d,decimalA:c,decimalB:u}),p=o.div(new dn(t-1)),y=new dn(0),f=[{price:m,totalSellSupply:0}],{a:b,b:g}=d,w=y,k=y;for(let h=1;h<t;h++){let x=h!==t-1?p:o.sub(k),T=this.buyExactIn({poolInfo:{virtualA:b,virtualB:g,realA:w,realB:k,totalFundRaisingB:o,totalSellA:r},amountB:x,protocolFeeRate:y,platformFeeRate:y,curveType:e,shareFeeRate:y});w=w.add(T.amountA),k=k.add(T.amountB);let B=this.getPrice({poolInfo:{virtualA:b,virtualB:g,realA:w,realB:k},decimalA:c,decimalB:u,curveType:e});f.push({price:B,totalSellSupply:new C(w.toString()).div(10**c).toNumber()})}return f}static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n,curveType:o}){return this.getCurve(o).getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n})}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o,curveType:r}){return this.getCurve(r).getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o})}static getPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:o}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:o})}static getEndPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:o}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:o})}static getPoolEndPriceReal({poolInfo:e,curveType:t,decimalA:n,decimalB:o}){return this.getCurve(t).getPoolEndPriceReal({poolInfo:e,decimalA:n,decimalB:o})}static checkParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,decimals:r,config:s,migrateType:a}){if(Number(r)!==6)throw Error("decimals = 6");if(e.mul(s.maxLockRate).div(jt).lt(o))throw Error("total lock amount gte max lock amount");if(e.lt(s.minSupplyA.mul(new dn(10**r))))throw Error("supply lt min supply");let u=e.mul(s.minSellRateA).div(jt);if(n.lt(u))throw Error("invalid input");if(t.lt(s.minFundRaisingB))throw Error("total fund raising lt min fund raising");let l=e.sub(n).sub(o),d=e.mul(s.minMigrateRateA).div(jt);if(l.lt(d))throw Error("migrate lt min migrate amount");let m=e.sub(n).sub(o),p=new dn(new C(m.mul(t).toString()).sqrt().toFixed(0));if(a==="amm"){let y=new dn(10).pow(new dn(r));if(p.lte(y))throw Error("check migrate lp error")}else if(a==="cpmm"){let y=new dn(100);if(p.lte(y))throw Error("check migrate lp error")}else throw Error("migrate type error")}static buyExactIn({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:o,curveType:r,shareFeeRate:s}){let a=n.add(s).add(o),c=this.calculateFee({amount:t,feeRate:a}),u=t.sub(c),l=this.getCurve(r),d=l.buyExactIn({poolInfo:e,amount:u}),m=e.totalSellA.sub(e.realA),p,y,f;if(d.gt(m)){p=m;let g=l.buyExactOut({poolInfo:e,amount:p});y=this.calculatePreFee({postFeeAmount:g,feeRate:a}),f=y.sub(g)}else p=d,y=t,f=c;let b=this.splitFee({totalFee:f,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:p,amountB:y,splitFee:b}}static buyExactOut({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:o,curveType:r,shareFeeRate:s}){let a=e.totalSellA.sub(e.realA),c=t;t.gt(a)&&(c=a);let l=this.getCurve(r).buyExactOut({poolInfo:e,amount:t}),d=n.add(s).add(o),m=this.calculatePreFee({postFeeAmount:l,feeRate:d}),p=m.sub(l),y=this.splitFee({totalFee:p,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:c,amountB:m,splitFee:y}}static sellExactIn({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:o,curveType:r,shareFeeRate:s}){let c=this.getCurve(r).sellExactIn({poolInfo:e,amount:t}),u=this.calculateFee({amount:c,feeRate:n.add(s).add(o)}),l=this.splitFee({totalFee:u,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:t,amountB:c.sub(u),splitFee:l}}static sellExactOut({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:o,curveType:r,shareFeeRate:s}){let a=n.add(s).add(o),c=this.calculatePreFee({postFeeAmount:t,feeRate:a});if(e.realB.lt(c))throw Error("Insufficient liquidity");let u=c.sub(t),d=pn.getCurve(r).sellExactOut({poolInfo:e,amount:c});if(d.gt(e.realA))throw Error();let m=this.splitFee({totalFee:u,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:d,amountB:t,splitFee:m}}static splitFee({totalFee:e,protocolFeeRate:t,platformFeeRate:n,shareFeeRate:o}){let r=t.add(n).add(o),s=r.isZero()?new dn(0):e.mul(n).div(r),a=r.isZero()?new dn(0):e.mul(o).div(r),c=e.sub(s).sub(a);return{platformFee:s,shareFee:a,protocolFee:c}}static calculateFee({amount:e,feeRate:t}){return ar(e,t,jt)}static calculatePreFee({postFeeAmount:e,feeRate:t}){if(t.isZero())return e;let n=e.mul(jt),o=jt.sub(t);return n.add(o).sub(new dn(1)).div(o)}static getCurve(e){switch(e){case 0:return is;case 1:return rs;case 2:return ss}throw Error("find curve error")}};var lo={initPriceX64:new pe("515752397214619"),supply:new pe(1e15),totalSellA:new pe(7931e11),totalFundRaisingB:new pe(85e9),totalLockedAmount:new pe("0"),cliffPeriod:new pe("0"),unlockPeriod:new pe("0"),decimals:6,virtualA:new pe("1073471847374405"),virtualB:new pe("30050573465"),realA:new pe(0),realB:new pe(0),protocolFee:new pe(0),platformId:new nm("4Bu96XjU84XjPDSpveTVf6LYGCkfW5FK7SNkREWcEfV4"),vestingSchedule:{totalLockedAmount:new pe(0),cliffPeriod:new pe(0),unlockPeriod:new pe(0),startTime:new pe(0),totalAllocatedShare:new pe(0)}},us=new pe(1e4),Xi=class extends Ne{constructor(e){super(e)}async createLaunchpad({programId:e=Qt,authProgramId:t,platformId:n=lo.platformId,mintA:o,decimals:r=6,mintBDecimals:s=9,name:a,symbol:c,uri:u,migrateType:l,configId:d,configInfo:m,platformFeeRate:p,txVersion:y,computeBudgetConfig:f,txTipConfig:b,feePayer:g,buyAmount:w,minMintAAmount:k,slippage:h,associatedOnly:x=!0,checkCreateATAOwner:T=!1,extraSigners:B,...S}){let I=this.createTxBuilder(g);t=t??co(e).publicKey;let K=m;if(!K&&d){let dt=await this.scope.connection.getAccountInfo(d);dt&&(K=Mo.decode(dt.data))}K||this.logAndCreateError("config not found");let O=K.mintB,v=K.curveType,{publicKey:_}=ts(e,o,O),{publicKey:D}=iu(e,_,o),{publicKey:q}=iu(e,_,O),{publicKey:G}=kn(o);console.log(`create token: ${o.toBase58()}, mintB: ${O.toBase58()}, decimals A:${r}/B:${s}, config:${d.toBase58()}`),c.length>10&&this.logAndCreateError("Symbol length should shorter than 11"),u||this.logAndCreateError("uri should not empty"),w.lte(new pe(0))&&this.logAndCreateError("buy amount should gt 0:",w.toString());let Z=S?.supply??lo.supply,ie=S?.totalSellA??lo.totalSellA,he=S?.totalFundRaisingB??lo.totalFundRaisingB,re=S?.totalLockedAmount??new pe(0),Ae=p;if(!p){let dt=await this.scope.connection.getAccountInfo(n);dt||this.logAndCreateError("platform id not found:",n.toString()),Ae=os.decode(dt.data).feeRate}let mt=pn.getCurve(K.curveType).getInitParam({supply:Z,totalFundRaising:he,totalSell:ie,totalLockedAmount:re,migrateFee:K.migrateFee}),et={epoch:new pe(896),bump:254,status:0,mintDecimalsA:r,mintDecimalsB:s,supply:Z,totalSellA:ie,mintA:new nm(o),mintB:O,virtualA:mt.a,virtualB:mt.b,realA:lo.realA,realB:lo.realB,migrateFee:K.migrateFee,migrateType:l==="amm"?0:1,protocolFee:lo.protocolFee,platformFee:Ae,platformId:n,configId:d,vaultA:D,vaultB:q,creator:this.scope.ownerPubKey,totalFundRaisingB:he,vestingSchedule:{totalLockedAmount:re,cliffPeriod:new pe(0),unlockPeriod:new pe(0),startTime:new pe(0),totalAllocatedShare:new pe(0)}},Tt=pn.getCurve(K.curveType),{c:Lt}=Tt.getInitParam({supply:et.supply,totalFundRaising:et.totalFundRaisingB,totalLockedAmount:re,totalSell:K.curveType===0?et.totalSellA:new pe(0),migrateFee:K.migrateFee});try{pn.checkParam({supply:et.supply,totalFundRaising:et.totalFundRaisingB,totalSell:Lt,totalLockedAmount:re,decimals:et.mintDecimalsA,config:K,migrateType:l}),console.log("check init params success")}catch(dt){this.logAndCreateError(`check create mint params failed, ${dt.message}`)}I.addInstruction({instructions:[Hl(e,g??this.scope.ownerPubKey,this.scope.ownerPubKey,d,n,t,_,o,O,D,q,G,Ct,Ct,r,a,c,u||"https://",{type:v===0?"ConstantCurve":v===1?"FixedCurve":v===2?"LinearCurve":"ConstantCurve",totalSellA:ie,migrateType:l,supply:Z,totalFundRaisingB:he},re,S?.cliffPeriod??new pe(0),S?.unlockPeriod??new pe(0))]});let tn=new pe(0),fn;if(B?.length&&I.addInstruction({signers:B}),!S.createOnly){let{builder:dt,extInfo:tt}=await this.buyToken({programId:e,authProgramId:t,mintA:o,mintB:O,poolInfo:et,buyAmount:w,minMintAAmount:k,shareFeeRate:S.shareFeeRate,shareFeeReceiver:S.shareFeeReceiver,configInfo:K,platformFeeRate:Ae,slippage:h,associatedOnly:x,checkCreateATAOwner:T});I.addInstruction({...dt.AllTxData}),tn=tt.outAmount,fn=(this.scope.cluster==="devnet"||y===1)&&S.shareFeeReceiver?[dt.allInstructions[0]]:void 0}return I.addTipInstruction(b),y===0?I.sizeCheckBuildV0({computeBudgetConfig:f,outAmount:tn,splitIns:fn,address:{...et,poolId:_}}):I.sizeCheckBuild({computeBudgetConfig:f,outAmount:tn,splitIns:fn,address:{...et,poolId:_}})}async buyToken({programId:e=Qt,authProgramId:t,mintA:n,mintB:o=as,poolInfo:r,configInfo:s,platformFeeRate:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:d,buyAmount:m,minMintAAmount:p,slippage:y,shareFeeRate:f=new pe(0),shareFeeReceiver:b,associatedOnly:g=!0,checkCreateATAOwner:w=!1}){m.lte(new pe(0))&&this.logAndCreateError("buy amount should gt 0:",m.toString());let k=this.createTxBuilder(d),{publicKey:h}=ts(e,n,o);t=t??co(e).publicKey;let x=null,T=null,B=o.equals(as),{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:n,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:g,checkCreateATAOwner:w});S&&(x=S),k.addInstruction(I||{}),x===void 0&&this.logAndCreateError(`cannot found mintA(${n.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let{account:K,instructionParams:O}=await this.scope.account.getOrCreateTokenAccount({mint:o,owner:this.scope.ownerPubKey,createInfo:B?{payer:this.scope.ownerPubKey,amount:m}:void 0,skipCloseAccount:!B,notUseTokenAccount:B,associatedOnly:B?!1:g,checkCreateATAOwner:w});K&&(T=K),k.addInstruction(O||{}),T===void 0&&this.logAndCreateError(`cannot found mintB(${o.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let v=r;if(!v){let re=await this.scope.connection.getAccountInfo(h,{commitment:"processed"});re||this.logAndCreateError("cannot found pool:",h.toBase58()),v=xn.decode(re.data)}let _=s,D=await Ke(this.scope.connection,[_?void 0:v.configId,a?void 0:v.platformId].filter(Boolean).map(re=>({pubkey:re})));if(!_){let re=D.find(Ae=>Ae.pubkey.equals(v.configId));(!re||!re.accountInfo)&&this.logAndCreateError("config not found: ",v.configId.toBase58()),_=Mo.decode(re.accountInfo.data)}if(!a){let re=D.find(Ae=>Ae.pubkey.equals(v.platformId));(!re||!re.accountInfo)&&this.logAndCreateError("platform info not found: ",v.configId.toBase58()),a=os.decode(re.accountInfo.data).feeRate}let q=pn.buyExactIn({poolInfo:v,amountB:m,protocolFeeRate:_.tradeFeeRate,platformFeeRate:a,curveType:_.curveType,shareFeeRate:f}),G=new C(q.amountA.toString()),Z=y?new C(us.sub(y).toNumber()/us.toNumber()).clampedTo(0,1):new C(1),ie=p??(y?new pe(G.mul(Z).toFixed(0)):q.amountA);q.amountB.lt(m)&&console.log(`maximum ${n.toBase58()} amount can buy is ${q.amountA.toString()}, input ${o.toBase58()} amount: ${q.amountB.toString()}`);let he=b?$(b,o,Ct).publicKey:void 0;return he&&k.addInstruction({instructions:[Gi(this.scope.ownerPubKey,he,b,o)]}),k.addInstruction({instructions:[jl(e,this.scope.ownerPubKey,t,v.configId,v.platformId,h,x,T,v.vaultA,v.vaultB,n,o,Ct,Ct,q.amountB.lt(m)?q.amountB:m,ie,f,he)]}),k.addCustomComputeBudget(u),k.addTipInstruction(l),k.versionBuild({txVersion:c,extInfo:{outAmount:ie}})}async sellToken({programId:e=Qt,authProgramId:t,mintA:n,mintB:o=as,poolInfo:r,configInfo:s,platformFeeRate:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:d,sellAmount:m,minAmountB:p,slippage:y,shareFeeRate:f=new pe(0),shareFeeReceiver:b,associatedOnly:g=!0,checkCreateATAOwner:w=!1}){t=t??co(e).publicKey;let k=this.createTxBuilder(d);m.lte(new pe(0))&&this.logAndCreateError("sell amount should be gt 0");let{publicKey:h}=ts(e,n,o),x=null,T=null,B=o.equals(as),{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:n,owner:this.scope.ownerPubKey,createInfo:void 0,skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:g,checkCreateATAOwner:w});S&&(x=S),k.addInstruction(I||{}),x===void 0&&this.logAndCreateError("cannot found mintA token accounts","tokenAccounts",this.scope.account.tokenAccounts);let{account:K,instructionParams:O}=await this.scope.account.getOrCreateTokenAccount({mint:o,owner:this.scope.ownerPubKey,createInfo:B?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!B,notUseTokenAccount:B,associatedOnly:B?!1:g,checkCreateATAOwner:w});K&&(T=K),k.addInstruction(O||{}),T===void 0&&this.logAndCreateError("cannot found mintB token accounts","tokenAccounts",this.scope.account.tokenAccounts);let v=r;if(!v){let re=await this.scope.connection.getAccountInfo(h,{commitment:"processed"});re||this.logAndCreateError("cannot found pool",h.toBase58()),v=xn.decode(re.data)}let _=s,D=await Ke(this.scope.connection,[_?void 0:v.configId,a?void 0:v.platformId].filter(Boolean).map(re=>({pubkey:re})));if(!_){let re=D.find(Ae=>Ae.pubkey.equals(v.configId));(!re||!re.accountInfo)&&this.logAndCreateError("config not found: ",v.configId.toBase58()),_=Mo.decode(re.accountInfo.data)}if(!a){let re=D.find(Ae=>Ae.pubkey.equals(v.platformId));(!re||!re.accountInfo)&&this.logAndCreateError("platform info not found: ",v.configId.toBase58()),a=os.decode(re.accountInfo.data).feeRate}let q=pn.sellExactIn({poolInfo:v,amountA:m,protocolFeeRate:_.tradeFeeRate,platformFeeRate:a,curveType:_.curveType,shareFeeRate:f}),G=new C(q.amountB.toString()),Z=y?new C(us.sub(y).toNumber()/us.toNumber()).clampedTo(0,1):new C(1),ie=p??(y?new pe(G.mul(Z).toFixed(0)):q.amountB);ie.lte(new pe(0))&&this.logAndCreateError(`out ${o.toBase58()} amount should be gt 0`);let he=b?$(b,o,Ct).publicKey:void 0;return he&&k.addInstruction({instructions:[Gi(this.scope.ownerPubKey,he,b,o)]}),k.addInstruction({instructions:[Yl(e,this.scope.ownerPubKey,t,v.configId,v.platformId,h,x,T,v.vaultA,v.vaultB,n,o,Ct,Ct,q.amountA.lt(m)?q.amountA:m,ie,f,he)]}),k.addCustomComputeBudget(u),k.addTipInstruction(l),k.versionBuild({txVersion:c,extInfo:{outAmount:ie}})}async createPlatformConfig({programId:e=Qt,platformAdmin:t,platformClaimFeeWallet:n,platformLockNftWallet:o,cpConfigId:r,migrateCpLockNftScale:s,feeRate:a,name:c,web:u,img:l,txVersion:d,computeBudgetConfig:m,txTipConfig:p,feePayer:y}){let f=this.createTxBuilder(y),{publicKey:b}=ru(e,t);return f.addInstruction({instructions:[Jl(e,t,n,o,b,r,s,a,c,u,l)]}),f.addCustomComputeBudget(m),f.addTipInstruction(p),f.versionBuild({txVersion:d,extInfo:{platformId:b}})}async updatePlatformConfig({programId:e=Qt,platformAdmin:t,platformId:n,updateInfo:o,txVersion:r,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l=n??ru(e,t).publicKey;return u.addInstruction({instructions:[em(e,t,l,o)]}),u.addCustomComputeBudget(s),u.addTipInstruction(a),u.versionBuild({txVersion:r})}async claimPlatformFee({programId:e=Qt,authProgramId:t,platformId:n,poolId:o,platformClaimFeeWallet:r,mintB:s,vaultB:a,mintBProgram:c=Ct,txVersion:u,computeBudgetConfig:l,txTipConfig:d,feePayer:m}){let p=this.createTxBuilder(m);t=t??co(e).publicKey;let y=s,f=a;if(!y){let g=await this.scope.connection.getAccountInfo(o,{commitment:"processed"});g||this.logAndCreateError("cannot found pool:",o.toBase58());let w=xn.decode(g.data),k=await this.scope.connection.getAccountInfo(w.configId,{commitment:"processed"});k||this.logAndCreateError("cannot found config:",w.configId.toBase58()),y=Mo.decode(k.data).mintB,f=f??w.vaultB}(!y||!f)&&this.logAndCreateError("cannot found mint info, mintB: ",y.toBase58(),", vaultB: ",f?.toBase58()??"");let b=$(this.scope.ownerPubKey,y,Ct).publicKey;return p.addInstruction({instructions:[Gi(this.scope.ownerPubKey,b,this.scope.ownerPubKey,y)]}),p.addInstruction({instructions:[au(e,r,t,o,n,f,b,y,c)]}),p.addCustomComputeBudget(l),p.addTipInstruction(d),p.versionBuild({txVersion:u})}async claimAllPlatformFee({programId:e=Qt,authProgramId:t,platformId:n,platformClaimFeeWallet:o,txVersion:r,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c);return t=t??co(e).publicKey,(await this.scope.connection.getProgramAccounts(e,{filters:[{dataSize:xn.span},{memcmp:{offset:xn.offsetOf("platformId"),bytes:n.toString()}}]})).forEach(d=>{let m=xn.decode(d.account.data),p=$(this.scope.ownerPubKey,m.mintB,Ct).publicKey;u.addInstruction({instructions:[Gi(this.scope.ownerPubKey,p,this.scope.ownerPubKey,m.mintB)]}),u.addInstruction({instructions:[au(e,o,t,d.pubkey,n,m.vaultB,p,m.mintB,Ct)]})}),u.addTipInstruction(a),r===0?u.sizeCheckBuildV0({computeBudgetConfig:s}):u.sizeCheckBuild({computeBudgetConfig:s})}async createVesting({programId:e=Qt,poolId:t,beneficiary:n,shareAmount:o,txVersion:r,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l=su(e,t,n).publicKey;return u.addInstruction({instructions:[$l(e,this.scope.ownerPubKey,n,t,l,o)]}),u.addCustomComputeBudget(s),u.addTipInstruction(a),u.versionBuild({txVersion:r})}async claimVesting({programId:e=Qt,poolId:t,poolInfo:n,txVersion:o,computeBudgetConfig:r,txTipConfig:s,feePayer:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1}){let l=this.createTxBuilder(a),d=co(e).publicKey,m=su(e,t,this.scope.ownerPubKey).publicKey,p=n;if(!p){let f=await this.scope.connection.getAccountInfo(t);f||this.logAndCreateError("pool not found"),p=xn.decode(f.data)}let y=$(this.scope.ownerPubKey,p.mintA,Ct).publicKey;return l.addInstruction({instructions:[Gi(this.scope.ownerPubKey,y,this.scope.ownerPubKey,p.mintA)]}),l.addInstruction({instructions:[Zl(e,this.scope.ownerPubKey,d,t,m,y,p.vaultA,p.mintA,Ct)]}),l.addCustomComputeBudget(r),l.addTipInstruction(s),l.versionBuild({txVersion:o})}async getRpcPoolInfo({poolId:e}){return(await this.getRpcPoolsInfo({poolIdList:[e]})).poolInfoMap[e.toBase58()]}async getRpcPoolsInfo({poolIdList:e,config:t}){let n=await Ke(this.scope.connection,e.map(c=>({pubkey:c})),t),o={},r=[];for(let c=0;c<e.length;c++){let u=n[c];if(u===null||!u.accountInfo)throw Error("fetch pool info error: "+e[c].toBase58());let l=xn.decode(u.accountInfo.data);o[e[c].toBase58()]={...l,poolId:u.accountInfo.owner},r.push(l.configId)}let s=await Ke(this.scope.connection,r.map(c=>({pubkey:c})),t),a={};for(let c=0;c<r.length;c++){let u=s[c];if(u===null||!u.accountInfo)throw Error("fetch config info error: "+r[c].toBase58());let l=Mo.decode(u.accountInfo.data);a[r[c].toBase58()]={...l,configId:u.accountInfo.owner}}return{poolInfoMap:Object.keys(o).reduce((c,u)=>({...c,[u]:{...o[u],configInfo:a[o[u].configId.toBase58()]}}),{})}}};import{PublicKey as ib}from"@solana/web3.js";import{MintLayout as rb,TOKEN_2022_PROGRAM_ID as uu,TOKEN_PROGRAM_ID as cu}from"@solana/spl-token";var Qi=class extends Ne{_tokenList=[];_tokenMap=new Map;_blackTokenMap=new Set;_mintGroup={official:new Set,jup:new Set,extra:new Set};_whiteMap=new Set;_extraTokenList=[];constructor(e){super(e)}async load(e){this.checkDisabled();let{forceUpdate:t=!1,type:n="strict"}=e||{},{mintList:o,blacklist:r,whiteList:s}=await this.scope.fetchV3TokenList(t),a=await this.scope.fetchJupTokenList(t);this._tokenList=[],this._tokenMap=new Map,this._blackTokenMap=new Set(r),this._mintGroup={official:new Set,jup:new Set,extra:new Set},this._whiteMap=new Set(s),this._tokenMap.set(rn.address,rn),this._mintGroup.official.add(rn.address),o.forEach(c=>{this._blackTokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"raydium",priority:2,programId:c.programId??(c.tags.includes("token-2022")?uu.toBase58():cu.toBase58())}),this._mintGroup.official.add(c.address))}),a.forEach(c=>{this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"jupiter",priority:1,programId:c.programId??(c.tags.includes("token-2022")?uu.toBase58():cu.toBase58()),tags:c.freezeAuthority?[...c.tags||[],"hasFreeze"]:c.tags}),this._mintGroup.jup.add(c.address))}),this._extraTokenList.forEach(c=>{this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"extra",priority:1,programId:c.programId||c.tags.includes("token-2022")?uu.toBase58():cu.toBase58()}),this._mintGroup.extra.add(c.address))}),this._tokenList=Array.from(this._tokenMap).map(c=>c[1])}get tokenList(){return this._tokenList}get tokenMap(){return this._tokenMap}get blackTokenMap(){return this._blackTokenMap}get mintGroup(){return this._mintGroup}get whiteListMap(){return this._whiteMap}async getTokenInfo(e){if(!e)throw new Error("please input mint");let t=e.toString(),n=this._tokenMap.get(t);if(n)return n;if(t.toLocaleUpperCase()==="SOL")return rn;let o=(await this.scope.api.getTokenInfo([t]))[0];if(o)return this._mintGroup.extra.add(t),this._tokenMap.set(t,{...o,priority:2}),o;let r=await this.scope.connection.getAccountInfo(new ib(t));if(!r)throw new Error(`mint address not found: ${t}`);let s=rb.decode(r.data),a=t.toString().substring(0,6),c={chainId:101,address:t,programId:r.owner.toBase58(),logoURI:"",symbol:a,name:a,decimals:s.decimals,tags:[],extensions:{},priority:0,type:"unknown"};return this._mintGroup.extra.add(t),this._tokenMap.set(t,c),c}};var cs=class{cluster;farm;account;liquidity;clmm;cpmm;tradeV2;utils1216;marketV2;ido;token;launchpad;rawBalances=new Map;apiData;availability;blockhashCommitment;loopMultiTxStatus;_connection;_owner;api;_apiCacheTime;_signAllTransactions;logger;_chainTime;_epochInfo;constructor(e){let{connection:t,cluster:n,owner:o,api:r,defaultChainTime:s,defaultChainTimeOffset:a,apiCacheTime:c,blockhashCommitment:u="confirmed",loopMultiTxStatus:l}=e;this._connection=t,this.cluster=n||"mainnet",this._owner=o?new Xt(o):void 0,this._signAllTransactions=e.signAllTransactions,this.blockhashCommitment=u,this.loopMultiTxStatus=l,this.api=r,this._apiCacheTime=c||5*60*1e3,this.logger=de("Raydium"),this.farm=new di({scope:this,moduleName:"Raydium_Farm"}),this.account=new ni({scope:this,moduleName:"Raydium_Account",tokenAccounts:e.tokenAccounts,tokenAccountRawInfos:e.tokenAccountRawInfos}),this.liquidity=new Ki({scope:this,moduleName:"Raydium_LiquidityV2"}),this.token=new Qi({scope:this,moduleName:"Raydium_tokenV2"}),this.tradeV2=new Fi({scope:this,moduleName:"Raydium_tradeV2"}),this.clmm=new Li({scope:this,moduleName:"Raydium_clmm"}),this.cpmm=new Mi({scope:this,moduleName:"Raydium_cpmm"}),this.utils1216=new Wt({scope:this,moduleName:"Raydium_utils1216"}),this.marketV2=new Co({scope:this,moduleName:"Raydium_marketV2"}),this.ido=new Oo({scope:this,moduleName:"Raydium_ido"}),this.launchpad=new Xi({scope:this,moduleName:"Raydium_lauchpad"}),this.availability={};let d=new Date().getTime();this.apiData={},a&&(this._chainTime={fetched:d,value:{chainTime:s||Date.now()-a,offset:a}})}static async load(e){let t=sb({cluster:"mainnet",owner:null,apiRequestInterval:3e5,apiRequestTimeout:1e4},e),{cluster:n,apiRequestTimeout:o,logCount:r,logRequests:s,urlConfigs:a}=t,c=new wr({cluster:n,timeout:o,urlConfigs:a,logCount:r,logRequests:s}),u=new cs({...t,api:c});return await u.fetchAvailabilityStatus(e.disableFeatureCheck??!0),e.disableLoadToken||await u.token.load({type:e.jupTokenType}),u}get owner(){return this._owner}get ownerPubKey(){if(!this._owner)throw new Error(kr);return this._owner.publicKey}setOwner(e){return this._owner=e?new Xt(e):void 0,this.account.resetTokenAccounts(),this}get connection(){if(!this._connection)throw new Error(nc);return this._connection}setConnection(e){return this._connection=e,this}get signAllTransactions(){return this._signAllTransactions}setSignAllTransactions(e){return this._signAllTransactions=e,this}checkOwner(){if(!this.owner)throw console.error(kr),new Error(kr)}isCacheInvalidate(e){return new Date().getTime()-e>this._apiCacheTime}async fetchChainTime(){try{let e=await this.api.getChainTimeOffset();this._chainTime={fetched:Date.now(),value:{chainTime:Date.now()+e.offset*1e3,offset:e.offset*1e3}}}catch{this._chainTime=void 0}}async fetchV3TokenList(e){if(this.apiData.tokenList&&!this.isCacheInvalidate(this.apiData.tokenList.fetched)&&!e)return this.apiData.tokenList.data;try{let t=await this.api.getTokenList(),n={fetched:Date.now(),data:t};return this.apiData.tokenList=n,n.data}catch(t){return console.error(t),{mintList:[],blacklist:[],whiteList:[]}}}async fetchJupTokenList(e){let t=this.apiData.jupTokenList;if(t&&!this.isCacheInvalidate(t.fetched)&&!e)return t.data;try{let n=await this.api.getJupTokenList();return this.apiData.jupTokenList={fetched:Date.now(),data:n.map(o=>({...o,mintAuthority:o.mint_authority||void 0,freezeAuthority:o.freeze_authority||void 0}))},this.apiData.jupTokenList.data}catch(n){return console.error(n),[]}}get chainTimeData(){return this._chainTime?.value}async chainTimeOffset(){return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.offset:(await this.fetchChainTime(),this._chainTime?.value.offset||0)}async currentBlockChainTime(){return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.chainTime:(await this.fetchChainTime(),this._chainTime?.value.chainTime||Date.now())}async fetchEpochInfo(){return this._epochInfo&&Date.now()-this._epochInfo.fetched<=1e3*30?this._epochInfo.value:(this._epochInfo={fetched:Date.now(),value:await this.connection.getEpochInfo()},this._epochInfo.value)}async fetchAvailabilityStatus(e){if(e)return{};try{let t=await this.api.fetchAvailabilityStatus(),n=t.all===!1;return this.availability={all:t.all,swap:n?!1:t.swap,createConcentratedPosition:n?!1:t.createConcentratedPosition,addConcentratedPosition:n?!1:t.addConcentratedPosition,addStandardPosition:n?!1:t.addStandardPosition,removeConcentratedPosition:n?!1:t.removeConcentratedPosition,removeStandardPosition:n?!1:t.removeStandardPosition,addFarm:n?!1:t.addFarm,removeFarm:n?!1:t.removeFarm},t}catch{return{}}}};var JL=i=>i;export{Pb as ACCOUNT_TYPE_SIZE,At as ALL_PROGRAM_ID,Ff as AMM_CONFIG_SEED,Ed as AMM_STABLE,Xo as AMM_V4,sg as ANAMint,rt as API_URLS,pm as AccountType,wr as Api,Dc as BIT_PRECISION,zt as BNDivCeil,jn as BNLayout,pP as BN_100,fP as BN_1000,yP as BN_10000,dP as BN_FIVE,Eu as BN_ONE,Qn as BN_TEN,mP as BN_THREE,lP as BN_TWO,ze as BN_ZERO,Cw as BitStructure,lc as Blob,Qo as CLMM_LOCK_AUTH_ID,Po as CLMM_LOCK_PROGRAM_ID,On as CLMM_PROGRAM_ID,Ss as CLOCK_PROGRAM_ID,Vs as CREATE_CPMM_POOL_AUTH,qd as CREATE_CPMM_POOL_FEE_ACC,zo as CREATE_CPMM_POOL_PROGRAM,Li as Clmm,nl as ClmmConfigLayout,xe as ClmmInstrument,Gr as ConstantProductCurve,za as CpmmConfigInfoLayout,Xr as CpmmFee,vi as CpmmPoolInfoLayout,qo as Currency,Xn as CurrencyAmount,pn as Curve,Gn as CurveBase,zr as CurveCalculator,XP as DEVNET_PROGRAM_ID,vA as DEV_API_URLS,Gd as DEV_CREATE_CPMM_POOL_AUTH,Xd as DEV_CREATE_CPMM_POOL_FEE_ACC,Ud as DEV_CREATE_CPMM_POOL_PROGRAM,Yd as DEV_LAUNCHPAD_AUTH,jd as DEV_LAUNCHPAD_PROGRAM,zd as DEV_LOCK_CPMM_AUTH,Qd as DEV_LOCK_CPMM_PROGRAM,ry as DataElement,ag as ETHMint,xa as EXTENSION_TICKARRAY_BITMAP_SIZE,Kc as FARM_LOCK_MINT,Cc as FARM_LOCK_VAULT,Es as FARM_PROGRAM_ID_V3,ju as FARM_PROGRAM_ID_V4,_s as FARM_PROGRAM_ID_V5,go as FARM_PROGRAM_ID_V6,Et as FARM_PROGRAM_TO_VERSION,Rc as FARM_VERSION_TO_LEDGER_LAYOUT,Lc as FARM_VERSION_TO_STATE_LAYOUT,Yu as FEE_DESTINATION_ID,Nr as FEE_RATE_DENOMINATOR,jt as FEE_RATE_DENOMINATOR_VALUE,zf as FETCH_TICKARRAY_COUNT,_f as Fee,rs as FixedPriceCurve,le as Fraction,Yo as IDO_ALL_PROGRAM,Fd as IDO_PROGRAM_ID_V1,Vd as IDO_PROGRAM_ID_V2,Wd as IDO_PROGRAM_ID_V3,Dd as IDO_PROGRAM_ID_V4,ir as INSTRUCTION_PROGRAM_ID,V as InstructionType,$u as JupTokenType,Hd as LAUNCHPAD_AUTH,Yy as LAUNCHPAD_AUTH_SEED,Zy as LAUNCHPAD_CONFIG_SEED,tb as LAUNCHPAD_POOL_PLATFORM_SEED,$y as LAUNCHPAD_POOL_SEED,Jy as LAUNCHPAD_POOL_VAULT_SEED,eb as LAUNCHPAD_POOL_VESTING_SEED,Qt as LAUNCHPAD_PROGRAM,_r as LIQUIDITY_FEES_DENOMINATOR,La as LIQUIDITY_FEES_NUMERATOR,pr as LIQUIDITY_POOL_PROGRAM_ID_V5_MODEL,ny as LIQUIDITY_VERSION_TO_SERUM_VERSION,_B as LIQUIDITY_VERSION_TO_STATE_LAYOUT,jo as LOCK_CPMM_AUTH,Ho as LOCK_CPMM_PROGRAM,Fy as LOCK_LIQUIDITY_SEED,qc as LOG_B_2_X32,Uc as LOG_B_P_ERR_MARGIN_LOWER_X64,Gc as LOG_B_P_ERR_MARGIN_UPPER_X64,br as LOOKUP_TABLE_CACHE,is as LaunchPadConstantProductCurve,Mo as LaunchpadConfig,xn as LaunchpadPool,lo as LaunchpadPoolInitParam,w1 as LaunchpadVesting,ob as LaunchpadVestingSchedule,ei as Layout,ss as LinearPriceCurve,be as LiquidityMath,jI as LockClPositionLayoutV2,HI as LockPositionLayout,um as LogLevel,ds as Logger,Ua as MARKET_STATE_LAYOUT_V2,ja as MARKET_STATE_LAYOUT_V3,Dl as MARKET_VERSION_TO_STATE_LAYOUT,Xu as MAX_BASE64_SIZE,Vt as MAX_SQRT_PRICE_X64,Rr as MAX_SQRT_PRICE_X64_SUB_ONE,kt as MAX_TICK,or as MEMO_PROGRAM_ID,sn as MEMO_PROGRAM_ID2,Gt as METADATA_PROGRAM_ID,Ft as MIN_SQRT_PRICE_X64,Lr as MIN_SQRT_PRICE_X64_ADD_ONE,bt as MIN_TICK,So as MODEL_DATA_PUBKEY,Zr as Market,Ui as MathLaunch,ae as MathUtil,pi as MaxU64,Wc as MaxUint128,wn as NEGATIVE_ONE,rg as NRVMint,Xf as OBSERVATION_SEED,Nt as ONE,Fs as OPEN_BOOK_PROGRAM,Uf as OPERATION_SEED,ol as ObservationInfoLayout,Yf as ObservationLayout,il as OperationLayout,$s as OptionLayout,Xt as Owner,$b as PAIMint,$c as POOL_LOCK_ID_SEED,Df as POOL_REWARD_VAULT_SEED,Vf as POOL_SEED,Gf as POOL_TICK_ARRAY_BITMAP_SEED,Wf as POOL_VAULT_SEED,Hc as POSITION_SEED,De as Percent,os as PlatformConfig,Ju as PoolFetchType,Jn as PoolInfoLayout,Le as PoolUtils,ki as PositionInfoLayout,$f as PositionRewardInfoLayout,Pi as PositionUtils,it as Price,zI as ProtocolPositionLayout,Cr as Q128,Ye as Q64,Zb as RAYMint,je as RENT_PROGRAM_ID,cs as Raydium,Zf as RewardInfo,Sl as RoundDirection,hs as Rounding,_d as Router,Vl as SERUM_PROGRAMID_TO_VERSION,dr as SERUM_PROGRAM_ID_V3,Wl as SERUM_VERSION_TO_PROGRAMID,ec as SESSION_KEY,ot as SOLMint,rn as SOL_INFO,ul as SPL_MINT_LAYOUT,Jb as SRMMint,qs as STORAGE_KEY,Qf as SUPPORT_MINT_SEED,rr as SYSTEM_PROGRAM_ID,ne as SqrtPriceMath,xo as StableLayout,Js as Structure,$n as SwapMath,Zn as TICK_ARRAY_BITMAP_SIZE,qf as TICK_ARRAY_SEED,Je as TICK_ARRAY_SIZE,CT as TICK_SPACINGS,nt as TOKEN_WSOL,hn as TickArrayBitmap,tl as TickArrayBitmapExtensionLayout,wi as TickArrayBitmapExtensionUtils,Ai as TickArrayLayout,Jf as TickLayout,eo as TickMath,ge as TickQuery,H as TickUtils,Te as Token,Pe as TokenAmount,Pr as TxBuilder,Nn as TxVersion,fi as U64Resolution,RT as U64_IGNORE_RANGE,js as UInt,eg as USDCMint,ig as USDHMint,tg as USDTMint,Md as UTIL1216,ea as Union,xc as Voter,hf as VoterDepositEntry,kf as VoterLockup,Bc as VoterRegistrar,wf as VoterVotingMintConfig,j as WSOLMint,xr as WideBits,Pn as WrappedLayout,fe as ZERO,Nu as _100_PERCENT,P as accountMeta,Xg as add,yo as addComputeBudget,va as addLiquidityLayout,mn as anchorDataBuf,pk as array,ia as associatedLedgerAccountLayout,Ys as bits,ke as blob,_e as bool,jl as buyExactInInstruction,b1 as buyExactOutInstruction,ga as calFarmRewardAmount,ar as ceilDiv,fr as ceilDivBN,Uo as checkLegacyTxSize,F1 as checkPoolToAmm,Go as checkV0TxSize,ys as chunkArray,Vi as claimLayout,au as claimPlatformFee,Zl as claimVestedToken,el as clmmComputeInfoToApiInfo,An as closeAccountInstruction,El as collectCpFeeInstruction,Is as commonSystemAccountMeta,lr as confirmTransaction,qy as cpmmLockPositionInstruction,ui as createAssociatedLedgerAccountInstruction,de as createLogger,Jl as createPlatformConfig,ml as createPoolFeeLayout,Fa as createPoolV4InstructionV2,EB as createPoolV4Layout,$l as createVestingAccount,En as createWSolAccountInstructions,ok as cstr,bg as currencyEquals,xd as decimalToFraction,Jp as decodeBool,Dg as div,sr as divCeil,wt as dwLayout,ef as encodeBool,iw as endlessRetry,kd as eq,$w as f32,Jw as f32be,ek as f64,tk as f64be,ua as farmAddRewardLayout,ah as farmLedgerLayoutV3_1,ii as farmLedgerLayoutV3_2,uh as farmLedgerLayoutV5_1,Tc as farmLedgerLayoutV5_2,Ic as farmLedgerLayoutV6_1,Oc as farmRewardInfoToConfig,sa as farmRewardLayout,aa as farmRewardRestartLayout,Af as farmRewardTimeInfoLayout,kc as farmStateV3Layout,hc as farmStateV5Layout,oi as farmStateV6Layout,Oh as fetchMultipleFarmInfoAndUpdate,Ix as fetchMultipleInfo,mo as fetchMultipleMintInfos,te as findProgramAddress,Ra as fixedSwapInLayout,Na as fixedSwapOutLayout,vs as floorDiv,mr as forecastTransactionSize,yy as formatLayout,Ue as generatePubKey,$ as getATAAddress,Nc as getAssociatedAuthority,Vr as getAssociatedConfigId,yt as getAssociatedLedgerAccount,si as getAssociatedLedgerPoolAccount,Ty as getAssociatedOpenOrders,qa as getAssociatedPoolKeys,Hr as getCpLockPda,TK as getCpmmPdaAmmConfigId,Xa as getCpmmPdaPoolId,Cl as getCreatePoolKeys,Vu as getDate,Pa as getDepositEntryIndex,yl as getDxByDyBaseIn,fl as getDyByDxBaseIn,_P as getEpochInfo,Io as getFarmLedgerLayout,Tf as getFarmStateLayout,Da as getLiquidityAssociatedAuthority,io as getLiquidityAssociatedId,TI as getLiquidityFromAmounts,Gg as getMax,Dt as getMultipleAccountsInfo,Ke as getMultipleAccountsInfoWithCustomFlags,Ws as getMultipleLookupTableInfo,FT as getPdaAmmConfigId,vo as getPdaCpiEvent,Ge as getPdaExBitmapAccount,co as getPdaLaunchpadAuth,s1 as getPdaLaunchpadConfigId,ts as getPdaLaunchpadPoolId,iu as getPdaLaunchpadVaultId,gi as getPdaLockClPositionIdV2,Ia as getPdaLockPositionId,Ey as getPdaLpMint,kn as getPdaMetadataKey,Ba as getPdaMintExAccount,Zc as getPdaObservationAccount,Ni as getPdaObservationId,bi as getPdaOperationAccount,ht as getPdaPersonalPositionAddress,ru as getPdaPlatformId,Ro as getPdaPoolAuthority,jc as getPdaPoolId,Yc as getPdaPoolRewardVaulId,Ta as getPdaPoolVaultId,en as getPdaProtocolPositionAddress,ye as getPdaTickArrayAddress,Kl as getPdaVault,su as getPdaVestId,bo as getRecentBlockHash,ma as getRegistrarAddress,ep as getSessionKey,bl as getStablePrice,Kd as getTime,Zg as getTimestamp,ba as getTokenOwnerRecordAddress,HP as getTransferAmountFee,we as getTransferAmountFeeV2,fa as getVoterAddress,ya as getVoterWeightRecordAddress,pa as getVotingMintAuthority,da as getVotingTokenMint,Nf as governanceCreateTokenOwnerRecord,Lw as greedy,wd as gt,Wg as gte,gc as i128,OT as i16ToBytes,vr as i32ToBytes,ko as i64,bc as i8,Oa as initPoolLayout,na as initTokenAccountInstruction,Hl as initialize,Sy as initializeMarket,hP as intersection,Du as isDateAfter,Wu as isDateBefore,Sd as isDecimal,Ug as isMeaningfulNumber,Fu as isNumber,ca as isValidFarmVersion,yi as isZero,Re as jsonInfo2PoolKeys,vh as judgeFarmType,ka as leadingZeros,zc as leastSignificantBit,to as liquidityStateV4Layout,oy as liquidityStateV5Layout,Fg as lt,Vg as lte,ng as mSOLMint,Fr as makeAMMSwapInstruction,Al as makeAddLiquidityInstruction,wa as makeAddNewRewardInstruction,es as makeClaimInstruction,ou as makeClaimInstructionV4,Ml as makeCpmmLockInstruction,Rl as makeCreateCpmmPoolInInstruction,vc as makeCreateFarmInstruction,Dr as makeCreateMarketInstruction,Mc as makeCreatorWithdrawFarmRewardInstruction,Nl as makeDepositCpmmInInstruction,_c as makeDepositInstructionV3,Fc as makeDepositInstructionV5,Vc as makeDepositInstructionV6,Yh as makeDepositTokenInstruction,$h as makeDepositWithdrawInstruction,ex as makeInitPoolInstructionV4,D0 as makePurchaseInstruction,Aa as makeRestartRewardInstruction,wl as makeSimulatePoolInfoInstruction,jr as makeSwapCpmmBaseInInstruction,vl as makeSwapCpmmBaseOutInstruction,Py as makeSwapFixedInInstruction,Ay as makeSwapFixedOutInstruction,Ul as makeSwapInstruction,wc as makeTransferInstruction,Ol as makeWithdrawCpmmInInstruction,mi as makeWithdrawInstructionV3,Ec as makeWithdrawInstructionV4,li as makeWithdrawInstructionV5,ci as makeWithdrawInstructionV6,Zh as makeWithdrawTokenInstruction,Ht as minExpirationTime,LT as mockCreatePoolInfo,Xc as mockV3CreatePoolInfo,sy as modelDataInfoLayout,Qc as mostSignificantBit,Ns as mul,Os as notInnerObject,Xw as ns64,Zw as ns64be,mc as nu64,Vw as nu64be,Zs as offset,wP as offsetDateTime,ck as option,Y as parseBigNumberish,zn as parseNumberInfo,zu as parseSimulateLogToJson,gn as parseSimulateValue,Ac as parseTokenAccountResp,hB as parseTokenInfo,Fn as poolTypeV6,Hn as printSimulate,L as publicKey,eu as purchaseLayout,bf as realFarmStateV3Layout,gf as realFarmStateV5Layout,Pf as realFarmV6Layout,Mu as recursivelyDecimalToFraction,_a as removeLiquidityInstruction,Ma as removeLiquidityLayout,XC as route1Instruction,QC as route2Instruction,Gy as routeInstruction,dk as rustEnum,Dw as s16,Qw as s16be,qw as s24,zw as s24be,Oe as s32,Hw as s32be,Uw as s40,jw as s40be,Gw as s48,Yw as s48be,Ww as s8,Yl as sellExactInInstruction,g1 as sellExactOut,X as seq,cb as setLoggerLevel,Id as shakeFractionDecimal,Qu as simulateMultipleInstruction,JB as simulatePoolInfoInstruction,Rd as simulateTransaction,Ou as sleep,pt as solToWSol,IB as solToWSolToken,Jt as splAccountLayout,Cu as splitNumber,og as stSOLMint,$t as str,N as struct,qg as sub,zC as swapBaseInAutoAccount,HC as swapBaseOutAutoAccount,mk as tagged,Rs as tenExponential,Wr as toAmmComputePoolInfo,gt as toApiV3Token,Bd as toBN,Hu as toBuffer,Vn as toFeeConfig,_u as toFraction,_g as toFractionWithDecimals,bP as toPercent,Er as toToken,Ti as toTokenAmount,TB as toTokenInfo,gP as toTokenPrice,PP as toTotalPrice,vu as toUsdCurrency,ha as trailingZeros,FP as transformTxToBase64,xs as tryParsePublicKey,Nd as txToBase64,J as u128,Zt as u16,Or as u16ToBytes,vw as u16be,Rw as u24,Mw as u24be,ut as u32,vT as u32ToBytes,Ew as u32be,Nw as u40,_w as u40be,Ow as u48,Fw as u48be,A as u64,F as u8,nb as u8ToBytes,fk as union,JL as unionArr,nk as unionLayoutDiscriminator,IP as uniq,If as updateFarmPoolInfo,em as updatePlatformConfig,Ar as updateReqHistory,ik as utf8,Bs as validateAndParsePublicKey,la as validateFarmRewards,lk as vec,tf as vecU8,vf as voterStakeRegistryCreateDepositEntry,Of as voterStakeRegistryCreateVoter,Cf as voterStakeRegistryDeposit,Lf as voterStakeRegistryUpdateVoterWeightRecord,Rf as voterStakeRegistryWithdraw,BB as wSolToSolToken,ra as withdrawRewardLayout,TP as xor,yk as zeros};
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=index.mjs.map