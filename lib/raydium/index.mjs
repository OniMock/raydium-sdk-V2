var _l=Object.defineProperty;var Fl=(r,e,t)=>e in r?_l(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var Ct=(r,e,t)=>(Fl(r,typeof e!="symbol"?e+"":e,t),t);import{merge as ey}from"lodash";import Ou from"axios";import{PublicKey as Za}from"@solana/web3.js";import{get as ja,set as Vl}from"lodash";var is=class{logLevel;name;constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},Ya={},Wl={};function me(r){let e=ja(Ya,r);if(!e){let t=ja(Wl,r);e=new is({name:r,logLevel:t}),Vl(Ya,r,e)}return e}import{MINT_SIZE as Dl,TOKEN_PROGRAM_ID as ql,getTransferFeeConfig as Ul,unpackMint as Gl}from"@solana/spl-token";var rs=me("Raydium_accountInfo_util");async function Vt(r,e,t){let{batchRequest:n,commitment:o="confirmed",chunkCount:i=100}={batchRequest:!1,...t},s=ss(e,i),a=new Array(s.length).fill([]);if(n){let c=s.map(d=>{let m=r._buildArgs([d.map(p=>p.toBase58())],o,"base64");return{methodName:"getMultipleAccounts",args:m}}),u=ss(c,10);a=(await(await Promise.all(u.map(async d=>await r._rpcBatchRequest(d)))).flat()).map(d=>(d.error&&rs.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${d.error.message}`),d.result.value.map(m=>{if(m){let{data:p,executable:y,lamports:f,owner:b,rentEpoch:g}=m;return p.length!==2&&p[1]!=="base64"&&rs.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(p[0],"base64"),executable:y,lamports:f,owner:new Za(b),rentEpoch:g}}return null})))}else try{a=await Promise.all(s.map(c=>r.getMultipleAccountsInfo(c,o)))}catch(c){c instanceof Error&&rs.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${c.message}`)}return a.flat()}async function Se(r,e,t){let n=await Vt(r,e.map(o=>o.pubkey),t);return e.map((o,i)=>({...o,accountInfo:n[i]}))}async function oo({connection:r,mints:e,config:t}){if(e.length===0)return{};let n=await Se(r,e.map(i=>({pubkey:ut(i)})),t),o={};for(let i of n){if(!i.accountInfo||i.accountInfo.data.length<Dl){console.log("invalid mint account",i.pubkey.toBase58());continue}let s=Gl(i.pubkey,i.accountInfo,i.accountInfo?.owner);o[i.pubkey.toString()]={...s,programId:i.accountInfo?.owner||ql,feeConfig:Ul(s)??void 0}}return o[Za.default.toBase58()]=o[j.toBase58()],o}import on from"bn.js";var io=9e15,xn=1e9,as="0123456789abcdef",Vi="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",Wi="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",us={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-io,maxE:io,crypto:!1},tu,dn,ue=!0,qi="[DecimalError] ",Bn=qi+"Invalid argument: ",nu=qi+"Precision limit exceeded",ou=qi+"crypto unavailable",iu="[object Decimal]",ct=Math.floor,Qe=Math.pow,Xl=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,Ql=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,zl=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,ru=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,Dt=1e7,oe=7,Hl=9007199254740991,jl=Vi.length-1,cs=Wi.length-1,W={toStringTag:iu};W.absoluteValue=W.abs=function(){var r=new this.constructor(this);return r.s<0&&(r.s=1),ee(r)};W.ceil=function(){return ee(new this.constructor(this),this.e+1,2)};W.clampedTo=W.clamp=function(r,e){var t,n=this,o=n.constructor;if(r=new o(r),e=new o(e),!r.s||!e.s)return new o(NaN);if(r.gt(e))throw Error(Bn+e);return t=n.cmp(r),t<0?r:n.cmp(e)>0?e:new o(n)};W.comparedTo=W.cmp=function(r){var e,t,n,o,i=this,s=i.d,a=(r=new i.constructor(r)).d,c=i.s,u=r.s;if(!s||!a)return!c||!u?NaN:c!==u?c:s===a?0:!s^c<0?1:-1;if(!s[0]||!a[0])return s[0]?c:a[0]?-u:0;if(c!==u)return c;if(i.e!==r.e)return i.e>r.e^c<0?1:-1;for(n=s.length,o=a.length,e=0,t=n<o?n:o;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^c<0?1:-1;return n===o?0:n>o^c<0?1:-1};W.cosine=W.cos=function(){var r,e,t=this,n=t.constructor;return t.d?t.d[0]?(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+oe,n.rounding=1,t=Yl(n,lu(n,t)),n.precision=r,n.rounding=e,ee(dn==2||dn==3?t.neg():t,r,e,!0)):new n(1):new n(NaN)};W.cubeRoot=W.cbrt=function(){var r,e,t,n,o,i,s,a,c,u,l=this,d=l.constructor;if(!l.isFinite()||l.isZero())return new d(l);for(ue=!1,i=l.s*Qe(l.s*l,1/3),!i||Math.abs(i)==1/0?(t=nt(l.d),r=l.e,(i=(r-t.length+1)%3)&&(t+=i==1||i==-2?"0":"00"),i=Qe(t,1/3),r=ct((r+1)/3)-(r%3==(r<0?-1:2)),i==1/0?t="5e"+r:(t=i.toExponential(),t=t.slice(0,t.indexOf("e")+1)+r),n=new d(t),n.s=l.s):n=new d(i.toString()),s=(r=d.precision)+3;;)if(a=n,c=a.times(a).times(a),u=c.plus(l),n=Ke(u.plus(l).times(a),u.plus(c),s+2,1),nt(a.d).slice(0,s)===(t=nt(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!o&&t=="4999"){if(!o&&(ee(a,r+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,o=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&(ee(n,r+1,1),e=!n.times(n).times(n).eq(l));break}return ue=!0,ee(n,r,d.rounding,e)};W.decimalPlaces=W.dp=function(){var r,e=this.d,t=NaN;if(e){if(r=e.length-1,t=(r-ct(this.e/oe))*oe,r=e[r],r)for(;r%10==0;r/=10)t--;t<0&&(t=0)}return t};W.dividedBy=W.div=function(r){return Ke(this,new this.constructor(r))};W.dividedToIntegerBy=W.divToInt=function(r){var e=this,t=e.constructor;return ee(Ke(e,new t(r),0,1,1),t.precision,t.rounding)};W.equals=W.eq=function(r){return this.cmp(r)===0};W.floor=function(){return ee(new this.constructor(this),this.e+1,3)};W.greaterThan=W.gt=function(r){return this.cmp(r)>0};W.greaterThanOrEqualTo=W.gte=function(r){var e=this.cmp(r);return e==1||e===0};W.hyperbolicCosine=W.cosh=function(){var r,e,t,n,o,i=this,s=i.constructor,a=new s(1);if(!i.isFinite())return new s(i.s?1/0:NaN);if(i.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(i.e,i.sd())+4,s.rounding=1,o=i.d.length,o<32?(r=Math.ceil(o/3),e=(1/Gi(4,r)).toString()):(r=16,e="2.3283064365386962890625e-10"),i=ro(s,1,i.times(e),new s(1),!0);for(var c,u=r,l=new s(8);u--;)c=i.times(i),i=a.minus(c.times(l.minus(c.times(l))));return ee(i,s.precision=t,s.rounding=n,!0)};W.hyperbolicSine=W.sinh=function(){var r,e,t,n,o=this,i=o.constructor;if(!o.isFinite()||o.isZero())return new i(o);if(e=i.precision,t=i.rounding,i.precision=e+Math.max(o.e,o.sd())+4,i.rounding=1,n=o.d.length,n<3)o=ro(i,2,o,o,!0);else{r=1.4*Math.sqrt(n),r=r>16?16:r|0,o=o.times(1/Gi(5,r)),o=ro(i,2,o,o,!0);for(var s,a=new i(5),c=new i(16),u=new i(20);r--;)s=o.times(o),o=o.times(a.plus(s.times(c.times(s).plus(u))))}return i.precision=e,i.rounding=t,ee(o,e,t,!0)};W.hyperbolicTangent=W.tanh=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+7,n.rounding=1,Ke(t.sinh(),t.cosh(),n.precision=r,n.rounding=e)):new n(t.s)};W.inverseCosine=W.acos=function(){var r,e=this,t=e.constructor,n=e.abs().cmp(1),o=t.precision,i=t.rounding;return n!==-1?n===0?e.isNeg()?Wt(t,o,i):new t(0):new t(NaN):e.isZero()?Wt(t,o+4,i).times(.5):(t.precision=o+6,t.rounding=1,e=e.asin(),r=Wt(t,o+4,i).times(.5),t.precision=o,t.rounding=i,r.minus(e))};W.inverseHyperbolicCosine=W.acosh=function(){var r,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(r=n.precision,e=n.rounding,n.precision=r+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,ue=!1,t=t.times(t).minus(1).sqrt().plus(t),ue=!0,n.precision=r,n.rounding=e,t.ln()):new n(t)};W.inverseHyperbolicSine=W.asinh=function(){var r,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,ue=!1,t=t.times(t).plus(1).sqrt().plus(t),ue=!0,n.precision=r,n.rounding=e,t.ln())};W.inverseHyperbolicTangent=W.atanh=function(){var r,e,t,n,o=this,i=o.constructor;return o.isFinite()?o.e>=0?new i(o.abs().eq(1)?o.s/0:o.isZero()?o:NaN):(r=i.precision,e=i.rounding,n=o.sd(),Math.max(n,r)<2*-o.e-1?ee(new i(o),r,e,!0):(i.precision=t=n-o.e,o=Ke(o.plus(1),new i(1).minus(o),t+r,1),i.precision=r+4,i.rounding=1,o=o.ln(),i.precision=r,i.rounding=e,o.times(.5))):new i(NaN)};W.inverseSine=W.asin=function(){var r,e,t,n,o=this,i=o.constructor;return o.isZero()?new i(o):(e=o.abs().cmp(1),t=i.precision,n=i.rounding,e!==-1?e===0?(r=Wt(i,t+4,n).times(.5),r.s=o.s,r):new i(NaN):(i.precision=t+6,i.rounding=1,o=o.div(new i(1).minus(o.times(o)).sqrt().plus(1)).atan(),i.precision=t,i.rounding=n,o.times(2)))};W.inverseTangent=W.atan=function(){var r,e,t,n,o,i,s,a,c,u=this,l=u.constructor,d=l.precision,m=l.rounding;if(u.isFinite()){if(u.isZero())return new l(u);if(u.abs().eq(1)&&d+4<=cs)return s=Wt(l,d+4,m).times(.25),s.s=u.s,s}else{if(!u.s)return new l(NaN);if(d+4<=cs)return s=Wt(l,d+4,m).times(.5),s.s=u.s,s}for(l.precision=a=d+10,l.rounding=1,t=Math.min(28,a/oe+2|0),r=t;r;--r)u=u.div(u.times(u).plus(1).sqrt().plus(1));for(ue=!1,e=Math.ceil(a/oe),n=1,c=u.times(u),s=new l(u),o=u;r!==-1;)if(o=o.times(c),i=s.minus(o.div(n+=2)),o=o.times(c),s=i.plus(o.div(n+=2)),s.d[e]!==void 0)for(r=e;s.d[r]===i.d[r]&&r--;);return t&&(s=s.times(2<<t-1)),ue=!0,ee(s,l.precision=d,l.rounding=m,!0)};W.isFinite=function(){return!!this.d};W.isInteger=W.isInt=function(){return!!this.d&&ct(this.e/oe)>this.d.length-2};W.isNaN=function(){return!this.s};W.isNegative=W.isNeg=function(){return this.s<0};W.isPositive=W.isPos=function(){return this.s>0};W.isZero=function(){return!!this.d&&this.d[0]===0};W.lessThan=W.lt=function(r){return this.cmp(r)<0};W.lessThanOrEqualTo=W.lte=function(r){return this.cmp(r)<1};W.logarithm=W.log=function(r){var e,t,n,o,i,s,a,c,u=this,l=u.constructor,d=l.precision,m=l.rounding,p=5;if(r==null)r=new l(10),e=!0;else{if(r=new l(r),t=r.d,r.s<0||!t||!t[0]||r.eq(1))return new l(NaN);e=r.eq(10)}if(t=u.d,u.s<0||!t||!t[0]||u.eq(1))return new l(t&&!t[0]?-1/0:u.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)i=!0;else{for(o=t[0];o%10===0;)o/=10;i=o!==1}if(ue=!1,a=d+p,s=In(u,a),n=e?Di(l,a+10):In(r,a),c=Ke(s,n,a,1),Lo(c.d,o=d,m))do if(a+=10,s=In(u,a),n=e?Di(l,a+10):In(r,a),c=Ke(s,n,a,1),!i){+nt(c.d).slice(o+1,o+15)+1==1e14&&(c=ee(c,d+1,0));break}while(Lo(c.d,o+=10,m));return ue=!0,ee(c,d,m)};W.minus=W.sub=function(r){var e,t,n,o,i,s,a,c,u,l,d,m,p=this,y=p.constructor;if(r=new y(r),!p.d||!r.d)return!p.s||!r.s?r=new y(NaN):p.d?r.s=-r.s:r=new y(r.d||p.s!==r.s?p:NaN),r;if(p.s!=r.s)return r.s=-r.s,p.plus(r);if(u=p.d,m=r.d,a=y.precision,c=y.rounding,!u[0]||!m[0]){if(m[0])r.s=-r.s;else if(u[0])r=new y(p);else return new y(c===3?-0:0);return ue?ee(r,a,c):r}if(t=ct(r.e/oe),l=ct(p.e/oe),u=u.slice(),i=l-t,i){for(d=i<0,d?(e=u,i=-i,s=m.length):(e=m,t=l,s=u.length),n=Math.max(Math.ceil(a/oe),s)+2,i>n&&(i=n,e.length=1),e.reverse(),n=i;n--;)e.push(0);e.reverse()}else{for(n=u.length,s=m.length,d=n<s,d&&(s=n),n=0;n<s;n++)if(u[n]!=m[n]){d=u[n]<m[n];break}i=0}for(d&&(e=u,u=m,m=e,r.s=-r.s),s=u.length,n=m.length-s;n>0;--n)u[s++]=0;for(n=m.length;n>i;){if(u[--n]<m[n]){for(o=n;o&&u[--o]===0;)u[o]=Dt-1;--u[o],u[n]+=Dt}u[n]-=m[n]}for(;u[--s]===0;)u.pop();for(;u[0]===0;u.shift())--t;return u[0]?(r.d=u,r.e=Ui(u,t),ue?ee(r,a,c):r):new y(c===3?-0:0)};W.modulo=W.mod=function(r){var e,t=this,n=t.constructor;return r=new n(r),!t.d||!r.s||r.d&&!r.d[0]?new n(NaN):!r.d||t.d&&!t.d[0]?ee(new n(t),n.precision,n.rounding):(ue=!1,n.modulo==9?(e=Ke(t,r.abs(),0,3,1),e.s*=r.s):e=Ke(t,r,0,n.modulo,1),e=e.times(r),ue=!0,t.minus(e))};W.naturalExponential=W.exp=function(){return ls(this)};W.naturalLogarithm=W.ln=function(){return In(this)};W.negated=W.neg=function(){var r=new this.constructor(this);return r.s=-r.s,ee(r)};W.plus=W.add=function(r){var e,t,n,o,i,s,a,c,u,l,d=this,m=d.constructor;if(r=new m(r),!d.d||!r.d)return!d.s||!r.s?r=new m(NaN):d.d||(r=new m(r.d||d.s===r.s?d:NaN)),r;if(d.s!=r.s)return r.s=-r.s,d.minus(r);if(u=d.d,l=r.d,a=m.precision,c=m.rounding,!u[0]||!l[0])return l[0]||(r=new m(d)),ue?ee(r,a,c):r;if(i=ct(d.e/oe),n=ct(r.e/oe),u=u.slice(),o=i-n,o){for(o<0?(t=u,o=-o,s=l.length):(t=l,n=i,s=u.length),i=Math.ceil(a/oe),s=i>s?i+1:s+1,o>s&&(o=s,t.length=1),t.reverse();o--;)t.push(0);t.reverse()}for(s=u.length,o=l.length,s-o<0&&(o=s,t=l,l=u,u=t),e=0;o;)e=(u[--o]=u[o]+l[o]+e)/Dt|0,u[o]%=Dt;for(e&&(u.unshift(e),++n),s=u.length;u[--s]==0;)u.pop();return r.d=u,r.e=Ui(u,n),ue?ee(r,a,c):r};W.precision=W.sd=function(r){var e,t=this;if(r!==void 0&&r!==!!r&&r!==1&&r!==0)throw Error(Bn+r);return t.d?(e=su(t.d),r&&t.e+1>e&&(e=t.e+1)):e=NaN,e};W.round=function(){var r=this,e=r.constructor;return ee(new e(r),r.e+1,e.rounding)};W.sine=W.sin=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+oe,n.rounding=1,t=$l(n,lu(n,t)),n.precision=r,n.rounding=e,ee(dn>2?t.neg():t,r,e,!0)):new n(NaN)};W.squareRoot=W.sqrt=function(){var r,e,t,n,o,i,s=this,a=s.d,c=s.e,u=s.s,l=s.constructor;if(u!==1||!a||!a[0])return new l(!u||u<0&&(!a||a[0])?NaN:a?s:1/0);for(ue=!1,u=Math.sqrt(+s),u==0||u==1/0?(e=nt(a),(e.length+c)%2==0&&(e+="0"),u=Math.sqrt(e),c=ct((c+1)/2)-(c<0||c%2),u==1/0?e="5e"+c:(e=u.toExponential(),e=e.slice(0,e.indexOf("e")+1)+c),n=new l(e)):n=new l(u.toString()),t=(c=l.precision)+3;;)if(i=n,n=i.plus(Ke(s,i,t+2,1)).times(.5),nt(i.d).slice(0,t)===(e=nt(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!o&&e=="4999"){if(!o&&(ee(i,c+1,0),i.times(i).eq(s))){n=i;break}t+=4,o=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&(ee(n,c+1,1),r=!n.times(n).eq(s));break}return ue=!0,ee(n,c,l.rounding,r)};W.tangent=W.tan=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+10,n.rounding=1,t=t.sin(),t.s=1,t=Ke(t,new n(1).minus(t.times(t)).sqrt(),r+10,0),n.precision=r,n.rounding=e,ee(dn==2||dn==4?t.neg():t,r,e,!0)):new n(NaN)};W.times=W.mul=function(r){var e,t,n,o,i,s,a,c,u,l=this,d=l.constructor,m=l.d,p=(r=new d(r)).d;if(r.s*=l.s,!m||!m[0]||!p||!p[0])return new d(!r.s||m&&!m[0]&&!p||p&&!p[0]&&!m?NaN:!m||!p?r.s/0:r.s*0);for(t=ct(l.e/oe)+ct(r.e/oe),c=m.length,u=p.length,c<u&&(i=m,m=p,p=i,s=c,c=u,u=s),i=[],s=c+u,n=s;n--;)i.push(0);for(n=u;--n>=0;){for(e=0,o=c+n;o>n;)a=i[o]+p[n]*m[o-n-1]+e,i[o--]=a%Dt|0,e=a/Dt|0;i[o]=(i[o]+e)%Dt|0}for(;!i[--s];)i.pop();return e?++t:i.shift(),r.d=i,r.e=Ui(i,t),ue?ee(r,d.precision,d.rounding):r};W.toBinary=function(r,e){return ds(this,2,r,e)};W.toDecimalPlaces=W.toDP=function(r,e){var t=this,n=t.constructor;return t=new n(t),r===void 0?t:(wt(r,0,xn),e===void 0?e=n.rounding:wt(e,0,8),ee(t,r+t.e+1,e))};W.toExponential=function(r,e){var t,n=this,o=n.constructor;return r===void 0?t=en(n,!0):(wt(r,0,xn),e===void 0?e=o.rounding:wt(e,0,8),n=ee(new o(n),r+1,e),t=en(n,!0,r+1)),n.isNeg()&&!n.isZero()?"-"+t:t};W.toFixed=function(r,e){var t,n,o=this,i=o.constructor;return r===void 0?t=en(o):(wt(r,0,xn),e===void 0?e=i.rounding:wt(e,0,8),n=ee(new i(o),r+o.e+1,e),t=en(n,!1,r+n.e+1)),o.isNeg()&&!o.isZero()?"-"+t:t};W.toFraction=function(r){var e,t,n,o,i,s,a,c,u,l,d,m,p=this,y=p.d,f=p.constructor;if(!y)return new f(p);if(u=t=new f(1),n=c=new f(0),e=new f(n),i=e.e=su(y)-p.e-1,s=i%oe,e.d[0]=Qe(10,s<0?oe+s:s),r==null)r=i>0?e:u;else{if(a=new f(r),!a.isInt()||a.lt(u))throw Error(Bn+a);r=a.gt(e)?i>0?e:u:a}for(ue=!1,a=new f(nt(y)),l=f.precision,f.precision=i=y.length*oe*2;d=Ke(a,e,0,1,1),o=t.plus(d.times(n)),o.cmp(r)!=1;)t=n,n=o,o=u,u=c.plus(d.times(o)),c=o,o=e,e=a.minus(d.times(o)),a=o;return o=Ke(r.minus(t),n,0,1,1),c=c.plus(o.times(u)),t=t.plus(o.times(n)),c.s=u.s=p.s,m=Ke(u,n,i,1).minus(p).abs().cmp(Ke(c,t,i,1).minus(p).abs())<1?[u,n]:[c,t],f.precision=l,ue=!0,m};W.toHexadecimal=W.toHex=function(r,e){return ds(this,16,r,e)};W.toNearest=function(r,e){var t=this,n=t.constructor;if(t=new n(t),r==null){if(!t.d)return t;r=new n(1),e=n.rounding}else{if(r=new n(r),e===void 0?e=n.rounding:wt(e,0,8),!t.d)return r.s?t:r;if(!r.d)return r.s&&(r.s=t.s),r}return r.d[0]?(ue=!1,t=Ke(t,r,0,e,1).times(r),ue=!0,ee(t)):(r.s=t.s,t=r),t};W.toNumber=function(){return+this};W.toOctal=function(r,e){return ds(this,8,r,e)};W.toPower=W.pow=function(r){var e,t,n,o,i,s,a=this,c=a.constructor,u=+(r=new c(r));if(!a.d||!r.d||!a.d[0]||!r.d[0])return new c(Qe(+a,u));if(a=new c(a),a.eq(1))return a;if(n=c.precision,i=c.rounding,r.eq(1))return ee(a,n,i);if(e=ct(r.e/oe),e>=r.d.length-1&&(t=u<0?-u:u)<=Hl)return o=au(c,a,t,n),r.s<0?new c(1).div(o):ee(o,n,i);if(s=a.s,s<0){if(e<r.d.length-1)return new c(NaN);if((r.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=Qe(+a,u),e=t==0||!isFinite(t)?ct(u*(Math.log("0."+nt(a.d))/Math.LN10+a.e+1)):new c(t+"").e,e>c.maxE+1||e<c.minE-1?new c(e>0?s/0:0):(ue=!1,c.rounding=a.s=1,t=Math.min(12,(e+"").length),o=ls(r.times(In(a,n+t)),n),o.d&&(o=ee(o,n+5,1),Lo(o.d,n,i)&&(e=n+10,o=ee(ls(r.times(In(a,e+t)),e),e+5,1),+nt(o.d).slice(n+1,n+15)+1==1e14&&(o=ee(o,n+1,0)))),o.s=s,ue=!0,c.rounding=i,ee(o,n,i))};W.toPrecision=function(r,e){var t,n=this,o=n.constructor;return r===void 0?t=en(n,n.e<=o.toExpNeg||n.e>=o.toExpPos):(wt(r,1,xn),e===void 0?e=o.rounding:wt(e,0,8),n=ee(new o(n),r,e),t=en(n,r<=n.e||n.e<=o.toExpNeg,r)),n.isNeg()&&!n.isZero()?"-"+t:t};W.toSignificantDigits=W.toSD=function(r,e){var t=this,n=t.constructor;return r===void 0?(r=n.precision,e=n.rounding):(wt(r,1,xn),e===void 0?e=n.rounding:wt(e,0,8)),ee(new n(t),r,e)};W.toString=function(){var r=this,e=r.constructor,t=en(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()&&!r.isZero()?"-"+t:t};W.truncated=W.trunc=function(){return ee(new this.constructor(this),this.e+1,1)};W.valueOf=W.toJSON=function(){var r=this,e=r.constructor,t=en(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()?"-"+t:t};function nt(r){var e,t,n,o=r.length-1,i="",s=r[0];if(o>0){for(i+=s,e=1;e<o;e++)n=r[e]+"",t=oe-n.length,t&&(i+=Tn(t)),i+=n;s=r[e],n=s+"",t=oe-n.length,t&&(i+=Tn(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return i+s}function wt(r,e,t){if(r!==~~r||r<e||r>t)throw Error(Bn+r)}function Lo(r,e,t,n){var o,i,s,a;for(i=r[0];i>=10;i/=10)--e;return--e<0?(e+=oe,o=0):(o=Math.ceil((e+1)/oe),e%=oe),i=Qe(10,oe-e),a=r[o]%i|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==i||t>3&&a+1==i/2)&&(r[o+1]/i/100|0)==Qe(10,e-2)-1||(a==i/2||a==0)&&(r[o+1]/i/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==i||!n&&t>3&&a+1==i/2)&&(r[o+1]/i/1e3|0)==Qe(10,e-3)-1,s}function Fi(r,e,t){for(var n,o=[0],i,s=0,a=r.length;s<a;){for(i=o.length;i--;)o[i]*=e;for(o[0]+=as.indexOf(r.charAt(s++)),n=0;n<o.length;n++)o[n]>t-1&&(o[n+1]===void 0&&(o[n+1]=0),o[n+1]+=o[n]/t|0,o[n]%=t)}return o.reverse()}function Yl(r,e){var t,n,o;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),o=(1/Gi(4,t)).toString()):(t=16,o="2.3283064365386962890625e-10"),r.precision+=t,e=ro(r,1,e.times(o),new r(1));for(var i=t;i--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return r.precision-=t,e}var Ke=function(){function r(n,o,i){var s,a=0,c=n.length;for(n=n.slice();c--;)s=n[c]*o+a,n[c]=s%i|0,a=s/i|0;return a&&n.unshift(a),n}function e(n,o,i,s){var a,c;if(i!=s)c=i>s?1:-1;else for(a=c=0;a<i;a++)if(n[a]!=o[a]){c=n[a]>o[a]?1:-1;break}return c}function t(n,o,i,s){for(var a=0;i--;)n[i]-=a,a=n[i]<o[i]?1:0,n[i]=a*s+n[i]-o[i];for(;!n[0]&&n.length>1;)n.shift()}return function(n,o,i,s,a,c){var u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I,K,N,v,_=n.constructor,D=n.s==o.s?1:-1,q=n.d,G=o.d;if(!q||!q[0]||!G||!G[0])return new _(!n.s||!o.s||(q?G&&q[0]==G[0]:!G)?NaN:q&&q[0]==0||!G?D*0:D/0);for(c?(p=1,l=n.e-o.e):(c=Dt,p=oe,l=ct(n.e/p)-ct(o.e/p)),N=G.length,I=q.length,g=new _(D),w=g.d=[],d=0;G[d]==(q[d]||0);d++);if(G[d]>(q[d]||0)&&l--,i==null?(T=i=_.precision,s=_.rounding):a?T=i+(n.e-o.e)+1:T=i,T<0)w.push(1),y=!0;else{if(T=T/p+2|0,d=0,N==1){for(m=0,G=G[0],T++;(d<I||m)&&T--;d++)B=m*c+(q[d]||0),w[d]=B/G|0,m=B%G|0;y=m||d<I}else{for(m=c/(G[0]+1)|0,m>1&&(G=r(G,m,c),q=r(q,m,c),N=G.length,I=q.length),S=N,k=q.slice(0,N),h=k.length;h<N;)k[h++]=0;v=G.slice(),v.unshift(0),K=G[0],G[1]>=c/2&&++K;do m=0,u=e(G,k,N,h),u<0?(x=k[0],N!=h&&(x=x*c+(k[1]||0)),m=x/K|0,m>1?(m>=c&&(m=c-1),f=r(G,m,c),b=f.length,h=k.length,u=e(f,k,b,h),u==1&&(m--,t(f,N<b?v:G,b,c))):(m==0&&(u=m=1),f=G.slice()),b=f.length,b<h&&f.unshift(0),t(k,f,h,c),u==-1&&(h=k.length,u=e(G,k,N,h),u<1&&(m++,t(k,N<h?v:G,h,c))),h=k.length):u===0&&(m++,k=[0]),w[d++]=m,u&&k[0]?k[h++]=q[S]||0:(k=[q[S]],h=1);while((S++<I||k[0]!==void 0)&&T--);y=k[0]!==void 0}w[0]||w.shift()}if(p==1)g.e=l,tu=y;else{for(d=1,m=w[0];m>=10;m/=10)d++;g.e=d+l*p-1,ee(g,a?i+g.e+1:i,s,y)}return g}}();function ee(r,e,t,n){var o,i,s,a,c,u,l,d,m,p=r.constructor;e:if(e!=null){if(d=r.d,!d)return r;for(o=1,a=d[0];a>=10;a/=10)o++;if(i=e-o,i<0)i+=oe,s=e,l=d[m=0],c=l/Qe(10,o-s-1)%10|0;else if(m=Math.ceil((i+1)/oe),a=d.length,m>=a)if(n){for(;a++<=m;)d.push(0);l=c=0,o=1,i%=oe,s=i-oe+1}else break e;else{for(l=a=d[m],o=1;a>=10;a/=10)o++;i%=oe,s=i-oe+o,c=s<0?0:l/Qe(10,o-s-1)%10|0}if(n=n||e<0||d[m+1]!==void 0||(s<0?l:l%Qe(10,o-s-1)),u=t<4?(c||n)&&(t==0||t==(r.s<0?3:2)):c>5||c==5&&(t==4||n||t==6&&(i>0?s>0?l/Qe(10,o-s):0:d[m-1])%10&1||t==(r.s<0?8:7)),e<1||!d[0])return d.length=0,u?(e-=r.e+1,d[0]=Qe(10,(oe-e%oe)%oe),r.e=-e||0):d[0]=r.e=0,r;if(i==0?(d.length=m,a=1,m--):(d.length=m+1,a=Qe(10,oe-i),d[m]=s>0?(l/Qe(10,o-s)%Qe(10,s)|0)*a:0),u)for(;;)if(m==0){for(i=1,s=d[0];s>=10;s/=10)i++;for(s=d[0]+=a,a=1;s>=10;s/=10)a++;i!=a&&(r.e++,d[0]==Dt&&(d[0]=1));break}else{if(d[m]+=a,d[m]!=Dt)break;d[m--]=0,a=1}for(i=d.length;d[--i]===0;)d.pop()}return ue&&(r.e>p.maxE?(r.d=null,r.e=NaN):r.e<p.minE&&(r.e=0,r.d=[0])),r}function en(r,e,t){if(!r.isFinite())return cu(r);var n,o=r.e,i=nt(r.d),s=i.length;return e?(t&&(n=t-s)>0?i=i.charAt(0)+"."+i.slice(1)+Tn(n):s>1&&(i=i.charAt(0)+"."+i.slice(1)),i=i+(r.e<0?"e":"e+")+r.e):o<0?(i="0."+Tn(-o-1)+i,t&&(n=t-s)>0&&(i+=Tn(n))):o>=s?(i+=Tn(o+1-s),t&&(n=t-o-1)>0&&(i=i+"."+Tn(n))):((n=o+1)<s&&(i=i.slice(0,n)+"."+i.slice(n)),t&&(n=t-s)>0&&(o+1===s&&(i+="."),i+=Tn(n))),i}function Ui(r,e){var t=r[0];for(e*=oe;t>=10;t/=10)e++;return e}function Di(r,e,t){if(e>jl)throw ue=!0,t&&(r.precision=t),Error(nu);return ee(new r(Vi),e,1,!0)}function Wt(r,e,t){if(e>cs)throw Error(nu);return ee(new r(Wi),e,t,!0)}function su(r){var e=r.length-1,t=e*oe+1;if(e=r[e],e){for(;e%10==0;e/=10)t--;for(e=r[0];e>=10;e/=10)t++}return t}function Tn(r){for(var e="";r--;)e+="0";return e}function au(r,e,t,n){var o,i=new r(1),s=Math.ceil(n/oe+4);for(ue=!1;;){if(t%2&&(i=i.times(e),Ja(i.d,s)&&(o=!0)),t=ct(t/2),t===0){t=i.d.length-1,o&&i.d[t]===0&&++i.d[t];break}e=e.times(e),Ja(e.d,s)}return ue=!0,i}function $a(r){return r.d[r.d.length-1]&1}function uu(r,e,t){for(var n,o=new r(e[0]),i=0;++i<e.length;)if(n=new r(e[i]),n.s)o[t](n)&&(o=n);else{o=n;break}return o}function ls(r,e){var t,n,o,i,s,a,c,u=0,l=0,d=0,m=r.constructor,p=m.rounding,y=m.precision;if(!r.d||!r.d[0]||r.e>17)return new m(r.d?r.d[0]?r.s<0?0:1/0:1:r.s?r.s<0?0:r:0/0);for(e==null?(ue=!1,c=y):c=e,a=new m(.03125);r.e>-2;)r=r.times(a),d+=5;for(n=Math.log(Qe(2,d))/Math.LN10*2+5|0,c+=n,t=i=s=new m(1),m.precision=c;;){if(i=ee(i.times(r),c,1),t=t.times(++l),a=s.plus(Ke(i,t,c,1)),nt(a.d).slice(0,c)===nt(s.d).slice(0,c)){for(o=d;o--;)s=ee(s.times(s),c,1);if(e==null)if(u<3&&Lo(s.d,c-n,p,u))m.precision=c+=10,t=i=a=new m(1),l=0,u++;else return ee(s,m.precision=y,p,ue=!0);else return m.precision=y,s}s=a}}function In(r,e){var t,n,o,i,s,a,c,u,l,d,m,p=1,y=10,f=r,b=f.d,g=f.constructor,w=g.rounding,k=g.precision;if(f.s<0||!b||!b[0]||!f.e&&b[0]==1&&b.length==1)return new g(b&&!b[0]?-1/0:f.s!=1?NaN:b?0:f);if(e==null?(ue=!1,l=k):l=e,g.precision=l+=y,t=nt(b),n=t.charAt(0),Math.abs(i=f.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)f=f.times(r),t=nt(f.d),n=t.charAt(0),p++;i=f.e,n>1?(f=new g("0."+t),i++):f=new g(n+"."+t.slice(1))}else return u=Di(g,l+2,k).times(i+""),f=In(new g(n+"."+t.slice(1)),l-y).plus(u),g.precision=k,e==null?ee(f,k,w,ue=!0):f;for(d=f,c=s=f=Ke(f.minus(1),f.plus(1),l,1),m=ee(f.times(f),l,1),o=3;;){if(s=ee(s.times(m),l,1),u=c.plus(Ke(s,new g(o),l,1)),nt(u.d).slice(0,l)===nt(c.d).slice(0,l))if(c=c.times(2),i!==0&&(c=c.plus(Di(g,l+2,k).times(i+""))),c=Ke(c,new g(p),l,1),e==null)if(Lo(c.d,l-y,w,a))g.precision=l+=y,u=s=f=Ke(d.minus(1),d.plus(1),l,1),m=ee(f.times(f),l,1),o=a=1;else return ee(c,g.precision=k,w,ue=!0);else return g.precision=k,c;c=u,o+=2}}function cu(r){return String(r.s*r.s/0)}function ms(r,e){var t,n,o;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(o=e.length;e.charCodeAt(o-1)===48;--o);if(e=e.slice(n,o),e){if(o-=n,r.e=t=t-n-1,r.d=[],n=(t+1)%oe,t<0&&(n+=oe),n<o){for(n&&r.d.push(+e.slice(0,n)),o-=oe;n<o;)r.d.push(+e.slice(n,n+=oe));e=e.slice(n),n=oe-e.length}else n-=o;for(;n--;)e+="0";r.d.push(+e),ue&&(r.e>r.constructor.maxE?(r.d=null,r.e=NaN):r.e<r.constructor.minE&&(r.e=0,r.d=[0]))}else r.e=0,r.d=[0];return r}function Zl(r,e){var t,n,o,i,s,a,c,u,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),ru.test(e))return ms(r,e)}else if(e==="Infinity"||e==="NaN")return+e||(r.s=NaN),r.e=NaN,r.d=null,r;if(Ql.test(e))t=16,e=e.toLowerCase();else if(Xl.test(e))t=2;else if(zl.test(e))t=8;else throw Error(Bn+e);for(i=e.search(/p/i),i>0?(c=+e.slice(i+1),e=e.substring(2,i)):e=e.slice(2),i=e.indexOf("."),s=i>=0,n=r.constructor,s&&(e=e.replace(".",""),a=e.length,i=a-i,o=au(n,new n(t),i,i*2)),u=Fi(e,t,Dt),l=u.length-1,i=l;u[i]===0;--i)u.pop();return i<0?new n(r.s*0):(r.e=Ui(u,l),r.d=u,ue=!1,s&&(r=Ke(r,o,a*4)),c&&(r=r.times(Math.abs(c)<54?Qe(2,c):Ro.pow(2,c))),ue=!0,r)}function $l(r,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:ro(r,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/Gi(5,t)),e=ro(r,2,e,e);for(var o,i=new r(5),s=new r(16),a=new r(20);t--;)o=e.times(e),e=e.times(i.plus(o.times(s.times(o).minus(a))));return e}function ro(r,e,t,n,o){var i,s,a,c,u=1,l=r.precision,d=Math.ceil(l/oe);for(ue=!1,c=t.times(t),a=new r(n);;){if(s=Ke(a.times(c),new r(e++*e++),l,1),a=o?n.plus(s):n.minus(s),n=Ke(s.times(c),new r(e++*e++),l,1),s=a.plus(n),s.d[d]!==void 0){for(i=d;s.d[i]===a.d[i]&&i--;);if(i==-1)break}i=a,a=n,n=s,s=i,u++}return ue=!0,s.d.length=d+1,s}function Gi(r,e){for(var t=r;--e;)t*=r;return t}function lu(r,e){var t,n=e.s<0,o=Wt(r,r.precision,1),i=o.times(.5);if(e=e.abs(),e.lte(i))return dn=n?4:1,e;if(t=e.divToInt(o),t.isZero())dn=n?3:2;else{if(e=e.minus(t.times(o)),e.lte(i))return dn=$a(t)?n?2:3:n?4:1,e;dn=$a(t)?n?1:4:n?3:2}return e.minus(o).abs()}function ds(r,e,t,n){var o,i,s,a,c,u,l,d,m,p=r.constructor,y=t!==void 0;if(y?(wt(t,1,xn),n===void 0?n=p.rounding:wt(n,0,8)):(t=p.precision,n=p.rounding),!r.isFinite())l=cu(r);else{for(l=en(r),s=l.indexOf("."),y?(o=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):o=e,s>=0&&(l=l.replace(".",""),m=new p(1),m.e=l.length-s,m.d=Fi(en(m),10,o),m.e=m.d.length),d=Fi(l,10,o),i=c=d.length;d[--c]==0;)d.pop();if(!d[0])l=y?"0p+0":"0";else{if(s<0?i--:(r=new p(r),r.d=d,r.e=i,r=Ke(r,m,t,n,0,o),d=r.d,i=r.e,u=tu),s=d[t],a=o/2,u=u||d[t+1]!==void 0,u=n<4?(s!==void 0||u)&&(n===0||n===(r.s<0?3:2)):s>a||s===a&&(n===4||u||n===6&&d[t-1]&1||n===(r.s<0?8:7)),d.length=t,u)for(;++d[--t]>o-1;)d[t]=0,t||(++i,d.unshift(1));for(c=d.length;!d[c-1];--c);for(s=0,l="";s<c;s++)l+=as.charAt(d[s]);if(y){if(c>1)if(e==16||e==8){for(s=e==16?4:3,--c;c%s;c++)l+="0";for(d=Fi(l,o,e),c=d.length;!d[c-1];--c);for(s=1,l="1.";s<c;s++)l+=as.charAt(d[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(i<0?"p":"p+")+i}else if(i<0){for(;++i;)l="0"+l;l="0."+l}else if(++i>c)for(i-=c;i--;)l+="0";else i<c&&(l=l.slice(0,i)+"."+l.slice(i))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return r.s<0?"-"+l:l}function Ja(r,e){if(r.length>e)return r.length=e,!0}function Jl(r){return new this(r).abs()}function em(r){return new this(r).acos()}function tm(r){return new this(r).acosh()}function nm(r,e){return new this(r).plus(e)}function om(r){return new this(r).asin()}function im(r){return new this(r).asinh()}function rm(r){return new this(r).atan()}function sm(r){return new this(r).atanh()}function am(r,e){r=new this(r),e=new this(e);var t,n=this.precision,o=this.rounding,i=n+4;return!r.s||!e.s?t=new this(NaN):!r.d&&!e.d?(t=Wt(this,i,1).times(e.s>0?.25:.75),t.s=r.s):!e.d||r.isZero()?(t=e.s<0?Wt(this,n,o):new this(0),t.s=r.s):!r.d||e.isZero()?(t=Wt(this,i,1).times(.5),t.s=r.s):e.s<0?(this.precision=i,this.rounding=1,t=this.atan(Ke(r,e,i,1)),e=Wt(this,i,1),this.precision=n,this.rounding=o,t=r.s<0?t.minus(e):t.plus(e)):t=this.atan(Ke(r,e,i,1)),t}function um(r){return new this(r).cbrt()}function cm(r){return ee(r=new this(r),r.e+1,2)}function lm(r,e,t){return new this(r).clamp(e,t)}function mm(r){if(!r||typeof r!="object")throw Error(qi+"Object expected");var e,t,n,o=r.defaults===!0,i=["precision",1,xn,"rounding",0,8,"toExpNeg",-io,0,"toExpPos",0,io,"maxE",0,io,"minE",-io,0,"modulo",0,9];for(e=0;e<i.length;e+=3)if(t=i[e],o&&(this[t]=us[t]),(n=r[t])!==void 0)if(ct(n)===n&&n>=i[e+1]&&n<=i[e+2])this[t]=n;else throw Error(Bn+t+": "+n);if(t="crypto",o&&(this[t]=us[t]),(n=r[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(ou);else this[t]=!1;else throw Error(Bn+t+": "+n);return this}function dm(r){return new this(r).cos()}function pm(r){return new this(r).cosh()}function mu(r){var e,t,n;function o(i){var s,a,c,u=this;if(!(u instanceof o))return new o(i);if(u.constructor=o,eu(i)){u.s=i.s,ue?!i.d||i.e>o.maxE?(u.e=NaN,u.d=null):i.e<o.minE?(u.e=0,u.d=[0]):(u.e=i.e,u.d=i.d.slice()):(u.e=i.e,u.d=i.d?i.d.slice():i.d);return}if(c=typeof i,c==="number"){if(i===0){u.s=1/i<0?-1:1,u.e=0,u.d=[0];return}if(i<0?(i=-i,u.s=-1):u.s=1,i===~~i&&i<1e7){for(s=0,a=i;a>=10;a/=10)s++;ue?s>o.maxE?(u.e=NaN,u.d=null):s<o.minE?(u.e=0,u.d=[0]):(u.e=s,u.d=[i]):(u.e=s,u.d=[i]);return}else if(i*0!==0){i||(u.s=NaN),u.e=NaN,u.d=null;return}return ms(u,i.toString())}else if(c!=="string")throw Error(Bn+i);return(a=i.charCodeAt(0))===45?(i=i.slice(1),u.s=-1):(a===43&&(i=i.slice(1)),u.s=1),ru.test(i)?ms(u,i):Zl(u,i)}if(o.prototype=W,o.ROUND_UP=0,o.ROUND_DOWN=1,o.ROUND_CEIL=2,o.ROUND_FLOOR=3,o.ROUND_HALF_UP=4,o.ROUND_HALF_DOWN=5,o.ROUND_HALF_EVEN=6,o.ROUND_HALF_CEIL=7,o.ROUND_HALF_FLOOR=8,o.EUCLID=9,o.config=o.set=mm,o.clone=mu,o.isDecimal=eu,o.abs=Jl,o.acos=em,o.acosh=tm,o.add=nm,o.asin=om,o.asinh=im,o.atan=rm,o.atanh=sm,o.atan2=am,o.cbrt=um,o.ceil=cm,o.clamp=lm,o.cos=dm,o.cosh=pm,o.div=fm,o.exp=ym,o.floor=bm,o.hypot=gm,o.ln=Pm,o.log=Am,o.log10=km,o.log2=wm,o.max=hm,o.min=Tm,o.mod=Im,o.mul=Bm,o.pow=xm,o.random=Sm,o.round=Km,o.sign=Cm,o.sin=Lm,o.sinh=Rm,o.sqrt=Nm,o.sub=Om,o.sum=vm,o.tan=Mm,o.tanh=Em,o.trunc=_m,r===void 0&&(r={}),r&&r.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)r.hasOwnProperty(t=n[e++])||(r[t]=this[t]);return o.config(r),o}function fm(r,e){return new this(r).div(e)}function ym(r){return new this(r).exp()}function bm(r){return ee(r=new this(r),r.e+1,3)}function gm(){var r,e,t=new this(0);for(ue=!1,r=0;r<arguments.length;)if(e=new this(arguments[r++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return ue=!0,new this(1/0);t=e}return ue=!0,t.sqrt()}function eu(r){return r instanceof Ro||r&&r.toStringTag===iu||!1}function Pm(r){return new this(r).ln()}function Am(r,e){return new this(r).log(e)}function wm(r){return new this(r).log(2)}function km(r){return new this(r).log(10)}function hm(){return uu(this,arguments,"lt")}function Tm(){return uu(this,arguments,"gt")}function Im(r,e){return new this(r).mod(e)}function Bm(r,e){return new this(r).mul(e)}function xm(r,e){return new this(r).pow(e)}function Sm(r){var e,t,n,o,i=0,s=new this(1),a=[];if(r===void 0?r=this.precision:wt(r,1,xn),n=Math.ceil(r/oe),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));i<n;)o=e[i],o>=429e7?e[i]=crypto.getRandomValues(new Uint32Array(1))[0]:a[i++]=o%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);i<n;)o=e[i]+(e[i+1]<<8)+(e[i+2]<<16)+((e[i+3]&127)<<24),o>=214e7?crypto.randomBytes(4).copy(e,i):(a.push(o%1e7),i+=4);i=n/4}else throw Error(ou);else for(;i<n;)a[i++]=Math.random()*1e7|0;for(n=a[--i],r%=oe,n&&r&&(o=Qe(10,oe-r),a[i]=(n/o|0)*o);a[i]===0;i--)a.pop();if(i<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=oe)a.shift();for(n=1,o=a[0];o>=10;o/=10)n++;n<oe&&(t-=oe-n)}return s.e=t,s.d=a,s}function Km(r){return ee(r=new this(r),r.e+1,this.rounding)}function Cm(r){return r=new this(r),r.d?r.d[0]?r.s:0*r.s:r.s||NaN}function Lm(r){return new this(r).sin()}function Rm(r){return new this(r).sinh()}function Nm(r){return new this(r).sqrt()}function Om(r,e){return new this(r).sub(e)}function vm(){var r=0,e=arguments,t=new this(e[r]);for(ue=!1;t.s&&++r<e.length;)t=t.plus(e[r]);return ue=!0,ee(t,this.precision,this.rounding)}function Mm(r){return new this(r).tan()}function Em(r){return new this(r).tanh()}function _m(r){return ee(r=new this(r),r.e+1,1)}W[Symbol.for("nodejs.util.inspect.custom")]=W.toString;W[Symbol.toStringTag]="Decimal";var Ro=W.constructor=mu(us);Vi=new Ro(Vi);Wi=new Ro(Wi);var C=Ro;import Xm from"big.js";import zi from"bn.js";import Fm from"toformat";var Vm=Fm,No=Vm;import Qi from"big.js";import Dm from"bn.js";import qm from"decimal.js-light";import Oo from"bn.js";var du=9007199254740991;function $(r){let e=me("Raydium_parseBigNumberish");if(r instanceof Oo)return r;if(typeof r=="string"){if(r.match(/^-?[0-9]+$/))return new Oo(r);e.logWithError(`invalid BigNumberish string: ${r}`)}return typeof r=="number"?(r%1&&e.logWithError(`BigNumberish number underflow: ${r}`),(r>=du||r<=-du)&&e.logWithError(`BigNumberish number overflow: ${r}`),new Oo(String(r))):typeof r=="bigint"?new Oo(r.toString()):(e.error(`invalid BigNumberish value: ${r}`),new Oo(0))}var Xi=me("module/fraction"),ps=No(Qi),vo=No(qm),Um={[0]:vo.ROUND_DOWN,[1]:vo.ROUND_HALF_UP,[2]:vo.ROUND_UP},Gm={[0]:Qi.roundDown,[1]:Qi.roundHalfUp,[2]:Qi.roundUp},Pe=class{numerator;denominator;constructor(e,t=new Dm(1)){this.numerator=$(e),this.denominator=$(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new Pe(this.denominator,this.numerator)}add(e){let t=e instanceof Pe?e:new Pe($(e));return this.denominator.eq(t.denominator)?new Pe(this.numerator.add(t.numerator),this.denominator):new Pe(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof Pe?e:new Pe($(e));return this.denominator.eq(t.denominator)?new Pe(this.numerator.sub(t.numerator),this.denominator):new Pe(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof Pe?e:new Pe($(e));return new Pe(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof Pe?e:new Pe($(e));return new Pe(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||Xi.logWithError(`${e} is not an integer.`),e<=0&&Xi.logWithError(`${e} is not positive.`),vo.set({precision:e+1,rounding:Um[n]});let o=new vo(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return o.toFormat(o.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||Xi.logWithError(`${e} is not an integer.`),e<0&&Xi.logWithError(`${e} is negative.`),ps.DP=e,ps.RM=Gm[n]||1,new ps(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var Qm=me("Raydium_amount"),pu=No(Xm);function zm(r,e){let t="0",n="0";if(r.includes(".")){let o=r.split(".");o.length===2?([t,n]=o,n=n.padEnd(e,"0")):Qm.logWithError(`invalid number string, num: ${r}`)}else t=r;return[t,n.slice(0,e)||n]}var he=class extends Pe{token;logger;constructor(e,t,n=!0,o){let i=new zi(0),s=fs.pow(new zi(e.decimals));if(n)i=$(t);else{let a=new zi(0),c=new zi(0);if(typeof t=="string"||typeof t=="number"||typeof t=="bigint"){let[u,l]=zm(t.toString(),e.decimals);a=$(u),c=$(l)}a=a.mul(s),i=a.add(c)}super(i,s),this.logger=me(o||"TokenAmount"),this.token=e}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(e){return this.token.equals(e.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(e.raw)}lt(e){return this.token.equals(e.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(e.raw)}add(e){return this.token.equals(e.token)||this.logger.logWithError("add token not equals"),new he(this.token,this.raw.add(e.raw))}subtract(e){return this.token.equals(e.token)||this.logger.logWithError("sub token not equals"),new he(this.token,this.raw.sub(e.raw))}toSignificant(e=this.token.decimals,t,n=0){return super.toSignificant(e,t,n)}toFixed(e=this.token.decimals,t,n=0){return e>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(e,t,n)}toExact(e={groupSeparator:""}){return pu.DP=this.token.decimals,new pu(this.numerator.toString()).div(this.denominator.toString()).toFormat(e)}};import{PublicKey as Hm}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as fu}from"@solana/spl-token";var tn={chainId:101,address:Hm.default.toBase58(),programId:fu.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},Ze={chainId:101,address:"So11111111111111111111111111111111111111112",programId:fu.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};import{PublicKey as As}from"@solana/web3.js";import{PublicKey as ve,SystemProgram as yu,SYSVAR_RENT_PUBKEY as jm}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ym}from"@solana/spl-token";function P({pubkey:r,isSigner:e=!1,isWritable:t=!0}){return{pubkey:r,isWritable:t,isSigner:e}}var ys=[P({pubkey:Ym,isWritable:!1}),P({pubkey:yu.programId,isWritable:!1}),P({pubkey:jm,isWritable:!1})];function bs({publicKey:r,transformSol:e}){let t=gs(r.toString());if(t instanceof ve)return e&&t.equals($e)?j:t;if(e&&t.toString()===$e.toBase58())return j;if(typeof t=="string"){if(t===ve.default.toBase58())return ve.default;try{return new ve(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function gs(r){try{return new ve(r)}catch{return r}}var Hi=new ve("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),nn=new ve("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),Ge=new ve("SysvarRent111111111111111111111111111111111"),Ps=new ve("SysvarC1ock11111111111111111111111111111111"),qt=new ve("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),ji=new ve("Sysvar1nstructions1111111111111111111111111"),Yi=yu.programId,Uy=new ve("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Gy=new ve("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),Xy=new ve("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),Qy=new ve("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),zy=new ve("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),Hy=new ve("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),jy=new ve("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),Yy=new ve("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),Zy=new ve("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),$y=new ve("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),Jy=new ve("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),j=new ve("So11111111111111111111111111111111111111112"),$e=ve.default;function ut(r){return bs({publicKey:r,transformSol:!0})}var ws=class{symbol;name;decimals;isToken2022;mint;constructor({mint:e,decimals:t,symbol:n,name:o,skipMint:i=!1,isToken2022:s=!1}){if(e===$e.toBase58()||e instanceof As&&$e.equals(e)){this.decimals=Ze.decimals,this.symbol=Ze.symbol,this.name=Ze.name,this.mint=new As(Ze.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=o||e.toString().substring(0,6),this.mint=i?As.default:bs({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Me=ws;Ct(Me,"WSOL",new ws({...Ze,mint:Ze.address}));var ks=class{symbol;name;decimals;constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},Zi=ks;Ct(Zi,"SOL",new ks(tn));import Zm from"bn.js";var bu=new Pe(new Zm(100)),Je=class extends Pe{toSignificant(e=5,t,n){return this.mul(bu).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(bu).toFixed(e,t,n)}};var $m=me("Raydium_price"),kt=class extends Pe{baseToken;quoteToken;scalar;constructor(e){let{baseToken:t,quoteToken:n,numerator:o,denominator:i}=e;super(o,i),this.baseToken=t,this.quoteToken=n,this.scalar=new Pe(hs(t.decimals),hs(n.decimals))}get raw(){return new Pe(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new kt({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(e){this.quoteToken!==e.baseToken&&$m.logWithError("mul token not equals");let t=super.mul(e);return new kt({baseToken:this.baseToken,quoteToken:e.quoteToken,denominator:t.denominator,numerator:t.numerator})}toSignificant(e=this.quoteToken.decimals,t,n){return this.adjusted.toSignificant(e,t,n)}toFixed(e=this.quoteToken.decimals,t,n){return this.adjusted.toFixed(e,t,n)}};import{PublicKey as Jm}from"@solana/web3.js";import ed from"bn.js";function gu(r){return typeof r=="object"&&r!==null&&![Me,he,Jm,Pe,ed,kt,Je].some(e=>typeof e=="object"&&r instanceof e)}function Le(r){return typeof r=="string"?gs(r):Array.isArray(r)?r.map(e=>Le(e)):gu(r)?Object.fromEntries(Object.entries(r).map(([e,t])=>[e,Le(t)])):r}var ht=new on(0),Pu=new on(1),Hb=new on(2),jb=new on(3),Yb=new on(5),fs=new on(10),Zb=new on(100),$b=new on(1e3),Jb=new on(1e4);function hs(r){return fs.pow($(r))}function $i(r,e){let t=r.divmod(e);return t.mod.isZero()?t.div:t.div.isNeg()?t.div.isubn(1):t.div.iaddn(1)}function Ji(r,e,t){return r.mul(e).add(t).sub(new on(1)).div(t)}function Ts(r,e,t){return r.mul(e).div(t)}var Au=r=>typeof r=="number";function wu(r,e,t){let n=Au(e)?e*(t?.unit==="s"?1e3:1):e;return new Date(r).getTime()<=n}function ku(r,e,t){let n=Au(e)?e*(t?.unit==="s"?1e3:1):e;return new Date(r).getTime()>n}function ss(r,e=1,t=[]){let n=[...r];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}var Ut=class{_owner;constructor(e){this._owner=e}get publicKey(){return Ut.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return Ut.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return Ut.isKeyPair(this._owner)}get isPublicKey(){return Ut.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!Ut.isKeyPair(e)}};import{PublicKey as sd}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ad}from"@solana/spl-token";import{ComputeBudgetProgram as hu,Keypair as Tu,PublicKey as Iu,Transaction as er,TransactionMessage as td,VersionedTransaction as Bu}from"@solana/web3.js";var V={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",ClmmLockPosition:"ClmmLockPosition",ClmmHarvestLockPosition:"ClmmHarvestLockPosition",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV4Withdraw:"FarmV4Withdraw",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut",CpmmLockLp:"CpmmLockLp",CpmmCollectLockFee:"CpmmCollectLockFee",TransferTip:"TransferTip",NonceAccount:"NonceAccount"};import{TOKEN_PROGRAM_ID as nd}from"@solana/spl-token";var pn=me("Raydium_txUtil"),xu=1644;function so(r){let e=[],t=[];return r.microLamports&&(e.push(hu.setComputeUnitPrice({microLamports:r.microLamports})),t.push(V.SetComputeUnitPrice)),r.units&&(e.push(hu.setComputeUnitLimit({units:r.units})),t.push(V.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function ao(r,e){let t=e??"confirmed";return(await r.getLatestBlockhash?.({commitment:t}))?.blockhash}async function tr(r,e){return r.getSignatureStatuses([e]),new Promise((t,n)=>{let o=setTimeout(n,6e4);r.onSignature(e,i=>{if(clearTimeout(o),!i.err){t("");return}n(Object.assign(i.err,{txId:e}))},"confirmed")})}function nr(r,e){r.length<1&&pn.logWithError(`no instructions provided: ${r.toString()}`),e.length<1&&pn.logWithError(`no signers provided:, ${e.toString()}`);let t=new er;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...r);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<xu}catch{return!1}}async function Su(r,e,t,n=!0){let o=new Iu("RaydiumSimuLateTransaction11111111111111111"),i=[],s=new er;s.feePayer=o;for(let u of e)nr([...s.instructions,u],[o])||(i.push(s),s=new er,s.feePayer=o),s.add(u);s.instructions.length>0&&i.push(s);let a=[];try{if(a=await od(r,i,n),a.find(u=>u.err!==null))throw Error("rpc simulateTransaction error")}catch(u){u instanceof Error&&pn.logWithError("failed to simulate for instructions","RPC_ERROR",{message:u.message})}let c=[];for(let u of a)if(pn.debug("simulate result:",u),u.logs){let l=u.logs.filter(d=>d&&d.includes(t));pn.debug("filteredLog:",c),l.length||pn.logWithError("simulate log not match keyword","keyword",t),c.push(...l)}return c}function Ku(r,e){let t=r.match(/{["\w:,]+}/g);return!t||t.length!==1?pn.logWithError(`simulate log fail to match json, keyword: ${e}`):t[0]}function fn(r,e){let n=new RegExp(`"${e}":(\\d+)`,"g").exec(r);return!n||n.length!==2?pn.logWithError(`simulate log fail to match key", key: ${e}`):n[1]}function te(r,e){let[t,n]=Iu.findProgramAddressSync(r,e);return{publicKey:t,nonce:n}}async function od(r,e,t){let n=[];if(t){let o=await r.getLatestBlockhash(),i=[];for(let u of e){u.recentBlockhash=o.blockhash,u.lastValidBlockHeight=o.lastValidBlockHeight;let d=u._compile().serialize(),p=u._serialize(d).toString("base64");i.push(p)}let s=i.map(u=>{let l=r._buildArgs([u],void 0,"base64");return{methodName:"simulateTransaction",args:l}}),a=[],c=20;for(let u=0;u<Math.ceil(s.length/c);u++)a.push(s.slice(u*c,(u+1)*c));n=await(await Promise.all(a.map(async u=>(await r._rpcBatchRequest(u)).map(l=>l.result.value)))).flat()}else try{n=await Promise.all(e.map(async o=>await(await r.simulateTransaction(o)).value))}catch(o){o instanceof Error&&pn.logWithError("failed to get info for multiple accounts","RPC_ERROR",{message:o.message})}return n}function Mo({instructions:r,payer:e,signers:t}){return nr(r,[e,...t])}function Eo({instructions:r,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=Tu.generate().publicKey.toString()}){let i=new td({payerKey:e,recentBlockhash:n,instructions:r}).compileToV0Message(Object.values(t??{}));try{return Buffer.from(new Bu(i).serialize()).toString("base64").length<xu}catch{return!1}}var id=r=>Buffer.isBuffer(r)?r:r instanceof Uint8Array?Buffer.from(r.buffer,r.byteOffset,r.byteLength):Buffer.from(r),rd=r=>{let e=r.serialize({requireAllSignatures:!1,verifySignatures:!1});r instanceof Bu&&(e=id(e));try{return e instanceof Buffer?e.toString("base64"):Buffer.from(e).toString("base64")}catch{return e.toString("base64")}};function Wn(r){let e=[];return r.forEach(t=>{t instanceof er&&(t.recentBlockhash||(t.recentBlockhash=nd.toBase58()),t.feePayer||(t.feePayer=Tu.generate().publicKey)),e.push(rd(t))}),console.log("simulate tx string:",e),e}function Z(r,e,t){return te([r.toBuffer(),(t??ad).toBuffer(),e.toBuffer()],new sd("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import{PublicKey as ce}from"@solana/web3.js";var Is=new ce("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),Cu=new ce("CBuCnLe26faBpcBP2fktp4rp8abpcAnTWft6ZrP5Q4T"),Bs=new ce("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),uo=new ce("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),ud=new ce("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),xs=new ce("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),or=new ce("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),_o=new ce("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),cd=new ce("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),ir=new ce("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Sn=new ce("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),co=new ce("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Fo=new ce("kN1kEznaF5Xbd8LYuqtEFcxzWSBk5Fv6ygX6SqEGJVy"),ld=new ce("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),Lu=new ce("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),md=new ce("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),dd=new ce("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),pd=new ce("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),fd=new ce("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),Vo=new ce("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),Ss=new ce("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),yd=new ce("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),bd=new ce("CPMDWBwJDtYax9qW7AyRuVC19Cc4L4Vcy4n2BHAbHkCW"),gd=new ce("7rQ1QFNosMkUCuh7Z7fPbTHvh73b68sQYdirycEzJVuw"),Pd=new ce("G11FKBRaAkHAKuLCgLM6K6NUc9rTjPAznRCjZifrTQe2"),Wo=new ce("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Ad=new ce("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),Do=new ce("3f7GcQFG397GAaEnv51zR6tsTVihYRydnydDD1cXekxH"),wd=new ce("7AFUeLVRjBfzqK3tTGw8hN48KLQWSk6DTE8xprWdPqix"),Gt=new ce("LanMV9sAd7wArD4vJFi2qDdfnVhFxYSUg6eADduJ3uj"),kd=new ce("WLHv2UAZm6z4KyaaELi5pjdbJh6RESMva1Rnn8pJVVh"),hd=new ce("LanD8FpTBBvzZFXjTxsAoipkFsxPUCDB4qAqKxYDiNP"),Td=new ce("HYNHiyKJ3gGVFvyxJAurK7qr7P2o5J9THmvCGMdULtpW"),qo={IDO_PROGRAM_ID_V1:md,IDO_PROGRAM_ID_V2:dd,IDO_PROGRAM_ID_V3:pd,IDO_PROGRAM_ID_V4:fd},ft={AMM_V4:_o,AMM_STABLE:cd,CLMM_PROGRAM_ID:Sn,CLMM_LOCK_PROGRAM_ID:co,CLMM_LOCK_AUTH_ID:Fo,FARM_PROGRAM_ID_V3:Is,FARM_PROGRAM_ID_V5:Bs,FARM_PROGRAM_ID_V6:uo,OPEN_BOOK_PROGRAM:xs,SERUM_PROGRAM_ID_V3:or,UTIL1216:ud,Router:ld,CREATE_CPMM_POOL_PROGRAM:Vo,CREATE_CPMM_POOL_AUTH:Ss,CREATE_CPMM_POOL_FEE_ACC:yd,LOCK_CPMM_PROGRAM:Wo,LOCK_CPMM_AUTH:Do,LAUNCHPAD_PROGRAM:Gt,LAUNCHPAD_AUTH:kd},wg={SERUM_MARKET:ce.default,OPENBOOK_MARKET:new ce("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),UTIL1216:ce.default,FarmV3:new ce("85BFyr98MbCUU9MVTEgzx1nbhWACbJqLzho6zd6DZcWL"),FarmV5:new ce("EcLzTrNg9V7qhcdyXDe2qjtPkiGzDM2UbdRaeaadU5r2"),FarmV6:new ce("Farm2hJLcqPtPg8M4rR6DMrsRNc5TPm5Cs4bVQrMe2T7"),AmmV4:new ce("HWy1jotHpo6UqeQxx49dpYYdQB8wj9Qk9MdxwjLvDHB8"),AmmStable:new ce("DDg4VmQaJV9ogWce7LpcjBA9bv22wRp5uaTPa5pGjijF"),CLMM:new ce("devi51mZmdwUJGU9hjN27vEz64Gps7uUefqxg27EAtH"),CLMM_LOCK_PROGRAM_ID:new ce("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),CLMM_LOCK_AUTH_ID:new ce("8qmHNvu2Kr2C7U8mJL4Vz1vTDxMhVuXKREwU7TNoaVEo"),Router:new ce("BVChZ3XFEwTMUk1o9i3HAf91H6mFxSwa5X2wFAWhYPhU"),CREATE_CPMM_POOL_PROGRAM:bd,CREATE_CPMM_POOL_AUTH:gd,CREATE_CPMM_POOL_FEE_ACC:Pd,FEE_DESTINATION_ID:new ce("3XMrhbv989VxAMi3DErLV9eJht1pHppW5LbKxe9fkEFR"),LOCK_CPMM_PROGRAM:Ad,LCOK_CPMM_AUTH:wd,LAUNCHPAD_PROGRAM:hd,LAUNCHPAD_AUTH:Td};import yt from"bn.js";var Uo=1e4;function Ae(r,e,t,n){if(e===void 0)return{amount:r,fee:void 0,expirationTime:void 0};let o={...e,olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}},i=t.epoch<o.newerTransferFee.epoch?o.olderTransferFee:o.newerTransferFee,s=new yt(i.maximumFee.toString()),a=t.epoch<o.newerTransferFee.epoch?(Number(o.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(i.transferFeeBasisPoints===Uo){let c=new yt(i.maximumFee.toString());return{amount:r.add(c),fee:c,expirationTime:a}}else{let c=Kn(r.mul(new yt(Uo)),new yt(Uo-i.transferFeeBasisPoints)),u=new yt(i.maximumFee.toString()),l=c.sub(r).gt(u)?r.add(u):c,d=Kn(l.mul(new yt(i.transferFeeBasisPoints)),new yt(Uo)),m=d.gt(s)?s:d;return{amount:l,fee:m,expirationTime:a}}else{let c=Kn(r.mul(new yt(i.transferFeeBasisPoints)),new yt(Uo)),u=c.gt(s)?s:c;return{amount:r,fee:u,expirationTime:a}}}function Xt(r,e){return r===void 0?e:e===void 0?r:Math.min(r,e)}function Kn(r,e){let{div:t,mod:n}=r.divmod(e);return n.gt(new yt(0))?t.add(new yt(1)):t}function rr(r,e){if(r.isZero())return new yt(0);let t=r.div(e);return t.isZero()?new yt(1):r.mod(e).gt(new yt(0))?t.add(new yt(1)):t}import{PublicKey as Ru,AddressLookupTableAccount as sr}from"@solana/web3.js";async function Ks({connection:r,address:e}){let t=await Vt(r,[...new Set(e.map(o=>o.toString()))].map(o=>new Ru(o))),n={};for(let o=0;o<e.length;o++){let i=t[o],s=e[o];if(!i)continue;let a=new sr({key:s,state:sr.deserialize(i.data)});n[s.toString()]=a,ar[s.toString()]=a}return n}var ar={AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU:new sr({key:new Ru("AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU"),state:sr.deserialize(Buffer.from("AQAAAP//////////I1rcEwAAAAAvAQYwun9CU6c5Ikm2pAj+D9IEnCOR45nK+SFTGSdpd6J6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAbd9uHXZaGT2cvhRs7reawctIXtX1s3kTqM9YV+/wCpBt324e51j94YQl285GzN2rYa/E2DuQ0n/r35KNihi/wFSlNQ+F3IgtYUpVZyeIopbd8eq6vQpgZ4iEky9O72oAVKU1qZKSEGTSTocWDaOHx8NbXdvJK7geQfqEBBBUSNBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvBkX2T9y7AHdNGviJAqQNtlDUDCnauQRWybsLji6nPM8Qkw5asQRvCdB3MbX6IEBwytOrpM32l4jQygKG9TKgR0vZScQ2AsM/IHeQ7RajUkyhuZdc8SGiqQz/7H34torNR/Wir3sl0ruUrVxJWEZfUg+QLNAxxODdBi53/OP7Ioil1cqeBM9dtZC3FLov4yyxWRM/wcGStyJX/QfTnLBAHqkqWotPKVlShCVQqpP9W5W1rOao65IMk5QuQ2kMIOxzDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu/YsA/yfEEFGcr8Z57VKDw8uQzpiru7g4lvjnfapW62W030syevD8k07SGoxUHiuT/ai7gAHWWhDsVmg/C63ajgpkH7Sn3GdutArDTfyqOkdqv4/IPC/EFFy7mGkfDd2C57N5a/4jC+BbmJy7wQaSEZr0CQU88lPtUxIVvzGjC95b8Ooss2TqmkrayGKofkPMGQn7Ux+9lfwBSNfxwH8NgbpqC/7LNlV4I7nCvsXf3p+ohQk9NrAJb2KAFpUqEIJ9ZBV7BYDzHF/ORKYlgtvPnXjudZQ6CEo5OzUDaNIomTCCsvhD16TxJjsbgne1kGnQPCFSoaxUbq2V1bPMFQ3VYP6wDZ9bKStCFKx9A3tNbwZFC5ZGAN83MFK7XoTy+OmmcFEr6rLOjfSuTfPvHJkSVxW6Qllwkl67XcBi5v00u2gQsbu+38sp+rd5pA/LvyWj4P94ZGZwc1tE2P88xekCLcAwZGb+UhFzL/7K26csOb57yM5bvF9xJrLEObOkAAAAAn+HWRkdcPKyFFMnVwEoD7vnD0jCKFIU1sImubYCxNTSVzsKpaQX+fzNxrLAI3L14JQnJx/D6Uk2LADIHGqnGELzjEbkBDAlaM77NkXMPfqXNLSveCkWI7UEgNs31WEWB6XHSYI/v5DklHOb4QTtDOR804PVbi3fjloZeLR2F8d4FuZmMMO7ck3Fnkn2zEMG5gOmqsygb6PjTitArVl52NhcSznTxVnguaIJxiZkAnurDmn3MWR0PC2GLghp2KJqHCc6QQ85odeIjFHKOlRlJyeSXVJmL8vb1UgOzsbJPVP8p6zM4M3C1Sd7uWIHP33G42AP2Zg8ucn/n6meQjjD266JgCWdxZD6PXs9CsnIeL7SSG0/6lGb9xfP0ZcWkCXB/3hjxHYVXjra/GPOeXGk0fLLKjCbk+mgs2w6d2oCwimBipTzuoZ30GiI8ij8VRzD5CzMWtu2m21eDBIfjGAEo4pQeNNonKcqzV/cleX8ySZLOHsz8PtBCrLqF+VkLm9hOzIT+6i/nIf6keR4GWKMOD4AvqfpjHoD4DuhBpz8P28+DxkGrDXXr/nr20x291VPvcTU/b+b+o2kC9G0kcXeTlLjU6a2TQXWlZ4gBUdBl1jgT7mObSTpLblNiXZsLkbmVXZwvFKXua5cUKlWed/w30skmEUraTuQqtqr5fHZPW9n57EmeTif6LjHL2YJFZkQU+TrJmFzqzmF4/b8OwrPQAprl8mX3q4LUIdAS/a+11B6DWD1Xk2++Sn94dLC4xjkO4Wtlw8c4XuzciVbepHOmnoWzVu/0y3KCrLCSfQxQ3br8DJCoVzhgtPsS2nZZjsBGIZgnU0QpMv+2MnRsnKwdp1VsrCX84j/qvaZn4WhKunippgTbN2EUs0tPTP55Qfgj+nKmjtWW5IYs72FrEwJKYoNfsmqaF4o5pf4v9zgPwVwY/5I4XJKUL2L25m9kAQcW/K+H1RTFEUoj8Z4ajpOmAB/dG0COmCphVMW2CCMvnxhcGiSgPnpDuWu6qiJ7NG7ye5kvHgefgqPLeicspNJ5EpL3XiRNLM2tmJLI1awAwOyd6iHv0dCkMYRKaa6rcaZeYwmKCkckm0kM2JNmnmmAaBQQ7mwmIM0IMxX4f5W6j9PqZWcJxF7r17T/lQBAmcjoupRiJifbnXCNUv9GhpRF19WcBdeKbivRJVlGop6I2RS6lGImJ9udcI1S/0aGlEXX1ZwF14puK9ElWUainojZFYVHLHD6dIP2ESjqBzg3ol1/wB7+/ylGwd9LS7wSZ2A630CJSVKwH47K9P4bB8PEQP8BwjMFa7xQHOqZFP1XqaQ==","base64"))})};import{PublicKey as lo,sendAndConfirmTransaction as Cs,SystemProgram as Id,Transaction as Go,TransactionMessage as Xo,VersionedTransaction as Qo}from"@solana/web3.js";import Bd from"axios";var ur=2e3,cr=class{connection;owner;instructions=[];endInstructions=[];lookupTableAddress=[];signers=[];instructionTypes=[];endInstructionTypes=[];feePayer;cluster;signAllTransactions;blockhashCommitment;loopMultiTxStatus;constructor(e){this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster,this.blockhashCommitment=e.blockhashCommitment,this.loopMultiTxStatus=!!e.loopMultiTxStatus}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){let e=(await Bd.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=e?.[15]??{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=so(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}addTipInstruction(e){return e?(this.endInstructions.push(Id.transfer({fromPubkey:e.feePayer??this.feePayer,toPubkey:new lo(e.address),lamports:BigInt(e.amount.toString())})),this.endInstructionTypes.push(V.TransferTip),!0):!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:o=[],endInstructionTypes:i=[],lookupTableAddress:s=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...o),this.endInstructionTypes.push(...i),this.lookupTableAddress.push(...s.filter(a=>a!==lo.default.toString())),this}async versionBuild({txVersion:e,extInfo:t},n){return e===0?await this.buildV0({...t||{}},n):this.build(t,n)}build(e,t){let n=new Go;return this.allInstructions.length&&n.add(...this.allInstructions),n.feePayer=this.feePayer,this.owner?.signer&&!this.signers.some(o=>o.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer),{builder:this,transaction:n,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async o=>{let{recentBlockHash:i,skipPreflight:s=!0,sendAndConfirm:a,notSendToRpc:c}=o||{},u=i??t??await ao(this.connection,this.blockhashCommitment);if(n.recentBlockhash=u,this.signers.length&&n.sign(...this.signers),Wn([n]),this.owner?.isKeyPair)return{txId:a?await Cs(this.connection,n,this.signers.find(d=>d.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:s}):await this.connection.sendRawTransaction(n.serialize(),{skipPreflight:s}),signedTx:n};if(this.signAllTransactions){let l=await this.signAllTransactions([n]);if(this.signers.length)for(let d of l)try{d.sign(...this.signers)}catch{}return{txId:c?"":await this.connection.sendRawTransaction(l[0].serialize(),{skipPreflight:s}),signedTx:l[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:o}=this.build(n),i=t.filter(u=>u.transaction.instructions.length>0),s=[o,...i.map(u=>u.transaction)],a=[this.signers,...i.map(u=>u.signers)],c=[...this.instructionTypes,...i.map(u=>u.instructionTypes).flat()];return this.owner?.signer&&a.forEach(u=>{u.some(l=>l.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:c,execute:async u=>{let{sequentially:l,onTxUpdate:d,skipTxCount:m=0,recentBlockHash:p,skipPreflight:y=!0}=u||{},f=p??await ao(this.connection,this.blockhashCommitment);if(this.owner?.isKeyPair){if(l){let b=[],g=0;for(let w of s){if(++g,g<=m)continue;let k=await Cs(this.connection,w,this.signers.find(h=>h.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:y});b.push(k)}return{txIds:b,signedTxs:s}}return{txIds:await await Promise.all(s.map(async b=>(b.recentBlockhash=f,await this.connection.sendRawTransaction(b.serialize(),{skipPreflight:y})))),signedTxs:s}}if(this.signAllTransactions){let b=s.map((w,k)=>(w.recentBlockhash=f,a[k].length&&w.sign(...a[k]),w));Wn(b);let g=await this.signAllTransactions(b);if(l){let w=0,k=[],h=async()=>{if(!g[w])return;let x=await this.connection.sendRawTransaction(g[w].serialize(),{skipPreflight:y});k.push({txId:x,status:"sent",signedTx:g[w]}),d?.([...k]),w++;let T=!1,B=null,S=null,I=K=>{B!==null&&clearInterval(B),S!==null&&this.connection.removeSignatureListener(S);let N=k.findIndex(v=>v.txId===x);if(N>-1){if(k[N].status==="error"||k[N].status==="success")return;k[N].status=K.err?"error":"success"}d?.([...k]),K.err||h()};this.loopMultiTxStatus&&(B=setInterval(async()=>{if(T){clearInterval(B);return}try{let K=await this.connection.getTransaction(x,{commitment:"confirmed",maxSupportedTransactionVersion:0});K&&(T=!0,clearInterval(B),I({err:K.meta?.err||null}),console.log("tx status from getTransaction:",x))}catch(K){T=!0,clearInterval(B),console.error("getTransaction timeout:",K,x)}},ur)),S=this.connection.onSignature(x,K=>{if(T){this.connection.removeSignatureListener(S);return}T=!0,I(K)},"confirmed"),this.connection.getSignatureStatus(x)};return await h(),{txIds:k.map(x=>x.txId),signedTxs:g}}else{let w=[];for(let k=0;k<g.length;k+=1){let h=await this.connection.sendRawTransaction(g[k].serialize(),{skipPreflight:y});w.push(h)}return{txIds:w,signedTxs:g}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e,t){let{lookupTableCache:n={},lookupTableAddress:o=[],forerunCreate:i,recentBlockhash:s,...a}=e||{},c={...this.cluster==="devnet"?{}:ar,...n},u=Array.from(new Set([...o,...this.lookupTableAddress])),l=[];for(let y of u)c[y]===void 0&&l.push(new lo(y));if(l.length>0){let y=await Ks({connection:this.connection,address:l});for(let[f,b]of Object.entries(y))c[f]=b}let d=t??(i?lo.default.toBase58():s??await ao(this.connection,this.blockhashCommitment)),m=new Xo({payerKey:this.feePayer,recentBlockhash:d,instructions:[...this.allInstructions]}).compileToV0Message(Object.values(c));this.owner?.signer&&!this.signers.some(y=>y.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer);let p=new Qo(m);return p.sign(this.signers),{builder:this,transaction:p,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async y=>{let{skipPreflight:f=!0,sendAndConfirm:b,notSendToRpc:g}=y||{};if(Wn([p]),this.owner?.isKeyPair){let w=await this.connection.sendTransaction(p,{skipPreflight:f});return b&&await tr(this.connection,w),{txId:w,signedTx:p}}if(this.signAllTransactions){let w=await this.signAllTransactions([p]);if(this.signers.length)for(let k of w)try{k.sign(this.signers)}catch{}return{txId:g?"":await this.connection.sendTransaction(w[0],{skipPreflight:f}),signedTx:w[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:a||{}}}async buildV0MultiTx(e){let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:o}=await this.buildV0(n),i=t.filter(u=>u.builder.instructions.length>0),s=[o,...i.map(u=>u.transaction)],a=[this.signers,...i.map(u=>u.signers)],c=[...this.instructionTypes,...i.map(u=>u.instructionTypes).flat()];return this.owner?.signer&&a.forEach(u=>{u.some(l=>l.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),s.forEach(async(u,l)=>{u.sign(a[l])}),{builder:this,transactions:s,signers:a,instructionTypes:c,buildProps:n,execute:async u=>{let{sequentially:l,onTxUpdate:d,recentBlockHash:m,skipPreflight:p=!0}=u||{};if(m&&s.forEach(y=>y.message.recentBlockhash=m),Wn(s),this.owner?.isKeyPair){if(l){let y=[];for(let f of s){let b=await this.connection.sendTransaction(f,{skipPreflight:p});await tr(this.connection,b),y.push(b)}return{txIds:y,signedTxs:s}}return{txIds:await Promise.all(s.map(async y=>await this.connection.sendTransaction(y,{skipPreflight:p}))),signedTxs:s}}if(this.signAllTransactions){let y=await this.signAllTransactions(s);if(l){let f=0,b=[],g=async()=>{if(!y[f])return;let w=await this.connection.sendTransaction(y[f],{skipPreflight:p});b.push({txId:w,status:"sent",signedTx:y[f]}),d?.([...b]),f++;let k=!1,h=null,x=null,T=B=>{h!==null&&clearInterval(h),x!==null&&this.connection.removeSignatureListener(x);let S=b.findIndex(I=>I.txId===w);if(S>-1){if(b[S].status==="error"||b[S].status==="success")return;b[S].status=B.err?"error":"success"}d?.([...b]),B.err||g()};this.loopMultiTxStatus&&(h=setInterval(async()=>{if(k){clearInterval(h);return}try{let B=await this.connection.getTransaction(w,{commitment:"confirmed",maxSupportedTransactionVersion:0});B&&(k=!0,clearInterval(h),T({err:B.meta?.err||null}),console.log("tx status from getTransaction:",w))}catch(B){k=!0,clearInterval(h),console.error("getTransaction timeout:",B,w)}},ur)),x=this.connection.onSignature(w,B=>{if(k){this.connection.removeSignatureListener(x);return}k=!0,T(B)},"confirmed"),this.connection.getSignatureStatus(w)};return g(),{txIds:[],signedTxs:y}}else{let f=[];for(let b=0;b<y.length;b+=1){let g=await this.connection.sendTransaction(y[b],{skipPreflight:p});f.push(g)}return{txIds:f,signedTxs:y}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){let{splitIns:t=[],computeBudgetConfig:n,...o}=e||{},i=n?so(n):{instructions:[],instructionTypes:[]},s=this.signers.reduce((d,m)=>({...d,[m.publicKey.toBase58()]:m}),{}),a=[],c=[],u=[],l=0;if(this.allInstructions.forEach(d=>{let m=[...u,d],p=n?[...i.instructions,...m]:m,f=[...new Set(m.map(b=>b.keys.filter(g=>g.isSigner).map(g=>g.pubkey.toString())).flat()).values()].map(b=>new lo(b));if(d!==t[l]&&u.length<12&&(Mo({instructions:p,payer:this.feePayer,signers:f})||Mo({instructions:m,payer:this.feePayer,signers:f})))u.push(d);else{if(u.length===0)throw Error("item ins too big");l+=d===t[l]?1:0,Mo({instructions:n?[...i.instructions,...u]:[...u],payer:this.feePayer,signers:f})?a.push(new Go().add(...i.instructions,...u)):a.push(new Go().add(...u)),c.push(Array.from(new Set(u.map(b=>b.keys.filter(g=>g.isSigner).map(g=>g.pubkey.toString())).flat())).map(b=>s[b]).filter(b=>b!==void 0)),u=[d]}}),u.length>0){let m=[...new Set(u.map(p=>p.keys.filter(y=>y.isSigner).map(y=>y.pubkey.toString())).flat()).values()].map(p=>s[p]).filter(p=>p!==void 0);Mo({instructions:n?[...i.instructions,...u]:[...u],payer:this.feePayer,signers:m.map(p=>p.publicKey)})?a.push(new Go().add(...i.instructions,...u)):a.push(new Go().add(...u)),c.push(m)}return a.forEach(d=>d.feePayer=this.feePayer),this.owner?.signer&&c.forEach(d=>{d.some(m=>m.publicKey.equals(this.owner.publicKey))||d.push(this.owner.signer)}),{builder:this,transactions:a,signers:c,instructionTypes:this.instructionTypes,execute:async d=>{let{sequentially:m,onTxUpdate:p,skipTxCount:y=0,recentBlockHash:f,skipPreflight:b=!0}=d||{},g=f??await ao(this.connection,this.blockhashCommitment);if(a.forEach(async(w,k)=>{w.recentBlockhash=g,c[k].length&&w.sign(...c[k])}),Wn(a),this.owner?.isKeyPair){if(m){let w=0,k=[];for(let h of a){if(++w,w<=y){k.push("tx skipped");continue}let x=await Cs(this.connection,h,this.signers.find(T=>T.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:b});k.push(x)}return{txIds:k,signedTxs:a}}return{txIds:await Promise.all(a.map(async w=>await this.connection.sendRawTransaction(w.serialize(),{skipPreflight:b}))),signedTxs:a}}if(this.signAllTransactions){let w=await this.signAllTransactions(a.slice(y,a.length)),k=[...a.slice(0,y),...w];if(m){let h=0,x=[],T=async()=>{if(!k[h])return;h<y&&(x.push({txId:"",status:"success",signedTx:k[h]}),p?.([...x]),h++,T());let B=await this.connection.sendRawTransaction(k[h].serialize(),{skipPreflight:b});x.push({txId:B,status:"sent",signedTx:k[h]}),p?.([...x]),h++;let S=!1,I=null,K=null,N=v=>{I!==null&&clearInterval(I),K!==null&&this.connection.removeSignatureListener(K);let _=x.findIndex(D=>D.txId===B);if(_>-1){if(x[_].status==="error"||x[_].status==="success")return;x[_].status=v.err?"error":"success"}p?.([...x]),v.err||T()};this.loopMultiTxStatus&&(I=setInterval(async()=>{if(S){clearInterval(I);return}try{let v=await this.connection.getTransaction(B,{commitment:"confirmed",maxSupportedTransactionVersion:0});v&&(S=!0,clearInterval(I),N({err:v.meta?.err||null}),console.log("tx status from getTransaction:",B))}catch(v){S=!0,clearInterval(I),console.error("getTransaction timeout:",v,B)}},ur)),K=this.connection.onSignature(B,v=>{if(S){this.connection.removeSignatureListener(K);return}S=!0,N(v)},"confirmed"),this.connection.getSignatureStatus(B)};return await T(),{txIds:x.map(B=>B.txId),signedTxs:k}}else{let h=[];for(let x=0;x<k.length;x+=1){let T=await this.connection.sendRawTransaction(k[x].serialize(),{skipPreflight:b});h.push(T)}return{txIds:h,signedTxs:k}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:o||{}}}async sizeCheckBuildV0(e){let{computeBudgetConfig:t,splitIns:n=[],lookupTableCache:o={},lookupTableAddress:i=[],...s}=e||{},a={...this.cluster==="devnet"?{}:ar,...o},c=Array.from(new Set([...this.lookupTableAddress,...i])),u=[];for(let w of c)a[w]===void 0&&u.push(new lo(w));let l=await Ks({connection:this.connection,address:u});for(let[w,k]of Object.entries(l))a[w]=k;let d=t?so(t):{instructions:[],instructionTypes:[]},m=await ao(this.connection,this.blockhashCommitment),p=this.signers.reduce((w,k)=>({...w,[k.publicKey.toBase58()]:k}),{}),y=[],f=[],b=[],g=0;if(this.allInstructions.forEach(w=>{let k=[...b,w],h=t?[...d.instructions,...k]:k;if(w!==n[g]&&b.length<12&&(Eo({instructions:h,payer:this.feePayer,lookupTableAddressAccount:a})||Eo({instructions:k,payer:this.feePayer,lookupTableAddressAccount:a})))b.push(w);else{if(b.length===0)throw Error("item ins too big");g+=w===n[g]?1:0;let x={};for(let T of[...new Set(c)])a[T]!==void 0&&(x[T]=a[T]);if(t&&Eo({instructions:[...d.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:a,recentBlockhash:m})){let T=new Xo({payerKey:this.feePayer,recentBlockhash:m,instructions:[...d.instructions,...b]}).compileToV0Message(Object.values(a));y.push(new Qo(T))}else{let T=new Xo({payerKey:this.feePayer,recentBlockhash:m,instructions:[...b]}).compileToV0Message(Object.values(a));y.push(new Qo(T))}f.push(Array.from(new Set(b.map(T=>T.keys.filter(B=>B.isSigner).map(B=>B.pubkey.toString())).flat())).map(T=>p[T]).filter(T=>T!==void 0)),b=[w]}}),b.length>0){let k=[...new Set(b.map(h=>h.keys.filter(x=>x.isSigner).map(x=>x.pubkey.toString())).flat()).values()].map(h=>p[h]).filter(h=>h!==void 0);if(t&&Eo({instructions:[...d.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:a,recentBlockhash:m})){let h=new Xo({payerKey:this.feePayer,recentBlockhash:m,instructions:[...d.instructions,...b]}).compileToV0Message(Object.values(a));y.push(new Qo(h))}else{let h=new Xo({payerKey:this.feePayer,recentBlockhash:m,instructions:[...b]}).compileToV0Message(Object.values(a));y.push(new Qo(h))}f.push(k)}return this.owner?.signer&&f.forEach(w=>{w.some(k=>k.publicKey.equals(this.owner.publicKey))||w.push(this.owner.signer)}),y.forEach((w,k)=>{w.sign(f[k])}),{builder:this,transactions:y,buildProps:e,signers:f,instructionTypes:this.instructionTypes,execute:async w=>{let{sequentially:k,onTxUpdate:h,skipTxCount:x=0,recentBlockHash:T,skipPreflight:B=!0}=w||{};if(y.map(async(S,I)=>{f[I].length&&S.sign(f[I]),T&&(S.message.recentBlockhash=T)}),Wn(y),this.owner?.isKeyPair){if(k){let S=0,I=[];for(let K of y){if(++S,S<=x){console.log("skip tx: ",S),I.push("tx skipped");continue}let N=await this.connection.sendTransaction(K,{skipPreflight:B});await tr(this.connection,N),I.push(N)}return{txIds:I,signedTxs:y}}return{txIds:await Promise.all(y.map(async S=>await this.connection.sendTransaction(S,{skipPreflight:B}))),signedTxs:y}}if(this.signAllTransactions){let S=await this.signAllTransactions(y.slice(x,y.length)),I=[...y.slice(0,x),...S];if(k){let K=0,N=[],v=async()=>{if(!I[K])return;if(K<x){N.push({txId:"",status:"success",signedTx:I[K]}),h?.([...N]),K++,v();return}let _=await this.connection.sendTransaction(I[K],{skipPreflight:B});N.push({txId:_,status:"sent",signedTx:I[K]}),h?.([...N]),K++;let D=!1,q=null,G=null,Y=ie=>{q!==null&&clearInterval(q),G!==null&&this.connection.removeSignatureListener(G);let ke=N.findIndex(re=>re.txId===_);if(ke>-1){if(N[ke].status==="error"||N[ke].status==="success")return;N[ke].status=ie.err?"error":"success"}h?.([...N]),ie.err||v()};this.loopMultiTxStatus&&(q=setInterval(async()=>{if(D){clearInterval(q);return}try{let ie=await this.connection.getTransaction(_,{commitment:"confirmed",maxSupportedTransactionVersion:0});ie&&(D=!0,clearInterval(q),Y({err:ie.meta?.err||null}),console.log("tx status from getTransaction:",_))}catch(ie){D=!0,clearInterval(q),console.error("getTransaction timeout:",ie,_)}},ur)),G=this.connection.onSignature(_,ie=>{if(D){this.connection.removeSignatureListener(G);return}D=!0,Y(ie)},"confirmed"),this.connection.getSignatureStatus(_)};return v(),{txIds:[],signedTxs:I}}else{let K=[];for(let N=0;N<I.length;N+=1){let v=await this.connection.sendTransaction(I[N],{skipPreflight:B});K.push(v)}return{txIds:K,signedTxs:I}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}};import xd from"bn.js";var Qt=new xd(1e6);var et={BASE_HOST:"https://api-v3.raydium.io",OWNER_BASE_HOST:"https://owner-v1.raydium.io",SERVICE_BASE_HOST:"https://service.raydium.io",MONITOR_BASE_HOST:"https://monitor.raydium.io",SERVICE_1_BASE_HOST:"https://service-v1.raydium.io",SEND_TRANSACTION:"/send-transaction",FARM_ARP:"/main/farm/info",FARM_ARP_LINE:"/main/farm-apr-tv",CLMM_CONFIG:"/main/clmm-config",CPMM_CONFIG:"/main/cpmm-config",VERSION:"/main/version",CHECK_AVAILABILITY:"/v3/main/AvailabilityCheckAPI",RPCS:"/main/rpcs",INFO:"/main/info",STAKE_POOLS:"/main/stake-pools",CHAIN_TIME:"/main/chain-time",TOKEN_LIST:"/mint/list",MINT_INFO_ID:"/mint/ids",JUP_TOKEN_LIST:"https://lite-api.jup.ag/tokens/v1/tagged/verified",POOL_LIST:"/pools/info/list",POOL_SEARCH_BY_ID:"/pools/info/ids",POOL_SEARCH_MINT:"/pools/info/mint",POOL_SEARCH_LP:"/pools/info/lps",POOL_KEY_BY_ID:"/pools/key/ids",POOL_LIQUIDITY_LINE:"/pools/line/liquidity",POOL_POSITION_LINE:"/pools/line/position",FARM_INFO:"/farms/info/ids",FARM_LP_INFO:"/farms/info/lp",FARM_KEYS:"/farms/key/ids",OWNER_CREATED_FARM:"/create-pool/{owner}",OWNER_IDO:"/main/ido/{owner}",OWNER_STAKE_FARMS:"/position/stake/{owner}",OWNER_LOCK_POSITION:"/position/clmm-lock/{owner}",IDO_KEYS:"/ido/key/ids",SWAP_HOST:"https://transaction-v1.raydium.io",SWAP_COMPUTE:"/compute/",SWAP_TX:"/transaction/",MINT_PRICE:"/mint/price",MIGRATE_CONFIG:"/main/migrate-lp",PRIORITY_FEE:"/main/auto-fee",CPMM_LOCK:"https://dynamic-ipfs.raydium.io/lock/cpmm/position"},uP={...et};var Nu="ray_tab_hash",Ls="ray_req_hash",Sd=()=>{if(typeof window===void 0)return"";let r=sessionStorage.getItem(Nu);return r||(r=`ray-${Date.now()}`,sessionStorage.setItem(Nu,r)),r},lr=async({logCount:r=1e3,removeLastLog:e,...t})=>{if(typeof window===void 0)return new Promise(o=>o());let n=JSON.parse(localStorage.getItem(Ls)||"[]").slice(0,r-1);e&&n.pop(),new Blob([JSON.stringify(t.data)]).size>1024&&(t.data=JSON.stringify(t.data).substring(0,200)+"..."),n.unshift({...t,time:Date.now(),session:Sd()});try{localStorage.setItem(Ls,JSON.stringify(n))}catch{if(e){let o=!1,i=JSON.stringify(t.data).substring(0,100);for(n[0].data=i+(i.length>100?"...":"");!o;){n.pop();let s=JSON.stringify(t.data).substring(0,100);n[0].data=s+(s.length>100?"...":"");try{localStorage.setItem(Ls,JSON.stringify(n)),o=!0}catch{o=!1}}return new Promise(s=>s())}return lr({...t,logCount:r,removeLastLog:!0})}};import{TOKEN_2022_PROGRAM_ID as Kd,TOKEN_PROGRAM_ID as Cd}from"@solana/spl-token";var mr=me("Raydium_Api"),Rs=new Map;var dr=class{cluster;api;logCount;urlConfigs;constructor({cluster:e,timeout:t,logRequests:n,logCount:o,urlConfigs:i}){this.cluster=e,this.urlConfigs=i||{},this.logCount=o||1e3,this.api=Ou.create({baseURL:this.urlConfigs.BASE_HOST||et.BASE_HOST,timeout:t}),this.api.interceptors.request.use(s=>{let{method:a,baseURL:c,url:u}=s;return mr.debug(`${a?.toUpperCase()} ${c}${u}`),s},s=>(mr.error("Request failed"),Promise.reject(s))),this.api.interceptors.response.use(s=>{let{config:a,data:c,status:u}=s,{method:l,baseURL:d,url:m}=a;return n&&lr({status:u,url:`${d}${m}`,params:a.params,data:c,logCount:this.logCount}),mr.debug(`${l?.toUpperCase()} ${d}${m}  ${u}`),c},s=>{let{config:a,response:c={}}=s,{status:u}=c,{method:l,baseURL:d,url:m}=a;return n&&lr({status:u,url:`${d}${m}`,params:a.params,data:s.message,logCount:this.logCount}),mr.error(`${l.toUpperCase()} ${d}${m} ${u||s.message}`),Promise.reject(s)})}async getClmmConfigs(){return(await this.api.get(this.urlConfigs.CLMM_CONFIG||et.CLMM_CONFIG)).data}async getCpmmConfigs(){return(await this.api.get(this.urlConfigs.CPMM_CONFIG||et.CPMM_CONFIG)).data}async getClmmPoolLines(e){return(await this.api.get(`${this.urlConfigs.POOL_LIQUIDITY_LINE||et.POOL_LIQUIDITY_LINE}?pool_id=${e}`)).data}async getBlockSlotCountForSecond(e){if(!e)return 2;let n=(await Ou.post(e,{id:"getRecentPerformanceSamples",jsonrpc:"2.0",method:"getRecentPerformanceSamples",params:[4]})).result.map(o=>o.numSlots);return n.reduce((o,i)=>o+i,0)/n.length/60}async getChainTimeOffset(){return(await this.api.get(this.urlConfigs.CHAIN_TIME||et.CHAIN_TIME)).data}async getRpcs(){return this.api.get(this.urlConfigs.RPCS||et.RPCS)}async getTokenList(){return(await this.api.get(this.urlConfigs.TOKEN_LIST||et.TOKEN_LIST)).data}async getJupTokenList(){return(await this.api.get("",{baseURL:this.urlConfigs.JUP_TOKEN_LIST||et.JUP_TOKEN_LIST})).map(t=>({...t,chainId:101,programId:t.tags.includes("token-2022")?Kd.toBase58():Cd.toBase58()}))}async getTokenInfo(e){return(await this.api.get((this.urlConfigs.MINT_INFO_ID||et.MINT_INFO_ID)+`?mints=${e.map(n=>n.toString()).join(",")}`)).data}async getPoolList(e={}){let{type:t="all",sort:n="liquidity",order:o="desc",page:i=0,pageSize:s=100}=e;return(await this.api.get((this.urlConfigs.POOL_LIST||et.POOL_LIST)+`?poolType=${t}&poolSortField=${n}&sortType=${o}&page=${i}&pageSize=${s}`)).data}async fetchPoolById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.POOL_SEARCH_BY_ID||et.POOL_SEARCH_BY_ID)+`?ids=${t}`)).data}async fetchPoolKeysById(e){let{idList:t}=e,n=[],o=t.filter(s=>Rs.has(s)?(n.push(Rs.get(s)),!1):!0),i=[];return o.length&&(i=(await this.api.get((this.urlConfigs.POOL_KEY_BY_ID||et.POOL_KEY_BY_ID)+`?ids=${o.join(",")}`)).data.filter(Boolean),i.forEach(a=>{Rs.set(a.id,a)})),n.concat(i)}async fetchPoolByMints(e){let{mint1:t,mint2:n,type:o="all",sort:i="default",order:s="desc",page:a=1}=e,[c,u]=[t&&ut(t).toBase58(),n&&n!=="undefined"?ut(n).toBase58():""],[l,d]=u&&c>u?[u,c]:[c,u];return(await this.api.get((this.urlConfigs.POOL_SEARCH_MINT||et.POOL_SEARCH_MINT)+`?mint1=${l}&mint2=${d}&poolType=${o}&poolSortField=${i}&sortType=${s}&pageSize=100&page=${a}`)).data}async fetchFarmInfoById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_INFO||et.FARM_INFO)+`?ids=${t}`)).data}async fetchFarmKeysById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_KEYS||et.FARM_KEYS)+`?ids=${t}`)).data}async fetchAvailabilityStatus(){return(await this.api.get(this.urlConfigs.CHECK_AVAILABILITY||et.CHECK_AVAILABILITY)).data}};var pr="please provide owner in load() initialization or you can set by calling raydium.setOwner(owner)",vu="please provide connection in load() initialization or set it by raydium.setConnection(connection)";import{PublicKey as wr,SystemProgram as sp}from"@solana/web3.js";import{AccountLayout as bo,createAssociatedTokenAccountInstruction as Ds,TOKEN_PROGRAM_ID as Nn,TOKEN_2022_PROGRAM_ID as ap}from"@solana/spl-token";var Ns=(...r)=>r.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Re=class{scope;disabled=!1;logger;constructor({scope:e,moduleName:t}){this.scope=e,this.logger=me(t)}createTxBuilder(e){return this.scope.checkOwner(),new cr({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,blockhashCommitment:this.scope.blockhashCommitment,loopMultiTxStatus:this.scope.loopMultiTxStatus,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(Ns(e))}logInfo(...e){this.logger.info(Ns(e))}logAndCreateError(...e){let t=Ns(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as ep,SystemProgram as tp}from"@solana/web3.js";import np from"bn.js";import{createCloseAccountInstruction as op,createInitializeAccountInstruction as ip,createTransferInstruction as rp,TOKEN_PROGRAM_ID as yo}from"@solana/spl-token";import{Keypair as Yd,PublicKey as ju}from"@solana/web3.js";import Zd from"bn.js";import{TOKEN_PROGRAM_ID as $d}from"@solana/spl-token";function Ld(r){return r instanceof Uint8Array||r!=null&&typeof r=="object"&&r.constructor.name==="Uint8Array"}function Os(r,...e){if(!Ld(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${r.length}`)}function vs(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function Mu(r,e){Os(r);let t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var yr=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),zt=(r,e)=>r<<32-e|r>>>e;var zP=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function Rd(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function Ms(r){return typeof r=="string"&&(r=Rd(r)),Os(r),r}var fr=class{clone(){return this._cloneInto()}},HP={}.toString;function Eu(r){let e=n=>r().update(Ms(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function Nd(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let o=BigInt(32),i=BigInt(4294967295),s=Number(t>>o&i),a=Number(t&i),c=n?4:0,u=n?0:4;r.setUint32(e+c,s,n),r.setUint32(e+u,a,n)}var _u=(r,e,t)=>r&e^~r&t,Fu=(r,e,t)=>r&e^r&t^e&t,br=class extends fr{constructor(e,t,n,o){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=o,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=yr(this.buffer)}update(e){vs(this);let{view:t,buffer:n,blockLen:o}=this;e=Ms(e);let i=e.length;for(let s=0;s<i;){let a=Math.min(o-this.pos,i-s);if(a===o){let c=yr(e);for(;o<=i-s;s+=o)this.process(c,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===o&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){vs(this),Mu(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:o,isLE:i}=this,{pos:s}=this;t[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>o-s&&(this.process(n,0),s=0);for(let d=s;d<o;d++)t[d]=0;Nd(n,o-8,BigInt(this.length*8),i),this.process(n,0);let a=yr(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let u=c/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let d=0;d<u;d++)a.setUint32(4*d,l[d],i)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:o,finished:i,destroyed:s,pos:a}=this;return e.length=o,e.pos=a,e.finished=i,e.destroyed=s,o%t&&e.buffer.set(n),e}};var Od=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Cn=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Ln=new Uint32Array(64),Es=class extends br{constructor(){super(64,32,8,!1),this.A=Cn[0]|0,this.B=Cn[1]|0,this.C=Cn[2]|0,this.D=Cn[3]|0,this.E=Cn[4]|0,this.F=Cn[5]|0,this.G=Cn[6]|0,this.H=Cn[7]|0}get(){let{A:e,B:t,C:n,D:o,E:i,F:s,G:a,H:c}=this;return[e,t,n,o,i,s,a,c]}set(e,t,n,o,i,s,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=o|0,this.E=i|0,this.F=s|0,this.G=a|0,this.H=c|0}process(e,t){for(let d=0;d<16;d++,t+=4)Ln[d]=e.getUint32(t,!1);for(let d=16;d<64;d++){let m=Ln[d-15],p=Ln[d-2],y=zt(m,7)^zt(m,18)^m>>>3,f=zt(p,17)^zt(p,19)^p>>>10;Ln[d]=f+Ln[d-7]+y+Ln[d-16]|0}let{A:n,B:o,C:i,D:s,E:a,F:c,G:u,H:l}=this;for(let d=0;d<64;d++){let m=zt(a,6)^zt(a,11)^zt(a,25),p=l+m+_u(a,c,u)+Od[d]+Ln[d]|0,f=(zt(n,2)^zt(n,13)^zt(n,22))+Fu(n,o,i)|0;l=u,u=c,c=a,a=s+p|0,s=i,i=o,o=n,n=p+f|0}n=n+this.A|0,o=o+this.B|0,i=i+this.C|0,s=s+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(n,o,i,s,a,c,u,l)}roundClean(){Ln.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var Vu=Eu(()=>new Es);import{PublicKey as Qd}from"@solana/web3.js";import Xu,{isBN as Qu}from"bn.js";import{bits as vd,BitStructure as oA,blob as Md,Blob as iA,cstr as rA,f32 as sA,f32be as aA,f64 as uA,f64be as cA,greedy as lA,Layout as Ed,ns64 as mA,ns64be as dA,nu64 as _d,nu64be as pA,offset as Fd,s16 as fA,s16be as yA,s24 as bA,s24be as gA,s32 as Vd,s32be as PA,s40 as AA,s40be as wA,s48 as kA,s48be as hA,s8 as TA,seq as Wd,struct as IA,Structure as Dd,u16 as qd,u16be as BA,u24 as xA,u24be as SA,u32 as Ud,u32be as KA,u40 as CA,u40be as LA,u48 as RA,u48be as NA,u8 as Gd,UInt as Xd,union as OA,Union as vA,unionLayoutDiscriminator as MA,utf8 as EA}from"@solana/buffer-layout";var gr=Ed,Wu=Dd;var _s=Xd;var Du=Gd,Ht=qd;var Pr=Ud;var qu=_d;var Ne=Vd;var Uu=Wd;var we=Md;var Fs=vd,Gu=Fd;var Dn=class extends gr{blob;signed;constructor(e,t,n){super(e,n),this.blob=we(e),this.signed=t}decode(e,t=0){let n=new Xu(this.blob.decode(e,t),10,"le");return this.signed?n.fromTwos(this.span*8).clone():n}encode(e,t,n=0){return typeof e=="number"&&(e=new Xu(e)),this.signed&&(e=e.toTwos(this.span*8)),this.blob.encode(e.toArrayLike(Buffer,"le",this.span),t,n)}},Ar=class extends gr{_lower;_upper;constructor(e){super(8,e),this._lower=Fs(Pr(),!1),this._upper=Fs(Pr(),!1)}addBoolean(e){this._lower.fields.length<32?this._lower.addBoolean(e):this._upper.addBoolean(e)}decode(e,t=0){let n=this._lower.decode(e,t),o=this._upper.decode(e,t+this._lower.span);return{...n,...o}}encode(e,t,n=0){return this._lower.encode(e,t,n)+this._upper.encode(e,t,n+this._lower.span)}};function F(r){return new _s(1,r)}function ot(r){return new _s(4,r)}function A(r){return new Dn(8,!1,r)}function J(r){return new Dn(16,!1,r)}function zu(r){return new Dn(1,!0,r)}function fo(r){return new Dn(8,!0,r)}function Hu(r){return new Dn(16,!0,r)}var po=class extends gr{layout;decoder;encoder;constructor(e,t,n,o){super(e.span,o),this.layout=e,this.decoder=t,this.encoder=n}decode(e,t){return this.decoder(this.layout.decode(e,t))}encode(e,t,n){return this.layout.encode(this.encoder(e),t,n)}getSpan(e,t){return this.layout.getSpan(e,t)}};function L(r){return new po(we(32),e=>new Qd(e),e=>e.toBuffer(),r)}function Ee(r){return new po(Du(),zd,Hd,r)}function zd(r){if(r===0)return!1;if(r===1)return!0;throw new Error("Invalid bool: "+r)}function Hd(r){return r?1:0}function jd(r){let e=Pr("length"),t=O([e,we(Gu(e,-e.span),"data")]);return new po(t,({data:n})=>n,n=>({data:n}),r)}function jt(r){return new po(jd(),e=>e.toString("utf-8"),e=>Buffer.from(e,"utf-8"),r)}var Vs=class extends Wu{decode(e,t){return super.decode(e,t)}};function O(r,e,t){return new Vs(r,e,t)}function Q(r,e,t){let n,o=typeof e=="number"?e:Qu(e)?e.toNumber():new Proxy(e,{get(i,s){if(!n){let a=Reflect.get(i,"count");n=Qu(a)?a.toNumber():a,Reflect.set(i,"count",n)}return Reflect.get(i,s)},set(i,s,a){return s==="count"&&(n=a),Reflect.set(i,s,a)}});return Uu(r,o,t)}var Yt=O([L("mint"),L("owner"),A("amount"),ot("delegateOption"),L("delegate"),F("state"),ot("isNativeOption"),A("isNative"),A("delegatedAmount"),ot("closeAuthorityOption"),L("closeAuthority")]);var ow=me("Raydium_Util");function Yu({owner:r,solAccountResp:e,tokenAccountResp:t}){let n=[],o=[];for(let{pubkey:i,account:s}of t.value){let a=Yt.decode(s.data),{mint:c,amount:u}=a;n.push({publicKey:i,mint:c,amount:u,isAssociated:Z(r,c,s.owner).publicKey.equals(i),isNative:!1,programId:s.owner}),o.push({pubkey:i,accountInfo:a,programId:s.owner})}return e&&n.push({mint:ju.default,amount:new Zd(String(e.lamports)),isNative:!0,programId:e.owner}),{tokenAccounts:n,tokenAccountRawInfos:o}}function We({fromPublicKey:r,programId:e=$d,assignSeed:t}){let n=t?btoa(t).slice(0,32):Yd.generate().publicKey.toBase58().slice(0,32);return{publicKey:Jd(r,n,e),seed:n}}function Jd(r,e,t){let n=Buffer.concat([r.toBuffer(),Buffer.from(e),t.toBuffer()]),o=Vu(n);return new ju(o)}function Ws(r){let{mint:e,tokenAccount:t,owner:n,programId:o=yo}=r;return ip(t,e,n,o)}function yn(r){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:o,programId:i=yo}=r;return op(e,t,o,n,i)}async function Rn(r){let{connection:e,amount:t,commitment:n,payer:o,owner:i,skipCloseAccount:s}=r,a=await e.getMinimumBalanceForRentExemption(Yt.span,n),c=$(t).add(new np(a)),u=We({fromPublicKey:o,programId:yo});return{addresses:{newAccount:u.publicKey},signers:[],instructions:[tp.createAccountWithSeed({fromPubkey:o,basePubkey:o,seed:u.seed,newAccountPubkey:u.publicKey,lamports:c.toNumber(),space:Yt.span,programId:yo}),Ws({mint:new ep(Ze.address),tokenAccount:u.publicKey,owner:i,programId:yo})],instructionTypes:[V.CreateAccount,V.InitAccount],endInstructionTypes:s?[]:[V.CloseAccount],endInstructions:s?[]:[yn({tokenAccount:u.publicKey,payer:o,owner:i})]}}function Zu({source:r,destination:e,owner:t,amount:n,multiSigners:o=[],tokenProgram:i=yo}){return rp(r,e,t,BigInt(String(n)),o,i)}var zo=class extends Re{_tokenAccounts=[];_tokenAccountRawInfos=[];_accountChangeListenerId;_accountListener=[];_clientOwnedToken=!1;_notSubscribeAccountChange=!1;_accountFetchTime=0;constructor(e){super(e);let{tokenAccounts:t,tokenAccountRawInfos:n,notSubscribeAccountChange:o}=e;this._tokenAccounts=t||[],this._tokenAccountRawInfos=n||[],this._notSubscribeAccountChange=o??!0,this._clientOwnedToken=!!(t||n)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}set notSubscribeAccountChange(e){this._notSubscribeAccountChange=e}updateTokenAccount({tokenAccounts:e,tokenAccountRawInfos:t}){return e&&(this._tokenAccounts=e),t&&(this._tokenAccountRawInfos=t),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(e){return this._accountListener.push(e),this}removeAccountChangeListener(e){return this._accountListener=this._accountListener.filter(t=>t!==e),this}getAssociatedTokenAccount(e,t){return Z(this.scope.ownerPubKey,e,t).publicKey}resetTokenAccounts(){this._clientOwnedToken||(this._tokenAccounts=[],this._tokenAccountRawInfos=[])}async fetchWalletTokenAccounts(e){if(this._clientOwnedToken||!e?.forceUpdate&&this._tokenAccounts.length&&Date.now()-this._accountFetchTime<(this._notSubscribeAccountChange?1e3*5:1e3*60*3))return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let n={...{},...e},[o,i,s]=await Promise.all([this.scope.connection.getAccountInfo(this.scope.ownerPubKey,n.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:Nn},n.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:ap},n.commitment)]),{tokenAccounts:a,tokenAccountRawInfos:c}=Yu({owner:this.scope.ownerPubKey,solAccountResp:o,tokenAccountResp:{context:i.context,value:[...i.value,...s.value]}});return this._tokenAccounts=a,this._tokenAccountRawInfos=c,this._accountFetchTime=Date.now(),this._notSubscribeAccountChange||(this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>{this.fetchWalletTokenAccounts({forceUpdate:!0}),this._accountListener.forEach(u=>u({tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos}))},{commitment:e?.commitment})),{tokenAccounts:a,tokenAccountRawInfos:c}}clearAccountChangeCkb(){this._accountChangeListenerId!==void 0&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId)}async getCreatedTokenAccount({mint:e,programId:t=Nn,associatedOnly:n=!0}){await this.fetchWalletTokenAccounts();let o=this._tokenAccounts.filter(({mint:s})=>s?.equals(e)).sort((s,a)=>s.amount.lt(a.amount)?1:-1),i=this.getAssociatedTokenAccount(e,t);for(let s of o){let{publicKey:a}=s;if(a&&(!n||n&&i.equals(a)))return a}}async getOrCreateTokenAccount(e){await this.fetchWalletTokenAccounts();let{mint:t,createInfo:n,associatedOnly:o,owner:i,notUseTokenAccount:s=!1,skipCloseAccount:a=!1,checkCreateATAOwner:c=!1,assignSeed:u}=e,l=new wr(e.tokenProgram||Nn),d=this.getAssociatedTokenAccount(t,new wr(l)),m=(s?[]:this.tokenAccountRawInfos).filter(y=>y.accountInfo.mint.equals(t)&&(!o||y.pubkey.equals(d))).sort((y,f)=>y.accountInfo.amount.lt(f.accountInfo.amount)?1:-1);n===void 0||m.length>0;let p={instructions:[],endInstructions:[],signers:[],instructionTypes:[],endInstructionTypes:[]};if(o){let y=Ds(i,d,i,t,l),f=this.tokenAccountRawInfos.find(b=>b.pubkey.equals(d));if(c){let b=await this.scope.connection.getAccountInfo(d);if(b===null)p.instructions?.push(y),p.instructionTypes.push(V.CreateATA);else if(!(b.owner.equals(l)&&bo.decode(b.data).mint.equals(t)&&bo.decode(b.data).owner.equals(i)))throw Error(`create ata check error -> mint: ${t.toString()}, ata: ${d.toString()}`)}else f===void 0&&(p.instructions.push(y),p.instructionTypes.push(V.CreateATA));if(t.equals(j)&&n?.amount){let b=await Rn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:n.payer||this.scope.ownerPubKey,amount:n.amount??0,skipCloseAccount:a});p.instructions.push(...b.instructions||[]),p.endInstructions.push(...b.endInstructions||[]),p.instructionTypes.push(...b.instructionTypes||[]),p.endInstructionTypes.push(...b.endInstructionTypes||[]),n.amount&&(p.instructions.push(Zu({source:b.addresses.newAccount,destination:d,owner:this.scope.ownerPubKey,amount:n.amount,tokenProgram:Nn})),p.instructionTypes.push(V.TransferAmount))}return!a&&f===void 0&&(p.endInstructions.push(yn({owner:i,payer:n?.payer||i,tokenAccount:d,programId:l})),p.endInstructionTypes.push(V.CloseAccount)),{account:d,instructionParams:p}}else{let y=We({fromPublicKey:i,programId:l,assignSeed:u}),f=await this.scope.connection.getMinimumBalanceForRentExemption(bo.span),b=sp.createAccountWithSeed({fromPubkey:i,basePubkey:i,seed:y.seed,newAccountPubkey:y.publicKey,lamports:f+Number(n?.amount?.toString()??0),space:bo.span,programId:l});return p.instructions.push(b,Ws({mint:t,tokenAccount:y.publicKey,owner:this.scope.ownerPubKey,programId:l})),p.instructionTypes.push(V.CreateAccount),p.instructionTypes.push(V.InitAccount),a||(p.endInstructions.push(yn({owner:i,payer:n?.payer||i,tokenAccount:y.publicKey,programId:l})),p.endInstructionTypes.push(V.CloseAccount)),{account:y.publicKey,instructionParams:p}}}async checkOrCreateAta({mint:e,programId:t=Nn,autoUnwrapWSOLToSOL:n}){await this.fetchWalletTokenAccounts();let o=this.scope.account.tokenAccounts.find(({mint:a})=>a?.toBase58()===e.toBase58())?.publicKey,i=this.scope.ownerPubKey,s={};if(!o){let a=this.getAssociatedTokenAccount(e,t),c=await Ds(i,a,i,e,t);s.instructions=[c],s.instructionTypes=[V.CreateATA],o=a}return n&&j.toBase58()===e.toBase58()&&(s.endInstructions=[yn({owner:i,payer:i,tokenAccount:o,programId:t})],s.endInstructionTypes=[V.CloseAccount]),{pubKey:o,newInstructions:s}}async handleTokenAccount(e){let{side:t,amount:n,mint:o,programId:i=Nn,tokenAccount:s,payer:a=this.scope.ownerPubKey,bypassAssociatedCheck:c,skipCloseAccount:u,checkCreateATAOwner:l}=e,d=this.getAssociatedTokenAccount(o,i);if(new wr(j).equals(o)){let m=await Rn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:a,amount:n,skipCloseAccount:u});return{tokenAccount:m.addresses.newAccount,...m}}else if(!s||t==="out"&&!d.equals(s)&&!c){let m=[],p=Ds(this.scope.ownerPubKey,d,this.scope.ownerPubKey,o,i);if(l){let y=await this.scope.connection.getAccountInfo(d);if(y===null)m.push(p);else if(!(y.owner.equals(Nn)&&bo.decode(y.data).mint.equals(o)&&bo.decode(y.data).owner.equals(this.scope.ownerPubKey)))throw Error(`create ata check error -> mint: ${o.toString()}, ata: ${d.toString()}`)}else m.push(p);return{tokenAccount:d,instructions:m,instructionTypes:[V.CreateATA]}}return{tokenAccount:s}}async processTokenAccount(e){let{mint:t,programId:n=Nn,amount:o,useSOLBalance:i,handleTokenAccount:s,feePayer:a}=e,c,u=this.createTxBuilder(a);if(t.equals(new wr(j))&&i){let{tokenAccount:l,...d}=await this.handleTokenAccount({side:"in",amount:o||0,mint:t,bypassAssociatedCheck:!0,programId:n});c=l,u.addInstruction(d)}else if(c=await this.getCreatedTokenAccount({mint:t,associatedOnly:!1,programId:n}),!c&&s){let{tokenAccount:l,...d}=await this.scope.account.handleTokenAccount({side:"in",amount:0,mint:t,bypassAssociatedCheck:!0,programId:n});c=l,u.addInstruction(d)}return{tokenAccount:c,...u.AllTxData}}};import{PublicKey as Te,SystemProgram as Kp}from"@solana/web3.js";import{createAssociatedTokenAccountInstruction as Cp}from"@solana/spl-token";import{PublicKey as ic}from"@solana/web3.js";var qs=O([F("instruction")]),Us=O([F("instruction")]),up=O([A("rewardState"),A("rewardOpenTime"),A("rewardEndTime"),A("rewardLastUpdateTime"),A("totalReward"),A("totalRewardEmissioned"),A("rewardClaimed"),A("rewardPerSecond"),J("accRewardPerShare"),L("rewardVault"),L("rewardMint"),L("rewardSender"),A("rewardType"),Q(A(),15,"padding")]),cp=O([A("state"),A("nonce"),L("lpVault"),L("rewardVault"),L(),L(),A(),A(),A("totalReward"),J("perShareReward"),A("lastSlot"),A("perSlotReward")]),lp=O([A("state"),A("nonce"),L("lpVault"),L("rewardVaultA"),A("totalRewardA"),J("perShareRewardA"),A("perSlotRewardA"),F("option"),L("rewardVaultB"),we(7),A("totalRewardB"),J("perShareRewardB"),A("perSlotRewardB"),A("lastSlot"),L()]),mp=O([A(),A("state"),A("nonce"),A("validRewardTokenNum"),J("rewardMultiplier"),A("rewardPeriodMax"),A("rewardPeriodMin"),A("rewardPeriodExtend"),L("lpMint"),L("lpVault"),Q(up,5,"rewardInfos"),L("creator"),L(),Q(A(),32,"padding")]),$u=new Proxy(cp,{get(r,e,t){return e==="decode"?(...n)=>{let o=r.decode(...n);return{...o,version:3,rewardInfos:[{rewardVault:o.rewardVault,totalReward:o.totalReward,perSlotReward:o.perSlotReward,perShareReward:o.perShareReward}]}}:Reflect.get(r,e,t)}}),Ju=new Proxy(lp,{get(r,e,t){return e==="decode"?(...n)=>{let o=r.decode(...n);return{...o,version:5,rewardInfos:[{rewardVault:o.rewardVaultA,totalReward:o.totalRewardA,perSlotReward:o.perSlotRewardA,perShareReward:o.perShareRewardA},{rewardVault:o.rewardVaultB,totalReward:o.totalRewardB,perSlotReward:o.perSlotRewardB,perShareReward:o.perShareRewardB}]}}:Reflect.get(r,e,t)}}),Ho=new Proxy(mp,{get(r,e,t){return e==="decode"?(...n)=>{let o=r.decode(...n);return{...o,version:6,rewardInfos:o.rewardInfos.map(i=>({...i,rewardType:(Object.entries(On).find(s=>String(s[1])===i.rewardType.toString())??["Standard SPL"])[0]}))}}:Reflect.get(r,e,t)}}),dp=O([A("isSet"),A("rewardPerSecond"),A("rewardOpenTime"),A("rewardEndTime"),A("rewardType")]),Gs=O([F("instruction"),A("nonce"),Q(dp,5,"rewardTimeInfo")]),Xs=O([F("instruction"),A("rewardReopenTime"),A("rewardEndTime"),A("rewardPerSecond")]),Qs=O([F("instruction"),A("isSet"),A("rewardPerSecond"),A("rewardOpenTime"),A("rewardEndTime"),A("rewardType")]),Mw=O([A("state"),L("id"),L("owner"),A("deposited"),Q(A(),1,"rewardDebts")]),jo=O([A("state"),L("id"),L("owner"),A("deposited"),Q(J(),1,"rewardDebts"),A(""),A("voteLockedBalance"),Q(A(),15)]),Ew=O([A("state"),L("id"),L("owner"),A("deposited"),Q(A(),2,"rewardDebts")]),ec=O([A("state"),L("id"),L("owner"),A("deposited"),Q(J(),2,"rewardDebts"),Q(A(),17)]),tc=O([A(),A("state"),L("id"),L("owner"),A("deposited"),Q(J(),5,"rewardDebts"),Q(A(),16)]),bt=O([F("instruction"),A("amount")]),pp=O([L("mint"),L("grantAuthority"),A("baselineVoteWeightScaledFactor"),A("maxExtraLockupVoteWeightScaledFactor"),A("lockupSaturationSecs"),zu("digitShift"),Q(F(),7,"reserved1"),Q(A(),7,"reserved2")]),nc=O([we(8),L("governanceProgramId"),L("realm"),L("realmGoverningTokenMint"),L("realmAuthority"),Q(F(),32,"reserved1"),Q(pp,4,"votingMints"),fo("timeOffset"),F("bump"),Q(F(),7,"reserved2"),Q(A(),11,"reserved3")]),fp=O([fo("startTime"),fo("endTime"),F("kind"),Q(F(),15,"reserved")]),yp=O([Q(fp,1,"lockup"),A("amountDeposited_native"),A("amountInitiallyLockedNative"),Ee("isUsed"),Ee("allowClawback"),F("votingMintConfigIdx"),Q(F(),29,"reserved")]),oc=O([we(8),L("voterAuthority"),L("registrar"),Q(yp,32,"deposits"),F("voterBump"),F("voterWweightRecordBump"),Q(F(),94,"reserved")]);var Gw=me("Raydium_farm_config"),rc=new ic("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),sc=new ic("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1"),ac={3:$u,5:Ju,6:Ho},uc={3:jo,5:ec,6:tc},zs=r=>[3,4,5,6].indexOf(r)!==-1,Hs=r=>{let{version:e,rewardInfos:t,rewardTokenAccountsPublicKeys:n}=r,o=`rewardInfo:${JSON.stringify(t)}, rewardAccount:${JSON.stringify(n)}`;return{3:()=>{if(t.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${o}`},5:()=>{if(t.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${o}`},6:()=>{if(!n.length||t.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${o}`}}[e]?.()},On={"Standard SPL":0,"Option tokens":1},vt={[Is.toString()]:3,[Cu.toString()]:4,[Bs.toString()]:5,[uo.toString()]:6};import{PublicKey as se,SystemProgram as qn,SYSVAR_CLOCK_PUBKEY as Po,SYSVAR_RENT_PUBKEY as Pp,TransactionInstruction as ze}from"@solana/web3.js";import kr from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Ap,createAssociatedTokenAccountInstruction as wp,TOKEN_PROGRAM_ID as It}from"@solana/spl-token";function js(r,e,t){return te([e.toBuffer(),Buffer.from("registrar","utf8"),t.toBuffer()],r)}function Ys(r,e){return te([e.toBuffer(),Buffer.from("voting_mint_seed","utf8")],r)}function Zs(r,e){return te([e.toBuffer()],r)}function $s(r,e,t){return te([e.toBuffer(),Buffer.from("voter","utf8"),t.toBuffer()],r)}function Js(r,e,t){return te([e.toBuffer(),Buffer.from("voter-weight-record","utf8"),t.toBuffer()],r)}function ea(r,e,t,n){return te([Buffer.from("governance","utf8"),e.toBuffer(),t.toBuffer(),n.toBuffer()],r)}import Tt from"bn.js";var Yo=me("Raydium.farm.util");function Zo({programId:r,poolId:e,mint:t,type:n}){let{publicKey:o}=te([e.toBuffer(),t.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],r);return o}function lt({programId:r,poolId:e,owner:t,version:n}){let{publicKey:o}=te([e.toBuffer(),t.toBuffer(),Buffer.from(n===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],r);return o}var cc=({programId:r,poolId:e})=>te([e.toBuffer()],r);function lc(r){return{isSet:new Tt(1),rewardPerSecond:$(r.perSecond),rewardOpenTime:$(r.openTime),rewardEndTime:$(r.endTime),rewardType:$(On[r.rewardType])}}function ta(r){return $(r.endTime).sub($(r.openTime)).mul($(r.perSecond))}function go(r){let e=uc[r];return e||Yo.logWithError("invalid version",r),e}function bp(r){let e=ac[r];return e||Yo.logWithError("invalid version",r),e}function gp(r,e,t,n){if(r.version===3||r.version===5){if(r.lastSlot.gte(new Tt(t)))return r;let o=new Tt(t).sub(r.lastSlot);r.lastSlot=new Tt(t);for(let i of r.rewardInfos){if(e.amount.eq(new Tt(0)))continue;let s=i.perSlotReward.mul(o);i.perShareReward=i.perShareReward.add(s.mul(new Tt(10).pow(new Tt(r.version===3?9:15))).div(e.amount)),i.totalReward=i.totalReward.add(s)}}else if(r.version===6)for(let o of r.rewardInfos){if(o.rewardState.eq(new Tt(0)))continue;let i=Tt.min(new Tt(n),o.rewardEndTime);if(o.rewardOpenTime.gte(i))continue;let a=i.sub(o.rewardLastUpdateTime).mul(o.rewardPerSecond),c=o.totalReward.sub(o.totalRewardEmissioned);c.lt(a)?(a=c,o.rewardLastUpdateTime=o.rewardLastUpdateTime.add(c.div(o.rewardPerSecond))):o.rewardLastUpdateTime=i,!e.amount.eq(new Tt(0))&&(o.accRewardPerShare=o.accRewardPerShare.add(a.mul(r.rewardMultiplier).div(e.amount)),o.totalRewardEmissioned=o.totalRewardEmissioned.add(a))}return r}async function ak({connection:r,farmPools:e,owner:t,config:n,chainTime:o}){let i=!1,s=!1,a=new Tt(10),c=[];for(let m of e){let p=Le(m);p.version===6?s=!0:i=!0,c.push({pubkey:p.id,version:p.version,key:"state",poolId:p.id},{pubkey:p.lpVault,version:p.version,key:"lpVault",poolId:p.id}),t&&c.push({pubkey:lt({programId:p.programId,poolId:p.id,owner:t,version:m.version}),version:p.version,key:"ledger",poolId:p.id})}let u={},l=await Se(r,c,n);for(let{pubkey:m,version:p,key:y,poolId:f,accountInfo:b}of l){let g=f.toBase58();if(u[g]={...u[g]},y==="state"){let w=bp(p);(!b||!b.data||b.data.length!==w.span)&&Yo.logWithError(`invalid farm state account info, pools.id, ${m}`),u[g].state=w.decode(b.data)}else if(y==="lpVault")(!b||!b.data||b.data.length!==Yt.span)&&Yo.logWithError(`invalid farm lp vault account info, pools.lpVault, ${m}`),u[g].lpVault=Yt.decode(b.data);else if(y==="ledger"){let w=go(p);b&&b.data&&(b.data.length!==w.span&&Yo.logWithError(`invalid farm ledger account info, ledger, ${m}`),u[g].ledger=w.decode(b.data))}}let d=s||i?await r.getSlot():0;for(let m of Object.keys(u))u[m]!==void 0&&(u[m].state=gp(u[m].state,u[m].lpVault,d,o));for(let[m,{state:p,ledger:y}]of Object.entries(u))if(y){let f=p.version===6?p.rewardMultiplier:p.rewardInfos.length===1?a.pow(new Tt(9)):a.pow(new Tt(15)),b=p.rewardInfos.map((g,w)=>{let k=y.rewardDebts[w];return y.deposited.mul(p.version===6?g.accRewardPerShare:g.perShareReward).div(f).sub(k)});u[m].wrapped={...u[m].wrapped,pendingRewards:b}}return u}function uk(r,e=Date.now()){if(r.version===6){let t=r.state.rewardInfos;if(t.every(({rewardOpenTime:n})=>wu(e,n.toNumber(),{unit:"s"})))return"upcoming pool";if(t.every(({rewardEndTime:n})=>ku(e,n.toNumber(),{unit:"s"})))return"closed pool"}else{let t=r.state.rewardInfos.map(({perSlotReward:n})=>n);if(t.length===2){if(String(t[0])==="0"&&String(t[1])!=="0")return"normal fusion pool";if(String(t[0])!=="0"&&String(t[1])!=="0")return"dual fusion pool";if(String(t[0])==="0"&&String(t[1])==="0")return"closed pool"}else if(t.length===1&&String(t[0])==="0")return"closed pool"}}async function na(r,e,t,n){let o=await r.getAccountInfo(e);if(o===null)throw Error("registrar info check error");let s=nc.decode(o.data).votingMints.findIndex(l=>l.mint.equals(n));if(s===-1)throw Error("find voter mint error");let a=await r.getAccountInfo(t);if(a===null)return{index:s,isInit:!1};let u=oc.decode(a.data).deposits.findIndex(l=>l.isUsed&&l.votingMintConfigIdx===s);return u===-1?{index:s,isInit:!1}:{index:u,isInit:!0}}var kp=me("Raydium_farm_instruction"),$o={voterStakeRegistryCreateVoter:Buffer.from([6,24,245,52,243,255,148,25]),voterStakeRegistryCreateDepositEntry:Buffer.from([185,131,167,186,159,125,19,67]),voterStakeRegistryDeposit:Buffer.from([242,35,198,137,82,225,242,182]),voterStakeRegistryWithdraw:Buffer.from([183,18,70,156,148,109,161,34]),voterStakeRegistryUpdateVoterWeightRecord:Buffer.from([45,185,3,36,109,190,115,169])};function Jo(r){let{version:e,id:t,ledger:n,programId:o,owner:i}=r,s={3:9,5:10}[e];s||kp.logWithError(`invalid farm pool version: ${e}`);let a=Buffer.alloc(qs.span);qs.encode({instruction:s},a);let c=[P({pubkey:t}),P({pubkey:n}),P({pubkey:i,isWritable:!1}),P({pubkey:qn.programId,isWritable:!1}),P({pubkey:Pp,isWritable:!1})];return{instruction:new ze({programId:o,keys:c,data:a}),instructionType:V.FarmV3CreateLedger}}function mc(r){let e=Buffer.alloc(Gs.span);Gs.encode({instruction:0,nonce:new kr(r.nonce),rewardTimeInfo:r.rewardInfoConfig},e);let t=[...ys,P({pubkey:r.farmId}),P({pubkey:r.farmAuthority,isWritable:!1}),P({pubkey:r.lpVault}),P({pubkey:r.lpMint,isWritable:!1}),P({pubkey:r.lockVault}),P({pubkey:r.lockMint,isWritable:!1}),P({pubkey:r.lockUserAccount??$e}),P({pubkey:r.owner,isWritable:!1,isSigner:!0})];for(let n of r.rewardInfo)t.push(P({pubkey:n.rewardMint,isWritable:!1}),P({pubkey:n.rewardVault}),P({pubkey:n.userRewardToken}));return{instruction:new ze({programId:r.programId,keys:t,data:e}),instructionType:V.FarmV6Create}}function dc(r){let e=Buffer.alloc(Us.span);Us.encode({instruction:5},e);let t=[P({pubkey:It,isWritable:!1}),P({pubkey:r.id}),P({pubkey:r.authority,isWritable:!1}),P({pubkey:r.lpVault,isWritable:!1}),P({pubkey:r.rewardVault}),P({pubkey:r.userRewardToken}),P({pubkey:r.owner,isWritable:!1,isSigner:!0})];return{instruction:new ze({programId:r.programId,keys:t,data:e}),instructionType:V.FarmV6CreatorWithdraw}}function hp(r,e,t,n,o,i,s,a,c,u,l,d,m){let p=O([F("depositEntryIndex"),A("amount")]),y=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:It,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:ji,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({depositEntryIndex:d,amount:m},f);let b=Buffer.from([...$o.voterStakeRegistryDeposit,...f]);return new ze({keys:y,programId:r,data:b})}function Tp(r,e,t,n){let o=O([]),i=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:qn.programId,isSigner:!1,isWritable:!1}],s=Buffer.alloc(o.span);o.encode({},s);let a=Buffer.from([...$o.voterStakeRegistryUpdateVoterWeightRecord,...s]);return new ze({keys:i,programId:r,data:a})}function Ip(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y){let f=O([F("depositEntryIndex"),A("amount")]),b=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:It,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:ji,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);f.encode({depositEntryIndex:p,amount:y},g);let w=Buffer.from([...$o.voterStakeRegistryWithdraw,...g]);return new ze({keys:b,programId:r,data:w})}function Bp(r,e,t,n,o,i){let s=O([F("ins")]),a=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:qn.programId,isSigner:!1,isWritable:!1}],c=Buffer.alloc(s.span);return s.encode({ins:23},c),new ze({keys:a,programId:r,data:c})}function xp(r,e,t,n,o,i,s,a){let c=O([F("voterBump"),F("voterWeightRecordBump")]),u=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:qn.programId,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:ji,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({voterBump:s,voterWeightRecordBump:a},l);let d=Buffer.from([...$o.voterStakeRegistryCreateVoter,...l]);return new ze({keys:u,programId:r,data:d})}function Sp(r,e,t,n,o,i,s,a,c,u,l,d){let m=O([F("depositEntryIndex"),F("kind"),F("option"),A("startTs"),ot("periods"),Ee("allowClawback")]),p=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:qn.programId,isSigner:!1,isWritable:!1},{pubkey:It,isSigner:!1,isWritable:!1},{pubkey:Ap,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1}],y=Buffer.alloc(m.span);m.encode({depositEntryIndex:a,kind:c,option:u===void 0?0:1,startTs:u,periods:l,allowClawback:d},y);let f=Buffer.from([...$o.voterStakeRegistryCreateDepositEntry,...y]);return new ze({keys:p,programId:r,data:f})}async function Ik({connection:r,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:o,communityTokenMint:i,owner:s,poolId:a,tokenProgram:c}){let u=js(n,o,i).publicKey,l=lt({programId:e,poolId:a,owner:s,version:3}),d=await r.getAccountInfo(l);if(d===null)throw Error("user is not staker");let m=jo.decode(d.data),p=m.deposited.sub(m.voteLockedBalance);if(console.log("amount",p.toString()),p.eq(new kr(0)))throw Error("user do not has new stake amount");let y=Ys(e,a).publicKey,f=Zs(e,a).publicKey,{publicKey:b,nonce:g}=$s(n,u,s),w=Z(b,y,c).publicKey,{publicKey:k,nonce:h}=Js(n,u,s),x=ea(t,o,i,s).publicKey,T=[],B=Z(s,y,c).publicKey;if(await r.getAccountInfo(B)===null&&T.push(wp(s,B,s,y)),await r.getAccountInfo(b)===null){let v=Bp(t,o,s,i,s,x);T.push(v,xp(n,u,b,k,s,s,g,h))}let{index:K,isInit:N}=await na(r,u,b,y);return N||T.push(Sp(n,u,b,w,s,s,y,K,0,void 0,0,!1)),T.push(hp(n,u,b,w,B,s,l,a,y,f,e,K,p),Tp(n,u,b,k)),T}async function Bk({connection:r,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:o,communityTokenMint:i,owner:s,poolId:a,tokenProgram:c}){let u=js(n,o,i).publicKey,l=lt({programId:e,poolId:a,owner:s,version:3}),d=await r.getAccountInfo(l);if(d===null)throw Error("user is not staker");let m=jo.decode(d.data);if(m.voteLockedBalance.eq(new kr(0)))throw Error("user has vote locked balance = 0");let p=Ys(e,a).publicKey,y=Zs(e,a).publicKey,{publicKey:f}=$s(n,u,s),b=Z(f,p,c).publicKey,{publicKey:g}=Js(n,u,s),w=ea(t,o,i,s).publicKey,k=[],{index:h,isInit:x}=await na(r,u,f,p);if(!x)throw Error("deposit entry index check error");return k.push(Ip(n,u,f,s,w,g,b,Z(s,p,c).publicKey,l,a,p,y,e,h,m.voteLockedBalance)),k}function oa({payer:r,rewardVault:e,userRewardTokenPub:t,farmKeys:n,rewardInfo:o}){let i=Buffer.alloc(Xs.span);Xs.encode({instruction:3,rewardReopenTime:$(o.openTime),rewardEndTime:$(o.endTime),rewardPerSecond:$(o.perSecond)},i);let s=[P({pubkey:It,isWritable:!1}),P({pubkey:n.id}),P({pubkey:n.lpVault,isWritable:!1}),P({pubkey:e}),P({pubkey:t}),P({pubkey:r,isWritable:!1,isSigner:!0})];return new ze({programId:n.programId,keys:s,data:i})}function ia({payer:r,userRewardTokenPub:e,farmKeys:t,rewardVault:n,rewardInfo:o}){let i=Buffer.alloc(Qs.span);Qs.encode({instruction:4,isSet:new kr(1),rewardPerSecond:$(o.perSecond),rewardOpenTime:$(o.openTime),rewardEndTime:$(o.endTime),rewardType:$(On[o.rewardType])},i);let s=[...ys,P({pubkey:t.id}),P({pubkey:t.authority,isWritable:!1}),P({pubkey:o.mint,isWritable:!1}),P({pubkey:n}),P({pubkey:e}),P({pubkey:r,isWritable:!1,isSigner:!0})];return new ze({programId:t.programId,keys:s,data:i})}function xk(r){let{farmInfo:e,farmKeys:t,version:n,lpAccount:o,rewardAccounts:i,owner:s,instruction:a,amount:c,deposit:u}=r,[l,d]=[new se(e.programId),new se(e.id)],m=lt({programId:l,poolId:d,owner:s,version:n}),p=Buffer.alloc(bt.span);bt.encode({instruction:a,amount:c},p);let y=n===6?[P({pubkey:It,isWritable:!1}),...u?[P({pubkey:qn.programId,isWritable:!1})]:[],P({pubkey:d}),P({pubkey:new se(t.authority),isWritable:!1}),P({pubkey:new se(t.lpVault)}),P({pubkey:m}),P({pubkey:s,isWritable:!1,isSigner:!0}),P({pubkey:o})]:[P({pubkey:d}),P({pubkey:new se(t.authority),isWritable:!1}),P({pubkey:m}),P({pubkey:s,isWritable:!1,isSigner:!0}),P({pubkey:o}),P({pubkey:new se(t.lpVault)}),P({pubkey:i[0]}),P({pubkey:new se(t.rewardInfos[0].vault)}),P({pubkey:Po,isWritable:!1}),P({pubkey:It,isWritable:!1})];if(n===5)for(let f=1;f<t.rewardInfos.length;f++)y.push(P({pubkey:i[f]})),y.push(P({pubkey:new se(t.rewardInfos[f].vault)}));if(n===6)for(let f=0;f<t.rewardInfos.length;f++)y.push(P({pubkey:new se(t.rewardInfos[f].vault)})),y.push(P({pubkey:i[f]}));return new ze({programId:l,keys:y,data:p})}function ei(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s}=r,[a,c]=[new se(e.programId),new se(e.id)],u=lt({programId:a,poolId:c,owner:i,version:6}),l=Buffer.alloc(bt.span);bt.encode({instruction:2,amount:$(s)},l);let d=[P({pubkey:It,isWritable:!1}),P({pubkey:c}),P({pubkey:new se(t.authority),isWritable:!1}),P({pubkey:new se(t.lpVault)}),P({pubkey:u}),P({pubkey:i,isWritable:!1,isSigner:!0}),P({pubkey:n})];for(let m=0;m<t.rewardInfos.length;m++)d.push(P({pubkey:new se(t.rewardInfos[m].vault)})),d.push(P({pubkey:o[m]}));return new ze({programId:a,keys:d,data:l})}function ti(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new se(e.programId),new se(e.id)],l=lt({programId:c,poolId:u,owner:i,version:5}),d=Buffer.alloc(bt.span);bt.encode({instruction:12,amount:$(s)},d);let m=[P({pubkey:u}),P({pubkey:new se(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:i,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new se(t.lpVault)}),P({pubkey:o[0]}),P({pubkey:new se(t.rewardInfos[0].vault)}),P({pubkey:Po,isWritable:!1}),P({pubkey:It,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)m.push(P({pubkey:o[p]})),m.push(P({pubkey:new se(t.rewardInfos[p].vault)}));if(a)for(let p of a)m.push(P({pubkey:p}));return new ze({programId:c,keys:m,data:d})}function pc(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new se(e.programId),new se(e.id)],l=O([F("instruction"),A("amount")]),d=[P({pubkey:u}),P({pubkey:new se(t.authority),isWritable:!1}),P({pubkey:a[0]}),P({pubkey:i,isSigner:!0,isWritable:!1}),P({pubkey:n}),P({pubkey:new se(t.lpVault)}),P({pubkey:o[0]}),P({pubkey:new se(t.rewardInfos[0].vault)}),P({pubkey:Po,isWritable:!1}),P({pubkey:It,isWritable:!1}),P({pubkey:o[1]}),P({pubkey:new se(t.rewardInfos[1].vault)})],m=Buffer.alloc(l.span);return l.encode({instruction:2,amount:s},m),new ze({keys:d,programId:c,data:m})}function ni(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new se(e.programId),new se(e.id)],l=lt({programId:c,poolId:u,owner:i,version:3}),d=Buffer.alloc(bt.span);bt.encode({instruction:11,amount:$(s)},d);let m=[P({pubkey:u}),P({pubkey:new se(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:i,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new se(t.lpVault)}),P({pubkey:o[0]}),P({pubkey:new se(t.rewardInfos[0].vault)}),P({pubkey:Po,isWritable:!1}),P({pubkey:It,isWritable:!1})];if(a)for(let p of a)m.push(P({pubkey:p}));return new ze({programId:c,keys:m,data:d})}function fc(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new se(e.programId),new se(e.id)],l=lt({programId:c,poolId:u,owner:i,version:3}),d=Buffer.alloc(bt.span);bt.encode({instruction:10,amount:$(s)},d);let m=[P({pubkey:u}),P({pubkey:new se(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:i,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new se(t.lpVault)}),P({pubkey:o[0]}),P({pubkey:new se(t.rewardInfos[0].vault)}),P({pubkey:Po,isWritable:!1}),P({pubkey:It,isWritable:!1})];if(a)for(let p of a)m.push(P({pubkey:p}));return new ze({programId:c,keys:m,data:d})}function yc(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new se(e.programId),new se(e.id)],l=lt({programId:c,poolId:u,owner:i,version:5}),d=Buffer.alloc(bt.span);bt.encode({instruction:11,amount:$(s)},d);let m=[P({pubkey:u}),P({pubkey:new se(t.authority),isWritable:!1}),P({pubkey:l}),P({pubkey:i,isWritable:!1,isSigner:!0}),P({pubkey:n}),P({pubkey:new se(t.lpVault)}),P({pubkey:o[0]}),P({pubkey:new se(t.rewardInfos[0].vault)}),P({pubkey:Po,isWritable:!1}),P({pubkey:It,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)m.push(P({pubkey:o[p]})),m.push(P({pubkey:new se(t.rewardInfos[p].vault)}));if(a)for(let p of a)m.push(P({pubkey:p}));return new ze({programId:c,keys:m,data:d})}function bc(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s}=r,[a,c]=[new se(e.programId),new se(e.id)],u=lt({programId:a,poolId:c,owner:i,version:6}),l=Buffer.alloc(bt.span);bt.encode({instruction:1,amount:$(s)},l);let d=[P({pubkey:It,isWritable:!1}),P({pubkey:qn.programId,isWritable:!1}),P({pubkey:c}),P({pubkey:new se(t.authority),isWritable:!1}),P({pubkey:new se(t.lpVault)}),P({pubkey:u}),P({pubkey:i,isWritable:!1,isSigner:!0}),P({pubkey:n})];for(let m=0;m<t.rewardInfos.length;m++)d.push(P({pubkey:new se(t.rewardInfos[m].vault)})),d.push(P({pubkey:o[m]}));return new ze({programId:a,keys:d,data:l})}var oi=class extends Re{async _getUserRewardInfo({payer:e,rewardInfo:t}){if(t.mint.equals($e)){let n=await Rn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:e,amount:ta({...t,openTime:t.openTime.toString(),endTime:t.endTime.toString()})});return{rewardPubKey:n.addresses.newAccount,newInstruction:n}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:t.mint,associatedOnly:!1})}}async create({poolInfo:e,rewardInfos:t,payer:n,programId:o=uo,txVersion:i,feePayer:s}){this.checkDisabled(),this.scope.checkOwner();let c={lpMint:new Te(e.lpMint.address),lockInfo:{lockMint:rc,lockVault:sc},version:6,rewardInfos:t,programId:o},u=this.createTxBuilder(s),l=n??this.scope.ownerPubKey,d=We({fromPublicKey:l,programId:c.programId}),m=await this.scope.connection.getMinimumBalanceForRentExemption(Ho.span);u.addInstruction({instructions:[Kp.createAccountWithSeed({fromPubkey:l,basePubkey:l,seed:d.seed,newAccountPubkey:d.publicKey,lamports:m,space:Ho.span,programId:c.programId})]});let{publicKey:p,nonce:y}=cc({programId:new Te(c.programId),poolId:d.publicKey}),f=Zo({programId:c.programId,poolId:d.publicKey,mint:c.lpMint,type:"lpVault"}),b=[],g=[];for(let T of c.rewardInfos){T.openTime>=T.endTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",T.openTime.toString()),isNaN(On[T.rewardType])&&this.logAndCreateError("rewardType error",T.rewardType),Number(T.perSecond)<=0&&this.logAndCreateError("rewardPerSecond error",T.perSecond),b.push(lc(T));let{rewardPubKey:B,newInstruction:S}=await this._getUserRewardInfo({rewardInfo:T,payer:l});S&&u.addInstruction(S),B||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let I=T.mint.equals($e)?new Te(Ze.address):T.mint;g.push({rewardMint:I,rewardVault:Zo({programId:c.programId,poolId:d.publicKey,mint:I,type:"rewardVault"}),userRewardToken:B})}let{account:w,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({mint:new Te(c.lockInfo.lockMint),owner:this.scope.ownerPubKey,skipCloseAccount:!1,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:!1});k&&u.addInstruction(k),w||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let{instruction:h,instructionType:x}=mc({farmId:d.publicKey,owner:this.scope.ownerPubKey,farmAuthority:p,lpVault:f,lpMint:c.lpMint,lockVault:c.lockInfo.lockVault,lockMint:c.lockInfo.lockMint,lockUserAccount:w,programId:c.programId,rewardInfo:g,rewardInfoConfig:b,nonce:y});return u.addInstruction({instructions:[h],instructionTypes:[x]}).versionBuild({txVersion:i,extInfo:{farmId:d.publicKey,farmAuthority:p,lpVault:f,lockUserAccount:w,nonce:y}})}async restartReward({farmInfo:e,payer:t,newRewardInfo:n,txVersion:o,feePayer:i}){let s=vt[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Le((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.openTime>=n.endTime&&this.logAndCreateError("start time error","newRewardInfo",n);let u=t||this.scope.ownerPubKey,l=n.mint.equals($e)?new Te(Ze.address):n.mint,d=c.rewardInfos.findIndex(g=>new Te(g.mint.address).equals(l)),m=a.rewardInfos[d];m||this.logAndCreateError("configuration does not exist","rewardMint",l);let p=m.vault??$e,y=this.createTxBuilder(i),{rewardPubKey:f,newInstruction:b}=await this._getUserRewardInfo({rewardInfo:n,payer:u});return b&&y.addInstruction(b),f||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts),y.addInstruction({instructions:[oa({payer:this.scope.ownerPubKey,rewardVault:p,userRewardTokenPub:f,farmKeys:c,rewardInfo:n})],instructionTypes:[V.FarmV6Restart]}).versionBuild({txVersion:o})}async restartRewards({farmInfo:e,payer:t,newRewardInfos:n,txVersion:o,feePayer:i}){let s=vt[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Le((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.forEach(d=>{d.openTime>=d.endTime&&this.logAndCreateError("start time error","newRewardInfo",d)});let u=t||this.scope.ownerPubKey,l=this.createTxBuilder(i);for(let d of n){let m=d.mint.equals($e)?new Te(Ze.address):d.mint,p=c.rewardInfos.findIndex(k=>new Te(k.mint.address).equals(m)),y=a.rewardInfos[p];y||this.logAndCreateError("configuration does not exist","rewardMint",m);let f=y.vault??$e,{rewardPubKey:b,newInstruction:g}=await this._getUserRewardInfo({rewardInfo:d,payer:u});g&&l.addInstruction(g),b||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let w=oa({payer:this.scope.ownerPubKey,rewardVault:f,userRewardTokenPub:b,farmKeys:c,rewardInfo:d});l.addInstruction({instructions:[w],instructionTypes:[V.FarmV6Restart]})}return l.versionBuild({txVersion:o})}async addNewRewardToken(e){let{txVersion:t,farmInfo:n,newRewardInfo:o,payer:i,feePayer:s}=e,a=vt[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=Le((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=i??this.scope.ownerPubKey,l=this.createTxBuilder(s),d=o.mint.equals($e)?new Te(Ze.address):o.mint,m=Zo({programId:new Te(n.programId),poolId:new Te(n.id),mint:d,type:"rewardVault"}),{rewardPubKey:p,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:o,payer:u});return y&&l.addInstruction(y),p||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts),o.mint=d,l.addInstruction({instructions:[ia({payer:this.scope.ownerPubKey,userRewardTokenPub:p,farmKeys:c,rewardVault:m,rewardInfo:o})],instructionTypes:[V.FarmV6CreatorAddReward]}).versionBuild({txVersion:t})}async addNewRewardsToken(e){let{txVersion:t,farmInfo:n,newRewardInfos:o,payer:i,feePayer:s}=e,a=vt[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=Le((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=i??this.scope.ownerPubKey,l=this.createTxBuilder(s);for(let d of o){let m=d.mint.equals($e)?new Te(Ze.address):d.mint,p=Zo({programId:new Te(n.programId),poolId:new Te(n.id),mint:m,type:"rewardVault"}),{rewardPubKey:y,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:d,payer:u});f&&l.addInstruction(f),y||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let b=ia({payer:this.scope.ownerPubKey,userRewardTokenPub:y,farmKeys:c,rewardVault:p,rewardInfo:{...d,mint:m}});l.addInstruction({instructions:[b],instructionTypes:[V.FarmV6CreatorAddReward]})}return l.versionBuild({txVersion:t})}async deposit(e){let{txVersion:t,farmInfo:n,amount:o,feePayer:i,useSOLBalance:s,associatedOnly:a=!0,checkCreateATAOwner:c=!1,userAuxiliaryLedgers:u,computeBudgetConfig:l,txTipConfig:d}=e;this.scope.availability.addFarm===!1&&this.logAndCreateError("farm deposit feature disabled in your region");let{rewardInfos:m,programId:p}=n,y=vt[p];y===4&&this.logAndCreateError("V4 has suspended deposits:",n.programId),zs(y)||this.logAndCreateError("invalid farm program:",n.programId);let[f,b]=[new Te(n.programId),new Te(n.id)],g=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],w=lt({programId:f,poolId:b,owner:this.scope.ownerPubKey,version:y}),k=this.createTxBuilder(i);k.addCustomComputeBudget(l),k.addTipInstruction(d);let h={};for(let D of this.scope.account.tokenAccounts)if(a){let q=Z(this.scope.ownerPubKey,D.mint,D.programId).publicKey;D.publicKey&&q.equals(D.publicKey)&&(h[D.mint.toString()]=D.publicKey)}else h[D.mint.toString()]=D.publicKey;let x=g.lpMint,T=h[x.address];T||this.logAndCreateError("you don't have any lp","lp zero",h);let B=[];for(let D of m){let q=s&&D.mint.address===j.toString(),G=h[D.mint.address];if(!G){let{account:Y,instructionParams:ie}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:D.mint.programId,mint:new Te(D.mint.address),notUseTokenAccount:q,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!q,associatedOnly:q?!1:a,checkCreateATAOwner:c});G=Y,ie&&k.addInstruction(ie)}h[D.mint.address]=G,B.push(G)}let S,I=await this.scope.connection.getAccountInfo(w);if(I&&(S=go(y).decode(I.data)),n.programId!==uo.toString()&&!S){let{instruction:D,instructionType:q}=Jo({id:b,programId:f,version:y,ledger:w,owner:this.scope.ownerPubKey});k.addInstruction({instructions:[D],instructionTypes:[q]})}let K=Hs({version:y,rewardInfos:m,rewardTokenAccountsPublicKeys:B});K&&this.logAndCreateError(K);let N={amount:$(o),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:g,lpAccount:T,rewardAccounts:B,userAuxiliaryLedgers:u?.map(D=>new Te(D))},v=y===6?bc(N):y===5?yc(N):fc(N),_={3:V.FarmV3Deposit,5:V.FarmV5Deposit,6:V.FarmV6Deposit};return k.addInstruction({instructions:[v],instructionTypes:[_[y]]}).versionBuild({txVersion:t})}async withdraw(e){let{txVersion:t,farmInfo:n,amount:o,deposited:i,useSOLBalance:s,feePayer:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,userAuxiliaryLedgers:l,computeBudgetConfig:d,txTipConfig:m}=e,{rewardInfos:p}=n;this.scope.availability.removeFarm===!1&&this.logAndCreateError("farm withdraw feature disabled in your region");let y=vt[n.programId];zs(y)||this.logAndCreateError("invalid farm program:",n.programId);let f=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],b=this.createTxBuilder(a);b.addCustomComputeBudget(d),b.addTipInstruction(m);let g={};for(let K of this.scope.account.tokenAccounts)if(c){let N=Z(this.scope.ownerPubKey,K.mint).publicKey;K.publicKey&&N.equals(K.publicKey)&&(g[K.mint.toString()]=K.publicKey)}else g[K.mint.toString()]=K.publicKey;if(y!==4){let K=lt({programId:new Te(n.programId),poolId:new Te(n.id),owner:this.scope.ownerPubKey,version:y}),N=await this.scope.connection.getAccountInfo(K);if(N)go(y).decode(N.data).deposited.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else if(y!==6){let{instruction:v,instructionType:_}=Jo({id:new Te(f.id),programId:new Te(f.programId),version:y,ledger:K,owner:this.scope.ownerPubKey});b.addInstruction({instructions:[v],instructionTypes:[_]})}}i&&i.isZero()&&!(l||[]).length&&this.logAndCreateError("no deposited lp",{farmId:n.id});let w=f.lpMint.address,k=s&&w===j.toString(),h=g[w.toString()];if(!h){let{account:K,instructionParams:N}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:f.lpMint.programId,mint:new Te(w),notUseTokenAccount:k,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:k?!1:c,checkCreateATAOwner:u});h=K,N&&b.addInstruction(N)}g[w.toString()]=h;let x=[];for(let K of p){let N=s&&K.mint.address===j.toString(),v=g[K.mint.address];if(!v){let{account:_,instructionParams:D}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:K.mint.programId,mint:new Te(K.mint.address),notUseTokenAccount:N,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!N,associatedOnly:N?!1:c,checkCreateATAOwner:u});v=_,D&&b.addInstruction(D)}g[K.mint.address]=v,x.push(v)}let T=Hs({version:y,rewardInfos:p,rewardTokenAccountsPublicKeys:x});T&&this.logAndCreateError(T);let B={amount:$(o),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:f,lpAccount:h,rewardAccounts:x,userAuxiliaryLedgers:l?.map(K=>new Te(K))},S=y===6?ei(B):y===5?ti(B):y===4?pc(B):ni(B),I={3:V.FarmV3Withdraw,4:V.FarmV4Withdraw,5:V.FarmV5Withdraw,6:V.FarmV6Withdraw};return b.addInstruction({instructions:[S],instructionTypes:[I[y]]}).versionBuild({txVersion:t})}async withdrawFarmReward({farmInfo:e,withdrawMint:t,txVersion:n,computeBudgetConfig:o,txTipConfig:i,feePayer:s}){this.scope.checkOwner();let a=Le((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c=vt[e.programId];c!==6&&this.logAndCreateError("invalid farm version",c);let u=a.rewardInfos.find(f=>ut(f.mint.address).equals(ut(t)));u||this.logAndCreateError("withdraw mint error","rewardInfos",e);let l=u?.vault??$e,d=this.createTxBuilder(s),m;if(t.equals($e)||t.equals(Te.default)){let f=await Rn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:ta({...u,openTime:u.openTime,endTime:u.endTime,perSecond:new C(u.perSecond).mul(10**u.mint.decimals).toString()})});m=f.addresses.newAccount,d.addInstruction(f)}else{let f=await this.scope.account.getCreatedTokenAccount({mint:t});f===null?(m=await this.scope.account.getAssociatedTokenAccount(t),d.addInstruction({instructions:[Cp(this.scope.ownerPubKey,m,this.scope.ownerPubKey,t)],instructionTypes:[V.CreateATA]})):m=f}let{instruction:p,instructionType:y}=dc({programId:a.programId,id:a.id,authority:a.authority,lpVault:a.lpVault,rewardVault:l,userRewardToken:m,owner:this.scope.ownerPubKey});return d.addCustomComputeBudget(o),d.addTipInstruction(i),d.addInstruction({instructions:[p],instructionTypes:[y]}).versionBuild({txVersion:n})}async harvestAllRewards(e){let{farmInfoList:t,useSOLBalance:n,feePayer:o,associatedOnly:i=!0,checkCreateATAOwner:s=!1,userAuxiliaryLedgers:a,txVersion:c,computeBudgetConfig:u}=e,l=this.createTxBuilder(o),d={};for(let y of this.scope.account.tokenAccounts)if(i){let f=Z(this.scope.ownerPubKey,y.mint).publicKey;y.publicKey&&f.equals(y.publicKey)&&(d[y.mint.toString()]=y.publicKey)}else d[y.mint.toString()]=y.publicKey;let p=(await this.scope.api.fetchFarmKeysById({ids:Object.values(t).map(y=>y.id).join(",")})).reduce((y,f)=>({...y,[f.id]:f}),{});for(let y of Object.values(t)){let{programId:f,lpMint:b,rewardInfos:g,id:w}=y,k=vt[f],h=b.address,x=n&&h===j.toString(),T=d[h];if(!T){let{account:v,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:b.programId,mint:new Te(h),notUseTokenAccount:x,createInfo:{payer:o||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:x?!1:i,checkCreateATAOwner:s});T=v,_&&l.addInstruction(_)}d[h.toString()]=T;let B=[];for(let v of g){let _=n&&v.mint.address===j.toString(),D=d[v.mint.address];if(!D){let{account:q,instructionParams:G}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:v.mint.programId,mint:new Te(v.mint.address),notUseTokenAccount:_,createInfo:{payer:o||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!_,associatedOnly:_?!1:i,checkCreateATAOwner:s});D=q,G&&l.addInstruction(G)}d[v.mint.address]=D,B.push(D)}let S=p[w],I={amount:ht,owner:this.scope.ownerPubKey,farmInfo:y,farmKeys:S,lpAccount:T,rewardAccounts:B,userAuxiliaryLedgers:a?.map(v=>new Te(v))},K=k===6?ei(I):k===5?ti(I):ni(I),N={3:V.FarmV3Withdraw,5:V.FarmV5Withdraw,6:V.FarmV6Withdraw};l.addInstruction({instructions:[K],instructionTypes:[N[k]]})}return c===1?l.sizeCheckBuild({computeBudgetConfig:u}):l.sizeCheckBuildV0({computeBudgetConfig:u})}};import{PublicKey as Ue}from"@solana/web3.js";import{AccountLayout as hf,NATIVE_MINT as Mr,TOKEN_PROGRAM_ID as Mn}from"@solana/spl-token";import{Keypair as Kr,PublicKey as U,SystemProgram as An,TransactionInstruction as it}from"@solana/web3.js";import pa from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as pi,TOKEN_2022_PROGRAM_ID as Fe,TOKEN_PROGRAM_ID as Ie}from"@solana/spl-token";import qp from"bn.js";import Mt from"bn.js";var pe=new Mt(0),Lt=new Mt(1),bn=new Mt(-1),Xe=new Mt(1).shln(64),hr=new Mt(1).shln(128),ii=Xe.sub(Lt),ri=64,gc=hr.subn(1),mt=-443636,gt=-mt,Et=new Mt("4295048016"),_t=new Mt("79226673521066979257578248091"),Tr=new Mt("4295048017"),Ir=new Mt("79226673521066979257578248090"),Pc=16,Ac="59543866431248",wc="184467440737095516",kc="15793534762490258745",Br=new Mt(10).pow(new Mt(6)),Lp=(n=>(n[n.rate_500=500]="rate_500",n[n.rate_3000=3e3]="rate_3000",n[n.rate_10000=1e4]="rate_10000",n))(Lp||{}),oh={[500]:10,[3e3]:60,[1e4]:200},ih={version:6,liquidity:pe,tickCurrent:0,feeGrowthGlobalX64A:pe,feeGrowthGlobalX64B:pe,protocolFeesTokenA:pe,protocolFeesTokenB:pe,swapInAmountTokenA:pe,swapOutAmountTokenB:pe,swapInAmountTokenB:pe,swapOutAmountTokenA:pe,tickArrayBitmap:[],rewardInfos:[],day:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},week:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},month:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},tvl:0},hc={tvl:0,volumeQuote:0,mintAmountA:0,mintAmountB:0,rewardDefaultInfos:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,day:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},week:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},month:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},pooltype:[]},rh=new Mt("18446744073700000000");import le from"bn.js";function xr(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r,!1),new Uint8Array(e)}function ah(r){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,r,!1),new Uint8Array(e)}function uh(r){let e=new ArrayBuffer(4);return new DataView(e).setUint32(0,r,!1),new Uint8Array(e)}function Sr(r){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,r,!1),new Uint8Array(e)}function ra(r,e){let t=0;for(let n=r-1;n>=0&&!e.testn(n);n--)t++;return t}function sa(r,e){let t=0;for(let n=0;n<r&&!e.testn(n);n++)t++;return t}function si(r,e){for(let t=0;t<r;t++)if(e.testn(t))return!1;return!0}function Tc(r,e){return si(r,e)?null:ra(r,e)}function Ic(r,e){return si(r,e)?null:sa(r,e)}var Rp=Buffer.from("amm_config","utf8"),Np=Buffer.from("pool","utf8"),Op=Buffer.from("pool_vault","utf8"),vp=Buffer.from("pool_reward_vault","utf8"),Bc=Buffer.from("position","utf8"),Mp=Buffer.from("tick_array","utf8"),Ep=Buffer.from("operation","utf8"),_p=Buffer.from("pool_tick_array_bitmap_extension","utf8"),Fp=Buffer.from("observation","utf8");function dh(r,e){return te([Rp,xr(e)],r)}function xc(r,e,t,n){return te([Np,e.toBuffer(),t.toBuffer(),n.toBuffer()],r)}function aa(r,e,t){return te([Op,e.toBuffer(),t.toBuffer()],r)}function Sc(r,e,t){return te([vp,e.toBuffer(),t.toBuffer()],r)}function fe(r,e,t){return te([Mp,e.toBuffer(),Sr(t)],r)}function Zt(r,e,t,n){return te([Bc,e.toBuffer(),Sr(t),Sr(n)],r)}function Pt(r,e){return te([Bc,e.toBuffer()],r)}function gn(r){return te([Buffer.from("metadata","utf8"),qt.toBuffer(),r.toBuffer()],qt)}function ai(r){return te([Ep],r)}function De(r,e){return te([_p,e.toBuffer()],r)}function Kc(r,e){return te([Fp,e.toBuffer()],r)}var Cc=Buffer.from("locked_position","utf8");function ua(r,e){return te([Cc,e.toBuffer()],r)}function ui(r,e){return te([Cc,e.toBuffer()],r)}var Vp=Buffer.from("support_mint","utf8");function ca(r,e){return te([Vp,e.toBuffer()],r)}import{PublicKey as Rt}from"@solana/web3.js";import{TOKEN_2022_PROGRAM_ID as Lc}from"@solana/spl-token";import Oe from"bn.js";import rn from"bn.js";var ci=class{static getfeeGrowthInside(e,t,n){let o=new rn(0),i=new rn(0);e.tickCurrent>=t.tick?(o=t.feeGrowthOutsideX64A,i=t.feeGrowthOutsideX64B):(o=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),i=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new rn(0),a=new rn(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let c=ae.wrappingSubU128(ae.wrappingSubU128(e.feeGrowthGlobalX64A,o),s),u=ae.wrappingSubU128(ae.wrappingSubU128(e.feeGrowthGlobalX64B,i),a);return{feeGrowthInsideX64A:c,feeGrowthInsideBX64:u}}static GetPositionFees(e,t,n,o){let{feeGrowthInsideX64A:i,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,o),a=ae.mulDivFloor(ae.wrappingSubU128(i,t.feeGrowthInsideLastX64A),t.liquidity,Xe),c=t.tokenFeesOwedA.add(a),u=ae.mulDivFloor(ae.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,Xe),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,o){let{feeGrowthInsideX64A:i,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,o),a=ae.mulDivFloor(ae.wrappingSubU128(i,t.feeGrowthInsideLastX64A),t.liquidity,Xe),c=t.tokenFeesOwedA.add(a),u=ae.mulDivFloor(ae.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,Xe),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,o){let i=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,o,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=ae.wrappingSubU128(c,u.growthInsideLastX64),d=ae.mulDivFloor(l,t.liquidity,Xe),m=u.rewardAmountOwed.add(d);i.push(m)}return i}static GetPositionRewards(e,t,n,o){let i=[],s=this.getRewardGrowthInside(e.tickCurrent,n,o,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=ae.wrappingSubU128(c,u.growthInsideLastX64),d=ae.mulDivFloor(l,t.liquidity,Xe),m=u.rewardAmountOwed.add(d);i.push(m)}return i}static getRewardGrowthInside(e,t,n,o){let i=[];for(let s=0;s<o.length;s++){let a=new rn(0);t.liquidityGross.eqn(0)?a=o[s].rewardGrowthGlobalX64:e<t.tick?a=o[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new rn(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=o[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),i.push(ae.wrappingSubU128(ae.wrappingSubU128(o[s].rewardGrowthGlobalX64,a),c))}return i}static getRewardGrowthInsideV2(e,t,n,o){let i=[];for(let s=0;s<o.length;s++){let a=new rn(0);t.liquidityGross.eqn(0)?a=o[s].rewardGrowthGlobalX64:e<t.tick?a=o[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new rn(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=o[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),i.push(ae.wrappingSubU128(ae.wrappingSubU128(o[s].rewardGrowthGlobalX64,a),c))}return i}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:o,add:i,epochInfo:s}){let a=ne.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),c=ne.getSqrtPriceX64FromTick(t.tickLower),u=ne.getSqrtPriceX64FromTick(t.tickUpper),l=i?1+o:1-o,d=ye.getAmountsFromLiquidity(a,c,u,n,i),[m,p]=[Ae(d.amountA,e.mintA.extensions?.feeConfig,s,!0),Ae(d.amountB,e.mintB.extensions?.feeConfig,s,!0)],[y,f]=[Ae(new rn(new C(d.amountA.toString()).mul(l).toFixed(0)),e.mintA.extensions?.feeConfig,s,!0),Ae(new rn(new C(d.amountB.toString()).mul(l).toFixed(0)),e.mintB.extensions?.feeConfig,s,!0)];return{liquidity:n,amountA:m,amountB:p,amountSlippageA:y,amountSlippageB:f,expirationTime:Xt(m.expirationTime,p.expirationTime)}}};var Wp=15,be=class{static async getTickArrays(e,t,n,o,i,s,a){let c=[],u=H.getTickArrayStartIndexByTick(o,i),l=H.getInitializedTickArrayInRange(s,a,i,u,Math.floor(Wp/2));for(let p=0;p<l.length;p++){let{publicKey:y}=fe(t,n,l[p]);c.push(y)}let d=(await Vt(e,c)).map(p=>p!==null?li.decode(p.data):null),m={};for(let p=0;p<c.length;p++){let y=d[p];y!==null&&(m[y.startTickIndex]={...y,address:c[p]})}return m}static nextInitializedTick(e,t,n,o,i,s){let{initializedTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}=this.nextInitializedTickInOneArray(e,t,n,o,i,s);for(;a==null||a.liquidityGross.lten(0);){if(u=H.getNextTickArrayStartIndex(u,i,s),this.checkIsValidStartIndex(u,i))throw new Error("No enough initialized tickArray");let l=n[u];if(l===void 0)continue;let{nextTick:d,tickArrayAddress:m,tickArrayStartTickIndex:p}=this.firstInitializedTickInOneArray(e,t,l,s);[a,c,u]=[d,m,p]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}}static nextInitializedTickArray(e,t,n,o,i){let s=Math.floor(e/be.tickCount(t)),a=n?H.searchLowBitFromStart(o,i,s-1,1,t):H.searchHightBitFromStart(o,i,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,o){let i;if(o){let a=He-1;for(;a>=0;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){i=c;break}a=a-1}}else{let a=0;for(;a<He;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){i=c;break}a=a+1}}let{publicKey:s}=fe(e,t,n.startTickIndex);return{nextTick:i,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,o,i,s){let a=H.getTickArrayStartIndexByTick(o,i),c=Math.floor((o-a)/i),u=n[a];if(u==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;c>=0;){let m=u.ticks[c];if(m.liquidityGross.gtn(0)){l=m;break}c=c-1}else for(c=c+1;c<He;){let m=u.ticks[c];if(m.liquidityGross.gtn(0)){l=m;break}c=c+1}let{publicKey:d}=fe(e,t,a);return{initializedTick:l,tickArrayAddress:d,tickArrayStartTickIndex:u.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(H.checkIsOutOfBoundary(e)){if(e>gt)return!1;let n=H.getTickArrayStartIndexByTick(mt,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return He*e}};var la=14,Pn=class{static maxTickInTickarrayBitmap(e){return e*He*Un}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),o=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(o+=1);let i=n*o;return e<0?{minValue:-i,maxValue:-i+n}:{minValue:i,maxValue:i+n}}static nextInitializedTickArrayStartIndex(e,t,n,o){if(!be.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let i=this.maxTickInTickarrayBitmap(n),s=o?t-be.tickCount(n):t+be.tickCount(n);if(s<-i||s>=i)return{isInit:!1,tickIndex:t};let a=n*He,c=s/a+512;s<0&&s%a!=0&&c--;let u=Math.abs(c);if(o){let l=e.shln(1024-u-1),d=Tc(1024,l);if(d!==null){let m=(u-d-512)*a;return{isInit:!0,tickIndex:m}}else return{isInit:!1,tickIndex:-i}}else{let l=e.shrn(u),d=Ic(1024,l);if(d!==null){let m=(u+d-512)*a;return{isInit:!0,tickIndex:m}}else return{isInit:!1,tickIndex:i-be.tickCount(n)}}}},mi=class{static getBitmapOffset(e,t){if(!be.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=Pn.maxTickInTickarrayBitmap(t),o=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&o--,o}static getBitmap(e,t,n){let o=this.getBitmapOffset(e,t);return e<0?{offset:o,tickarrayBitmap:n.negativeTickArrayBitmap[o]}:{offset:o,tickarrayBitmap:n.positiveTickArrayBitmap[o]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:o}=this.extensionTickBoundary(t);if(e>=o&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=Pn.maxTickInTickarrayBitmap(e),n=-t;if(gt<=t)throw Error(`extensionTickBoundary check error: ${gt}, ${t}`);if(n<=mt)throw Error(`extensionTickBoundary check error: ${n}, ${mt}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:o}=this.getBitmap(e,t,n),i=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:H.mergeTickArrayBitmap(o).testn(i),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,o){let i=be.tickCount(t),s=n?e-i:e+i,{tickarrayBitmap:a}=this.getBitmap(s,t,o);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,o){let{minValue:i,maxValue:s}=Pn.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(o){let c=H.mergeTickArrayBitmap(e).shln(Un-1-a),u=si(512,c)?null:ra(512,c);if(u!==null){let l=t-u*be.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:i}}else{let c=H.mergeTickArrayBitmap(e).shrn(a),u=si(512,c)?null:sa(512,c);if(u!==null){let l=t+u*be.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-be.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%Pn.maxTickInTickarrayBitmap(t),o=Math.floor(n/be.tickCount(t));return e<0&&n!=0&&(o=Un-o),o}};var Ce=class{static getOutputAmountAndRemainAccounts(e,t,n,o,i,s=!1){let a=n.toBase58()===e.mintA.address,c=[],{isExist:u,startIndex:l,nextAccountMeta:d}=this.getFirstInitializedTickArray(e,a);if(!u||l===void 0||!d)throw new Error("Invalid tick array");c.push(d);let{allTrade:m,amountCalculated:p,accounts:y,sqrtPriceX64:f,feeAmount:b}=Gn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,a,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,o,l,i,s);return c.push(...y),{allTrade:m,expectedAmountOut:p.mul(bn),remainingAccounts:c,executionPrice:f,feeAmount:b}}static getInputAmountAndRemainAccounts(e,t,n,o,i){let s=n.toBase58()===e.mintB.address,a=[],{isExist:c,startIndex:u,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!c||u===void 0||!l)throw new Error("Invalid tick array");try{let f=this.preInitializedTickArrayStartIndex(e,s);if(f.isExist){let{publicKey:b}=fe(e.programId,e.id,f.nextStartIndex);a.push(b)}}catch{}a.push(l);let{amountCalculated:d,accounts:m,sqrtPriceX64:p,feeAmount:y}=Gn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,o.mul(bn),u,i);return a.push(...m),{expectedAmountIn:d,remainingAccounts:a,executionPrice:p,feeAmount:y}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:o}=Ce.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?mi.checkTickArrayIsInit(be.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):H.checkTickArrayIsInitialized(H.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=fe(e.programId,e.id,o);return{isExist:!0,startIndex:o,nextAccountMeta:a}}let{isExist:i,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,be.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(i){let{publicKey:a}=fe(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/be.tickCount(e.tickSpacing)),o=t?H.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):H.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return o.length>0?{isExist:!0,nextStartIndex:o[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=be.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:o,tickIndex:i}=Pn.nextInitializedTickArrayStartIndex(H.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(o)return{isExist:!0,nextStartIndex:i};t=i;let{isInit:s,tickIndex:a}=mi.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<mt||t>gt)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:o,rewardInfos:i}){let s=[];for(let a=0;a<i.length;a++){let c=i[a],u=t.rewardDefaultInfos[a]?.mint.programId??(await e.getAccountInfo(c.tokenMint))?.owner;if(u===void 0)throw Error("get new reward mint info error");let l={...c,perSecond:ae.x64ToDecimal(c.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new Rt(u)};if(l.tokenMint.equals(Rt.default))continue;if(n<=l.openTime.toNumber()||o.eq(pe)){s.push(l);continue}let d=new Oe(Math.min(l.endTime.toNumber(),n)),m=d.sub(l.lastUpdateTime),p=ae.mulDivFloor(m,l.emissionsPerSecondX64,o),y=l.rewardGrowthGlobalX64.add(p),f=ae.mulDivFloor(m,l.emissionsPerSecondX64,Xe),b=l.rewardTotalEmissioned.add(f);s.push({...l,rewardGrowthGlobalX64:y,rewardTotalEmissioned:b,lastUpdateTime:d})}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:o}=this.tickRange(e);for(let i of t){let s=H.getTickArrayStartIndexByTick(i,e);if(s>=n||s<o)return!0}return!1}static tickRange(e){let t=Pn.maxTickInTickarrayBitmap(e),n=-t;return t>gt&&(t=be.getArrayStartIndex(gt,e)+be.tickCount(e)),n<mt&&(n=be.getArrayStartIndex(mt,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!be.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/be.tickCount(t)*Un}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let o=await Se(e,t.map(s=>({pubkey:s})),{batchRequest:n}),i={};for(let s of o)s.accountInfo!==null&&(i[s.pubkey.toString()]=Nc.decode(s.accountInfo.data));return i}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let o={},i=[];for(let c of t){let u=H.getTickArrayStartIndexByTick(c.tickCurrent,c.tickSpacing),l=H.getInitializedTickArrayInRange(c.tickArrayBitmap,c.exBitmapInfo,c.tickSpacing,u,7);for(let d of l){let{publicKey:m}=fe(c.programId,c.id,d);i.push({pubkey:m}),o[m.toString()]=c.id}}let s=await Se(e,i,{batchRequest:n}),a={};for(let c of s){if(!c.accountInfo)continue;let u=o[c.pubkey.toString()];if(!u)continue;a[u.toString()]===void 0&&(a[u.toString()]={});let l=li.decode(c.accountInfo.data);a[u.toString()][l.startTickIndex]={...l,address:c.pubkey}}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:o=!1,updateOwnerRewardAndFee:i=!0}){let s=[];for(let a=0;a<e.length;a++){let c=e[a];c!==null&&(s.find(u=>u.equals(c.state.programId))||s.push(c.state.programId))}if(n){let a=n.tokenAccounts.map(d=>d.accountInfo.mint),c=[];for(let d of a)for(let m of s)c.push(Pt(m,d).publicKey);let u=await Vt(t,c,{batchRequest:o}),l={};for(let d of u){if(d===null)continue;let m=di.decode(d.data),p=m.poolId.toString(),y=e.find(B=>B.state.id.toBase58()===p);if(y===void 0)continue;let f=y.state,b=H._getTickPriceLegacy({poolInfo:f,tick:m.tickLower,baseIn:!0}),g=H._getTickPriceLegacy({poolInfo:f,tick:m.tickUpper,baseIn:!0}),{amountA:w,amountB:k}=ye.getAmountsFromLiquidity(f.sqrtPriceX64,b.tickSqrtPriceX64,g.tickSqrtPriceX64,m.liquidity,!1),h=1/(1-Math.sqrt(Math.sqrt(b.price.div(g.price).toNumber())));y.positionAccount=[...y.positionAccount??[],{poolId:m.poolId,nftMint:m.nftMint,priceLower:b.price,priceUpper:g.price,amountA:w,amountB:k,tickLower:m.tickLower,tickUpper:m.tickUpper,liquidity:m.liquidity,feeGrowthInsideLastX64A:m.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:m.feeGrowthInsideLastX64B,tokenFeesOwedA:m.tokenFeesOwedA,tokenFeesOwedB:m.tokenFeesOwedB,rewardInfos:m.rewardInfos.map(B=>({...B,pendingReward:new Oe(0)})),leverage:h,tokenFeeAmountA:new Oe(0),tokenFeeAmountB:new Oe(0)}];let x=await H.getTickArrayAddressByTick(y.state.programId,m.poolId,m.tickLower,y.state.tickSpacing),T=await H.getTickArrayAddressByTick(y.state.programId,m.poolId,m.tickUpper,y.state.tickSpacing);l[`${y.state.programId.toString()}-${m.poolId.toString()}-${m.tickLower}`]=x,l[`${y.state.programId.toString()}-${m.poolId.toString()}-${m.tickUpper}`]=T}if(i){let d=Object.values(l),m=await Vt(t,d,{batchRequest:o}),p={};for(let y=0;y<d.length;y++){let f=m[y];if(f===null)continue;let b=d[y].toString();p[b]=li.decode(f.data)}for(let{state:y,positionAccount:f}of e)if(!!f)for(let b of f){let g=`${y.programId.toString()}-${y.id.toString()}-${b.tickLower}`,w=`${y.programId.toString()}-${y.id.toString()}-${b.tickUpper}`,k=p[l[g].toString()],h=p[l[w].toString()],x=k.ticks[H.getTickOffsetInArray(b.tickLower,y.tickSpacing)],T=h.ticks[H.getTickOffsetInArray(b.tickUpper,y.tickSpacing)],{tokenFeeAmountA:B,tokenFeeAmountB:S}=await ci.GetPositionFees(y,b,x,T),I=await ci.GetPositionRewards(y,b,x,T);b.tokenFeeAmountA=B.gte(new Oe(0))?B:new Oe(0),b.tokenFeeAmountB=S.gte(new Oe(0))?S:new Oe(0);for(let K=0;K<I.length;K++)b.rewardInfos[K].pendingReward=I[K].gte(new Oe(0))?I[K]:new Oe(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:o,amountIn:i,slippage:s,priceLimit:a=new C(0),catchLiquidityInsufficient:c=!1}){let u,l=n.toBase58()===e.mintA.address,[d,m]=l?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];a.equals(new C(0))?u=l?Et.add(new Oe(1)):_t.sub(new Oe(1)):u=ne.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let p=Ae(i,d,o,!1),{allTrade:y,expectedAmountOut:f,remainingAccounts:b,executionPrice:g,feeAmount:w}=Ce.getOutputAmountAndRemainAccounts(e,t,n,p.amount.sub(p.fee??pe),u,c),k=Ae(f,m,o,!1),h=ne.sqrtPriceX64ToPrice(g,e.mintA.decimals,e.mintB.decimals),x=l?h:new C(1).div(h),T=f.mul(new Oe(Math.floor((1-s)*1e10))).div(new Oe(1e10)),B=Ae(T,m,o,!1),S=l?e.currentPrice:new C(1).div(e.currentPrice),I=new C(x).sub(S).abs(),K=S,N=new Je(new C(I).mul(10**15).toFixed(0),new C(K).mul(10**15).toFixed(0));return{allTrade:y,realAmountIn:p,amountOut:k,minAmountOut:B,expirationTime:Xt(p.expirationTime,k.expirationTime),currentPrice:e.currentPrice,executionPrice:x,priceImpact:N,fee:w,remainingAccounts:b,executionPriceX64:g}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:o,slippage:i,epochInfo:s,catchLiquidityInsufficient:a=!1}){let c=o.address===e.mintB.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA],[d,m]=[new Me({...u,mint:u.address,isToken2022:u.programId===Lc.toBase58()}),new Me({...l,mint:l.address,isToken2022:l.programId===Lc.toBase58()})],{allTrade:p,realAmountIn:y,amountOut:f,minAmountOut:b,expirationTime:g,currentPrice:w,executionPrice:k,priceImpact:h,fee:x,remainingAccounts:T,executionPriceX64:B}=Ce.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new Rt(u.address),amountIn:n,slippage:i,epochInfo:s,catchLiquidityInsufficient:a}),S={...y,amount:new he(d,y.amount),fee:y.fee===void 0?void 0:new he(d,y.fee)},I={...f,amount:new he(m,f.amount),fee:f.fee===void 0?void 0:new he(m,f.fee)},K={...b,amount:new he(m,b.amount),fee:b.fee===void 0?void 0:new he(m,b.fee)},N=new kt({baseToken:d,denominator:new Oe(10).pow(new Oe(20+d.decimals)),quoteToken:m,numerator:w.mul(new C(10**(20+m.decimals))).toFixed(0)}),v=new kt({baseToken:d,denominator:new Oe(10).pow(new Oe(20+d.decimals)),quoteToken:m,numerator:k.mul(new C(10**(20+m.decimals))).toFixed(0)}),_=new he(d,x);return{allTrade:p,realAmountIn:S,amountOut:I,minAmountOut:K,expirationTime:g,currentPrice:N,executionPrice:v,priceImpact:h,fee:_,remainingAccounts:T,executionPriceX64:B}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:o,amountOut:i,slippage:s,priceLimit:a=new C(0)}){let c=n.toBase58()===e.mintA.address,u={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},l;a.equals(new C(0))?l=c?_t.sub(new Oe(1)):Et.add(new Oe(1)):l=ne.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let d=Ae(i,u[n.toString()],o,!0),{expectedAmountIn:m,remainingAccounts:p,executionPrice:y,feeAmount:f}=Ce.getInputAmountAndRemainAccounts(e,t,n,d.amount.sub(d.fee??pe),l),b=c?e.mintB.address:e.mintA.address,g=Ae(m,u[b],o,!1),w=ne.sqrtPriceX64ToPrice(y,e.mintA.decimals,e.mintB.decimals),k=c?w:new C(1).div(w),h=m.mul(new Oe(Math.floor((1+s)*1e10))).div(new Oe(1e10)),x=Ae(h,u[b],o,!0),T=c?e.currentPrice:new C(1).div(e.currentPrice),B=new C(k).sub(T).abs(),S=T,I=new Je(new C(B).mul(10**15).toFixed(0),new C(S).mul(10**15).toFixed(0));return{amountIn:g,maxAmountIn:x,realAmountOut:d,expirationTime:Xt(g.expirationTime,d.expirationTime),currentPrice:e.currentPrice,executionPrice:k,priceImpact:I,fee:f,remainingAccounts:p}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:o}){let i=e[t],s=H.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=H.getTickPrice({poolInfo:e,tick:o,baseIn:!0}).price.toNumber(),c=Math.max(s,i.priceMin),l=Math.min(a,i.priceMax)-c,d=a-s,m=i.priceMax-i.priceMin,p;return l<=0?p=0:d===l?p=m/l:m===l?p=l/d:p=l/m*(l/d),{feeApr:i.feeApr*p,rewardsApr:[(i.rewardApr[0]??0)*p,(i.rewardApr[1]??0)*p,(i.rewardApr[2]??0)*p],apr:i.apr*p}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:o,liquidity:i,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:c}){let u=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],d=o[ut(e.mintA.address).toString()],m=o[ut(e.mintB.address).toString()],p=e.mintA.decimals,y=e.mintB.decimals;if(!l||!d||!m)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let f=ne.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),b=ne.getSqrtPriceX64FromTick(s),g=ne.getSqrtPriceX64FromTick(a),{amountSlippageA:w,amountSlippageB:k}=ye.getAmountsFromLiquidityWithSlippage(f,b,g,t,!1,!1,0),{amountSlippageA:h,amountSlippageB:x}=ye.getAmountsFromLiquidityWithSlippage(f,b,g,i,!1,!1,0),T=new C(w.toString()).div(new C(10).pow(p)).mul(d.value).add(new C(k.toString()).div(new C(10).pow(y)).mul(m.value)),B=new C(h.toString()).div(new C(10).pow(p)).mul(d.value).add(new C(x.toString()).div(new C(10).pow(y)).mul(m.value)),S=new C(1).div(T.add(B)),K=new C(l.volumeFee).mul(365).div(u).mul(S).mul(100).toNumber(),N=3600*24*365,v=e.rewardDefaultInfos.map(_=>{let D=_.mint.decimals,q=o[_.mint.address];return c<(_.startTime??0)||c>(_.endTime??0)||!_.perSecond||!q||D===void 0?0:new C(q.value).mul(new C(_.perSecond).mul(N)).div(new C(10).pow(D)).mul(S).mul(100).toNumber()});return{feeApr:K,rewardsApr:v,apr:K+v.reduce((_,D)=>_+D,0)}}static async getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:o,amount:i,slippage:s,add:a,epochInfo:c,amountHasFee:u}){let l=ne.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),d=ne.getSqrtPriceX64FromTick(n),m=ne.getSqrtPriceX64FromTick(o),p=Ae(i,e[t?"mintA":"mintB"].extensions?.feeConfig,c,!u),y=new Oe(new C(p.amount.sub(p.fee??pe).toString()).toFixed(0)),f;if(l.lte(d))f=t?ye.getLiquidityFromTokenAmountA(d,m,y,!a):new Oe(0);else if(l.lte(m)){let g=ye.getLiquidityFromTokenAmountA(l,m,y,!a),w=ye.getLiquidityFromTokenAmountB(d,l,y);f=t?g:w}else f=t?new Oe(0):ye.getLiquidityFromTokenAmountB(d,m,y);let b=await Ce.getAmountsFromLiquidity({epochInfo:c,poolInfo:e,tickLower:n,tickUpper:o,liquidity:f,slippage:s,add:a});return{liquidity:f,amountA:t?p:b.amountA,amountB:t?b.amountB:p,amountSlippageA:t?p:b.amountSlippageA,amountSlippageB:t?b.amountSlippageB:p,expirationTime:b.expirationTime}}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:o,liquidity:i,slippage:s,add:a}){let c=ne.getSqrtPriceX64FromTick(n),u=ne.getSqrtPriceX64FromTick(o),l=a?1+s:1-s,d=ye.getAmountsFromLiquidity(ne.priceToSqrtPriceX64(new C(t.price),t.mintA.decimals,t.mintB.decimals),c,u,i,a),[m,p]=[Ae(d.amountA,t.mintA.extensions?.feeConfig,e,!0),Ae(d.amountB,t.mintB.extensions?.feeConfig,e,!0)],[y,f]=[Ae(d.amountA.muln(l),t.mintA.extensions?.feeConfig,e,!0),Ae(d.amountB.muln(l),t.mintB.extensions?.feeConfig,e,!0)];return{liquidity:i,amountA:m,amountB:p,amountSlippageA:y,amountSlippageB:f,expirationTime:Xt(m.expirationTime,p.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let o=t.filter(c=>!n[c.id]).map(c=>new Rt(c.id));(await Vt(e,o)).forEach((c,u)=>{!c||(n[o[u].toBase58()]=Xn.decode(c.data))});let s=t.map(c=>De(new Rt(c.programId),new Rt(c.id)).publicKey),a=await Ce.fetchExBitmaps({connection:e,exBitmapAddress:s,batchRequest:!1});return t.reduce((c,u)=>({...c,[u.id]:{...n[u.id],id:new Rt(u.id),version:6,programId:new Rt(u.programId),mintA:u.mintA,mintB:u.mintB,ammConfig:{...u.config,id:new Rt(u.config.id),fundOwner:""},currentPrice:new C(u.price),exBitmapAccount:De(new Rt(u.programId),new Rt(u.id)).publicKey,exBitmapInfo:a[De(new Rt(u.programId),new Rt(u.id)).publicKey.toBase58()],startTime:n[u.id].startTime.toNumber(),rewardInfos:n[u.id].rewardInfos}}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};function Zh({poolInfo:r,tickLower:e,tickUpper:t,amountA:n,amountB:o,slippage:i,add:s,epochInfo:a,amountHasFee:c}){let[u,l,d,m]=e<t?[e,t,n,o]:[t,e,o,n],p=ne.priceToSqrtPriceX64(new C(r.price),r.mintA.decimals,r.mintB.decimals),y=ne.getSqrtPriceX64FromTick(u),f=ne.getSqrtPriceX64FromTick(l),[b,g]=[Ae(d,r.mintA.extensions?.feeConfig,a,!c),Ae(m,r.mintB.extensions?.feeConfig,a,!c)],w=ye.getLiquidityFromTokenAmounts(p,y,f,b.amount.sub(b.fee??pe),g.amount.sub(g.fee??pe));return ye.getAmountsOutFromLiquidity({poolInfo:r,tickLower:e,tickUpper:t,liquidity:w,slippage:i,add:s,epochInfo:a,amountAddFee:!c})}var ma={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};function Rc(r){return{...r,type:"Concentrated",programId:r.programId.toString(),id:r.id.toString(),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Clmm",price:r.currentPrice.toNumber(),mintAmountA:0,mintAmountB:0,feeRate:r.ammConfig.tradeFeeRate,openTime:r.startTime.toString(),tvl:0,day:ma,week:ma,month:ma,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,burnPercent:0,config:{...r.ammConfig,id:r.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]}}}var ae=class{static mulDivRoundingUp(e,t,n){let o=e.mul(t),i=o.div(n);return o.mod(n).eq(pe)||(i=i.add(Lt)),i}static mulDivFloor(e,t,n){if(n.eq(pe))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(pe))throw new Error("division by 0");return e.mul(t).add(n.sub(Lt)).div(n)}static x64ToDecimal(e,t){return new C(e.toString()).div(C.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new le(e.mul(C.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(hr).sub(t).mod(hr)}};function tt(r,e){return da(r.mul(e),64,256)}function Dp(r,e,t){let n=r.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function da(r,e,t){let n=r.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var ne=class{static sqrtPriceX64ToPrice(e,t,n){return ae.x64ToDecimal(e).pow(2).mul(C.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return ae.decimalToX64(e.mul(C.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,o){if(!e.gt(pe))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(pe))throw new Error("liquidity must greater than 0");return o?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,o){if(!e.gt(pe))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(pe))throw new Error("liquidity must greater than 0");return o?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,o){if(n.eq(pe))return e;let i=t.shln(ri);if(o){let s=i,a=i.add(n.mul(e));return a.gte(s)?ae.mulDivCeil(s,e,a):ae.mulDivRoundingUp(s,Lt,s.div(e).add(n))}else{let s=n.mul(e);if(!i.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=i.sub(s);return ae.mulDivCeil(i,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,o){let i=n.shln(ri);if(o)return e.add(i.div(t));{let s=ae.mulDivRoundingUp(i,Lt,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<mt||e>gt)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new le("18445821805675395072"):new le("18446744073709551616");return(t&2)!=0&&(n=tt(n,new le("18444899583751176192"))),(t&4)!=0&&(n=tt(n,new le("18443055278223355904"))),(t&8)!=0&&(n=tt(n,new le("18439367220385607680"))),(t&16)!=0&&(n=tt(n,new le("18431993317065453568"))),(t&32)!=0&&(n=tt(n,new le("18417254355718170624"))),(t&64)!=0&&(n=tt(n,new le("18387811781193609216"))),(t&128)!=0&&(n=tt(n,new le("18329067761203558400"))),(t&256)!=0&&(n=tt(n,new le("18212142134806163456"))),(t&512)!=0&&(n=tt(n,new le("17980523815641700352"))),(t&1024)!=0&&(n=tt(n,new le("17526086738831433728"))),(t&2048)!=0&&(n=tt(n,new le("16651378430235570176"))),(t&4096)!=0&&(n=tt(n,new le("15030750278694412288"))),(t&8192)!=0&&(n=tt(n,new le("12247334978884435968"))),(t&16384)!=0&&(n=tt(n,new le("8131365268886854656"))),(t&32768)!=0&&(n=tt(n,new le("3584323654725218816"))),(t&65536)!=0&&(n=tt(n,new le("696457651848324352"))),(t&131072)!=0&&(n=tt(n,new le("26294789957507116"))),(t&262144)!=0&&(n=tt(n,new le("37481735321082"))),e>0&&(n=gc.div(n)),n}static getTickFromPrice(e,t,n){return ne.getTickFromSqrtPriceX64(ne.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(_t)||e.lt(Et))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new le(t-64),o=Dp(n,32,128),i=new le("8000000000000000","hex"),s=0,a=new le(0),c=t>=64?e.shrn(t-63):e.shln(63-t);for(;i.gt(new le(0))&&s<Pc;){c=c.mul(c);let y=c.shrn(127);c=c.shrn(63+y.toNumber()),a=a.add(i.mul(y)),i=i.shrn(1),s+=1}let u=a.shrn(32),d=o.add(u).mul(new le(Ac)),m=da(d.sub(new le(wc)),64,128).toNumber(),p=da(d.add(new le(kc)),64,128).toNumber();return m==p?m:ne.getSqrtPriceX64FromTick(p).lte(e)?p:m}},Qn=class{static getTickWithPriceAndTickspacing(e,t,n,o){let s=ne.getTickFromSqrtPriceX64(ne.priceToSqrtPriceX64(e,n,o))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,o){let i=Qn.getTickWithPriceAndTickspacing(e,t,n,o),s=ne.getSqrtPriceX64FromTick(i);return ne.sqrtPriceX64ToPrice(s,n,o)}},ye=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,o){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(pe))throw new Error("sqrtPriceX64A must greater than 0");let i=n.ushln(ri),s=t.sub(e);return o?ae.mulDivRoundingUp(ae.mulDivCeil(i,s,t),Lt,e):ae.mulDivFloor(i,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,o){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(pe))throw new Error("sqrtPriceX64A must greater than 0");return o?ae.mulDivCeil(n,t.sub(e),Xe):ae.mulDivFloor(n,t.sub(e),Xe)}static getLiquidityFromTokenAmountA(e,t,n,o){e.gt(t)&&([e,t]=[t,e]);let i=n.mul(e).mul(t),s=t.sub(e),a=i.div(s);return o?ae.mulDivRoundingUp(a,Lt,ii):a.shrn(ri)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),ae.mulDivFloor(n,ii,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,o,i){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return ye.getLiquidityFromTokenAmountA(t,n,o,!1);if(e.lt(n)){let s=ye.getLiquidityFromTokenAmountA(e,n,o,!1),a=ye.getLiquidityFromTokenAmountB(t,e,i);return s.lt(a)?s:a}else return ye.getLiquidityFromTokenAmountB(t,n,i)}static getAmountsFromLiquidity(e,t,n,o,i){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:ye.getTokenAmountAFromLiquidity(t,n,o,i),amountB:new le(0)};if(e.lt(n)){let s=ye.getTokenAmountAFromLiquidity(e,n,o,i),a=ye.getTokenAmountBFromLiquidity(t,e,o,i);return{amountA:s,amountB:a}}else return{amountA:new le(0),amountB:ye.getTokenAmountBFromLiquidity(t,n,o,i)}}static getAmountsFromLiquidityWithSlippage(e,t,n,o,i,s,a){let{amountA:c,amountB:u}=ye.getAmountsFromLiquidity(e,t,n,o,s),l=i?1+a:1-a,d=new le(new C(c.toString()).mul(l).toFixed(0)),m=new le(new C(u.toString()).mul(l).toFixed(0));return{amountSlippageA:d,amountSlippageB:m}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:o,slippage:i,add:s,epochInfo:a,amountAddFee:c}){let u=ne.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),l=ne.getSqrtPriceX64FromTick(t),d=ne.getSqrtPriceX64FromTick(n),m=s?1+i:1-i,p=ye.getAmountsFromLiquidity(u,l,d,o,s),[y,f]=[Ae(p.amountA,e.mintA.extensions?.feeConfig,a,c),Ae(p.amountB,e.mintB.extensions?.feeConfig,a,c)],[b,g]=[Ae(new le(new C(p.amountA.toString()).mul(m).toFixed(0)),e.mintA.extensions?.feeConfig,a,c),Ae(new le(new C(p.amountB.toString()).mul(m).toFixed(0)),e.mintB.extensions?.feeConfig,a,c)];return{liquidity:o,amountA:y,amountB:f,amountSlippageA:b,amountSlippageB:g,expirationTime:Xt(y.expirationTime,f.expirationTime)}}},Gn=class{static swapCompute(e,t,n,o,i,s,a,c,u,l,d,m,p,y,f=!1){if(m.eq(pe))throw new Error("amountSpecified must not be 0");if(y||(y=s?Et.add(Lt):_t.sub(Lt)),s){if(y.lt(Et))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(y.gte(d))throw new Error("sqrtPriceX64 must smaller than current")}else{if(y.gt(_t))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(y.lte(d))throw new Error("sqrtPriceX64 must greater than current")}let b=m.gt(pe),g={amountSpecifiedRemaining:m,amountCalculated:pe,sqrtPriceX64:d,tick:u>p?Math.min(p+be.tickCount(l)-1,u):p,accounts:[],liquidity:c,feeAmount:new le(0)},w=p,k=n[p],h=0,x=!s&&k.startTickIndex===g.tick;for(;!g.amountSpecifiedRemaining.eq(pe)&&!g.sqrtPriceX64.eq(y);){h>10;let T={};T.sqrtPriceStartX64=g.sqrtPriceX64;let B=H.nextInitTick(k,g.tick,l,s,x),S=B||null,I=null;if(!S?.liquidityGross.gtn(0)){let N=Ce.nextInitializedTickArrayStartIndex({tickCurrent:g.tick,tickSpacing:l,tickArrayBitmap:o,exBitmapInfo:i},w,s);if(!N.isExist){if(f)return{allTrade:!1,amountSpecifiedRemaining:g.amountSpecifiedRemaining,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts};throw Error("swapCompute LiquidityInsufficient")}w=N.nextStartIndex;let{publicKey:v}=fe(e,t,w);I=v,k=n[w];try{S=H.firstInitializedTick(k,s)}catch{throw Error("not found next tick info")}}T.tickNext=S.tick,T.initialized=S.liquidityGross.gtn(0),p!==w&&I&&(g.accounts.push(I),p=w),T.tickNext<mt?T.tickNext=mt:T.tickNext>gt&&(T.tickNext=gt),T.sqrtPriceNextX64=ne.getSqrtPriceX64FromTick(T.tickNext);let K;if(s&&T.sqrtPriceNextX64.lt(y)||!s&&T.sqrtPriceNextX64.gt(y)?K=y:K=T.sqrtPriceNextX64,[g.sqrtPriceX64,T.amountIn,T.amountOut,T.feeAmount]=Gn.swapStepCompute(g.sqrtPriceX64,K,g.liquidity,g.amountSpecifiedRemaining,a,s),g.feeAmount=g.feeAmount.add(T.feeAmount),b?(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.sub(T.amountIn.add(T.feeAmount)),g.amountCalculated=g.amountCalculated.sub(T.amountOut)):(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.add(T.amountOut),g.amountCalculated=g.amountCalculated.add(T.amountIn.add(T.feeAmount))),g.sqrtPriceX64.eq(T.sqrtPriceNextX64)){if(T.initialized){let N=S.liquidityNet;s&&(N=N.mul(bn)),g.liquidity=ye.addDelta(g.liquidity,N)}x=T.tickNext!=g.tick&&!s&&k.startTickIndex===T.tickNext,g.tick=s?T.tickNext-1:T.tickNext}else if(g.sqrtPriceX64!=T.sqrtPriceStartX64){let N=ne.getTickFromSqrtPriceX64(g.sqrtPriceX64);x=N!=g.tick&&!s&&k.startTickIndex===N,g.tick=N}++h}try{let{nextStartIndex:T,isExist:B}=be.nextInitializedTickArray(g.tick,l,s,o,i);B&&p!==T&&(g.accounts.push(fe(e,t,T).publicKey),p=T)}catch{}return{allTrade:!0,amountSpecifiedRemaining:pe,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts}}static swapStepCompute(e,t,n,o,i,s){let a={sqrtPriceX64Next:new le(0),amountIn:new le(0),amountOut:new le(0),feeAmount:new le(0)},c=o.gte(pe);if(c){let l=ae.mulDivFloor(o,Br.sub(new le(i.toString())),Br);a.amountIn=s?ye.getTokenAmountAFromLiquidity(t,e,n,!0):ye.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(a.amountIn)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=ne.getNextSqrtPriceX64FromInput(e,n,l,s)}else a.amountOut=s?ye.getTokenAmountBFromLiquidity(t,e,n,!1):ye.getTokenAmountAFromLiquidity(e,t,n,!1),o.mul(bn).gte(a.amountOut)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=ne.getNextSqrtPriceX64FromOutput(e,n,o.mul(bn),s);let u=t.eq(a.sqrtPriceX64Next);return s?(u&&c||(a.amountIn=ye.getTokenAmountAFromLiquidity(a.sqrtPriceX64Next,e,n,!0)),u&&!c||(a.amountOut=ye.getTokenAmountBFromLiquidity(a.sqrtPriceX64Next,e,n,!1))):(a.amountIn=u&&c?a.amountIn:ye.getTokenAmountBFromLiquidity(e,a.sqrtPriceX64Next,n,!0),a.amountOut=u&&!c?a.amountOut:ye.getTokenAmountAFromLiquidity(e,a.sqrtPriceX64Next,n,!1)),!c&&a.amountOut.gt(o.mul(bn))&&(a.amountOut=o.mul(bn)),c&&!a.sqrtPriceX64Next.eq(t)?a.feeAmount=o.sub(a.amountIn):a.feeAmount=ae.mulDivCeil(a.amountIn,new le(i),Br.sub(new le(i))),[a.sqrtPriceX64Next,a.amountIn,a.amountOut,a.feeAmount]}};var He=60,Un=512,H=class{static getTickArrayAddressByTick(e,t,n,o){let i=H.getTickArrayStartIndexByTick(n,o),{publicKey:s}=fe(e,t,i);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=H.getTickArrayStartIndexByTick(e,t),o=Math.floor((e-n)/t);if(o<0||o>=He)throw new Error("tick offset in array overflow");return o}static getTickArrayBitIndex(e,t){let n=be.tickCount(t),o=e/n;return e<0&&e%n!=0?o=Math.ceil(o)-1:o=Math.floor(o),o}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*be.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*He,o=Math.floor(e/n)+512;return Math.abs(o)}static checkTickArrayIsInitialized(e,t,n){let o=n*He,i=Math.floor(t/o)+512,s=Math.abs(i);return{isInitialized:e.testn(s),startIndex:(s-512)*o}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*He:e+t*He}static mergeTickArrayBitmap(e){let t=new qp(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,o,i){let s=Math.floor(o/(n*He));return[...H.searchLowBitFromStart(e,t,s-1,i,n),...H.searchHightBitFromStart(e,t,s,i,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return H.searchHightBitFromStart(e,t,-7680,Un,n)}static getAllInitializedTickArrayInfo(e,t,n,o,i){let s=[],a=H.getAllInitializedTickArrayStartIndex(n,o,i);for(let c of a){let{publicKey:u}=fe(e,t,c);s.push({tickArrayStartIndex:c,tickArrayAddress:u})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,o,i){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>H.mergeTickArrayBitmap(u)),a=[];for(;n>=-7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n--,a.length===o)break}let c=be.tickCount(i);return a.map(u=>u*c)}static searchHightBitFromStart(e,t,n,o,i){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>H.mergeTickArrayBitmap(u)),a=[];for(;n<7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n++,a.length===o)break}let c=be.tickCount(i);return a.map(u=>u*c)}static checkIsOutOfBoundary(e){return e<mt||e>gt}static nextInitTick(e,t,n,o,i){if(be.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(o)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(i||(a=a+1);a<He;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=He-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<He;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let o=ne.getSqrtPriceX64FromTick(t),i=ne.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:i,tickSqrtPriceX64:o}:{tick:t,price:new C(1).div(i),tickSqrtPriceX64:o}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let o=n?t:new C(1).div(t),i=Qn.getTickWithPriceAndTickspacing(o,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=ne.getSqrtPriceX64FromTick(i),a=ne.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:i,price:a}:{tick:i,price:new C(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let o=ne.getSqrtPriceX64FromTick(t),i=ne.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:i,tickSqrtPriceX64:o}:{tick:t,price:new C(1).div(i),tickSqrtPriceX64:o}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let o=n?t:new C(1).div(t),i=Qn.getTickWithPriceAndTickspacing(o,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=ne.getSqrtPriceX64FromTick(i),a=ne.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:i,price:a}:{tick:i,price:new C(1).div(a)}}};var Oc=O([we(8),F("bump"),Ht("index"),L(""),ot("protocolFeeRate"),ot("tradeFeeRate"),Ht("tickSpacing"),Q(A(),8,"")]),Up=O([ot("blockTimestamp"),fo("tickCumulative"),Q(A(),4)]),vc=O([we(8),Ee("initialized"),A("recentEpoch"),Ht("observationIndex"),L("poolId"),Q(Up,100,"observations"),Q(A(),4)]),Gp=O([F("rewardState"),A("openTime"),A("endTime"),A("lastUpdateTime"),J("emissionsPerSecondX64"),A("rewardTotalEmissioned"),A("rewardClaimed"),L("tokenMint"),L("tokenVault"),L("creator"),J("rewardGrowthGlobalX64")]),Xn=O([we(8),F("bump"),L("ammConfig"),L("creator"),L("mintA"),L("mintB"),L("vaultA"),L("vaultB"),L("observationId"),F("mintDecimalsA"),F("mintDecimalsB"),Ht("tickSpacing"),J("liquidity"),J("sqrtPriceX64"),Ne("tickCurrent"),ot(),J("feeGrowthGlobalX64A"),J("feeGrowthGlobalX64B"),A("protocolFeesTokenA"),A("protocolFeesTokenB"),J("swapInAmountTokenA"),J("swapOutAmountTokenB"),J("swapInAmountTokenB"),J("swapOutAmountTokenA"),F("status"),Q(F(),7,""),Q(Gp,3,"rewardInfos"),Q(A(),16,"tickArrayBitmap"),A("totalFeesTokenA"),A("totalFeesClaimedTokenA"),A("totalFeesTokenB"),A("totalFeesClaimedTokenB"),A("fundFeesTokenA"),A("fundFeesTokenB"),A("startTime"),Q(A(),15*4-3,"padding")]),Xp=O([J("growthInsideLastX64"),A("rewardAmountOwed")]),di=O([we(8),F("bump"),L("nftMint"),L("poolId"),Ne("tickLower"),Ne("tickUpper"),J("liquidity"),J("feeGrowthInsideLastX64A"),J("feeGrowthInsideLastX64B"),A("tokenFeesOwedA"),A("tokenFeesOwedB"),Q(Xp,3,"rewardInfos"),Q(A(),8,"")]),kT=O([we(8),F("bump"),L("poolId"),Ne("tickLowerIndex"),Ne("tickUpperIndex"),J("liquidity"),J("feeGrowthInsideLastX64A"),J("feeGrowthInsideLastX64B"),A("tokenFeesOwedA"),A("tokenFeesOwedB"),Q(J(),3,"rewardGrowthInside"),Q(A(),8,"")]),Qp=O([Ne("tick"),Hu("liquidityNet"),J("liquidityGross"),J("feeGrowthOutsideX64A"),J("feeGrowthOutsideX64B"),Q(J(),3,"rewardGrowthsOutsideX64"),Q(ot(),13,"")]),li=O([we(8),L("poolId"),Ne("startTickIndex"),Q(Qp,He,"ticks"),F("initializedTickCount"),Q(F(),115,"")]),Mc=O([we(329),Q(L(),100,"whitelistMints")]),Nc=O([we(8),L("poolId"),Q(Q(A(),8),la,"positiveTickArrayBitmap"),Q(Q(A(),8),la,"negativeTickArrayBitmap")]),hT=O([A(),F("bump"),L("owner"),L("poolId"),L("positionId"),L("nftAccount"),Q(A(),8)]),TT=O([we(8),F("bump"),L("lockOwner"),L("poolId"),L("positionId"),L("nftAccount"),L("lockNftMint"),A("recentEpoch"),Q(A(),8)]);vc.span;var Ec=me("Raydium_Clmm"),Nt={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],openPositionWithTokenEx:[77,255,174,82,125,29,201,46],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},_c=[188,37,179,131,82,150,84,73],Fc=[16,72,250,198,14,162,212,19],Be=class{static createPoolInstruction(e,t,n,o,i,s,a,c,u,l,d,m,p,y){let f=O([J("sqrtPriceX64"),A("zero")]),b=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:An.programId,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1},...y?.map(k=>({pubkey:k,isSigner:!1,isWritable:!1}))||[]],g=Buffer.alloc(f.span);f.encode({sqrtPriceX64:p,zero:pe},g);let w=Buffer.from([...Nt.createPool,...g]);return new it({keys:b,programId:e,data:w})}static async createPoolInstructions(e){let{programId:t,owner:n,mintA:o,mintB:i,ammConfigId:s,initialPriceX64:a,extendMintAccount:c}=e,[u,l]=[new U(o.address),new U(i.address)],{publicKey:d}=xc(t,s,u,l),{publicKey:m}=Kc(t,d),{publicKey:p}=aa(t,d,u),{publicKey:y}=aa(t,d,l),f=De(t,d).publicKey,b=[this.createPoolInstruction(t,d,n,s,m,u,p,new U(o.programId||Ie),l,y,new U(i.programId||Ie),f,a,c)];return{signers:[],instructions:b,instructionTypes:[V.CreateAccount,V.ClmmCreatePool],address:{poolId:d,observationId:m,exBitmapAccount:f,mintAVault:p,mintBVault:y},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I,K){let N=O([Ne("tickLowerIndex"),Ne("tickUpperIndex"),Ne("tickArrayLowerStartIndex"),Ne("tickArrayUpperStartIndex"),J("liquidity"),A("amountMaxA"),A("amountMaxB"),Ee("withMetadata"),F("optionBaseFlag"),Ee("baseFlag")]),v=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],_=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:An.programId,isSigner:!1,isWritable:!1},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:pi,isSigner:!1,isWritable:!1},{pubkey:qt,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...v],D=Buffer.alloc(N.span);N.encode({tickLowerIndex:w,tickUpperIndex:k,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:x,liquidity:T,amountMaxA:B,amountMaxB:S,withMetadata:I==="create",baseFlag:!1,optionBaseFlag:0},D);let q=Buffer.from([...Nt.openPosition,...D]);return new it({keys:_,programId:e,data:q})}static openPositionFromLiquidityInstruction22(e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I){let K=O([Ne("tickLowerIndex"),Ne("tickUpperIndex"),Ne("tickArrayLowerStartIndex"),Ne("tickArrayUpperStartIndex"),J("liquidity"),A("amountMaxA"),A("amountMaxB"),Ee("withMetadata"),F("optionBaseFlag"),Ee("baseFlag")]),N=[...I?[{pubkey:I,isSigner:!1,isWritable:!0}]:[]],v=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:An.programId,isSigner:!1,isWritable:!1},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:pi,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...N],_=Buffer.alloc(K.span);K.encode({tickLowerIndex:g,tickUpperIndex:w,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:h,liquidity:x,amountMaxA:T,amountMaxB:B,withMetadata:S==="create",baseFlag:!1,optionBaseFlag:0},_);let D=Buffer.from([...Nt.openPositionWithTokenEx,..._]);return new it({keys:v,programId:e,data:D})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:i,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:d}){let m=[],[p,y]=[new U(e.programId),new U(e.id)],f;if(l)f=new U((await l(1))[0]);else{let I=Kr.generate();m.push(I),f=I.publicKey}let b=H.getTickArrayStartIndexByTick(o,e.config.tickSpacing),g=H.getTickArrayStartIndexByTick(i,e.config.tickSpacing),{publicKey:w}=fe(p,y,b),{publicKey:k}=fe(p,y,g),{publicKey:h}=d?Z(n.wallet,f,Fe):Z(n.wallet,f,Ie),{publicKey:x}=gn(f),{publicKey:T}=Pt(p,f),{publicKey:B}=Zt(p,y,o,i),S=d?this.openPositionFromLiquidityInstruction22(p,n.feePayer,y,n.wallet,f,h,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),o,i,b,g,s,a,c,u,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?De(p,y).publicKey:void 0):this.openPositionFromLiquidityInstruction(p,n.feePayer,y,n.wallet,f,h,x,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),o,i,b,g,s,a,c,u,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?De(p,y).publicKey:void 0);return{signers:m,instructions:[S],instructionTypes:[V.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:f,tickArrayLower:w,tickArrayUpper:k,positionNftAccount:h,metadataAccount:x,personalPosition:T,protocolPosition:B}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:i,base:s,baseAmount:a,otherAmountMax:c,withMetadata:u,getEphemeralSigners:l,nft2022:d}){let m=[],[p,y]=[new U(e.programId),new U(e.id)],f;if(l)f=new U((await l(1))[0]);else{let I=Kr.generate();m.push(I),f=I.publicKey}let b=H.getTickArrayStartIndexByTick(o,e.config.tickSpacing),g=H.getTickArrayStartIndexByTick(i,e.config.tickSpacing),{publicKey:w}=fe(p,y,b),{publicKey:k}=fe(p,y,g),{publicKey:h}=d?Z(n.wallet,f,Fe):Z(n.wallet,f,Ie),{publicKey:x}=gn(f),{publicKey:T}=Pt(p,f),{publicKey:B}=Zt(p,y,o,i),S=d?this.openPositionFromBaseInstruction22(p,n.feePayer,y,n.wallet,f,h,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),o,i,b,g,u,s,a,c,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?De(p,y).publicKey:void 0):this.openPositionFromBaseInstruction(p,n.feePayer,y,n.wallet,f,h,x,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),o,i,b,g,u,s,a,c,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?De(p,y).publicKey:void 0);return{address:{nftMint:f,tickArrayLower:w,tickArrayUpper:k,positionNftAccount:h,metadataAccount:x,personalPosition:T,protocolPosition:B},instructions:[S],signers:m,instructionTypes:[V.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I,K){let N=O([Ne("tickLowerIndex"),Ne("tickUpperIndex"),Ne("tickArrayLowerStartIndex"),Ne("tickArrayUpperStartIndex"),J("liquidity"),A("amountMaxA"),A("amountMaxB"),Ee("withMetadata"),F("optionBaseFlag"),Ee("baseFlag")]),v=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],_=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:An.programId,isSigner:!1,isWritable:!1},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:pi,isSigner:!1,isWritable:!1},{pubkey:qt,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...v],D=Buffer.alloc(N.span);N.encode({tickLowerIndex:w,tickUpperIndex:k,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:x,liquidity:new pa(0),amountMaxA:B==="MintA"?S:I,amountMaxB:B==="MintA"?I:S,withMetadata:T==="create",baseFlag:B==="MintA",optionBaseFlag:1},D);let q=Buffer.from([...Nt.openPosition,...D]);return new it({keys:_,programId:e,data:q})}static openPositionFromBaseInstruction22(e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I){let K=O([Ne("tickLowerIndex"),Ne("tickUpperIndex"),Ne("tickArrayLowerStartIndex"),Ne("tickArrayUpperStartIndex"),J("liquidity"),A("amountMaxA"),A("amountMaxB"),Ee("withMetadata"),F("optionBaseFlag"),Ee("baseFlag")]),N=[...I?[{pubkey:I,isSigner:!1,isWritable:!0}]:[]],v=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:An.programId,isSigner:!1,isWritable:!1},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:pi,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...N],_=Buffer.alloc(K.span);K.encode({tickLowerIndex:g,tickUpperIndex:w,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:h,liquidity:new pa(0),amountMaxA:T==="MintA"?B:S,amountMaxB:T==="MintA"?S:B,withMetadata:x==="create",baseFlag:T==="MintA",optionBaseFlag:1},_);let D=Buffer.from([...Nt.openPositionWithTokenEx,..._]);return new it({keys:v,programId:e,data:D})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:i,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:d}){let m,p=[];if(l)m=new U((await l(1))[0]);else{let I=Kr.generate();p.push(I),m=I.publicKey}let[y,f]=[new U(e.programId),new U(e.id)],b=H.getTickArrayStartIndexByTick(o,e.config.tickSpacing),g=H.getTickArrayStartIndexByTick(i,e.config.tickSpacing),{publicKey:w}=fe(y,f,b),{publicKey:k}=fe(y,f,g),{publicKey:h}=d?Z(n.wallet,m,Fe):Z(n.wallet,m,Ie),{publicKey:x}=gn(m),{publicKey:T}=Pt(y,m),{publicKey:B}=Zt(y,f,o,i),S=d?this.openPositionFromLiquidityInstruction22(y,n.wallet,f,n.wallet,m,h,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(t.mintA.address),new U(t.mintB.address),o,i,b,g,s,a,c,u,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?De(y,f).publicKey:void 0):this.openPositionFromLiquidityInstruction(y,n.wallet,f,n.wallet,m,h,x,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(t.mintA.address),new U(t.mintB.address),o,i,b,g,s,a,c,u,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?De(y,f).publicKey:void 0);return{address:{nftMint:m,tickArrayLower:w,tickArrayUpper:k,positionNftAccount:h,metadataAccount:x,personalPosition:T,protocolPosition:B},instructions:[S],signers:p,instructionTypes:[V.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,o,i,s){let a=O([]),c=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:An.programId,isSigner:!1,isWritable:!1},{pubkey:s?Fe:Ie,isSigner:!1,isWritable:!1}],u=Buffer.alloc(a.span);a.encode({},u);let l=Buffer.from([...Nt.closePosition,...u]);return new it({keys:c,programId:e,data:l})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:o,nft2022:i}){let s=new U(e.programId),a=i?Z(n.wallet,o.nftMint,Fe).publicKey:Z(n.wallet,o.nftMint,Ie).publicKey,{publicKey:c}=Pt(s,o.nftMint),u=[];return u.push(this.closePositionInstruction(s,n.wallet,o.nftMint,a,c,i)),{address:{positionNftAccount:a,personalPosition:c},signers:[],instructions:u,instructionTypes:[V.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g,w){let k=O([J("liquidity"),A("amountMaxA"),A("amountMaxB"),F("optionBaseFlag"),Ee("baseFlag")]),h=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[]],x=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...h],T=Buffer.alloc(k.span);k.encode({liquidity:f,amountMaxA:b,amountMaxB:g,optionBaseFlag:0,baseFlag:!1},T);let B=Buffer.from([...Nt.increaseLiquidity,...T]);return new it({keys:x,programId:e,data:B})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,liquidity:i,amountMaxA:s,amountMaxB:a,nft2022:c}){let[u,l]=[new U(e.programId),new U(e.id)],d=H.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=H.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=fe(u,l,d),{publicKey:y}=fe(u,l,m),{publicKey:f}=c?Z(o.wallet,n.nftMint,Fe):Z(o.wallet,n.nftMint,Ie),{publicKey:b}=Pt(u,n.nftMint),{publicKey:g}=Zt(u,l,n.tickLower,n.tickUpper),w=this.increasePositionFromLiquidityInstruction(u,o.wallet,f,b,l,g,p,y,o.tokenAccountA,o.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),i,s,a,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[d,m])?De(u,l).publicKey:void 0);return{address:{tickArrayLower:p,tickArrayUpper:y,positionNftAccount:f,personalPosition:b,protocolPosition:g},signers:[],instructions:[w],instructionTypes:[V.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,base:i,baseAmount:s,otherAmountMax:a,nft2022:c}){let[u,l]=[new U(e.programId),new U(e.id)],d=H.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=H.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=fe(u,l,d),{publicKey:y}=fe(u,l,m),{publicKey:f}=c?Z(o.wallet,n.nftMint,Fe):Z(o.wallet,n.nftMint,Ie),{publicKey:b}=Pt(u,n.nftMint),{publicKey:g}=Zt(u,l,n.tickLower,n.tickUpper);return{address:{tickArrayLower:p,tickArrayUpper:y,positionNftAccount:f,personalPosition:b,protocolPosition:g},instructions:[this.increasePositionFromBaseInstruction(u,o.wallet,f,b,l,g,p,y,o.tokenAccountA,o.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),i,s,a,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[d,m])?De(u,l).publicKey:void 0)],signers:[],instructionTypes:[V.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g,w){let k=O([J("liquidity"),A("amountMaxA"),A("amountMaxB"),F("optionBaseFlag"),Ee("baseFlag")]),h=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[]],x=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...h],T=Buffer.alloc(k.span);k.encode({liquidity:new pa(0),amountMaxA:f==="MintA"?b:g,amountMaxB:f==="MintA"?g:b,baseFlag:f==="MintA",optionBaseFlag:1},T);let B=Buffer.from([...Nt.increaseLiquidity,...T]);return new it({keys:x,programId:e,data:B})}static decreaseLiquidityInstruction(e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g,w,k){let h=O([J("liquidity"),A("amountMinA"),A("amountMinB")]),x=[...k?[{pubkey:k,isSigner:!1,isWritable:!0}]:[],...f.map(I=>[{pubkey:I.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:I.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:I.rewardMint,isSigner:!1,isWritable:!1}]).flat()],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:Hi,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...x],B=Buffer.alloc(h.span);h.encode({liquidity:b,amountMinA:g,amountMinB:w},B);let S=Buffer.from([...Nt.decreaseLiquidity,...B]);return new it({keys:T,programId:e,data:S})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,liquidity:i,amountMinA:s,amountMinB:a,programId:c,nft2022:u}){let[l,d]=[new U(e.programId),new U(e.id)],m=H.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),p=H.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:y}=fe(l,d,m),{publicKey:f}=fe(l,d,p),{publicKey:b}=u?Z(o.wallet,n.nftMint,Fe):Z(o.wallet,n.nftMint,c),{publicKey:g}=Pt(l,n.nftMint),{publicKey:w}=Zt(l,d,n.tickLower,n.tickUpper),k=[];for(let T=0;T<e.rewardDefaultInfos.length;T++)k.push({poolRewardVault:new U(t.rewardInfos[T].vault),ownerRewardVault:o.rewardAccounts[T],rewardMint:new U(e.rewardDefaultInfos[T].mint.address)});let h=[],x=this.decreaseLiquidityInstruction(l,o.wallet,b,g,d,w,y,f,o.tokenAccountA,o.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),k,i,s,a,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,p])?De(l,d).publicKey:void 0);return h.push(x),{address:{tickArrayLower:y,tickArrayUpper:f,positionNftAccount:b,personalPosition:g,protocolPosition:w},signers:[],instructions:h,instructionTypes:[V.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g){let w=O([A("amount"),A("otherAmountThreshold"),J("sqrtPriceLimitX64"),Ee("isBaseInput")]),k=[...g?[{pubkey:g,isSigner:!1,isWritable:!0}]:[],...d.map(B=>({pubkey:B,isSigner:!1,isWritable:!0}))],h=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:Hi,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...k],x=Buffer.alloc(w.span);w.encode({amount:p,otherAmountThreshold:y,sqrtPriceLimitX64:f,isBaseInput:b},x);let T=Buffer.from([...Nt.swap,...x]);return new it({keys:h,programId:e,data:T})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:o,inputMint:i,amountIn:s,amountOutMin:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,d]=[new U(e.programId),new U(e.id)],[m,p]=[new U(t.vault.A),new U(t.vault.B)],[y,f]=[new U(e.mintA.address),new U(e.mintB.address)],b=e.mintA.address===i.toString(),g=[this.swapInstruction(l,o.wallet,d,new U(e.config.id),b?o.tokenAccountA:o.tokenAccountB,b?o.tokenAccountB:o.tokenAccountA,b?m:p,b?p:m,b?y:f,b?f:y,u,n,s,a,c,!0,De(l,d).publicKey)];return{signers:[],instructions:g,instructionTypes:[V.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static makeSwapBaseOutInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:o,outputMint:i,amountOut:s,amountInMax:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,d]=[new U(e.programId),new U(e.id)],[m,p]=[new U(t.vault.A),new U(t.vault.B)],[y,f]=[new U(e.mintA.address),new U(e.mintB.address)],b=e.mintA.address===i.toBase58(),g=[this.swapInstruction(l,o.wallet,d,new U(e.config.id),b?o.tokenAccountB:o.tokenAccountA,b?o.tokenAccountA:o.tokenAccountB,b?p:m,b?m:p,b?f:y,b?y:f,u,n,s,a,c,!1,De(l,d).publicKey)];return{signers:[],instructions:g,instructionTypes:[V.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,o,i,s,a,c,u,l,d,m){let p=O([A("openTime"),A("endTime"),J("emissionsPerSecondX64")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:An.programId,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({openTime:$(l),endTime:$(d),emissionsPerSecondX64:m},f);let b=Buffer.from([...Nt.initReward,...f]);return new it({keys:y,programId:e,data:b})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:o}){let[i,s]=[new U(e.programId),new U(e.id)],a=Sc(i,s,o.mint).publicKey,c=ai(i).publicKey,u=[this.initRewardInstruction(i,n.wallet,s,c,new U(e.config.id),n.tokenAccount,o.programId,o.mint,a,o.openTime,o.endTime,o.emissionsPerSecondX64)];return{address:{poolRewardVault:a,operationId:c},signers:[],instructions:u,instructionTypes:[V.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,o,i,s,a,c,u,l,d,m){let p=O([F("rewardIndex"),J("emissionsPerSecondX64"),A("openTime"),A("endTime")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0}],f=Buffer.alloc(p.span);p.encode({rewardIndex:u,emissionsPerSecondX64:m,openTime:$(l),endTime:$(d)},f);let b=Buffer.from([...Nt.setRewardEmissions,...f]);return new it({keys:y,programId:e,data:b})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:o}){let[i,s]=[new U(e.programId),new U(e.id)],a,c,u;for(let m=0;m<e.rewardDefaultInfos.length;m++)e.rewardDefaultInfos[m].mint.address===o.mint.toString()&&(a=m,c=new U(t.rewardInfos[m].vault),u=new U(t.rewardInfos[m].mint.address));(a===void 0||c===void 0)&&Ec.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=ai(i).publicKey,d=[this.setRewardInstruction(i,n.wallet,s,l,new U(e.config.id),n.tokenAccount,c,u,a,o.openTime,o.endTime,o.emissionsPerSecondX64)];return{address:{rewardVault:c,operationId:l},signers:[],instructions:d,instructionTypes:[V.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,o,i,s,a){let c=O([F("rewardIndex")]),u=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:Hi,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({rewardIndex:a},l);let d=Buffer.from([...Nt.collectReward,...l]);return new it({keys:u,programId:e,data:d})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:o}){let[i,s]=[new U(e.programId),new U(e.id)],a,c;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===o.toString()&&(a=l,c=new U(t.rewardInfos[l].vault));(a===void 0||c===void 0)&&Ec.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let u=[this.collectRewardInstruction(i,n.wallet,s,n.tokenAccount,c,o,a)];return{address:{rewardVault:c},signers:[],instructions:u,instructionTypes:[V.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static async makeLockPositions({programId:e,authProgramId:t,poolProgramId:n,payer:o,wallet:i,nftMint:s,nft2022:a,getEphemeralSigners:c}){let u=[],l;if(c)l=new U((await c(1))[0]);else{let g=Kr.generate();u.push(g),l=g.publicKey}let d=a?Z(i,s,Fe).publicKey:Z(i,s,Ie).publicKey,{publicKey:m}=Pt(n,s),p=ui(e,l).publicKey,y=Z(i,l,Ie).publicKey,f=gn(l).publicKey,b=Be.lockPositionInstructionV2({programId:e,auth:t,payer:o,positionOwner:i,lockOwner:i,positionNftAccount:d,positionId:m,lockPositionId:p,lockNftMint:l,lockNftAccount:y,metadataAccount:f,withMetadata:!0,nft2022:a,positionNftMint:s,authPositionNftAccount:Z(t,s,a?Fe:Ie).publicKey,positionNftProgram:a?Fe:Ie});return{address:{positionId:m,lockPositionId:p,lockNftAccount:y,lockNftMint:l,positionNftAccount:d,metadataAccount:f},instructions:[b],signers:u,instructionTypes:[V.ClmmLockPosition],lookupTableAddress:[]}}static lockPositionInstructionV2({programId:e,auth:t,payer:n,positionOwner:o,lockOwner:i,positionNftAccount:s,positionId:a,positionNftMint:c,authPositionNftAccount:u,positionNftProgram:l,lockPositionId:d,lockNftMint:m,lockNftAccount:p,metadataAccount:y,withMetadata:f}){let b=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!0,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:qt,isSigner:!1,isWritable:!1},{pubkey:pi,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:An.programId,isSigner:!1,isWritable:!1}],g=O([Ee("withMetadata")]),w=Buffer.alloc(g.span);g.encode({withMetadata:f},w);let k=Buffer.from([..._c,...w]);return new it({keys:b,programId:e,data:k})}static lockPositionInstruction({programId:e,authProgramId:t,poolProgramId:n,owner:o,positionNft:i}){let{publicKey:s}=Z(o,i,Ie),{publicKey:a}=Pt(n,i),c=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:ua(e,a).publicKey,isSigner:!1,isWritable:!0},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:An.programId,isSigner:!1,isWritable:!1}];return new it({keys:c,programId:e,data:Buffer.from(_c)})}static harvestLockPositionInstruction(e){let[t,n]=[new U(e.poolKeys.programId),new U(e.poolKeys.id)],o=H.getTickArrayStartIndexByTick(e.ownerPosition.tickLower,e.poolKeys.config.tickSpacing),i=H.getTickArrayStartIndexByTick(e.ownerPosition.tickUpper,e.poolKeys.config.tickSpacing),{publicKey:s}=fe(t,n,o),{publicKey:a}=fe(t,n,i),{publicKey:c}=Z(e.owner,e.ownerPosition.nftMint,Ie),{publicKey:u}=Pt(t,e.ownerPosition.nftMint),{publicKey:l}=Zt(t,n,e.ownerPosition.tickLower,e.ownerPosition.tickUpper),d=[];for(let y=0;y<e.poolKeys.rewardInfos.length;y++)d.push({poolRewardVault:new U(e.poolKeys.rewardInfos[y].vault),ownerRewardVault:e.ownerRewardAccounts[y],rewardMint:new U(e.poolKeys.rewardInfos[y].mint.address)});let m=[...d.map(y=>[{pubkey:y.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:y.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:y.rewardMint,isSigner:!1,isWritable:!1}]).flat()],p=[{pubkey:e.authProgramId,isSigner:!1,isWritable:!1},{pubkey:ua(e.programId,u).publicKey,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e.owner,isSigner:!0,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:new U(e.poolKeys.vault.A),isSigner:!1,isWritable:!0},{pubkey:new U(e.poolKeys.vault.B),isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:e.userVaultA,isSigner:!1,isWritable:!0},{pubkey:e.userVaultB,isSigner:!1,isWritable:!0},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:nn,isSigner:!1,isWritable:!1},{pubkey:new U(e.poolKeys.mintA.address),isSigner:!1,isWritable:!1},{pubkey:new U(e.poolKeys.mintB.address),isSigner:!1,isWritable:!1},...m];return new it({keys:p,programId:e.programId,data:Buffer.from(Fc)})}static harvestLockPositionInstructionV2({programId:e,auth:t,lockPositionId:n,clmmProgram:o,lockOwner:i,lockNftMint:s,lockNftAccount:a,positionNftAccount:c,positionId:u,poolId:l,protocolPosition:d,vaultA:m,vaultB:p,tickArrayLower:y,tickArrayUpper:f,userVaultA:b,userVaultB:g,mintA:w,mintB:k,rewardAccounts:h,exTickArrayBitmap:x}){let T=[...x?[{pubkey:x,isSigner:!1,isWritable:!0}]:[],...h.map(S=>[{pubkey:S.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:S.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:S.rewardMint,isSigner:!1,isWritable:!1}]).flat()],B=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:nn,isSigner:!1,isWritable:!1},{pubkey:w,isSigner:!1,isWritable:!1},{pubkey:k,isSigner:!1,isWritable:!1},...T];return new it({keys:B,programId:e,data:Buffer.from(Fc)})}};var Vc=O([ot("mintAuthorityOption"),L("mintAuthority"),A("supply"),F("decimals"),F("isInitialized"),ot("freezeAuthorityOption"),L("freezeAuthority")]);import{PublicKey as zp}from"@solana/web3.js";import{MintLayout as Wc,TOKEN_PROGRAM_ID as Hp}from"@solana/spl-token";var YT=async({connection:r,mint:e})=>{let t=await r.getAccountInfo(new zp(e));return!t||t.data.length!==Wc.span?void 0:Wc.decode(t.data)},ZT=({mint:r,decimals:e,programId:t=Hp,logoURI:n="",priority:o=3})=>{let i=r.toBase58().substring(0,6);return{address:r.toBase58(),decimals:e,symbol:i,logoURI:n,extensions:{},chainId:101,programId:t.toString(),name:i,tags:[],priority:o}},Cr=r=>new Me({mint:r.address,decimals:r.decimals,symbol:r.symbol,name:r.name}),fi=({amount:r,isRaw:e,name:t,...n})=>new he(new Me({mint:ut(n.address).toBase58(),decimals:n.decimals,symbol:n.symbol,name:t}),r,e,t);function $T(r){return r.address===tn.address?Ze:r}function JT(r){return r.address===Ze.address?tn:r}var dt=({address:r,programId:e,decimals:t,...n})=>({chainId:101,address:ut(r).toBase58(),programId:e,logoURI:"",symbol:"",name:"",decimals:t,tags:[],extensions:n.extensions||{},...n}),vn=r=>r?{...r,transferFeeConfigAuthority:r.transferFeeConfigAuthority.toBase58(),withdrawWithheldAuthority:r.withdrawWithheldAuthority.toBase58(),withheldAmount:r.withheldAmount.toString(),olderTransferFee:{...r.olderTransferFee,epoch:r.olderTransferFee.epoch.toString(),maximumFee:r.olderTransferFee.maximumFee.toString()},newerTransferFee:{...r.newerTransferFee,epoch:r.newerTransferFee.epoch.toString(),maximumFee:r.newerTransferFee.maximumFee.toString()}}:void 0;import Dc from"bn.js";var fa=new Dc(25),Lr=new Dc(1e4),jp={4:3,5:3};import{PublicKey as xe,SystemProgram as jc,SYSVAR_RENT_PUBKEY as lf,TransactionInstruction as wn}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as mf,TOKEN_PROGRAM_ID as ko}from"@solana/spl-token";var ya=O([F("instruction"),A("amountIn"),A("minAmountOut")]),ba=O([F("instruction"),A("maxAmountIn"),A("amountOut")]),lI=O([F("instruction"),F("nonce")]),ga=O([F("instruction"),F("nonce"),A("startTime")]),zn=O([A("status"),A("nonce"),A("maxOrder"),A("depth"),A("baseDecimal"),A("quoteDecimal"),A("state"),A("resetFlag"),A("minSize"),A("volMaxCutRatio"),A("amountWaveRatio"),A("baseLotSize"),A("quoteLotSize"),A("minPriceMultiplier"),A("maxPriceMultiplier"),A("systemDecimalValue"),A("minSeparateNumerator"),A("minSeparateDenominator"),A("tradeFeeNumerator"),A("tradeFeeDenominator"),A("pnlNumerator"),A("pnlDenominator"),A("swapFeeNumerator"),A("swapFeeDenominator"),A("baseNeedTakePnl"),A("quoteNeedTakePnl"),A("quoteTotalPnl"),A("baseTotalPnl"),A("poolOpenTime"),A("punishPcAmount"),A("punishCoinAmount"),A("orderbookToInitTime"),J("swapBaseInAmount"),J("swapQuoteOutAmount"),A("swapBase2QuoteFee"),J("swapQuoteInAmount"),J("swapBaseOutAmount"),A("swapQuote2BaseFee"),L("baseVault"),L("quoteVault"),L("baseMint"),L("quoteMint"),L("lpMint"),L("openOrders"),L("marketId"),L("marketProgramId"),L("targetOrders"),L("withdrawQueue"),L("lpVault"),L("owner"),A("lpReserve"),Q(A(),3,"padding")]),Yp=O([A("accountType"),A("status"),A("nonce"),A("maxOrder"),A("depth"),A("baseDecimal"),A("quoteDecimal"),A("state"),A("resetFlag"),A("minSize"),A("volMaxCutRatio"),A("amountWaveRatio"),A("baseLotSize"),A("quoteLotSize"),A("minPriceMultiplier"),A("maxPriceMultiplier"),A("systemDecimalsValue"),A("abortTradeFactor"),A("priceTickMultiplier"),A("priceTick"),A("minSeparateNumerator"),A("minSeparateDenominator"),A("tradeFeeNumerator"),A("tradeFeeDenominator"),A("pnlNumerator"),A("pnlDenominator"),A("swapFeeNumerator"),A("swapFeeDenominator"),A("baseNeedTakePnl"),A("quoteNeedTakePnl"),A("quoteTotalPnl"),A("baseTotalPnl"),A("poolOpenTime"),A("punishPcAmount"),A("punishCoinAmount"),A("orderbookToInitTime"),J("swapBaseInAmount"),J("swapQuoteOutAmount"),J("swapQuoteInAmount"),J("swapBaseOutAmount"),A("swapQuote2BaseFee"),A("swapBase2QuoteFee"),L("baseVault"),L("quoteVault"),L("baseMint"),L("quoteMint"),L("lpMint"),L("modelDataAccount"),L("openOrders"),L("marketId"),L("marketProgramId"),L("targetOrders"),L("owner"),Q(A(),64,"padding")]),Pa=O([F("instruction"),A("baseAmountIn"),A("quoteAmountIn"),A("fixedSide"),A("otherAmountMin")]),Aa=O([F("instruction"),A("lpAmount"),A("baseAmountMin"),A("quoteAmountMin")]),mI={4:zn,5:Yp},qc=O([A("fee")]);import{PublicKey as Zp}from"@solana/web3.js";var wo=new Zp("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),jn=5e4,$p=O([A("x"),A("y"),A("price")]),Jp=O([A("accountType"),A("status"),A("multiplier"),A("validDataCount"),Q($p,jn,"DataElement")]);function ef(r,e){return[0,jn-2]}function tf(r){return[0,jn-2]}function nf(r){return[0,jn-2]}function of(r,e,t){let[n,o]=ef(e,t),i=n,s=o,a=0,c=e*r.multiplier/t;for(;i<=s;){if(a=Math.floor((s+i)/2),a===0||a>=jn-2)return[a,a,!1];let u=r.DataElement[a].x*r.multiplier/r.DataElement[a].y,l=r.DataElement[a-1].x*r.multiplier/r.DataElement[a-1].y,d=r.DataElement[a+1].x*r.multiplier/r.DataElement[a+1].y;if(c===u)return[a,a,!0];if(c===l)return[a-1,a-1,!0];if(c===d)return[a+1,a+1,!0];if(c<l)s=a-1;else{if(c>l&&c<u)return[a-1,a,!0];if(c>u&&c<d)return[a,a+1,!0];i=a+1}}return[a,a,!1]}function wa(r,e,t){let[n,o,i]=of(r,e,t);if(!i)return 0;if(n===o){let s=r.DataElement[n].x;return e*r.multiplier/s}else{let s=r.DataElement[n].x,a=r.DataElement[n].y,c=r.DataElement[o].x,u=r.DataElement[o].y,l=t*(c*a-s*u),d=s*l,m=(c-s)*(e*a-s*t)*u,p=d+m;return e*r.multiplier*l/p}}function Hn(r,e,t){return e*r.multiplier/t}function Uc(r,e,t){return e*t/r.multiplier}function rf(r,e){let[t,n]=tf(e),o=t,i=n,s=0,a=e;for(;o<i;){if(s=Math.floor((i+o)/2),s<=0||s>jn-2)return[s,s,!1];let c=r.DataElement[s].x,u=r.DataElement[s-1].x,l=r.DataElement[s+1].x;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<u)i=s-1;else{if(a>u&&a<c)return[s-1,s,!0];if(a>c&&a<l)return[s,s+1,!0];o=s+1}}return[s,s,!1]}function sf(r,e){let[t,n]=nf(e),o=t,i=n,s=0,a=e;for(;o<=i;){if(s=Math.floor((i+o)/2),s<=0||s>=jn-2)return[s,s,!1];let c=r.DataElement[s].y,u=r.DataElement[s-1].y,l=r.DataElement[s+1].y;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<l)o=s+1;else{if(a<u&&a>c)return[s-1,s,!0];if(a<c&&a>l)return[s,s+1,!0];i=s-1}}return[s,s,!1]}function Gc(r,e,t,n){let o=n?e+t:e-t,[i,s,a]=rf(r,o);if(!a)return[0,0,!1,a];if(i===s)return[r.DataElement[s].price,r.DataElement[s].y,!1,a];{let c=r.DataElement[i].x,u=r.DataElement[s].x,l=r.DataElement[i].price,d=r.DataElement[s].price,m=r.DataElement[i].y,p=r.DataElement[s].y;if(e>=c&&e<=u)return n?[d,p,!0,a]:[l,m,!0,a];{let y,f;return n?(y=l+(d-l)*(e-c)/(u-c),f=m-(o-c)*r.multiplier/d):(y=l+(d-l)*(e-c)/(u-c),f=p+(u-o)*r.multiplier/l),[y,f,!1,a]}}}function af(r,e,t,n){let o=n?e-t:e+t,[i,s,a]=sf(r,o);if(!a)return[0,0,!1,a];if(i===s)return[r.DataElement[s].price,r.DataElement[s].x,!1,a];{let c=r.DataElement[i].x,u=r.DataElement[s].x,l=r.DataElement[i].price,d=r.DataElement[s].price,m=r.DataElement[i].y,p=r.DataElement[s].y;if(e>=p&&e<=m)return n?[d,u,!0,a]:[l,c,!0,a];{let y,f;return n?(y=l+(d-l)*(m-e)/(m-p),f=c+d*(m-o)/r.multiplier):(y=l+(d-l)*(m-e)/(m-p),f=u-l*(o-p)/r.multiplier),[y,f,!1,a]}}}function uf(r,e){let t=Gc(r,e,0,!1);return t[3]?t[0]:0}function Xc(r,e,t,n){let o=wa(r,e,t),i=Hn(r,e,o),s=Hn(r,t,o),a=Hn(r,n,o),c=!0,[u,l,d,m]=Gc(r,i,a,c);if(!m)return 0;if(d)return n*r.multiplier/u;{let p=s-l;return Uc(r,p,o)}}function Qc(r,e,t,n){let o=wa(r,e,t),i=Hn(r,e,o),s=Hn(r,t,o),a=Hn(r,n,o),c=!1,[u,l,d,m]=af(r,s,a,c);if(!m)return 0;if(d)return n*u/r.multiplier;{let p=i-l;return Uc(r,p,o)}}function cf(r){let e=Jp.decode(r);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function zc(r,e,t,n){let o=uf(r,Hn(r,e,wa(r,e,t)))/r.multiplier;return n?o:1/o}var Ao=class{connection;_layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};constructor({connection:e}){this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(wo);e&&(this._layoutData=cf(e?.data))}}};var Hc=me("Raydium_liquidity_instruction");function Yc(r){let{poolInfo:e,poolKeys:t,userKeys:n,baseAmountIn:o,quoteAmountIn:i,fixedSide:s,otherAmountMin:a}=r,c=Buffer.alloc(Pa.span);Pa.encode({instruction:3,baseAmountIn:$(o),quoteAmountIn:$(i),otherAmountMin:$(a),fixedSide:s==="base"?ht:Pu},c);let u=[P({pubkey:ko,isWritable:!1}),P({pubkey:new xe(e.id)}),P({pubkey:new xe(t.authority),isWritable:!1}),P({pubkey:new xe(t.openOrders),isWritable:!1}),P({pubkey:new xe(t.targetOrders)}),P({pubkey:new xe(e.lpMint.address)}),P({pubkey:new xe(t.vault.A)}),P({pubkey:new xe(t.vault.B)})];return e.pooltype.includes("StablePool")&&u.push(P({pubkey:wo})),u.push(P({pubkey:new xe(e.marketId),isWritable:!1}),P({pubkey:n.baseTokenAccount}),P({pubkey:n.quoteTokenAccount}),P({pubkey:n.lpTokenAccount}),P({pubkey:n.owner,isWritable:!1,isSigner:!0}),P({pubkey:new xe(t.marketEventQueue),isWritable:!1})),new wn({programId:new xe(e.programId),keys:u,data:c})}function ka(r){let{poolInfo:e,poolKeys:t,userKeys:n,lpAmount:o,baseAmountMin:i,quoteAmountMin:s}=r,a=Le(t),c=4;if(e.pooltype.includes("StablePool")&&(c=5),c===4||c===5){let u=Buffer.alloc(Aa.span);Aa.encode({instruction:4,lpAmount:$(o),baseAmountMin:$(i),quoteAmountMin:$(s)},u);let l=[P({pubkey:ko,isWritable:!1}),P({pubkey:a.id}),P({pubkey:a.authority,isWritable:!1}),P({pubkey:a.openOrders}),P({pubkey:a.targetOrders}),P({pubkey:a.mintLp.address}),P({pubkey:a.vault.A}),P({pubkey:a.vault.B})];return c===5?l.push(P({pubkey:wo})):(l.push(P({pubkey:a.id})),l.push(P({pubkey:a.id}))),l.push(P({pubkey:a.marketProgramId,isWritable:!1}),P({pubkey:a.marketId}),P({pubkey:a.marketBaseVault}),P({pubkey:a.marketQuoteVault}),P({pubkey:a.marketAuthority,isWritable:!1}),P({pubkey:n.lpTokenAccount}),P({pubkey:n.baseTokenAccount}),P({pubkey:n.quoteTokenAccount}),P({pubkey:n.owner,isWritable:!1,isSigner:!0}),P({pubkey:a.marketEventQueue}),P({pubkey:a.marketBids}),P({pubkey:a.marketAsks})),new wn({programId:a.programId,keys:l,data:u})}return new wn({programId:a.programId,keys:[]})}function ha({programId:r,ammId:e,ammAuthority:t,ammOpenOrders:n,lpMint:o,coinMint:i,pcMint:s,coinVault:a,pcVault:c,withdrawQueue:u,ammTargetOrders:l,poolTempLp:d,marketProgramId:m,marketId:p,userWallet:y,userCoinVault:f,userPcVault:b,userLpVault:g,nonce:w,openTime:k,coinAmount:h,pcAmount:x,ammConfigId:T,feeDestinationId:B}){let S=O([F("instruction"),F("nonce"),A("openTime"),A("pcAmount"),A("coinAmount")]),I=[{pubkey:ko,isSigner:!1,isWritable:!1},{pubkey:mf,isSigner:!1,isWritable:!1},{pubkey:jc.programId,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:T,isSigner:!1,isWritable:!1},{pubkey:B,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!0,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0}],K=Buffer.alloc(S.span);return S.encode({instruction:1,nonce:w,openTime:k,coinAmount:h,pcAmount:x},K),{instruction:new wn({keys:I,programId:r,data:K}),instructionType:V.AmmV4CreatePool}}function SI(r){let e=O([F("instruction"),F("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[P({pubkey:new xe(r.id),isWritable:!1}),P({pubkey:new xe(r.authority),isWritable:!1}),P({pubkey:new xe(r.openOrders),isWritable:!1}),P({pubkey:new xe(r.vault.A),isWritable:!1}),P({pubkey:new xe(r.vault.B),isWritable:!1}),P({pubkey:new xe(r.mintLp.address),isWritable:!1}),P({pubkey:new xe(r.marketId),isWritable:!1}),P({pubkey:new xe(r.marketEventQueue),isWritable:!1})];return new wn({programId:new xe(r.programId),keys:n,data:t})}function df({poolKeys:r,userKeys:e,amountIn:t,minAmountOut:n},o){let i=Le(r),s=Buffer.alloc(ya.span);ya.encode({instruction:9,amountIn:$(t),minAmountOut:$(n)},s);let a=[P({pubkey:ko,isWritable:!1}),P({pubkey:i.id}),P({pubkey:i.authority,isWritable:!1}),P({pubkey:i.openOrders})];return o===4&&a.push(P({pubkey:i.targetOrders})),a.push(P({pubkey:i.vault.A}),P({pubkey:i.vault.B})),o===5&&a.push(P({pubkey:wo})),a.push(P({pubkey:i.marketProgramId,isWritable:!1}),P({pubkey:i.marketId}),P({pubkey:i.marketBids}),P({pubkey:i.marketAsks}),P({pubkey:i.marketEventQueue}),P({pubkey:i.marketBaseVault}),P({pubkey:i.marketQuoteVault}),P({pubkey:i.marketAuthority,isWritable:!1}),P({pubkey:e.tokenAccountIn}),P({pubkey:e.tokenAccountOut}),P({pubkey:e.owner,isWritable:!1,isSigner:!0})),new wn({programId:i.programId,keys:a,data:s})}function pf({poolKeys:r,userKeys:e,maxAmountIn:t,amountOut:n},o){let i=Le(r),s=Buffer.alloc(ba.span);ba.encode({instruction:11,maxAmountIn:$(t),amountOut:$(n)},s);let a=[P({pubkey:ko,isWritable:!1}),P({pubkey:i.id}),P({pubkey:i.authority,isWritable:!1}),P({pubkey:i.openOrders}),P({pubkey:i.targetOrders}),P({pubkey:i.vault.A}),P({pubkey:i.vault.B})];return o===5&&a.push(P({pubkey:wo})),a.push(P({pubkey:i.marketProgramId,isWritable:!1}),P({pubkey:i.marketId}),P({pubkey:i.marketBids}),P({pubkey:i.marketAsks}),P({pubkey:i.marketEventQueue}),P({pubkey:i.marketBaseVault}),P({pubkey:i.marketQuoteVault}),P({pubkey:i.marketAuthority,isWritable:!1}),P({pubkey:e.tokenAccountIn}),P({pubkey:e.tokenAccountOut}),P({pubkey:e.owner,isWritable:!1,isSigner:!0})),new wn({programId:i.programId,keys:a,data:s})}function Rr(r){let{poolKeys:e,version:t,userKeys:n,amountIn:o,amountOut:i,fixedSide:s}=r;if(t===4||t===5){let a={poolKeys:e,userKeys:n};if(s==="in")return df({...a,amountIn:o,minAmountOut:i},t);if(s==="out")return pf({...a,maxAmountIn:o,amountOut:i},t);Hc.logWithError("invalid params","params",r)}throw Hc.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}function KI({poolKeys:r,userKeys:e,startTime:t}){let n=Buffer.alloc(ga.span);ga.encode({instruction:0,nonce:5,startTime:$(t)},n);let o=Le(r),i=[P({pubkey:ko,isWritable:!1}),P({pubkey:jc.programId,isWritable:!1}),P({pubkey:lf,isWritable:!1}),P({pubkey:o.id}),P({pubkey:o.authority,isWritable:!1}),P({pubkey:o.openOrders}),P({pubkey:o.mintLp.address}),P({pubkey:o.mintA.address,isWritable:!1}),P({pubkey:o.mintB.address,isWritable:!1}),P({pubkey:o.vault.A,isWritable:!1}),P({pubkey:o.vault.B,isWritable:!1}),P({pubkey:o.id}),P({pubkey:o.targetOrders}),P({pubkey:e.lpTokenAccount}),P({pubkey:o.id,isWritable:!1}),P({pubkey:o.marketProgramId,isWritable:!1}),P({pubkey:o.marketId,isWritable:!1}),P({pubkey:e.payer,isSigner:!0})];return new wn({programId:o.programId,keys:i,data:n})}function Zc({poolKeys:r}){let e=O([F("instruction"),F("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[P({pubkey:new xe(r.id),isWritable:!1}),P({pubkey:new xe(r.authority),isWritable:!1}),P({pubkey:new xe(r.openOrders),isWritable:!1}),P({pubkey:new xe(r.vault.A),isWritable:!1}),P({pubkey:new xe(r.vault.B),isWritable:!1}),P({pubkey:new xe(r.mintLp.address),isWritable:!1}),P({pubkey:new xe(r.marketId),isWritable:!1}),P({pubkey:new xe(r.marketEventQueue),isWritable:!1})];return{instruction:new wn({programId:new xe(r.programId),keys:n,data:t})}}import{PublicKey as bi}from"@solana/web3.js";import yi from"bn.js";import{TOKEN_PROGRAM_ID as bf}from"@solana/spl-token";import{PublicKey as ff}from"@solana/web3.js";var yf=me("Raydium_liquidity_serum");function $c({programId:r,marketId:e}){let t=[e.toBuffer()],n=0,o;for(;n<100;){try{let i=t.concat(Buffer.from([n]),Buffer.alloc(7));o=ff.createProgramAddressSync(i,r)}catch(i){if(i instanceof TypeError)throw i;n++;continue}return{publicKey:o,nonce:n}}throw yf.logWithError("unable to find a viable program address nonce","params",{programId:r,marketId:e}),new Error("unable to find a viable program address nonce")}function Nr({programId:r}){let{publicKey:e}=te([Buffer.from("amm_config_account_seed","utf-8")],r);return e}function Yn({name:r,programId:e,marketId:t}){let{publicKey:n}=te([e.toBuffer(),t.toBuffer(),Buffer.from(r,"utf-8")],e);return n}function gf({programId:r,marketId:e}){let{publicKey:t}=te([r.toBuffer(),e.toBuffer(),Buffer.from("open_order_associated_seed","utf-8")],r);return t}function Ba({programId:r}){return te([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],r)}function xa({version:r,marketVersion:e,marketId:t,baseMint:n,quoteMint:o,baseDecimals:i,quoteDecimals:s,programId:a,marketProgramId:c}){let u=Yn({name:"amm_associated_seed",programId:a,marketId:t}),l=Yn({name:"lp_mint_associated_seed",programId:a,marketId:t}),{publicKey:d,nonce:m}=Ba({programId:a}),p=Yn({name:"coin_vault_associated_seed",programId:a,marketId:t}),y=Yn({name:"pc_vault_associated_seed",programId:a,marketId:t}),f=Yn({name:"temp_lp_token_associated_seed",programId:a,marketId:t}),b=gf({programId:a,marketId:t}),g=Yn({name:"target_associated_seed",programId:a,marketId:t}),w=Yn({name:"withdraw_associated_seed",programId:a,marketId:t}),{publicKey:k}=$c({programId:c,marketId:t});return{id:u,baseMint:n,quoteMint:o,lpMint:l,baseDecimals:i,quoteDecimals:s,lpDecimals:i,version:r,programId:a,authority:d,nonce:m,baseVault:p,quoteVault:y,lpVault:f,openOrders:b,targetOrders:g,withdrawQueue:w,marketVersion:e,marketProgramId:c,marketId:t,marketAuthority:k,lookupTableAccount:bi.default,configId:Nr({programId:a})}}var Ta;async function $I({connection:r,poolKeysList:e,config:t}){return e.find(o=>o.modelDataAccount)&&(Ta||(Ta=new Ao({connection:r}),await Ta.initStableModelLayout())),await Promise.all(e.map(async o=>{if(o.modelDataAccount){let i=Zc({poolKeys:o});return(await Su(r,[i.instruction],"GetPoolData")).map(c=>{let u=Ku(c,"GetPoolData"),l=new yi(fn(u,"status")),d=Number(fn(u,"coin_decimals")),m=Number(fn(u,"pc_decimals")),p=Number(fn(u,"lp_decimals")),y=new yi(fn(u,"pool_coin_amount")),f=new yi(fn(u,"pool_pc_amount")),b=new yi(fn(u,"pool_lp_supply")),g="0";try{g=fn(u,"pool_open_time")}catch{}return{status:l,baseDecimals:d,quoteDecimals:m,lpDecimals:p,baseReserve:y,quoteReserve:f,lpSupply:b,startTime:new yi(g)}})[0]}else{let[i,s,a,c]=await r.getMultipleAccountsInfo([new bi(o.id),new bi(o.vault.A),new bi(o.vault.B),new bi(o.mintLp.address)]);if(i===null)throw Error("fetch pool error");if(s===null)throw Error("fetch vaultAccA error");if(a===null)throw Error("fetch vaultAccB error");if(c===null)throw Error("fetch mintAccLp error");let u=zn.decode(i.data),l=Yt.decode(s.data),d=Yt.decode(a.data),m=Vc.decode(c.data);return{status:u.status,baseDecimals:u.baseDecimal.toNumber(),quoteDecimals:u.quoteDecimal.toNumber(),lpDecimals:m.decimals,baseReserve:l.amount.sub(u.baseNeedTakePnl),quoteReserve:d.amount.sub(u.quoteNeedTakePnl),lpSupply:u.lpReserve,startTime:u.poolOpenTime}}}))}var Ia={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]},Or=r=>{let e={},t=bf.toBase58();return Object.keys(r).map(n=>{let o=r[n],[i,s]=[o.baseMint.toBase58(),o.quoteMint.toBase58()];e[n]={id:n,version:4,status:o.status.toNumber(),programId:o.programId.toBase58(),mintA:dt({address:i,programId:t,decimals:o.baseDecimal.toNumber()}),mintB:dt({address:s,programId:t,decimals:o.quoteDecimal.toNumber()}),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:o.poolPrice.toNumber(),mintAmountA:new C(o.mintAAmount.toString()).div(10**o.baseDecimal.toNumber()).toNumber(),mintAmountB:new C(o.mintBAmount.toString()).div(10**o.quoteDecimal.toNumber()).toNumber(),baseReserve:o.baseReserve,quoteReserve:o.quoteReserve,feeRate:new C(o.tradeFeeNumerator.toString()).div(o.tradeFeeDenominator.toString()).toNumber(),openTime:o.poolOpenTime.toString(),tvl:0,day:Ia,week:Ia,month:Ia,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,type:"Standard",marketId:o.marketId.toBase58(),configId:Nr({programId:o.programId}).toBase58(),lpPrice:0,lpAmount:new C(o.lpReserve.toString()).div(10**Math.min(o.baseDecimal.toNumber(),o.quoteDecimal.toNumber())).toNumber(),lpMint:dt({address:o.lpMint.toBase58(),programId:t,decimals:Math.min(o.baseDecimal.toNumber(),o.quoteDecimal.toNumber())}),burnPercent:0}}),e};import Ve from"bn.js";import{PublicKey as gi}from"@solana/web3.js";import Pi from"bn.js";import{TOKEN_PROGRAM_ID as nl}from"@solana/spl-token";import{SystemProgram as Zn,SYSVAR_RENT_PUBKEY as Af,Transaction as Jc,TransactionInstruction as wf}from"@solana/web3.js";import{createInitializeAccountInstruction as el,TOKEN_PROGRAM_ID as tl}from"@solana/spl-token";function Pf(r="accountFlags"){let e=new Ar(r);return e.addBoolean("initialized"),e.addBoolean("market"),e.addBoolean("openOrders"),e.addBoolean("requestQueue"),e.addBoolean("eventQueue"),e.addBoolean("bids"),e.addBoolean("asks"),e}var Sa=O([we(5),Pf("accountFlags"),L("ownAddress"),A("vaultSignerNonce"),L("baseMint"),L("quoteMint"),L("baseVault"),A("baseDepositsTotal"),A("baseFeesAccrued"),L("quoteVault"),A("quoteDepositsTotal"),A("quoteFeesAccrued"),A("quoteDustThreshold"),L("requestQueue"),L("eventQueue"),L("bids"),L("asks"),A("baseLotSize"),A("quoteLotSize"),A("feeRateBps"),A("referrerRebatesAccrued"),we(7)]);function kf({programId:r,marketInfo:e}){let t=O([F("version"),ot("instruction"),A("baseLotSize"),A("quoteLotSize"),Ht("feeRateBps"),A("vaultSignerNonce"),A("quoteDustThreshold")]),n=[{pubkey:e.id,isSigner:!1,isWritable:!0},{pubkey:e.requestQueue,isSigner:!1,isWritable:!0},{pubkey:e.eventQueue,isSigner:!1,isWritable:!0},{pubkey:e.bids,isSigner:!1,isWritable:!0},{pubkey:e.asks,isSigner:!1,isWritable:!0},{pubkey:e.baseVault,isSigner:!1,isWritable:!0},{pubkey:e.quoteVault,isSigner:!1,isWritable:!0},{pubkey:e.baseMint,isSigner:!1,isWritable:!1},{pubkey:e.quoteMint,isSigner:!1,isWritable:!1},{pubkey:e.authority?e.quoteMint:Af,isSigner:!1,isWritable:!1}].concat(e.authority?{pubkey:e.authority,isSigner:!1,isWritable:!1}:[]).concat(e.authority&&e.pruneAuthority?{pubkey:e.pruneAuthority,isSigner:!1,isWritable:!1}:[]),o=Buffer.alloc(t.span);return t.encode({version:0,instruction:0,baseLotSize:e.baseLotSize,quoteLotSize:e.quoteLotSize,feeRateBps:e.feeRateBps,vaultSignerNonce:e.vaultSignerNonce,quoteDustThreshold:e.quoteDustThreshold},o),new wf({keys:n,programId:r,data:o})}async function vr({connection:r,wallet:e,marketInfo:t}){let n=new Jc,o=await r.getMinimumBalanceForRentExemption(165);n.add(Zn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.baseVault.seed,newAccountPubkey:t.baseVault.publicKey,lamports:o,space:165,programId:tl}),Zn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.quoteVault.seed,newAccountPubkey:t.quoteVault.publicKey,lamports:o,space:165,programId:tl}),el(t.baseVault.publicKey,t.baseMint,t.vaultOwner),el(t.quoteVault.publicKey,t.quoteMint,t.vaultOwner),Zn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.id.seed,newAccountPubkey:t.id.publicKey,lamports:await r.getMinimumBalanceForRentExemption(Sa.span),space:Sa.span,programId:t.programId}));let i=new Jc;return i.add(Zn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.requestQueue.seed,newAccountPubkey:t.requestQueue.publicKey,lamports:t.lowestFeeMarket?6208320:await r.getMinimumBalanceForRentExemption(t.requestQueueSpace??5120+12),space:t.lowestFeeMarket?764:t.requestQueueSpace??5120+12,programId:t.programId}),Zn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.eventQueue.seed,newAccountPubkey:t.eventQueue.publicKey,lamports:t.lowestFeeMarket?79594560:await r.getMinimumBalanceForRentExemption(t.eventQueueSpace??262144+12),space:t.lowestFeeMarket?11308:t.eventQueueSpace??262144+12,programId:t.programId}),Zn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.bids.seed,newAccountPubkey:t.bids.publicKey,lamports:t.lowestFeeMarket?101977920:await r.getMinimumBalanceForRentExemption(t.orderbookQueueSpace??65536+12),space:t.lowestFeeMarket?14524:t.orderbookQueueSpace??65536+12,programId:t.programId}),Zn.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.asks.seed,newAccountPubkey:t.asks.publicKey,lamports:t.lowestFeeMarket?101977920:await r.getMinimumBalanceForRentExemption(t.orderbookQueueSpace??65536+12),space:t.lowestFeeMarket?14524:t.orderbookQueueSpace??65536+12,programId:t.programId}),kf({programId:t.programId,marketInfo:{id:t.id.publicKey,requestQueue:t.requestQueue.publicKey,eventQueue:t.eventQueue.publicKey,bids:t.bids.publicKey,asks:t.asks.publicKey,baseVault:t.baseVault.publicKey,quoteVault:t.quoteVault.publicKey,baseMint:t.baseMint,quoteMint:t.quoteMint,baseLotSize:t.baseLotSize,quoteLotSize:t.quoteLotSize,feeRateBps:t.feeRateBps,vaultSignerNonce:t.vaultSignerNonce,quoteDustThreshold:t.quoteDustThreshold}})),[{transaction:n,signer:[],instructionTypes:[V.CreateAccount,V.CreateAccount,V.InitAccount,V.InitAccount]},{transaction:i,signer:[],instructionTypes:[V.CreateAccount,V.CreateAccount,V.CreateAccount,V.CreateAccount,V.CreateAccount,V.InitMarket]}]}var ho=class extends Re{async create({baseInfo:e,quoteInfo:t,lotSize:n,tickSize:o,dexProgramId:i,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u,assignSeed:l,txVersion:d,computeBudgetConfig:m,txTipConfig:p,feePayer:y}){let f=this.scope.ownerPubKey,b=l?`${e.mint.toBase58().slice(0,10)}-${t.mint.toBase58().slice(0,10)}-${l}`:void 0,g=We({fromPublicKey:f,programId:i,assignSeed:b&&`${b}-market`}),w=We({fromPublicKey:f,programId:i,assignSeed:b&&`${b}-request`}),k=We({fromPublicKey:f,programId:i,assignSeed:b&&`${b}-event`}),h=We({fromPublicKey:f,programId:i,assignSeed:b&&`${b}-bids`}),x=We({fromPublicKey:f,programId:i,assignSeed:b&&`${b}-asks`}),T=We({fromPublicKey:f,programId:nl,assignSeed:b&&`${b}-baseVault`}),B=We({fromPublicKey:f,programId:nl,assignSeed:b&&`${b}-quoteVault`}),S=0,I=new Pi(100);function K(){let Y=new Pi(0);for(;;)try{return{vaultOwner:gi.createProgramAddressSync([g.publicKey.toBuffer(),Y.toArrayLike(Buffer,"le",8)],i),vaultSignerNonce:Y}}catch{if(Y.iaddn(1),Y.gt(new Pi(25555)))throw Error("find vault owner error")}}let{vaultOwner:N,vaultSignerNonce:v}=K(),_=new Pi(Math.round(10**e.decimals*n)),D=new Pi(Math.round(n*10**t.decimals*o));if(_.eq(ht))throw Error("lot size is too small");if(D.eq(ht))throw Error("tick size or lot size is too small");let q=await vr({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:i,id:g,baseMint:e.mint,quoteMint:t.mint,baseVault:T,quoteVault:B,vaultOwner:N,requestQueue:w,eventQueue:k,bids:h,asks:x,feeRateBps:S,quoteDustThreshold:I,vaultSignerNonce:v,baseLotSize:_,quoteLotSize:D,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u}}),G=this.createTxBuilder(y);G.addInstruction({instructions:q[0].transaction.instructions,signers:q[0].signer});for await(let Y of q.slice(1,q.length))G.addInstruction({instructions:Y.transaction.instructions,signers:Y.signer,instructionTypes:Y.instructionTypes});return d===0?G.sizeCheckBuildV0({computeBudgetConfig:m,address:{marketId:g.publicKey,requestQueue:w.publicKey,eventQueue:k.publicKey,bids:h.publicKey,asks:x.publicKey,baseVault:T.publicKey,quoteVault:B.publicKey,baseMint:new gi(e.mint),quoteMint:new gi(t.mint)}}):G.sizeCheckBuild({computeBudgetConfig:m,address:{marketId:g.publicKey,requestQueue:w.publicKey,eventQueue:k.publicKey,bids:h.publicKey,asks:x.publicKey,baseVault:T.publicKey,quoteVault:B.publicKey,baseMint:new gi(e.mint),quoteMint:new gi(t.mint)}})}};var Ai=class extends Re{stableLayout;constructor(e){super(e),this.stableLayout=new Ao({connection:this.scope.connection})}async initLayout(){await this.stableLayout.initStableModelLayout()}async load(){this.checkDisabled()}computePairAmount({poolInfo:e,amount:t,slippage:n,baseIn:o}){let i=new Ve(new C(t).mul(10**e[o?"mintA":"mintB"].decimals).toFixed(0)),s=Cr(e[o?"mintB":"mintA"]),[a,c]=[new Ve(new C(e.mintAmountA).mul(10**e.mintA.decimals).toString()),new Ve(new C(e.mintAmountB).mul(10**e.mintB.decimals).toString())],u=new Ve(new C(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,C.ROUND_DOWN));this.logDebug("baseReserve:",a.toString(),"quoteReserve:",c.toString()),this.logDebug("tokenIn:",o?e.mintA.symbol:e.mintB.symbol,"amountIn:",i.toString(),"anotherToken:",o?e.mintB.symbol:e.mintA.symbol,"slippage:",`${n.toSignificant()}%`,"baseReserve",a.toString(),"quoteReserve",c.toString());let l=o?"base":"quote";this.logDebug("input side:",l);let d=ht;i.isZero()||(d=l==="base"?$i(i.mul(c),a):$i(i.mul(a),c)),this.logDebug("amountRaw:",d.toString(),"lpAmount:",u.toString());let m=$i(i.mul(u),l==="base"?a:c);this.logDebug("liquidity:",m.toString());let p=new Je(new Ve(1)).add(n),y=new Je(new Ve(1)).sub(n),f=p.mul(d).quotient,b=y.mul(d).quotient,g=new he(s,d),w=new he(s,f),k=new he(s,b);return this.logDebug("anotherAmount:",g.toFixed(),"maxAnotherAmount:",w.toFixed()),{anotherAmount:g,maxAnotherAmount:w,minAnotherAmount:k,liquidity:m}}async getAmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async addLiquidity(e){let{poolInfo:t,poolKeys:n,amountInA:o,amountInB:i,otherAmountMin:s,fixedSide:a,config:c,txVersion:u,computeBudgetConfig:l,txTipConfig:d,feePayer:m}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),this.logDebug("amountInA:",o,"amountInB:",i),(o.isZero()||i.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:o.toFixed(),amountInB:i.toFixed()});let{account:p}=this.scope,{bypassAssociatedCheck:y,checkCreateATAOwner:f}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...c},[b,g]=[o.token,i.token],w=await p.getCreatedTokenAccount({mint:b.mint,associatedOnly:!1}),k=await p.getCreatedTokenAccount({mint:g.mint,associatedOnly:!1});!w&&!k&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",p.tokenAccounts);let h=await p.getCreatedTokenAccount({mint:new Ue(t.lpMint.address)}),x=[b,g],T=[w,k],B=[o.raw,i.raw],S=o.token.mint.toBase58()===t.mintA.address?"base":"quote",I="base";["quote","base"].includes(S)||this.logAndCreateError("invalid fixedSide","fixedSide",a),S==="quote"?(x.reverse(),T.reverse(),B.reverse(),I=a==="a"?"quote":"base"):S==="base"&&(I=a==="a"?"base":"quote");let[K,N]=x,[v,_]=T,[D,q]=B,G=n??await this.getAmmPoolKeys(t.id),Y=this.createTxBuilder(m),{tokenAccount:ie,...ke}=await p.handleTokenAccount({side:"in",amount:D,mint:K.mint,tokenAccount:v,bypassAssociatedCheck:y,checkCreateATAOwner:f});Y.addInstruction(ke);let{tokenAccount:re,...ge}=await p.handleTokenAccount({side:"in",amount:q,mint:N.mint,tokenAccount:_,bypassAssociatedCheck:y,checkCreateATAOwner:f});Y.addInstruction(ge);let{tokenAccount:rt,...st}=await p.handleTokenAccount({side:"out",amount:0,mint:new Ue(t.lpMint.address),tokenAccount:h,bypassAssociatedCheck:y,checkCreateATAOwner:f});return Y.addInstruction(st),Y.addInstruction({instructions:[Yc({poolInfo:t,poolKeys:G,userKeys:{baseTokenAccount:ie,quoteTokenAccount:re,lpTokenAccount:rt,owner:this.scope.ownerPubKey},baseAmountIn:D,quoteAmountIn:q,otherAmountMin:s.raw,fixedSide:I})],instructionTypes:[t.pooltype.includes("StablePool")?V.AmmV5AddLiquidity:V.AmmV4AddLiquidity],lookupTableAddress:G.lookupTableAccount?[G.lookupTableAccount]:[]}),Y.addCustomComputeBudget(l),Y.addTipInstruction(d),u===0?await Y.buildV0():Y.build()}async removeLiquidity(e){this.scope.availability.removeStandardPosition===!1&&this.logAndCreateError("remove liquidity feature disabled in your region");let{poolInfo:t,poolKeys:n,lpAmount:o,baseAmountMin:i,quoteAmountMin:s,config:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:d}=e,m=n??await this.getAmmPoolKeys(t.id),[p,y,f]=[new Ue(t.mintA.address),new Ue(t.mintB.address),new Ue(t.lpMint.address)];this.logDebug("lpAmount:",o),this.logDebug("baseAmountMin:",i),this.logDebug("quoteAmountMin:",s),o.isZero()&&this.logAndCreateError("amount must greater than zero","lpAmount",o.toString());let{account:b}=this.scope,g=await b.getCreatedTokenAccount({mint:f,associatedOnly:!1});g||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",b.tokenAccounts);let w=await b.getCreatedTokenAccount({mint:p}),k=await b.getCreatedTokenAccount({mint:y}),h=this.createTxBuilder(d),{bypassAssociatedCheck:x,checkCreateATAOwner:T}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...a},{tokenAccount:B,...S}=await b.handleTokenAccount({side:"out",amount:0,mint:p,tokenAccount:w,bypassAssociatedCheck:x,checkCreateATAOwner:T});h.addInstruction(S);let{tokenAccount:I,...K}=await b.handleTokenAccount({side:"out",amount:0,mint:y,tokenAccount:k,bypassAssociatedCheck:x,checkCreateATAOwner:T});return h.addInstruction(K),h.addInstruction({instructions:[ka({poolInfo:t,poolKeys:m,userKeys:{lpTokenAccount:g,baseTokenAccount:B,quoteTokenAccount:I,owner:this.scope.ownerPubKey},lpAmount:o,baseAmountMin:i,quoteAmountMin:s})],lookupTableAddress:m.lookupTableAccount?[m.lookupTableAccount]:[],instructionTypes:[t.pooltype.includes("StablePool")?V.AmmV5RemoveLiquidity:V.AmmV4RemoveLiquidity]}),h.addCustomComputeBudget(u),h.addTipInstruction(l),c===0?await h.buildV0():h.build()}async removeAllLpAndCreateClmmPosition({poolInfo:e,clmmPoolInfo:t,removeLpAmount:n,createPositionInfo:o,farmInfo:i,userFarmLpAmount:s,base:a,computeBudgetConfig:c,payer:u,userAuxiliaryLedgers:l,tokenProgram:d=Mn,checkCreateATAOwner:m=!0,getEphemeralSigners:p,txVersion:y,feePayer:f}){if((this.scope.availability.removeStandardPosition===!1||this.scope.availability.createConcentratedPosition===!1)&&this.logAndCreateError("remove liquidity or create position feature disabled in your region"),!(e.mintA.address===t.mintA.address||e.mintA.address===t.mintB.address)||!(e.mintB.address===t.mintA.address||e.mintB.address===t.mintB.address))throw Error("mint check error");let b=this.createTxBuilder(f),g={};for(let G of this.scope.account.tokenAccountRawInfos)(g[G.accountInfo.mint.toString()]===void 0||Z(this.scope.ownerPubKey,G.accountInfo.mint,Mn).publicKey.equals(G.pubkey))&&(g[G.accountInfo.mint.toString()]=G.pubkey);let w=g[e.lpMint.address];if(w===void 0)throw Error("find lp account error in trade accounts");let k=n.add(s??new Ve(0)),h=e.mintA.address===Me.WSOL.mint.toString(),x=e.mintB.address===Me.WSOL.mint.toString(),{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Mn,mint:new Ue(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:h?{payer:this.scope.ownerPubKey}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:!0,checkCreateATAOwner:m});if(b.addInstruction(B||{}),T===void 0)throw new Error("base token account not found");let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Mn,mint:new Ue(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:x?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:!0,checkCreateATAOwner:m});if(b.addInstruction(I||{}),S===void 0)throw new Error("quote token account not found");if(g[e.mintA.address]=T,g[e.mintB.address]=S,i!==void 0&&!s?.isZero()){let G=vt[i.programId],Y=lt({programId:new Ue(i.programId),poolId:new Ue(i.id),owner:this.scope.ownerPubKey,version:G}),ie,ke=await this.scope.connection.getAccountInfo(Y);if(ke&&(ie=go(G).decode(ke.data)),G!==6&&!ie){let{instruction:Kt,instructionType:$t}=Jo({id:new Ue(i.id),programId:new Ue(i.programId),version:G,ledger:Y,owner:this.scope.ownerPubKey});b.addInstruction({instructions:[Kt],instructionTypes:[$t]})}let re=[];for(let Kt of i.rewardInfos){let $t=Kt.mint.address===Me.WSOL.mint.toString();if(g[Kt.mint.address])re.push(g[Kt.mint.address]);else{let{account:mn,instructionParams:at}=await this.scope.account.getOrCreateTokenAccount({mint:new Ue(Kt.mint.address),tokenProgram:d,owner:this.scope.ownerPubKey,skipCloseAccount:!$t,createInfo:{payer:u||this.scope.ownerPubKey},associatedOnly:!0,checkCreateATAOwner:m});mn||this.logAndCreateError("farm reward account not found:",Kt.mint.address),at&&b.addInstruction(at),re.push(mn)}}let ge=(await this.scope.api.fetchFarmKeysById({ids:i.id}))[0],rt={userAuxiliaryLedgers:l,amount:s,owner:this.scope.ownerPubKey,farmInfo:i,farmKeys:ge,lpAccount:w,rewardAccounts:re},st=vt[i.programId],je=st===6?ei(rt):st===5?ti(rt):ni(rt),At={3:V.FarmV3Withdraw,5:V.FarmV5Withdraw,6:V.FarmV6Withdraw};b.addInstruction({instructions:[je],instructionTypes:[At[st]]})}let K=await this.getAmmPoolKeys(e.id),N=ka({poolInfo:e,poolKeys:K,userKeys:{lpTokenAccount:w,baseTokenAccount:T,quoteTokenAccount:S,owner:this.scope.ownerPubKey},lpAmount:k,baseAmountMin:0,quoteAmountMin:0});b.addInstruction({instructions:[N],instructionTypes:[e.pooltype.includes("StablePool")?V.AmmV5RemoveLiquidity:V.AmmV4RemoveLiquidity],lookupTableAddress:K.lookupTableAccount?[K.lookupTableAccount]:[]});let[v,_]=e.mintA.address===t.mintA.address?[T,S]:[S,T],D=await this.scope.clmm.getClmmPoolKeys(t.id),q=await Be.openPositionFromBaseInstructions({poolInfo:t,poolKeys:D,ownerInfo:{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:v,tokenAccountB:_},withMetadata:"create",...o,base:a,getEphemeralSigners:p});return b.addInstruction({instructions:[...q.instructions],signers:q.signers,instructionTypes:[...q.instructionTypes],lookupTableAddress:D.lookupTableAccount?[D.lookupTableAccount]:[]}),y===0?b.sizeCheckBuildV0({computeBudgetConfig:c}):b.sizeCheckBuild({computeBudgetConfig:c})}async createPoolV4({programId:e,marketInfo:t,baseMintInfo:n,quoteMintInfo:o,baseAmount:i,quoteAmount:s,startTime:a,ownerInfo:c,associatedOnly:u=!1,checkCreateATAOwner:l=!1,tokenProgram:d,txVersion:m,feeDestinationId:p,computeBudgetConfig:y,txTipConfig:f,feePayer:b}){let g=c.feePayer||this.scope.owner?.publicKey,w=c.useSOLBalance&&n.mint.equals(Mr),k=c.useSOLBalance&&o.mint.equals(Mr),h=this.createTxBuilder(b),{account:x,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({mint:n.mint,owner:this.scope.ownerPubKey,createInfo:w?{payer:g,amount:i}:void 0,notUseTokenAccount:w,skipCloseAccount:!w,associatedOnly:w?!1:u,checkCreateATAOwner:l});h.addInstruction(T||{});let{account:B,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:o.mint,owner:this.scope.ownerPubKey,createInfo:k?{payer:g,amount:s}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:u,checkCreateATAOwner:l});if(h.addInstruction(S||{}),x===void 0||B===void 0)throw Error("you don't has some token account");let I=xa({version:4,marketVersion:3,marketId:t.marketId,baseMint:n.mint,quoteMint:o.mint,baseDecimals:n.decimals,quoteDecimals:o.decimals,programId:e,marketProgramId:t.programId}),K={programId:e,ammId:I.id,ammAuthority:I.authority,ammOpenOrders:I.openOrders,lpMint:I.lpMint,coinMint:I.baseMint,pcMint:I.quoteMint,coinVault:I.baseVault,pcVault:I.quoteVault,withdrawQueue:I.withdrawQueue,ammTargetOrders:I.targetOrders,poolTempLp:I.lpVault,marketProgramId:I.marketProgramId,marketId:I.marketId,ammConfigId:I.configId,feeDestinationId:p},{instruction:N,instructionType:v}=ha({...K,userWallet:this.scope.ownerPubKey,userCoinVault:x,userPcVault:B,userLpVault:Z(this.scope.ownerPubKey,I.lpMint,d).publicKey,nonce:I.nonce,openTime:a,coinAmount:i,pcAmount:s});return h.addInstruction({instructions:[N],instructionTypes:[v]}),h.addCustomComputeBudget(y),h.addTipInstruction(f),h.versionBuild({txVersion:m,extInfo:{address:K}})}async createMarketAndPoolV4({programId:e=_o,marketProgram:t=xs,feeDestinationId:n=Lu,tokenProgram:o,baseMintInfo:i,quoteMintInfo:s,baseAmount:a,quoteAmount:c,startTime:u,ownerInfo:l,lowestFeeMarket:d,assignSeed:m,associatedOnly:p=!1,checkCreateATAOwner:y=!1,lotSize:f=1,tickSize:b=.01,txVersion:g,computeBudgetConfig:w,txTipConfig:k,feePayer:h}){let x=this.scope.ownerPubKey,T=l.feePayer||this.scope.owner?.publicKey,B=l.useSOLBalance&&i.mint.equals(Mr),S=l.useSOLBalance&&s.mint.equals(Mr),I=m?`${i.mint.toBase58().slice(0,7)}-${s.mint.toBase58().slice(0,7)}-${m}`:void 0,K=We({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-market`}),N=We({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-request`}),v=We({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-event`}),_=We({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-bids`}),D=We({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-asks`}),q=We({fromPublicKey:x,programId:Mn,assignSeed:I&&`${I}-baseVault`}),G=We({fromPublicKey:x,programId:Mn,assignSeed:I&&`${I}-quoteVault`}),Y=0,ie=new Ve(100);function ke(){let Jt=new Ve(0);for(;;)try{return{vaultOwner:Ue.createProgramAddressSync([K.publicKey.toBuffer(),Jt.toArrayLike(Buffer,"le",8)],t),vaultSignerNonce:Jt}}catch{if(Jt.iaddn(1),Jt.gt(new Ve(25555)))throw Error("find vault owner error")}}let{vaultOwner:re,vaultSignerNonce:ge}=ke(),rt=new Ve(Math.round(10**i.decimals*f)),st=new Ve(Math.round(f*10**s.decimals*b));if(rt.eq(ht))throw Error("lot size is too small");if(st.eq(ht))throw Error("tick size or lot size is too small");let je=await vr({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:t,vaultOwner:re,baseMint:i.mint,quoteMint:s.mint,id:K,baseVault:q,quoteVault:G,requestQueue:N,eventQueue:v,bids:_,asks:D,feeRateBps:Y,quoteDustThreshold:ie,vaultSignerNonce:ge,baseLotSize:rt,quoteLotSize:st,lowestFeeMarket:d}}),At=this.createTxBuilder(h);At.addInstruction({instructions:je[0].transaction.instructions,signers:je[0].signer});for await(let Jt of je.slice(1,je.length))At.addInstruction({instructions:Jt.transaction.instructions,signers:Jt.signer,instructionTypes:Jt.instructionTypes});let{account:Kt,instructionParams:$t}=await this.scope.account.getOrCreateTokenAccount({mint:i.mint,owner:this.scope.ownerPubKey,createInfo:B?{payer:T,amount:a}:void 0,notUseTokenAccount:B,skipCloseAccount:!B,associatedOnly:B?!1:p,checkCreateATAOwner:y,assignSeed:B&&I?`${I}-wsol`:void 0});At.addInstruction($t||{});let{account:mn,instructionParams:at}=await this.scope.account.getOrCreateTokenAccount({mint:s.mint,owner:this.scope.ownerPubKey,createInfo:S?{payer:T,amount:c}:void 0,notUseTokenAccount:S,skipCloseAccount:!S,associatedOnly:S?!1:p,checkCreateATAOwner:y,assignSeed:S&&I?`${I}-wsol`:void 0});if(At.addInstruction(at||{}),Kt===void 0)throw Error("you don't has base token account");if(mn===void 0)throw Error("you don't has quote token account");let Ye=xa({version:4,marketVersion:3,marketId:K.publicKey,baseMint:i.mint,quoteMint:s.mint,baseDecimals:i.decimals,quoteDecimals:s.decimals,programId:e,marketProgramId:t}),os={programId:e,ammId:Ye.id,ammAuthority:Ye.authority,ammOpenOrders:Ye.openOrders,lpMint:Ye.lpMint,coinMint:Ye.baseMint,pcMint:Ye.quoteMint,coinVault:Ye.baseVault,pcVault:Ye.quoteVault,withdrawQueue:Ye.withdrawQueue,ammTargetOrders:Ye.targetOrders,poolTempLp:Ye.lpVault,marketProgramId:Ye.marketProgramId,marketId:Ye.marketId,ammConfigId:Ye.configId,feeDestinationId:n},{instruction:vl,instructionType:Ml}=ha({...os,userWallet:this.scope.ownerPubKey,userCoinVault:Kt,userPcVault:mn,userLpVault:Z(this.scope.ownerPubKey,Ye.lpMint,o).publicKey,nonce:Ye.nonce,openTime:u,coinAmount:a,pcAmount:c});At.addInstruction({instructions:[vl],instructionTypes:[Ml]});let Ha=B||S?[$t?.instructions?.[0]||at?.instructions?.[0]].filter(Jt=>!!Jt):void 0;return g===0?At.sizeCheckBuildV0({computeBudgetConfig:w,splitIns:Ha,address:{requestQueue:N.publicKey,eventQueue:v.publicKey,bids:_.publicKey,asks:D.publicKey,baseVault:q.publicKey,quoteVault:G.publicKey,baseMint:new Ue(i.mint),quoteMint:new Ue(s.mint),...os}}):At.sizeCheckBuild({computeBudgetConfig:w,splitIns:Ha,address:{requestQueue:N.publicKey,eventQueue:v.publicKey,bids:_.publicKey,asks:D.publicKey,baseVault:q.publicKey,quoteVault:G.publicKey,baseMint:new Ue(i.mint),quoteMint:new Ue(s.mint),...os}})}async getCreatePoolFee({programId:e}){let t=Nr({programId:e}),n=await this.scope.connection.getAccountInfo(t,{dataSlice:{offset:536,length:8}});if(n===null)throw Error("get config account error");return qc.decode(n.data).fee}computeAmountOut({poolInfo:e,amountIn:t,mintIn:n,mintOut:o,slippage:i}){let[s,a]=[n.toString(),o.toString()];if(s!==e.mintA.address&&s!==e.mintB.address)throw new Error("toke not match");if(a!==e.mintA.address&&a!==e.mintB.address)throw new Error("toke not match");let{baseReserve:c,quoteReserve:u}=e,l=[c,u],d=[e.mintA.decimals,e.mintB.decimals],m=s==e.mintA.address?"base":"quote";m==="quote"&&(l.reverse(),d.reverse());let[p,y]=l,[f,b]=d,g=e.version===4,w;if(g)w=new C(y.toString()).div(10**b).div(new C(p.toString()).div(10**f));else{let v=zc(this.stableLayout.stableModelData,c.toNumber(),u.toNumber(),!1);m==="quote"?w=new C(1e6).div(v*1e6):w=new C(v*1e6).div(1e6)}let k=t,h=new Ve(0),x=new Ve(0);if(!k.isZero())if(g){x=Kn(k.mul(fa),Lr);let v=k.sub(x),_=p.add(v);h=y.mul(v).div(_)}else{x=k.mul(new Ve(2)).div(new Ve(1e4));let v=k.sub(x);m==="quote"?h=new Ve(Xc(this.stableLayout.stableModelData,u.toNumber(),c.toNumber(),v.toNumber())):h=new Ve(Qc(this.stableLayout.stableModelData,u.toNumber(),c.toNumber(),v.toNumber()))}let T=new Ve(new C(h.toString()).mul(1-i).toFixed(0)),B=h,S=T,I=new C(h.toString()).div(new C(k.sub(x).toString()).toFixed(0));!k.isZero()&&!h.isZero()&&(I=new C(h.toString()).div(10**b).div(new C(k.sub(x).toString()).div(10**f)));let K=w.sub(I).div(w).mul(100);return{amountOut:B,minAmountOut:S,currentPrice:w,executionPrice:I,priceImpact:K,fee:x}}computeAmountIn({poolInfo:e,amountOut:t,mintIn:n,mintOut:o,slippage:i}){let{baseReserve:s,quoteReserve:a}=e;n.toString()!==e.mintA.address&&n.toString()!==e.mintB.address&&this.logAndCreateError("mintIn does not match pool"),o.toString()!==e.mintA.address&&o.toString()!==e.mintB.address&&this.logAndCreateError("mintOut does not match pool"),this.logDebug("baseReserve:",s.toString()),this.logDebug("quoteReserve:",a.toString());let c=n.toString()===e.mintA.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA];this.logDebug("currencyOut:",l.symbol||l.address),this.logDebug("amountOut:",new C(t.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString(),u.symbol||u.address),this.logDebug("slippage:",`${i*100}%`);let d=[s,a],m=c?"quote":"base";m==="base"&&d.reverse(),this.logDebug("output side:",m);let[p,y]=d,f=new C(y.toString()).div(10**e[c?"mintB":"mintA"].decimals).div(new C(p.toString()).div(10**e[c?"mintA":"mintB"].decimals));this.logDebug("currentPrice:",`1 ${u.symbol||u.address} \u2248 ${f.toString()} ${l.symbol||l.address}`),this.logDebug("currentPrice invert:",`1 ${l.symbol||l.address} \u2248 ${new C(1).div(f).toString()} ${u.symbol||u.address}`);let b=new Ve(0),g=t;if(!g.isZero()){g.gt(y)&&(g=y.sub(new Ve(1)));let S=y.sub(g);b=p.mul(g).div(S).mul(Lr).div(Lr.sub(fa))}let w=new Ve(new C(b.toString()).mul(1+i).toFixed(0)),k=b,h=w;this.logDebug("amountIn:",new C(k.toString()).div(10**u.decimals).toDecimalPlaces(u.decimals).toString()),this.logDebug("maxAmountIn:",new C(h.toString()).div(10**u.decimals).toDecimalPlaces(u.decimals).toString());let x=null;!b.isZero()&&!g.isZero()&&(x=new C(g.toString()).div(10**l.decimals).div(new C(b.toString()).div(10**u.decimals)),this.logDebug("executionPrice:",`1 ${l.symbol||l.address} \u2248 ${x.toDecimalPlaces(Math.max(e.mintA.decimals,e.mintB.decimals)).toString()} ${u.symbol||u.address}`),this.logDebug("executionPrice invert:",`1 ${l.symbol||l.address} \u2248 ${new C(1).div(x).toDecimalPlaces(Math.max(e.mintA.decimals,e.mintB.decimals)).toString()} ${u.symbol||u.address}`));let T=f.mul(k.toString()),B=T.sub(t.toString()).abs().div(T);return this.logDebug("priceImpact:",`${B.toString()}%`),{amountIn:k,maxAmountIn:h,currentPrice:f,executionPrice:x,priceImpact:B}}async swap({poolInfo:e,poolKeys:t,amountIn:n,amountOut:o,inputMint:i,fixedSide:s,txVersion:a,config:c,computeBudgetConfig:u,txTipConfig:l,feePayer:d}){let m=this.createTxBuilder(d),{associatedOnly:p=!0,inputUseSolBalance:y=!0,outputUseSolBalance:f=!0}=c||{},[b,g]=i===e.mintA.address?[e.mintA,e.mintB]:[e.mintB,e.mintA],w=y&&b.address===j.toBase58(),k=f&&g.address===j.toBase58(),{account:h,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Mn,mint:new Ue(b.address),owner:this.scope.ownerPubKey,createInfo:w?{payer:this.scope.ownerPubKey,amount:n}:void 0,skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:p});m.addInstruction(x||{}),h||this.logAndCreateError("input token account not found",{token:b.symbol||b.address,tokenAccountIn:h,inputTokenUseSolBalance:w,associatedOnly:p});let{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:Mn,mint:new Ue(g.address),owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:k?!1:p});m.addInstruction(B||{}),T===void 0&&this.logAndCreateError("output token account not found",{token:g.symbol||g.address,tokenAccountOut:T,outputTokenUseSolBalance:k,associatedOnly:p});let S=t||await this.getAmmPoolKeys(e.id),I=4;return e.pooltype.includes("StablePool")&&(I=5),m.addInstruction({instructions:[Rr({version:I,poolKeys:S,userKeys:{tokenAccountIn:h,tokenAccountOut:T,owner:this.scope.ownerPubKey},amountIn:n,amountOut:o,fixedSide:s})],instructionTypes:[I===4?V.AmmV4SwapBaseIn:V.AmmV5SwapBaseIn]}),m.addCustomComputeBudget(u),m.addTipInstruction(l),m.versionBuild({txVersion:a})}async getRpcPoolInfo(e){return(await this.getRpcPoolInfos([e]))[e]}async getRpcPoolInfos(e,t){let n=await Se(this.scope.connection,e.map(u=>({pubkey:new Ue(u)})),t),o={},i=[];for(let u=0;u<e.length;u++){let l=n[u];if(l===null||!l.accountInfo)throw Error("fetch pool info error: "+String(e[u]));let d=zn.decode(l.accountInfo.data);o[String(e[u])]={...d,programId:l.accountInfo.owner},i.push(d.baseVault,d.quoteVault)}let s={},a=await Se(this.scope.connection,i.map(u=>({pubkey:new Ue(u)})),t);for(let u=0;u<i.length;u++){let l=a[u].accountInfo;if(l===null)throw Error("fetch vault info error: "+i[u]);s[String(i[u])]=new Ve(hf.decode(l.data).amount.toString())}let c={};for(let[u,l]of Object.entries(o)){let d=s[l.baseVault.toString()].sub(l.baseNeedTakePnl),m=s[l.quoteVault.toString()].sub(l.quoteNeedTakePnl);c[u]={...l,baseReserve:d,mintAAmount:s[l.baseVault.toString()],mintBAmount:s[l.quoteVault.toString()],quoteReserve:m,poolPrice:new C(m.toString()).div(new C(10).pow(l.quoteDecimal.toString())).div(new C(d.toString()).div(new C(10).pow(l.baseDecimal.toString())))}}return c}async getPoolInfoFromRpc({poolId:e}){let t=await this.getRpcPoolInfo(e),n=Or({[e]:t}),o=n[e],i=await this.scope.tradeV2.computePoolToPoolKeys({pools:[n[e]],ammRpcData:{[e]:t}});return{poolRpcData:t,poolInfo:o,poolKeys:i[0]}}};import{PublicKey as z}from"@solana/web3.js";import Bt from"bn.js";import{AccountLayout as ol,TOKEN_2022_PROGRAM_ID as En,TOKEN_PROGRAM_ID as wi}from"@solana/spl-token";var ki=class extends Re{constructor(e){super(e)}async getClmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async createPool(e){let{programId:t,owner:n=this.scope.owner?.publicKey||z.default,mint1:o,mint2:i,ammConfig:s,initialPrice:a,computeBudgetConfig:c,forerunCreate:u,getObserveState:l,txVersion:d,txTipConfig:m,feePayer:p}=e,y=this.createTxBuilder(p),[f,b,g]=new Bt(new z(o.address).toBuffer()).gt(new Bt(new z(i.address).toBuffer()))?[i,o,new C(1).div(a)]:[o,i,a],w=ne.priceToSqrtPriceX64(g,f.decimals,b.decimals),k=[],h=[];f.programId===En.toBase58()&&h.push(ca(t,new z(f.address)).publicKey),b.programId===En.toBase58()&&h.push(ca(t,new z(b.address)).publicKey),(await this.scope.connection.getMultipleAccountsInfo(h)).forEach((B,S)=>{B&&k.push(h[S])});let T=await Be.createPoolInstructions({connection:this.scope.connection,programId:t,owner:n,mintA:f,mintB:b,ammConfigId:s.id,initialPriceX64:w,forerunCreate:!l&&u,extendMintAccount:k});return y.addInstruction(T),y.addCustomComputeBudget(c),y.addTipInstruction(m),y.versionBuild({txVersion:d,extInfo:{address:{...T.address,observationId:T.address.observationId.toBase58(),exBitmapAccount:T.address.exBitmapAccount.toBase58(),programId:t.toString(),id:T.address.poolId.toString(),mintA:f,mintB:b,openTime:"0",vault:{A:T.address.mintAVault.toString(),B:T.address.mintBVault.toString()},rewardInfos:[],config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}},mockPoolInfo:{type:"Concentrated",rewardDefaultPoolInfos:"Clmm",id:T.address.poolId.toString(),mintA:f,mintB:b,feeRate:s.tradeFeeRate,openTime:"0",programId:t.toString(),price:g.toNumber(),config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]},burnPercent:0,...hc},forerunCreate:u}})}async openPositionFromBase({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:i,base:s,baseAmount:a,otherAmountMax:c,nft2022:u,associatedOnly:l=!0,checkCreateATAOwner:d=!1,withMetadata:m="create",getEphemeralSigners:p,computeBudgetConfig:y,txTipConfig:f,txVersion:b,feePayer:g}){this.scope.availability.addConcentratedPosition===!1&&this.logAndCreateError("add position feature disabled in your region"),this.scope.checkOwner();let w=this.createTxBuilder(g),k=null,h=null,x=n.useSOLBalance&&e.mintA.address===j.toString(),T=n.useSOLBalance&&e.mintB.address===j.toString(),[B,S]=s==="MintA"?[a,c]:[c,a],{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new z(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:x||B.isZero()?{payer:this.scope.ownerPubKey,amount:B}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:x?!1:l,checkCreateATAOwner:d});I&&(k=I),w.addInstruction(K||{});let{account:N,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new z(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:T||S.isZero()?{payer:this.scope.ownerPubKey,amount:S}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:T?!1:l,checkCreateATAOwner:d});N&&(h=N),w.addInstruction(v||{}),(!k||!h)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",{ownerTokenAccountA:k?.toBase58(),ownerTokenAccountB:h?.toBase58()});let _=t||await this.getClmmPoolKeys(e.id),D=await Be.openPositionFromBaseInstructions({poolInfo:e,poolKeys:_,ownerInfo:{...n,feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:k,tokenAccountB:h},tickLower:o,tickUpper:i,base:s,baseAmount:a,otherAmountMax:c,withMetadata:m,getEphemeralSigners:p,nft2022:u});return w.addInstruction(D),w.addCustomComputeBudget(y),w.addTipInstruction(f),w.versionBuild({txVersion:b,extInfo:{...D.address}})}async openPositionFromLiquidity({poolInfo:e,poolKeys:t,ownerInfo:n,amountMaxA:o,amountMaxB:i,tickLower:s,tickUpper:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,withMetadata:d="create",txVersion:m,computeBudgetConfig:p,txTipConfig:y,getEphemeralSigners:f,nft2022:b,feePayer:g}){this.scope.availability.createConcentratedPosition===!1&&this.logAndCreateError("open position feature disabled in your region");let w=this.createTxBuilder(g),k=null,h=null,x=n.useSOLBalance&&e.mintA.address===j.toBase58(),T=n.useSOLBalance&&e.mintB.address===j.toBase58(),{account:B,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new z(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:x||o.isZero()?{payer:this.scope.ownerPubKey,amount:o}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:x?!1:u,checkCreateATAOwner:l});B&&(k=B),w.addInstruction(S||{});let{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new z(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:T||i.isZero()?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:T?!1:u,checkCreateATAOwner:l});I&&(h=I),w.addInstruction(K||{}),(k===void 0||h===void 0)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let N=t||await this.getClmmPoolKeys(e.id),v=await Be.openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:N,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:k,tokenAccountB:h},tickLower:s,tickUpper:a,liquidity:c,amountMaxA:o,amountMaxB:i,withMetadata:d,getEphemeralSigners:f,nft2022:b});return w.addInstruction(v),w.addCustomComputeBudget(p),w.addTipInstruction(y),w.versionBuild({txVersion:m,extInfo:{address:v.address}})}async increasePositionFromLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:o,amountMaxA:i,amountMaxB:s,liquidity:a,ownerInfo:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:d,txTipConfig:m,txVersion:p,feePayer:y}=e,f=this.createTxBuilder(y),b,g,w=c.useSOLBalance&&t.mintA.address===j.toString(),k=c.useSOLBalance&&t.mintB.address===j.toString(),{account:h,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,createInfo:w||i.isZero()?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!w,associatedOnly:w?!1:u,checkCreateATAOwner:l});h&&(b=h),f.addInstruction(x||{});let{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:k||s.isZero()?{payer:this.scope.ownerPubKey,amount:s}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:u,checkCreateATAOwner:l});T&&(g=T),f.addInstruction(B||{}),!b&&!g&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let S=n??await this.getClmmPoolKeys(t.id),I=Be.increasePositionFromLiquidityInstructions({poolInfo:t,poolKeys:S,ownerPosition:o,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g},liquidity:a,amountMaxA:i,amountMaxB:s,nft2022:(await this.scope.connection.getAccountInfo(o.nftMint))?.owner.equals(En)});return f.addInstruction(I),f.addCustomComputeBudget(d),f.addTipInstruction(m),f.versionBuild({txVersion:p,extInfo:{address:I.address}})}async increasePositionFromBase(e){let{poolInfo:t,ownerPosition:n,base:o,baseAmount:i,otherAmountMax:s,ownerInfo:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:d,txVersion:m,feePayer:p}=e,y=this.createTxBuilder(p),f,b,g=a.useSOLBalance&&t.mintA.address===j.toString(),w=a.useSOLBalance&&t.mintB.address===j.toString(),{account:k,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:g||(o==="MintA"?i:s).isZero()?{payer:this.scope.ownerPubKey,amount:o==="MintA"?i:s}:void 0,skipCloseAccount:!g,associatedOnly:g?!1:c,checkCreateATAOwner:u});k&&(f=k),y.addInstruction(h||{});let{account:x,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:w||(o==="MintA"?s:i).isZero()?{payer:this.scope.ownerPubKey,amount:o==="MintA"?s:i}:void 0,notUseTokenAccount:w,skipCloseAccount:!w,associatedOnly:w?!1:c,checkCreateATAOwner:u});x&&(b=x),y.addInstruction(T||{}),!f&&!b&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let B=await this.getClmmPoolKeys(t.id),S=Be.increasePositionFromBaseInstructions({poolInfo:t,poolKeys:B,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:b},base:o,baseAmount:i,otherAmountMax:s,nft2022:(await this.scope.connection.getAccountInfo(n.nftMint))?.owner.equals(En)});return y.addInstruction(S),y.addCustomComputeBudget(l),y.addTipInstruction(d),y.versionBuild({txVersion:m,extInfo:{address:S.address}})}async decreaseLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:o,ownerInfo:i,amountMinA:s,amountMinB:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:d,txTipConfig:m,txVersion:p,feePayer:y}=e;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let f=this.createTxBuilder(y),b=i.useSOLBalance&&t.mintA.address===j.toString(),g=i.useSOLBalance&&t.mintB.address===j.toString(),w,k,{account:h,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:l});w=h,x&&f.addInstruction(x);let{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!g,associatedOnly:g?!1:u,checkCreateATAOwner:l});k=T,B&&f.addInstruction(B);let S=[];for(let _ of t.rewardDefaultInfos){let D=i.useSOLBalance&&_.mint.address===j.toString(),q;if(_.mint.address===t.mintA.address)q=w;else if(_.mint.address===t.mintB.address)q=k;else{let{account:G,instructionParams:Y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(_.mint.programId),mint:new z(_.mint.address),notUseTokenAccount:D,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!D,associatedOnly:D?!1:u,checkCreateATAOwner:l});q=G,Y&&f.addInstruction(Y)}S.push(q)}!w&&!k&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccountRawInfos);let I=n??await this.getClmmPoolKeys(t.id),K=(await this.scope.connection.getAccountInfo(o.nftMint))?.owner.equals(En),N=await Be.decreaseLiquidityInstructions({poolInfo:t,poolKeys:I,ownerPosition:o,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:w,tokenAccountB:k,rewardAccounts:S},liquidity:c,amountMinA:s,amountMinB:a,nft2022:K});f.addInstruction({instructions:N.instructions,instructionTypes:[V.ClmmDecreasePosition]});let v={...N.address};if(i.closePosition){let _=await Be.closePositionInstructions({poolInfo:t,poolKeys:I,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:o,nft2022:K});f.addInstruction({endInstructions:_.instructions,endInstructionTypes:_.instructionTypes}),v={...v,..._.address}}return f.addCustomComputeBudget(d),f.addTipInstruction(m),f.versionBuild({txVersion:p,extInfo:{address:v}})}async lockPosition(e){let{programId:t=co,authProgramId:n=Fo,poolProgramId:o=Sn,ownerPosition:i,payer:s,computeBudgetConfig:a,txTipConfig:c,txVersion:u,getEphemeralSigners:l,feePayer:d}=e,m=this.createTxBuilder(d),p=await Be.makeLockPositions({programId:t,authProgramId:n,poolProgramId:o,wallet:this.scope.ownerPubKey,payer:s??this.scope.ownerPubKey,nftMint:i.nftMint,getEphemeralSigners:l,nft2022:(await this.scope.connection.getAccountInfo(i.nftMint))?.owner.equals(En)});return m.addInstruction(p),m.addCustomComputeBudget(a),m.addTipInstruction(c),m.versionBuild({txVersion:u,extInfo:p.address})}async harvestLockPosition(e){let{programId:t=co,authProgramId:n=Fo,clmmProgram:o=Sn,poolKeys:i,lockData:s,ownerInfo:a={useSOLBalance:!0},associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:d,txVersion:m,feePayer:p}=e,y=i||await this.getClmmPoolKeys(s.poolId.toString()),f=this.createTxBuilder(p),b=await this.scope.connection.getAccountInfo(s.positionId);b||this.logger.logWithError("position not found",s.positionId);let g=di.decode(b.data),w=a.useSOLBalance&&y.mintA.address===j.toString(),k=a.useSOLBalance&&y.mintB.address===j.toString(),h,x,{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.mintA.programId,mint:new z(y.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!w,associatedOnly:w?!1:c,checkCreateATAOwner:u});h=T,B&&f.addInstruction(B);let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.mintB.programId,mint:new z(y.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!k,associatedOnly:k?!1:c,checkCreateATAOwner:u});x=S,I&&f.addInstruction(I);let K={},N=[];for(let ge of y.rewardInfos){let rt=a.useSOLBalance&&ge.mint.address===j.toString(),st=K[ge.mint.address];if(!st){let{account:je,instructionParams:At}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(ge.mint.programId),mint:new z(ge.mint.address),notUseTokenAccount:rt,owner:this.scope.ownerPubKey,skipCloseAccount:!rt,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:rt?!1:c});st=je,At&&f.addInstruction(At)}K[ge.mint.address]=st,N.push(st)}let v=ui(t,s.lockNftMint).publicKey,_=Z(this.scope.ownerPubKey,s.lockNftMint,wi).publicKey,D=H.getTickArrayStartIndexByTick(g.tickLower,y.config.tickSpacing),q=H.getTickArrayStartIndexByTick(g.tickUpper,y.config.tickSpacing),{publicKey:G}=fe(new z(y.programId),s.poolId,D),{publicKey:Y}=fe(new z(y.programId),s.poolId,q),{publicKey:ie}=Zt(new z(y.programId),s.poolId,g.tickLower,g.tickUpper),ke=[];for(let ge=0;ge<y.rewardInfos.length;ge++)ke.push({poolRewardVault:new z(y.rewardInfos[ge].vault),ownerRewardVault:N[ge],rewardMint:new z(y.rewardInfos[ge].mint.address)});let re=await Be.harvestLockPositionInstructionV2({programId:t,auth:n,lockPositionId:v,clmmProgram:o,lockOwner:this.scope.ownerPubKey,lockNftMint:s.lockNftMint,lockNftAccount:_,positionNftAccount:s.nftAccount,positionId:s.positionId,poolId:s.poolId,protocolPosition:ie,vaultA:new z(y.vault.A),vaultB:new z(y.vault.B),tickArrayLower:G,tickArrayUpper:Y,userVaultA:h,userVaultB:x,mintA:new z(y.mintA.address),mintB:new z(y.mintB.address),rewardAccounts:ke,exTickArrayBitmap:De(o,s.poolId).publicKey});return f.addInstruction({instructions:[re],instructionTypes:[V.ClmmHarvestLockPosition]}),f.addCustomComputeBudget(l),f.addTipInstruction(d),f.versionBuild({txVersion:m})}async closePosition({poolInfo:e,poolKeys:t,ownerPosition:n,txVersion:o,computeBudgetConfig:i,txTipConfig:s,feePayer:a}){this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let c=this.createTxBuilder(a),u=t??await this.getClmmPoolKeys(e.id),l=Be.closePositionInstructions({poolInfo:e,poolKeys:u,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:n,nft2022:(await this.scope.connection.getAccountInfo(n.nftMint))?.owner.equals(En)});return c.addCustomComputeBudget(i),c.addTipInstruction(s),c.addInstruction(l).versionBuild({txVersion:o,extInfo:{address:l.address}})}async initReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:o=!0,checkCreateATAOwner:i=!1,computeBudgetConfig:s,txVersion:a,feePayer:c}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(c),l=t.useSOLBalance&&n.mint.address.toString()===j.toString(),d=n.perSecond.mul(n.endTime-n.openTime),{account:m,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(n.mint.address),mint:new z(n.mint.address),notUseTokenAccount:!!l,skipCloseAccount:!l,owner:this.scope.ownerPubKey,createInfo:l?{payer:t.feePayer||this.scope.ownerPubKey,amount:new Bt(new C(d.toFixed(0)).gte(d)?d.toFixed(0):d.add(1).toFixed(0))}:void 0,associatedOnly:l?!1:o,checkCreateATAOwner:i});p&&u.addInstruction(p),m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let y=await this.getClmmPoolKeys(e.id),f=Be.initRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardInfo:{programId:new z(n.mint.programId),mint:new z(n.mint.address),openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ae.decimalToX64(n.perSecond)}});return u.addInstruction(f),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:f.address}})}async initRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:o,associatedOnly:i=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){for(let p of o)p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let d=this.createTxBuilder(l),m={};for(let p of o){let y=n.useSOLBalance&&p.mint.address===j.toString(),f=p.perSecond.mul(p.endTime-p.openTime),{account:b,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(p.mint.programId),mint:new z(p.mint.address),notUseTokenAccount:!!y,skipCloseAccount:!y,owner:this.scope.ownerPubKey,createInfo:y?{payer:n.feePayer||this.scope.ownerPubKey,amount:new Bt(new C(f.toFixed(0)).gte(f)?f.toFixed(0):f.add(1).toFixed(0))}:void 0,associatedOnly:y?!1:i,checkCreateATAOwner:s});g&&d.addInstruction(g),b||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let w=t??await this.getClmmPoolKeys(e.id),k=Be.initRewardInstructions({poolInfo:e,poolKeys:w,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:b},rewardInfo:{programId:new z(p.mint.programId),mint:new z(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:ae.decimalToX64(p.perSecond)}});m={...m,...k.address},d.addInstruction(k)}return d.addCustomComputeBudget(a),d.addTipInstruction(c),d.versionBuild({txVersion:u,extInfo:{address:m}})}async setReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:o=!0,checkCreateATAOwner:i=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let l=this.createTxBuilder(u),d=t.useSOLBalance&&n.mint.equals(j),{account:m,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n.programId,mint:n.mint,notUseTokenAccount:d,owner:this.scope.ownerPubKey,createInfo:d?{payer:t.feePayer||this.scope.ownerPubKey,amount:new Bt(new C(n.perSecond.mul(n.endTime-n.openTime).toFixed(0)).gte(n.perSecond.mul(n.endTime-n.openTime))?n.perSecond.mul(n.endTime-n.openTime).toFixed(0):n.perSecond.mul(n.endTime-n.openTime).add(1).toFixed(0))}:void 0,associatedOnly:d?!1:o,checkCreateATAOwner:i});p&&l.addInstruction(p),m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let y=await this.getClmmPoolKeys(e.id),f=Be.setRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardInfo:{mint:n.mint,openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ae.decimalToX64(n.perSecond)}});return l.addInstruction(f),l.addCustomComputeBudget(s),l.addTipInstruction(a),l.versionBuild({txVersion:c,extInfo:{address:f.address}})}async setRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:o,associatedOnly:i=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){let d=this.createTxBuilder(l),m={};for(let p of o){p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let y=n.useSOLBalance&&p.mint.address===j.toString(),{account:f,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(p.mint.programId),mint:new z(p.mint.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:y?{payer:n.feePayer||this.scope.ownerPubKey,amount:new Bt(new C(p.perSecond.mul(p.endTime-p.openTime).toFixed(0)).gte(p.perSecond.mul(p.endTime-p.openTime))?p.perSecond.mul(p.endTime-p.openTime).toFixed(0):p.perSecond.mul(p.endTime-p.openTime).add(1).toFixed(0))}:void 0,associatedOnly:y?!1:i,checkCreateATAOwner:s});b&&d.addInstruction(b),f||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let g=t??await this.getClmmPoolKeys(e.id),w=Be.setRewardInstructions({poolInfo:e,poolKeys:g,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:f},rewardInfo:{mint:new z(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:ae.decimalToX64(p.perSecond)}});d.addInstruction(w),m={...m,...w.address}}return d.addCustomComputeBudget(a),d.addTipInstruction(c),d.versionBuild({txVersion:u,extInfo:{address:m}})}async collectReward({poolInfo:e,ownerInfo:t,rewardMint:n,associatedOnly:o=!0,checkCreateATAOwner:i=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){let l=e.rewardDefaultInfos.find(g=>g.mint.address===n.toString());l||this.logAndCreateError("reward mint error","not found reward mint",n);let d=this.createTxBuilder(u),m=t.useSOLBalance&&n.equals(j),{account:p,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(l.mint.programId),mint:n,notUseTokenAccount:m,owner:this.scope.ownerPubKey,skipCloseAccount:!m,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:m?!1:o,checkCreateATAOwner:i});y&&d.addInstruction(y),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=await this.getClmmPoolKeys(e.id),b=Be.collectRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardMint:n});return d.addInstruction(b),d.addCustomComputeBudget(s),d.addTipInstruction(a),d.versionBuild({txVersion:c,extInfo:{address:b.address}})}async collectRewards({poolInfo:e,ownerInfo:t,rewardMints:n,associatedOnly:o=!0,checkCreateATAOwner:i=!1,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l={};for(let d of n){let m=e.rewardDefaultInfos.find(w=>w.mint.address===d.toString());if(!m){this.logAndCreateError("reward mint error","not found reward mint",d);continue}let p=t.useSOLBalance&&d.equals(j),{account:y,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(m.mint.programId),mint:d,notUseTokenAccount:p,owner:this.scope.ownerPubKey,skipCloseAccount:!p,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:p?!1:o,checkCreateATAOwner:i});y||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos),f&&u.addInstruction(f);let b=await this.getClmmPoolKeys(e.id),g=Be.collectRewardInstructions({poolInfo:e,poolKeys:b,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:y},rewardMint:d});u.addInstruction(g),l={...l,...g.address}}return u.addCustomComputeBudget(s),u.addTipInstruction(a),u.build({address:l})}async swap({poolInfo:e,poolKeys:t,inputMint:n,amountIn:o,amountOutMin:i,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:d=!1,txVersion:m,computeBudgetConfig:p,txTipConfig:y,feePayer:f}){let b=this.createTxBuilder(f),g=n.toString()===e.mintA.address,w=c.useSOLBalance&&e.mintA.address===j.toBase58(),k=c.useSOLBalance&&e.mintB.address===j.toBase58(),h;!s||s.equals(new C(0))?h=g?Et.add(new Bt(1)):_t.sub(new Bt(1)):h=ne.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let x;if(!x){let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new z(e.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,skipCloseAccount:!w,createInfo:w||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?o:0}:void 0,associatedOnly:w?!1:l,checkCreateATAOwner:d});x=S,I&&b.addInstruction(I)}let T;if(!T){let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new z(e.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,skipCloseAccount:!k,createInfo:k||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:o}:void 0,associatedOnly:k?!1:l,checkCreateATAOwner:d});T=S,I&&b.addInstruction(I)}(!x||!T)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:x,ownerTokenAccountB:T,mintAUseSOLBalance:w,mintBUseSOLBalance:k,associatedOnly:l});let B=t??await this.getClmmPoolKeys(e.id);return b.addInstruction(Be.makeSwapBaseInInstructions({poolInfo:e,poolKeys:B,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:x,tokenAccountB:T},inputMint:new z(n),amountIn:o,amountOutMin:i,sqrtPriceLimitX64:h,remainingAccounts:u})),b.addCustomComputeBudget(p),b.addTipInstruction(y),b.versionBuild({txVersion:m})}async swapBaseOut({poolInfo:e,poolKeys:t,outputMint:n,amountOut:o,amountInMax:i,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:d=!1,txVersion:m,computeBudgetConfig:p,txTipConfig:y,feePayer:f}){let b=this.createTxBuilder(f),g=n.toString()===e.mintB.address,w=c.useSOLBalance&&e.mintA.address===j.toBase58(),k=c.useSOLBalance&&e.mintB.address===j.toBase58(),h;!s||s.equals(new C(0))?h=n.toString()===e.mintB.address?Et.add(new Bt(1)):_t.sub(new Bt(1)):h=ne.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let x;if(!x){let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new z(e.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,skipCloseAccount:!w,createInfo:w||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?i:0}:void 0,associatedOnly:w?!1:l,checkCreateATAOwner:d});x=S,I&&b.addInstruction(I)}let T;if(!T){let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new z(e.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,skipCloseAccount:!k,createInfo:k||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:i}:void 0,associatedOnly:k?!1:l,checkCreateATAOwner:d});T=S,I&&b.addInstruction(I)}(!x||!T)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:x,ownerTokenAccountB:T,mintAUseSOLBalance:w,mintBUseSOLBalance:k,associatedOnly:l});let B=t??await this.getClmmPoolKeys(e.id);return b.addInstruction(Be.makeSwapBaseOutInstructions({poolInfo:e,poolKeys:B,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:x,tokenAccountB:T},outputMint:new z(n),amountOut:o,amountInMax:i,sqrtPriceLimitX64:h,remainingAccounts:u})),b.addCustomComputeBudget(p),b.addTipInstruction(y),b.versionBuild({txVersion:m})}async harvestAllRewards({allPoolInfo:e,allPositions:t,lockInfo:n,ownerInfo:o,associatedOnly:i=!0,checkCreateATAOwner:s=!1,programId:a,txVersion:c,computeBudgetConfig:u,feePayer:l}){let d={};for(let b of this.scope.account.tokenAccountRawInfos)i?Z(this.scope.ownerPubKey,b.accountInfo.mint,a).publicKey.equals(b.pubkey)&&(d[b.accountInfo.mint.toString()]=b.pubkey):d[b.accountInfo.mint.toString()]=b.pubkey;let m=Object.values(t).flat().map(b=>b.nftMint),p=await Se(this.scope.connection,m.map(b=>({pubkey:b}))),y={};p.forEach(b=>{y[b.pubkey.toBase58()]=b?.accountInfo?.owner??null});let f=this.createTxBuilder(l);for(let b of Object.values(e)){if(t[b.id]===void 0||!t[b.id].find(I=>!I.liquidity.isZero()||I.rewardInfos.find(K=>!K.rewardAmountOwed.isZero())))continue;let g=b,w=o.useSOLBalance&&g.mintA.address===j.toString(),k=o.useSOLBalance&&g.mintB.address===j.toString(),h=d[g.mintA.address];if(!h){let{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:g.mintA.programId,mint:new z(g.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,skipCloseAccount:!w,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:w?!1:i,checkCreateATAOwner:s});h=I,K&&f.addInstruction(K)}let x=d[g.mintB.address];if(!x){let{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:g.mintB.programId,mint:new z(g.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,skipCloseAccount:!k,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:k?!1:i,checkCreateATAOwner:s});x=I,K&&f.addInstruction(K)}d[g.mintA.address]=h,d[g.mintB.address]=x;let T=[];for(let I of g.rewardDefaultInfos){let K=o.useSOLBalance&&I.mint.address===j.toString(),N=d[I.mint.address];if(!N){let{account:v,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(I.mint.programId),mint:new z(I.mint.address),notUseTokenAccount:K,owner:this.scope.ownerPubKey,skipCloseAccount:!K,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:K?!1:i});N=v,_&&f.addInstruction(_)}d[I.mint.address]=N,T.push(N)}let B=await this.getClmmPoolKeys(g.id),S=[];for(let I=0;I<B.rewardInfos.length;I++)S.push({poolRewardVault:new z(B.rewardInfos[I].vault),ownerRewardVault:T[I],rewardMint:new z(B.rewardInfos[I].mint.address)});for(let I of t[b.id]){let K=n?.[b.id]?.[I.nftMint.toBase58()];if(K){let N=Z(this.scope.ownerPubKey,K.lockNftMint,wi).publicKey,v=H.getTickArrayStartIndexByTick(I.tickLower,B.config.tickSpacing),_=H.getTickArrayStartIndexByTick(I.tickUpper,B.config.tickSpacing),{publicKey:D}=fe(new z(B.programId),K.poolId,v),{publicKey:q}=fe(new z(B.programId),K.poolId,_),{publicKey:G}=Zt(new z(B.programId),K.poolId,I.tickLower,I.tickUpper),Y=ui(co,K.lockNftMint).publicKey,ie=Be.harvestLockPositionInstructionV2({programId:co,auth:Fo,lockPositionId:Y,clmmProgram:Sn,lockOwner:this.scope.ownerPubKey,lockNftMint:K.lockNftMint,lockNftAccount:N,positionNftAccount:K.nftAccount,positionId:K.positionId,poolId:K.poolId,protocolPosition:G,vaultA:new z(B.vault.A),vaultB:new z(B.vault.B),tickArrayLower:D,tickArrayUpper:q,userVaultA:h,userVaultB:x,mintA:new z(B.mintA.address),mintB:new z(B.mintB.address),rewardAccounts:S,exTickArrayBitmap:De(Sn,K.poolId).publicKey});f.addInstruction({instructions:[ie],instructionTypes:[V.ClmmHarvestLockPosition],lookupTableAddress:B.lookupTableAccount?[B.lookupTableAccount]:[]})}else{let N=Be.decreaseLiquidityInstructions({poolInfo:g,poolKeys:B,ownerPosition:I,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:h,tokenAccountB:x,rewardAccounts:T},liquidity:new Bt(0),amountMinA:new Bt(0),amountMinB:new Bt(0),nft2022:y[I.nftMint.toBase58()]?.equals(En)});f.addInstruction(N)}}}return c===0?f.sizeCheckBuildV0({computeBudgetConfig:u}):f.sizeCheckBuild({computeBudgetConfig:u})}async getWhiteListMint({programId:e}){let t=await this.scope.connection.getAccountInfo(ai(e).publicKey);return t?Mc.decode(t.data).whitelistMints.filter(o=>!o.equals(z.default)):[]}async getOwnerPositionInfo({programId:e}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(s=>s.accountInfo.amount.eq(new Bt(1))).map(s=>Pt(new z(e),s.accountInfo.mint).publicKey),o=await this.scope.connection.getMultipleAccountsInfo(n),i=[];return o.forEach(s=>{if(!s)return;let a=di.decode(s.data);i.push(a)}),i}async getRpcClmmPoolInfo({poolId:e}){return(await this.getRpcClmmPoolInfos({poolIds:[e]}))[String(e)]}async getRpcClmmPoolInfos({poolIds:e,config:t}){let n=await Se(this.scope.connection,e.map(i=>({pubkey:new z(i)})),t),o={};for(let i=0;i<e.length;i++){let s=n[i];if(s===null||!s.accountInfo)throw Error("fetch pool info error: "+String(e[i]));let a=Xn.decode(s.accountInfo.data),c=ne.sqrtPriceX64ToPrice(a.sqrtPriceX64,a.mintDecimalsA,a.mintDecimalsB).toNumber();o[String(e[i])]={...a,currentPrice:c,programId:s.accountInfo.owner}}return o}async getComputeClmmPoolInfos({clmmPoolsRpcInfo:e,mintInfos:t}){let n=new Set(Object.keys(e).map(c=>e[c].ammConfig.toBase58())),o=await Se(this.scope.connection,Array.from(n).map(c=>({pubkey:new z(c)}))),i={};o.forEach(c=>{!c.accountInfo||(i[c.pubkey.toBase58()]=Oc.decode(c.accountInfo.data))});let s=await Ce.fetchComputeMultipleClmmInfo({connection:this.scope.connection,rpcDataMap:e,poolList:Object.keys(e).map(c=>{let[u,l]=[e[c].mintA.toBase58(),e[c].mintB.toBase58()];return{id:c,programId:e[c].programId.toBase58(),mintA:dt({address:u,decimals:e[c].mintDecimalsA,programId:t[u].programId.toBase58()||wi.toBase58(),extensions:{feeConfig:t[u]?.feeConfig?vn(t[u]?.feeConfig):void 0}}),mintB:dt({address:l,decimals:e[c].mintDecimalsB,programId:t[l].programId.toBase58()||wi.toBase58(),extensions:{feeConfig:t[l]?.feeConfig?vn(t[l]?.feeConfig):void 0}}),price:e[c].currentPrice,config:{...i[e[c].ammConfig.toBase58()],id:e[c].ammConfig.toBase58(),fundFeeRate:0,description:"",defaultRange:0,defaultRangePoint:[]}}})}),a=await Ce.fetchMultiplePoolTickArrays({connection:this.scope.connection,poolKeys:Object.values(s)});return{computeClmmPoolInfo:s,computePoolTickData:a}}async getPoolInfoFromRpc(e){let t=await this.getRpcClmmPoolInfo({poolId:e}),n=new Set([t.mintA.toBase58(),t.mintB.toBase58()]),o=await oo({connection:this.scope.connection,mints:Array.from(n).map(l=>new z(l))}),{computeClmmPoolInfo:i,computePoolTickData:s}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:{[e]:t},mintInfos:o}),a=await Se(this.scope.connection,[{pubkey:t.vaultA},{pubkey:t.vaultB}]),c=Rc(i[e]);if(!a[0].accountInfo||!a[1].accountInfo)throw new Error("pool vault data not found");c.mintAmountA=Number(ol.decode(a[0].accountInfo.data).amount.toString()),c.mintAmountB=Number(ol.decode(a[1].accountInfo?.data).amount.toString());let u={...i[e],exBitmapAccount:i[e].exBitmapAccount.toBase58(),observationId:i[e].observationId.toBase58(),id:e,programId:t.programId.toBase58(),openTime:t.startTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},config:c.config,rewardInfos:i[e].rewardInfos.filter(l=>!l.tokenVault.equals(z.default)).map(l=>({mint:dt({address:l.tokenMint.toBase58(),programId:wi.toBase58(),decimals:10}),vault:l.tokenVault.toBase58()}))};return{poolInfo:c,poolKeys:u,computePoolInfo:i[e],tickData:s}}};import{PublicKey as X}from"@solana/web3.js";import{AccountLayout as Na,createAssociatedTokenAccountIdempotentInstruction as fl,getAssociatedTokenAddressSync as yl,NATIVE_MINT as Bo,TOKEN_PROGRAM_ID as Ot}from"@solana/spl-token";import Ka from"bn.js";import Vr from"decimal.js-light";import hi from"bn.js";function Er(r,e){if(e.isZero())throw Error("divisor is zero");return r.mod(e)}function Tf(r,e){if(e.isZero())throw Error("rhs is zero");let t=r.div(e);if(t.isZero())throw Error("quotient is zero");let n=Er(r,e);return n.gt(To)&&(t=t.add(new hi(1)),e=r.div(t),n=Er(r,t),n.gt(To)&&(e=e.add(new hi(1)))),[t,e]}var To=new hi(0),_r=class{static swapWithoutFees(e,t,n){let o=t.mul(n),i=t.add(e),[s]=Tf(o,i),a=n.sub(s);if(a.isZero())throw Error("destinationAmountSwapped is zero");return{destinationAmountSwapped:a}}static lpTokensToTradingTokens(e,t,n,o,i){let s=e.mul(n).div(t),a=e.mul(o).div(t);if(i===0)return{tokenAmount0:s,tokenAmount1:a};if(i===1)return Er(e.mul(n),t).gt(To)&&s.gt(To)&&(s=s.add(new hi(1))),Er(e.mul(o),t).gt(To)&&a.gt(To)&&(a=a.add(new hi(1))),{tokenAmount0:s,tokenAmount1:a};throw Error("roundDirection value error")}};var Fr=class{static tradingFee(e,t){return Ji(e,t,Qt)}static protocolFee(e,t){return Ts(e,t,Qt)}static fundFee(e,t){return Ts(e,t,Qt)}};var il=(t=>(t[t.Floor=0]="Floor",t[t.Ceiling=1]="Ceiling",t))(il||{}),Wr=class{static validate_supply(e,t){if(e.isZero())throw Error("tokenAmount0 is zero");if(t.isZero())throw Error("tokenAmount1 is zero")}static swap(e,t,n,o){let i=Fr.tradingFee(e,o),s=e.sub(i),{destinationAmountSwapped:a}=_r.swapWithoutFees(s,t,n);return{newSwapDestinationAmount:n.sub(a),sourceAmountSwapped:e,destinationAmountSwapped:a,tradeFee:i}}static swapBaseOut({poolMintA:e,poolMintB:t,tradeFeeRate:n,baseReserve:o,quoteReserve:i,outputMint:s,outputAmount:a}){let[c,u,l,d,m]=t.address===s.toString()?[o,i,e.decimals,t.decimals,e.address]:[i,o,t.decimals,e.decimals,t.address],p=new Vr(u.toString()).div(10**d).div(new Vr(c.toString()).div(10**l)),y=a.gte(u)?u.sub(new Ka(1)):a,f=u.sub(y),b=Kn(c.mul(y),f),g=Kn(b.mul(new Ka(1e6)),new Ka(1e6).sub(n)),w=g.sub(b),k=new Vr(y.toString()).div(10**d).div(new Vr(g.toString()).div(10**l)),h=p.isZero()?0:k.sub(p).div(p).abs().toNumber();return{amountRealOut:y,amountIn:g,amountInWithoutFee:b,tradeFee:w,priceImpact:h}}};import _e from"bn.js";import{PublicKey as Ii,TransactionInstruction as $n,Keypair as Of,SystemProgram as vf}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as al,TOKEN_2022_PROGRAM_ID as La,TOKEN_PROGRAM_ID as _n}from"@solana/spl-token";var If=Buffer.from("vault_and_lp_mint_auth_seed","utf8"),Bf=Buffer.from("amm_config","utf8"),xf=Buffer.from("pool","utf8"),Sf=Buffer.from("pool_lp_mint","utf8"),Kf=Buffer.from("pool_vault","utf8"),Cf=Buffer.from("observation","utf8");function Io(r){return te([If],r)}function Zx(r,e){return te([Bf,Rf(e)],r)}function Ca(r,e,t,n){return te([xf,e.toBuffer(),t.toBuffer(),n.toBuffer()],r)}function Lf(r,e){return te([Sf,e.toBuffer()],r)}function rl(r,e,t){return te([Kf,e.toBuffer(),t.toBuffer()],r)}function Ti(r,e){return te([Cf,e.toBuffer()],r)}function Rf(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r,!1),new Uint8Array(e)}function sl({poolId:r,programId:e,configId:t,mintA:n,mintB:o}){let i=Io(e).publicKey,s=r||Ca(e,t,n,o).publicKey,a=Lf(e,s).publicKey,c=rl(e,s,n).publicKey,u=rl(e,s,o).publicKey,l=Ti(e,s).publicKey;return{poolId:s,configId:t,authority:i,lpMint:a,vaultA:c,vaultB:u,observationId:l}}var Nf=Buffer.from("locked_liquidity","utf8");function Dr(r,e){return te([Nf,e.toBuffer()],r)}var Mf=me("Raydium_cpmm"),Jn={initialize:[175,175,109,31,13,152,155,237],deposit:[242,35,198,137,82,225,242,182],withdraw:[183,18,70,156,148,109,161,34],swapBaseInput:[143,190,90,218,196,30,51,222],swapBaseOutput:[55,217,98,86,163,74,180,173],lockCpLiquidity:[216,157,29,78,38,51,31,26],collectCpFee:[8,30,51,199,209,184,247,133]};function ul(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g,w,k){let h=O([A("amountMaxA"),A("amountMaxB"),A("openTime")]),x=Ca(r,t,i,s).publicKey,T=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!o.equals(x),isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:_n,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:al,isSigner:!1,isWritable:!1},{pubkey:Yi,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1}],B=Buffer.alloc(h.span);return h.encode({amountMaxA:g,amountMaxB:w,openTime:k},B),new $n({keys:T,programId:r,data:Buffer.from([...Jn.initialize,...B])})}function cl(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y){let f=O([A("lpAmount"),A("amountMaxA"),A("amountMaxB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:_n,isSigner:!1,isWritable:!1},{pubkey:La,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!0}],g=Buffer.alloc(f.span);return Mf.debug("cpmm deposit data",{lpAmount:m.toString(),amountMaxA:p.toString(),amountMaxB:y.toString()}),f.encode({lpAmount:m,amountMaxA:p,amountMaxB:y},g),new $n({keys:b,programId:r,data:Buffer.from([...Jn.deposit,...g])})}function ll(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y){let f=O([A("lpAmount"),A("amountMinA"),A("amountMinB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:_n,isSigner:!1,isWritable:!1},{pubkey:La,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:nn,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);return f.encode({lpAmount:m,amountMinA:p,amountMinB:y},g),new $n({keys:b,programId:r,data:Buffer.from([...Jn.withdraw,...g])})}function qr(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y,f){let b=O([A("amountIn"),A("amounOutMin")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],w=Buffer.alloc(b.span);return b.encode({amountIn:y,amounOutMin:f},w),new $n({keys:g,programId:r,data:Buffer.from([...Jn.swapBaseInput,...w])})}function ml(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y,f){let b=O([A("amountInMax"),A("amountOut")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],w=Buffer.alloc(b.span);return b.encode({amountInMax:y,amountOut:f},w),new $n({keys:g,programId:r,data:Buffer.from([...Jn.swapBaseOutput,...w])})}async function dl(r){let{ownerInfo:e,poolInfo:t,poolKeys:n,feeNftOwner:o,getEphemeralSigners:i}=r,s=[],[a,c]=[new Ii(t.id),new Ii(t.lpMint.address)],u;if(i)u=new Ii((await i(1))[0]);else{let b=Of.generate();s.push(b),u=b.publicKey}let{publicKey:l}=Z(o,u,_n),{publicKey:d}=gn(u),{publicKey:m}=Dr(r.lockProgram,u),{publicKey:p}=Z(e.wallet,c,_n),{publicKey:y}=Z(r.lockAuthProgram,c,_n),f=Ef({programId:r.lockProgram,auth:r.lockAuthProgram,payer:e.feePayer,liquidityOwner:e.wallet,nftOwner:o,nftMint:u,nftAccount:l,poolId:a,lockPda:m,mintLp:c,userLpVault:p,lockLpVault:y,poolVaultA:new Ii(n.vault.A),poolVaultB:new Ii(n.vault.B),metadataAccount:d,lpAmount:r.lpAmount,withMetadata:r.withMetadata??!0});return{address:{nftMint:u,nftAccount:l,metadataAccount:d,lockPda:m,userLpVault:p,lockLpVault:y},instructions:[f],signers:s,instructionTypes:[V.CpmmLockLp],lookupTableAddress:[]}}function Ef({programId:r,auth:e,payer:t,liquidityOwner:n,nftOwner:o,nftMint:i,nftAccount:s,poolId:a,lockPda:c,mintLp:u,userLpVault:l,lockLpVault:d,poolVaultA:m,poolVaultB:p,metadataAccount:y,lpAmount:f,withMetadata:b}){let g=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:vf.programId,isSigner:!1,isWritable:!1},{pubkey:_n,isSigner:!1,isWritable:!1},{pubkey:al,isSigner:!1,isWritable:!1},{pubkey:qt,isSigner:!1,isWritable:!1}],w=O([A("lpAmount"),Ee("withMetadata")]),k=Buffer.alloc(w.span);w.encode({lpAmount:f,withMetadata:b},k);let h=Buffer.from([...Jn.lockCpLiquidity,...k]);return new $n({keys:g,programId:r,data:h})}function pl({programId:r,nftOwner:e,auth:t,nftAccount:n,lockPda:o,poolId:i,mintLp:s,userVaultA:a,userVaultB:c,poolVaultA:u,poolVaultB:l,mintA:d,mintB:m,lockLpVault:p,lpFeeAmount:y,cpmmProgram:f,cpmmAuthProgram:b}){let g=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:f??Vo,isSigner:!1,isWritable:!1},{pubkey:b??Ss,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:_n,isSigner:!1,isWritable:!1},{pubkey:La,isSigner:!1,isWritable:!1},{pubkey:nn,isSigner:!1,isWritable:!1}],w=O([A("lpFeeAmount")]),k=Buffer.alloc(w.span);w.encode({lpFeeAmount:y},k);let h=Buffer.from([...Jn.collectCpFee,...k]);return new $n({keys:g,programId:r,data:h})}var Ra=O([we(8),F("bump"),Ee("disableCreatePool"),Ht("index"),A("tradeFeeRate"),A("protocolFeeRate"),A("fundFeeRate"),A("createPoolFee"),L("protocolOwner"),L("fundOwner"),Q(A(),16)]),Bi=O([we(8),L("configId"),L("poolCreator"),L("vaultA"),L("vaultB"),L("mintLp"),L("mintA"),L("mintB"),L("mintProgramA"),L("mintProgramB"),L("observationId"),F("bump"),F("status"),F("lpDecimals"),F("mintDecimalA"),F("mintDecimalB"),A("lpAmount"),A("protocolFeesMintA"),A("protocolFeesMintB"),A("fundFeesMintA"),A("fundFeesMintB"),A("openTime"),Q(A(),32)]);var xi=class extends Re{constructor(e){super(e)}async load(){this.checkDisabled()}async getCpmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async getRpcPoolInfo(e,t,n){if(!e&&!t?.marketAccount)throw new Error("Either poolId or accountInfos.marketAccount must be provided");let o=e?(await Se(this.scope.connection,[{pubkey:new X(e)}]))[0]:t.marketAccount;if(!o?.accountInfo){let x=e||t?.marketAccount?.pubkey?.toBase58()||"unknown";throw new Error(`Pool account not found: ${x}`)}let i={...Bi.decode(o.accountInfo.data),programId:o.accountInfo.owner},s=[],a=[i.vaultA,i.vaultB];e&&(s.push(...a.map(x=>({pubkey:new X(x)}))),n&&s.push({pubkey:new X(i.configId)}));let c=[];e&&s.length>0&&(c=await Se(this.scope.connection,s));let u;if(n){let x=e?c[c.length-1]:t?.configState;if(!x?.accountInfo)throw new Error(`Config account not found: ${i.configId}`);u=Ra.decode(x.accountInfo.data)}let l=e?c[0]?.accountInfo:t?.vaultAInfo?.accountInfo,d=e?c[1]?.accountInfo:t?.vaultBInfo?.accountInfo;if(!l||!d)throw new Error(`Vault accounts not found: A=${i.vaultA}, B=${i.vaultB}`);let m=new _e(Na.decode(l.data).amount.toString()),p=new _e(Na.decode(d.data).amount.toString()),y=m.sub(i.protocolFeesMintA).sub(i.fundFeesMintA),f=p.sub(i.protocolFeesMintB).sub(i.fundFeesMintB),b=new C(10).pow(i.mintDecimalA),g=new C(10).pow(i.mintDecimalB),w=new C(y.toString()).div(b),k=new C(f.toString()).div(g),h=w.isZero()?new C(0):k.div(w);return{...i,baseReserve:y,quoteReserve:f,vaultAAmount:m,vaultBAmount:p,configInfo:u,poolPrice:h}}async getRpcPoolInfos(e,t){let n=await Se(this.scope.connection,e.map(d=>({pubkey:new X(d)}))),o={},i=new Set,s=[];for(let d=0;d<e.length;d++){let m=n[d];if(m.accountInfo===null)throw Error("fetch pool info error: "+String(e[d]));let p=Bi.decode(m.accountInfo.data);o[String(e[d])]={...p,programId:m.accountInfo.owner},i.add(String(p.configId)),s.push(p.vaultA,p.vaultB)}let a={};if(t){let d=[...i],m=await Se(this.scope.connection,d.map(p=>({pubkey:new X(p)})));for(let p=0;p<d.length;p++){let y=m[p].accountInfo;if(y===null)throw Error("fetch pool config error: "+d[p]);a[d[p]]=Ra.decode(y.data)}}let c={},u=await Se(this.scope.connection,s.map(d=>({pubkey:new X(d)})));for(let d=0;d<s.length;d++){let m=u[d].accountInfo;if(m===null)throw Error("fetch vault info error: "+s[d]);c[String(s[d])]=new _e(Na.decode(m.data).amount.toString())}let l={};for(let[d,m]of Object.entries(o)){let p=c[m.vaultA.toString()].sub(m.protocolFeesMintA).sub(m.fundFeesMintA),y=c[m.vaultB.toString()].sub(m.protocolFeesMintB).sub(m.fundFeesMintB);l[d]={...m,baseReserve:p,quoteReserve:y,vaultAAmount:c[m.vaultA.toString()],vaultBAmount:c[m.vaultB.toString()],configInfo:a[m.configId.toString()],poolPrice:new C(y.toString()).div(new C(10).pow(m.mintDecimalB)).div(new C(p.toString()).div(new C(10).pow(m.mintDecimalA)))}}return l}toComputePoolInfos({pools:e,mintInfos:t}){return Object.keys(e).reduce((n,o)=>{let i=e[o],[s,a]=[i.mintA.toBase58(),i.mintB.toBase58()];return{...n,[o]:{...i,id:new X(o),configInfo:i.configInfo,version:7,authority:Io(i.programId).publicKey,mintA:dt({address:s,decimals:i.mintDecimalA,programId:i.mintProgramA.toBase58(),extensions:{feeConfig:t[s]?.feeConfig?vn(t[s]?.feeConfig):void 0}}),mintB:dt({address:a,decimals:i.mintDecimalB,programId:i.mintProgramB.toBase58(),extensions:{feeConfig:t[a]?.feeConfig?vn(t[a]?.feeConfig):void 0}})}}},{})}async getPoolInfoFromRpc(e,t,n){t=t||await this.getRpcPoolInfo(e,void 0,!0),n=n||await oo({connection:this.scope.connection,mints:[t.mintA,t.mintB]});let o=dt({address:t.mintA.toBase58(),decimals:t.mintDecimalA,programId:t.mintProgramA.toBase58(),extensions:{feeConfig:n[t.mintA.toBase58()].feeConfig?vn(n[t.mintA.toBase58()].feeConfig):void 0}}),i=dt({address:t.mintB.toBase58(),decimals:t.mintDecimalB,programId:t.mintProgramB.toBase58(),extensions:{feeConfig:n[t.mintB.toBase58()].feeConfig?vn(n[t.mintB.toBase58()].feeConfig):void 0}}),s=dt({address:t.mintLp.toBase58(),decimals:t.lpDecimals,programId:Ot.toBase58()}),a={id:t.configId.toBase58(),index:t.configInfo.index,protocolFeeRate:t.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:t.configInfo.tradeFeeRate.toNumber(),fundFeeRate:t.configInfo.fundFeeRate.toNumber(),createPoolFee:t.configInfo.createPoolFee.toString()},c={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};return{poolInfo:{programId:t.programId.toBase58(),id:e,type:"Standard",lpMint:s,lpPrice:0,lpAmount:t.lpAmount.toNumber(),config:a,mintA:o,mintB:i,rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:t.poolPrice.toNumber(),mintAmountA:new C(t.vaultAAmount.toString()).div(10**o.decimals).toNumber(),mintAmountB:new C(t.vaultBAmount.toString()).div(10**i.decimals).toNumber(),feeRate:t.configInfo.tradeFeeRate.toNumber(),openTime:t.openTime.toString(),tvl:0,burnPercent:0,day:c,week:c,month:c,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0},poolKeys:{programId:t.programId.toBase58(),id:e,mintA:o,mintB:i,openTime:t.openTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},authority:Io(t.programId).publicKey.toBase58(),mintLp:s,config:a,observationId:Ti(t.programId,new X(e)).publicKey.toBase58()},rpcData:t}}async createPool({poolId:e,programId:t,poolFeeAccount:n,startTime:o,ownerInfo:i,associatedOnly:s=!1,checkCreateATAOwner:a=!1,txVersion:c,feeConfig:u,computeBudgetConfig:l,txTipConfig:d,feePayer:m,...p}){let y=i.feePayer||this.scope.owner?.publicKey,f=new _e(new X(p.mintA.address).toBuffer()).lte(new _e(new X(p.mintB.address).toBuffer())),[b,g]=f?[p.mintA,p.mintB]:[p.mintB,p.mintA],[w,k]=f?[p.mintAAmount,p.mintBAmount]:[p.mintBAmount,p.mintAAmount],h=i.useSOLBalance&&b.address===Bo.toBase58(),x=i.useSOLBalance&&g.address===Bo.toBase58(),[T,B]=[new X(b.address),new X(g.address)],S=this.createTxBuilder(m),{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:T,tokenProgram:b.programId,owner:this.scope.ownerPubKey,createInfo:h?{payer:y,amount:w}:void 0,notUseTokenAccount:h,skipCloseAccount:!h,associatedOnly:h?!1:s,checkCreateATAOwner:a});S.addInstruction(K||{});let{account:N,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({mint:new X(g.address),tokenProgram:g.programId,owner:this.scope.ownerPubKey,createInfo:x?{payer:y,amount:k}:void 0,notUseTokenAccount:x,skipCloseAccount:!x,associatedOnly:x?!1:s,checkCreateATAOwner:a});if(S.addInstruction(v||{}),I===void 0||N===void 0)throw Error("you don't has some token account");let _=sl({poolId:e,programId:t,configId:new X(u.id),mintA:T,mintB:B});return S.addInstruction({instructions:[ul(t,this.scope.ownerPubKey,new X(u.id),_.authority,_.poolId,T,B,_.lpMint,I,N,Z(this.scope.ownerPubKey,_.lpMint).publicKey,_.vaultA,_.vaultB,n,new X(b.programId??Ot),new X(g.programId??Ot),_.observationId,w,k,o)],instructionTypes:[V.CpmmCreatePool]}),S.addCustomComputeBudget(l),S.addTipInstruction(d),S.versionBuild({txVersion:c,extInfo:{address:{..._,mintA:b,mintB:g,programId:t,poolFeeAccount:n,feeConfig:u}}})}async addLiquidity(e){let{poolInfo:t,poolKeys:n,inputAmount:o,baseIn:i,slippage:s,computeResult:a,computeBudgetConfig:c,txTipConfig:u,config:l,txVersion:d,feePayer:m}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),o.isZero()&&this.logAndCreateError("amounts must greater than zero","amountInA",{amountInA:o.toString()});let{account:p}=this.scope,{bypassAssociatedCheck:y,checkCreateATAOwner:f}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...l},b=a?void 0:await this.getRpcPoolInfo(t.id),{liquidity:g,inputAmountFee:w,anotherAmount:k}=a||this.computePairAmount({poolInfo:{...t,lpAmount:new C(b.lpAmount.toString()).div(10**t.lpMint.decimals).toNumber()},baseReserve:b.baseReserve,quoteReserve:b.quoteReserve,slippage:new Je(0),baseIn:i,epochInfo:await this.scope.fetchEpochInfo(),amount:new C(o.toString()).div(10**(i?t.mintA.decimals:t.mintB.decimals))}),h=k.amount,x=t.mintA.address===Bo.toString(),T=t.mintB.address===Bo.toString(),B=this.createTxBuilder(m),[S,I]=[new X(t.mintA.address),new X(t.mintB.address)],{account:K,instructionParams:N}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new X(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:x||(i?o:h).isZero()?{payer:this.scope.ownerPubKey,amount:i?o:h}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:!1,checkCreateATAOwner:f});B.addInstruction(N||{});let{account:v,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new X(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:T||(i?h:o).isZero()?{payer:this.scope.ownerPubKey,amount:i?h:o}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:!1,checkCreateATAOwner:f});B.addInstruction(_||{}),!K&&!v&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",p.tokenAccounts);let D=await p.getCreatedTokenAccount({mint:new X(t.lpMint.address)}),{tokenAccount:q,...G}=await p.handleTokenAccount({side:"out",amount:0,mint:new X(t.lpMint.address),tokenAccount:D,bypassAssociatedCheck:y,checkCreateATAOwner:f});B.addInstruction(G);let Y=n??await this.getCpmmPoolKeys(t.id),ie=new Je(new _e(1)).sub(s);return B.addInstruction({instructions:[cl(new X(t.programId),this.scope.ownerPubKey,new X(Y.authority),new X(t.id),q,K,v,new X(Y.vault.A),new X(Y.vault.B),S,I,new X(t.lpMint.address),a?a?.liquidity:ie.mul(g).quotient,i?w.amount:h,i?h:w.amount)],instructionTypes:[V.CpmmAddLiquidity],lookupTableAddress:Y.lookupTableAccount?[Y.lookupTableAccount]:[]}),B.addCustomComputeBudget(c),B.addTipInstruction(u),B.versionBuild({txVersion:d})}async withdrawLiquidity(e){let{poolInfo:t,poolKeys:n,lpAmount:o,slippage:i,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u,closeWsol:l=!0}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region");let d=new Je(new _e(1)).sub(i),m=await this.getRpcPoolInfo(t.id),[p,y]=[d.mul(o.mul(m.baseReserve).div(m.lpAmount)).quotient,d.mul(o.mul(m.quoteReserve).div(m.lpAmount)).quotient],f=await this.scope.fetchEpochInfo(),[b,g]=[Ae(p,t.mintA.extensions.feeConfig,f,!1),Ae(y,t.mintB.extensions.feeConfig,f,!1)],{account:w}=this.scope,k=this.createTxBuilder(u),[h,x]=[new X(t.mintA.address),new X(t.mintB.address)],T=h.equals(j),B=x.equals(j),S,I,{account:K,instructionParams:N}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new X(t.mintA.address),notUseTokenAccount:T,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(T&&l),associatedOnly:!T,checkCreateATAOwner:!1});S=K,N&&k.addInstruction(N);let{account:v,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new X(t.mintB.address),notUseTokenAccount:B,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(B&&l),associatedOnly:!B,checkCreateATAOwner:!1});I=v,_&&k.addInstruction(_),(!S||!I)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",w.tokenAccounts);let D=await w.getCreatedTokenAccount({mint:new X(t.lpMint.address)});D||this.logAndCreateError("cannot found lp token account","tokenAccounts",w.tokenAccounts);let q=n??await this.getCpmmPoolKeys(t.id);return k.addInstruction({instructions:[ll(new X(t.programId),this.scope.ownerPubKey,new X(q.authority),new X(t.id),D,S,I,new X(q.vault.A),new X(q.vault.B),h,x,new X(t.lpMint.address),o,p.sub(b.fee??new _e(0)),y.sub(g.fee??new _e(0)))],instructionTypes:[V.CpmmWithdrawLiquidity],lookupTableAddress:q.lookupTableAccount?[q.lookupTableAccount]:[]}),k.addCustomComputeBudget(s),k.addTipInstruction(a),k.versionBuild({txVersion:c})}async swap(e){await new Promise(Y=>setImmediate(Y));let{poolInfo:t,poolKeys:n,baseIn:o,fixedOut:i,inputAmount:s,swapResult:a,slippage:c=0,config:u,computeBudgetConfig:l,txTipConfig:d,txVersion:m,feePayer:p,nonce:y}=e,{bypassAssociatedCheck:f,checkCreateATAOwner:b,associatedOnly:g,useIdempotent:w=!1}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,associatedOnly:!0,useIdempotent:!1,...u},k=this.createTxBuilder(p);if(y&&y?.instruction&&k.addInstruction({instructions:[y.instruction],instructionTypes:[y.instruction].map(()=>V.NonceAccount)}),l){let{instructions:Y,instructionTypes:ie}=so(l);k.addInstruction({instructions:Y,instructionTypes:ie})}i?a.sourceAmountSwapped=a.sourceAmountSwapped.mul(new _e((1+c)*1e4)).div(new _e(1e4)):a.destinationAmountSwapped=a.destinationAmountSwapped.mul(new _e((1-c)*1e4)).div(new _e(1e4));let[h,x]=[new X(t.mintA.address),new X(t.mintB.address)],T,B;if(w){let Y=new X(t.mintA.programId??Ot),ie=new X(t.mintB.programId??Ot),ke=h.equals(Bo),re=x.equals(Bo);T=yl(h,this.scope.ownerPubKey,!1,Y),B=yl(x,this.scope.ownerPubKey,!1,ie),ke||k.addInstruction({instructions:[fl(this.scope.ownerPubKey,T,this.scope.ownerPubKey,h,Y)],instructionTypes:[V.CreateATA]}),re||k.addInstruction({instructions:[fl(this.scope.ownerPubKey,B,this.scope.ownerPubKey,x,ie)],instructionTypes:[V.CreateATA]})}else{let Y=t.mintA.address===j.toBase58(),ie=t.mintB.address===j.toBase58(),{account:ke,instructionParams:re}=await this.scope.account.getOrCreateTokenAccount({mint:h,tokenProgram:new X(t.mintA.programId??Ot),owner:this.scope.ownerPubKey,createInfo:Y||!o?{payer:this.scope.ownerPubKey,amount:o?a.sourceAmountSwapped:0}:void 0,notUseTokenAccount:Y,skipCloseAccount:!Y,associatedOnly:Y?!1:g,checkCreateATAOwner:b});re&&k.addInstruction(re),T=ke;let{account:ge,instructionParams:rt}=await this.scope.account.getOrCreateTokenAccount({mint:x,tokenProgram:new X(t.mintB.programId??Ot),owner:this.scope.ownerPubKey,createInfo:ie||o?{payer:this.scope.ownerPubKey,amount:o?0:a.sourceAmountSwapped}:void 0,notUseTokenAccount:ie,skipCloseAccount:!ie,associatedOnly:ie?!1:g,checkCreateATAOwner:b});rt&&k.addInstruction(rt),B=ge,(!T||!B)&&this.logAndCreateError("user do not have token account",{mintA:t.mintA.symbol||t.mintA.address,mintB:t.mintB.symbol||t.mintB.address,mintATokenAcc:T,mintBTokenAcc:B,mintAUseSOLBalance:Y,mintBUseSOLBalance:ie,associatedOnly:g})}let S=n??await this.getCpmmPoolKeys(t.id),I=o?T:B,K=o?B:T,N=o?h:x,v=o?x:h,_=o?S.vault.A:S.vault.B,D=o?S.vault.B:S.vault.A,q=o?new X(t.mintA.programId??Ot):new X(t.mintB.programId??Ot),G=o?new X(t.mintB.programId??Ot):new X(t.mintA.programId??Ot);return k.addInstruction({instructions:[i?ml(new X(t.programId),this.scope.ownerPubKey,new X(S.authority),new X(S.config.id),new X(t.id),I,K,new X(_),new X(D),q,G,N,v,Ti(new X(t.programId),new X(t.id)).publicKey,a.sourceAmountSwapped,a.destinationAmountSwapped):qr(new X(t.programId),this.scope.ownerPubKey,new X(S.authority),new X(S.config.id),new X(t.id),I,K,new X(_),new X(D),q,G,N,v,Ti(new X(t.programId),new X(t.id)).publicKey,s,a.destinationAmountSwapped)],instructionTypes:[i?V.CpmmSwapBaseOut:V.CpmmSwapBaseIn]}),k.addTipInstruction(d),k.versionBuild({txVersion:m},y?.nonce)}async lockLp(e){let{poolInfo:t,lpAmount:n,computeBudgetConfig:o,txTipConfig:i,txVersion:s,feePayer:a,feeNftOwner:c}=e;n.isZero()&&this.logAndCreateError("lpAmount must greater than zero",{lpAmount:n.toString()});let u=this.createTxBuilder(a),l=e.poolKeys??await this.getCpmmPoolKeys(t.id),d=await dl({poolInfo:t,poolKeys:l,ownerInfo:{wallet:this.scope.ownerPubKey,feePayer:e.feePayer??this.scope.ownerPubKey},feeNftOwner:c??this.scope.ownerPubKey,lockProgram:e.programId??Wo,lockAuthProgram:e.authProgram??Do,lpAmount:n,withMetadata:e.withMetadata??!0,getEphemeralSigners:e.getEphemeralSigners});return u.addInstruction(d),u.addCustomComputeBudget(o),u.addTipInstruction(i),u.versionBuild({txVersion:s,extInfo:d.address})}async harvestLockLp(e){let{poolInfo:t,lpFeeAmount:n,nftMint:o,programId:i=Wo,authProgram:s=Do,cpmmProgram:a,computeBudgetConfig:c,txTipConfig:u,txVersion:l,closeWsol:d=!0}=e;n.isZero()&&this.logAndCreateError("lpFeeAmount must greater than zero",{lpAmount:n.toString()});let m=e.feePayer||this.scope.ownerPubKey,p=this.createTxBuilder(m),[y,f]=[new X(t.mintA.address),new X(t.mintB.address)],b=y.equals(j),g=f.equals(j),w,k,{account:h,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new X(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(b&&d),associatedOnly:!b,checkCreateATAOwner:!1});w=h,x&&p.addInstruction(x);let{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new X(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(g&&d),associatedOnly:!g,checkCreateATAOwner:!1});k=T,B&&p.addInstruction(B),(!w||!k)&&this.logAndCreateError("cannot found target token accounts",{tokenAccountA:w,tokenAccountB:k});let S=e.poolKeys??await this.getCpmmPoolKeys(t.id),{publicKey:I}=Z(m,o,Ot),{publicKey:K}=Dr(i,o),{publicKey:N}=Z(s,new X(t.lpMint.address),Ot);return p.addInstruction({instructions:[pl({programId:i??Wo,nftOwner:this.scope.ownerPubKey,auth:s??Do,nftMint:o,nftAccount:I,lockPda:K,poolId:new X(t.id),mintLp:new X(S.mintLp.address),userVaultA:w,userVaultB:k,poolVaultA:new X(S.vault.A),poolVaultB:new X(S.vault.B),mintA:y,mintB:f,lockLpVault:N,lpFeeAmount:n,cpmmProgram:a?.programId,cpmmAuthProgram:a?.authProgram})],instructionTypes:[V.CpmmCollectLockFee]}),p.addCustomComputeBudget(c),p.addTipInstruction(u),p.versionBuild({txVersion:l})}computeSwapAmount({pool:e,amountIn:t,outputMint:n,slippage:o}){let i=n.toString()===e.mintB.address,s=Wr.swap(t,i?e.baseReserve:e.quoteReserve,i?e.quoteReserve:e.baseReserve,e.configInfo.tradeFeeRate),a=new C(s.destinationAmountSwapped.toString()).div(s.sourceAmountSwapped.toString()),c=s.destinationAmountSwapped.mul(new _e((1-o)*1e4)).div(new _e(1e4));return{allTrade:s.sourceAmountSwapped.eq(t),amountIn:t,amountOut:s.destinationAmountSwapped,minAmountOut:c,executionPrice:a,fee:s.tradeFee,priceImpact:e.poolPrice.sub(a).div(e.poolPrice)}}computePairAmount({poolInfo:e,baseReserve:t,quoteReserve:n,amount:o,slippage:i,epochInfo:s,baseIn:a}){let c=1-Number(i.toSignificant())/100,u=new _e(new C(o).mul(10**e[a?"mintA":"mintB"].decimals).mul(c).toFixed(0)),l=Ae(u,e[a?"mintA":"mintB"].extensions.feeConfig,s,!1),d=u.sub(l.fee??new _e(0)),m=new _e(new C(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,C.ROUND_DOWN));this.logDebug("baseReserve:",t.toString(),"quoteReserve:",n.toString()),this.logDebug("tokenIn:",a?e.mintA.symbol:e.mintB.symbol,"amountIn:",u.toString(),"amountInFee:",l.fee?.toString()??0,"anotherToken:",a?e.mintB.symbol:e.mintA.symbol,"slippage:",`${i.toSignificant()}%`);let p=a?"base":"quote";this.logDebug("input side:",p);let y=d.mul(m).div(p==="base"?t:n),f={amount:ht,fee:void 0,expirationTime:void 0};if(!d.isZero()){let h=_f(y,t,n,m);this.logDebug("lpAmountData:",{amountA:h.amountA.toString(),amountB:h.amountB.toString()}),f=Ae(h[a?"amountB":"amountA"],e[a?"mintB":"mintA"].extensions.feeConfig,s,!0)}let b=new Je(new _e(1)).add(i),g=new Je(new _e(1)).sub(i),w=Ae(b.mul(f.amount.sub(f.fee??new _e(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0),k=Ae(g.mul(f.amount.sub(f.fee??new _e(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0);return this.logDebug("anotherAmount:",f.amount.toString(),"anotherAmountFee:",f.fee?.toString()??0,"maxAnotherAmount:",w.amount.toString(),"maxAnotherAmountFee:",w.fee?.toString()??0),{inputAmountFee:l,anotherAmount:f,maxAnotherAmount:w,minAnotherAmount:k,liquidity:y}}};function _f(r,e,t,n){let o=r.mul(e).div(n);!o.isZero()&&!r.mul(e).mod(n).isZero()&&(o=o.add(new _e(1)));let i=r.mul(t).div(n);return!i.isZero()&&!r.mul(t).mod(n).isZero()&&(i=i.add(new _e(1))),{amountA:o,amountB:i}}import{PublicKey as eo}from"@solana/web3.js";import{createTransferInstruction as kl,TOKEN_PROGRAM_ID as qe,TOKEN_2022_PROGRAM_ID as Xr}from"@solana/spl-token";import Qr from"bn.js";var bl={[or.toBase58()]:3},gl={3:or};var Oa=O([we(5),we(8),L("ownAddress"),A("vaultSignerNonce"),L("baseMint"),L("quoteMint"),L("baseVault"),A("baseDepositsTotal"),A("baseFeesAccrued"),L("quoteVault"),A("quoteDepositsTotal"),A("quoteFeesAccrued"),A("quoteDustThreshold"),L("requestQueue"),L("eventQueue"),L("bids"),L("asks"),A("baseLotSize"),A("quoteLotSize"),A("feeRateBps"),A("referrerRebatesAccrued"),we(7)]),Pl={3:Oa};import{PublicKey as Al}from"@solana/web3.js";var Ur=me("Serum"),Gr=class{static getProgramId(e){let t=gl[e];return t||Ur.logWithError("invalid version","version",e),t}static getVersion(e){let t=e.toBase58(),n=bl[t];return n||Ur.logWithError("invalid program id","programId",t),n}static getStateLayout(e){let t=Pl[e];return t||Ur.logWithError(!!t,"invalid version","version",e),t}static getLayouts(e){return{state:this.getStateLayout(e)}}static getAssociatedAuthority({programId:e,marketId:t}){let n=[t.toBuffer()],o=0,i;for(;o<100;){try{let s=n.concat(Buffer.from([o]),Buffer.alloc(7));i=Al.createProgramAddressSync(s,e)}catch(s){if(s instanceof TypeError)throw s;o++;continue}return{publicKey:i,nonce:o}}return Ur.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),{publicKey:Al.default,nonce:o}}};import{PublicKey as R,SystemProgram as Si,TransactionInstruction as Ki}from"@solana/web3.js";import sn from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as va,TOKEN_2022_PROGRAM_ID as Ma,TOKEN_PROGRAM_ID as Fn}from"@solana/spl-token";function AK(r,e,t,n,o,i,s,a,c,u,l,d){let m=O([F("instruction"),A("amountIn"),A("amountOut")]),p=[{pubkey:Si.programId,isSigner:!1,isWritable:!1},{pubkey:Fn,isSigner:!1,isWritable:!1},{pubkey:new R(t.programId),isSigner:!1,isWritable:!1},{pubkey:new R(t.id),isSigner:!1,isWritable:!0},{pubkey:new R(n.id),isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let f=Le(t);p.push({pubkey:f.config.id,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(c)?f.vault.A:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(c)?f.vault.B:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},...d.map(b=>({pubkey:b,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let f=Le(t);p.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:new R("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0})}else{let f=Le(t);p.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},...f.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:f.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:f.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0}])}let y=Buffer.alloc(m.span);return m.encode({instruction:4,amountIn:u,amountOut:l},y),new Ki({keys:p,programId:r,data:y})}function wK(r,e,t,n,o,i,s,a,c,u){let l=O([F("instruction")]),d=[{pubkey:Si.programId,isSigner:!1,isWritable:!1},{pubkey:Fn,isSigner:!1,isWritable:!1},{pubkey:new R(String(n.programId)),isSigner:!1,isWritable:!1},{pubkey:new R(String(n.id)),isSigner:!1,isWritable:!0},{pubkey:new R(String(t.id)),isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let p=Le(n);d.push({pubkey:p.config.id,isSigner:!1,isWritable:!1},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.mintA.address.equals(c)?p.vault.A:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.mintA.address.equals(c)?p.vault.B:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0},...u.map(y=>({pubkey:y,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let p=Le(n);d.push({pubkey:p.authority,isSigner:!1,isWritable:!1},{pubkey:p.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:new R("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:p.openOrders,isSigner:!1,isWritable:!0},{pubkey:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.marketId,isSigner:!1,isWritable:!0},{pubkey:p.marketBids,isSigner:!1,isWritable:!0},{pubkey:p.marketAsks,isSigner:!1,isWritable:!0},{pubkey:p.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0})}else{let p=Le(n);d.push({pubkey:p.authority,isSigner:!1,isWritable:!1},{pubkey:p.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:p.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:p.openOrders,isSigner:!1,isWritable:!0},{pubkey:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.marketId,isSigner:!1,isWritable:!0},{pubkey:p.marketBids,isSigner:!1,isWritable:!0},{pubkey:p.marketAsks,isSigner:!1,isWritable:!0},{pubkey:p.marketEventQueue,isSigner:!1,isWritable:!0},...p.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:p.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:p.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0}])}let m=Buffer.alloc(l.span);return l.encode({instruction:5},m),new Ki({keys:d,programId:r,data:m})}function Ff(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y){let f=[],b=[P({pubkey:Fn,isWritable:!1}),P({pubkey:Ma,isWritable:!1}),P({pubkey:va,isWritable:!1}),P({pubkey:Si.programId,isWritable:!1}),P({pubkey:e,isSigner:!0})];b.push(P({pubkey:t})),b.push(P({pubkey:o}));let g=[c,u],w=[l,d],k=[i,s,a];for(let T=0;T<g.length;T++){let B=g[T],S=k[T]===B.mintA.address;if(b.push(P({pubkey:new R(B.programId),isWritable:!1})),T===g.length-1?b.push(P({pubkey:o})):b.push(P({pubkey:n})),b.push(P({pubkey:new R(k[T])})),b.push(P({pubkey:new R(k[T+1])})),B.version===6){let I=w[T];b.push(P({pubkey:new R(I.config.id)})),b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(S?I.vault.A:I.vault.B)})),b.push(P({pubkey:new R(S?I.vault.B:I.vault.A)})),b.push(P({pubkey:new R(B.observationId)})),b.push(P({pubkey:nn})),b.push(P({pubkey:De(new R(B.programId),new R(B.id)).publicKey})),f.push(Ea(B.sqrtPriceX64.toString(),S));for(let K of y[T]??[])b.push(P({pubkey:new R(K)}))}else if(B.version===5){let I=w[T];b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(I.authority),isWritable:!1})),b.push(P({pubkey:new R(I.marketProgramId)})),b.push(P({pubkey:new R(I.marketAuthority)})),b.push(P({pubkey:ir,isWritable:!1})),b.push(P({pubkey:new R(I.openOrders)})),b.push(P({pubkey:new R(I.vault.A)})),b.push(P({pubkey:new R(I.vault.B)})),b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(I.marketId)})),b.push(P({pubkey:new R(I.marketBids)})),b.push(P({pubkey:new R(I.marketAsks)})),b.push(P({pubkey:new R(I.marketEventQueue)})),b.push(P({pubkey:new R(I.marketBaseVault)})),b.push(P({pubkey:new R(I.marketQuoteVault)}))}else if(B.version===4){let I=w[T],K=B.status!==1;b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(I.authority),isWritable:!1})),b.push(P({pubkey:new R(K?I.id:I.marketProgramId)})),b.push(P({pubkey:new R(K?I.id:I.marketAuthority)})),b.push(P({pubkey:new R(K?I.id:I.openOrders)})),b.push(P({pubkey:new R(I.vault.A)})),b.push(P({pubkey:new R(I.vault.B)})),b.push(P({pubkey:new R(K?I.id:I.marketId)})),b.push(P({pubkey:new R(K?I.id:I.marketBids)})),b.push(P({pubkey:new R(K?I.id:I.marketAsks)})),b.push(P({pubkey:new R(K?I.id:I.marketEventQueue)})),b.push(P({pubkey:new R(K?I.id:I.marketBaseVault)})),b.push(P({pubkey:new R(K?I.id:I.marketQuoteVault)}))}else if(B.version===7){let I=w[T];b.push(P({pubkey:new R(I.authority)})),b.push(P({pubkey:new R(I.config.id)})),b.push(P({pubkey:new R(I.id)})),b.push(P({pubkey:new R(S?I.vault.A:I.vault.B)})),b.push(P({pubkey:new R(S?I.vault.B:I.vault.A)})),b.push(P({pubkey:new R(B.observationId)}))}else throw Error("pool type error")}let h=O([F("insId"),A("amountIn"),A("amountOut"),Q(J(),f.length,"clmmPriceLimit")]),x=Buffer.alloc(h.span);return h.encode({insId:0,amountIn:m,amountOut:p,clmmPriceLimit:f},x),new Ki({keys:b,programId:r,data:x})}function Ea(r,e){if(r)if(e){let t=new sn(r).div(new sn(25));return t.gt(Tr)?t:Tr}else{let t=new sn(r).mul(new sn(25));return t.lt(Ir)?t:Ir}else return e?Tr:Ir}function wl({routeProgram:r,ownerInfo:e,inputMint:t,swapInfo:n}){if(n.routeType==="amm")if(n.poolInfo[0].version===6){let o=n.poolKey[0],i=Le(o),s=t.equals(i.mintA.address)?Et.add(Lt):_t.sub(Lt);return Be.makeSwapBaseInInstructions({poolInfo:o,poolKeys:o,observationId:n.poolInfo[0].observationId,ownerInfo:{wallet:e.wallet,tokenAccountA:i.mintA.address.equals(t)?e.sourceToken:e.destinationToken,tokenAccountB:i.mintA.address.equals(t)?e.destinationToken:e.sourceToken},inputMint:t,amountIn:n.amountIn.amount.raw,amountOutMin:n.minAmountOut.amount.raw.sub(n.minAmountOut.fee?.raw??new sn(0)),sqrtPriceLimitX64:s,remainingAccounts:n.remainingAccounts[0]??[]})}else if(n.poolInfo[0].version===7){let o=n.poolInfo[0],i=t.toString()===n.poolInfo[0].mintA.address;return{signers:[],instructions:[qr(o.programId,e.wallet,o.authority,o.configId,o.id,e.sourceToken,e.destinationToken,i?o.vaultA:o.vaultB,i?o.vaultB:o.vaultA,i?o.mintProgramA:o.mintProgramB,i?o.mintProgramB:o.mintProgramA,new R(o[i?"mintA":"mintB"].address),new R(o[i?"mintB":"mintA"].address),o.observationId,n.amountIn.amount.raw,n.minAmountOut.amount.raw)],lookupTableAddress:[],instructionTypes:[i?V.CpmmSwapBaseIn:V.CpmmSwapBaseOut],address:{}}}else{let o=n.poolKey[0];return{signers:[],instructions:[Rr({poolKeys:o,version:n.poolInfo[0].pooltype.includes("StablePool")?5:4,userKeys:{tokenAccountIn:e.sourceToken,tokenAccountOut:e.destinationToken,owner:e.wallet},amountIn:n.amountIn.amount.raw,amountOut:n.minAmountOut.amount.raw.sub(n.minAmountOut.fee?.raw??new sn(0)),fixedSide:"in"})],lookupTableAddress:o.lookupTableAccount?[o.lookupTableAccount]:[],instructionTypes:[n.poolInfo[0].pooltype.includes("StablePool")?V.AmmV5SwapBaseIn:V.AmmV4SwapBaseIn],address:{}}}else if(n.routeType==="route"){let o=n.poolInfo[0],i=n.poolInfo[1],s=n.poolKey[0],a=n.poolKey[1];if(e.routeToken===void 0)throw Error("owner route token account check error");return{signers:[],instructions:[Ff(r,e.wallet,e.sourceToken,e.routeToken,e.destinationToken,t.toString(),n.middleToken.mint.toString(),n.outputMint.toString(),o,i,s,a,n.amountIn.amount.raw,n.minAmountOut.amount.raw.sub(n.minAmountOut.fee?.raw??new sn(0)),n.remainingAccounts)],instructionTypes:[V.RouteSwap],lookupTableAddress:[s.lookupTableAccount,a.lookupTableAccount].filter(c=>c!==void 0),address:{}}}else throw Error("route type error")}function kK({programId:r,wallet:e,amount:t,inputAccount:n,outputAccount:o,routeInfo:i,poolKeys:s}){if(i.success===!1)throw Error("route info error");let a=[],c=[P({pubkey:Fn,isWritable:!1}),P({pubkey:Ma,isWritable:!1}),P({pubkey:va,isWritable:!1}),P({pubkey:Si.programId,isWritable:!1}),P({pubkey:e,isSigner:!0})],u={[i.data.inputMint]:n,[i.data.outputMint]:o};c.push(P({pubkey:u[i.data.inputMint]})),c.push(P({pubkey:u[i.data.outputMint]}));for(let m=0;m<s.length;m++){let p=i.data.routePlan[m],y=s[m],f=p.inputMint===y.mintA.address;if(c.push(P({pubkey:new R(y.programId),isWritable:!1})),m===s.length-1)c.push(P({pubkey:u[p.outputMint]}));else{let b=p.outputMint;if(u[b]===void 0){let g=Z(e,new R(b),y.programId===ft.CLMM_PROGRAM_ID.toBase58()||y.programId===ft.CREATE_CPMM_POOL_PROGRAM.toBase58()?new R(f?y.mintB.programId:y.mintA.programId):Fn).publicKey;u[b]=g}c.push(P({pubkey:u[b]}))}if(c.push(P({pubkey:new R(p.inputMint)})),c.push(P({pubkey:new R(p.outputMint)})),y.programId===ft.CLMM_PROGRAM_ID.toBase58()){let b=y;c.push(P({pubkey:new R(b.config.id)})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(f?b.vault.A:b.vault.B)})),c.push(P({pubkey:new R(f?b.vault.B:b.vault.A)})),c.push(P({pubkey:new R(b.observationId)})),c.push(P({pubkey:nn,isWritable:!1})),c.push(P({pubkey:new R(b.exBitmapAccount)})),a.push(Ea(p.lastPoolPriceX64,f));for(let g of p.remainingAccounts??[])c.push(P({pubkey:new R(g)}))}else if(y.programId===ft.AMM_STABLE.toBase58()){let b=y;c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.authority),isWritable:!1})),c.push(P({pubkey:new R(b.marketProgramId),isWritable:!1})),c.push(P({pubkey:new R(b.marketAuthority),isWritable:!1})),c.push(P({pubkey:ir,isWritable:!1})),c.push(P({pubkey:new R(b.openOrders)})),c.push(P({pubkey:new R(b.vault.A)})),c.push(P({pubkey:new R(b.vault.B)})),c.push(P({pubkey:new R(b.marketId)})),c.push(P({pubkey:new R(b.marketBids)})),c.push(P({pubkey:new R(b.marketAsks)})),c.push(P({pubkey:new R(b.marketEventQueue)})),c.push(P({pubkey:new R(b.marketBaseVault)})),c.push(P({pubkey:new R(b.marketQuoteVault)}))}else if(y.programId===ft.AMM_V4.toBase58()){let b=y;c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.authority),isWritable:!1})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.vault.A)})),c.push(P({pubkey:new R(b.vault.B)})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(b.id)}))}else if(y.programId===ft.CREATE_CPMM_POOL_PROGRAM.toBase58()){let b=y;c.push(P({pubkey:new R(b.authority)})),c.push(P({pubkey:new R(b.config.id)})),c.push(P({pubkey:new R(b.id)})),c.push(P({pubkey:new R(f?b.vault.A:b.vault.B)})),c.push(P({pubkey:new R(f?b.vault.B:b.vault.A)})),c.push(P({pubkey:new R(b.observationId)}))}else throw Error("pool type error")}let l=O([F("insId"),A("amountIn"),A("amountOut"),Q(J(),a.length,"clmmPriceLimit")]),d=Buffer.alloc(l.span);return l.encode({insId:0,amountIn:t,amountOut:new sn(i.data.otherAmountThreshold),clmmPriceLimit:a},d),new Ki({keys:c,programId:r,data:d})}function hK({programId:r,wallet:e,inputAccount:t,outputAccount:n,routeInfo:o,poolKeys:i}){if(o.success===!1)throw Error("route info error");let s=[],a=[P({pubkey:Fn,isWritable:!1}),P({pubkey:Ma,isWritable:!1}),P({pubkey:va,isWritable:!1}),P({pubkey:Si.programId,isWritable:!1}),P({pubkey:e,isSigner:!0})],c={[o.data.inputMint]:t,[o.data.outputMint]:n};for(let d=i.length-1;d>=0;d--){let m=o.data.routePlan[d],p=i[d],y=m.inputMint===p.mintA.address;if(a.push(P({pubkey:new R(p.programId)})),d===0)a.push(P({pubkey:c[m.inputMint]}));else{let f=m.inputMint;if(c[f]===void 0){let b=Z(e,new R(f),p.programId===ft.CLMM_PROGRAM_ID.toBase58()||p.programId===ft.CREATE_CPMM_POOL_PROGRAM.toBase58()?new R(y?p.mintA.programId:p.mintB.programId):Fn).publicKey;c[f]=b}a.push(P({pubkey:c[f]}))}if(d===i.length-1)a.push(P({pubkey:c[m.outputMint]}));else{let f=m.outputMint;if(c[f]===void 0){let b=Z(e,new R(f),p.programId===ft.CLMM_PROGRAM_ID.toBase58()||p.programId===ft.CREATE_CPMM_POOL_PROGRAM.toBase58()?new R(y?p.mintB.programId:p.mintA.programId):Fn).publicKey;c[f]=b}a.push(P({pubkey:c[f]}))}if(a.push(P({pubkey:new R(m.inputMint)})),a.push(P({pubkey:new R(m.outputMint)})),p.programId===ft.CLMM_PROGRAM_ID.toBase58()){let f=p;a.push(P({pubkey:new R(f.config.id)})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(y?f.vault.A:f.vault.B)})),a.push(P({pubkey:new R(y?f.vault.B:f.vault.A)})),a.push(P({pubkey:new R(f.observationId)})),a.push(P({pubkey:nn,isWritable:!1})),a.push(P({pubkey:new R(f.exBitmapAccount)})),s.push(Ea(m.lastPoolPriceX64,y));for(let b of m.remainingAccounts??[])a.push(P({pubkey:new R(b)}))}else if(p.programId===ft.AMM_STABLE.toBase58()){let f=p;a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.authority),isWritable:!1})),a.push(P({pubkey:new R(f.marketProgramId),isWritable:!1})),a.push(P({pubkey:new R(f.marketAuthority),isWritable:!1})),a.push(P({pubkey:ir,isWritable:!1})),a.push(P({pubkey:new R(f.openOrders)})),a.push(P({pubkey:new R(f.vault.A)})),a.push(P({pubkey:new R(f.vault.B)})),a.push(P({pubkey:new R(f.marketId)})),a.push(P({pubkey:new R(f.marketBids)})),a.push(P({pubkey:new R(f.marketAsks)})),a.push(P({pubkey:new R(f.marketEventQueue)})),a.push(P({pubkey:new R(f.marketBaseVault)})),a.push(P({pubkey:new R(f.marketQuoteVault)}))}else if(p.programId===ft.AMM_V4.toBase58()){let f=p;a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.authority),isWritable:!1})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.vault.A)})),a.push(P({pubkey:new R(f.vault.B)})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(f.id)}))}else if(p.programId===ft.CREATE_CPMM_POOL_PROGRAM.toBase58()){let f=p;a.push(P({pubkey:new R(f.authority)})),a.push(P({pubkey:new R(f.config.id)})),a.push(P({pubkey:new R(f.id)})),a.push(P({pubkey:new R(y?f.vault.A:f.vault.B)})),a.push(P({pubkey:new R(y?f.vault.B:f.vault.A)})),a.push(P({pubkey:new R(f.observationId)}))}else throw Error("pool type error")}let u=O([F("insId"),A("amountIn"),A("amountOut"),Q(J(),s.length,"clmmPriceLimit")]),l=Buffer.alloc(u.span);return u.encode({insId:1,amountIn:new sn(o.data.otherAmountThreshold),amountOut:new sn(o.data.outputAmount),clmmPriceLimit:s},l),new Ki({keys:a,programId:r,data:l})}var kn=new Qr(0),Ci=class extends Re{constructor(e){super(e)}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals(j));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n,txVersion:o=1,feePayer:i}=e,s=await this.getWSolAccounts(),a=this.createTxBuilder(i);a.addCustomComputeBudget(e.computeBudgetConfig);let c=$(t);for(let u=0;u<s.length;u++)c.gte(s[u].amount)?(a.addInstruction({instructions:[yn({tokenAccount:s[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),c.sub(s[u].amount)):a.addInstruction({instructions:[yn({tokenAccount:s[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]});return a.versionBuild({txVersion:o})}async wrapWSol(e,t,n,o){let i=this.createTxBuilder(o),s=await Rn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return i.addInstruction(s),i.versionBuild({txVersion:n??1})}async swap({swapInfo:e,swapPoolKeys:t,ownerInfo:n,computeBudgetConfig:o,routeProgram:i,txVersion:s,feePayer:a}){let c=this.createTxBuilder(a),u=e.amountIn,l=e.amountOut,d=u.amount.token.mint.equals(j),m=l.amount.token.mint.equals(j),p=u.amount.token.mint,y=l.amount.token.mint,{account:f,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.amount.token.isToken2022?Xr:qe,mint:p,notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!d,createInfo:d?{payer:this.scope.ownerPubKey,amount:u.amount.raw}:void 0,associatedOnly:d?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});if(b&&c.addInstruction(b),f===void 0)throw Error("input account check error");let g;if(e.routeType==="route"&&!m)g=this.scope.account.getAssociatedTokenAccount(y,l.amount.token.isToken2022?Xr:qe);else{let{account:x,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:l.amount.token.isToken2022?Xr:qe,mint:y,notUseTokenAccount:m,owner:this.scope.ownerPubKey,skipCloseAccount:!0,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:m?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});g=x,T&&c.addInstruction(T)}m&&c.addInstruction({endInstructions:[yn({owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,tokenAccount:g,programId:qe})],endInstructionTypes:[V.CloseAccount]});let w;if(e.routeType==="route"){let x=e.middleToken;w=this.scope.account.getAssociatedTokenAccount(x.mint,x.isToken2022?Xr:qe)}let k=t||await this.computePoolToPoolKeys({pools:e.poolInfoList}),h=wl({routeProgram:i,inputMint:p,swapInfo:{...e,poolInfo:[...e.poolInfoList],poolKey:k,outputMint:y},ownerInfo:{wallet:this.scope.ownerPubKey,sourceToken:f,routeToken:w,destinationToken:g}});if(e.feeConfig!==void 0){let x=this.createTxBuilder();x.addInstruction({instructions:[kl(f,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[V.TransferAmount]}),x.addInstruction(h);let{transactions:T}=s===0?await x.sizeCheckBuildV0():await x.sizeCheckBuild();T.length<2&&c.addInstruction({instructions:[kl(f,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[V.TransferAmount]})}return c.addInstruction(h),s===0?c.sizeCheckBuildV0({computeBudgetConfig:o,address:h.address}):c.sizeCheckBuild({computeBudgetConfig:o,address:h.address})}async fetchRoutePoolBasicInfo(e){let{amm:t=_o,clmm:n=Sn,cpmm:o=Vo}=e||{},i=await this.scope.connection.getProgramAccounts(t,{dataSlice:{offset:zn.offsetOf("baseMint"),length:64}}),s=O([L("baseMint"),L("quoteMint")]),a=i.map(p=>({id:p.pubkey,version:4,mintA:s.decode(p.account.data).baseMint,mintB:s.decode(p.account.data).quoteMint})),c=O([L("mintA"),L("mintB")]),l=(await this.scope.connection.getProgramAccounts(n,{filters:[{dataSize:Xn.span}],dataSlice:{offset:Xn.offsetOf("mintA"),length:64}})).map(p=>{let y=c.decode(p.account.data);return{id:p.pubkey,version:6,mintA:y.mintA,mintB:y.mintB}}),m=(await this.scope.connection.getProgramAccounts(o,{dataSlice:{offset:Bi.offsetOf("mintA"),length:64}})).map(p=>{let y=c.decode(p.account.data);return{id:p.pubkey,version:7,mintA:y.mintA,mintB:y.mintB}});return{clmmPools:l,ammPools:a,cpmmPools:m}}getAllRoute({inputMint:e,outputMint:t,clmmPools:n,ammPools:o,cpmmPools:i}){e=e.toString()===eo.default.toString()?j:e,t=t.toString()===eo.default.toString()?j:t;let s={},a={},c={},u=[],l={};for(let m of n??[]){if((m.mintA.equals(e)&&m.mintB.equals(t)||m.mintA.equals(t)&&m.mintB.equals(e))&&(u.push(m),a[m.id.toString()]=m),m.mintA.equals(e)){let p=m.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[p].in.push(m)}if(m.mintB.equals(e)){let p=m.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[p].in.push(m)}if(m.mintA.equals(t)){let p=m.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[p].out.push(m)}if(m.mintB.equals(t)){let p=m.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[p].out.push(m)}}let d=[];for(let m of o)(m.mintA.equals(e)&&m.mintB.equals(t)||m.mintA.equals(t)&&m.mintB.equals(e))&&(u.push(m),s[m.id.toBase58()]=m,d.push(m)),m.mintA.equals(e)&&(l[m.mintB.toBase58()]===void 0&&(l[m.mintB.toBase58()]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[m.mintB.toBase58()].in.push(m)),m.mintB.equals(e)&&(l[m.mintA.toBase58()]===void 0&&(l[m.mintA.toBase58()]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[m.mintA.toBase58()].in.push(m)),m.mintA.equals(t)&&(l[m.mintB.toBase58()]===void 0&&(l[m.mintB.toBase58()]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[m.mintB.toBase58()].out.push(m)),m.mintB.equals(t)&&(l[m.mintA.toBase58()]===void 0&&(l[m.mintA.toBase58()]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[m.mintA.toBase58()].out.push(m));for(let m of i)(m.mintA.equals(e)&&m.mintB.equals(t)||m.mintA.equals(t)&&m.mintB.equals(e))&&(u.push(m),c[m.id.toBase58()]=m),m.mintA.equals(e)&&(l[m.mintB.toBase58()]===void 0&&(l[m.mintB.toBase58()]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[m.mintB.toBase58()].in.push(m)),m.mintB.equals(e)&&(l[m.mintA.toBase58()]===void 0&&(l[m.mintA.toBase58()]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[m.mintA.toBase58()].in.push(m)),m.mintA.equals(t)&&(l[m.mintB.toBase58()]===void 0&&(l[m.mintB.toBase58()]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[m.mintB.toBase58()].out.push(m)),m.mintB.equals(t)&&(l[m.mintA.toBase58()]===void 0&&(l[m.mintA.toBase58()]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[m.mintA.toBase58()].out.push(m));for(let m of Object.keys(l)){if(l[m].in.length===1&&l[m].out.length===1&&l[m].in[0].id.equals(l[m].out[0].id)){delete l[m];continue}if(l[m].in.length===0||l[m].out.length===0){delete l[m];continue}let p=l[m];for(let y of p.in)for(let f of p.out)y.version===6&&a[y.id.toString()]===void 0?a[y.id.toString()]=y:y.version===7&&c[y.id.toString()]===void 0?c[y.id.toString()]=y:(y.version===4||y.version===5)&&s[y.id.toString()]===void 0&&(s[y.id.toString()]=y),f.version===6&&a[f.id.toString()]===void 0?a[f.id.toString()]=f:f.version===7&&c[f.id.toString()]===void 0?c[f.id.toString()]=f:(f.version===4||f.version===5)&&s[f.id.toString()]===void 0&&(s[f.id.toString()]=f)}return{directPath:u,addLiquidityPools:d,routePathDict:l,needSimulate:Object.values(s),needTickArray:Object.values(a),cpmmPoolList:Object.values(c)}}async fetchSwapRoutesData({routes:e,inputMint:t,outputMint:n}){let o=new Set([...e.needTickArray.map(f=>[f.mintA.toBase58(),f.mintB.toBase58()]).flat(),t.toString(),n.toString()]);console.log("fetching amm pools info, total: ",e.needSimulate.length);let i=await this.scope.liquidity.getRpcPoolInfos(e.needSimulate.map(f=>f.id)),s=Or(i),a={};Object.values(s).forEach(f=>{o.delete(f.mintA.address),a[f.mintA.address]={address:new eo(f.mintA.address),programId:qe,mintAuthority:null,supply:BigInt(0),decimals:f.mintA.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0},o.delete(f.mintB.address),a[f.mintB.address]={address:new eo(f.mintB.address),programId:qe,mintAuthority:null,supply:BigInt(0),decimals:f.mintB.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}}),console.log("fetching cpmm pools info, total: ",e.cpmmPoolList.length);let c=await this.scope.cpmm.getRpcPoolInfos(e.cpmmPoolList.map(f=>f.id.toBase58()),!0);Object.values(c).forEach(f=>{let[b,g]=[f.mintA.toBase58(),f.mintB.toBase58()];f.mintProgramA.equals(qe)?(o.delete(b),a[b]={address:f.mintA,programId:f.mintProgramA,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalA,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):o.add(b),f.mintProgramB.equals(qe)?(o.delete(g),a[g]={address:f.mintB,programId:f.mintProgramB,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalB,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):o.add(g)}),console.log("fetching mints info, total: ",o.size);let u=await oo({connection:this.scope.connection,mints:Array.from(o).map(f=>new eo(f))});a={...a,...u};let l=this.scope.cpmm.toComputePoolInfos({pools:c,mintInfos:a});console.log("fetching clmm pools info, total:",e.needTickArray.length);let d=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:e.needTickArray.map(f=>f.id)}),{computeClmmPoolInfo:m,computePoolTickData:p}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:d,mintInfos:a}),y=Object.keys(e.routePathDict).reduce((f,b)=>({...f,[b]:{...e.routePathDict[b],mintProgram:a[b].programId,mDecimals:a[b].decimals,in:e.routePathDict[b].in.map(g=>s[g.id.toBase58()]||m[g.id.toBase58()]||l[g.id.toBase58()]),out:e.routePathDict[b].out.map(g=>s[g.id.toBase58()]||m[g.id.toBase58()]||l[g.id.toBase58()])}}),{});return{mintInfos:a,ammPoolsRpcInfo:i,ammSimulateCache:s,clmmPoolsRpcInfo:d,computeClmmPoolInfo:m,computePoolTickData:p,computeCpmmData:l,routePathDict:y}}getAllRouteComputeAmountOut({inputTokenAmount:e,outputToken:t,directPath:n,routePathDict:o,simulateCache:i,tickCache:s,slippage:a,chainTime:c,epochInfo:u,feeConfig:l}){let d=l===void 0?new Qr(0):e.raw.mul(new Qr(l.feeBps.toNumber())).div(new Qr(1e4)),m=e.raw.sub(d),p=new he(e.token,m),y=l===void 0?void 0:{feeAmount:d,feeAccount:l.feeAccount},f={...t,address:ut(t.address).toString()},b=[];for(let g of n)try{b.push({...this.computeAmountOut({itemPool:g,tickCache:s,simulateCache:i,chainTime:c,epochInfo:u,slippage:a,outputToken:f,amountIn:p}),feeConfig:y})}catch(w){this.logDebug("direct error",g.version,g.id.toString(),w.message)}this.logDebug("direct done");for(let[g,w]of Object.entries(o)){let k={chainId:101,address:g,programId:w.mintProgram.toBase58(),logoURI:"",symbol:"",name:"",decimals:w.mDecimals,tags:[],extensions:{}},h=w.in.map(T=>{try{return{pool:T,data:this.computeAmountOut({itemPool:T,tickCache:s,simulateCache:i,chainTime:c,epochInfo:u,slippage:a,outputToken:k,amountIn:p})}}catch(B){this.logDebug("route in error",T.version,T.id.toString(),B.message);return}}).sort((T,B)=>{let S=T===void 0?kn:T.data.amountOut.amount.raw.sub(T.data.amountOut.fee?.raw??kn),I=B===void 0?kn:B.data.amountOut.amount.raw.sub(B.data.amountOut.fee?.raw??kn);return S.lt(I)?1:-1})[0];if(h===void 0)continue;let x=new he(Cr(k),h.data.amountOut.amount.raw.sub(h.data.amountOut.fee?.raw??kn));for(let T of w.out)try{let B=this.computeAmountOut({itemPool:T,tickCache:s,simulateCache:i,chainTime:c,epochInfo:u,slippage:a,outputToken:f,amountIn:x});b.push({...B,allTrade:!!(h.data.allTrade&&B.allTrade),amountIn:h.data.amountIn,amountOut:B.amountOut,minAmountOut:B.minAmountOut,currentPrice:void 0,executionPrice:new C(new kt({baseToken:h.data.amountIn.amount.token,denominator:h.data.amountIn.amount.raw,quoteToken:B.amountOut.amount.token,numerator:B.amountOut.amount.raw.sub(B.amountOut.fee?.raw??kn)}).toFixed()),priceImpact:new C(h.data.priceImpact.add(B.priceImpact).toFixed()),fee:[h.data.fee[0],B.fee[0]],routeType:"route",poolInfoList:[h.pool,T],remainingAccounts:[h.data.remainingAccounts[0],B.remainingAccounts[0]],minMiddleAmountFee:B.amountOut.fee?.raw?new he(h.data.amountOut.amount.token,(h.data.amountOut.fee?.raw??kn).add(B.amountOut.fee?.raw??kn)):void 0,middleToken:h.data.amountOut.amount.token,poolReady:h.data.poolReady&&B.poolReady,poolType:[h.data.poolType,B.poolType],feeConfig:y,expirationTime:Xt(h.data.expirationTime,B.expirationTime)})}catch(B){this.logDebug("route out error",T.version,T.id.toString(),B.message)}}return b.filter(g=>(g.allTrade||this.logDebug(`pool ${g.poolInfoList.map(w=>w.id.toString()).join(",")} filter out since not all trade`),g.allTrade)).sort((g,w)=>g.amountOut.amount.raw.sub(w.amountOut.amount.raw).gt(kn)?-1:1)}computeAmountOut({itemPool:e,tickCache:t,simulateCache:n,chainTime:o,epochInfo:i,slippage:s,outputToken:a,amountIn:c}){if(e.version===6){let{allTrade:u,realAmountIn:l,amountOut:d,minAmountOut:m,expirationTime:p,currentPrice:y,executionPrice:f,priceImpact:b,fee:g,remainingAccounts:w,executionPriceX64:k}=Ce.computeAmountOutFormat({poolInfo:e,tickArrayCache:t[e.id.toString()],amountIn:c.raw,tokenOut:a,slippage:s,epochInfo:i,catchLiquidityInsufficient:!0});return{allTrade:u,amountIn:l,amountOut:d,minAmountOut:m,currentPrice:new C(y.toFixed()),executionPrice:new C(f.toFixed()),priceImpact:new C(b.toFixed()),fee:[g],remainingAccounts:[w],routeType:"amm",poolInfoList:[e],poolReady:e.startTime<o,poolType:"CLMM",slippage:s,clmmExPriceX64:[k],expirationTime:Xt(l.expirationTime,p)}}else if(e.version===7){let{allTrade:u,executionPrice:l,amountOut:d,minAmountOut:m,priceImpact:p,fee:y}=this.scope.cpmm.computeSwapAmount({pool:e,outputMint:a.address,amountIn:c.raw,slippage:s});return{allTrade:u,amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:fi({...a,amount:d}),fee:void 0,expirationTime:void 0},minAmountOut:{amount:fi({...a,amount:m}),fee:void 0,expirationTime:void 0},currentPrice:e.poolPrice,executionPrice:l,priceImpact:p,fee:[new he(c.token,y)],remainingAccounts:[],routeType:"amm",poolInfoList:[e],poolReady:e.openTime.toNumber()<o,poolType:"CPMM",slippage:s,clmmExPriceX64:[void 0],expirationTime:void 0}}else{if(![1,6,7].includes(n[e.id.toString()].status))throw Error("swap error");let{amountOut:u,minAmountOut:l,currentPrice:d,executionPrice:m,priceImpact:p,fee:y}=this.scope.liquidity.computeAmountOut({poolInfo:n[e.id.toString()],amountIn:c.raw,mintIn:c.token.mint,mintOut:a.address,slippage:s});return{amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:fi({...a,amount:u}),fee:void 0,expirationTime:void 0},minAmountOut:{amount:fi({...a,amount:l}),fee:void 0,expirationTime:void 0},currentPrice:d,executionPrice:m,priceImpact:p,fee:[new he(c.token,y)],routeType:"amm",poolInfoList:[e],remainingAccounts:[],poolReady:Number(n[e.id].openTime)<o,poolType:e.version===5?"STABLE":void 0,expirationTime:void 0,allTrade:!0,slippage:s,clmmExPriceX64:[void 0]}}}async computePoolToPoolKeys({pools:e,clmmRpcData:t={},ammRpcData:n={}}){let o=new Set(e.filter(u=>u.version===6&&!t[u.id.toString()]).map(u=>u.id.toString()));if(o.size>0){let u=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:Array.from(o)});Object.keys(u).forEach(l=>{t[l]=u[l]})}let i=new Set(e.filter(u=>u.version===4&&!n[u.id.toString()]).map(u=>u.id.toString()));if(i.size>0){let u=await this.scope.liquidity.getRpcPoolInfos(Array.from(i));Object.keys(u).forEach(l=>{n[l]=u[l]})}let s=new Set(e.filter(u=>u.version===4).map(u=>u.marketId)),a={};s.size>0&&(await Se(this.scope.connection,Array.from(s).map(l=>({pubkey:new eo(l)})))).forEach(l=>{if(!l.accountInfo)return;let d=Oa.decode(l.accountInfo.data);a[l.pubkey.toBase58()]={marketId:l.pubkey.toString(),marketProgramId:l.accountInfo.owner.toString(),marketAuthority:Gr.getAssociatedAuthority({programId:l.accountInfo.owner,marketId:l.pubkey}).publicKey.toString(),marketBaseVault:d.baseVault.toString(),marketQuoteVault:d.quoteVault.toString(),marketBids:d.bids.toString(),marketAsks:d.asks.toString(),marketEventQueue:d.eventQueue.toString()}});let c=[];return e.forEach(u=>{if(u.version===6){let l=t[u.id.toString()],d={programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.startTime),vault:{A:l.vaultA.toBase58(),B:l.vaultB.toBase58()},config:{...u.ammConfig,id:u.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]},rewardInfos:[],observationId:u.observationId.toBase58(),exBitmapAccount:u.exBitmapAccount.toBase58()};c.push(d)}else if(u.version===4){let l=n[u.id.toString()],d={programId:u.programId,id:u.id,mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),vault:{A:l.baseVault.toBase58(),B:l.quoteVault.toBase58()},authority:Ba({programId:new eo(u.programId)}).publicKey.toString(),openOrders:l.openOrders.toBase58(),targetOrders:l.targetOrders.toBase58(),mintLp:u.lpMint,...a[u.marketId]};c.push(d)}else u.version===7&&c.push({observationId:u.observationId.toBase58(),programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),authority:Io(u.programId).publicKey.toBase58(),vault:{A:u.vaultA.toBase58(),B:u.vaultB.toBase58()},mintLp:dt({address:u.mintLp.toBase58(),programId:qe.toBase58(),decimals:u.lpDecimals}),config:{id:u.configId.toBase58(),...u.configInfo,protocolFeeRate:u.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:u.configInfo.tradeFeeRate.toNumber(),fundFeeRate:u.configInfo.fundFeeRate.toNumber(),createPoolFee:u.configInfo.createPoolFee.toString()}})}),c}};import{PublicKey as Vf,Transaction as _a,TransactionInstruction as Wf}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Df}from"@solana/spl-token";import hl from"bn.js";var pt=class extends Re{static getPdaPoolId(e,t){return te([pt.SEED_CONFIG.pool.id,t.toBuffer()],e)}static getPdaOwnerId(e,t,n,o){return te([pt.SEED_CONFIG.owner.id,t.toBuffer(),n.toBuffer(),Buffer.from(new hl(o).toArray())],e)}static async getAllInfo({connection:e,programId:t,poolIds:n,wallet:o,chainTime:i}){if(n.length===0)return[];let s=n.map(l=>pt.getPdaPoolId(t,l).publicKey),a=[];for(let l=0;l<pt.VERSION_PROJECT.length;l++)a.push(...s.map(d=>pt.getPdaOwnerId(t,d,o,l).publicKey));let c=await Vt(e,[...s,...a]),u=[];for(let l=0;l<c.length;l++){let d=Math.floor(l/n.length),m=l%n.length,p=s[m],y=a[l],f=c[m],b=c[n.length+l];if(!(f&&b)||f.data.length!==pt.POOL_LAYOUT.span||b.data.length!==pt.OWNER_LAYOUT.span)continue;let g=pt.POOL_LAYOUT.decode(f.data),w=pt.OWNER_LAYOUT.decode(b.data),k=g.openTime.toNumber(),h=g.endTime.toNumber(),x=w.tokenInfo.map(S=>S.debtAmount.gt(new hl(0))).filter(S=>!S).length!==3,T=i>k&&i<h&&g.status===1,B=x&&T;u.push({programId:t,poolId:p,ammId:g.ammId,ownerAccountId:y,snapshotLpAmount:w.lpAmount,project:pt.VERSION_PROJECT[d],openTime:k,endTime:h,canClaim:B,canClaimErrorType:x?T?void 0:"outOfOperationalTime":"alreadyClaimIt",tokenInfo:g.tokenInfo.map((S,I)=>({mintAddress:S.mintAddress,mintVault:S.mintVault,mintDecimals:S.mintDecimals,perLpLoss:S.perLpLoss,debtAmount:w.tokenInfo[I].debtAmount.add(w.tokenInfo[I].claimedAmount)}))})}return u}async makeClaimTransaction({poolInfo:e,ownerInfo:t,feePayer:n}){t.wallet||this.scope.checkOwner();let o=this.createTxBuilder(n),i=t.wallet||this.scope.ownerPubKey,s=[];for(let u of e.tokenInfo){let{account:l,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({mint:u.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:u.mintAddress.equals(Me.WSOL.mint),createInfo:{payer:i,amount:0},skipCloseAccount:!u.mintAddress.equals(Me.WSOL.mint),associatedOnly:u.mintAddress.equals(Me.WSOL.mint)?!1:t.associatedOnly});d&&o.addInstruction(d),s.push(l)}o.addInstruction({instructions:[pt.makeClaimInstruction({programId:e.programId,poolInfo:e,ownerInfo:{wallet:i,ownerPda:e.ownerAccountId,claimAddress:s}})]});let{transaction:a,signers:c}=o.build();return[{transaction:a,signer:c}]}async makeClaimAllTransaction({poolInfos:e,ownerInfo:t,feePayer:n}){let o=this.createTxBuilder(n),i=t.wallet||this.scope.ownerPubKey,s={};for(let l of e){let d=[];for(let m of l.tokenInfo){let{account:p,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({mint:m.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:m.mintAddress.equals(Me.WSOL.mint),createInfo:{payer:i,amount:0},skipCloseAccount:!m.mintAddress.equals(Me.WSOL.mint),associatedOnly:m.mintAddress.equals(Me.WSOL.mint)?!1:t.associatedOnly});y&&o.addInstruction(y),p&&(s[m.mintAddress.toString()]=p,d.push(p))}o.addInstruction({instructions:[pt.makeClaimInstruction({programId:l.programId,poolInfo:l,ownerInfo:{wallet:i,ownerPda:l.ownerAccountId,claimAddress:d}})]})}let{transaction:a,signers:c}=o.build(),u=o.allInstructions;return nr(u,[i,...c.map(l=>l.publicKey)])?[{transaction:a,signer:c}]:[{transaction:new _a().add(...u.slice(0,o.AllTxData.instructions.length-1)),signer:c},{transaction:new _a().add(...u.slice(o.AllTxData.instructions.length-1)),signer:[]},{transaction:new _a().add(...o.AllTxData.endInstructions),signer:[]}]}static makeClaimInstruction({programId:e,poolInfo:t,ownerInfo:n}){let o=O([]),i=[{pubkey:n.wallet,isSigner:!0,isWritable:!0},{pubkey:t.poolId,isSigner:!1,isWritable:!0},{pubkey:n.ownerPda,isSigner:!1,isWritable:!0},...n.claimAddress.map(c=>({pubkey:c,isSigner:!1,isWritable:!0})),...t.tokenInfo.map(({mintVault:c})=>({pubkey:c,isSigner:!1,isWritable:!0})),{pubkey:Df,isSigner:!1,isWritable:!1}],s=Buffer.alloc(o.span);o.encode({},s);let a=Buffer.from([10,66,208,184,161,6,191,98,...s]);return new Wf({keys:i,programId:e,data:a})}},Ft=pt;Ct(Ft,"CLAIMED_NUM",3),Ct(Ft,"POOL_LAYOUT",O([we(8),F("bump"),F("status"),A("openTime"),A("endTime"),L("ammId"),Q(O([F("mintDecimals"),L("mintAddress"),L("mintVault"),A("perLpLoss"),A("totalClaimedAmount")]),pt.CLAIMED_NUM,"tokenInfo"),Q(A(),10,"padding")])),Ct(Ft,"OWNER_LAYOUT",O([we(8),F("bump"),F("version"),L("poolId"),L("owner"),A("lpAmount"),Q(O([L("mintAddress"),A("debtAmount"),A("claimedAmount")]),pt.CLAIMED_NUM,"tokenInfo"),Q(A(),4,"padding")])),Ct(Ft,"DEFAULT_POOL_ID",["58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2","6UmmUiYoBjSrhakAobJw8BvkmJtDVxaeBtbt7rxWo1mg","AVs9TA4nWDzfPJE9gGVNJMVhcQy3V9PGazuz33BfG2RA","DVa7Qmb5ct9RCpaU7UTpSaf3GVMYz17vNVU67XpdCRut","7XawhbbxtsRcQA8KTkHT9f9nc6d69UwqCDh6U5EEbEmX","6a1CsrpeZubDjEJE9s1CMVheB6HWM5d7m1cj2jkhyXhj","EoNrn8iUhwgJySD1pHu8Qxm5gSQqLK3za4m8xzD2RuEb","AceAyRTWt4PyB2pHqf2qhDgNZDtKVNaxgL8Ru3V4aN1P","6tmFJbMk5yVHFcFy7X2K8RwHjKLr6KVFLYXpgpBNeAxB"].map(e=>new Vf(e))),Ct(Ft,"SEED_CONFIG",{pool:{id:Buffer.from("pool_seed","utf8")},owner:{id:Buffer.from("user_claim_seed","utf8")}}),Ct(Ft,"VERSION_PROJECT",[void 0,"Francium","Tulip","Larix"]);import{PublicKey as Ri}from"@solana/web3.js";import Tl from"bn.js";import{SYSVAR_CLOCK_PUBKEY as qf,TransactionInstruction as Va}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Wa}from"@solana/spl-token";var Fa=O([F("instruction"),qu("amount")]),Li=O([F("instruction")]);function yC({programId:r,amount:e,instructionKeys:t}){let n=[{pubkey:Yi,isSigner:!1,isWritable:!1},{pubkey:Wa,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:Ps,isSigner:!1,isWritable:!1},...Object.entries(t).map(([i,s])=>({pubkey:s,isSigner:i==="userOwner",isWritable:!["authority","userOwner","userIdoCheck","userStakeInfo"].includes(i)}))],o=Buffer.alloc(Fa.span);return Fa.encode({instruction:1,amount:Number(e)},o),new Va({keys:n,programId:r,data:o})}function zr({programId:r},e){let t=[{pubkey:Wa,isSigner:!1,isWritable:!1},{pubkey:Ps,isSigner:!1,isWritable:!1},...Object.entries(e).map(([o,i])=>({pubkey:i,isSigner:o==="userOwner",isWritable:!["authority","userOwner"].includes(o)}))],n=Buffer.alloc(Li.span);return Li.encode({instruction:2},n),new Va({keys:t,programId:r,data:n})}function Da(r){let{poolConfig:e,userKeys:t,side:n}=r,o=n==="base"?t.baseTokenAccount:t.quoteTokenAccount,i=n==="base"?e.baseVault:e.quoteVault,s=Buffer.alloc(Li.span);Li.encode({instruction:2},s);let a=[{pubkey:Wa,isWritable:!1,isSigner:!1},{pubkey:qf,isWritable:!1,isSigner:!1},{pubkey:e.id,isWritable:!0,isSigner:!1},{pubkey:e.authority,isWritable:!1,isSigner:!1},{pubkey:i,isWritable:!0,isSigner:!1},{pubkey:o,isWritable:!0,isSigner:!1},{pubkey:t.ledgerAccount,isWritable:!0,isSigner:!1},{pubkey:t.owner,isWritable:!1,isSigner:!0}];return new Va({programId:e.programId,keys:a,data:s})}var Uf={[qo.IDO_PROGRAM_ID_V1.toString()]:1,[qo.IDO_PROGRAM_ID_V2.toString()]:2,[qo.IDO_PROGRAM_ID_V3.toString()]:3,[qo.IDO_PROGRAM_ID_V4.toString()]:4},xo=class extends Re{async claim({ownerInfo:e,idoKeys:t,associatedOnly:n=!0,checkCreateATAOwner:o=!1,txVersion:i,feePayer:s}){let a=this.createTxBuilder(s),c=Uf[t.programId];c||this.logAndCreateError("invalid version",c);let u=Le(t),[l,d]=[!new Tl(e.coin).isZero(),!new Tl(e.pc).isZero()],m=u.projectInfo.mint.address.equals(j),{account:p,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.projectInfo.mint.programId,mint:u.projectInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!m,notUseTokenAccount:m,associatedOnly:m?!1:n,checkCreateATAOwner:o});!p&&l&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),l&&y&&a.addInstruction(y);let f=u.buyInfo.mint.address.equals(j),{account:b,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.buyInfo.mint.programId,mint:u.buyInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!f,notUseTokenAccount:f,associatedOnly:f?!1:n,checkCreateATAOwner:o});if(!p&&d&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),d&&g&&a.addInstruction(g),(!p||!b)&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address,t.buyInfo.mint.address),c===3)return a.addInstruction({instructions:[...l?[zr({programId:u.programId},{idoId:u.id,authority:u.authority,poolTokenAccount:u.projectInfo.vault,userTokenAccount:p,userIdoInfo:new Ri(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[],...d?[zr({programId:new Ri(t.programId)},{idoId:u.id,authority:u.authority,poolTokenAccount:u.buyInfo.vault,userTokenAccount:b,userIdoInfo:new Ri(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[]]}).versionBuild({txVersion:i});if(c<3)return!l&&!d&&this.logAndCreateError("no claimable rewards"),a.addInstruction({instructions:[zr({programId:u.programId},{idoId:u.id,authority:u.authority,poolQuoteTokenAccount:u.buyInfo.vault,poolBaseTokenAccount:u.projectInfo.vault,userQuoteTokenAccount:b,userBaseTokenAccount:p,userIdoInfo:new Ri(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]}).versionBuild({txVersion:i});let w={poolConfig:{id:u.id,programId:u.programId,authority:u.authority,baseVault:u.projectInfo.vault,quoteVault:u.buyInfo.vault,baseToken:t.projectInfo.mint,quoteToken:t.buyInfo.mint},userKeys:{baseTokenAccount:p,quoteTokenAccount:b,ledgerAccount:new Ri(e.userIdoInfo),owner:this.scope.ownerPubKey}};return a.addInstruction({instructions:[...l?[Da({...w,side:"base"})]:[],...d?[Da({...w,side:"quote"})]:[]]}).versionBuild({txVersion:i})}};var Gf=Buffer.from("vault_auth_seed","utf8"),Xf=Buffer.from("global_config","utf8"),Qf=Buffer.from("pool","utf8"),zf=Buffer.from("pool_vault","utf8"),Hf=Buffer.from("pool_vesting","utf8"),jf=Buffer.from("platform_config","utf8");function to(r){return te([Gf],r)}function vC(r,e,t,n){return te([Xf,e.toBuffer(),Yf(t),xr(n)],r)}function Hr(r,e,t){return te([Qf,e.toBuffer(),t.toBuffer()],r)}function qa(r,e,t){return te([zf,e.toBuffer(),t.toBuffer()],r)}function Yf(r){let e=new ArrayBuffer(1);return new DataView(e).setUint8(0,r),new Uint8Array(e)}function So(r){return te([Buffer.from("__event_authority","utf8")],r)}function Ua(r,e){return te([jf,e.toBuffer()],r)}function Ga(r,e,t){return te([Hf,e.toBuffer(),t.toBuffer()],r)}import{SystemProgram as Ni,TransactionInstruction as an}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Il}from"@solana/spl-token";import jr from"bn.js";var un={initialize:Buffer.from([175,175,109,31,13,152,155,237]),buyExactIn:Buffer.from([250,234,13,123,213,156,19,236]),buyExactOut:Buffer.from([24,211,116,40,105,3,153,56]),sellExactIn:Buffer.from([149,39,222,155,211,124,152,26]),sellExactOut:Buffer.from([95,200,71,34,8,9,11,166]),createVestingAccount:Buffer.from([129,178,2,13,217,172,230,218]),claimVestedToken:Buffer.from([49,33,104,30,189,157,79,35]),createPlatformConfig:Buffer.from([176,90,196,175,253,113,220,20]),claimPlatformFee:Buffer.from([156,39,208,135,76,237,61,72]),updatePlaformConfig:Buffer.from([195,60,76,129,146,45,67,143])};function Bl(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x){let T=O([F("decimals"),jt("name"),jt("symbol"),jt("uri")]),B=O([A("totalLockedAmount"),A("cliffPeriod"),A("unlockPeriod")]),S=O([F("index"),A("supply"),A("totalFundRaisingB"),F("migrateType")]),I=O([F("index"),A("supply"),A("totalSellA"),A("totalFundRaisingB"),F("migrateType")]),K=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:qt,isSigner:!1,isWritable:!1},{pubkey:Ni.programId,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:So(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}],N=Buffer.alloc(Buffer.from(f,"utf-8").length+Buffer.from(b,"utf-8").length+Buffer.from(g,"utf-8").length+4*3+1),v=Buffer.alloc(B.span),_=Buffer.alloc(w.type==="ConstantCurve"?I.span:S.span);return T.encode({decimals:y,name:f,symbol:b,uri:g},N),w.type==="ConstantCurve"?I.encode({index:0,...w,migrateType:w.migrateType==="amm"?0:1},_):w.type==="FixedCurve"?S.encode({index:1,...w,migrateType:w.migrateType==="amm"?0:1},_):w.type==="LinearCurve"&&S.encode({index:2,...w,migrateType:w.migrateType==="amm"?0:1},_),B.encode({totalLockedAmount:k,cliffPeriod:h,unlockPeriod:x},v),new an({keys:K,programId:r,data:Buffer.from([...un.initialize,...N,..._,...v])})}function xl(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g){let w=O([A("amountB"),A("minAmountA"),A("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:So(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0}),console.log({amountB:y.toString(),minAmountA:f.toString()});let h=Buffer.alloc(w.span);return w.encode({amountB:y,minAmountA:f,shareFeeRate:b??new jr(0)},h),new an({keys:k,programId:r,data:Buffer.from([...un.buyExactIn,...h])})}function GC(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g){let w=O([A("amountA"),A("maxAmountB"),A("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:So(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let h=Buffer.alloc(w.span);return w.encode({amountA:y,maxAmountB:f,shareFeeRate:b??new jr(0)},h),new an({keys:k,programId:r,data:Buffer.from([...un.buyExactOut,...h])})}function Sl(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g){let w=O([A("amountA"),A("minAmountB"),A("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:So(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let h=Buffer.alloc(w.span);return w.encode({amountA:y,minAmountB:f,shareFeeRate:b??new jr(0)},h),new an({keys:k,programId:r,data:Buffer.from([...un.sellExactIn,...h])})}function XC(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g){let w=O([A("amountB"),A("maxAmountA"),A("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:So(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let h=Buffer.alloc(w.span);return w.encode({amountB:y,maxAmountA:f,shareFeeRate:b??new jr(0)},h),new an({keys:k,programId:r,data:Buffer.from([...un.sellExactOut,...h])})}function Kl(r,e,t,n,o,i,s,a,c){let u=O([]),l=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:Ni.programId,isSigner:!1,isWritable:!1},{pubkey:Il,isSigner:!1,isWritable:!1}],d=Buffer.alloc(u.span);return u.encode({},d),new an({keys:l,programId:r,data:Buffer.from([...un.claimVestedToken,...d])})}function Cl(r,e,t,n,o,i){let s=O([A("shareAmount")]),a=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:Ni.programId,isSigner:!1,isWritable:!1}],c=Buffer.alloc(s.span);return s.encode({shareAmount:i},c),new an({keys:a,programId:r,data:Buffer.from([...un.createVestingAccount,...c])})}function Xa(r,e,t,n,o,i,s,a,c){let u=[{pubkey:e,isSigner:!0,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Ni.programId,isSigner:!1,isWritable:!0},{pubkey:Il,isSigner:!1,isWritable:!0}];return new an({keys:u,programId:r,data:un.claimPlatformFee})}function Ll(r,e,t,n,o,i,s,a,c,u,l){let d=O([A("platformScale"),A("creatorScale"),A("burnScale"),A("feeRate"),jt("name"),jt("web"),jt("img")]),m=[{pubkey:e,isSigner:!0,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:Ni.programId,isSigner:!1,isWritable:!1}],p=Buffer.alloc(8*4+Buffer.from(c,"utf-8").length+Buffer.from(u,"utf-8").length+Buffer.from(l,"utf-8").length+4*3);return d.encode({platformScale:s.platformScale,creatorScale:s.creatorScale,burnScale:s.burnScale,feeRate:a,name:c,web:u,img:l},p),new an({keys:m,programId:r,data:Buffer.from([...un.createPlatformConfig,...p])})}function Rl(r,e,t,n){let o=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0}],i;if(n.type==="updateClaimFeeWallet"){let s=O([F("index"),L("value")]);i=Buffer.alloc(s.span),s.encode({index:0,value:n.value},i)}else if(n.type==="updateLockNftWallet"){let s=O([F("index"),L("value")]);i=Buffer.alloc(s.span),s.encode({index:1,value:n.value},i)}else if(n.type==="migrateCpLockNftScale"){let s=O([F("index"),A("platformScale"),A("creatorScale"),A("burnScale")]);i=Buffer.alloc(s.span),s.encode({index:2,...n.value},i)}else if(n.type==="updateFeeRate"){let s=O([F("index"),A("value")]);i=Buffer.alloc(s.span),s.encode({index:3,value:n.value},i)}else if(n.type==="updateImg"||n.type==="updateName"||n.type==="updateWeb"){let s=O([F("index"),jt("value")]);i=Buffer.alloc(Buffer.from(n.value,"utf-8").length+4+1*1),n.type==="updateName"?s.encode({index:4,value:n.value},i):n.type==="updateWeb"?s.encode({index:5,value:n.value},i):n.type==="updateImg"&&s.encode({index:6,value:n.value},i)}else if(n.type==="updateCpConfigId"){o.push({pubkey:n.value,isSigner:!1,isWritable:!1});let s=O([F("index")]);i=Buffer.alloc(s.span),s.encode({index:7},i)}else if(n.type==="updateAll"){console.log("Please note that this update will overwrite all data in the platform account with the new data."),o.push({pubkey:n.value.cpConfigId,isSigner:!1,isWritable:!1});let s=O([F("index"),L("platformClaimFeeWallet"),L("platformLockNftWallet"),A("platformScale"),A("creatorScale"),A("burnScale"),A("feeRate"),jt("name"),jt("web"),jt("img")]);i=Buffer.alloc(1+32+32+8*4+4*3+Buffer.from(n.value.name,"utf-8").length+Buffer.from(n.value.web,"utf-8").length+Buffer.from(n.value.img,"utf-8").length),s.encode({index:8,platformClaimFeeWallet:n.value.platformClaimFeeWallet,platformLockNftWallet:n.value.platformLockNftWallet,platformScale:n.value.migrateCpLockNftScale.platformScale,creatorScale:n.value.migrateCpLockNftScale.creatorScale,burnScale:n.value.migrateCpLockNftScale.burnScale,feeRate:n.value.feeRate,name:n.value.name,web:n.value.web,img:n.value.img},i)}else throw Error("updateInfo params type error");return new an({keys:o,programId:r,data:Buffer.from([...un.updatePlaformConfig,...i])})}import{NATIVE_MINT as es,TOKEN_PROGRAM_ID as St,createAssociatedTokenAccountIdempotentInstruction as Mi}from"@solana/spl-token";import de from"bn.js";import{PublicKey as Ol}from"@solana/web3.js";var Ko=O([A(),A("epoch"),F("curveType"),Ht("index"),A("migrateFee"),A("tradeFeeRate"),A("maxShareFeeRate"),A("minSupplyA"),A("maxLockRate"),A("minSellRateA"),A("minMigrateRateA"),A("minFundRaisingB"),L("mintB"),L("protocolFeeOwner"),L("migrateFeeOwner"),L("migrateToAmmWallet"),L("migrateToCpmmWallet"),Q(A(),16)]),Zf=O([A("totalLockedAmount"),A("cliffPeriod"),A("unlockPeriod"),A("startTime"),A("totalAllocatedShare")]),hn=O([A(),A("epoch"),F("bump"),F("status"),F("mintDecimalsA"),F("mintDecimalsB"),F("migrateType"),A("supply"),A("totalSellA"),A("virtualA"),A("virtualB"),A("realA"),A("realB"),A("totalFundRaisingB"),A("protocolFee"),A("platformFee"),A("migrateFee"),Zf.replicate("vestingSchedule"),L("configId"),L("platformId"),L("mintA"),L("mintB"),L("vaultA"),L("vaultB"),L("creator"),Q(A(),8)]),HC=O([A(),A("epoch"),L("poolId"),L("beneficiary"),A("claimedAmount"),A("tokenShareAmount"),Q(A(),8)]),Yr=O([A(),A("epoch"),L("platformClaimFeeWallet"),L("platformLockNftWallet"),A("platformScale"),A("creatorScale"),A("burnScale"),A("feeRate"),Q(F(),64,"name"),Q(F(),256,"web"),Q(F(),256,"img"),L("cpConfigId"),Q(F(),224)]);import cn from"bn.js";import Oi from"bn.js";var Vn=class{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){throw Error()}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:i,decimalA:s,decimalB:a}){throw Error()}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:i}){throw Error()}static buyExactIn({poolInfo:e,amount:t}){throw Error()}static buyExactOut({poolInfo:e,amount:t}){throw Error()}static sellExactIn({poolInfo:e,amount:t}){throw Error()}static sellExactOut({poolInfo:e,amount:t}){throw Error()}};var Zr=class extends Vn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){return new C(t.toString()).div(e.toString()).mul(10**(n-o))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualB.add(e.realB).toString()).div(e.virtualA.sub(e.realA).toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:i,decimalA:s,decimalB:a}){return new C(o.sub(i).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let o=e.totalSellA.sub(e.realA),i=e.totalFundRaisingB.sub(e.realB);return new C(e.virtualB.add(e.realB.add(i)).toString()).div(e.virtualA.sub(e.realA.add(o)).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:i}){if(e.lte(n))throw Error("supply need gt total sell");let s=e.sub(n).sub(o);if(s.lte(new Oi(0)))throw Error("supplyMinusSellLocked <= 0");let a=t.sub(i);if(a.lte(new Oi(0)))throw Error("tfMinusMf <= 0");let c=a.mul(n).mul(n).div(s),u=a.mul(n).div(s).sub(t);if(u.lt(new Oi(0)))throw Error("supply/totalSell/totalLockedAmount diff too high");let l=c.div(u),d=t.mul(t).div(u);if(l.lt(new Oi(0))||d.lt(new Oi(0)))throw Error("invalid input 0");return{a:l,b:d,c:n}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static getAmountOut({amountIn:e,inputReserve:t,outputReserve:n}){let o=e.mul(n),i=t.add(e);return o.div(i)}static getAmountIn({amountOut:e,inputReserve:t,outputReserve:n}){let o=t.mul(e),i=n.sub(e);return rr(o,i)}};import Nl from"bn.js";var $r=class extends Vn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){return new C(t.toString()).div(e.toString()).mul(10**(n-o))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:i,decimalA:s,decimalB:a}){return new C(o.sub(i).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let o=e.totalSellA.sub(e.realA),i=e.totalFundRaisingB.sub(e.realB);return new C(e.virtualB.add(e.realB).add(i).toString()).div(e.virtualA.sub(e.realA).add(o).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:i}){let s=e.sub(o);if(s.lte(new Nl(0)))throw Error("invalid input 1");let a=new Nl(2).mul(t).sub(i),u=t.mul(s).div(a);return{a:u,b:t,c:u}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualB,initOutput:e.virtualA})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualB,initOutput:e.virtualA})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualA,initOutput:e.virtualB})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualA,initOutput:e.virtualB})}static getAmountOut({amountIn:e,initInput:t,initOutput:n}){return n.mul(e).div(t)}static getAmountIn({amountOut:e,initInput:t,initOutput:n}){let o=t.mul(e);return rr(o,n)}};import xt from"bn.js";import Co from"bn.js";var vi=class{static _multipler(e){return new C(10).pow(e)}static getPrice({priceX64:e,decimalA:t,decimalB:n}){return new C(e.toString()).div(this._Q64).mul(this._multipler(t)).div(this._multipler(n))}static getPriceX64({price:e,decimalA:t,decimalB:n}){let o=e.mul(this._multipler(n)).div(this._multipler(t));return new Co(o.mul(this._Q64).toFixed(0))}};Ct(vi,"_Q64",new C(new Co(1).shln(64).toString()));function d0({supply:r,totalFundRaisingB:e,totalLockedAmount:t,totalSellA:n,migrateType:o,decimalsA:i}){let s=r.sub(n).sub(t),a=new Co(new C(s.mul(e).toString()).sqrt().toFixed(0));if(o==="amm"){if(a.gt(new Co(10).pow(new Co(i))))return!0}else if(o==="cpmm"){if(a.gt(new Co(100)))return!0}else throw Error("migrate type error");return!1}var Jr=class extends Vn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new C(0)}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){return new C(0)}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualA.mul(e.realA).toString()).div(vi._Q64).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:i,decimalA:s,decimalB:a}){return new C(o.sub(i).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let o=e.totalSellA.sub(e.realA),i=e.totalFundRaisingB.sub(e.realB);return new C(e.virtualB.add(e.realB).add(i).toString()).div(e.virtualA.sub(e.realA).add(o).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:i}){let s=e.sub(o);if(s.lte(new xt(0)))throw Error("supplyMinusLocked need gt 0");let a=t.mul(new xt(3)).sub(i),u=t.mul(new xt(2)).mul(s).div(a),l=u.mul(u),d=t.mul(new xt(2)).mul(Xe).div(l);if(!d.gt(new xt(0)))throw Error("a need gt 0");if(!ii.gt(d))throw Error("a need lt u64 max");return{a:d,b:new xt(0),c:u}}static buyExactIn({poolInfo:e,amount:t}){let n=e.realB.add(t),o=new xt(2).mul(n).mul(Xe).div(e.virtualA);return new xt(new C(o.toString()).sqrt().toFixed(0)).sub(e.realA)}static buyExactOut({poolInfo:e,amount:t}){let n=e.realA.add(t),o=n.mul(n),{div:i,mod:s}=e.virtualA.mul(o).divmod(new xt(2).mul(Xe));return(s.isZero()?i:i.add(new xt(1))).sub(e.realB)}static sellExactIn({poolInfo:e,amount:t}){let n=e.realA.sub(t),o=n.mul(n),{div:i,mod:s}=e.virtualA.mul(o).divmod(new xt(2).mul(Xe)),a=s.isZero()?i:i.add(new xt(1));return e.realB.sub(a)}static sellExactOut({poolInfo:e,amount:t}){let n=e.realB.sub(t),o=new xt(2).mul(n).mul(Xe).div(e.virtualA),i=new xt(new C(o.toString()).sqrt().toFixed(0));return e.realA.sub(i)}};var ln=class{static getPoolCurvePointByPoolInfo({curveType:e,pointCount:t,poolInfo:n}){return this.getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n.supply,totalFundRaising:n.totalFundRaisingB,totalSell:n.totalSellA,totalLockedAmount:n.vestingSchedule.totalLockedAmount,migrateFee:n.migrateFee,decimalA:n.mintDecimalsA,decimalB:n.mintDecimalsB})}static getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n,totalFundRaising:o,totalSell:i,totalLockedAmount:s,migrateFee:a,decimalA:c,decimalB:u}){if(t<3)throw Error("point count < 3");let l=this.getCurve(e),d=l.getInitParam({supply:n,totalFundRaising:o,totalSell:i,totalLockedAmount:s,migrateFee:a}),m=l.getPoolInitPriceByInit({...d,decimalA:c,decimalB:u}),p=o.div(new cn(t-1)),y=new cn(0),f=[{price:m,totalSellSupply:0}],{a:b,b:g}=d,w=y,k=y;for(let h=1;h<t;h++){let x=h!==t-1?p:o.sub(k),T=this.buyExactIn({poolInfo:{virtualA:b,virtualB:g,realA:w,realB:k,totalFundRaisingB:o,totalSellA:i},amountB:x,protocolFeeRate:y,platformFeeRate:y,curveType:e,shareFeeRate:y});w=w.add(T.amountA),k=k.add(T.amountB);let B=this.getPrice({poolInfo:{virtualA:b,virtualB:g,realA:w,realB:k},decimalA:c,decimalB:u,curveType:e});f.push({price:B,totalSellSupply:new C(w.toString()).div(10**c).toNumber()})}return f}static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n,curveType:o}){return this.getCurve(o).getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n})}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o,curveType:i}){return this.getCurve(i).getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o})}static getPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:o}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:o})}static getEndPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:o}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:o})}static getPoolEndPriceReal({poolInfo:e,curveType:t,decimalA:n,decimalB:o}){return this.getCurve(t).getPoolEndPriceReal({poolInfo:e,decimalA:n,decimalB:o})}static checkParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,decimals:i,config:s,migrateType:a}){if(Number(i)!==6)throw Error("decimals = 6");if(e.mul(s.maxLockRate).div(Qt).lt(o))throw Error("total lock amount gte max lock amount");if(e.lt(s.minSupplyA.mul(new cn(10**i))))throw Error("supply lt min supply");let u=e.mul(s.minSellRateA).div(Qt);if(n.lt(u))throw Error("invalid input");if(t.lt(s.minFundRaisingB))throw Error("total fund raising lt min fund raising");let l=e.sub(n).sub(o),d=e.mul(s.minMigrateRateA).div(Qt);if(l.lt(d))throw Error("migrate lt min migrate amount");let m=e.sub(n).sub(o),p=new cn(new C(m.mul(t).toString()).sqrt().toFixed(0));if(a==="amm"){let y=new cn(10).pow(new cn(i));if(p.lte(y))throw Error("check migrate lp error")}else if(a==="cpmm"){let y=new cn(100);if(p.lte(y))throw Error("check migrate lp error")}else throw Error("migrate type error")}static buyExactIn({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:o,curveType:i,shareFeeRate:s}){let a=n.add(s).add(o),c=this.calculateFee({amount:t,feeRate:a}),u=t.sub(c),l=this.getCurve(i),d=l.buyExactIn({poolInfo:e,amount:u}),m=e.totalSellA.sub(e.realA),p,y,f;if(d.gt(m)){p=m;let g=l.buyExactOut({poolInfo:e,amount:p});y=this.calculatePreFee({postFeeAmount:g,feeRate:a}),f=y.sub(g)}else p=d,y=t,f=c;let b=this.splitFee({totalFee:f,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:p,amountB:y,splitFee:b}}static buyExactOut({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:o,curveType:i,shareFeeRate:s}){let a=e.totalSellA.sub(e.realA),c=t;t.gt(a)&&(c=a);let l=this.getCurve(i).buyExactOut({poolInfo:e,amount:t}),d=n.add(s).add(o),m=this.calculatePreFee({postFeeAmount:l,feeRate:d}),p=m.sub(l),y=this.splitFee({totalFee:p,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:c,amountB:m,splitFee:y}}static sellExactIn({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:o,curveType:i,shareFeeRate:s}){let c=this.getCurve(i).sellExactIn({poolInfo:e,amount:t}),u=this.calculateFee({amount:c,feeRate:n.add(s).add(o)}),l=this.splitFee({totalFee:u,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:t,amountB:c.sub(u),splitFee:l}}static sellExactOut({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:o,curveType:i,shareFeeRate:s}){let a=n.add(s).add(o),c=this.calculatePreFee({postFeeAmount:t,feeRate:a});if(e.realB.lt(c))throw Error("Insufficient liquidity");let u=c.sub(t),d=ln.getCurve(i).sellExactOut({poolInfo:e,amount:c});if(d.gt(e.realA))throw Error();let m=this.splitFee({totalFee:u,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:d,amountB:t,splitFee:m}}static splitFee({totalFee:e,protocolFeeRate:t,platformFeeRate:n,shareFeeRate:o}){let i=t.add(n).add(o),s=i.isZero()?new cn(0):e.mul(n).div(i),a=i.isZero()?new cn(0):e.mul(o).div(i),c=e.sub(s).sub(a);return{platformFee:s,shareFee:a,protocolFee:c}}static calculateFee({amount:e,feeRate:t}){return Ji(e,t,Qt)}static calculatePreFee({postFeeAmount:e,feeRate:t}){if(t.isZero())return e;let n=e.mul(Qt),o=Qt.sub(t);return n.add(o).sub(new cn(1)).div(o)}static getCurve(e){switch(e){case 0:return Zr;case 1:return $r;case 2:return Jr}throw Error("find curve error")}};var no={initPriceX64:new de("515752397214619"),supply:new de(1e15),totalSellA:new de(7931e11),totalFundRaisingB:new de(85e9),totalLockedAmount:new de("0"),cliffPeriod:new de("0"),unlockPeriod:new de("0"),decimals:6,virtualA:new de("1073471847374405"),virtualB:new de("30050573465"),realA:new de(0),realB:new de(0),protocolFee:new de(0),platformId:new Ol("4Bu96XjU84XjPDSpveTVf6LYGCkfW5FK7SNkREWcEfV4"),vestingSchedule:{totalLockedAmount:new de(0),cliffPeriod:new de(0),unlockPeriod:new de(0),startTime:new de(0),totalAllocatedShare:new de(0)}},ts=new de(1e4),Ei=class extends Re{constructor(e){super(e)}async createLaunchpad({programId:e=Gt,authProgramId:t,platformId:n=no.platformId,mintA:o,decimals:i=6,mintBDecimals:s=9,name:a,symbol:c,uri:u,migrateType:l,configId:d,configInfo:m,platformFeeRate:p,txVersion:y,computeBudgetConfig:f,txTipConfig:b,feePayer:g,buyAmount:w,minMintAAmount:k,slippage:h,associatedOnly:x=!0,checkCreateATAOwner:T=!1,extraSigners:B,...S}){let I=this.createTxBuilder(g);t=t??to(e).publicKey;let K=m;if(!K&&d){let at=await this.scope.connection.getAccountInfo(d);at&&(K=Ko.decode(at.data))}K||this.logAndCreateError("config not found");let N=K.mintB,v=K.curveType,{publicKey:_}=Hr(e,o,N),{publicKey:D}=qa(e,_,o),{publicKey:q}=qa(e,_,N),{publicKey:G}=gn(o);console.log(`create token: ${o.toBase58()}, mintB: ${N.toBase58()}, decimals A:${i}/B:${s}, config:${d.toBase58()}`),c.length>10&&this.logAndCreateError("Symbol length should shorter than 11"),u||this.logAndCreateError("uri should not empty"),w.lte(new de(0))&&this.logAndCreateError("buy amount should gt 0:",w.toString());let Y=S?.supply??no.supply,ie=S?.totalSellA??no.totalSellA,ke=S?.totalFundRaisingB??no.totalFundRaisingB,re=S?.totalLockedAmount??new de(0),ge=p;if(!p){let at=await this.scope.connection.getAccountInfo(n);at||this.logAndCreateError("platform id not found:",n.toString()),ge=Yr.decode(at.data).feeRate}let st=ln.getCurve(K.curveType).getInitParam({supply:Y,totalFundRaising:ke,totalSell:ie,totalLockedAmount:re,migrateFee:K.migrateFee}),je={epoch:new de(896),bump:254,status:0,mintDecimalsA:i,mintDecimalsB:s,supply:Y,totalSellA:ie,mintA:new Ol(o),mintB:N,virtualA:st.a,virtualB:st.b,realA:no.realA,realB:no.realB,migrateFee:K.migrateFee,migrateType:l==="amm"?0:1,protocolFee:no.protocolFee,platformFee:ge,platformId:n,configId:d,vaultA:D,vaultB:q,creator:this.scope.ownerPubKey,totalFundRaisingB:ke,vestingSchedule:{totalLockedAmount:re,cliffPeriod:new de(0),unlockPeriod:new de(0),startTime:new de(0),totalAllocatedShare:new de(0)}},At=ln.getCurve(K.curveType),{c:Kt}=At.getInitParam({supply:je.supply,totalFundRaising:je.totalFundRaisingB,totalLockedAmount:re,totalSell:K.curveType===0?je.totalSellA:new de(0),migrateFee:K.migrateFee});try{ln.checkParam({supply:je.supply,totalFundRaising:je.totalFundRaisingB,totalSell:Kt,totalLockedAmount:re,decimals:je.mintDecimalsA,config:K,migrateType:l}),console.log("check init params success")}catch(at){this.logAndCreateError(`check create mint params failed, ${at.message}`)}I.addInstruction({instructions:[Bl(e,g??this.scope.ownerPubKey,this.scope.ownerPubKey,d,n,t,_,o,N,D,q,G,St,St,i,a,c,u||"https://",{type:v===0?"ConstantCurve":v===1?"FixedCurve":v===2?"LinearCurve":"ConstantCurve",totalSellA:ie,migrateType:l,supply:Y,totalFundRaisingB:ke},re,S?.cliffPeriod??new de(0),S?.unlockPeriod??new de(0))]});let $t=new de(0),mn;if(B?.length&&I.addInstruction({signers:B}),!S.createOnly){let{builder:at,extInfo:Ye}=await this.buyToken({programId:e,authProgramId:t,mintA:o,mintB:N,poolInfo:je,buyAmount:w,minMintAAmount:k,shareFeeRate:S.shareFeeRate,shareFeeReceiver:S.shareFeeReceiver,configInfo:K,platformFeeRate:ge,slippage:h,associatedOnly:x,checkCreateATAOwner:T});I.addInstruction({...at.AllTxData}),$t=Ye.outAmount,mn=(this.scope.cluster==="devnet"||y===1)&&S.shareFeeReceiver?[at.allInstructions[0]]:void 0}return I.addTipInstruction(b),y===0?I.sizeCheckBuildV0({computeBudgetConfig:f,outAmount:$t,splitIns:mn,address:{...je,poolId:_}}):I.sizeCheckBuild({computeBudgetConfig:f,outAmount:$t,splitIns:mn,address:{...je,poolId:_}})}async buyToken({programId:e=Gt,authProgramId:t,mintA:n,mintB:o=es,poolInfo:i,configInfo:s,platformFeeRate:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:d,buyAmount:m,minMintAAmount:p,slippage:y,shareFeeRate:f=new de(0),shareFeeReceiver:b,associatedOnly:g=!0,checkCreateATAOwner:w=!1}){m.lte(new de(0))&&this.logAndCreateError("buy amount should gt 0:",m.toString());let k=this.createTxBuilder(d),{publicKey:h}=Hr(e,n,o);t=t??to(e).publicKey;let x=null,T=null,B=o.equals(es),{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:n,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:g,checkCreateATAOwner:w});S&&(x=S),k.addInstruction(I||{}),x===void 0&&this.logAndCreateError(`cannot found mintA(${n.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let{account:K,instructionParams:N}=await this.scope.account.getOrCreateTokenAccount({mint:o,owner:this.scope.ownerPubKey,createInfo:B?{payer:this.scope.ownerPubKey,amount:m}:void 0,skipCloseAccount:!B,notUseTokenAccount:B,associatedOnly:B?!1:g,checkCreateATAOwner:w});K&&(T=K),k.addInstruction(N||{}),T===void 0&&this.logAndCreateError(`cannot found mintB(${o.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let v=i;if(!v){let re=await this.scope.connection.getAccountInfo(h,{commitment:"processed"});re||this.logAndCreateError("cannot found pool:",h.toBase58()),v=hn.decode(re.data)}let _=s,D=await Se(this.scope.connection,[_?void 0:v.configId,a?void 0:v.platformId].filter(Boolean).map(re=>({pubkey:re})));if(!_){let re=D.find(ge=>ge.pubkey.equals(v.configId));(!re||!re.accountInfo)&&this.logAndCreateError("config not found: ",v.configId.toBase58()),_=Ko.decode(re.accountInfo.data)}if(!a){let re=D.find(ge=>ge.pubkey.equals(v.platformId));(!re||!re.accountInfo)&&this.logAndCreateError("platform info not found: ",v.configId.toBase58()),a=Yr.decode(re.accountInfo.data).feeRate}let q=ln.buyExactIn({poolInfo:v,amountB:m,protocolFeeRate:_.tradeFeeRate,platformFeeRate:a,curveType:_.curveType,shareFeeRate:f}),G=new C(q.amountA.toString()),Y=y?new C(ts.sub(y).toNumber()/ts.toNumber()).clampedTo(0,1):new C(1),ie=p??(y?new de(G.mul(Y).toFixed(0)):q.amountA);q.amountB.lt(m)&&console.log(`maximum ${n.toBase58()} amount can buy is ${q.amountA.toString()}, input ${o.toBase58()} amount: ${q.amountB.toString()}`);let ke=b?Z(b,o,St).publicKey:void 0;return ke&&k.addInstruction({instructions:[Mi(this.scope.ownerPubKey,ke,b,o)]}),k.addInstruction({instructions:[xl(e,this.scope.ownerPubKey,t,v.configId,v.platformId,h,x,T,v.vaultA,v.vaultB,n,o,St,St,q.amountB.lt(m)?q.amountB:m,ie,f,ke)]}),k.addCustomComputeBudget(u),k.addTipInstruction(l),k.versionBuild({txVersion:c,extInfo:{outAmount:ie}})}async sellToken({programId:e=Gt,authProgramId:t,mintA:n,mintB:o=es,poolInfo:i,configInfo:s,platformFeeRate:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:d,sellAmount:m,minAmountB:p,slippage:y,shareFeeRate:f=new de(0),shareFeeReceiver:b,associatedOnly:g=!0,checkCreateATAOwner:w=!1}){t=t??to(e).publicKey;let k=this.createTxBuilder(d);m.lte(new de(0))&&this.logAndCreateError("sell amount should be gt 0");let{publicKey:h}=Hr(e,n,o),x=null,T=null,B=o.equals(es),{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:n,owner:this.scope.ownerPubKey,createInfo:void 0,skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:g,checkCreateATAOwner:w});S&&(x=S),k.addInstruction(I||{}),x===void 0&&this.logAndCreateError("cannot found mintA token accounts","tokenAccounts",this.scope.account.tokenAccounts);let{account:K,instructionParams:N}=await this.scope.account.getOrCreateTokenAccount({mint:o,owner:this.scope.ownerPubKey,createInfo:B?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!B,notUseTokenAccount:B,associatedOnly:B?!1:g,checkCreateATAOwner:w});K&&(T=K),k.addInstruction(N||{}),T===void 0&&this.logAndCreateError("cannot found mintB token accounts","tokenAccounts",this.scope.account.tokenAccounts);let v=i;if(!v){let re=await this.scope.connection.getAccountInfo(h,{commitment:"processed"});re||this.logAndCreateError("cannot found pool",h.toBase58()),v=hn.decode(re.data)}let _=s,D=await Se(this.scope.connection,[_?void 0:v.configId,a?void 0:v.platformId].filter(Boolean).map(re=>({pubkey:re})));if(!_){let re=D.find(ge=>ge.pubkey.equals(v.configId));(!re||!re.accountInfo)&&this.logAndCreateError("config not found: ",v.configId.toBase58()),_=Ko.decode(re.accountInfo.data)}if(!a){let re=D.find(ge=>ge.pubkey.equals(v.platformId));(!re||!re.accountInfo)&&this.logAndCreateError("platform info not found: ",v.configId.toBase58()),a=Yr.decode(re.accountInfo.data).feeRate}let q=ln.sellExactIn({poolInfo:v,amountA:m,protocolFeeRate:_.tradeFeeRate,platformFeeRate:a,curveType:_.curveType,shareFeeRate:f}),G=new C(q.amountB.toString()),Y=y?new C(ts.sub(y).toNumber()/ts.toNumber()).clampedTo(0,1):new C(1),ie=p??(y?new de(G.mul(Y).toFixed(0)):q.amountB);ie.lte(new de(0))&&this.logAndCreateError(`out ${o.toBase58()} amount should be gt 0`);let ke=b?Z(b,o,St).publicKey:void 0;return ke&&k.addInstruction({instructions:[Mi(this.scope.ownerPubKey,ke,b,o)]}),k.addInstruction({instructions:[Sl(e,this.scope.ownerPubKey,t,v.configId,v.platformId,h,x,T,v.vaultA,v.vaultB,n,o,St,St,q.amountA.lt(m)?q.amountA:m,ie,f,ke)]}),k.addCustomComputeBudget(u),k.addTipInstruction(l),k.versionBuild({txVersion:c,extInfo:{outAmount:ie}})}async createPlatformConfig({programId:e=Gt,platformAdmin:t,platformClaimFeeWallet:n,platformLockNftWallet:o,cpConfigId:i,migrateCpLockNftScale:s,feeRate:a,name:c,web:u,img:l,txVersion:d,computeBudgetConfig:m,txTipConfig:p,feePayer:y}){let f=this.createTxBuilder(y),{publicKey:b}=Ua(e,t);return f.addInstruction({instructions:[Ll(e,t,n,o,b,i,s,a,c,u,l)]}),f.addCustomComputeBudget(m),f.addTipInstruction(p),f.versionBuild({txVersion:d,extInfo:{platformId:b}})}async updatePlatformConfig({programId:e=Gt,platformAdmin:t,platformId:n,updateInfo:o,txVersion:i,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l=n??Ua(e,t).publicKey;return u.addInstruction({instructions:[Rl(e,t,l,o)]}),u.addCustomComputeBudget(s),u.addTipInstruction(a),u.versionBuild({txVersion:i})}async claimPlatformFee({programId:e=Gt,authProgramId:t,platformId:n,poolId:o,platformClaimFeeWallet:i,mintB:s,vaultB:a,mintBProgram:c=St,txVersion:u,computeBudgetConfig:l,txTipConfig:d,feePayer:m}){let p=this.createTxBuilder(m);t=t??to(e).publicKey;let y=s,f=a;if(!y){let g=await this.scope.connection.getAccountInfo(o,{commitment:"processed"});g||this.logAndCreateError("cannot found pool:",o.toBase58());let w=hn.decode(g.data),k=await this.scope.connection.getAccountInfo(w.configId,{commitment:"processed"});k||this.logAndCreateError("cannot found config:",w.configId.toBase58()),y=Ko.decode(k.data).mintB,f=f??w.vaultB}(!y||!f)&&this.logAndCreateError("cannot found mint info, mintB: ",y.toBase58(),", vaultB: ",f?.toBase58()??"");let b=Z(this.scope.ownerPubKey,y,St).publicKey;return p.addInstruction({instructions:[Mi(this.scope.ownerPubKey,b,this.scope.ownerPubKey,y)]}),p.addInstruction({instructions:[Xa(e,i,t,o,n,f,b,y,c)]}),p.addCustomComputeBudget(l),p.addTipInstruction(d),p.versionBuild({txVersion:u})}async claimAllPlatformFee({programId:e=Gt,authProgramId:t,platformId:n,platformClaimFeeWallet:o,txVersion:i,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c);return t=t??to(e).publicKey,(await this.scope.connection.getProgramAccounts(e,{filters:[{dataSize:hn.span},{memcmp:{offset:hn.offsetOf("platformId"),bytes:n.toString()}}]})).forEach(d=>{let m=hn.decode(d.account.data),p=Z(this.scope.ownerPubKey,m.mintB,St).publicKey;u.addInstruction({instructions:[Mi(this.scope.ownerPubKey,p,this.scope.ownerPubKey,m.mintB)]}),u.addInstruction({instructions:[Xa(e,o,t,d.pubkey,n,m.vaultB,p,m.mintB,St)]})}),u.addTipInstruction(a),i===0?u.sizeCheckBuildV0({computeBudgetConfig:s}):u.sizeCheckBuild({computeBudgetConfig:s})}async createVesting({programId:e=Gt,poolId:t,beneficiary:n,shareAmount:o,txVersion:i,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l=Ga(e,t,n).publicKey;return u.addInstruction({instructions:[Cl(e,this.scope.ownerPubKey,n,t,l,o)]}),u.addCustomComputeBudget(s),u.addTipInstruction(a),u.versionBuild({txVersion:i})}async claimVesting({programId:e=Gt,poolId:t,poolInfo:n,txVersion:o,computeBudgetConfig:i,txTipConfig:s,feePayer:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1}){let l=this.createTxBuilder(a),d=to(e).publicKey,m=Ga(e,t,this.scope.ownerPubKey).publicKey,p=n;if(!p){let f=await this.scope.connection.getAccountInfo(t);f||this.logAndCreateError("pool not found"),p=hn.decode(f.data)}let y=Z(this.scope.ownerPubKey,p.mintA,St).publicKey;return l.addInstruction({instructions:[Mi(this.scope.ownerPubKey,y,this.scope.ownerPubKey,p.mintA)]}),l.addInstruction({instructions:[Kl(e,this.scope.ownerPubKey,d,t,m,y,p.vaultA,p.mintA,St)]}),l.addCustomComputeBudget(i),l.addTipInstruction(s),l.versionBuild({txVersion:o})}async getRpcPoolInfo({poolId:e}){return(await this.getRpcPoolsInfo({poolIdList:[e]})).poolInfoMap[e.toBase58()]}async getRpcPoolsInfo({poolIdList:e,config:t}){let n=await Se(this.scope.connection,e.map(c=>({pubkey:c})),t),o={},i=[];for(let c=0;c<e.length;c++){let u=n[c];if(u===null||!u.accountInfo)throw Error("fetch pool info error: "+e[c].toBase58());let l=hn.decode(u.accountInfo.data);o[e[c].toBase58()]={...l,poolId:u.accountInfo.owner},i.push(l.configId)}let s=await Se(this.scope.connection,i.map(c=>({pubkey:c})),t),a={};for(let c=0;c<i.length;c++){let u=s[c];if(u===null||!u.accountInfo)throw Error("fetch config info error: "+i[c].toBase58());let l=Ko.decode(u.accountInfo.data);a[i[c].toBase58()]={...l,configId:u.accountInfo.owner}}return{poolInfoMap:Object.keys(o).reduce((c,u)=>({...c,[u]:{...o[u],configInfo:a[o[u].configId.toBase58()]}}),{})}}};import{PublicKey as $f}from"@solana/web3.js";import{MintLayout as Jf,TOKEN_2022_PROGRAM_ID as Qa,TOKEN_PROGRAM_ID as za}from"@solana/spl-token";var _i=class extends Re{_tokenList=[];_tokenMap=new Map;_blackTokenMap=new Set;_mintGroup={official:new Set,jup:new Set,extra:new Set};_whiteMap=new Set;_extraTokenList=[];constructor(e){super(e)}async load(e){this.checkDisabled();let{forceUpdate:t=!1,type:n="strict"}=e||{},{mintList:o,blacklist:i,whiteList:s}=await this.scope.fetchV3TokenList(t),a=await this.scope.fetchJupTokenList(t);this._tokenList=[],this._tokenMap=new Map,this._blackTokenMap=new Set(i),this._mintGroup={official:new Set,jup:new Set,extra:new Set},this._whiteMap=new Set(s),this._tokenMap.set(tn.address,tn),this._mintGroup.official.add(tn.address),o.forEach(c=>{this._blackTokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"raydium",priority:2,programId:c.programId??(c.tags.includes("token-2022")?Qa.toBase58():za.toBase58())}),this._mintGroup.official.add(c.address))}),a.forEach(c=>{this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"jupiter",priority:1,programId:c.programId??(c.tags.includes("token-2022")?Qa.toBase58():za.toBase58()),tags:c.freezeAuthority?[...c.tags||[],"hasFreeze"]:c.tags}),this._mintGroup.jup.add(c.address))}),this._extraTokenList.forEach(c=>{this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"extra",priority:1,programId:c.programId||c.tags.includes("token-2022")?Qa.toBase58():za.toBase58()}),this._mintGroup.extra.add(c.address))}),this._tokenList=Array.from(this._tokenMap).map(c=>c[1])}get tokenList(){return this._tokenList}get tokenMap(){return this._tokenMap}get blackTokenMap(){return this._blackTokenMap}get mintGroup(){return this._mintGroup}get whiteListMap(){return this._whiteMap}async getTokenInfo(e){if(!e)throw new Error("please input mint");let t=e.toString(),n=this._tokenMap.get(t);if(n)return n;if(t.toLocaleUpperCase()==="SOL")return tn;let o=(await this.scope.api.getTokenInfo([t]))[0];if(o)return this._mintGroup.extra.add(t),this._tokenMap.set(t,{...o,priority:2}),o;let i=await this.scope.connection.getAccountInfo(new $f(t));if(!i)throw new Error(`mint address not found: ${t}`);let s=Jf.decode(i.data),a=t.toString().substring(0,6),c={chainId:101,address:t,programId:i.owner.toBase58(),logoURI:"",symbol:a,name:a,decimals:s.decimals,tags:[],extensions:{},priority:0,type:"unknown"};return this._mintGroup.extra.add(t),this._tokenMap.set(t,c),c}};var ns=class{cluster;farm;account;liquidity;clmm;cpmm;tradeV2;utils1216;marketV2;ido;token;launchpad;rawBalances=new Map;apiData;availability;blockhashCommitment;loopMultiTxStatus;_connection;_owner;api;_apiCacheTime;_signAllTransactions;logger;_chainTime;_epochInfo;constructor(e){let{connection:t,cluster:n,owner:o,api:i,defaultChainTime:s,defaultChainTimeOffset:a,apiCacheTime:c,blockhashCommitment:u="confirmed",loopMultiTxStatus:l}=e;this._connection=t,this.cluster=n||"mainnet",this._owner=o?new Ut(o):void 0,this._signAllTransactions=e.signAllTransactions,this.blockhashCommitment=u,this.loopMultiTxStatus=l,this.api=i,this._apiCacheTime=c||5*60*1e3,this.logger=me("Raydium"),this.farm=new oi({scope:this,moduleName:"Raydium_Farm"}),this.account=new zo({scope:this,moduleName:"Raydium_Account",tokenAccounts:e.tokenAccounts,tokenAccountRawInfos:e.tokenAccountRawInfos}),this.liquidity=new Ai({scope:this,moduleName:"Raydium_LiquidityV2"}),this.token=new _i({scope:this,moduleName:"Raydium_tokenV2"}),this.tradeV2=new Ci({scope:this,moduleName:"Raydium_tradeV2"}),this.clmm=new ki({scope:this,moduleName:"Raydium_clmm"}),this.cpmm=new xi({scope:this,moduleName:"Raydium_cpmm"}),this.utils1216=new Ft({scope:this,moduleName:"Raydium_utils1216"}),this.marketV2=new ho({scope:this,moduleName:"Raydium_marketV2"}),this.ido=new xo({scope:this,moduleName:"Raydium_ido"}),this.launchpad=new Ei({scope:this,moduleName:"Raydium_lauchpad"}),this.availability={};let d=new Date().getTime();this.apiData={},a&&(this._chainTime={fetched:d,value:{chainTime:s||Date.now()-a,offset:a}})}static async load(e){let t=ey({cluster:"mainnet",owner:null,apiRequestInterval:3e5,apiRequestTimeout:1e4},e),{cluster:n,apiRequestTimeout:o,logCount:i,logRequests:s,urlConfigs:a}=t,c=new dr({cluster:n,timeout:o,urlConfigs:a,logCount:i,logRequests:s}),u=new ns({...t,api:c});return await u.fetchAvailabilityStatus(e.disableFeatureCheck??!0),e.disableLoadToken||await u.token.load({type:e.jupTokenType}),u}get owner(){return this._owner}get ownerPubKey(){if(!this._owner)throw new Error(pr);return this._owner.publicKey}setOwner(e){return this._owner=e?new Ut(e):void 0,this.account.resetTokenAccounts(),this}get connection(){if(!this._connection)throw new Error(vu);return this._connection}setConnection(e){return this._connection=e,this}get signAllTransactions(){return this._signAllTransactions}setSignAllTransactions(e){return this._signAllTransactions=e,this}checkOwner(){if(!this.owner)throw console.error(pr),new Error(pr)}isCacheInvalidate(e){return new Date().getTime()-e>this._apiCacheTime}async fetchChainTime(){try{let e=await this.api.getChainTimeOffset();this._chainTime={fetched:Date.now(),value:{chainTime:Date.now()+e.offset*1e3,offset:e.offset*1e3}}}catch{this._chainTime=void 0}}async fetchV3TokenList(e){if(this.apiData.tokenList&&!this.isCacheInvalidate(this.apiData.tokenList.fetched)&&!e)return this.apiData.tokenList.data;try{let t=await this.api.getTokenList(),n={fetched:Date.now(),data:t};return this.apiData.tokenList=n,n.data}catch(t){return console.error(t),{mintList:[],blacklist:[],whiteList:[]}}}async fetchJupTokenList(e){let t=this.apiData.jupTokenList;if(t&&!this.isCacheInvalidate(t.fetched)&&!e)return t.data;try{let n=await this.api.getJupTokenList();return this.apiData.jupTokenList={fetched:Date.now(),data:n.map(o=>({...o,mintAuthority:o.mint_authority||void 0,freezeAuthority:o.freeze_authority||void 0}))},this.apiData.jupTokenList.data}catch(n){return console.error(n),[]}}get chainTimeData(){return this._chainTime?.value}async chainTimeOffset(){return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.offset:(await this.fetchChainTime(),this._chainTime?.value.offset||0)}async currentBlockChainTime(){return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.chainTime:(await this.fetchChainTime(),this._chainTime?.value.chainTime||Date.now())}async fetchEpochInfo(){return this._epochInfo&&Date.now()-this._epochInfo.fetched<=1e3*30?this._epochInfo.value:(this._epochInfo={fetched:Date.now(),value:await this.connection.getEpochInfo()},this._epochInfo.value)}async fetchAvailabilityStatus(e){if(e)return{};try{let t=await this.api.fetchAvailabilityStatus(),n=t.all===!1;return this.availability={all:t.all,swap:n?!1:t.swap,createConcentratedPosition:n?!1:t.createConcentratedPosition,addConcentratedPosition:n?!1:t.addConcentratedPosition,addStandardPosition:n?!1:t.addStandardPosition,removeConcentratedPosition:n?!1:t.removeConcentratedPosition,removeStandardPosition:n?!1:t.removeStandardPosition,addFarm:n?!1:t.addFarm,removeFarm:n?!1:t.removeFarm},t}catch{return{}}}};var K1=r=>r;export{Rp as AMM_CONFIG_SEED,Pc as BIT_PRECISION,ki as Clmm,Oc as ClmmConfigLayout,Be as ClmmInstrument,_r as ConstantProductCurve,Ra as CpmmConfigInfoLayout,Fr as CpmmFee,Bi as CpmmPoolInfoLayout,ln as Curve,Vn as CurveBase,Wr as CurveCalculator,$p as DataElement,la as EXTENSION_TICKARRAY_BITMAP_SIZE,rc as FARM_LOCK_MINT,sc as FARM_LOCK_VAULT,vt as FARM_PROGRAM_TO_VERSION,uc as FARM_VERSION_TO_LEDGER_LAYOUT,ac as FARM_VERSION_TO_STATE_LAYOUT,Br as FEE_RATE_DENOMINATOR,Wp as FETCH_TICKARRAY_COUNT,Lp as Fee,$r as FixedPriceCurve,Gf as LAUNCHPAD_AUTH_SEED,Xf as LAUNCHPAD_CONFIG_SEED,jf as LAUNCHPAD_POOL_PLATFORM_SEED,Qf as LAUNCHPAD_POOL_SEED,zf as LAUNCHPAD_POOL_VAULT_SEED,Hf as LAUNCHPAD_POOL_VESTING_SEED,Lr as LIQUIDITY_FEES_DENOMINATOR,fa as LIQUIDITY_FEES_NUMERATOR,jp as LIQUIDITY_VERSION_TO_SERUM_VERSION,mI as LIQUIDITY_VERSION_TO_STATE_LAYOUT,Nf as LOCK_LIQUIDITY_SEED,Ac as LOG_B_2_X32,wc as LOG_B_P_ERR_MARGIN_LOWER_X64,kc as LOG_B_P_ERR_MARGIN_UPPER_X64,Zr as LaunchPadConstantProductCurve,Ko as LaunchpadConfig,hn as LaunchpadPool,no as LaunchpadPoolInitParam,HC as LaunchpadVesting,Zf as LaunchpadVestingSchedule,Jr as LinearPriceCurve,ye as LiquidityMath,TT as LockClPositionLayoutV2,hT as LockPositionLayout,Sa as MARKET_STATE_LAYOUT_V2,Oa as MARKET_STATE_LAYOUT_V3,Pl as MARKET_VERSION_TO_STATE_LAYOUT,_t as MAX_SQRT_PRICE_X64,Ir as MAX_SQRT_PRICE_X64_SUB_ONE,gt as MAX_TICK,Et as MIN_SQRT_PRICE_X64,Tr as MIN_SQRT_PRICE_X64_ADD_ONE,mt as MIN_TICK,wo as MODEL_DATA_PUBKEY,Gr as Market,vi as MathLaunch,ae as MathUtil,ii as MaxU64,gc as MaxUint128,bn as NEGATIVE_ONE,Fp as OBSERVATION_SEED,Lt as ONE,Ep as OPERATION_SEED,vc as ObservationInfoLayout,Up as ObservationLayout,Mc as OperationLayout,Cc as POOL_LOCK_ID_SEED,vp as POOL_REWARD_VAULT_SEED,Np as POOL_SEED,_p as POOL_TICK_ARRAY_BITMAP_SEED,Op as POOL_VAULT_SEED,Bc as POSITION_SEED,Yr as PlatformConfig,Xn as PoolInfoLayout,Ce as PoolUtils,di as PositionInfoLayout,Xp as PositionRewardInfoLayout,ci as PositionUtils,kT as ProtocolPositionLayout,hr as Q128,Xe as Q64,ns as Raydium,Gp as RewardInfo,il as RoundDirection,bl as SERUM_PROGRAMID_TO_VERSION,gl as SERUM_VERSION_TO_PROGRAMID,tn as SOL_INFO,Vc as SPL_MINT_LAYOUT,Vp as SUPPORT_MINT_SEED,ne as SqrtPriceMath,Ao as StableLayout,Gn as SwapMath,Un as TICK_ARRAY_BITMAP_SIZE,Mp as TICK_ARRAY_SEED,He as TICK_ARRAY_SIZE,oh as TICK_SPACINGS,Ze as TOKEN_WSOL,Pn as TickArrayBitmap,Nc as TickArrayBitmapExtensionLayout,mi as TickArrayBitmapExtensionUtils,li as TickArrayLayout,Qp as TickLayout,Qn as TickMath,be as TickQuery,H as TickUtils,ri as U64Resolution,rh as U64_IGNORE_RANGE,oc as Voter,yp as VoterDepositEntry,fp as VoterLockup,nc as VoterRegistrar,pp as VoterVotingMintConfig,pe as ZERO,Pa as addLiquidityLayout,un as anchorDataBuf,qs as associatedLedgerAccountLayout,xl as buyExactInInstruction,GC as buyExactOutInstruction,ta as calFarmRewardAmount,d0 as checkPoolToAmm,Li as claimLayout,Xa as claimPlatformFee,Kl as claimVestedToken,Rc as clmmComputeInfoToApiInfo,yn as closeAccountInstruction,pl as collectCpFeeInstruction,Ef as cpmmLockPositionInstruction,Jo as createAssociatedLedgerAccountInstruction,Ll as createPlatformConfig,qc as createPoolFeeLayout,ha as createPoolV4InstructionV2,lI as createPoolV4Layout,Cl as createVestingAccount,Rn as createWSolAccountInstructions,bt as dwLayout,Qs as farmAddRewardLayout,Mw as farmLedgerLayoutV3_1,jo as farmLedgerLayoutV3_2,Ew as farmLedgerLayoutV5_1,ec as farmLedgerLayoutV5_2,tc as farmLedgerLayoutV6_1,lc as farmRewardInfoToConfig,Gs as farmRewardLayout,Xs as farmRewardRestartLayout,dp as farmRewardTimeInfoLayout,$u as farmStateV3Layout,Ju as farmStateV5Layout,Ho as farmStateV6Layout,ak as fetchMultipleFarmInfoAndUpdate,$I as fetchMultipleInfo,ya as fixedSwapInLayout,ba as fixedSwapOutLayout,cf as formatLayout,We as generatePubKey,cc as getAssociatedAuthority,Nr as getAssociatedConfigId,lt as getAssociatedLedgerAccount,Zo as getAssociatedLedgerPoolAccount,gf as getAssociatedOpenOrders,xa as getAssociatedPoolKeys,Dr as getCpLockPda,Zx as getCpmmPdaAmmConfigId,Ca as getCpmmPdaPoolId,sl as getCreatePoolKeys,na as getDepositEntryIndex,Qc as getDxByDyBaseIn,Xc as getDyByDxBaseIn,go as getFarmLedgerLayout,bp as getFarmStateLayout,Ba as getLiquidityAssociatedAuthority,Yn as getLiquidityAssociatedId,Zh as getLiquidityFromAmounts,dh as getPdaAmmConfigId,So as getPdaCpiEvent,De as getPdaExBitmapAccount,to as getPdaLaunchpadAuth,vC as getPdaLaunchpadConfigId,Hr as getPdaLaunchpadPoolId,qa as getPdaLaunchpadVaultId,ui as getPdaLockClPositionIdV2,ua as getPdaLockPositionId,Lf as getPdaLpMint,gn as getPdaMetadataKey,ca as getPdaMintExAccount,Kc as getPdaObservationAccount,Ti as getPdaObservationId,ai as getPdaOperationAccount,Pt as getPdaPersonalPositionAddress,Ua as getPdaPlatformId,Io as getPdaPoolAuthority,xc as getPdaPoolId,Sc as getPdaPoolRewardVaulId,aa as getPdaPoolVaultId,Zt as getPdaProtocolPositionAddress,fe as getPdaTickArrayAddress,rl as getPdaVault,Ga as getPdaVestId,js as getRegistrarAddress,zc as getStablePrice,ea as getTokenOwnerRecordAddress,$s as getVoterAddress,Js as getVoterWeightRecordAddress,Zs as getVotingMintAuthority,Ys as getVotingTokenMint,Bp as governanceCreateTokenOwnerRecord,ah as i16ToBytes,Sr as i32ToBytes,ga as initPoolLayout,Ws as initTokenAccountInstruction,Bl as initialize,kf as initializeMarket,zs as isValidFarmVersion,si as isZero,uk as judgeFarmType,ra as leadingZeros,Ic as leastSignificantBit,zn as liquidityStateV4Layout,Yp as liquidityStateV5Layout,Rr as makeAMMSwapInstruction,Yc as makeAddLiquidityInstruction,ia as makeAddNewRewardInstruction,zr as makeClaimInstruction,Da as makeClaimInstructionV4,dl as makeCpmmLockInstruction,ul as makeCreateCpmmPoolInInstruction,mc as makeCreateFarmInstruction,vr as makeCreateMarketInstruction,dc as makeCreatorWithdrawFarmRewardInstruction,cl as makeDepositCpmmInInstruction,fc as makeDepositInstructionV3,yc as makeDepositInstructionV5,bc as makeDepositInstructionV6,Ik as makeDepositTokenInstruction,xk as makeDepositWithdrawInstruction,KI as makeInitPoolInstructionV4,yC as makePurchaseInstruction,oa as makeRestartRewardInstruction,Zc as makeSimulatePoolInfoInstruction,qr as makeSwapCpmmBaseInInstruction,ml as makeSwapCpmmBaseOutInstruction,df as makeSwapFixedInInstruction,pf as makeSwapFixedOutInstruction,wl as makeSwapInstruction,Zu as makeTransferInstruction,ll as makeWithdrawCpmmInInstruction,ni as makeWithdrawInstructionV3,pc as makeWithdrawInstructionV4,ti as makeWithdrawInstructionV5,ei as makeWithdrawInstructionV6,Bk as makeWithdrawTokenInstruction,ih as mockCreatePoolInfo,hc as mockV3CreatePoolInfo,Jp as modelDataInfoLayout,Tc as mostSignificantBit,Yu as parseTokenAccountResp,YT as parseTokenInfo,On as poolTypeV6,Fa as purchaseLayout,cp as realFarmStateV3Layout,lp as realFarmStateV5Layout,mp as realFarmV6Layout,ka as removeLiquidityInstruction,Aa as removeLiquidityLayout,AK as route1Instruction,wK as route2Instruction,Ff as routeInstruction,Sl as sellExactInInstruction,XC as sellExactOut,SI as simulatePoolInfoInstruction,$T as solToWSolToken,Yt as splAccountLayout,kK as swapBaseInAutoAccount,hK as swapBaseOutAutoAccount,Or as toAmmComputePoolInfo,dt as toApiV3Token,vn as toFeeConfig,Cr as toToken,fi as toTokenAmount,ZT as toTokenInfo,sa as trailingZeros,xr as u16ToBytes,uh as u32ToBytes,Yf as u8ToBytes,K1 as unionArr,gp as updateFarmPoolInfo,Rl as updatePlatformConfig,Hs as validateFarmRewards,Sp as voterStakeRegistryCreateDepositEntry,xp as voterStakeRegistryCreateVoter,hp as voterStakeRegistryDeposit,Tp as voterStakeRegistryUpdateVoterWeightRecord,Ip as voterStakeRegistryWithdraw,JT as wSolToSolToken,Us as withdrawRewardLayout};
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=index.mjs.map