var Fl=Object.defineProperty;var Vl=(r,e,t)=>e in r?Fl(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var Lt=(r,e,t)=>(Vl(r,typeof e!="symbol"?e+"":e,t),t);import{merge as ty}from"lodash";import vu from"axios";import{PublicKey as $a}from"@solana/web3.js";import{get as Ya,set as Wl}from"lodash";var rs=class{logLevel;name;constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},Za={},Dl={};function de(r){let e=Ya(Za,r);if(!e){let t=Ya(Dl,r);e=new rs({name:r,logLevel:t}),Wl(Za,r,e)}return e}import{MINT_SIZE as ql,TOKEN_PROGRAM_ID as Ul,getTransferFeeConfig as Gl,unpackMint as Xl}from"@solana/spl-token";var ss=de("Raydium_accountInfo_util");async function Wt(r,e,t){let{batchRequest:n,commitment:o="confirmed",chunkCount:i=100}={batchRequest:!1,...t},s=as(e,i),a=new Array(s.length).fill([]);if(n){let c=s.map(d=>{let m=r._buildArgs([d.map(p=>p.toBase58())],o,"base64");return{methodName:"getMultipleAccounts",args:m}}),u=as(c,10);a=(await(await Promise.all(u.map(async d=>await r._rpcBatchRequest(d)))).flat()).map(d=>(d.error&&ss.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${d.error.message}`),d.result.value.map(m=>{if(m){let{data:p,executable:y,lamports:f,owner:b,rentEpoch:g}=m;return p.length!==2&&p[1]!=="base64"&&ss.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(p[0],"base64"),executable:y,lamports:f,owner:new $a(b),rentEpoch:g}}return null})))}else try{a=await Promise.all(s.map(c=>r.getMultipleAccountsInfo(c,o)))}catch(c){c instanceof Error&&ss.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${c.message}`)}return a.flat()}async function Se(r,e,t){let n=await Wt(r,e.map(o=>o.pubkey),t);return e.map((o,i)=>({...o,accountInfo:n[i]}))}async function io({connection:r,mints:e,config:t}){if(e.length===0)return{};let n=await Se(r,e.map(i=>({pubkey:ct(i)})),t),o={};for(let i of n){if(!i.accountInfo||i.accountInfo.data.length<ql){console.log("invalid mint account",i.pubkey.toBase58());continue}let s=Xl(i.pubkey,i.accountInfo,i.accountInfo?.owner);o[i.pubkey.toString()]={...s,programId:i.accountInfo?.owner||Ul,feeConfig:Gl(s)??void 0}}return o[$a.default.toBase58()]=o[j.toBase58()],o}import rn from"bn.js";var ro=9e15,Sn=1e9,us="0123456789abcdef",Wi="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",Di="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",cs={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-ro,maxE:ro,crypto:!1},nu,pn,ue=!0,Ui="[DecimalError] ",xn=Ui+"Invalid argument: ",ou=Ui+"Precision limit exceeded",iu=Ui+"crypto unavailable",ru="[object Decimal]",lt=Math.floor,He=Math.pow,Ql=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,zl=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,Hl=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,su=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,qt=1e7,oe=7,jl=9007199254740991,Yl=Wi.length-1,ls=Di.length-1,W={toStringTag:ru};W.absoluteValue=W.abs=function(){var r=new this.constructor(this);return r.s<0&&(r.s=1),J(r)};W.ceil=function(){return J(new this.constructor(this),this.e+1,2)};W.clampedTo=W.clamp=function(r,e){var t,n=this,o=n.constructor;if(r=new o(r),e=new o(e),!r.s||!e.s)return new o(NaN);if(r.gt(e))throw Error(xn+e);return t=n.cmp(r),t<0?r:n.cmp(e)>0?e:new o(n)};W.comparedTo=W.cmp=function(r){var e,t,n,o,i=this,s=i.d,a=(r=new i.constructor(r)).d,c=i.s,u=r.s;if(!s||!a)return!c||!u?NaN:c!==u?c:s===a?0:!s^c<0?1:-1;if(!s[0]||!a[0])return s[0]?c:a[0]?-u:0;if(c!==u)return c;if(i.e!==r.e)return i.e>r.e^c<0?1:-1;for(n=s.length,o=a.length,e=0,t=n<o?n:o;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^c<0?1:-1;return n===o?0:n>o^c<0?1:-1};W.cosine=W.cos=function(){var r,e,t=this,n=t.constructor;return t.d?t.d[0]?(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+oe,n.rounding=1,t=Zl(n,mu(n,t)),n.precision=r,n.rounding=e,J(pn==2||pn==3?t.neg():t,r,e,!0)):new n(1):new n(NaN)};W.cubeRoot=W.cbrt=function(){var r,e,t,n,o,i,s,a,c,u,l=this,d=l.constructor;if(!l.isFinite()||l.isZero())return new d(l);for(ue=!1,i=l.s*He(l.s*l,1/3),!i||Math.abs(i)==1/0?(t=it(l.d),r=l.e,(i=(r-t.length+1)%3)&&(t+=i==1||i==-2?"0":"00"),i=He(t,1/3),r=lt((r+1)/3)-(r%3==(r<0?-1:2)),i==1/0?t="5e"+r:(t=i.toExponential(),t=t.slice(0,t.indexOf("e")+1)+r),n=new d(t),n.s=l.s):n=new d(i.toString()),s=(r=d.precision)+3;;)if(a=n,c=a.times(a).times(a),u=c.plus(l),n=Ke(u.plus(l).times(a),u.plus(c),s+2,1),it(a.d).slice(0,s)===(t=it(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!o&&t=="4999"){if(!o&&(J(a,r+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,o=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&(J(n,r+1,1),e=!n.times(n).times(n).eq(l));break}return ue=!0,J(n,r,d.rounding,e)};W.decimalPlaces=W.dp=function(){var r,e=this.d,t=NaN;if(e){if(r=e.length-1,t=(r-lt(this.e/oe))*oe,r=e[r],r)for(;r%10==0;r/=10)t--;t<0&&(t=0)}return t};W.dividedBy=W.div=function(r){return Ke(this,new this.constructor(r))};W.dividedToIntegerBy=W.divToInt=function(r){var e=this,t=e.constructor;return J(Ke(e,new t(r),0,1,1),t.precision,t.rounding)};W.equals=W.eq=function(r){return this.cmp(r)===0};W.floor=function(){return J(new this.constructor(this),this.e+1,3)};W.greaterThan=W.gt=function(r){return this.cmp(r)>0};W.greaterThanOrEqualTo=W.gte=function(r){var e=this.cmp(r);return e==1||e===0};W.hyperbolicCosine=W.cosh=function(){var r,e,t,n,o,i=this,s=i.constructor,a=new s(1);if(!i.isFinite())return new s(i.s?1/0:NaN);if(i.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(i.e,i.sd())+4,s.rounding=1,o=i.d.length,o<32?(r=Math.ceil(o/3),e=(1/Xi(4,r)).toString()):(r=16,e="2.3283064365386962890625e-10"),i=so(s,1,i.times(e),new s(1),!0);for(var c,u=r,l=new s(8);u--;)c=i.times(i),i=a.minus(c.times(l.minus(c.times(l))));return J(i,s.precision=t,s.rounding=n,!0)};W.hyperbolicSine=W.sinh=function(){var r,e,t,n,o=this,i=o.constructor;if(!o.isFinite()||o.isZero())return new i(o);if(e=i.precision,t=i.rounding,i.precision=e+Math.max(o.e,o.sd())+4,i.rounding=1,n=o.d.length,n<3)o=so(i,2,o,o,!0);else{r=1.4*Math.sqrt(n),r=r>16?16:r|0,o=o.times(1/Xi(5,r)),o=so(i,2,o,o,!0);for(var s,a=new i(5),c=new i(16),u=new i(20);r--;)s=o.times(o),o=o.times(a.plus(s.times(c.times(s).plus(u))))}return i.precision=e,i.rounding=t,J(o,e,t,!0)};W.hyperbolicTangent=W.tanh=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+7,n.rounding=1,Ke(t.sinh(),t.cosh(),n.precision=r,n.rounding=e)):new n(t.s)};W.inverseCosine=W.acos=function(){var r,e=this,t=e.constructor,n=e.abs().cmp(1),o=t.precision,i=t.rounding;return n!==-1?n===0?e.isNeg()?Dt(t,o,i):new t(0):new t(NaN):e.isZero()?Dt(t,o+4,i).times(.5):(t.precision=o+6,t.rounding=1,e=e.asin(),r=Dt(t,o+4,i).times(.5),t.precision=o,t.rounding=i,r.minus(e))};W.inverseHyperbolicCosine=W.acosh=function(){var r,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(r=n.precision,e=n.rounding,n.precision=r+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,ue=!1,t=t.times(t).minus(1).sqrt().plus(t),ue=!0,n.precision=r,n.rounding=e,t.ln()):new n(t)};W.inverseHyperbolicSine=W.asinh=function(){var r,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,ue=!1,t=t.times(t).plus(1).sqrt().plus(t),ue=!0,n.precision=r,n.rounding=e,t.ln())};W.inverseHyperbolicTangent=W.atanh=function(){var r,e,t,n,o=this,i=o.constructor;return o.isFinite()?o.e>=0?new i(o.abs().eq(1)?o.s/0:o.isZero()?o:NaN):(r=i.precision,e=i.rounding,n=o.sd(),Math.max(n,r)<2*-o.e-1?J(new i(o),r,e,!0):(i.precision=t=n-o.e,o=Ke(o.plus(1),new i(1).minus(o),t+r,1),i.precision=r+4,i.rounding=1,o=o.ln(),i.precision=r,i.rounding=e,o.times(.5))):new i(NaN)};W.inverseSine=W.asin=function(){var r,e,t,n,o=this,i=o.constructor;return o.isZero()?new i(o):(e=o.abs().cmp(1),t=i.precision,n=i.rounding,e!==-1?e===0?(r=Dt(i,t+4,n).times(.5),r.s=o.s,r):new i(NaN):(i.precision=t+6,i.rounding=1,o=o.div(new i(1).minus(o.times(o)).sqrt().plus(1)).atan(),i.precision=t,i.rounding=n,o.times(2)))};W.inverseTangent=W.atan=function(){var r,e,t,n,o,i,s,a,c,u=this,l=u.constructor,d=l.precision,m=l.rounding;if(u.isFinite()){if(u.isZero())return new l(u);if(u.abs().eq(1)&&d+4<=ls)return s=Dt(l,d+4,m).times(.25),s.s=u.s,s}else{if(!u.s)return new l(NaN);if(d+4<=ls)return s=Dt(l,d+4,m).times(.5),s.s=u.s,s}for(l.precision=a=d+10,l.rounding=1,t=Math.min(28,a/oe+2|0),r=t;r;--r)u=u.div(u.times(u).plus(1).sqrt().plus(1));for(ue=!1,e=Math.ceil(a/oe),n=1,c=u.times(u),s=new l(u),o=u;r!==-1;)if(o=o.times(c),i=s.minus(o.div(n+=2)),o=o.times(c),s=i.plus(o.div(n+=2)),s.d[e]!==void 0)for(r=e;s.d[r]===i.d[r]&&r--;);return t&&(s=s.times(2<<t-1)),ue=!0,J(s,l.precision=d,l.rounding=m,!0)};W.isFinite=function(){return!!this.d};W.isInteger=W.isInt=function(){return!!this.d&&lt(this.e/oe)>this.d.length-2};W.isNaN=function(){return!this.s};W.isNegative=W.isNeg=function(){return this.s<0};W.isPositive=W.isPos=function(){return this.s>0};W.isZero=function(){return!!this.d&&this.d[0]===0};W.lessThan=W.lt=function(r){return this.cmp(r)<0};W.lessThanOrEqualTo=W.lte=function(r){return this.cmp(r)<1};W.logarithm=W.log=function(r){var e,t,n,o,i,s,a,c,u=this,l=u.constructor,d=l.precision,m=l.rounding,p=5;if(r==null)r=new l(10),e=!0;else{if(r=new l(r),t=r.d,r.s<0||!t||!t[0]||r.eq(1))return new l(NaN);e=r.eq(10)}if(t=u.d,u.s<0||!t||!t[0]||u.eq(1))return new l(t&&!t[0]?-1/0:u.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)i=!0;else{for(o=t[0];o%10===0;)o/=10;i=o!==1}if(ue=!1,a=d+p,s=Bn(u,a),n=e?qi(l,a+10):Bn(r,a),c=Ke(s,n,a,1),Ro(c.d,o=d,m))do if(a+=10,s=Bn(u,a),n=e?qi(l,a+10):Bn(r,a),c=Ke(s,n,a,1),!i){+it(c.d).slice(o+1,o+15)+1==1e14&&(c=J(c,d+1,0));break}while(Ro(c.d,o+=10,m));return ue=!0,J(c,d,m)};W.minus=W.sub=function(r){var e,t,n,o,i,s,a,c,u,l,d,m,p=this,y=p.constructor;if(r=new y(r),!p.d||!r.d)return!p.s||!r.s?r=new y(NaN):p.d?r.s=-r.s:r=new y(r.d||p.s!==r.s?p:NaN),r;if(p.s!=r.s)return r.s=-r.s,p.plus(r);if(u=p.d,m=r.d,a=y.precision,c=y.rounding,!u[0]||!m[0]){if(m[0])r.s=-r.s;else if(u[0])r=new y(p);else return new y(c===3?-0:0);return ue?J(r,a,c):r}if(t=lt(r.e/oe),l=lt(p.e/oe),u=u.slice(),i=l-t,i){for(d=i<0,d?(e=u,i=-i,s=m.length):(e=m,t=l,s=u.length),n=Math.max(Math.ceil(a/oe),s)+2,i>n&&(i=n,e.length=1),e.reverse(),n=i;n--;)e.push(0);e.reverse()}else{for(n=u.length,s=m.length,d=n<s,d&&(s=n),n=0;n<s;n++)if(u[n]!=m[n]){d=u[n]<m[n];break}i=0}for(d&&(e=u,u=m,m=e,r.s=-r.s),s=u.length,n=m.length-s;n>0;--n)u[s++]=0;for(n=m.length;n>i;){if(u[--n]<m[n]){for(o=n;o&&u[--o]===0;)u[o]=qt-1;--u[o],u[n]+=qt}u[n]-=m[n]}for(;u[--s]===0;)u.pop();for(;u[0]===0;u.shift())--t;return u[0]?(r.d=u,r.e=Gi(u,t),ue?J(r,a,c):r):new y(c===3?-0:0)};W.modulo=W.mod=function(r){var e,t=this,n=t.constructor;return r=new n(r),!t.d||!r.s||r.d&&!r.d[0]?new n(NaN):!r.d||t.d&&!t.d[0]?J(new n(t),n.precision,n.rounding):(ue=!1,n.modulo==9?(e=Ke(t,r.abs(),0,3,1),e.s*=r.s):e=Ke(t,r,0,n.modulo,1),e=e.times(r),ue=!0,t.minus(e))};W.naturalExponential=W.exp=function(){return ms(this)};W.naturalLogarithm=W.ln=function(){return Bn(this)};W.negated=W.neg=function(){var r=new this.constructor(this);return r.s=-r.s,J(r)};W.plus=W.add=function(r){var e,t,n,o,i,s,a,c,u,l,d=this,m=d.constructor;if(r=new m(r),!d.d||!r.d)return!d.s||!r.s?r=new m(NaN):d.d||(r=new m(r.d||d.s===r.s?d:NaN)),r;if(d.s!=r.s)return r.s=-r.s,d.minus(r);if(u=d.d,l=r.d,a=m.precision,c=m.rounding,!u[0]||!l[0])return l[0]||(r=new m(d)),ue?J(r,a,c):r;if(i=lt(d.e/oe),n=lt(r.e/oe),u=u.slice(),o=i-n,o){for(o<0?(t=u,o=-o,s=l.length):(t=l,n=i,s=u.length),i=Math.ceil(a/oe),s=i>s?i+1:s+1,o>s&&(o=s,t.length=1),t.reverse();o--;)t.push(0);t.reverse()}for(s=u.length,o=l.length,s-o<0&&(o=s,t=l,l=u,u=t),e=0;o;)e=(u[--o]=u[o]+l[o]+e)/qt|0,u[o]%=qt;for(e&&(u.unshift(e),++n),s=u.length;u[--s]==0;)u.pop();return r.d=u,r.e=Gi(u,n),ue?J(r,a,c):r};W.precision=W.sd=function(r){var e,t=this;if(r!==void 0&&r!==!!r&&r!==1&&r!==0)throw Error(xn+r);return t.d?(e=au(t.d),r&&t.e+1>e&&(e=t.e+1)):e=NaN,e};W.round=function(){var r=this,e=r.constructor;return J(new e(r),r.e+1,e.rounding)};W.sine=W.sin=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+oe,n.rounding=1,t=Jl(n,mu(n,t)),n.precision=r,n.rounding=e,J(pn>2?t.neg():t,r,e,!0)):new n(NaN)};W.squareRoot=W.sqrt=function(){var r,e,t,n,o,i,s=this,a=s.d,c=s.e,u=s.s,l=s.constructor;if(u!==1||!a||!a[0])return new l(!u||u<0&&(!a||a[0])?NaN:a?s:1/0);for(ue=!1,u=Math.sqrt(+s),u==0||u==1/0?(e=it(a),(e.length+c)%2==0&&(e+="0"),u=Math.sqrt(e),c=lt((c+1)/2)-(c<0||c%2),u==1/0?e="5e"+c:(e=u.toExponential(),e=e.slice(0,e.indexOf("e")+1)+c),n=new l(e)):n=new l(u.toString()),t=(c=l.precision)+3;;)if(i=n,n=i.plus(Ke(s,i,t+2,1)).times(.5),it(i.d).slice(0,t)===(e=it(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!o&&e=="4999"){if(!o&&(J(i,c+1,0),i.times(i).eq(s))){n=i;break}t+=4,o=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&(J(n,c+1,1),r=!n.times(n).eq(s));break}return ue=!0,J(n,c,l.rounding,r)};W.tangent=W.tan=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+10,n.rounding=1,t=t.sin(),t.s=1,t=Ke(t,new n(1).minus(t.times(t)).sqrt(),r+10,0),n.precision=r,n.rounding=e,J(pn==2||pn==4?t.neg():t,r,e,!0)):new n(NaN)};W.times=W.mul=function(r){var e,t,n,o,i,s,a,c,u,l=this,d=l.constructor,m=l.d,p=(r=new d(r)).d;if(r.s*=l.s,!m||!m[0]||!p||!p[0])return new d(!r.s||m&&!m[0]&&!p||p&&!p[0]&&!m?NaN:!m||!p?r.s/0:r.s*0);for(t=lt(l.e/oe)+lt(r.e/oe),c=m.length,u=p.length,c<u&&(i=m,m=p,p=i,s=c,c=u,u=s),i=[],s=c+u,n=s;n--;)i.push(0);for(n=u;--n>=0;){for(e=0,o=c+n;o>n;)a=i[o]+p[n]*m[o-n-1]+e,i[o--]=a%qt|0,e=a/qt|0;i[o]=(i[o]+e)%qt|0}for(;!i[--s];)i.pop();return e?++t:i.shift(),r.d=i,r.e=Gi(i,t),ue?J(r,d.precision,d.rounding):r};W.toBinary=function(r,e){return ps(this,2,r,e)};W.toDecimalPlaces=W.toDP=function(r,e){var t=this,n=t.constructor;return t=new n(t),r===void 0?t:(kt(r,0,Sn),e===void 0?e=n.rounding:kt(e,0,8),J(t,r+t.e+1,e))};W.toExponential=function(r,e){var t,n=this,o=n.constructor;return r===void 0?t=tn(n,!0):(kt(r,0,Sn),e===void 0?e=o.rounding:kt(e,0,8),n=J(new o(n),r+1,e),t=tn(n,!0,r+1)),n.isNeg()&&!n.isZero()?"-"+t:t};W.toFixed=function(r,e){var t,n,o=this,i=o.constructor;return r===void 0?t=tn(o):(kt(r,0,Sn),e===void 0?e=i.rounding:kt(e,0,8),n=J(new i(o),r+o.e+1,e),t=tn(n,!1,r+n.e+1)),o.isNeg()&&!o.isZero()?"-"+t:t};W.toFraction=function(r){var e,t,n,o,i,s,a,c,u,l,d,m,p=this,y=p.d,f=p.constructor;if(!y)return new f(p);if(u=t=new f(1),n=c=new f(0),e=new f(n),i=e.e=au(y)-p.e-1,s=i%oe,e.d[0]=He(10,s<0?oe+s:s),r==null)r=i>0?e:u;else{if(a=new f(r),!a.isInt()||a.lt(u))throw Error(xn+a);r=a.gt(e)?i>0?e:u:a}for(ue=!1,a=new f(it(y)),l=f.precision,f.precision=i=y.length*oe*2;d=Ke(a,e,0,1,1),o=t.plus(d.times(n)),o.cmp(r)!=1;)t=n,n=o,o=u,u=c.plus(d.times(o)),c=o,o=e,e=a.minus(d.times(o)),a=o;return o=Ke(r.minus(t),n,0,1,1),c=c.plus(o.times(u)),t=t.plus(o.times(n)),c.s=u.s=p.s,m=Ke(u,n,i,1).minus(p).abs().cmp(Ke(c,t,i,1).minus(p).abs())<1?[u,n]:[c,t],f.precision=l,ue=!0,m};W.toHexadecimal=W.toHex=function(r,e){return ps(this,16,r,e)};W.toNearest=function(r,e){var t=this,n=t.constructor;if(t=new n(t),r==null){if(!t.d)return t;r=new n(1),e=n.rounding}else{if(r=new n(r),e===void 0?e=n.rounding:kt(e,0,8),!t.d)return r.s?t:r;if(!r.d)return r.s&&(r.s=t.s),r}return r.d[0]?(ue=!1,t=Ke(t,r,0,e,1).times(r),ue=!0,J(t)):(r.s=t.s,t=r),t};W.toNumber=function(){return+this};W.toOctal=function(r,e){return ps(this,8,r,e)};W.toPower=W.pow=function(r){var e,t,n,o,i,s,a=this,c=a.constructor,u=+(r=new c(r));if(!a.d||!r.d||!a.d[0]||!r.d[0])return new c(He(+a,u));if(a=new c(a),a.eq(1))return a;if(n=c.precision,i=c.rounding,r.eq(1))return J(a,n,i);if(e=lt(r.e/oe),e>=r.d.length-1&&(t=u<0?-u:u)<=jl)return o=uu(c,a,t,n),r.s<0?new c(1).div(o):J(o,n,i);if(s=a.s,s<0){if(e<r.d.length-1)return new c(NaN);if((r.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=He(+a,u),e=t==0||!isFinite(t)?lt(u*(Math.log("0."+it(a.d))/Math.LN10+a.e+1)):new c(t+"").e,e>c.maxE+1||e<c.minE-1?new c(e>0?s/0:0):(ue=!1,c.rounding=a.s=1,t=Math.min(12,(e+"").length),o=ms(r.times(Bn(a,n+t)),n),o.d&&(o=J(o,n+5,1),Ro(o.d,n,i)&&(e=n+10,o=J(ms(r.times(Bn(a,e+t)),e),e+5,1),+it(o.d).slice(n+1,n+15)+1==1e14&&(o=J(o,n+1,0)))),o.s=s,ue=!0,c.rounding=i,J(o,n,i))};W.toPrecision=function(r,e){var t,n=this,o=n.constructor;return r===void 0?t=tn(n,n.e<=o.toExpNeg||n.e>=o.toExpPos):(kt(r,1,Sn),e===void 0?e=o.rounding:kt(e,0,8),n=J(new o(n),r,e),t=tn(n,r<=n.e||n.e<=o.toExpNeg,r)),n.isNeg()&&!n.isZero()?"-"+t:t};W.toSignificantDigits=W.toSD=function(r,e){var t=this,n=t.constructor;return r===void 0?(r=n.precision,e=n.rounding):(kt(r,1,Sn),e===void 0?e=n.rounding:kt(e,0,8)),J(new n(t),r,e)};W.toString=function(){var r=this,e=r.constructor,t=tn(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()&&!r.isZero()?"-"+t:t};W.truncated=W.trunc=function(){return J(new this.constructor(this),this.e+1,1)};W.valueOf=W.toJSON=function(){var r=this,e=r.constructor,t=tn(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()?"-"+t:t};function it(r){var e,t,n,o=r.length-1,i="",s=r[0];if(o>0){for(i+=s,e=1;e<o;e++)n=r[e]+"",t=oe-n.length,t&&(i+=In(t)),i+=n;s=r[e],n=s+"",t=oe-n.length,t&&(i+=In(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return i+s}function kt(r,e,t){if(r!==~~r||r<e||r>t)throw Error(xn+r)}function Ro(r,e,t,n){var o,i,s,a;for(i=r[0];i>=10;i/=10)--e;return--e<0?(e+=oe,o=0):(o=Math.ceil((e+1)/oe),e%=oe),i=He(10,oe-e),a=r[o]%i|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==i||t>3&&a+1==i/2)&&(r[o+1]/i/100|0)==He(10,e-2)-1||(a==i/2||a==0)&&(r[o+1]/i/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==i||!n&&t>3&&a+1==i/2)&&(r[o+1]/i/1e3|0)==He(10,e-3)-1,s}function Vi(r,e,t){for(var n,o=[0],i,s=0,a=r.length;s<a;){for(i=o.length;i--;)o[i]*=e;for(o[0]+=us.indexOf(r.charAt(s++)),n=0;n<o.length;n++)o[n]>t-1&&(o[n+1]===void 0&&(o[n+1]=0),o[n+1]+=o[n]/t|0,o[n]%=t)}return o.reverse()}function Zl(r,e){var t,n,o;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),o=(1/Xi(4,t)).toString()):(t=16,o="2.3283064365386962890625e-10"),r.precision+=t,e=so(r,1,e.times(o),new r(1));for(var i=t;i--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return r.precision-=t,e}var Ke=function(){function r(n,o,i){var s,a=0,c=n.length;for(n=n.slice();c--;)s=n[c]*o+a,n[c]=s%i|0,a=s/i|0;return a&&n.unshift(a),n}function e(n,o,i,s){var a,c;if(i!=s)c=i>s?1:-1;else for(a=c=0;a<i;a++)if(n[a]!=o[a]){c=n[a]>o[a]?1:-1;break}return c}function t(n,o,i,s){for(var a=0;i--;)n[i]-=a,a=n[i]<o[i]?1:0,n[i]=a*s+n[i]-o[i];for(;!n[0]&&n.length>1;)n.shift()}return function(n,o,i,s,a,c){var u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I,K,N,v,_=n.constructor,D=n.s==o.s?1:-1,q=n.d,G=o.d;if(!q||!q[0]||!G||!G[0])return new _(!n.s||!o.s||(q?G&&q[0]==G[0]:!G)?NaN:q&&q[0]==0||!G?D*0:D/0);for(c?(p=1,l=n.e-o.e):(c=qt,p=oe,l=lt(n.e/p)-lt(o.e/p)),N=G.length,I=q.length,g=new _(D),w=g.d=[],d=0;G[d]==(q[d]||0);d++);if(G[d]>(q[d]||0)&&l--,i==null?(T=i=_.precision,s=_.rounding):a?T=i+(n.e-o.e)+1:T=i,T<0)w.push(1),y=!0;else{if(T=T/p+2|0,d=0,N==1){for(m=0,G=G[0],T++;(d<I||m)&&T--;d++)B=m*c+(q[d]||0),w[d]=B/G|0,m=B%G|0;y=m||d<I}else{for(m=c/(G[0]+1)|0,m>1&&(G=r(G,m,c),q=r(q,m,c),N=G.length,I=q.length),S=N,k=q.slice(0,N),h=k.length;h<N;)k[h++]=0;v=G.slice(),v.unshift(0),K=G[0],G[1]>=c/2&&++K;do m=0,u=e(G,k,N,h),u<0?(x=k[0],N!=h&&(x=x*c+(k[1]||0)),m=x/K|0,m>1?(m>=c&&(m=c-1),f=r(G,m,c),b=f.length,h=k.length,u=e(f,k,b,h),u==1&&(m--,t(f,N<b?v:G,b,c))):(m==0&&(u=m=1),f=G.slice()),b=f.length,b<h&&f.unshift(0),t(k,f,h,c),u==-1&&(h=k.length,u=e(G,k,N,h),u<1&&(m++,t(k,N<h?v:G,h,c))),h=k.length):u===0&&(m++,k=[0]),w[d++]=m,u&&k[0]?k[h++]=q[S]||0:(k=[q[S]],h=1);while((S++<I||k[0]!==void 0)&&T--);y=k[0]!==void 0}w[0]||w.shift()}if(p==1)g.e=l,nu=y;else{for(d=1,m=w[0];m>=10;m/=10)d++;g.e=d+l*p-1,J(g,a?i+g.e+1:i,s,y)}return g}}();function J(r,e,t,n){var o,i,s,a,c,u,l,d,m,p=r.constructor;e:if(e!=null){if(d=r.d,!d)return r;for(o=1,a=d[0];a>=10;a/=10)o++;if(i=e-o,i<0)i+=oe,s=e,l=d[m=0],c=l/He(10,o-s-1)%10|0;else if(m=Math.ceil((i+1)/oe),a=d.length,m>=a)if(n){for(;a++<=m;)d.push(0);l=c=0,o=1,i%=oe,s=i-oe+1}else break e;else{for(l=a=d[m],o=1;a>=10;a/=10)o++;i%=oe,s=i-oe+o,c=s<0?0:l/He(10,o-s-1)%10|0}if(n=n||e<0||d[m+1]!==void 0||(s<0?l:l%He(10,o-s-1)),u=t<4?(c||n)&&(t==0||t==(r.s<0?3:2)):c>5||c==5&&(t==4||n||t==6&&(i>0?s>0?l/He(10,o-s):0:d[m-1])%10&1||t==(r.s<0?8:7)),e<1||!d[0])return d.length=0,u?(e-=r.e+1,d[0]=He(10,(oe-e%oe)%oe),r.e=-e||0):d[0]=r.e=0,r;if(i==0?(d.length=m,a=1,m--):(d.length=m+1,a=He(10,oe-i),d[m]=s>0?(l/He(10,o-s)%He(10,s)|0)*a:0),u)for(;;)if(m==0){for(i=1,s=d[0];s>=10;s/=10)i++;for(s=d[0]+=a,a=1;s>=10;s/=10)a++;i!=a&&(r.e++,d[0]==qt&&(d[0]=1));break}else{if(d[m]+=a,d[m]!=qt)break;d[m--]=0,a=1}for(i=d.length;d[--i]===0;)d.pop()}return ue&&(r.e>p.maxE?(r.d=null,r.e=NaN):r.e<p.minE&&(r.e=0,r.d=[0])),r}function tn(r,e,t){if(!r.isFinite())return lu(r);var n,o=r.e,i=it(r.d),s=i.length;return e?(t&&(n=t-s)>0?i=i.charAt(0)+"."+i.slice(1)+In(n):s>1&&(i=i.charAt(0)+"."+i.slice(1)),i=i+(r.e<0?"e":"e+")+r.e):o<0?(i="0."+In(-o-1)+i,t&&(n=t-s)>0&&(i+=In(n))):o>=s?(i+=In(o+1-s),t&&(n=t-o-1)>0&&(i=i+"."+In(n))):((n=o+1)<s&&(i=i.slice(0,n)+"."+i.slice(n)),t&&(n=t-s)>0&&(o+1===s&&(i+="."),i+=In(n))),i}function Gi(r,e){var t=r[0];for(e*=oe;t>=10;t/=10)e++;return e}function qi(r,e,t){if(e>Yl)throw ue=!0,t&&(r.precision=t),Error(ou);return J(new r(Wi),e,1,!0)}function Dt(r,e,t){if(e>ls)throw Error(ou);return J(new r(Di),e,t,!0)}function au(r){var e=r.length-1,t=e*oe+1;if(e=r[e],e){for(;e%10==0;e/=10)t--;for(e=r[0];e>=10;e/=10)t++}return t}function In(r){for(var e="";r--;)e+="0";return e}function uu(r,e,t,n){var o,i=new r(1),s=Math.ceil(n/oe+4);for(ue=!1;;){if(t%2&&(i=i.times(e),eu(i.d,s)&&(o=!0)),t=lt(t/2),t===0){t=i.d.length-1,o&&i.d[t]===0&&++i.d[t];break}e=e.times(e),eu(e.d,s)}return ue=!0,i}function Ja(r){return r.d[r.d.length-1]&1}function cu(r,e,t){for(var n,o=new r(e[0]),i=0;++i<e.length;)if(n=new r(e[i]),n.s)o[t](n)&&(o=n);else{o=n;break}return o}function ms(r,e){var t,n,o,i,s,a,c,u=0,l=0,d=0,m=r.constructor,p=m.rounding,y=m.precision;if(!r.d||!r.d[0]||r.e>17)return new m(r.d?r.d[0]?r.s<0?0:1/0:1:r.s?r.s<0?0:r:0/0);for(e==null?(ue=!1,c=y):c=e,a=new m(.03125);r.e>-2;)r=r.times(a),d+=5;for(n=Math.log(He(2,d))/Math.LN10*2+5|0,c+=n,t=i=s=new m(1),m.precision=c;;){if(i=J(i.times(r),c,1),t=t.times(++l),a=s.plus(Ke(i,t,c,1)),it(a.d).slice(0,c)===it(s.d).slice(0,c)){for(o=d;o--;)s=J(s.times(s),c,1);if(e==null)if(u<3&&Ro(s.d,c-n,p,u))m.precision=c+=10,t=i=a=new m(1),l=0,u++;else return J(s,m.precision=y,p,ue=!0);else return m.precision=y,s}s=a}}function Bn(r,e){var t,n,o,i,s,a,c,u,l,d,m,p=1,y=10,f=r,b=f.d,g=f.constructor,w=g.rounding,k=g.precision;if(f.s<0||!b||!b[0]||!f.e&&b[0]==1&&b.length==1)return new g(b&&!b[0]?-1/0:f.s!=1?NaN:b?0:f);if(e==null?(ue=!1,l=k):l=e,g.precision=l+=y,t=it(b),n=t.charAt(0),Math.abs(i=f.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)f=f.times(r),t=it(f.d),n=t.charAt(0),p++;i=f.e,n>1?(f=new g("0."+t),i++):f=new g(n+"."+t.slice(1))}else return u=qi(g,l+2,k).times(i+""),f=Bn(new g(n+"."+t.slice(1)),l-y).plus(u),g.precision=k,e==null?J(f,k,w,ue=!0):f;for(d=f,c=s=f=Ke(f.minus(1),f.plus(1),l,1),m=J(f.times(f),l,1),o=3;;){if(s=J(s.times(m),l,1),u=c.plus(Ke(s,new g(o),l,1)),it(u.d).slice(0,l)===it(c.d).slice(0,l))if(c=c.times(2),i!==0&&(c=c.plus(qi(g,l+2,k).times(i+""))),c=Ke(c,new g(p),l,1),e==null)if(Ro(c.d,l-y,w,a))g.precision=l+=y,u=s=f=Ke(d.minus(1),d.plus(1),l,1),m=J(f.times(f),l,1),o=a=1;else return J(c,g.precision=k,w,ue=!0);else return g.precision=k,c;c=u,o+=2}}function lu(r){return String(r.s*r.s/0)}function ds(r,e){var t,n,o;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(o=e.length;e.charCodeAt(o-1)===48;--o);if(e=e.slice(n,o),e){if(o-=n,r.e=t=t-n-1,r.d=[],n=(t+1)%oe,t<0&&(n+=oe),n<o){for(n&&r.d.push(+e.slice(0,n)),o-=oe;n<o;)r.d.push(+e.slice(n,n+=oe));e=e.slice(n),n=oe-e.length}else n-=o;for(;n--;)e+="0";r.d.push(+e),ue&&(r.e>r.constructor.maxE?(r.d=null,r.e=NaN):r.e<r.constructor.minE&&(r.e=0,r.d=[0]))}else r.e=0,r.d=[0];return r}function $l(r,e){var t,n,o,i,s,a,c,u,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),su.test(e))return ds(r,e)}else if(e==="Infinity"||e==="NaN")return+e||(r.s=NaN),r.e=NaN,r.d=null,r;if(zl.test(e))t=16,e=e.toLowerCase();else if(Ql.test(e))t=2;else if(Hl.test(e))t=8;else throw Error(xn+e);for(i=e.search(/p/i),i>0?(c=+e.slice(i+1),e=e.substring(2,i)):e=e.slice(2),i=e.indexOf("."),s=i>=0,n=r.constructor,s&&(e=e.replace(".",""),a=e.length,i=a-i,o=uu(n,new n(t),i,i*2)),u=Vi(e,t,qt),l=u.length-1,i=l;u[i]===0;--i)u.pop();return i<0?new n(r.s*0):(r.e=Gi(u,l),r.d=u,ue=!1,s&&(r=Ke(r,o,a*4)),c&&(r=r.times(Math.abs(c)<54?He(2,c):No.pow(2,c))),ue=!0,r)}function Jl(r,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:so(r,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/Xi(5,t)),e=so(r,2,e,e);for(var o,i=new r(5),s=new r(16),a=new r(20);t--;)o=e.times(e),e=e.times(i.plus(o.times(s.times(o).minus(a))));return e}function so(r,e,t,n,o){var i,s,a,c,u=1,l=r.precision,d=Math.ceil(l/oe);for(ue=!1,c=t.times(t),a=new r(n);;){if(s=Ke(a.times(c),new r(e++*e++),l,1),a=o?n.plus(s):n.minus(s),n=Ke(s.times(c),new r(e++*e++),l,1),s=a.plus(n),s.d[d]!==void 0){for(i=d;s.d[i]===a.d[i]&&i--;);if(i==-1)break}i=a,a=n,n=s,s=i,u++}return ue=!0,s.d.length=d+1,s}function Xi(r,e){for(var t=r;--e;)t*=r;return t}function mu(r,e){var t,n=e.s<0,o=Dt(r,r.precision,1),i=o.times(.5);if(e=e.abs(),e.lte(i))return pn=n?4:1,e;if(t=e.divToInt(o),t.isZero())pn=n?3:2;else{if(e=e.minus(t.times(o)),e.lte(i))return pn=Ja(t)?n?2:3:n?4:1,e;pn=Ja(t)?n?1:4:n?3:2}return e.minus(o).abs()}function ps(r,e,t,n){var o,i,s,a,c,u,l,d,m,p=r.constructor,y=t!==void 0;if(y?(kt(t,1,Sn),n===void 0?n=p.rounding:kt(n,0,8)):(t=p.precision,n=p.rounding),!r.isFinite())l=lu(r);else{for(l=tn(r),s=l.indexOf("."),y?(o=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):o=e,s>=0&&(l=l.replace(".",""),m=new p(1),m.e=l.length-s,m.d=Vi(tn(m),10,o),m.e=m.d.length),d=Vi(l,10,o),i=c=d.length;d[--c]==0;)d.pop();if(!d[0])l=y?"0p+0":"0";else{if(s<0?i--:(r=new p(r),r.d=d,r.e=i,r=Ke(r,m,t,n,0,o),d=r.d,i=r.e,u=nu),s=d[t],a=o/2,u=u||d[t+1]!==void 0,u=n<4?(s!==void 0||u)&&(n===0||n===(r.s<0?3:2)):s>a||s===a&&(n===4||u||n===6&&d[t-1]&1||n===(r.s<0?8:7)),d.length=t,u)for(;++d[--t]>o-1;)d[t]=0,t||(++i,d.unshift(1));for(c=d.length;!d[c-1];--c);for(s=0,l="";s<c;s++)l+=us.charAt(d[s]);if(y){if(c>1)if(e==16||e==8){for(s=e==16?4:3,--c;c%s;c++)l+="0";for(d=Vi(l,o,e),c=d.length;!d[c-1];--c);for(s=1,l="1.";s<c;s++)l+=us.charAt(d[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(i<0?"p":"p+")+i}else if(i<0){for(;++i;)l="0"+l;l="0."+l}else if(++i>c)for(i-=c;i--;)l+="0";else i<c&&(l=l.slice(0,i)+"."+l.slice(i))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return r.s<0?"-"+l:l}function eu(r,e){if(r.length>e)return r.length=e,!0}function em(r){return new this(r).abs()}function tm(r){return new this(r).acos()}function nm(r){return new this(r).acosh()}function om(r,e){return new this(r).plus(e)}function im(r){return new this(r).asin()}function rm(r){return new this(r).asinh()}function sm(r){return new this(r).atan()}function am(r){return new this(r).atanh()}function um(r,e){r=new this(r),e=new this(e);var t,n=this.precision,o=this.rounding,i=n+4;return!r.s||!e.s?t=new this(NaN):!r.d&&!e.d?(t=Dt(this,i,1).times(e.s>0?.25:.75),t.s=r.s):!e.d||r.isZero()?(t=e.s<0?Dt(this,n,o):new this(0),t.s=r.s):!r.d||e.isZero()?(t=Dt(this,i,1).times(.5),t.s=r.s):e.s<0?(this.precision=i,this.rounding=1,t=this.atan(Ke(r,e,i,1)),e=Dt(this,i,1),this.precision=n,this.rounding=o,t=r.s<0?t.minus(e):t.plus(e)):t=this.atan(Ke(r,e,i,1)),t}function cm(r){return new this(r).cbrt()}function lm(r){return J(r=new this(r),r.e+1,2)}function mm(r,e,t){return new this(r).clamp(e,t)}function dm(r){if(!r||typeof r!="object")throw Error(Ui+"Object expected");var e,t,n,o=r.defaults===!0,i=["precision",1,Sn,"rounding",0,8,"toExpNeg",-ro,0,"toExpPos",0,ro,"maxE",0,ro,"minE",-ro,0,"modulo",0,9];for(e=0;e<i.length;e+=3)if(t=i[e],o&&(this[t]=cs[t]),(n=r[t])!==void 0)if(lt(n)===n&&n>=i[e+1]&&n<=i[e+2])this[t]=n;else throw Error(xn+t+": "+n);if(t="crypto",o&&(this[t]=cs[t]),(n=r[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(iu);else this[t]=!1;else throw Error(xn+t+": "+n);return this}function pm(r){return new this(r).cos()}function fm(r){return new this(r).cosh()}function du(r){var e,t,n;function o(i){var s,a,c,u=this;if(!(u instanceof o))return new o(i);if(u.constructor=o,tu(i)){u.s=i.s,ue?!i.d||i.e>o.maxE?(u.e=NaN,u.d=null):i.e<o.minE?(u.e=0,u.d=[0]):(u.e=i.e,u.d=i.d.slice()):(u.e=i.e,u.d=i.d?i.d.slice():i.d);return}if(c=typeof i,c==="number"){if(i===0){u.s=1/i<0?-1:1,u.e=0,u.d=[0];return}if(i<0?(i=-i,u.s=-1):u.s=1,i===~~i&&i<1e7){for(s=0,a=i;a>=10;a/=10)s++;ue?s>o.maxE?(u.e=NaN,u.d=null):s<o.minE?(u.e=0,u.d=[0]):(u.e=s,u.d=[i]):(u.e=s,u.d=[i]);return}else if(i*0!==0){i||(u.s=NaN),u.e=NaN,u.d=null;return}return ds(u,i.toString())}else if(c!=="string")throw Error(xn+i);return(a=i.charCodeAt(0))===45?(i=i.slice(1),u.s=-1):(a===43&&(i=i.slice(1)),u.s=1),su.test(i)?ds(u,i):$l(u,i)}if(o.prototype=W,o.ROUND_UP=0,o.ROUND_DOWN=1,o.ROUND_CEIL=2,o.ROUND_FLOOR=3,o.ROUND_HALF_UP=4,o.ROUND_HALF_DOWN=5,o.ROUND_HALF_EVEN=6,o.ROUND_HALF_CEIL=7,o.ROUND_HALF_FLOOR=8,o.EUCLID=9,o.config=o.set=dm,o.clone=du,o.isDecimal=tu,o.abs=em,o.acos=tm,o.acosh=nm,o.add=om,o.asin=im,o.asinh=rm,o.atan=sm,o.atanh=am,o.atan2=um,o.cbrt=cm,o.ceil=lm,o.clamp=mm,o.cos=pm,o.cosh=fm,o.div=ym,o.exp=bm,o.floor=gm,o.hypot=Am,o.ln=Pm,o.log=wm,o.log10=hm,o.log2=km,o.max=Tm,o.min=Im,o.mod=Bm,o.mul=xm,o.pow=Sm,o.random=Km,o.round=Cm,o.sign=Lm,o.sin=Rm,o.sinh=Nm,o.sqrt=Om,o.sub=vm,o.sum=Mm,o.tan=Em,o.tanh=_m,o.trunc=Fm,r===void 0&&(r={}),r&&r.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)r.hasOwnProperty(t=n[e++])||(r[t]=this[t]);return o.config(r),o}function ym(r,e){return new this(r).div(e)}function bm(r){return new this(r).exp()}function gm(r){return J(r=new this(r),r.e+1,3)}function Am(){var r,e,t=new this(0);for(ue=!1,r=0;r<arguments.length;)if(e=new this(arguments[r++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return ue=!0,new this(1/0);t=e}return ue=!0,t.sqrt()}function tu(r){return r instanceof No||r&&r.toStringTag===ru||!1}function Pm(r){return new this(r).ln()}function wm(r,e){return new this(r).log(e)}function km(r){return new this(r).log(2)}function hm(r){return new this(r).log(10)}function Tm(){return cu(this,arguments,"lt")}function Im(){return cu(this,arguments,"gt")}function Bm(r,e){return new this(r).mod(e)}function xm(r,e){return new this(r).mul(e)}function Sm(r,e){return new this(r).pow(e)}function Km(r){var e,t,n,o,i=0,s=new this(1),a=[];if(r===void 0?r=this.precision:kt(r,1,Sn),n=Math.ceil(r/oe),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));i<n;)o=e[i],o>=429e7?e[i]=crypto.getRandomValues(new Uint32Array(1))[0]:a[i++]=o%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);i<n;)o=e[i]+(e[i+1]<<8)+(e[i+2]<<16)+((e[i+3]&127)<<24),o>=214e7?crypto.randomBytes(4).copy(e,i):(a.push(o%1e7),i+=4);i=n/4}else throw Error(iu);else for(;i<n;)a[i++]=Math.random()*1e7|0;for(n=a[--i],r%=oe,n&&r&&(o=He(10,oe-r),a[i]=(n/o|0)*o);a[i]===0;i--)a.pop();if(i<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=oe)a.shift();for(n=1,o=a[0];o>=10;o/=10)n++;n<oe&&(t-=oe-n)}return s.e=t,s.d=a,s}function Cm(r){return J(r=new this(r),r.e+1,this.rounding)}function Lm(r){return r=new this(r),r.d?r.d[0]?r.s:0*r.s:r.s||NaN}function Rm(r){return new this(r).sin()}function Nm(r){return new this(r).sinh()}function Om(r){return new this(r).sqrt()}function vm(r,e){return new this(r).sub(e)}function Mm(){var r=0,e=arguments,t=new this(e[r]);for(ue=!1;t.s&&++r<e.length;)t=t.plus(e[r]);return ue=!0,J(t,this.precision,this.rounding)}function Em(r){return new this(r).tan()}function _m(r){return new this(r).tanh()}function Fm(r){return J(r=new this(r),r.e+1,1)}W[Symbol.for("nodejs.util.inspect.custom")]=W.toString;W[Symbol.toStringTag]="Decimal";var No=W.constructor=du(cs);Wi=new No(Wi);Di=new No(Di);var C=No;import Qm from"big.js";import Hi from"bn.js";import Vm from"toformat";var Wm=Vm,Oo=Wm;import zi from"big.js";import qm from"bn.js";import Um from"decimal.js-light";import vo from"bn.js";var pu=9007199254740991;function Z(r){let e=de("Raydium_parseBigNumberish");if(r instanceof vo)return r;if(typeof r=="string"){if(r.match(/^-?[0-9]+$/))return new vo(r);e.logWithError(`invalid BigNumberish string: ${r}`)}return typeof r=="number"?(r%1&&e.logWithError(`BigNumberish number underflow: ${r}`),(r>=pu||r<=-pu)&&e.logWithError(`BigNumberish number overflow: ${r}`),new vo(String(r))):typeof r=="bigint"?new vo(r.toString()):(e.error(`invalid BigNumberish value: ${r}`),new vo(0))}var Qi=de("module/fraction"),fs=Oo(zi),Mo=Oo(Um),Gm={[0]:Mo.ROUND_DOWN,[1]:Mo.ROUND_HALF_UP,[2]:Mo.ROUND_UP},Xm={[0]:zi.roundDown,[1]:zi.roundHalfUp,[2]:zi.roundUp},Pe=class{numerator;denominator;constructor(e,t=new qm(1)){this.numerator=Z(e),this.denominator=Z(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new Pe(this.denominator,this.numerator)}add(e){let t=e instanceof Pe?e:new Pe(Z(e));return this.denominator.eq(t.denominator)?new Pe(this.numerator.add(t.numerator),this.denominator):new Pe(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof Pe?e:new Pe(Z(e));return this.denominator.eq(t.denominator)?new Pe(this.numerator.sub(t.numerator),this.denominator):new Pe(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof Pe?e:new Pe(Z(e));return new Pe(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof Pe?e:new Pe(Z(e));return new Pe(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||Qi.logWithError(`${e} is not an integer.`),e<=0&&Qi.logWithError(`${e} is not positive.`),Mo.set({precision:e+1,rounding:Gm[n]});let o=new Mo(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return o.toFormat(o.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||Qi.logWithError(`${e} is not an integer.`),e<0&&Qi.logWithError(`${e} is negative.`),fs.DP=e,fs.RM=Xm[n]||1,new fs(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var zm=de("Raydium_amount"),fu=Oo(Qm);function Hm(r,e){let t="0",n="0";if(r.includes(".")){let o=r.split(".");o.length===2?([t,n]=o,n=n.padEnd(e,"0")):zm.logWithError(`invalid number string, num: ${r}`)}else t=r;return[t,n.slice(0,e)||n]}var he=class extends Pe{token;logger;constructor(e,t,n=!0,o){let i=new Hi(0),s=ys.pow(new Hi(e.decimals));if(n)i=Z(t);else{let a=new Hi(0),c=new Hi(0);if(typeof t=="string"||typeof t=="number"||typeof t=="bigint"){let[u,l]=Hm(t.toString(),e.decimals);a=Z(u),c=Z(l)}a=a.mul(s),i=a.add(c)}super(i,s),this.logger=de(o||"TokenAmount"),this.token=e}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(e){return this.token.equals(e.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(e.raw)}lt(e){return this.token.equals(e.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(e.raw)}add(e){return this.token.equals(e.token)||this.logger.logWithError("add token not equals"),new he(this.token,this.raw.add(e.raw))}subtract(e){return this.token.equals(e.token)||this.logger.logWithError("sub token not equals"),new he(this.token,this.raw.sub(e.raw))}toSignificant(e=this.token.decimals,t,n=0){return super.toSignificant(e,t,n)}toFixed(e=this.token.decimals,t,n=0){return e>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(e,t,n)}toExact(e={groupSeparator:""}){return fu.DP=this.token.decimals,new fu(this.numerator.toString()).div(this.denominator.toString()).toFormat(e)}};import{PublicKey as jm}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as yu}from"@solana/spl-token";var nn={chainId:101,address:jm.default.toBase58(),programId:yu.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},Je={chainId:101,address:"So11111111111111111111111111111111111111112",programId:yu.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};import{PublicKey as ws}from"@solana/web3.js";import{PublicKey as ve,SystemProgram as bu,SYSVAR_RENT_PUBKEY as Ym}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Zm}from"@solana/spl-token";function A({pubkey:r,isSigner:e=!1,isWritable:t=!0}){return{pubkey:r,isWritable:t,isSigner:e}}var bs=[A({pubkey:Zm,isWritable:!1}),A({pubkey:bu.programId,isWritable:!1}),A({pubkey:Ym,isWritable:!1})];function gs({publicKey:r,transformSol:e}){let t=As(r.toString());if(t instanceof ve)return e&&t.equals(et)?j:t;if(e&&t.toString()===et.toBase58())return j;if(typeof t=="string"){if(t===ve.default.toBase58())return ve.default;try{return new ve(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function As(r){try{return new ve(r)}catch{return r}}var ji=new ve("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),on=new ve("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),Ge=new ve("SysvarRent111111111111111111111111111111111"),Ps=new ve("SysvarC1ock11111111111111111111111111111111"),Ut=new ve("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),Yi=new ve("Sysvar1nstructions1111111111111111111111111"),Zi=bu.programId,Gy=new ve("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Xy=new ve("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),Qy=new ve("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),zy=new ve("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),Hy=new ve("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),jy=new ve("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),Yy=new ve("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),Zy=new ve("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),$y=new ve("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),Jy=new ve("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),eb=new ve("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),j=new ve("So11111111111111111111111111111111111111112"),et=ve.default;function ct(r){return gs({publicKey:r,transformSol:!0})}var ks=class{symbol;name;decimals;isToken2022;mint;constructor({mint:e,decimals:t,symbol:n,name:o,skipMint:i=!1,isToken2022:s=!1}){if(e===et.toBase58()||e instanceof ws&&et.equals(e)){this.decimals=Je.decimals,this.symbol=Je.symbol,this.name=Je.name,this.mint=new ws(Je.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=o||e.toString().substring(0,6),this.mint=i?ws.default:gs({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Me=ks;Lt(Me,"WSOL",new ks({...Je,mint:Je.address}));var hs=class{symbol;name;decimals;constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},$i=hs;Lt($i,"SOL",new hs(nn));import $m from"bn.js";var gu=new Pe(new $m(100)),tt=class extends Pe{toSignificant(e=5,t,n){return this.mul(gu).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(gu).toFixed(e,t,n)}};var Jm=de("Raydium_price"),ht=class extends Pe{baseToken;quoteToken;scalar;constructor(e){let{baseToken:t,quoteToken:n,numerator:o,denominator:i}=e;super(o,i),this.baseToken=t,this.quoteToken=n,this.scalar=new Pe(Ts(t.decimals),Ts(n.decimals))}get raw(){return new Pe(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new ht({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(e){this.quoteToken!==e.baseToken&&Jm.logWithError("mul token not equals");let t=super.mul(e);return new ht({baseToken:this.baseToken,quoteToken:e.quoteToken,denominator:t.denominator,numerator:t.numerator})}toSignificant(e=this.quoteToken.decimals,t,n){return this.adjusted.toSignificant(e,t,n)}toFixed(e=this.quoteToken.decimals,t,n){return this.adjusted.toFixed(e,t,n)}};import{PublicKey as ed}from"@solana/web3.js";import td from"bn.js";function Au(r){return typeof r=="object"&&r!==null&&![Me,he,ed,Pe,td,ht,tt].some(e=>typeof e=="object"&&r instanceof e)}function Le(r){return typeof r=="string"?As(r):Array.isArray(r)?r.map(e=>Le(e)):Au(r)?Object.fromEntries(Object.entries(r).map(([e,t])=>[e,Le(t)])):r}var Tt=new rn(0),Pu=new rn(1),jb=new rn(2),Yb=new rn(3),Zb=new rn(5),ys=new rn(10),$b=new rn(100),Jb=new rn(1e3),eg=new rn(1e4);function Ts(r){return ys.pow(Z(r))}function Ji(r,e){let t=r.divmod(e);return t.mod.isZero()?t.div:t.div.isNeg()?t.div.isubn(1):t.div.iaddn(1)}function er(r,e,t){return r.mul(e).add(t).sub(new rn(1)).div(t)}function Is(r,e,t){return r.mul(e).div(t)}var wu=r=>typeof r=="number";function ku(r,e,t){let n=wu(e)?e*(t?.unit==="s"?1e3:1):e;return new Date(r).getTime()<=n}function hu(r,e,t){let n=wu(e)?e*(t?.unit==="s"?1e3:1):e;return new Date(r).getTime()>n}function as(r,e=1,t=[]){let n=[...r];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}var Gt=class{_owner;constructor(e){this._owner=e}get publicKey(){return Gt.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return Gt.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return Gt.isKeyPair(this._owner)}get isPublicKey(){return Gt.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!Gt.isKeyPair(e)}};import{PublicKey as ad}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ud}from"@solana/spl-token";import{ComputeBudgetProgram as Tu,Keypair as Iu,PublicKey as Bu,Transaction as tr,TransactionMessage as nd,VersionedTransaction as xu}from"@solana/web3.js";var V={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",ClmmLockPosition:"ClmmLockPosition",ClmmHarvestLockPosition:"ClmmHarvestLockPosition",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV4Withdraw:"FarmV4Withdraw",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut",CpmmLockLp:"CpmmLockLp",CpmmCollectLockFee:"CpmmCollectLockFee",TransferTip:"TransferTip",NonceAccount:"NonceAccount"};import{TOKEN_PROGRAM_ID as od}from"@solana/spl-token";var fn=de("Raydium_txUtil"),Su=1644;function ao(r){let e=[],t=[];return r.microLamports&&(e.push(Tu.setComputeUnitPrice({microLamports:r.microLamports})),t.push(V.SetComputeUnitPrice)),r.units&&(e.push(Tu.setComputeUnitLimit({units:r.units})),t.push(V.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function uo(r,e){let t=e??"confirmed";return(await r.getLatestBlockhash?.({commitment:t}))?.blockhash}async function nr(r,e){return r.getSignatureStatuses([e]),new Promise((t,n)=>{let o=setTimeout(n,6e4);r.onSignature(e,i=>{if(clearTimeout(o),!i.err){t("");return}n(Object.assign(i.err,{txId:e}))},"confirmed")})}function or(r,e){r.length<1&&fn.logWithError(`no instructions provided: ${r.toString()}`),e.length<1&&fn.logWithError(`no signers provided:, ${e.toString()}`);let t=new tr;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...r);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<Su}catch{return!1}}async function Ku(r,e,t,n=!0){let o=new Bu("RaydiumSimuLateTransaction11111111111111111"),i=[],s=new tr;s.feePayer=o;for(let u of e)or([...s.instructions,u],[o])||(i.push(s),s=new tr,s.feePayer=o),s.add(u);s.instructions.length>0&&i.push(s);let a=[];try{if(a=await id(r,i,n),a.find(u=>u.err!==null))throw Error("rpc simulateTransaction error")}catch(u){u instanceof Error&&fn.logWithError("failed to simulate for instructions","RPC_ERROR",{message:u.message})}let c=[];for(let u of a)if(fn.debug("simulate result:",u),u.logs){let l=u.logs.filter(d=>d&&d.includes(t));fn.debug("filteredLog:",c),l.length||fn.logWithError("simulate log not match keyword","keyword",t),c.push(...l)}return c}function Cu(r,e){let t=r.match(/{["\w:,]+}/g);return!t||t.length!==1?fn.logWithError(`simulate log fail to match json, keyword: ${e}`):t[0]}function yn(r,e){let n=new RegExp(`"${e}":(\\d+)`,"g").exec(r);return!n||n.length!==2?fn.logWithError(`simulate log fail to match key", key: ${e}`):n[1]}function ee(r,e){let[t,n]=Bu.findProgramAddressSync(r,e);return{publicKey:t,nonce:n}}async function id(r,e,t){let n=[];if(t){let o=await r.getLatestBlockhash(),i=[];for(let u of e){u.recentBlockhash=o.blockhash,u.lastValidBlockHeight=o.lastValidBlockHeight;let d=u._compile().serialize(),p=u._serialize(d).toString("base64");i.push(p)}let s=i.map(u=>{let l=r._buildArgs([u],void 0,"base64");return{methodName:"simulateTransaction",args:l}}),a=[],c=20;for(let u=0;u<Math.ceil(s.length/c);u++)a.push(s.slice(u*c,(u+1)*c));n=await(await Promise.all(a.map(async u=>(await r._rpcBatchRequest(u)).map(l=>l.result.value)))).flat()}else try{n=await Promise.all(e.map(async o=>await(await r.simulateTransaction(o)).value))}catch(o){o instanceof Error&&fn.logWithError("failed to get info for multiple accounts","RPC_ERROR",{message:o.message})}return n}function Eo({instructions:r,payer:e,signers:t}){return or(r,[e,...t])}function _o({instructions:r,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=Iu.generate().publicKey.toString()}){let i=new nd({payerKey:e,recentBlockhash:n,instructions:r}).compileToV0Message(Object.values(t??{}));try{return Buffer.from(new xu(i).serialize()).toString("base64").length<Su}catch{return!1}}var rd=r=>Buffer.isBuffer(r)?r:r instanceof Uint8Array?Buffer.from(r.buffer,r.byteOffset,r.byteLength):Buffer.from(r),sd=r=>{let e=r.serialize({requireAllSignatures:!1,verifySignatures:!1});r instanceof xu&&(e=rd(e));try{return e instanceof Buffer?e.toString("base64"):Buffer.from(e).toString("base64")}catch{return e.toString("base64")}};function Dn(r){let e=[];return r.forEach(t=>{t instanceof tr&&(t.recentBlockhash||(t.recentBlockhash=od.toBase58()),t.feePayer||(t.feePayer=Iu.generate().publicKey)),e.push(sd(t))}),console.log("simulate tx string:",e),e}function Y(r,e,t){return ee([r.toBuffer(),(t??ud).toBuffer(),e.toBuffer()],new ad("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import{PublicKey as ce}from"@solana/web3.js";var Bs=new ce("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),Lu=new ce("CBuCnLe26faBpcBP2fktp4rp8abpcAnTWft6ZrP5Q4T"),xs=new ce("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),co=new ce("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),cd=new ce("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),Ss=new ce("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),ir=new ce("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),Fo=new ce("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),ld=new ce("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),rr=new ce("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Kn=new ce("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),lo=new ce("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Vo=new ce("kN1kEznaF5Xbd8LYuqtEFcxzWSBk5Fv6ygX6SqEGJVy"),md=new ce("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),Ru=new ce("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),dd=new ce("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),pd=new ce("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),fd=new ce("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),yd=new ce("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),Wo=new ce("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),Ks=new ce("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),bd=new ce("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),gd=new ce("CPMDWBwJDtYax9qW7AyRuVC19Cc4L4Vcy4n2BHAbHkCW"),Ad=new ce("7rQ1QFNosMkUCuh7Z7fPbTHvh73b68sQYdirycEzJVuw"),Pd=new ce("G11FKBRaAkHAKuLCgLM6K6NUc9rTjPAznRCjZifrTQe2"),Do=new ce("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),wd=new ce("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),qo=new ce("3f7GcQFG397GAaEnv51zR6tsTVihYRydnydDD1cXekxH"),kd=new ce("7AFUeLVRjBfzqK3tTGw8hN48KLQWSk6DTE8xprWdPqix"),Xt=new ce("LanMV9sAd7wArD4vJFi2qDdfnVhFxYSUg6eADduJ3uj"),hd=new ce("WLHv2UAZm6z4KyaaELi5pjdbJh6RESMva1Rnn8pJVVh"),Td=new ce("LanD8FpTBBvzZFXjTxsAoipkFsxPUCDB4qAqKxYDiNP"),Id=new ce("HYNHiyKJ3gGVFvyxJAurK7qr7P2o5J9THmvCGMdULtpW"),Uo={IDO_PROGRAM_ID_V1:dd,IDO_PROGRAM_ID_V2:pd,IDO_PROGRAM_ID_V3:fd,IDO_PROGRAM_ID_V4:yd},yt={AMM_V4:Fo,AMM_STABLE:ld,CLMM_PROGRAM_ID:Kn,CLMM_LOCK_PROGRAM_ID:lo,CLMM_LOCK_AUTH_ID:Vo,FARM_PROGRAM_ID_V3:Bs,FARM_PROGRAM_ID_V5:xs,FARM_PROGRAM_ID_V6:co,OPEN_BOOK_PROGRAM:Ss,SERUM_PROGRAM_ID_V3:ir,UTIL1216:cd,Router:md,CREATE_CPMM_POOL_PROGRAM:Wo,CREATE_CPMM_POOL_AUTH:Ks,CREATE_CPMM_POOL_FEE_ACC:bd,LOCK_CPMM_PROGRAM:Do,LOCK_CPMM_AUTH:qo,LAUNCHPAD_PROGRAM:Xt,LAUNCHPAD_AUTH:hd},kg={SERUM_MARKET:ce.default,OPENBOOK_MARKET:new ce("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),UTIL1216:ce.default,FarmV3:new ce("85BFyr98MbCUU9MVTEgzx1nbhWACbJqLzho6zd6DZcWL"),FarmV5:new ce("EcLzTrNg9V7qhcdyXDe2qjtPkiGzDM2UbdRaeaadU5r2"),FarmV6:new ce("Farm2hJLcqPtPg8M4rR6DMrsRNc5TPm5Cs4bVQrMe2T7"),AmmV4:new ce("HWy1jotHpo6UqeQxx49dpYYdQB8wj9Qk9MdxwjLvDHB8"),AmmStable:new ce("DDg4VmQaJV9ogWce7LpcjBA9bv22wRp5uaTPa5pGjijF"),CLMM:new ce("devi51mZmdwUJGU9hjN27vEz64Gps7uUefqxg27EAtH"),CLMM_LOCK_PROGRAM_ID:new ce("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),CLMM_LOCK_AUTH_ID:new ce("8qmHNvu2Kr2C7U8mJL4Vz1vTDxMhVuXKREwU7TNoaVEo"),Router:new ce("BVChZ3XFEwTMUk1o9i3HAf91H6mFxSwa5X2wFAWhYPhU"),CREATE_CPMM_POOL_PROGRAM:gd,CREATE_CPMM_POOL_AUTH:Ad,CREATE_CPMM_POOL_FEE_ACC:Pd,FEE_DESTINATION_ID:new ce("3XMrhbv989VxAMi3DErLV9eJht1pHppW5LbKxe9fkEFR"),LOCK_CPMM_PROGRAM:wd,LCOK_CPMM_AUTH:kd,LAUNCHPAD_PROGRAM:Td,LAUNCHPAD_AUTH:Id};import bt from"bn.js";var Go=1e4;function we(r,e,t,n){if(e===void 0)return{amount:r,fee:void 0,expirationTime:void 0};let o={...e,olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}},i=t.epoch<o.newerTransferFee.epoch?o.olderTransferFee:o.newerTransferFee,s=new bt(i.maximumFee.toString()),a=t.epoch<o.newerTransferFee.epoch?(Number(o.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(i.transferFeeBasisPoints===Go){let c=new bt(i.maximumFee.toString());return{amount:r.add(c),fee:c,expirationTime:a}}else{let c=Cn(r.mul(new bt(Go)),new bt(Go-i.transferFeeBasisPoints)),u=new bt(i.maximumFee.toString()),l=c.sub(r).gt(u)?r.add(u):c,d=Cn(l.mul(new bt(i.transferFeeBasisPoints)),new bt(Go)),m=d.gt(s)?s:d;return{amount:l,fee:m,expirationTime:a}}else{let c=Cn(r.mul(new bt(i.transferFeeBasisPoints)),new bt(Go)),u=c.gt(s)?s:c;return{amount:r,fee:u,expirationTime:a}}}function Qt(r,e){return r===void 0?e:e===void 0?r:Math.min(r,e)}function Cn(r,e){let{div:t,mod:n}=r.divmod(e);return n.gt(new bt(0))?t.add(new bt(1)):t}function sr(r,e){if(r.isZero())return new bt(0);let t=r.div(e);return t.isZero()?new bt(1):r.mod(e).gt(new bt(0))?t.add(new bt(1)):t}import{PublicKey as Nu,AddressLookupTableAccount as ar}from"@solana/web3.js";async function Cs({connection:r,address:e}){let t=await Wt(r,[...new Set(e.map(o=>o.toString()))].map(o=>new Nu(o))),n={};for(let o=0;o<e.length;o++){let i=t[o],s=e[o];if(!i)continue;let a=new ar({key:s,state:ar.deserialize(i.data)});n[s.toString()]=a,ur[s.toString()]=a}return n}var ur={AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU:new ar({key:new Nu("AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU"),state:ar.deserialize(Buffer.from("AQAAAP//////////I1rcEwAAAAAvAQYwun9CU6c5Ikm2pAj+D9IEnCOR45nK+SFTGSdpd6J6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAbd9uHXZaGT2cvhRs7reawctIXtX1s3kTqM9YV+/wCpBt324e51j94YQl285GzN2rYa/E2DuQ0n/r35KNihi/wFSlNQ+F3IgtYUpVZyeIopbd8eq6vQpgZ4iEky9O72oAVKU1qZKSEGTSTocWDaOHx8NbXdvJK7geQfqEBBBUSNBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvBkX2T9y7AHdNGviJAqQNtlDUDCnauQRWybsLji6nPM8Qkw5asQRvCdB3MbX6IEBwytOrpM32l4jQygKG9TKgR0vZScQ2AsM/IHeQ7RajUkyhuZdc8SGiqQz/7H34torNR/Wir3sl0ruUrVxJWEZfUg+QLNAxxODdBi53/OP7Ioil1cqeBM9dtZC3FLov4yyxWRM/wcGStyJX/QfTnLBAHqkqWotPKVlShCVQqpP9W5W1rOao65IMk5QuQ2kMIOxzDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu/YsA/yfEEFGcr8Z57VKDw8uQzpiru7g4lvjnfapW62W030syevD8k07SGoxUHiuT/ai7gAHWWhDsVmg/C63ajgpkH7Sn3GdutArDTfyqOkdqv4/IPC/EFFy7mGkfDd2C57N5a/4jC+BbmJy7wQaSEZr0CQU88lPtUxIVvzGjC95b8Ooss2TqmkrayGKofkPMGQn7Ux+9lfwBSNfxwH8NgbpqC/7LNlV4I7nCvsXf3p+ohQk9NrAJb2KAFpUqEIJ9ZBV7BYDzHF/ORKYlgtvPnXjudZQ6CEo5OzUDaNIomTCCsvhD16TxJjsbgne1kGnQPCFSoaxUbq2V1bPMFQ3VYP6wDZ9bKStCFKx9A3tNbwZFC5ZGAN83MFK7XoTy+OmmcFEr6rLOjfSuTfPvHJkSVxW6Qllwkl67XcBi5v00u2gQsbu+38sp+rd5pA/LvyWj4P94ZGZwc1tE2P88xekCLcAwZGb+UhFzL/7K26csOb57yM5bvF9xJrLEObOkAAAAAn+HWRkdcPKyFFMnVwEoD7vnD0jCKFIU1sImubYCxNTSVzsKpaQX+fzNxrLAI3L14JQnJx/D6Uk2LADIHGqnGELzjEbkBDAlaM77NkXMPfqXNLSveCkWI7UEgNs31WEWB6XHSYI/v5DklHOb4QTtDOR804PVbi3fjloZeLR2F8d4FuZmMMO7ck3Fnkn2zEMG5gOmqsygb6PjTitArVl52NhcSznTxVnguaIJxiZkAnurDmn3MWR0PC2GLghp2KJqHCc6QQ85odeIjFHKOlRlJyeSXVJmL8vb1UgOzsbJPVP8p6zM4M3C1Sd7uWIHP33G42AP2Zg8ucn/n6meQjjD266JgCWdxZD6PXs9CsnIeL7SSG0/6lGb9xfP0ZcWkCXB/3hjxHYVXjra/GPOeXGk0fLLKjCbk+mgs2w6d2oCwimBipTzuoZ30GiI8ij8VRzD5CzMWtu2m21eDBIfjGAEo4pQeNNonKcqzV/cleX8ySZLOHsz8PtBCrLqF+VkLm9hOzIT+6i/nIf6keR4GWKMOD4AvqfpjHoD4DuhBpz8P28+DxkGrDXXr/nr20x291VPvcTU/b+b+o2kC9G0kcXeTlLjU6a2TQXWlZ4gBUdBl1jgT7mObSTpLblNiXZsLkbmVXZwvFKXua5cUKlWed/w30skmEUraTuQqtqr5fHZPW9n57EmeTif6LjHL2YJFZkQU+TrJmFzqzmF4/b8OwrPQAprl8mX3q4LUIdAS/a+11B6DWD1Xk2++Sn94dLC4xjkO4Wtlw8c4XuzciVbepHOmnoWzVu/0y3KCrLCSfQxQ3br8DJCoVzhgtPsS2nZZjsBGIZgnU0QpMv+2MnRsnKwdp1VsrCX84j/qvaZn4WhKunippgTbN2EUs0tPTP55Qfgj+nKmjtWW5IYs72FrEwJKYoNfsmqaF4o5pf4v9zgPwVwY/5I4XJKUL2L25m9kAQcW/K+H1RTFEUoj8Z4ajpOmAB/dG0COmCphVMW2CCMvnxhcGiSgPnpDuWu6qiJ7NG7ye5kvHgefgqPLeicspNJ5EpL3XiRNLM2tmJLI1awAwOyd6iHv0dCkMYRKaa6rcaZeYwmKCkckm0kM2JNmnmmAaBQQ7mwmIM0IMxX4f5W6j9PqZWcJxF7r17T/lQBAmcjoupRiJifbnXCNUv9GhpRF19WcBdeKbivRJVlGop6I2RS6lGImJ9udcI1S/0aGlEXX1ZwF14puK9ElWUainojZFYVHLHD6dIP2ESjqBzg3ol1/wB7+/ylGwd9LS7wSZ2A630CJSVKwH47K9P4bB8PEQP8BwjMFa7xQHOqZFP1XqaQ==","base64"))})};import{PublicKey as mo,sendAndConfirmTransaction as Ls,SystemProgram as Bd,Transaction as Xo,TransactionMessage as Qo,VersionedTransaction as zo}from"@solana/web3.js";import xd from"axios";var cr=2e3,lr=class{connection;owner;instructions=[];endInstructions=[];lookupTableAddress=[];signers=[];instructionTypes=[];endInstructionTypes=[];feePayer;cluster;signAllTransactions;blockhashCommitment;loopMultiTxStatus;constructor(e){this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster,this.blockhashCommitment=e.blockhashCommitment,this.loopMultiTxStatus=!!e.loopMultiTxStatus}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){let e=(await xd.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=e?.[15]??{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=ao(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}addTipInstruction(e){return e?(this.endInstructions.push(Bd.transfer({fromPubkey:e.feePayer??this.feePayer,toPubkey:new mo(e.address),lamports:BigInt(e.amount.toString())})),this.endInstructionTypes.push(V.TransferTip),!0):!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:o=[],endInstructionTypes:i=[],lookupTableAddress:s=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...o),this.endInstructionTypes.push(...i),this.lookupTableAddress.push(...s.filter(a=>a!==mo.default.toString())),this}async versionBuild({txVersion:e,extInfo:t},n){return e===0?await this.buildV0({...t||{}},n):this.build(t,n)}build(e,t){let n=new Xo;return this.allInstructions.length&&n.add(...this.allInstructions),n.feePayer=this.feePayer,this.owner?.signer&&!this.signers.some(o=>o.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer),{builder:this,transaction:n,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async o=>{let{recentBlockHash:i,skipPreflight:s=!0,sendAndConfirm:a,notSendToRpc:c}=o||{},u=i??t??await uo(this.connection,this.blockhashCommitment);if(n.recentBlockhash=u,this.signers.length&&n.sign(...this.signers),Dn([n]),this.owner?.isKeyPair)return{txId:a?await Ls(this.connection,n,this.signers.find(d=>d.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:s}):await this.connection.sendRawTransaction(n.serialize(),{skipPreflight:s}),signedTx:n};if(this.signAllTransactions){let l=await this.signAllTransactions([n]);if(this.signers.length)for(let d of l)try{d.sign(...this.signers)}catch{}return{txId:c?"":await this.connection.sendRawTransaction(l[0].serialize(),{skipPreflight:s}),signedTx:l[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:o}=this.build(n),i=t.filter(u=>u.transaction.instructions.length>0),s=[o,...i.map(u=>u.transaction)],a=[this.signers,...i.map(u=>u.signers)],c=[...this.instructionTypes,...i.map(u=>u.instructionTypes).flat()];return this.owner?.signer&&a.forEach(u=>{u.some(l=>l.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:c,execute:async u=>{let{sequentially:l,onTxUpdate:d,skipTxCount:m=0,recentBlockHash:p,skipPreflight:y=!0}=u||{},f=p??await uo(this.connection,this.blockhashCommitment);if(this.owner?.isKeyPair){if(l){let b=[],g=0;for(let w of s){if(++g,g<=m)continue;let k=await Ls(this.connection,w,this.signers.find(h=>h.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:y});b.push(k)}return{txIds:b,signedTxs:s}}return{txIds:await await Promise.all(s.map(async b=>(b.recentBlockhash=f,await this.connection.sendRawTransaction(b.serialize(),{skipPreflight:y})))),signedTxs:s}}if(this.signAllTransactions){let b=s.map((w,k)=>(w.recentBlockhash=f,a[k].length&&w.sign(...a[k]),w));Dn(b);let g=await this.signAllTransactions(b);if(l){let w=0,k=[],h=async()=>{if(!g[w])return;let x=await this.connection.sendRawTransaction(g[w].serialize(),{skipPreflight:y});k.push({txId:x,status:"sent",signedTx:g[w]}),d?.([...k]),w++;let T=!1,B=null,S=null,I=K=>{B!==null&&clearInterval(B),S!==null&&this.connection.removeSignatureListener(S);let N=k.findIndex(v=>v.txId===x);if(N>-1){if(k[N].status==="error"||k[N].status==="success")return;k[N].status=K.err?"error":"success"}d?.([...k]),K.err||h()};this.loopMultiTxStatus&&(B=setInterval(async()=>{if(T){clearInterval(B);return}try{let K=await this.connection.getTransaction(x,{commitment:"confirmed",maxSupportedTransactionVersion:0});K&&(T=!0,clearInterval(B),I({err:K.meta?.err||null}),console.log("tx status from getTransaction:",x))}catch(K){T=!0,clearInterval(B),console.error("getTransaction timeout:",K,x)}},cr)),S=this.connection.onSignature(x,K=>{if(T){this.connection.removeSignatureListener(S);return}T=!0,I(K)},"confirmed"),this.connection.getSignatureStatus(x)};return await h(),{txIds:k.map(x=>x.txId),signedTxs:g}}else{let w=[];for(let k=0;k<g.length;k+=1){let h=await this.connection.sendRawTransaction(g[k].serialize(),{skipPreflight:y});w.push(h)}return{txIds:w,signedTxs:g}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e,t){let{lookupTableCache:n={},lookupTableAddress:o=[],forerunCreate:i,recentBlockhash:s,...a}=e||{},c={...this.cluster==="devnet"?{}:ur,...n},u=Array.from(new Set([...o,...this.lookupTableAddress])),l=[];for(let y of u)c[y]===void 0&&l.push(new mo(y));if(l.length>0){let y=await Cs({connection:this.connection,address:l});for(let[f,b]of Object.entries(y))c[f]=b}let d=t??(i?mo.default.toBase58():s??await uo(this.connection,this.blockhashCommitment)),m=new Qo({payerKey:this.feePayer,recentBlockhash:d,instructions:[...this.allInstructions]}).compileToV0Message(Object.values(c));this.owner?.signer&&!this.signers.some(y=>y.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer);let p=new zo(m);return p.sign(this.signers),{builder:this,transaction:p,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async y=>{let{skipPreflight:f=!0,sendAndConfirm:b,notSendToRpc:g}=y||{};if(Dn([p]),this.owner?.isKeyPair){let w=await this.connection.sendTransaction(p,{skipPreflight:f});return b&&await nr(this.connection,w),{txId:w,signedTx:p}}if(this.signAllTransactions){let w=await this.signAllTransactions([p]);if(this.signers.length)for(let k of w)try{k.sign(this.signers)}catch{}return{txId:g?"":await this.connection.sendTransaction(w[0],{skipPreflight:f}),signedTx:w[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:a||{}}}async buildV0MultiTx(e){let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:o}=await this.buildV0(n),i=t.filter(u=>u.builder.instructions.length>0),s=[o,...i.map(u=>u.transaction)],a=[this.signers,...i.map(u=>u.signers)],c=[...this.instructionTypes,...i.map(u=>u.instructionTypes).flat()];return this.owner?.signer&&a.forEach(u=>{u.some(l=>l.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),s.forEach(async(u,l)=>{u.sign(a[l])}),{builder:this,transactions:s,signers:a,instructionTypes:c,buildProps:n,execute:async u=>{let{sequentially:l,onTxUpdate:d,recentBlockHash:m,skipPreflight:p=!0}=u||{};if(m&&s.forEach(y=>y.message.recentBlockhash=m),Dn(s),this.owner?.isKeyPair){if(l){let y=[];for(let f of s){let b=await this.connection.sendTransaction(f,{skipPreflight:p});await nr(this.connection,b),y.push(b)}return{txIds:y,signedTxs:s}}return{txIds:await Promise.all(s.map(async y=>await this.connection.sendTransaction(y,{skipPreflight:p}))),signedTxs:s}}if(this.signAllTransactions){let y=await this.signAllTransactions(s);if(l){let f=0,b=[],g=async()=>{if(!y[f])return;let w=await this.connection.sendTransaction(y[f],{skipPreflight:p});b.push({txId:w,status:"sent",signedTx:y[f]}),d?.([...b]),f++;let k=!1,h=null,x=null,T=B=>{h!==null&&clearInterval(h),x!==null&&this.connection.removeSignatureListener(x);let S=b.findIndex(I=>I.txId===w);if(S>-1){if(b[S].status==="error"||b[S].status==="success")return;b[S].status=B.err?"error":"success"}d?.([...b]),B.err||g()};this.loopMultiTxStatus&&(h=setInterval(async()=>{if(k){clearInterval(h);return}try{let B=await this.connection.getTransaction(w,{commitment:"confirmed",maxSupportedTransactionVersion:0});B&&(k=!0,clearInterval(h),T({err:B.meta?.err||null}),console.log("tx status from getTransaction:",w))}catch(B){k=!0,clearInterval(h),console.error("getTransaction timeout:",B,w)}},cr)),x=this.connection.onSignature(w,B=>{if(k){this.connection.removeSignatureListener(x);return}k=!0,T(B)},"confirmed"),this.connection.getSignatureStatus(w)};return g(),{txIds:[],signedTxs:y}}else{let f=[];for(let b=0;b<y.length;b+=1){let g=await this.connection.sendTransaction(y[b],{skipPreflight:p});f.push(g)}return{txIds:f,signedTxs:y}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){let{splitIns:t=[],computeBudgetConfig:n,...o}=e||{},i=n?ao(n):{instructions:[],instructionTypes:[]},s=this.signers.reduce((d,m)=>({...d,[m.publicKey.toBase58()]:m}),{}),a=[],c=[],u=[],l=0;if(this.allInstructions.forEach(d=>{let m=[...u,d],p=n?[...i.instructions,...m]:m,f=[...new Set(m.map(b=>b.keys.filter(g=>g.isSigner).map(g=>g.pubkey.toString())).flat()).values()].map(b=>new mo(b));if(d!==t[l]&&u.length<12&&(Eo({instructions:p,payer:this.feePayer,signers:f})||Eo({instructions:m,payer:this.feePayer,signers:f})))u.push(d);else{if(u.length===0)throw Error("item ins too big");l+=d===t[l]?1:0,Eo({instructions:n?[...i.instructions,...u]:[...u],payer:this.feePayer,signers:f})?a.push(new Xo().add(...i.instructions,...u)):a.push(new Xo().add(...u)),c.push(Array.from(new Set(u.map(b=>b.keys.filter(g=>g.isSigner).map(g=>g.pubkey.toString())).flat())).map(b=>s[b]).filter(b=>b!==void 0)),u=[d]}}),u.length>0){let m=[...new Set(u.map(p=>p.keys.filter(y=>y.isSigner).map(y=>y.pubkey.toString())).flat()).values()].map(p=>s[p]).filter(p=>p!==void 0);Eo({instructions:n?[...i.instructions,...u]:[...u],payer:this.feePayer,signers:m.map(p=>p.publicKey)})?a.push(new Xo().add(...i.instructions,...u)):a.push(new Xo().add(...u)),c.push(m)}return a.forEach(d=>d.feePayer=this.feePayer),this.owner?.signer&&c.forEach(d=>{d.some(m=>m.publicKey.equals(this.owner.publicKey))||d.push(this.owner.signer)}),{builder:this,transactions:a,signers:c,instructionTypes:this.instructionTypes,execute:async d=>{let{sequentially:m,onTxUpdate:p,skipTxCount:y=0,recentBlockHash:f,skipPreflight:b=!0}=d||{},g=f??await uo(this.connection,this.blockhashCommitment);if(a.forEach(async(w,k)=>{w.recentBlockhash=g,c[k].length&&w.sign(...c[k])}),Dn(a),this.owner?.isKeyPair){if(m){let w=0,k=[];for(let h of a){if(++w,w<=y){k.push("tx skipped");continue}let x=await Ls(this.connection,h,this.signers.find(T=>T.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:b});k.push(x)}return{txIds:k,signedTxs:a}}return{txIds:await Promise.all(a.map(async w=>await this.connection.sendRawTransaction(w.serialize(),{skipPreflight:b}))),signedTxs:a}}if(this.signAllTransactions){let w=await this.signAllTransactions(a.slice(y,a.length)),k=[...a.slice(0,y),...w];if(m){let h=0,x=[],T=async()=>{if(!k[h])return;h<y&&(x.push({txId:"",status:"success",signedTx:k[h]}),p?.([...x]),h++,T());let B=await this.connection.sendRawTransaction(k[h].serialize(),{skipPreflight:b});x.push({txId:B,status:"sent",signedTx:k[h]}),p?.([...x]),h++;let S=!1,I=null,K=null,N=v=>{I!==null&&clearInterval(I),K!==null&&this.connection.removeSignatureListener(K);let _=x.findIndex(D=>D.txId===B);if(_>-1){if(x[_].status==="error"||x[_].status==="success")return;x[_].status=v.err?"error":"success"}p?.([...x]),v.err||T()};this.loopMultiTxStatus&&(I=setInterval(async()=>{if(S){clearInterval(I);return}try{let v=await this.connection.getTransaction(B,{commitment:"confirmed",maxSupportedTransactionVersion:0});v&&(S=!0,clearInterval(I),N({err:v.meta?.err||null}),console.log("tx status from getTransaction:",B))}catch(v){S=!0,clearInterval(I),console.error("getTransaction timeout:",v,B)}},cr)),K=this.connection.onSignature(B,v=>{if(S){this.connection.removeSignatureListener(K);return}S=!0,N(v)},"confirmed"),this.connection.getSignatureStatus(B)};return await T(),{txIds:x.map(B=>B.txId),signedTxs:k}}else{let h=[];for(let x=0;x<k.length;x+=1){let T=await this.connection.sendRawTransaction(k[x].serialize(),{skipPreflight:b});h.push(T)}return{txIds:h,signedTxs:k}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:o||{}}}async sizeCheckBuildV0(e){let{computeBudgetConfig:t,splitIns:n=[],lookupTableCache:o={},lookupTableAddress:i=[],...s}=e||{},a={...this.cluster==="devnet"?{}:ur,...o},c=Array.from(new Set([...this.lookupTableAddress,...i])),u=[];for(let w of c)a[w]===void 0&&u.push(new mo(w));let l=await Cs({connection:this.connection,address:u});for(let[w,k]of Object.entries(l))a[w]=k;let d=t?ao(t):{instructions:[],instructionTypes:[]},m=await uo(this.connection,this.blockhashCommitment),p=this.signers.reduce((w,k)=>({...w,[k.publicKey.toBase58()]:k}),{}),y=[],f=[],b=[],g=0;if(this.allInstructions.forEach(w=>{let k=[...b,w],h=t?[...d.instructions,...k]:k;if(w!==n[g]&&b.length<12&&(_o({instructions:h,payer:this.feePayer,lookupTableAddressAccount:a})||_o({instructions:k,payer:this.feePayer,lookupTableAddressAccount:a})))b.push(w);else{if(b.length===0)throw Error("item ins too big");g+=w===n[g]?1:0;let x={};for(let T of[...new Set(c)])a[T]!==void 0&&(x[T]=a[T]);if(t&&_o({instructions:[...d.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:a,recentBlockhash:m})){let T=new Qo({payerKey:this.feePayer,recentBlockhash:m,instructions:[...d.instructions,...b]}).compileToV0Message(Object.values(a));y.push(new zo(T))}else{let T=new Qo({payerKey:this.feePayer,recentBlockhash:m,instructions:[...b]}).compileToV0Message(Object.values(a));y.push(new zo(T))}f.push(Array.from(new Set(b.map(T=>T.keys.filter(B=>B.isSigner).map(B=>B.pubkey.toString())).flat())).map(T=>p[T]).filter(T=>T!==void 0)),b=[w]}}),b.length>0){let k=[...new Set(b.map(h=>h.keys.filter(x=>x.isSigner).map(x=>x.pubkey.toString())).flat()).values()].map(h=>p[h]).filter(h=>h!==void 0);if(t&&_o({instructions:[...d.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:a,recentBlockhash:m})){let h=new Qo({payerKey:this.feePayer,recentBlockhash:m,instructions:[...d.instructions,...b]}).compileToV0Message(Object.values(a));y.push(new zo(h))}else{let h=new Qo({payerKey:this.feePayer,recentBlockhash:m,instructions:[...b]}).compileToV0Message(Object.values(a));y.push(new zo(h))}f.push(k)}return this.owner?.signer&&f.forEach(w=>{w.some(k=>k.publicKey.equals(this.owner.publicKey))||w.push(this.owner.signer)}),y.forEach((w,k)=>{w.sign(f[k])}),{builder:this,transactions:y,buildProps:e,signers:f,instructionTypes:this.instructionTypes,execute:async w=>{let{sequentially:k,onTxUpdate:h,skipTxCount:x=0,recentBlockHash:T,skipPreflight:B=!0}=w||{};if(y.map(async(S,I)=>{f[I].length&&S.sign(f[I]),T&&(S.message.recentBlockhash=T)}),Dn(y),this.owner?.isKeyPair){if(k){let S=0,I=[];for(let K of y){if(++S,S<=x){console.log("skip tx: ",S),I.push("tx skipped");continue}let N=await this.connection.sendTransaction(K,{skipPreflight:B});await nr(this.connection,N),I.push(N)}return{txIds:I,signedTxs:y}}return{txIds:await Promise.all(y.map(async S=>await this.connection.sendTransaction(S,{skipPreflight:B}))),signedTxs:y}}if(this.signAllTransactions){let S=await this.signAllTransactions(y.slice(x,y.length)),I=[...y.slice(0,x),...S];if(k){let K=0,N=[],v=async()=>{if(!I[K])return;if(K<x){N.push({txId:"",status:"success",signedTx:I[K]}),h?.([...N]),K++,v();return}let _=await this.connection.sendTransaction(I[K],{skipPreflight:B});N.push({txId:_,status:"sent",signedTx:I[K]}),h?.([...N]),K++;let D=!1,q=null,G=null,ne=ie=>{q!==null&&clearInterval(q),G!==null&&this.connection.removeSignatureListener(G);let me=N.findIndex(re=>re.txId===_);if(me>-1){if(N[me].status==="error"||N[me].status==="success")return;N[me].status=ie.err?"error":"success"}h?.([...N]),ie.err||v()};this.loopMultiTxStatus&&(q=setInterval(async()=>{if(D){clearInterval(q);return}try{let ie=await this.connection.getTransaction(_,{commitment:"confirmed",maxSupportedTransactionVersion:0});ie&&(D=!0,clearInterval(q),ne({err:ie.meta?.err||null}),console.log("tx status from getTransaction:",_))}catch(ie){D=!0,clearInterval(q),console.error("getTransaction timeout:",ie,_)}},cr)),G=this.connection.onSignature(_,ie=>{if(D){this.connection.removeSignatureListener(G);return}D=!0,ne(ie)},"confirmed"),this.connection.getSignatureStatus(_)};return v(),{txIds:[],signedTxs:I}}else{let K=[];for(let N=0;N<I.length;N+=1){let v=await this.connection.sendTransaction(I[N],{skipPreflight:B});K.push(v)}return{txIds:K,signedTxs:I}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}};import Sd from"bn.js";var zt=new Sd(1e6);var nt={BASE_HOST:"https://api-v3.raydium.io",OWNER_BASE_HOST:"https://owner-v1.raydium.io",SERVICE_BASE_HOST:"https://service.raydium.io",MONITOR_BASE_HOST:"https://monitor.raydium.io",SERVICE_1_BASE_HOST:"https://service-v1.raydium.io",SEND_TRANSACTION:"/send-transaction",FARM_ARP:"/main/farm/info",FARM_ARP_LINE:"/main/farm-apr-tv",CLMM_CONFIG:"/main/clmm-config",CPMM_CONFIG:"/main/cpmm-config",VERSION:"/main/version",CHECK_AVAILABILITY:"/v3/main/AvailabilityCheckAPI",RPCS:"/main/rpcs",INFO:"/main/info",STAKE_POOLS:"/main/stake-pools",CHAIN_TIME:"/main/chain-time",TOKEN_LIST:"/mint/list",MINT_INFO_ID:"/mint/ids",JUP_TOKEN_LIST:"https://lite-api.jup.ag/tokens/v1/tagged/verified",POOL_LIST:"/pools/info/list",POOL_SEARCH_BY_ID:"/pools/info/ids",POOL_SEARCH_MINT:"/pools/info/mint",POOL_SEARCH_LP:"/pools/info/lps",POOL_KEY_BY_ID:"/pools/key/ids",POOL_LIQUIDITY_LINE:"/pools/line/liquidity",POOL_POSITION_LINE:"/pools/line/position",FARM_INFO:"/farms/info/ids",FARM_LP_INFO:"/farms/info/lp",FARM_KEYS:"/farms/key/ids",OWNER_CREATED_FARM:"/create-pool/{owner}",OWNER_IDO:"/main/ido/{owner}",OWNER_STAKE_FARMS:"/position/stake/{owner}",OWNER_LOCK_POSITION:"/position/clmm-lock/{owner}",IDO_KEYS:"/ido/key/ids",SWAP_HOST:"https://transaction-v1.raydium.io",SWAP_COMPUTE:"/compute/",SWAP_TX:"/transaction/",MINT_PRICE:"/mint/price",MIGRATE_CONFIG:"/main/migrate-lp",PRIORITY_FEE:"/main/auto-fee",CPMM_LOCK:"https://dynamic-ipfs.raydium.io/lock/cpmm/position"},cA={...nt};var Ou="ray_tab_hash",Rs="ray_req_hash",Kd=()=>{if(typeof window===void 0)return"";let r=sessionStorage.getItem(Ou);return r||(r=`ray-${Date.now()}`,sessionStorage.setItem(Ou,r)),r},mr=async({logCount:r=1e3,removeLastLog:e,...t})=>{if(typeof window===void 0)return new Promise(o=>o());let n=JSON.parse(localStorage.getItem(Rs)||"[]").slice(0,r-1);e&&n.pop(),new Blob([JSON.stringify(t.data)]).size>1024&&(t.data=JSON.stringify(t.data).substring(0,200)+"..."),n.unshift({...t,time:Date.now(),session:Kd()});try{localStorage.setItem(Rs,JSON.stringify(n))}catch{if(e){let o=!1,i=JSON.stringify(t.data).substring(0,100);for(n[0].data=i+(i.length>100?"...":"");!o;){n.pop();let s=JSON.stringify(t.data).substring(0,100);n[0].data=s+(s.length>100?"...":"");try{localStorage.setItem(Rs,JSON.stringify(n)),o=!0}catch{o=!1}}return new Promise(s=>s())}return mr({...t,logCount:r,removeLastLog:!0})}};import{TOKEN_2022_PROGRAM_ID as Cd,TOKEN_PROGRAM_ID as Ld}from"@solana/spl-token";var dr=de("Raydium_Api"),Ns=new Map;var pr=class{cluster;api;logCount;urlConfigs;constructor({cluster:e,timeout:t,logRequests:n,logCount:o,urlConfigs:i}){this.cluster=e,this.urlConfigs=i||{},this.logCount=o||1e3,this.api=vu.create({baseURL:this.urlConfigs.BASE_HOST||nt.BASE_HOST,timeout:t}),this.api.interceptors.request.use(s=>{let{method:a,baseURL:c,url:u}=s;return dr.debug(`${a?.toUpperCase()} ${c}${u}`),s},s=>(dr.error("Request failed"),Promise.reject(s))),this.api.interceptors.response.use(s=>{let{config:a,data:c,status:u}=s,{method:l,baseURL:d,url:m}=a;return n&&mr({status:u,url:`${d}${m}`,params:a.params,data:c,logCount:this.logCount}),dr.debug(`${l?.toUpperCase()} ${d}${m}  ${u}`),c},s=>{let{config:a,response:c={}}=s,{status:u}=c,{method:l,baseURL:d,url:m}=a;return n&&mr({status:u,url:`${d}${m}`,params:a.params,data:s.message,logCount:this.logCount}),dr.error(`${l.toUpperCase()} ${d}${m} ${u||s.message}`),Promise.reject(s)})}async getClmmConfigs(){return(await this.api.get(this.urlConfigs.CLMM_CONFIG||nt.CLMM_CONFIG)).data}async getCpmmConfigs(){return(await this.api.get(this.urlConfigs.CPMM_CONFIG||nt.CPMM_CONFIG)).data}async getClmmPoolLines(e){return(await this.api.get(`${this.urlConfigs.POOL_LIQUIDITY_LINE||nt.POOL_LIQUIDITY_LINE}?pool_id=${e}`)).data}async getBlockSlotCountForSecond(e){if(!e)return 2;let n=(await vu.post(e,{id:"getRecentPerformanceSamples",jsonrpc:"2.0",method:"getRecentPerformanceSamples",params:[4]})).result.map(o=>o.numSlots);return n.reduce((o,i)=>o+i,0)/n.length/60}async getChainTimeOffset(){return(await this.api.get(this.urlConfigs.CHAIN_TIME||nt.CHAIN_TIME)).data}async getRpcs(){return this.api.get(this.urlConfigs.RPCS||nt.RPCS)}async getTokenList(){return(await this.api.get(this.urlConfigs.TOKEN_LIST||nt.TOKEN_LIST)).data}async getJupTokenList(){return(await this.api.get("",{baseURL:this.urlConfigs.JUP_TOKEN_LIST||nt.JUP_TOKEN_LIST})).map(t=>({...t,chainId:101,programId:t.tags.includes("token-2022")?Cd.toBase58():Ld.toBase58()}))}async getTokenInfo(e){return(await this.api.get((this.urlConfigs.MINT_INFO_ID||nt.MINT_INFO_ID)+`?mints=${e.map(n=>n.toString()).join(",")}`)).data}async getPoolList(e={}){let{type:t="all",sort:n="liquidity",order:o="desc",page:i=0,pageSize:s=100}=e;return(await this.api.get((this.urlConfigs.POOL_LIST||nt.POOL_LIST)+`?poolType=${t}&poolSortField=${n}&sortType=${o}&page=${i}&pageSize=${s}`)).data}async fetchPoolById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.POOL_SEARCH_BY_ID||nt.POOL_SEARCH_BY_ID)+`?ids=${t}`)).data}async fetchPoolKeysById(e){let{idList:t}=e,n=[],o=t.filter(s=>Ns.has(s)?(n.push(Ns.get(s)),!1):!0),i=[];return o.length&&(i=(await this.api.get((this.urlConfigs.POOL_KEY_BY_ID||nt.POOL_KEY_BY_ID)+`?ids=${o.join(",")}`)).data.filter(Boolean),i.forEach(a=>{Ns.set(a.id,a)})),n.concat(i)}async fetchPoolByMints(e){let{mint1:t,mint2:n,type:o="all",sort:i="default",order:s="desc",page:a=1}=e,[c,u]=[t&&ct(t).toBase58(),n&&n!=="undefined"?ct(n).toBase58():""],[l,d]=u&&c>u?[u,c]:[c,u];return(await this.api.get((this.urlConfigs.POOL_SEARCH_MINT||nt.POOL_SEARCH_MINT)+`?mint1=${l}&mint2=${d}&poolType=${o}&poolSortField=${i}&sortType=${s}&pageSize=100&page=${a}`)).data}async fetchFarmInfoById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_INFO||nt.FARM_INFO)+`?ids=${t}`)).data}async fetchFarmKeysById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_KEYS||nt.FARM_KEYS)+`?ids=${t}`)).data}async fetchAvailabilityStatus(){return(await this.api.get(this.urlConfigs.CHECK_AVAILABILITY||nt.CHECK_AVAILABILITY)).data}};var fr="please provide owner in load() initialization or you can set by calling raydium.setOwner(owner)",Mu="please provide connection in load() initialization or set it by raydium.setConnection(connection)";import{PublicKey as kr,SystemProgram as ap}from"@solana/web3.js";import{AccountLayout as go,createAssociatedTokenAccountInstruction as qs,TOKEN_PROGRAM_ID as On,TOKEN_2022_PROGRAM_ID as up}from"@solana/spl-token";var Os=(...r)=>r.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Re=class{scope;disabled=!1;logger;constructor({scope:e,moduleName:t}){this.scope=e,this.logger=de(t)}createTxBuilder(e){return this.scope.checkOwner(),new lr({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,blockhashCommitment:this.scope.blockhashCommitment,loopMultiTxStatus:this.scope.loopMultiTxStatus,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(Os(e))}logInfo(...e){this.logger.info(Os(e))}logAndCreateError(...e){let t=Os(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as tp,SystemProgram as np}from"@solana/web3.js";import op from"bn.js";import{createCloseAccountInstruction as ip,createInitializeAccountInstruction as rp,createTransferInstruction as sp,TOKEN_PROGRAM_ID as bo}from"@solana/spl-token";import{Keypair as Zd,PublicKey as Yu}from"@solana/web3.js";import $d from"bn.js";import{TOKEN_PROGRAM_ID as Jd}from"@solana/spl-token";function Rd(r){return r instanceof Uint8Array||r!=null&&typeof r=="object"&&r.constructor.name==="Uint8Array"}function vs(r,...e){if(!Rd(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${r.length}`)}function Ms(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function Eu(r,e){vs(r);let t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var br=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),Ht=(r,e)=>r<<32-e|r>>>e;var HA=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function Nd(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function Es(r){return typeof r=="string"&&(r=Nd(r)),vs(r),r}var yr=class{clone(){return this._cloneInto()}},jA={}.toString;function _u(r){let e=n=>r().update(Es(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function Od(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let o=BigInt(32),i=BigInt(4294967295),s=Number(t>>o&i),a=Number(t&i),c=n?4:0,u=n?0:4;r.setUint32(e+c,s,n),r.setUint32(e+u,a,n)}var Fu=(r,e,t)=>r&e^~r&t,Vu=(r,e,t)=>r&e^r&t^e&t,gr=class extends yr{constructor(e,t,n,o){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=o,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=br(this.buffer)}update(e){Ms(this);let{view:t,buffer:n,blockLen:o}=this;e=Es(e);let i=e.length;for(let s=0;s<i;){let a=Math.min(o-this.pos,i-s);if(a===o){let c=br(e);for(;o<=i-s;s+=o)this.process(c,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===o&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){Ms(this),Eu(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:o,isLE:i}=this,{pos:s}=this;t[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>o-s&&(this.process(n,0),s=0);for(let d=s;d<o;d++)t[d]=0;Od(n,o-8,BigInt(this.length*8),i),this.process(n,0);let a=br(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let u=c/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let d=0;d<u;d++)a.setUint32(4*d,l[d],i)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:o,finished:i,destroyed:s,pos:a}=this;return e.length=o,e.pos=a,e.finished=i,e.destroyed=s,o%t&&e.buffer.set(n),e}};var vd=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Ln=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Rn=new Uint32Array(64),_s=class extends gr{constructor(){super(64,32,8,!1),this.A=Ln[0]|0,this.B=Ln[1]|0,this.C=Ln[2]|0,this.D=Ln[3]|0,this.E=Ln[4]|0,this.F=Ln[5]|0,this.G=Ln[6]|0,this.H=Ln[7]|0}get(){let{A:e,B:t,C:n,D:o,E:i,F:s,G:a,H:c}=this;return[e,t,n,o,i,s,a,c]}set(e,t,n,o,i,s,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=o|0,this.E=i|0,this.F=s|0,this.G=a|0,this.H=c|0}process(e,t){for(let d=0;d<16;d++,t+=4)Rn[d]=e.getUint32(t,!1);for(let d=16;d<64;d++){let m=Rn[d-15],p=Rn[d-2],y=Ht(m,7)^Ht(m,18)^m>>>3,f=Ht(p,17)^Ht(p,19)^p>>>10;Rn[d]=f+Rn[d-7]+y+Rn[d-16]|0}let{A:n,B:o,C:i,D:s,E:a,F:c,G:u,H:l}=this;for(let d=0;d<64;d++){let m=Ht(a,6)^Ht(a,11)^Ht(a,25),p=l+m+Fu(a,c,u)+vd[d]+Rn[d]|0,f=(Ht(n,2)^Ht(n,13)^Ht(n,22))+Vu(n,o,i)|0;l=u,u=c,c=a,a=s+p|0,s=i,i=o,o=n,n=p+f|0}n=n+this.A|0,o=o+this.B|0,i=i+this.C|0,s=s+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(n,o,i,s,a,c,u,l)}roundClean(){Rn.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var Wu=_u(()=>new _s);import{PublicKey as zd}from"@solana/web3.js";import Qu,{isBN as zu}from"bn.js";import{bits as Md,BitStructure as iP,blob as Ed,Blob as rP,cstr as sP,f32 as aP,f32be as uP,f64 as cP,f64be as lP,greedy as mP,Layout as _d,ns64 as dP,ns64be as pP,nu64 as Fd,nu64be as fP,offset as Vd,s16 as yP,s16be as bP,s24 as gP,s24be as AP,s32 as Wd,s32be as PP,s40 as wP,s40be as kP,s48 as hP,s48be as TP,s8 as IP,seq as Dd,struct as BP,Structure as qd,u16 as Ud,u16be as xP,u24 as SP,u24be as KP,u32 as Gd,u32be as CP,u40 as LP,u40be as RP,u48 as NP,u48be as OP,u8 as Xd,UInt as Qd,union as vP,Union as MP,unionLayoutDiscriminator as EP,utf8 as _P}from"@solana/buffer-layout";var Ar=_d,Du=qd;var Fs=Qd;var qu=Xd,jt=Ud;var Pr=Gd;var Uu=Fd;var Ne=Wd;var Gu=Dd;var ke=Ed;var Vs=Md,Xu=Vd;var qn=class extends Ar{blob;signed;constructor(e,t,n){super(e,n),this.blob=ke(e),this.signed=t}decode(e,t=0){let n=new Qu(this.blob.decode(e,t),10,"le");return this.signed?n.fromTwos(this.span*8).clone():n}encode(e,t,n=0){return typeof e=="number"&&(e=new Qu(e)),this.signed&&(e=e.toTwos(this.span*8)),this.blob.encode(e.toArrayLike(Buffer,"le",this.span),t,n)}},wr=class extends Ar{_lower;_upper;constructor(e){super(8,e),this._lower=Vs(Pr(),!1),this._upper=Vs(Pr(),!1)}addBoolean(e){this._lower.fields.length<32?this._lower.addBoolean(e):this._upper.addBoolean(e)}decode(e,t=0){let n=this._lower.decode(e,t),o=this._upper.decode(e,t+this._lower.span);return{...n,...o}}encode(e,t,n=0){return this._lower.encode(e,t,n)+this._upper.encode(e,t,n+this._lower.span)}};function F(r){return new Fs(1,r)}function rt(r){return new Fs(4,r)}function P(r){return new qn(8,!1,r)}function $(r){return new qn(16,!1,r)}function Hu(r){return new qn(1,!0,r)}function yo(r){return new qn(8,!0,r)}function ju(r){return new qn(16,!0,r)}var fo=class extends Ar{layout;decoder;encoder;constructor(e,t,n,o){super(e.span,o),this.layout=e,this.decoder=t,this.encoder=n}decode(e,t){return this.decoder(this.layout.decode(e,t))}encode(e,t,n){return this.layout.encode(this.encoder(e),t,n)}getSpan(e,t){return this.layout.getSpan(e,t)}};function L(r){return new fo(ke(32),e=>new zd(e),e=>e.toBuffer(),r)}function Ee(r){return new fo(qu(),Hd,jd,r)}function Hd(r){if(r===0)return!1;if(r===1)return!0;throw new Error("Invalid bool: "+r)}function jd(r){return r?1:0}function Yd(r){let e=Pr("length"),t=O([e,ke(Xu(e,-e.span),"data")]);return new fo(t,({data:n})=>n,n=>({data:n}),r)}function Yt(r){return new fo(Yd(),e=>e.toString("utf-8"),e=>Buffer.from(e,"utf-8"),r)}var Ws=class extends Du{decode(e,t){return super.decode(e,t)}};function O(r,e,t){return new Ws(r,e,t)}function Q(r,e,t){let n,o=typeof e=="number"?e:zu(e)?e.toNumber():new Proxy(e,{get(i,s){if(!n){let a=Reflect.get(i,"count");n=zu(a)?a.toNumber():a,Reflect.set(i,"count",n)}return Reflect.get(i,s)},set(i,s,a){return s==="count"&&(n=a),Reflect.set(i,s,a)}});return Gu(r,o,t)}var Zt=O([L("mint"),L("owner"),P("amount"),rt("delegateOption"),L("delegate"),F("state"),rt("isNativeOption"),P("isNative"),P("delegatedAmount"),rt("closeAuthorityOption"),L("closeAuthority")]);var iw=de("Raydium_Util");function Zu({owner:r,solAccountResp:e,tokenAccountResp:t}){let n=[],o=[];for(let{pubkey:i,account:s}of t.value){let a=Zt.decode(s.data),{mint:c,amount:u}=a;n.push({publicKey:i,mint:c,amount:u,isAssociated:Y(r,c,s.owner).publicKey.equals(i),isNative:!1,programId:s.owner}),o.push({pubkey:i,accountInfo:a,programId:s.owner})}return e&&n.push({mint:Yu.default,amount:new $d(String(e.lamports)),isNative:!0,programId:e.owner}),{tokenAccounts:n,tokenAccountRawInfos:o}}function We({fromPublicKey:r,programId:e=Jd,assignSeed:t}){let n=t?btoa(t).slice(0,32):Zd.generate().publicKey.toBase58().slice(0,32);return{publicKey:ep(r,n,e),seed:n}}function ep(r,e,t){let n=Buffer.concat([r.toBuffer(),Buffer.from(e),t.toBuffer()]),o=Wu(n);return new Yu(o)}function Ds(r){let{mint:e,tokenAccount:t,owner:n,programId:o=bo}=r;return rp(t,e,n,o)}function bn(r){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:o,programId:i=bo}=r;return ip(e,t,o,n,i)}async function Nn(r){let{connection:e,amount:t,commitment:n,payer:o,owner:i,skipCloseAccount:s}=r,a=await e.getMinimumBalanceForRentExemption(Zt.span,n),c=Z(t).add(new op(a)),u=We({fromPublicKey:o,programId:bo});return{addresses:{newAccount:u.publicKey},signers:[],instructions:[np.createAccountWithSeed({fromPubkey:o,basePubkey:o,seed:u.seed,newAccountPubkey:u.publicKey,lamports:c.toNumber(),space:Zt.span,programId:bo}),Ds({mint:new tp(Je.address),tokenAccount:u.publicKey,owner:i,programId:bo})],instructionTypes:[V.CreateAccount,V.InitAccount],endInstructionTypes:s?[]:[V.CloseAccount],endInstructions:s?[]:[bn({tokenAccount:u.publicKey,payer:o,owner:i})]}}function $u({source:r,destination:e,owner:t,amount:n,multiSigners:o=[],tokenProgram:i=bo}){return sp(r,e,t,BigInt(String(n)),o,i)}var Ho=class extends Re{_tokenAccounts=[];_tokenAccountRawInfos=[];_accountChangeListenerId;_accountListener=[];_clientOwnedToken=!1;_notSubscribeAccountChange=!1;_accountFetchTime=0;constructor(e){super(e);let{tokenAccounts:t,tokenAccountRawInfos:n,notSubscribeAccountChange:o}=e;this._tokenAccounts=t||[],this._tokenAccountRawInfos=n||[],this._notSubscribeAccountChange=o??!0,this._clientOwnedToken=!!(t||n)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}set notSubscribeAccountChange(e){this._notSubscribeAccountChange=e}updateTokenAccount({tokenAccounts:e,tokenAccountRawInfos:t}){return e&&(this._tokenAccounts=e),t&&(this._tokenAccountRawInfos=t),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(e){return this._accountListener.push(e),this}removeAccountChangeListener(e){return this._accountListener=this._accountListener.filter(t=>t!==e),this}getAssociatedTokenAccount(e,t){return Y(this.scope.ownerPubKey,e,t).publicKey}resetTokenAccounts(){this._clientOwnedToken||(this._tokenAccounts=[],this._tokenAccountRawInfos=[])}async fetchWalletTokenAccounts(e){if(this._clientOwnedToken||!e?.forceUpdate&&this._tokenAccounts.length&&Date.now()-this._accountFetchTime<(this._notSubscribeAccountChange?1e3*5:1e3*60*3))return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let n={...{},...e},[o,i,s]=await Promise.all([this.scope.connection.getAccountInfo(this.scope.ownerPubKey,n.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:On},n.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:up},n.commitment)]),{tokenAccounts:a,tokenAccountRawInfos:c}=Zu({owner:this.scope.ownerPubKey,solAccountResp:o,tokenAccountResp:{context:i.context,value:[...i.value,...s.value]}});return this._tokenAccounts=a,this._tokenAccountRawInfos=c,this._accountFetchTime=Date.now(),this._notSubscribeAccountChange||(this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>{this.fetchWalletTokenAccounts({forceUpdate:!0}),this._accountListener.forEach(u=>u({tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos}))},{commitment:e?.commitment})),{tokenAccounts:a,tokenAccountRawInfos:c}}clearAccountChangeCkb(){this._accountChangeListenerId!==void 0&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId)}async getCreatedTokenAccount({mint:e,programId:t=On,associatedOnly:n=!0}){await this.fetchWalletTokenAccounts();let o=this._tokenAccounts.filter(({mint:s})=>s?.equals(e)).sort((s,a)=>s.amount.lt(a.amount)?1:-1),i=this.getAssociatedTokenAccount(e,t);for(let s of o){let{publicKey:a}=s;if(a&&(!n||n&&i.equals(a)))return a}}async getOrCreateTokenAccount(e){await this.fetchWalletTokenAccounts();let{mint:t,createInfo:n,associatedOnly:o,owner:i,notUseTokenAccount:s=!1,skipCloseAccount:a=!1,checkCreateATAOwner:c=!1,assignSeed:u}=e,l=new kr(e.tokenProgram||On),d=this.getAssociatedTokenAccount(t,new kr(l)),m=(s?[]:this.tokenAccountRawInfos).filter(y=>y.accountInfo.mint.equals(t)&&(!o||y.pubkey.equals(d))).sort((y,f)=>y.accountInfo.amount.lt(f.accountInfo.amount)?1:-1);n===void 0||m.length>0;let p={instructions:[],endInstructions:[],signers:[],instructionTypes:[],endInstructionTypes:[]};if(o){let y=qs(i,d,i,t,l),f=this.tokenAccountRawInfos.find(b=>b.pubkey.equals(d));if(c){let b=await this.scope.connection.getAccountInfo(d);if(b===null)p.instructions?.push(y),p.instructionTypes.push(V.CreateATA);else if(!(b.owner.equals(l)&&go.decode(b.data).mint.equals(t)&&go.decode(b.data).owner.equals(i)))throw Error(`create ata check error -> mint: ${t.toString()}, ata: ${d.toString()}`)}else f===void 0&&(p.instructions.push(y),p.instructionTypes.push(V.CreateATA));if(t.equals(j)&&n?.amount){let b=await Nn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:n.payer||this.scope.ownerPubKey,amount:n.amount??0,skipCloseAccount:a});p.instructions.push(...b.instructions||[]),p.endInstructions.push(...b.endInstructions||[]),p.instructionTypes.push(...b.instructionTypes||[]),p.endInstructionTypes.push(...b.endInstructionTypes||[]),n.amount&&(p.instructions.push($u({source:b.addresses.newAccount,destination:d,owner:this.scope.ownerPubKey,amount:n.amount,tokenProgram:On})),p.instructionTypes.push(V.TransferAmount))}return!a&&f===void 0&&(p.endInstructions.push(bn({owner:i,payer:n?.payer||i,tokenAccount:d,programId:l})),p.endInstructionTypes.push(V.CloseAccount)),{account:d,instructionParams:p}}else{let y=We({fromPublicKey:i,programId:l,assignSeed:u}),f=await this.scope.connection.getMinimumBalanceForRentExemption(go.span),b=ap.createAccountWithSeed({fromPubkey:i,basePubkey:i,seed:y.seed,newAccountPubkey:y.publicKey,lamports:f+Number(n?.amount?.toString()??0),space:go.span,programId:l});return p.instructions.push(b,Ds({mint:t,tokenAccount:y.publicKey,owner:this.scope.ownerPubKey,programId:l})),p.instructionTypes.push(V.CreateAccount),p.instructionTypes.push(V.InitAccount),a||(p.endInstructions.push(bn({owner:i,payer:n?.payer||i,tokenAccount:y.publicKey,programId:l})),p.endInstructionTypes.push(V.CloseAccount)),{account:y.publicKey,instructionParams:p}}}async checkOrCreateAta({mint:e,programId:t=On,autoUnwrapWSOLToSOL:n}){await this.fetchWalletTokenAccounts();let o=this.scope.account.tokenAccounts.find(({mint:a})=>a?.toBase58()===e.toBase58())?.publicKey,i=this.scope.ownerPubKey,s={};if(!o){let a=this.getAssociatedTokenAccount(e,t),c=await qs(i,a,i,e,t);s.instructions=[c],s.instructionTypes=[V.CreateATA],o=a}return n&&j.toBase58()===e.toBase58()&&(s.endInstructions=[bn({owner:i,payer:i,tokenAccount:o,programId:t})],s.endInstructionTypes=[V.CloseAccount]),{pubKey:o,newInstructions:s}}async handleTokenAccount(e){let{side:t,amount:n,mint:o,programId:i=On,tokenAccount:s,payer:a=this.scope.ownerPubKey,bypassAssociatedCheck:c,skipCloseAccount:u,checkCreateATAOwner:l}=e,d=this.getAssociatedTokenAccount(o,i);if(new kr(j).equals(o)){let m=await Nn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:a,amount:n,skipCloseAccount:u});return{tokenAccount:m.addresses.newAccount,...m}}else if(!s||t==="out"&&!d.equals(s)&&!c){let m=[],p=qs(this.scope.ownerPubKey,d,this.scope.ownerPubKey,o,i);if(l){let y=await this.scope.connection.getAccountInfo(d);if(y===null)m.push(p);else if(!(y.owner.equals(On)&&go.decode(y.data).mint.equals(o)&&go.decode(y.data).owner.equals(this.scope.ownerPubKey)))throw Error(`create ata check error -> mint: ${o.toString()}, ata: ${d.toString()}`)}else m.push(p);return{tokenAccount:d,instructions:m,instructionTypes:[V.CreateATA]}}return{tokenAccount:s}}async processTokenAccount(e){let{mint:t,programId:n=On,amount:o,useSOLBalance:i,handleTokenAccount:s,feePayer:a}=e,c,u=this.createTxBuilder(a);if(t.equals(new kr(j))&&i){let{tokenAccount:l,...d}=await this.handleTokenAccount({side:"in",amount:o||0,mint:t,bypassAssociatedCheck:!0,programId:n});c=l,u.addInstruction(d)}else if(c=await this.getCreatedTokenAccount({mint:t,associatedOnly:!1,programId:n}),!c&&s){let{tokenAccount:l,...d}=await this.scope.account.handleTokenAccount({side:"in",amount:0,mint:t,bypassAssociatedCheck:!0,programId:n});c=l,u.addInstruction(d)}return{tokenAccount:c,...u.AllTxData}}};import{PublicKey as Te,SystemProgram as Cp}from"@solana/web3.js";import{createAssociatedTokenAccountInstruction as Lp}from"@solana/spl-token";import{PublicKey as rc}from"@solana/web3.js";var Us=O([F("instruction")]),Gs=O([F("instruction")]),cp=O([P("rewardState"),P("rewardOpenTime"),P("rewardEndTime"),P("rewardLastUpdateTime"),P("totalReward"),P("totalRewardEmissioned"),P("rewardClaimed"),P("rewardPerSecond"),$("accRewardPerShare"),L("rewardVault"),L("rewardMint"),L("rewardSender"),P("rewardType"),Q(P(),15,"padding")]),lp=O([P("state"),P("nonce"),L("lpVault"),L("rewardVault"),L(),L(),P(),P(),P("totalReward"),$("perShareReward"),P("lastSlot"),P("perSlotReward")]),mp=O([P("state"),P("nonce"),L("lpVault"),L("rewardVaultA"),P("totalRewardA"),$("perShareRewardA"),P("perSlotRewardA"),F("option"),L("rewardVaultB"),ke(7),P("totalRewardB"),$("perShareRewardB"),P("perSlotRewardB"),P("lastSlot"),L()]),dp=O([P(),P("state"),P("nonce"),P("validRewardTokenNum"),$("rewardMultiplier"),P("rewardPeriodMax"),P("rewardPeriodMin"),P("rewardPeriodExtend"),L("lpMint"),L("lpVault"),Q(cp,5,"rewardInfos"),L("creator"),L(),Q(P(),32,"padding")]),Ju=new Proxy(lp,{get(r,e,t){return e==="decode"?(...n)=>{let o=r.decode(...n);return{...o,version:3,rewardInfos:[{rewardVault:o.rewardVault,totalReward:o.totalReward,perSlotReward:o.perSlotReward,perShareReward:o.perShareReward}]}}:Reflect.get(r,e,t)}}),ec=new Proxy(mp,{get(r,e,t){return e==="decode"?(...n)=>{let o=r.decode(...n);return{...o,version:5,rewardInfos:[{rewardVault:o.rewardVaultA,totalReward:o.totalRewardA,perSlotReward:o.perSlotRewardA,perShareReward:o.perShareRewardA},{rewardVault:o.rewardVaultB,totalReward:o.totalRewardB,perSlotReward:o.perSlotRewardB,perShareReward:o.perShareRewardB}]}}:Reflect.get(r,e,t)}}),jo=new Proxy(dp,{get(r,e,t){return e==="decode"?(...n)=>{let o=r.decode(...n);return{...o,version:6,rewardInfos:o.rewardInfos.map(i=>({...i,rewardType:(Object.entries(vn).find(s=>String(s[1])===i.rewardType.toString())??["Standard SPL"])[0]}))}}:Reflect.get(r,e,t)}}),pp=O([P("isSet"),P("rewardPerSecond"),P("rewardOpenTime"),P("rewardEndTime"),P("rewardType")]),Xs=O([F("instruction"),P("nonce"),Q(pp,5,"rewardTimeInfo")]),Qs=O([F("instruction"),P("rewardReopenTime"),P("rewardEndTime"),P("rewardPerSecond")]),zs=O([F("instruction"),P("isSet"),P("rewardPerSecond"),P("rewardOpenTime"),P("rewardEndTime"),P("rewardType")]),Ew=O([P("state"),L("id"),L("owner"),P("deposited"),Q(P(),1,"rewardDebts")]),Yo=O([P("state"),L("id"),L("owner"),P("deposited"),Q($(),1,"rewardDebts"),P(""),P("voteLockedBalance"),Q(P(),15)]),_w=O([P("state"),L("id"),L("owner"),P("deposited"),Q(P(),2,"rewardDebts")]),tc=O([P("state"),L("id"),L("owner"),P("deposited"),Q($(),2,"rewardDebts"),Q(P(),17)]),nc=O([P(),P("state"),L("id"),L("owner"),P("deposited"),Q($(),5,"rewardDebts"),Q(P(),16)]),gt=O([F("instruction"),P("amount")]),fp=O([L("mint"),L("grantAuthority"),P("baselineVoteWeightScaledFactor"),P("maxExtraLockupVoteWeightScaledFactor"),P("lockupSaturationSecs"),Hu("digitShift"),Q(F(),7,"reserved1"),Q(P(),7,"reserved2")]),oc=O([ke(8),L("governanceProgramId"),L("realm"),L("realmGoverningTokenMint"),L("realmAuthority"),Q(F(),32,"reserved1"),Q(fp,4,"votingMints"),yo("timeOffset"),F("bump"),Q(F(),7,"reserved2"),Q(P(),11,"reserved3")]),yp=O([yo("startTime"),yo("endTime"),F("kind"),Q(F(),15,"reserved")]),bp=O([Q(yp,1,"lockup"),P("amountDeposited_native"),P("amountInitiallyLockedNative"),Ee("isUsed"),Ee("allowClawback"),F("votingMintConfigIdx"),Q(F(),29,"reserved")]),ic=O([ke(8),L("voterAuthority"),L("registrar"),Q(bp,32,"deposits"),F("voterBump"),F("voterWweightRecordBump"),Q(F(),94,"reserved")]);var Xw=de("Raydium_farm_config"),sc=new rc("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),ac=new rc("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1"),uc={3:Ju,5:ec,6:jo},cc={3:Yo,5:tc,6:nc},Hs=r=>[3,4,5,6].indexOf(r)!==-1,js=r=>{let{version:e,rewardInfos:t,rewardTokenAccountsPublicKeys:n}=r,o=`rewardInfo:${JSON.stringify(t)}, rewardAccount:${JSON.stringify(n)}`;return{3:()=>{if(t.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${o}`},5:()=>{if(t.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${o}`},6:()=>{if(!n.length||t.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${o}`}}[e]?.()},vn={"Standard SPL":0,"Option tokens":1},Mt={[Bs.toString()]:3,[Lu.toString()]:4,[xs.toString()]:5,[co.toString()]:6};import{PublicKey as se,SystemProgram as Un,SYSVAR_CLOCK_PUBKEY as Po,SYSVAR_RENT_PUBKEY as Pp,TransactionInstruction as je}from"@solana/web3.js";import hr from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as wp,createAssociatedTokenAccountInstruction as kp,TOKEN_PROGRAM_ID as Bt}from"@solana/spl-token";function Ys(r,e,t){return ee([e.toBuffer(),Buffer.from("registrar","utf8"),t.toBuffer()],r)}function Zs(r,e){return ee([e.toBuffer(),Buffer.from("voting_mint_seed","utf8")],r)}function $s(r,e){return ee([e.toBuffer()],r)}function Js(r,e,t){return ee([e.toBuffer(),Buffer.from("voter","utf8"),t.toBuffer()],r)}function ea(r,e,t){return ee([e.toBuffer(),Buffer.from("voter-weight-record","utf8"),t.toBuffer()],r)}function ta(r,e,t,n){return ee([Buffer.from("governance","utf8"),e.toBuffer(),t.toBuffer(),n.toBuffer()],r)}import It from"bn.js";var Zo=de("Raydium.farm.util");function $o({programId:r,poolId:e,mint:t,type:n}){let{publicKey:o}=ee([e.toBuffer(),t.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],r);return o}function mt({programId:r,poolId:e,owner:t,version:n}){let{publicKey:o}=ee([e.toBuffer(),t.toBuffer(),Buffer.from(n===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],r);return o}var lc=({programId:r,poolId:e})=>ee([e.toBuffer()],r);function mc(r){return{isSet:new It(1),rewardPerSecond:Z(r.perSecond),rewardOpenTime:Z(r.openTime),rewardEndTime:Z(r.endTime),rewardType:Z(vn[r.rewardType])}}function na(r){return Z(r.endTime).sub(Z(r.openTime)).mul(Z(r.perSecond))}function Ao(r){let e=cc[r];return e||Zo.logWithError("invalid version",r),e}function gp(r){let e=uc[r];return e||Zo.logWithError("invalid version",r),e}function Ap(r,e,t,n){if(r.version===3||r.version===5){if(r.lastSlot.gte(new It(t)))return r;let o=new It(t).sub(r.lastSlot);r.lastSlot=new It(t);for(let i of r.rewardInfos){if(e.amount.eq(new It(0)))continue;let s=i.perSlotReward.mul(o);i.perShareReward=i.perShareReward.add(s.mul(new It(10).pow(new It(r.version===3?9:15))).div(e.amount)),i.totalReward=i.totalReward.add(s)}}else if(r.version===6)for(let o of r.rewardInfos){if(o.rewardState.eq(new It(0)))continue;let i=It.min(new It(n),o.rewardEndTime);if(o.rewardOpenTime.gte(i))continue;let a=i.sub(o.rewardLastUpdateTime).mul(o.rewardPerSecond),c=o.totalReward.sub(o.totalRewardEmissioned);c.lt(a)?(a=c,o.rewardLastUpdateTime=o.rewardLastUpdateTime.add(c.div(o.rewardPerSecond))):o.rewardLastUpdateTime=i,!e.amount.eq(new It(0))&&(o.accRewardPerShare=o.accRewardPerShare.add(a.mul(r.rewardMultiplier).div(e.amount)),o.totalRewardEmissioned=o.totalRewardEmissioned.add(a))}return r}async function uk({connection:r,farmPools:e,owner:t,config:n,chainTime:o}){let i=!1,s=!1,a=new It(10),c=[];for(let m of e){let p=Le(m);p.version===6?s=!0:i=!0,c.push({pubkey:p.id,version:p.version,key:"state",poolId:p.id},{pubkey:p.lpVault,version:p.version,key:"lpVault",poolId:p.id}),t&&c.push({pubkey:mt({programId:p.programId,poolId:p.id,owner:t,version:m.version}),version:p.version,key:"ledger",poolId:p.id})}let u={},l=await Se(r,c,n);for(let{pubkey:m,version:p,key:y,poolId:f,accountInfo:b}of l){let g=f.toBase58();if(u[g]={...u[g]},y==="state"){let w=gp(p);(!b||!b.data||b.data.length!==w.span)&&Zo.logWithError(`invalid farm state account info, pools.id, ${m}`),u[g].state=w.decode(b.data)}else if(y==="lpVault")(!b||!b.data||b.data.length!==Zt.span)&&Zo.logWithError(`invalid farm lp vault account info, pools.lpVault, ${m}`),u[g].lpVault=Zt.decode(b.data);else if(y==="ledger"){let w=Ao(p);b&&b.data&&(b.data.length!==w.span&&Zo.logWithError(`invalid farm ledger account info, ledger, ${m}`),u[g].ledger=w.decode(b.data))}}let d=s||i?await r.getSlot():0;for(let m of Object.keys(u))u[m]!==void 0&&(u[m].state=Ap(u[m].state,u[m].lpVault,d,o));for(let[m,{state:p,ledger:y}]of Object.entries(u))if(y){let f=p.version===6?p.rewardMultiplier:p.rewardInfos.length===1?a.pow(new It(9)):a.pow(new It(15)),b=p.rewardInfos.map((g,w)=>{let k=y.rewardDebts[w];return y.deposited.mul(p.version===6?g.accRewardPerShare:g.perShareReward).div(f).sub(k)});u[m].wrapped={...u[m].wrapped,pendingRewards:b}}return u}function ck(r,e=Date.now()){if(r.version===6){let t=r.state.rewardInfos;if(t.every(({rewardOpenTime:n})=>ku(e,n.toNumber(),{unit:"s"})))return"upcoming pool";if(t.every(({rewardEndTime:n})=>hu(e,n.toNumber(),{unit:"s"})))return"closed pool"}else{let t=r.state.rewardInfos.map(({perSlotReward:n})=>n);if(t.length===2){if(String(t[0])==="0"&&String(t[1])!=="0")return"normal fusion pool";if(String(t[0])!=="0"&&String(t[1])!=="0")return"dual fusion pool";if(String(t[0])==="0"&&String(t[1])==="0")return"closed pool"}else if(t.length===1&&String(t[0])==="0")return"closed pool"}}async function oa(r,e,t,n){let o=await r.getAccountInfo(e);if(o===null)throw Error("registrar info check error");let s=oc.decode(o.data).votingMints.findIndex(l=>l.mint.equals(n));if(s===-1)throw Error("find voter mint error");let a=await r.getAccountInfo(t);if(a===null)return{index:s,isInit:!1};let u=ic.decode(a.data).deposits.findIndex(l=>l.isUsed&&l.votingMintConfigIdx===s);return u===-1?{index:s,isInit:!1}:{index:u,isInit:!0}}var hp=de("Raydium_farm_instruction"),Jo={voterStakeRegistryCreateVoter:Buffer.from([6,24,245,52,243,255,148,25]),voterStakeRegistryCreateDepositEntry:Buffer.from([185,131,167,186,159,125,19,67]),voterStakeRegistryDeposit:Buffer.from([242,35,198,137,82,225,242,182]),voterStakeRegistryWithdraw:Buffer.from([183,18,70,156,148,109,161,34]),voterStakeRegistryUpdateVoterWeightRecord:Buffer.from([45,185,3,36,109,190,115,169])};function ei(r){let{version:e,id:t,ledger:n,programId:o,owner:i}=r,s={3:9,5:10}[e];s||hp.logWithError(`invalid farm pool version: ${e}`);let a=Buffer.alloc(Us.span);Us.encode({instruction:s},a);let c=[A({pubkey:t}),A({pubkey:n}),A({pubkey:i,isWritable:!1}),A({pubkey:Un.programId,isWritable:!1}),A({pubkey:Pp,isWritable:!1})];return{instruction:new je({programId:o,keys:c,data:a}),instructionType:V.FarmV3CreateLedger}}function dc(r){let e=Buffer.alloc(Xs.span);Xs.encode({instruction:0,nonce:new hr(r.nonce),rewardTimeInfo:r.rewardInfoConfig},e);let t=[...bs,A({pubkey:r.farmId}),A({pubkey:r.farmAuthority,isWritable:!1}),A({pubkey:r.lpVault}),A({pubkey:r.lpMint,isWritable:!1}),A({pubkey:r.lockVault}),A({pubkey:r.lockMint,isWritable:!1}),A({pubkey:r.lockUserAccount??et}),A({pubkey:r.owner,isWritable:!1,isSigner:!0})];for(let n of r.rewardInfo)t.push(A({pubkey:n.rewardMint,isWritable:!1}),A({pubkey:n.rewardVault}),A({pubkey:n.userRewardToken}));return{instruction:new je({programId:r.programId,keys:t,data:e}),instructionType:V.FarmV6Create}}function pc(r){let e=Buffer.alloc(Gs.span);Gs.encode({instruction:5},e);let t=[A({pubkey:Bt,isWritable:!1}),A({pubkey:r.id}),A({pubkey:r.authority,isWritable:!1}),A({pubkey:r.lpVault,isWritable:!1}),A({pubkey:r.rewardVault}),A({pubkey:r.userRewardToken}),A({pubkey:r.owner,isWritable:!1,isSigner:!0})];return{instruction:new je({programId:r.programId,keys:t,data:e}),instructionType:V.FarmV6CreatorWithdraw}}function Tp(r,e,t,n,o,i,s,a,c,u,l,d,m){let p=O([F("depositEntryIndex"),P("amount")]),y=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:Bt,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:Yi,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({depositEntryIndex:d,amount:m},f);let b=Buffer.from([...Jo.voterStakeRegistryDeposit,...f]);return new je({keys:y,programId:r,data:b})}function Ip(r,e,t,n){let o=O([]),i=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:Un.programId,isSigner:!1,isWritable:!1}],s=Buffer.alloc(o.span);o.encode({},s);let a=Buffer.from([...Jo.voterStakeRegistryUpdateVoterWeightRecord,...s]);return new je({keys:i,programId:r,data:a})}function Bp(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y){let f=O([F("depositEntryIndex"),P("amount")]),b=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:Bt,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:Yi,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);f.encode({depositEntryIndex:p,amount:y},g);let w=Buffer.from([...Jo.voterStakeRegistryWithdraw,...g]);return new je({keys:b,programId:r,data:w})}function xp(r,e,t,n,o,i){let s=O([F("ins")]),a=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:Un.programId,isSigner:!1,isWritable:!1}],c=Buffer.alloc(s.span);return s.encode({ins:23},c),new je({keys:a,programId:r,data:c})}function Sp(r,e,t,n,o,i,s,a){let c=O([F("voterBump"),F("voterWeightRecordBump")]),u=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:Un.programId,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:Yi,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({voterBump:s,voterWeightRecordBump:a},l);let d=Buffer.from([...Jo.voterStakeRegistryCreateVoter,...l]);return new je({keys:u,programId:r,data:d})}function Kp(r,e,t,n,o,i,s,a,c,u,l,d){let m=O([F("depositEntryIndex"),F("kind"),F("option"),P("startTs"),rt("periods"),Ee("allowClawback")]),p=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:Un.programId,isSigner:!1,isWritable:!1},{pubkey:Bt,isSigner:!1,isWritable:!1},{pubkey:wp,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1}],y=Buffer.alloc(m.span);m.encode({depositEntryIndex:a,kind:c,option:u===void 0?0:1,startTs:u,periods:l,allowClawback:d},y);let f=Buffer.from([...Jo.voterStakeRegistryCreateDepositEntry,...y]);return new je({keys:p,programId:r,data:f})}async function Bk({connection:r,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:o,communityTokenMint:i,owner:s,poolId:a,tokenProgram:c}){let u=Ys(n,o,i).publicKey,l=mt({programId:e,poolId:a,owner:s,version:3}),d=await r.getAccountInfo(l);if(d===null)throw Error("user is not staker");let m=Yo.decode(d.data),p=m.deposited.sub(m.voteLockedBalance);if(console.log("amount",p.toString()),p.eq(new hr(0)))throw Error("user do not has new stake amount");let y=Zs(e,a).publicKey,f=$s(e,a).publicKey,{publicKey:b,nonce:g}=Js(n,u,s),w=Y(b,y,c).publicKey,{publicKey:k,nonce:h}=ea(n,u,s),x=ta(t,o,i,s).publicKey,T=[],B=Y(s,y,c).publicKey;if(await r.getAccountInfo(B)===null&&T.push(kp(s,B,s,y)),await r.getAccountInfo(b)===null){let v=xp(t,o,s,i,s,x);T.push(v,Sp(n,u,b,k,s,s,g,h))}let{index:K,isInit:N}=await oa(r,u,b,y);return N||T.push(Kp(n,u,b,w,s,s,y,K,0,void 0,0,!1)),T.push(Tp(n,u,b,w,B,s,l,a,y,f,e,K,p),Ip(n,u,b,k)),T}async function xk({connection:r,programId:e,governanceProgramId:t,voteWeightAddinProgramId:n,realm:o,communityTokenMint:i,owner:s,poolId:a,tokenProgram:c}){let u=Ys(n,o,i).publicKey,l=mt({programId:e,poolId:a,owner:s,version:3}),d=await r.getAccountInfo(l);if(d===null)throw Error("user is not staker");let m=Yo.decode(d.data);if(m.voteLockedBalance.eq(new hr(0)))throw Error("user has vote locked balance = 0");let p=Zs(e,a).publicKey,y=$s(e,a).publicKey,{publicKey:f}=Js(n,u,s),b=Y(f,p,c).publicKey,{publicKey:g}=ea(n,u,s),w=ta(t,o,i,s).publicKey,k=[],{index:h,isInit:x}=await oa(r,u,f,p);if(!x)throw Error("deposit entry index check error");return k.push(Bp(n,u,f,s,w,g,b,Y(s,p,c).publicKey,l,a,p,y,e,h,m.voteLockedBalance)),k}function ia({payer:r,rewardVault:e,userRewardTokenPub:t,farmKeys:n,rewardInfo:o}){let i=Buffer.alloc(Qs.span);Qs.encode({instruction:3,rewardReopenTime:Z(o.openTime),rewardEndTime:Z(o.endTime),rewardPerSecond:Z(o.perSecond)},i);let s=[A({pubkey:Bt,isWritable:!1}),A({pubkey:n.id}),A({pubkey:n.lpVault,isWritable:!1}),A({pubkey:e}),A({pubkey:t}),A({pubkey:r,isWritable:!1,isSigner:!0})];return new je({programId:n.programId,keys:s,data:i})}function ra({payer:r,userRewardTokenPub:e,farmKeys:t,rewardVault:n,rewardInfo:o}){let i=Buffer.alloc(zs.span);zs.encode({instruction:4,isSet:new hr(1),rewardPerSecond:Z(o.perSecond),rewardOpenTime:Z(o.openTime),rewardEndTime:Z(o.endTime),rewardType:Z(vn[o.rewardType])},i);let s=[...bs,A({pubkey:t.id}),A({pubkey:t.authority,isWritable:!1}),A({pubkey:o.mint,isWritable:!1}),A({pubkey:n}),A({pubkey:e}),A({pubkey:r,isWritable:!1,isSigner:!0})];return new je({programId:t.programId,keys:s,data:i})}function Sk(r){let{farmInfo:e,farmKeys:t,version:n,lpAccount:o,rewardAccounts:i,owner:s,instruction:a,amount:c,deposit:u}=r,[l,d]=[new se(e.programId),new se(e.id)],m=mt({programId:l,poolId:d,owner:s,version:n}),p=Buffer.alloc(gt.span);gt.encode({instruction:a,amount:c},p);let y=n===6?[A({pubkey:Bt,isWritable:!1}),...u?[A({pubkey:Un.programId,isWritable:!1})]:[],A({pubkey:d}),A({pubkey:new se(t.authority),isWritable:!1}),A({pubkey:new se(t.lpVault)}),A({pubkey:m}),A({pubkey:s,isWritable:!1,isSigner:!0}),A({pubkey:o})]:[A({pubkey:d}),A({pubkey:new se(t.authority),isWritable:!1}),A({pubkey:m}),A({pubkey:s,isWritable:!1,isSigner:!0}),A({pubkey:o}),A({pubkey:new se(t.lpVault)}),A({pubkey:i[0]}),A({pubkey:new se(t.rewardInfos[0].vault)}),A({pubkey:Po,isWritable:!1}),A({pubkey:Bt,isWritable:!1})];if(n===5)for(let f=1;f<t.rewardInfos.length;f++)y.push(A({pubkey:i[f]})),y.push(A({pubkey:new se(t.rewardInfos[f].vault)}));if(n===6)for(let f=0;f<t.rewardInfos.length;f++)y.push(A({pubkey:new se(t.rewardInfos[f].vault)})),y.push(A({pubkey:i[f]}));return new je({programId:l,keys:y,data:p})}function ti(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s}=r,[a,c]=[new se(e.programId),new se(e.id)],u=mt({programId:a,poolId:c,owner:i,version:6}),l=Buffer.alloc(gt.span);gt.encode({instruction:2,amount:Z(s)},l);let d=[A({pubkey:Bt,isWritable:!1}),A({pubkey:c}),A({pubkey:new se(t.authority),isWritable:!1}),A({pubkey:new se(t.lpVault)}),A({pubkey:u}),A({pubkey:i,isWritable:!1,isSigner:!0}),A({pubkey:n})];for(let m=0;m<t.rewardInfos.length;m++)d.push(A({pubkey:new se(t.rewardInfos[m].vault)})),d.push(A({pubkey:o[m]}));return new je({programId:a,keys:d,data:l})}function ni(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new se(e.programId),new se(e.id)],l=mt({programId:c,poolId:u,owner:i,version:5}),d=Buffer.alloc(gt.span);gt.encode({instruction:12,amount:Z(s)},d);let m=[A({pubkey:u}),A({pubkey:new se(t.authority),isWritable:!1}),A({pubkey:l}),A({pubkey:i,isWritable:!1,isSigner:!0}),A({pubkey:n}),A({pubkey:new se(t.lpVault)}),A({pubkey:o[0]}),A({pubkey:new se(t.rewardInfos[0].vault)}),A({pubkey:Po,isWritable:!1}),A({pubkey:Bt,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)m.push(A({pubkey:o[p]})),m.push(A({pubkey:new se(t.rewardInfos[p].vault)}));if(a)for(let p of a)m.push(A({pubkey:p}));return new je({programId:c,keys:m,data:d})}function fc(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new se(e.programId),new se(e.id)],l=O([F("instruction"),P("amount")]),d=[A({pubkey:u}),A({pubkey:new se(t.authority),isWritable:!1}),A({pubkey:a[0]}),A({pubkey:i,isSigner:!0,isWritable:!1}),A({pubkey:n}),A({pubkey:new se(t.lpVault)}),A({pubkey:o[0]}),A({pubkey:new se(t.rewardInfos[0].vault)}),A({pubkey:Po,isWritable:!1}),A({pubkey:Bt,isWritable:!1}),A({pubkey:o[1]}),A({pubkey:new se(t.rewardInfos[1].vault)})],m=Buffer.alloc(l.span);return l.encode({instruction:2,amount:s},m),new je({keys:d,programId:c,data:m})}function oi(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new se(e.programId),new se(e.id)],l=mt({programId:c,poolId:u,owner:i,version:3}),d=Buffer.alloc(gt.span);gt.encode({instruction:11,amount:Z(s)},d);let m=[A({pubkey:u}),A({pubkey:new se(t.authority),isWritable:!1}),A({pubkey:l}),A({pubkey:i,isWritable:!1,isSigner:!0}),A({pubkey:n}),A({pubkey:new se(t.lpVault)}),A({pubkey:o[0]}),A({pubkey:new se(t.rewardInfos[0].vault)}),A({pubkey:Po,isWritable:!1}),A({pubkey:Bt,isWritable:!1})];if(a)for(let p of a)m.push(A({pubkey:p}));return new je({programId:c,keys:m,data:d})}function yc(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new se(e.programId),new se(e.id)],l=mt({programId:c,poolId:u,owner:i,version:3}),d=Buffer.alloc(gt.span);gt.encode({instruction:10,amount:Z(s)},d);let m=[A({pubkey:u}),A({pubkey:new se(t.authority),isWritable:!1}),A({pubkey:l}),A({pubkey:i,isWritable:!1,isSigner:!0}),A({pubkey:n}),A({pubkey:new se(t.lpVault)}),A({pubkey:o[0]}),A({pubkey:new se(t.rewardInfos[0].vault)}),A({pubkey:Po,isWritable:!1}),A({pubkey:Bt,isWritable:!1})];if(a)for(let p of a)m.push(A({pubkey:p}));return new je({programId:c,keys:m,data:d})}function bc(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new se(e.programId),new se(e.id)],l=mt({programId:c,poolId:u,owner:i,version:5}),d=Buffer.alloc(gt.span);gt.encode({instruction:11,amount:Z(s)},d);let m=[A({pubkey:u}),A({pubkey:new se(t.authority),isWritable:!1}),A({pubkey:l}),A({pubkey:i,isWritable:!1,isSigner:!0}),A({pubkey:n}),A({pubkey:new se(t.lpVault)}),A({pubkey:o[0]}),A({pubkey:new se(t.rewardInfos[0].vault)}),A({pubkey:Po,isWritable:!1}),A({pubkey:Bt,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)m.push(A({pubkey:o[p]})),m.push(A({pubkey:new se(t.rewardInfos[p].vault)}));if(a)for(let p of a)m.push(A({pubkey:p}));return new je({programId:c,keys:m,data:d})}function gc(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s}=r,[a,c]=[new se(e.programId),new se(e.id)],u=mt({programId:a,poolId:c,owner:i,version:6}),l=Buffer.alloc(gt.span);gt.encode({instruction:1,amount:Z(s)},l);let d=[A({pubkey:Bt,isWritable:!1}),A({pubkey:Un.programId,isWritable:!1}),A({pubkey:c}),A({pubkey:new se(t.authority),isWritable:!1}),A({pubkey:new se(t.lpVault)}),A({pubkey:u}),A({pubkey:i,isWritable:!1,isSigner:!0}),A({pubkey:n})];for(let m=0;m<t.rewardInfos.length;m++)d.push(A({pubkey:new se(t.rewardInfos[m].vault)})),d.push(A({pubkey:o[m]}));return new je({programId:a,keys:d,data:l})}var ii=class extends Re{async _getUserRewardInfo({payer:e,rewardInfo:t}){if(t.mint.equals(et)){let n=await Nn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:e,amount:na({...t,openTime:t.openTime.toString(),endTime:t.endTime.toString()})});return{rewardPubKey:n.addresses.newAccount,newInstruction:n}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:t.mint,associatedOnly:!1})}}async create({poolInfo:e,rewardInfos:t,payer:n,programId:o=co,txVersion:i,feePayer:s}){this.checkDisabled(),this.scope.checkOwner();let c={lpMint:new Te(e.lpMint.address),lockInfo:{lockMint:sc,lockVault:ac},version:6,rewardInfos:t,programId:o},u=this.createTxBuilder(s),l=n??this.scope.ownerPubKey,d=We({fromPublicKey:l,programId:c.programId}),m=await this.scope.connection.getMinimumBalanceForRentExemption(jo.span);u.addInstruction({instructions:[Cp.createAccountWithSeed({fromPubkey:l,basePubkey:l,seed:d.seed,newAccountPubkey:d.publicKey,lamports:m,space:jo.span,programId:c.programId})]});let{publicKey:p,nonce:y}=lc({programId:new Te(c.programId),poolId:d.publicKey}),f=$o({programId:c.programId,poolId:d.publicKey,mint:c.lpMint,type:"lpVault"}),b=[],g=[];for(let T of c.rewardInfos){T.openTime>=T.endTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",T.openTime.toString()),isNaN(vn[T.rewardType])&&this.logAndCreateError("rewardType error",T.rewardType),Number(T.perSecond)<=0&&this.logAndCreateError("rewardPerSecond error",T.perSecond),b.push(mc(T));let{rewardPubKey:B,newInstruction:S}=await this._getUserRewardInfo({rewardInfo:T,payer:l});S&&u.addInstruction(S),B||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let I=T.mint.equals(et)?new Te(Je.address):T.mint;g.push({rewardMint:I,rewardVault:$o({programId:c.programId,poolId:d.publicKey,mint:I,type:"rewardVault"}),userRewardToken:B})}let{account:w,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({mint:new Te(c.lockInfo.lockMint),owner:this.scope.ownerPubKey,skipCloseAccount:!1,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:!1});k&&u.addInstruction(k),w||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let{instruction:h,instructionType:x}=dc({farmId:d.publicKey,owner:this.scope.ownerPubKey,farmAuthority:p,lpVault:f,lpMint:c.lpMint,lockVault:c.lockInfo.lockVault,lockMint:c.lockInfo.lockMint,lockUserAccount:w,programId:c.programId,rewardInfo:g,rewardInfoConfig:b,nonce:y});return u.addInstruction({instructions:[h],instructionTypes:[x]}).versionBuild({txVersion:i,extInfo:{farmId:d.publicKey,farmAuthority:p,lpVault:f,lockUserAccount:w,nonce:y}})}async restartReward({farmInfo:e,payer:t,newRewardInfo:n,txVersion:o,feePayer:i}){let s=Mt[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Le((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.openTime>=n.endTime&&this.logAndCreateError("start time error","newRewardInfo",n);let u=t||this.scope.ownerPubKey,l=n.mint.equals(et)?new Te(Je.address):n.mint,d=c.rewardInfos.findIndex(g=>new Te(g.mint.address).equals(l)),m=a.rewardInfos[d];m||this.logAndCreateError("configuration does not exist","rewardMint",l);let p=m.vault??et,y=this.createTxBuilder(i),{rewardPubKey:f,newInstruction:b}=await this._getUserRewardInfo({rewardInfo:n,payer:u});return b&&y.addInstruction(b),f||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts),y.addInstruction({instructions:[ia({payer:this.scope.ownerPubKey,rewardVault:p,userRewardTokenPub:f,farmKeys:c,rewardInfo:n})],instructionTypes:[V.FarmV6Restart]}).versionBuild({txVersion:o})}async restartRewards({farmInfo:e,payer:t,newRewardInfos:n,txVersion:o,feePayer:i}){let s=Mt[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=Le((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.forEach(d=>{d.openTime>=d.endTime&&this.logAndCreateError("start time error","newRewardInfo",d)});let u=t||this.scope.ownerPubKey,l=this.createTxBuilder(i);for(let d of n){let m=d.mint.equals(et)?new Te(Je.address):d.mint,p=c.rewardInfos.findIndex(k=>new Te(k.mint.address).equals(m)),y=a.rewardInfos[p];y||this.logAndCreateError("configuration does not exist","rewardMint",m);let f=y.vault??et,{rewardPubKey:b,newInstruction:g}=await this._getUserRewardInfo({rewardInfo:d,payer:u});g&&l.addInstruction(g),b||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let w=ia({payer:this.scope.ownerPubKey,rewardVault:f,userRewardTokenPub:b,farmKeys:c,rewardInfo:d});l.addInstruction({instructions:[w],instructionTypes:[V.FarmV6Restart]})}return l.versionBuild({txVersion:o})}async addNewRewardToken(e){let{txVersion:t,farmInfo:n,newRewardInfo:o,payer:i,feePayer:s}=e,a=Mt[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=Le((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=i??this.scope.ownerPubKey,l=this.createTxBuilder(s),d=o.mint.equals(et)?new Te(Je.address):o.mint,m=$o({programId:new Te(n.programId),poolId:new Te(n.id),mint:d,type:"rewardVault"}),{rewardPubKey:p,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:o,payer:u});return y&&l.addInstruction(y),p||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts),o.mint=d,l.addInstruction({instructions:[ra({payer:this.scope.ownerPubKey,userRewardTokenPub:p,farmKeys:c,rewardVault:m,rewardInfo:o})],instructionTypes:[V.FarmV6CreatorAddReward]}).versionBuild({txVersion:t})}async addNewRewardsToken(e){let{txVersion:t,farmInfo:n,newRewardInfos:o,payer:i,feePayer:s}=e,a=Mt[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=Le((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=i??this.scope.ownerPubKey,l=this.createTxBuilder(s);for(let d of o){let m=d.mint.equals(et)?new Te(Je.address):d.mint,p=$o({programId:new Te(n.programId),poolId:new Te(n.id),mint:m,type:"rewardVault"}),{rewardPubKey:y,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:d,payer:u});f&&l.addInstruction(f),y||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let b=ra({payer:this.scope.ownerPubKey,userRewardTokenPub:y,farmKeys:c,rewardVault:p,rewardInfo:{...d,mint:m}});l.addInstruction({instructions:[b],instructionTypes:[V.FarmV6CreatorAddReward]})}return l.versionBuild({txVersion:t})}async deposit(e){let{txVersion:t,farmInfo:n,amount:o,feePayer:i,useSOLBalance:s,associatedOnly:a=!0,checkCreateATAOwner:c=!1,userAuxiliaryLedgers:u,computeBudgetConfig:l,txTipConfig:d}=e;this.scope.availability.addFarm===!1&&this.logAndCreateError("farm deposit feature disabled in your region");let{rewardInfos:m,programId:p}=n,y=Mt[p];y===4&&this.logAndCreateError("V4 has suspended deposits:",n.programId),Hs(y)||this.logAndCreateError("invalid farm program:",n.programId);let[f,b]=[new Te(n.programId),new Te(n.id)],g=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],w=mt({programId:f,poolId:b,owner:this.scope.ownerPubKey,version:y}),k=this.createTxBuilder(i);k.addCustomComputeBudget(l),k.addTipInstruction(d);let h={};for(let D of this.scope.account.tokenAccounts)if(a){let q=Y(this.scope.ownerPubKey,D.mint,D.programId).publicKey;D.publicKey&&q.equals(D.publicKey)&&(h[D.mint.toString()]=D.publicKey)}else h[D.mint.toString()]=D.publicKey;let x=g.lpMint,T=h[x.address];T||this.logAndCreateError("you don't have any lp","lp zero",h);let B=[];for(let D of m){let q=s&&D.mint.address===j.toString(),G=h[D.mint.address];if(!G){let{account:ne,instructionParams:ie}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:D.mint.programId,mint:new Te(D.mint.address),notUseTokenAccount:q,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!q,associatedOnly:q?!1:a,checkCreateATAOwner:c});G=ne,ie&&k.addInstruction(ie)}h[D.mint.address]=G,B.push(G)}let S,I=await this.scope.connection.getAccountInfo(w);if(I&&(S=Ao(y).decode(I.data)),n.programId!==co.toString()&&!S){let{instruction:D,instructionType:q}=ei({id:b,programId:f,version:y,ledger:w,owner:this.scope.ownerPubKey});k.addInstruction({instructions:[D],instructionTypes:[q]})}let K=js({version:y,rewardInfos:m,rewardTokenAccountsPublicKeys:B});K&&this.logAndCreateError(K);let N={amount:Z(o),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:g,lpAccount:T,rewardAccounts:B,userAuxiliaryLedgers:u?.map(D=>new Te(D))},v=y===6?gc(N):y===5?bc(N):yc(N),_={3:V.FarmV3Deposit,5:V.FarmV5Deposit,6:V.FarmV6Deposit};return k.addInstruction({instructions:[v],instructionTypes:[_[y]]}).versionBuild({txVersion:t})}async withdraw(e){let{txVersion:t,farmInfo:n,amount:o,deposited:i,useSOLBalance:s,feePayer:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,userAuxiliaryLedgers:l,computeBudgetConfig:d,txTipConfig:m}=e,{rewardInfos:p}=n;this.scope.availability.removeFarm===!1&&this.logAndCreateError("farm withdraw feature disabled in your region");let y=Mt[n.programId];Hs(y)||this.logAndCreateError("invalid farm program:",n.programId);let f=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],b=this.createTxBuilder(a);b.addCustomComputeBudget(d),b.addTipInstruction(m);let g={};for(let K of this.scope.account.tokenAccounts)if(c){let N=Y(this.scope.ownerPubKey,K.mint).publicKey;K.publicKey&&N.equals(K.publicKey)&&(g[K.mint.toString()]=K.publicKey)}else g[K.mint.toString()]=K.publicKey;if(y!==4){let K=mt({programId:new Te(n.programId),poolId:new Te(n.id),owner:this.scope.ownerPubKey,version:y}),N=await this.scope.connection.getAccountInfo(K);if(N)Ao(y).decode(N.data).deposited.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else if(y!==6){let{instruction:v,instructionType:_}=ei({id:new Te(f.id),programId:new Te(f.programId),version:y,ledger:K,owner:this.scope.ownerPubKey});b.addInstruction({instructions:[v],instructionTypes:[_]})}}i&&i.isZero()&&!(l||[]).length&&this.logAndCreateError("no deposited lp",{farmId:n.id});let w=f.lpMint.address,k=s&&w===j.toString(),h=g[w.toString()];if(!h){let{account:K,instructionParams:N}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:f.lpMint.programId,mint:new Te(w),notUseTokenAccount:k,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:k?!1:c,checkCreateATAOwner:u});h=K,N&&b.addInstruction(N)}g[w.toString()]=h;let x=[];for(let K of p){let N=s&&K.mint.address===j.toString(),v=g[K.mint.address];if(!v){let{account:_,instructionParams:D}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:K.mint.programId,mint:new Te(K.mint.address),notUseTokenAccount:N,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!N,associatedOnly:N?!1:c,checkCreateATAOwner:u});v=_,D&&b.addInstruction(D)}g[K.mint.address]=v,x.push(v)}let T=js({version:y,rewardInfos:p,rewardTokenAccountsPublicKeys:x});T&&this.logAndCreateError(T);let B={amount:Z(o),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:f,lpAccount:h,rewardAccounts:x,userAuxiliaryLedgers:l?.map(K=>new Te(K))},S=y===6?ti(B):y===5?ni(B):y===4?fc(B):oi(B),I={3:V.FarmV3Withdraw,4:V.FarmV4Withdraw,5:V.FarmV5Withdraw,6:V.FarmV6Withdraw};return b.addInstruction({instructions:[S],instructionTypes:[I[y]]}).versionBuild({txVersion:t})}async withdrawFarmReward({farmInfo:e,withdrawMint:t,txVersion:n,computeBudgetConfig:o,txTipConfig:i,feePayer:s}){this.scope.checkOwner();let a=Le((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c=Mt[e.programId];c!==6&&this.logAndCreateError("invalid farm version",c);let u=a.rewardInfos.find(f=>ct(f.mint.address).equals(ct(t)));u||this.logAndCreateError("withdraw mint error","rewardInfos",e);let l=u?.vault??et,d=this.createTxBuilder(s),m;if(t.equals(et)||t.equals(Te.default)){let f=await Nn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:na({...u,openTime:u.openTime,endTime:u.endTime,perSecond:new C(u.perSecond).mul(10**u.mint.decimals).toString()})});m=f.addresses.newAccount,d.addInstruction(f)}else{let f=await this.scope.account.getCreatedTokenAccount({mint:t});f===null?(m=await this.scope.account.getAssociatedTokenAccount(t),d.addInstruction({instructions:[Lp(this.scope.ownerPubKey,m,this.scope.ownerPubKey,t)],instructionTypes:[V.CreateATA]})):m=f}let{instruction:p,instructionType:y}=pc({programId:a.programId,id:a.id,authority:a.authority,lpVault:a.lpVault,rewardVault:l,userRewardToken:m,owner:this.scope.ownerPubKey});return d.addCustomComputeBudget(o),d.addTipInstruction(i),d.addInstruction({instructions:[p],instructionTypes:[y]}).versionBuild({txVersion:n})}async harvestAllRewards(e){let{farmInfoList:t,useSOLBalance:n,feePayer:o,associatedOnly:i=!0,checkCreateATAOwner:s=!1,userAuxiliaryLedgers:a,txVersion:c,computeBudgetConfig:u}=e,l=this.createTxBuilder(o),d={};for(let y of this.scope.account.tokenAccounts)if(i){let f=Y(this.scope.ownerPubKey,y.mint).publicKey;y.publicKey&&f.equals(y.publicKey)&&(d[y.mint.toString()]=y.publicKey)}else d[y.mint.toString()]=y.publicKey;let p=(await this.scope.api.fetchFarmKeysById({ids:Object.values(t).map(y=>y.id).join(",")})).reduce((y,f)=>({...y,[f.id]:f}),{});for(let y of Object.values(t)){let{programId:f,lpMint:b,rewardInfos:g,id:w}=y,k=Mt[f],h=b.address,x=n&&h===j.toString(),T=d[h];if(!T){let{account:v,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:b.programId,mint:new Te(h),notUseTokenAccount:x,createInfo:{payer:o||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:x?!1:i,checkCreateATAOwner:s});T=v,_&&l.addInstruction(_)}d[h.toString()]=T;let B=[];for(let v of g){let _=n&&v.mint.address===j.toString(),D=d[v.mint.address];if(!D){let{account:q,instructionParams:G}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:v.mint.programId,mint:new Te(v.mint.address),notUseTokenAccount:_,createInfo:{payer:o||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!_,associatedOnly:_?!1:i,checkCreateATAOwner:s});D=q,G&&l.addInstruction(G)}d[v.mint.address]=D,B.push(D)}let S=p[w],I={amount:Tt,owner:this.scope.ownerPubKey,farmInfo:y,farmKeys:S,lpAccount:T,rewardAccounts:B,userAuxiliaryLedgers:a?.map(v=>new Te(v))},K=k===6?ti(I):k===5?ni(I):oi(I),N={3:V.FarmV3Withdraw,5:V.FarmV5Withdraw,6:V.FarmV6Withdraw};l.addInstruction({instructions:[K],instructionTypes:[N[k]]})}return c===1?l.sizeCheckBuild({computeBudgetConfig:u}):l.sizeCheckBuildV0({computeBudgetConfig:u})}};import{PublicKey as Ue}from"@solana/web3.js";import{AccountLayout as Tf,NATIVE_MINT as Er,TOKEN_PROGRAM_ID as En}from"@solana/spl-token";import{Keypair as Cr,PublicKey as U,SystemProgram as wn,TransactionInstruction as st}from"@solana/web3.js";import fa from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as fi,TOKEN_2022_PROGRAM_ID as Fe,TOKEN_PROGRAM_ID as Ie}from"@solana/spl-token";import Up from"bn.js";import Et from"bn.js";var ye=new Et(0),Rt=new Et(1),gn=new Et(-1),Xe=new Et(1).shln(64),Tr=new Et(1).shln(128),ri=Xe.sub(Rt),si=64,Ac=Tr.subn(1),dt=-443636,At=-dt,_t=new Et("4295048016"),Ft=new Et("79226673521066979257578248091"),Ir=new Et("4295048017"),Br=new Et("79226673521066979257578248090"),Pc=16,wc="59543866431248",kc="184467440737095516",hc="15793534762490258745",xr=new Et(10).pow(new Et(6)),Rp=(n=>(n[n.rate_500=500]="rate_500",n[n.rate_3000=3e3]="rate_3000",n[n.rate_10000=1e4]="rate_10000",n))(Rp||{}),ih={[500]:10,[3e3]:60,[1e4]:200},rh={version:6,liquidity:ye,tickCurrent:0,feeGrowthGlobalX64A:ye,feeGrowthGlobalX64B:ye,protocolFeesTokenA:ye,protocolFeesTokenB:ye,swapInAmountTokenA:ye,swapOutAmountTokenB:ye,swapInAmountTokenB:ye,swapOutAmountTokenA:ye,tickArrayBitmap:[],rewardInfos:[],day:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},week:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},month:{volume:0,volumeFee:0,feeA:0,feeB:0,feeApr:0,rewardApr:{A:0,B:0,C:0},apr:0,priceMax:0,priceMin:0},tvl:0},Tc={tvl:0,volumeQuote:0,mintAmountA:0,mintAmountB:0,rewardDefaultInfos:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,day:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},week:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},month:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},pooltype:[]},sh=new Et("18446744073700000000");import le from"bn.js";function Sr(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r,!1),new Uint8Array(e)}function uh(r){let e=new ArrayBuffer(2);return new DataView(e).setInt16(0,r,!1),new Uint8Array(e)}function ch(r){let e=new ArrayBuffer(4);return new DataView(e).setUint32(0,r,!1),new Uint8Array(e)}function Kr(r){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,r,!1),new Uint8Array(e)}function sa(r,e){let t=0;for(let n=r-1;n>=0&&!e.testn(n);n--)t++;return t}function aa(r,e){let t=0;for(let n=0;n<r&&!e.testn(n);n++)t++;return t}function ai(r,e){for(let t=0;t<r;t++)if(e.testn(t))return!1;return!0}function Ic(r,e){return ai(r,e)?null:sa(r,e)}function Bc(r,e){return ai(r,e)?null:aa(r,e)}var Np=Buffer.from("amm_config","utf8"),Op=Buffer.from("pool","utf8"),vp=Buffer.from("pool_vault","utf8"),Mp=Buffer.from("pool_reward_vault","utf8"),xc=Buffer.from("position","utf8"),Ep=Buffer.from("tick_array","utf8"),_p=Buffer.from("operation","utf8"),Fp=Buffer.from("pool_tick_array_bitmap_extension","utf8"),Vp=Buffer.from("observation","utf8");function ph(r,e){return ee([Np,Sr(e)],r)}function Sc(r,e,t,n){return ee([Op,e.toBuffer(),t.toBuffer(),n.toBuffer()],r)}function ua(r,e,t){return ee([vp,e.toBuffer(),t.toBuffer()],r)}function Kc(r,e,t){return ee([Mp,e.toBuffer(),t.toBuffer()],r)}function be(r,e,t){return ee([Ep,e.toBuffer(),Kr(t)],r)}function $t(r,e,t,n){return ee([xc,e.toBuffer(),Kr(t),Kr(n)],r)}function Pt(r,e){return ee([xc,e.toBuffer()],r)}function An(r){return ee([Buffer.from("metadata","utf8"),Ut.toBuffer(),r.toBuffer()],Ut)}function ui(r){return ee([_p],r)}function De(r,e){return ee([Fp,e.toBuffer()],r)}function Cc(r,e){return ee([Vp,e.toBuffer()],r)}var Lc=Buffer.from("locked_position","utf8");function ca(r,e){return ee([Lc,e.toBuffer()],r)}function ci(r,e){return ee([Lc,e.toBuffer()],r)}var Wp=Buffer.from("support_mint","utf8");function la(r,e){return ee([Wp,e.toBuffer()],r)}import{PublicKey as Nt}from"@solana/web3.js";import{TOKEN_2022_PROGRAM_ID as Rc}from"@solana/spl-token";import Oe from"bn.js";import sn from"bn.js";var li=class{static getfeeGrowthInside(e,t,n){let o=new sn(0),i=new sn(0);e.tickCurrent>=t.tick?(o=t.feeGrowthOutsideX64A,i=t.feeGrowthOutsideX64B):(o=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),i=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new sn(0),a=new sn(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let c=ae.wrappingSubU128(ae.wrappingSubU128(e.feeGrowthGlobalX64A,o),s),u=ae.wrappingSubU128(ae.wrappingSubU128(e.feeGrowthGlobalX64B,i),a);return{feeGrowthInsideX64A:c,feeGrowthInsideBX64:u}}static GetPositionFees(e,t,n,o){let{feeGrowthInsideX64A:i,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,o),a=ae.mulDivFloor(ae.wrappingSubU128(i,t.feeGrowthInsideLastX64A),t.liquidity,Xe),c=t.tokenFeesOwedA.add(a),u=ae.mulDivFloor(ae.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,Xe),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,o){let{feeGrowthInsideX64A:i,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,o),a=ae.mulDivFloor(ae.wrappingSubU128(i,t.feeGrowthInsideLastX64A),t.liquidity,Xe),c=t.tokenFeesOwedA.add(a),u=ae.mulDivFloor(ae.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,Xe),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,o){let i=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,o,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=ae.wrappingSubU128(c,u.growthInsideLastX64),d=ae.mulDivFloor(l,t.liquidity,Xe),m=u.rewardAmountOwed.add(d);i.push(m)}return i}static GetPositionRewards(e,t,n,o){let i=[],s=this.getRewardGrowthInside(e.tickCurrent,n,o,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=ae.wrappingSubU128(c,u.growthInsideLastX64),d=ae.mulDivFloor(l,t.liquidity,Xe),m=u.rewardAmountOwed.add(d);i.push(m)}return i}static getRewardGrowthInside(e,t,n,o){let i=[];for(let s=0;s<o.length;s++){let a=new sn(0);t.liquidityGross.eqn(0)?a=o[s].rewardGrowthGlobalX64:e<t.tick?a=o[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new sn(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=o[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),i.push(ae.wrappingSubU128(ae.wrappingSubU128(o[s].rewardGrowthGlobalX64,a),c))}return i}static getRewardGrowthInsideV2(e,t,n,o){let i=[];for(let s=0;s<o.length;s++){let a=new sn(0);t.liquidityGross.eqn(0)?a=o[s].rewardGrowthGlobalX64:e<t.tick?a=o[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new sn(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=o[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),i.push(ae.wrappingSubU128(ae.wrappingSubU128(o[s].rewardGrowthGlobalX64,a),c))}return i}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:o,add:i,epochInfo:s}){let a=te.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),c=te.getSqrtPriceX64FromTick(t.tickLower),u=te.getSqrtPriceX64FromTick(t.tickUpper),l=i?1+o:1-o,d=ge.getAmountsFromLiquidity(a,c,u,n,i),[m,p]=[we(d.amountA,e.mintA.extensions?.feeConfig,s,!0),we(d.amountB,e.mintB.extensions?.feeConfig,s,!0)],[y,f]=[we(new sn(new C(d.amountA.toString()).mul(l).toFixed(0)),e.mintA.extensions?.feeConfig,s,!0),we(new sn(new C(d.amountB.toString()).mul(l).toFixed(0)),e.mintB.extensions?.feeConfig,s,!0)];return{liquidity:n,amountA:m,amountB:p,amountSlippageA:y,amountSlippageB:f,expirationTime:Qt(m.expirationTime,p.expirationTime)}}};var Dp=15,Ae=class{static async getTickArrays(e,t,n,o,i,s,a){let c=[],u=H.getTickArrayStartIndexByTick(o,i),l=H.getInitializedTickArrayInRange(s,a,i,u,Math.floor(Dp/2));for(let p=0;p<l.length;p++){let{publicKey:y}=be(t,n,l[p]);c.push(y)}let d=(await Wt(e,c)).map(p=>p!==null?mi.decode(p.data):null),m={};for(let p=0;p<c.length;p++){let y=d[p];y!==null&&(m[y.startTickIndex]={...y,address:c[p]})}return m}static nextInitializedTick(e,t,n,o,i,s){let{initializedTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}=this.nextInitializedTickInOneArray(e,t,n,o,i,s);for(;a==null||a.liquidityGross.lten(0);){if(u=H.getNextTickArrayStartIndex(u,i,s),this.checkIsValidStartIndex(u,i))throw new Error("No enough initialized tickArray");let l=n[u];if(l===void 0)continue;let{nextTick:d,tickArrayAddress:m,tickArrayStartTickIndex:p}=this.firstInitializedTickInOneArray(e,t,l,s);[a,c,u]=[d,m,p]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}}static nextInitializedTickArray(e,t,n,o,i){let s=Math.floor(e/Ae.tickCount(t)),a=n?H.searchLowBitFromStart(o,i,s-1,1,t):H.searchHightBitFromStart(o,i,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,o){let i;if(o){let a=Ye-1;for(;a>=0;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){i=c;break}a=a-1}}else{let a=0;for(;a<Ye;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){i=c;break}a=a+1}}let{publicKey:s}=be(e,t,n.startTickIndex);return{nextTick:i,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,o,i,s){let a=H.getTickArrayStartIndexByTick(o,i),c=Math.floor((o-a)/i),u=n[a];if(u==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;c>=0;){let m=u.ticks[c];if(m.liquidityGross.gtn(0)){l=m;break}c=c-1}else for(c=c+1;c<Ye;){let m=u.ticks[c];if(m.liquidityGross.gtn(0)){l=m;break}c=c+1}let{publicKey:d}=be(e,t,a);return{initializedTick:l,tickArrayAddress:d,tickArrayStartTickIndex:u.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(H.checkIsOutOfBoundary(e)){if(e>At)return!1;let n=H.getTickArrayStartIndexByTick(dt,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return Ye*e}};var ma=14,Pn=class{static maxTickInTickarrayBitmap(e){return e*Ye*Gn}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),o=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(o+=1);let i=n*o;return e<0?{minValue:-i,maxValue:-i+n}:{minValue:i,maxValue:i+n}}static nextInitializedTickArrayStartIndex(e,t,n,o){if(!Ae.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let i=this.maxTickInTickarrayBitmap(n),s=o?t-Ae.tickCount(n):t+Ae.tickCount(n);if(s<-i||s>=i)return{isInit:!1,tickIndex:t};let a=n*Ye,c=s/a+512;s<0&&s%a!=0&&c--;let u=Math.abs(c);if(o){let l=e.shln(1024-u-1),d=Ic(1024,l);if(d!==null){let m=(u-d-512)*a;return{isInit:!0,tickIndex:m}}else return{isInit:!1,tickIndex:-i}}else{let l=e.shrn(u),d=Bc(1024,l);if(d!==null){let m=(u+d-512)*a;return{isInit:!0,tickIndex:m}}else return{isInit:!1,tickIndex:i-Ae.tickCount(n)}}}},di=class{static getBitmapOffset(e,t){if(!Ae.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=Pn.maxTickInTickarrayBitmap(t),o=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&o--,o}static getBitmap(e,t,n){let o=this.getBitmapOffset(e,t);return e<0?{offset:o,tickarrayBitmap:n.negativeTickArrayBitmap[o]}:{offset:o,tickarrayBitmap:n.positiveTickArrayBitmap[o]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:o}=this.extensionTickBoundary(t);if(e>=o&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=Pn.maxTickInTickarrayBitmap(e),n=-t;if(At<=t)throw Error(`extensionTickBoundary check error: ${At}, ${t}`);if(n<=dt)throw Error(`extensionTickBoundary check error: ${n}, ${dt}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:o}=this.getBitmap(e,t,n),i=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:H.mergeTickArrayBitmap(o).testn(i),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,o){let i=Ae.tickCount(t),s=n?e-i:e+i,{tickarrayBitmap:a}=this.getBitmap(s,t,o);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,o){let{minValue:i,maxValue:s}=Pn.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(o){let c=H.mergeTickArrayBitmap(e).shln(Gn-1-a),u=ai(512,c)?null:sa(512,c);if(u!==null){let l=t-u*Ae.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:i}}else{let c=H.mergeTickArrayBitmap(e).shrn(a),u=ai(512,c)?null:aa(512,c);if(u!==null){let l=t+u*Ae.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-Ae.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%Pn.maxTickInTickarrayBitmap(t),o=Math.floor(n/Ae.tickCount(t));return e<0&&n!=0&&(o=Gn-o),o}};var Ce=class{static getOutputAmountAndRemainAccounts(e,t,n,o,i,s=!1){let a=n.toBase58()===e.mintA.address,c=[],{isExist:u,startIndex:l,nextAccountMeta:d}=this.getFirstInitializedTickArray(e,a);if(!u||l===void 0||!d)throw new Error("Invalid tick array");c.push(d);let{allTrade:m,amountCalculated:p,accounts:y,sqrtPriceX64:f,feeAmount:b}=Xn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,a,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,o,l,i,s);return c.push(...y),{allTrade:m,expectedAmountOut:p.mul(gn),remainingAccounts:c,executionPrice:f,feeAmount:b}}static getInputAmountAndRemainAccounts(e,t,n,o,i){let s=n.toBase58()===e.mintB.address,a=[],{isExist:c,startIndex:u,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!c||u===void 0||!l)throw new Error("Invalid tick array");try{let f=this.preInitializedTickArrayStartIndex(e,s);if(f.isExist){let{publicKey:b}=be(e.programId,e.id,f.nextStartIndex);a.push(b)}}catch{}a.push(l);let{amountCalculated:d,accounts:m,sqrtPriceX64:p,feeAmount:y}=Xn.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,o.mul(gn),u,i);return a.push(...m),{expectedAmountIn:d,remainingAccounts:a,executionPrice:p,feeAmount:y}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:o}=Ce.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?di.checkTickArrayIsInit(Ae.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):H.checkTickArrayIsInitialized(H.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=be(e.programId,e.id,o);return{isExist:!0,startIndex:o,nextAccountMeta:a}}let{isExist:i,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,Ae.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(i){let{publicKey:a}=be(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/Ae.tickCount(e.tickSpacing)),o=t?H.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):H.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return o.length>0?{isExist:!0,nextStartIndex:o[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=Ae.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:o,tickIndex:i}=Pn.nextInitializedTickArrayStartIndex(H.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(o)return{isExist:!0,nextStartIndex:i};t=i;let{isInit:s,tickIndex:a}=di.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<dt||t>At)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:o,rewardInfos:i}){let s=[];for(let a=0;a<i.length;a++){let c=i[a],u=t.rewardDefaultInfos[a]?.mint.programId??(await e.getAccountInfo(c.tokenMint))?.owner;if(u===void 0)throw Error("get new reward mint info error");let l={...c,perSecond:ae.x64ToDecimal(c.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new Nt(u)};if(l.tokenMint.equals(Nt.default))continue;if(n<=l.openTime.toNumber()||o.eq(ye)){s.push(l);continue}let d=new Oe(Math.min(l.endTime.toNumber(),n)),m=d.sub(l.lastUpdateTime),p=ae.mulDivFloor(m,l.emissionsPerSecondX64,o),y=l.rewardGrowthGlobalX64.add(p),f=ae.mulDivFloor(m,l.emissionsPerSecondX64,Xe),b=l.rewardTotalEmissioned.add(f);s.push({...l,rewardGrowthGlobalX64:y,rewardTotalEmissioned:b,lastUpdateTime:d})}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:o}=this.tickRange(e);for(let i of t){let s=H.getTickArrayStartIndexByTick(i,e);if(s>=n||s<o)return!0}return!1}static tickRange(e){let t=Pn.maxTickInTickarrayBitmap(e),n=-t;return t>At&&(t=Ae.getArrayStartIndex(At,e)+Ae.tickCount(e)),n<dt&&(n=Ae.getArrayStartIndex(dt,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!Ae.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/Ae.tickCount(t)*Gn}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let o=await Se(e,t.map(s=>({pubkey:s})),{batchRequest:n}),i={};for(let s of o)s.accountInfo!==null&&(i[s.pubkey.toString()]=Oc.decode(s.accountInfo.data));return i}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let o={},i=[];for(let c of t){let u=H.getTickArrayStartIndexByTick(c.tickCurrent,c.tickSpacing),l=H.getInitializedTickArrayInRange(c.tickArrayBitmap,c.exBitmapInfo,c.tickSpacing,u,7);for(let d of l){let{publicKey:m}=be(c.programId,c.id,d);i.push({pubkey:m}),o[m.toString()]=c.id}}let s=await Se(e,i,{batchRequest:n}),a={};for(let c of s){if(!c.accountInfo)continue;let u=o[c.pubkey.toString()];if(!u)continue;a[u.toString()]===void 0&&(a[u.toString()]={});let l=mi.decode(c.accountInfo.data);a[u.toString()][l.startTickIndex]={...l,address:c.pubkey}}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:o=!1,updateOwnerRewardAndFee:i=!0}){let s=[];for(let a=0;a<e.length;a++){let c=e[a];c!==null&&(s.find(u=>u.equals(c.state.programId))||s.push(c.state.programId))}if(n){let a=n.tokenAccounts.map(d=>d.accountInfo.mint),c=[];for(let d of a)for(let m of s)c.push(Pt(m,d).publicKey);let u=await Wt(t,c,{batchRequest:o}),l={};for(let d of u){if(d===null)continue;let m=pi.decode(d.data),p=m.poolId.toString(),y=e.find(B=>B.state.id.toBase58()===p);if(y===void 0)continue;let f=y.state,b=H._getTickPriceLegacy({poolInfo:f,tick:m.tickLower,baseIn:!0}),g=H._getTickPriceLegacy({poolInfo:f,tick:m.tickUpper,baseIn:!0}),{amountA:w,amountB:k}=ge.getAmountsFromLiquidity(f.sqrtPriceX64,b.tickSqrtPriceX64,g.tickSqrtPriceX64,m.liquidity,!1),h=1/(1-Math.sqrt(Math.sqrt(b.price.div(g.price).toNumber())));y.positionAccount=[...y.positionAccount??[],{poolId:m.poolId,nftMint:m.nftMint,priceLower:b.price,priceUpper:g.price,amountA:w,amountB:k,tickLower:m.tickLower,tickUpper:m.tickUpper,liquidity:m.liquidity,feeGrowthInsideLastX64A:m.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:m.feeGrowthInsideLastX64B,tokenFeesOwedA:m.tokenFeesOwedA,tokenFeesOwedB:m.tokenFeesOwedB,rewardInfos:m.rewardInfos.map(B=>({...B,pendingReward:new Oe(0)})),leverage:h,tokenFeeAmountA:new Oe(0),tokenFeeAmountB:new Oe(0)}];let x=await H.getTickArrayAddressByTick(y.state.programId,m.poolId,m.tickLower,y.state.tickSpacing),T=await H.getTickArrayAddressByTick(y.state.programId,m.poolId,m.tickUpper,y.state.tickSpacing);l[`${y.state.programId.toString()}-${m.poolId.toString()}-${m.tickLower}`]=x,l[`${y.state.programId.toString()}-${m.poolId.toString()}-${m.tickUpper}`]=T}if(i){let d=Object.values(l),m=await Wt(t,d,{batchRequest:o}),p={};for(let y=0;y<d.length;y++){let f=m[y];if(f===null)continue;let b=d[y].toString();p[b]=mi.decode(f.data)}for(let{state:y,positionAccount:f}of e)if(!!f)for(let b of f){let g=`${y.programId.toString()}-${y.id.toString()}-${b.tickLower}`,w=`${y.programId.toString()}-${y.id.toString()}-${b.tickUpper}`,k=p[l[g].toString()],h=p[l[w].toString()],x=k.ticks[H.getTickOffsetInArray(b.tickLower,y.tickSpacing)],T=h.ticks[H.getTickOffsetInArray(b.tickUpper,y.tickSpacing)],{tokenFeeAmountA:B,tokenFeeAmountB:S}=await li.GetPositionFees(y,b,x,T),I=await li.GetPositionRewards(y,b,x,T);b.tokenFeeAmountA=B.gte(new Oe(0))?B:new Oe(0),b.tokenFeeAmountB=S.gte(new Oe(0))?S:new Oe(0);for(let K=0;K<I.length;K++)b.rewardInfos[K].pendingReward=I[K].gte(new Oe(0))?I[K]:new Oe(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:o,amountIn:i,slippage:s,priceLimit:a=new C(0),catchLiquidityInsufficient:c=!1}){let u,l=n.toBase58()===e.mintA.address,[d,m]=l?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];a.equals(new C(0))?u=l?_t.add(new Oe(1)):Ft.sub(new Oe(1)):u=te.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let p=we(i,d,o,!1),{allTrade:y,expectedAmountOut:f,remainingAccounts:b,executionPrice:g,feeAmount:w}=Ce.getOutputAmountAndRemainAccounts(e,t,n,p.amount.sub(p.fee??ye),u,c),k=we(f,m,o,!1),h=te.sqrtPriceX64ToPrice(g,e.mintA.decimals,e.mintB.decimals),x=l?h:new C(1).div(h),T=f.mul(new Oe(Math.floor((1-s)*1e10))).div(new Oe(1e10)),B=we(T,m,o,!1),S=l?e.currentPrice:new C(1).div(e.currentPrice),I=new C(x).sub(S).abs(),K=S,N=new tt(new C(I).mul(10**15).toFixed(0),new C(K).mul(10**15).toFixed(0));return{allTrade:y,realAmountIn:p,amountOut:k,minAmountOut:B,expirationTime:Qt(p.expirationTime,k.expirationTime),currentPrice:e.currentPrice,executionPrice:x,priceImpact:N,fee:w,remainingAccounts:b,executionPriceX64:g}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:o,slippage:i,epochInfo:s,catchLiquidityInsufficient:a=!1}){let c=o.address===e.mintB.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA],[d,m]=[new Me({...u,mint:u.address,isToken2022:u.programId===Rc.toBase58()}),new Me({...l,mint:l.address,isToken2022:l.programId===Rc.toBase58()})],{allTrade:p,realAmountIn:y,amountOut:f,minAmountOut:b,expirationTime:g,currentPrice:w,executionPrice:k,priceImpact:h,fee:x,remainingAccounts:T,executionPriceX64:B}=Ce.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new Nt(u.address),amountIn:n,slippage:i,epochInfo:s,catchLiquidityInsufficient:a}),S={...y,amount:new he(d,y.amount),fee:y.fee===void 0?void 0:new he(d,y.fee)},I={...f,amount:new he(m,f.amount),fee:f.fee===void 0?void 0:new he(m,f.fee)},K={...b,amount:new he(m,b.amount),fee:b.fee===void 0?void 0:new he(m,b.fee)},N=new ht({baseToken:d,denominator:new Oe(10).pow(new Oe(20+d.decimals)),quoteToken:m,numerator:w.mul(new C(10**(20+m.decimals))).toFixed(0)}),v=new ht({baseToken:d,denominator:new Oe(10).pow(new Oe(20+d.decimals)),quoteToken:m,numerator:k.mul(new C(10**(20+m.decimals))).toFixed(0)}),_=new he(d,x);return{allTrade:p,realAmountIn:S,amountOut:I,minAmountOut:K,expirationTime:g,currentPrice:N,executionPrice:v,priceImpact:h,fee:_,remainingAccounts:T,executionPriceX64:B}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:o,amountOut:i,slippage:s,priceLimit:a=new C(0)}){let c=n.toBase58()===e.mintA.address,u={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},l;a.equals(new C(0))?l=c?Ft.sub(new Oe(1)):_t.add(new Oe(1)):l=te.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let d=we(i,u[n.toString()],o,!0),{expectedAmountIn:m,remainingAccounts:p,executionPrice:y,feeAmount:f}=Ce.getInputAmountAndRemainAccounts(e,t,n,d.amount.sub(d.fee??ye),l),b=c?e.mintB.address:e.mintA.address,g=we(m,u[b],o,!1),w=te.sqrtPriceX64ToPrice(y,e.mintA.decimals,e.mintB.decimals),k=c?w:new C(1).div(w),h=m.mul(new Oe(Math.floor((1+s)*1e10))).div(new Oe(1e10)),x=we(h,u[b],o,!0),T=c?e.currentPrice:new C(1).div(e.currentPrice),B=new C(k).sub(T).abs(),S=T,I=new tt(new C(B).mul(10**15).toFixed(0),new C(S).mul(10**15).toFixed(0));return{amountIn:g,maxAmountIn:x,realAmountOut:d,expirationTime:Qt(g.expirationTime,d.expirationTime),currentPrice:e.currentPrice,executionPrice:k,priceImpact:I,fee:f,remainingAccounts:p}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:o}){let i=e[t],s=H.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=H.getTickPrice({poolInfo:e,tick:o,baseIn:!0}).price.toNumber(),c=Math.max(s,i.priceMin),l=Math.min(a,i.priceMax)-c,d=a-s,m=i.priceMax-i.priceMin,p;return l<=0?p=0:d===l?p=m/l:m===l?p=l/d:p=l/m*(l/d),{feeApr:i.feeApr*p,rewardsApr:[(i.rewardApr[0]??0)*p,(i.rewardApr[1]??0)*p,(i.rewardApr[2]??0)*p],apr:i.apr*p}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:o,liquidity:i,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:c}){let u=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],d=o[ct(e.mintA.address).toString()],m=o[ct(e.mintB.address).toString()],p=e.mintA.decimals,y=e.mintB.decimals;if(!l||!d||!m)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let f=te.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),b=te.getSqrtPriceX64FromTick(s),g=te.getSqrtPriceX64FromTick(a),{amountSlippageA:w,amountSlippageB:k}=ge.getAmountsFromLiquidityWithSlippage(f,b,g,t,!1,!1,0),{amountSlippageA:h,amountSlippageB:x}=ge.getAmountsFromLiquidityWithSlippage(f,b,g,i,!1,!1,0),T=new C(w.toString()).div(new C(10).pow(p)).mul(d.value).add(new C(k.toString()).div(new C(10).pow(y)).mul(m.value)),B=new C(h.toString()).div(new C(10).pow(p)).mul(d.value).add(new C(x.toString()).div(new C(10).pow(y)).mul(m.value)),S=new C(1).div(T.add(B)),K=new C(l.volumeFee).mul(365).div(u).mul(S).mul(100).toNumber(),N=3600*24*365,v=e.rewardDefaultInfos.map(_=>{let D=_.mint.decimals,q=o[_.mint.address];return c<(_.startTime??0)||c>(_.endTime??0)||!_.perSecond||!q||D===void 0?0:new C(q.value).mul(new C(_.perSecond).mul(N)).div(new C(10).pow(D)).mul(S).mul(100).toNumber()});return{feeApr:K,rewardsApr:v,apr:K+v.reduce((_,D)=>_+D,0)}}static async getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:o,amount:i,slippage:s,add:a,epochInfo:c,amountHasFee:u}){let l=te.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),d=te.getSqrtPriceX64FromTick(n),m=te.getSqrtPriceX64FromTick(o),p=we(i,e[t?"mintA":"mintB"].extensions?.feeConfig,c,!u),y=new Oe(new C(p.amount.sub(p.fee??ye).toString()).toFixed(0)),f;if(l.lte(d))f=t?ge.getLiquidityFromTokenAmountA(d,m,y,!a):new Oe(0);else if(l.lte(m)){let g=ge.getLiquidityFromTokenAmountA(l,m,y,!a),w=ge.getLiquidityFromTokenAmountB(d,l,y);f=t?g:w}else f=t?new Oe(0):ge.getLiquidityFromTokenAmountB(d,m,y);let b=await Ce.getAmountsFromLiquidity({epochInfo:c,poolInfo:e,tickLower:n,tickUpper:o,liquidity:f,slippage:s,add:a});return{liquidity:f,amountA:t?p:b.amountA,amountB:t?b.amountB:p,amountSlippageA:t?p:b.amountSlippageA,amountSlippageB:t?b.amountSlippageB:p,expirationTime:b.expirationTime}}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:o,liquidity:i,slippage:s,add:a}){let c=te.getSqrtPriceX64FromTick(n),u=te.getSqrtPriceX64FromTick(o),l=a?1+s:1-s,d=ge.getAmountsFromLiquidity(te.priceToSqrtPriceX64(new C(t.price),t.mintA.decimals,t.mintB.decimals),c,u,i,a),[m,p]=[we(d.amountA,t.mintA.extensions?.feeConfig,e,!0),we(d.amountB,t.mintB.extensions?.feeConfig,e,!0)],[y,f]=[we(d.amountA.muln(l),t.mintA.extensions?.feeConfig,e,!0),we(d.amountB.muln(l),t.mintB.extensions?.feeConfig,e,!0)];return{liquidity:i,amountA:m,amountB:p,amountSlippageA:y,amountSlippageB:f,expirationTime:Qt(m.expirationTime,p.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let o=t.filter(c=>!n[c.id]).map(c=>new Nt(c.id));(await Wt(e,o)).forEach((c,u)=>{!c||(n[o[u].toBase58()]=Qn.decode(c.data))});let s=t.map(c=>De(new Nt(c.programId),new Nt(c.id)).publicKey),a=await Ce.fetchExBitmaps({connection:e,exBitmapAddress:s,batchRequest:!1});return t.reduce((c,u)=>({...c,[u.id]:{...n[u.id],id:new Nt(u.id),version:6,programId:new Nt(u.programId),mintA:u.mintA,mintB:u.mintB,ammConfig:{...u.config,id:new Nt(u.config.id),fundOwner:""},currentPrice:new C(u.price),exBitmapAccount:De(new Nt(u.programId),new Nt(u.id)).publicKey,exBitmapInfo:a[De(new Nt(u.programId),new Nt(u.id)).publicKey.toBase58()],startTime:n[u.id].startTime.toNumber(),rewardInfos:n[u.id].rewardInfos}}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};function $h({poolInfo:r,tickLower:e,tickUpper:t,amountA:n,amountB:o,slippage:i,add:s,epochInfo:a,amountHasFee:c}){let[u,l,d,m]=e<t?[e,t,n,o]:[t,e,o,n],p=te.priceToSqrtPriceX64(new C(r.price),r.mintA.decimals,r.mintB.decimals),y=te.getSqrtPriceX64FromTick(u),f=te.getSqrtPriceX64FromTick(l),[b,g]=[we(d,r.mintA.extensions?.feeConfig,a,!c),we(m,r.mintB.extensions?.feeConfig,a,!c)],w=ge.getLiquidityFromTokenAmounts(p,y,f,b.amount.sub(b.fee??ye),g.amount.sub(g.fee??ye));return ge.getAmountsOutFromLiquidity({poolInfo:r,tickLower:e,tickUpper:t,liquidity:w,slippage:i,add:s,epochInfo:a,amountAddFee:!c})}var da={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};function Nc(r){return{...r,type:"Concentrated",programId:r.programId.toString(),id:r.id.toString(),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Clmm",price:r.currentPrice.toNumber(),mintAmountA:0,mintAmountB:0,feeRate:r.ammConfig.tradeFeeRate,openTime:r.startTime.toString(),tvl:0,day:da,week:da,month:da,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,burnPercent:0,config:{...r.ammConfig,id:r.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]}}}var ae=class{static mulDivRoundingUp(e,t,n){let o=e.mul(t),i=o.div(n);return o.mod(n).eq(ye)||(i=i.add(Rt)),i}static mulDivFloor(e,t,n){if(n.eq(ye))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(ye))throw new Error("division by 0");return e.mul(t).add(n.sub(Rt)).div(n)}static x64ToDecimal(e,t){return new C(e.toString()).div(C.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new le(e.mul(C.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(Tr).sub(t).mod(Tr)}};function ot(r,e){return pa(r.mul(e),64,256)}function qp(r,e,t){let n=r.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function pa(r,e,t){let n=r.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var te=class{static sqrtPriceX64ToPrice(e,t,n){return ae.x64ToDecimal(e).pow(2).mul(C.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return ae.decimalToX64(e.mul(C.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,o){if(!e.gt(ye))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(ye))throw new Error("liquidity must greater than 0");return o?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,o){if(!e.gt(ye))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(ye))throw new Error("liquidity must greater than 0");return o?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,o){if(n.eq(ye))return e;let i=t.shln(si);if(o){let s=i,a=i.add(n.mul(e));return a.gte(s)?ae.mulDivCeil(s,e,a):ae.mulDivRoundingUp(s,Rt,s.div(e).add(n))}else{let s=n.mul(e);if(!i.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=i.sub(s);return ae.mulDivCeil(i,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,o){let i=n.shln(si);if(o)return e.add(i.div(t));{let s=ae.mulDivRoundingUp(i,Rt,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<dt||e>At)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new le("18445821805675395072"):new le("18446744073709551616");return(t&2)!=0&&(n=ot(n,new le("18444899583751176192"))),(t&4)!=0&&(n=ot(n,new le("18443055278223355904"))),(t&8)!=0&&(n=ot(n,new le("18439367220385607680"))),(t&16)!=0&&(n=ot(n,new le("18431993317065453568"))),(t&32)!=0&&(n=ot(n,new le("18417254355718170624"))),(t&64)!=0&&(n=ot(n,new le("18387811781193609216"))),(t&128)!=0&&(n=ot(n,new le("18329067761203558400"))),(t&256)!=0&&(n=ot(n,new le("18212142134806163456"))),(t&512)!=0&&(n=ot(n,new le("17980523815641700352"))),(t&1024)!=0&&(n=ot(n,new le("17526086738831433728"))),(t&2048)!=0&&(n=ot(n,new le("16651378430235570176"))),(t&4096)!=0&&(n=ot(n,new le("15030750278694412288"))),(t&8192)!=0&&(n=ot(n,new le("12247334978884435968"))),(t&16384)!=0&&(n=ot(n,new le("8131365268886854656"))),(t&32768)!=0&&(n=ot(n,new le("3584323654725218816"))),(t&65536)!=0&&(n=ot(n,new le("696457651848324352"))),(t&131072)!=0&&(n=ot(n,new le("26294789957507116"))),(t&262144)!=0&&(n=ot(n,new le("37481735321082"))),e>0&&(n=Ac.div(n)),n}static getTickFromPrice(e,t,n){return te.getTickFromSqrtPriceX64(te.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(Ft)||e.lt(_t))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new le(t-64),o=qp(n,32,128),i=new le("8000000000000000","hex"),s=0,a=new le(0),c=t>=64?e.shrn(t-63):e.shln(63-t);for(;i.gt(new le(0))&&s<Pc;){c=c.mul(c);let y=c.shrn(127);c=c.shrn(63+y.toNumber()),a=a.add(i.mul(y)),i=i.shrn(1),s+=1}let u=a.shrn(32),d=o.add(u).mul(new le(wc)),m=pa(d.sub(new le(kc)),64,128).toNumber(),p=pa(d.add(new le(hc)),64,128).toNumber();return m==p?m:te.getSqrtPriceX64FromTick(p).lte(e)?p:m}},zn=class{static getTickWithPriceAndTickspacing(e,t,n,o){let s=te.getTickFromSqrtPriceX64(te.priceToSqrtPriceX64(e,n,o))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,o){let i=zn.getTickWithPriceAndTickspacing(e,t,n,o),s=te.getSqrtPriceX64FromTick(i);return te.sqrtPriceX64ToPrice(s,n,o)}},ge=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,o){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(ye))throw new Error("sqrtPriceX64A must greater than 0");let i=n.ushln(si),s=t.sub(e);return o?ae.mulDivRoundingUp(ae.mulDivCeil(i,s,t),Rt,e):ae.mulDivFloor(i,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,o){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(ye))throw new Error("sqrtPriceX64A must greater than 0");return o?ae.mulDivCeil(n,t.sub(e),Xe):ae.mulDivFloor(n,t.sub(e),Xe)}static getLiquidityFromTokenAmountA(e,t,n,o){e.gt(t)&&([e,t]=[t,e]);let i=n.mul(e).mul(t),s=t.sub(e),a=i.div(s);return o?ae.mulDivRoundingUp(a,Rt,ri):a.shrn(si)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),ae.mulDivFloor(n,ri,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,o,i){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return ge.getLiquidityFromTokenAmountA(t,n,o,!1);if(e.lt(n)){let s=ge.getLiquidityFromTokenAmountA(e,n,o,!1),a=ge.getLiquidityFromTokenAmountB(t,e,i);return s.lt(a)?s:a}else return ge.getLiquidityFromTokenAmountB(t,n,i)}static getAmountsFromLiquidity(e,t,n,o,i){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:ge.getTokenAmountAFromLiquidity(t,n,o,i),amountB:new le(0)};if(e.lt(n)){let s=ge.getTokenAmountAFromLiquidity(e,n,o,i),a=ge.getTokenAmountBFromLiquidity(t,e,o,i);return{amountA:s,amountB:a}}else return{amountA:new le(0),amountB:ge.getTokenAmountBFromLiquidity(t,n,o,i)}}static getAmountsFromLiquidityWithSlippage(e,t,n,o,i,s,a){let{amountA:c,amountB:u}=ge.getAmountsFromLiquidity(e,t,n,o,s),l=i?1+a:1-a,d=new le(new C(c.toString()).mul(l).toFixed(0)),m=new le(new C(u.toString()).mul(l).toFixed(0));return{amountSlippageA:d,amountSlippageB:m}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:o,slippage:i,add:s,epochInfo:a,amountAddFee:c}){let u=te.priceToSqrtPriceX64(new C(e.price),e.mintA.decimals,e.mintB.decimals),l=te.getSqrtPriceX64FromTick(t),d=te.getSqrtPriceX64FromTick(n),m=s?1+i:1-i,p=ge.getAmountsFromLiquidity(u,l,d,o,s),[y,f]=[we(p.amountA,e.mintA.extensions?.feeConfig,a,c),we(p.amountB,e.mintB.extensions?.feeConfig,a,c)],[b,g]=[we(new le(new C(p.amountA.toString()).mul(m).toFixed(0)),e.mintA.extensions?.feeConfig,a,c),we(new le(new C(p.amountB.toString()).mul(m).toFixed(0)),e.mintB.extensions?.feeConfig,a,c)];return{liquidity:o,amountA:y,amountB:f,amountSlippageA:b,amountSlippageB:g,expirationTime:Qt(y.expirationTime,f.expirationTime)}}},Xn=class{static swapCompute(e,t,n,o,i,s,a,c,u,l,d,m,p,y,f=!1){if(m.eq(ye))throw new Error("amountSpecified must not be 0");if(y||(y=s?_t.add(Rt):Ft.sub(Rt)),s){if(y.lt(_t))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(y.gte(d))throw new Error("sqrtPriceX64 must smaller than current")}else{if(y.gt(Ft))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(y.lte(d))throw new Error("sqrtPriceX64 must greater than current")}let b=m.gt(ye),g={amountSpecifiedRemaining:m,amountCalculated:ye,sqrtPriceX64:d,tick:u>p?Math.min(p+Ae.tickCount(l)-1,u):p,accounts:[],liquidity:c,feeAmount:new le(0)},w=p,k=n[p],h=0,x=!s&&k.startTickIndex===g.tick;for(;!g.amountSpecifiedRemaining.eq(ye)&&!g.sqrtPriceX64.eq(y);){h>10;let T={};T.sqrtPriceStartX64=g.sqrtPriceX64;let B=H.nextInitTick(k,g.tick,l,s,x),S=B||null,I=null;if(!S?.liquidityGross.gtn(0)){let N=Ce.nextInitializedTickArrayStartIndex({tickCurrent:g.tick,tickSpacing:l,tickArrayBitmap:o,exBitmapInfo:i},w,s);if(!N.isExist){if(f)return{allTrade:!1,amountSpecifiedRemaining:g.amountSpecifiedRemaining,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts};throw Error("swapCompute LiquidityInsufficient")}w=N.nextStartIndex;let{publicKey:v}=be(e,t,w);I=v,k=n[w];try{S=H.firstInitializedTick(k,s)}catch{throw Error("not found next tick info")}}T.tickNext=S.tick,T.initialized=S.liquidityGross.gtn(0),p!==w&&I&&(g.accounts.push(I),p=w),T.tickNext<dt?T.tickNext=dt:T.tickNext>At&&(T.tickNext=At),T.sqrtPriceNextX64=te.getSqrtPriceX64FromTick(T.tickNext);let K;if(s&&T.sqrtPriceNextX64.lt(y)||!s&&T.sqrtPriceNextX64.gt(y)?K=y:K=T.sqrtPriceNextX64,[g.sqrtPriceX64,T.amountIn,T.amountOut,T.feeAmount]=Xn.swapStepCompute(g.sqrtPriceX64,K,g.liquidity,g.amountSpecifiedRemaining,a,s),g.feeAmount=g.feeAmount.add(T.feeAmount),b?(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.sub(T.amountIn.add(T.feeAmount)),g.amountCalculated=g.amountCalculated.sub(T.amountOut)):(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.add(T.amountOut),g.amountCalculated=g.amountCalculated.add(T.amountIn.add(T.feeAmount))),g.sqrtPriceX64.eq(T.sqrtPriceNextX64)){if(T.initialized){let N=S.liquidityNet;s&&(N=N.mul(gn)),g.liquidity=ge.addDelta(g.liquidity,N)}x=T.tickNext!=g.tick&&!s&&k.startTickIndex===T.tickNext,g.tick=s?T.tickNext-1:T.tickNext}else if(g.sqrtPriceX64!=T.sqrtPriceStartX64){let N=te.getTickFromSqrtPriceX64(g.sqrtPriceX64);x=N!=g.tick&&!s&&k.startTickIndex===N,g.tick=N}++h}try{let{nextStartIndex:T,isExist:B}=Ae.nextInitializedTickArray(g.tick,l,s,o,i);B&&p!==T&&(g.accounts.push(be(e,t,T).publicKey),p=T)}catch{}return{allTrade:!0,amountSpecifiedRemaining:ye,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts}}static swapStepCompute(e,t,n,o,i,s){let a={sqrtPriceX64Next:new le(0),amountIn:new le(0),amountOut:new le(0),feeAmount:new le(0)},c=o.gte(ye);if(c){let l=ae.mulDivFloor(o,xr.sub(new le(i.toString())),xr);a.amountIn=s?ge.getTokenAmountAFromLiquidity(t,e,n,!0):ge.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(a.amountIn)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=te.getNextSqrtPriceX64FromInput(e,n,l,s)}else a.amountOut=s?ge.getTokenAmountBFromLiquidity(t,e,n,!1):ge.getTokenAmountAFromLiquidity(e,t,n,!1),o.mul(gn).gte(a.amountOut)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=te.getNextSqrtPriceX64FromOutput(e,n,o.mul(gn),s);let u=t.eq(a.sqrtPriceX64Next);return s?(u&&c||(a.amountIn=ge.getTokenAmountAFromLiquidity(a.sqrtPriceX64Next,e,n,!0)),u&&!c||(a.amountOut=ge.getTokenAmountBFromLiquidity(a.sqrtPriceX64Next,e,n,!1))):(a.amountIn=u&&c?a.amountIn:ge.getTokenAmountBFromLiquidity(e,a.sqrtPriceX64Next,n,!0),a.amountOut=u&&!c?a.amountOut:ge.getTokenAmountAFromLiquidity(e,a.sqrtPriceX64Next,n,!1)),!c&&a.amountOut.gt(o.mul(gn))&&(a.amountOut=o.mul(gn)),c&&!a.sqrtPriceX64Next.eq(t)?a.feeAmount=o.sub(a.amountIn):a.feeAmount=ae.mulDivCeil(a.amountIn,new le(i),xr.sub(new le(i))),[a.sqrtPriceX64Next,a.amountIn,a.amountOut,a.feeAmount]}};var Ye=60,Gn=512,H=class{static getTickArrayAddressByTick(e,t,n,o){let i=H.getTickArrayStartIndexByTick(n,o),{publicKey:s}=be(e,t,i);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=H.getTickArrayStartIndexByTick(e,t),o=Math.floor((e-n)/t);if(o<0||o>=Ye)throw new Error("tick offset in array overflow");return o}static getTickArrayBitIndex(e,t){let n=Ae.tickCount(t),o=e/n;return e<0&&e%n!=0?o=Math.ceil(o)-1:o=Math.floor(o),o}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*Ae.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*Ye,o=Math.floor(e/n)+512;return Math.abs(o)}static checkTickArrayIsInitialized(e,t,n){let o=n*Ye,i=Math.floor(t/o)+512,s=Math.abs(i);return{isInitialized:e.testn(s),startIndex:(s-512)*o}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*Ye:e+t*Ye}static mergeTickArrayBitmap(e){let t=new Up(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,o,i){let s=Math.floor(o/(n*Ye));return[...H.searchLowBitFromStart(e,t,s-1,i,n),...H.searchHightBitFromStart(e,t,s,i,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return H.searchHightBitFromStart(e,t,-7680,Gn,n)}static getAllInitializedTickArrayInfo(e,t,n,o,i){let s=[],a=H.getAllInitializedTickArrayStartIndex(n,o,i);for(let c of a){let{publicKey:u}=be(e,t,c);s.push({tickArrayStartIndex:c,tickArrayAddress:u})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,o,i){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>H.mergeTickArrayBitmap(u)),a=[];for(;n>=-7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n--,a.length===o)break}let c=Ae.tickCount(i);return a.map(u=>u*c)}static searchHightBitFromStart(e,t,n,o,i){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>H.mergeTickArrayBitmap(u)),a=[];for(;n<7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n++,a.length===o)break}let c=Ae.tickCount(i);return a.map(u=>u*c)}static checkIsOutOfBoundary(e){return e<dt||e>At}static nextInitTick(e,t,n,o,i){if(Ae.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(o)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(i||(a=a+1);a<Ye;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=Ye-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<Ye;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let o=te.getSqrtPriceX64FromTick(t),i=te.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:i,tickSqrtPriceX64:o}:{tick:t,price:new C(1).div(i),tickSqrtPriceX64:o}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let o=n?t:new C(1).div(t),i=zn.getTickWithPriceAndTickspacing(o,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=te.getSqrtPriceX64FromTick(i),a=te.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:i,price:a}:{tick:i,price:new C(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let o=te.getSqrtPriceX64FromTick(t),i=te.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:i,tickSqrtPriceX64:o}:{tick:t,price:new C(1).div(i),tickSqrtPriceX64:o}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let o=n?t:new C(1).div(t),i=zn.getTickWithPriceAndTickspacing(o,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=te.getSqrtPriceX64FromTick(i),a=te.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:i,price:a}:{tick:i,price:new C(1).div(a)}}};var vc=O([ke(8),F("bump"),jt("index"),L(""),rt("protocolFeeRate"),rt("tradeFeeRate"),jt("tickSpacing"),Q(P(),8,"")]),Gp=O([rt("blockTimestamp"),yo("tickCumulative"),Q(P(),4)]),Mc=O([ke(8),Ee("initialized"),P("recentEpoch"),jt("observationIndex"),L("poolId"),Q(Gp,100,"observations"),Q(P(),4)]),Xp=O([F("rewardState"),P("openTime"),P("endTime"),P("lastUpdateTime"),$("emissionsPerSecondX64"),P("rewardTotalEmissioned"),P("rewardClaimed"),L("tokenMint"),L("tokenVault"),L("creator"),$("rewardGrowthGlobalX64")]),Qn=O([ke(8),F("bump"),L("ammConfig"),L("creator"),L("mintA"),L("mintB"),L("vaultA"),L("vaultB"),L("observationId"),F("mintDecimalsA"),F("mintDecimalsB"),jt("tickSpacing"),$("liquidity"),$("sqrtPriceX64"),Ne("tickCurrent"),rt(),$("feeGrowthGlobalX64A"),$("feeGrowthGlobalX64B"),P("protocolFeesTokenA"),P("protocolFeesTokenB"),$("swapInAmountTokenA"),$("swapOutAmountTokenB"),$("swapInAmountTokenB"),$("swapOutAmountTokenA"),F("status"),Q(F(),7,""),Q(Xp,3,"rewardInfos"),Q(P(),16,"tickArrayBitmap"),P("totalFeesTokenA"),P("totalFeesClaimedTokenA"),P("totalFeesTokenB"),P("totalFeesClaimedTokenB"),P("fundFeesTokenA"),P("fundFeesTokenB"),P("startTime"),Q(P(),15*4-3,"padding")]),Qp=O([$("growthInsideLastX64"),P("rewardAmountOwed")]),pi=O([ke(8),F("bump"),L("nftMint"),L("poolId"),Ne("tickLower"),Ne("tickUpper"),$("liquidity"),$("feeGrowthInsideLastX64A"),$("feeGrowthInsideLastX64B"),P("tokenFeesOwedA"),P("tokenFeesOwedB"),Q(Qp,3,"rewardInfos"),Q(P(),8,"")]),hT=O([ke(8),F("bump"),L("poolId"),Ne("tickLowerIndex"),Ne("tickUpperIndex"),$("liquidity"),$("feeGrowthInsideLastX64A"),$("feeGrowthInsideLastX64B"),P("tokenFeesOwedA"),P("tokenFeesOwedB"),Q($(),3,"rewardGrowthInside"),Q(P(),8,"")]),zp=O([Ne("tick"),ju("liquidityNet"),$("liquidityGross"),$("feeGrowthOutsideX64A"),$("feeGrowthOutsideX64B"),Q($(),3,"rewardGrowthsOutsideX64"),Q(rt(),13,"")]),mi=O([ke(8),L("poolId"),Ne("startTickIndex"),Q(zp,Ye,"ticks"),F("initializedTickCount"),Q(F(),115,"")]),Ec=O([ke(329),Q(L(),100,"whitelistMints")]),Oc=O([ke(8),L("poolId"),Q(Q(P(),8),ma,"positiveTickArrayBitmap"),Q(Q(P(),8),ma,"negativeTickArrayBitmap")]),TT=O([P(),F("bump"),L("owner"),L("poolId"),L("positionId"),L("nftAccount"),Q(P(),8)]),IT=O([ke(8),F("bump"),L("lockOwner"),L("poolId"),L("positionId"),L("nftAccount"),L("lockNftMint"),P("recentEpoch"),Q(P(),8)]);Mc.span;var _c=de("Raydium_Clmm"),Ot={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],openPositionWithTokenEx:[77,255,174,82,125,29,201,46],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},Fc=[188,37,179,131,82,150,84,73],Vc=[16,72,250,198,14,162,212,19],Be=class{static createPoolInstruction(e,t,n,o,i,s,a,c,u,l,d,m,p,y){let f=O([$("sqrtPriceX64"),P("zero")]),b=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:wn.programId,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1},...y?.map(k=>({pubkey:k,isSigner:!1,isWritable:!1}))||[]],g=Buffer.alloc(f.span);f.encode({sqrtPriceX64:p,zero:ye},g);let w=Buffer.from([...Ot.createPool,...g]);return new st({keys:b,programId:e,data:w})}static async createPoolInstructions(e){let{programId:t,owner:n,mintA:o,mintB:i,ammConfigId:s,initialPriceX64:a,extendMintAccount:c}=e,[u,l]=[new U(o.address),new U(i.address)],{publicKey:d}=Sc(t,s,u,l),{publicKey:m}=Cc(t,d),{publicKey:p}=ua(t,d,u),{publicKey:y}=ua(t,d,l),f=De(t,d).publicKey,b=[this.createPoolInstruction(t,d,n,s,m,u,p,new U(o.programId||Ie),l,y,new U(i.programId||Ie),f,a,c)];return{signers:[],instructions:b,instructionTypes:[V.CreateAccount,V.ClmmCreatePool],address:{poolId:d,observationId:m,exBitmapAccount:f,mintAVault:p,mintBVault:y},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I,K){let N=O([Ne("tickLowerIndex"),Ne("tickUpperIndex"),Ne("tickArrayLowerStartIndex"),Ne("tickArrayUpperStartIndex"),$("liquidity"),P("amountMaxA"),P("amountMaxB"),Ee("withMetadata"),F("optionBaseFlag"),Ee("baseFlag")]),v=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],_=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:wn.programId,isSigner:!1,isWritable:!1},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:fi,isSigner:!1,isWritable:!1},{pubkey:Ut,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...v],D=Buffer.alloc(N.span);N.encode({tickLowerIndex:w,tickUpperIndex:k,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:x,liquidity:T,amountMaxA:B,amountMaxB:S,withMetadata:I==="create",baseFlag:!1,optionBaseFlag:0},D);let q=Buffer.from([...Ot.openPosition,...D]);return new st({keys:_,programId:e,data:q})}static openPositionFromLiquidityInstruction22(e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I){let K=O([Ne("tickLowerIndex"),Ne("tickUpperIndex"),Ne("tickArrayLowerStartIndex"),Ne("tickArrayUpperStartIndex"),$("liquidity"),P("amountMaxA"),P("amountMaxB"),Ee("withMetadata"),F("optionBaseFlag"),Ee("baseFlag")]),N=[...I?[{pubkey:I,isSigner:!1,isWritable:!0}]:[]],v=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:wn.programId,isSigner:!1,isWritable:!1},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:fi,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...N],_=Buffer.alloc(K.span);K.encode({tickLowerIndex:g,tickUpperIndex:w,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:h,liquidity:x,amountMaxA:T,amountMaxB:B,withMetadata:S==="create",baseFlag:!1,optionBaseFlag:0},_);let D=Buffer.from([...Ot.openPositionWithTokenEx,..._]);return new st({keys:v,programId:e,data:D})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:i,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:d}){let m=[],[p,y]=[new U(e.programId),new U(e.id)],f;if(l)f=new U((await l(1))[0]);else{let I=Cr.generate();m.push(I),f=I.publicKey}let b=H.getTickArrayStartIndexByTick(o,e.config.tickSpacing),g=H.getTickArrayStartIndexByTick(i,e.config.tickSpacing),{publicKey:w}=be(p,y,b),{publicKey:k}=be(p,y,g),{publicKey:h}=d?Y(n.wallet,f,Fe):Y(n.wallet,f,Ie),{publicKey:x}=An(f),{publicKey:T}=Pt(p,f),{publicKey:B}=$t(p,y,o,i),S=d?this.openPositionFromLiquidityInstruction22(p,n.feePayer,y,n.wallet,f,h,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),o,i,b,g,s,a,c,u,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?De(p,y).publicKey:void 0):this.openPositionFromLiquidityInstruction(p,n.feePayer,y,n.wallet,f,h,x,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),o,i,b,g,s,a,c,u,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?De(p,y).publicKey:void 0);return{signers:m,instructions:[S],instructionTypes:[V.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:f,tickArrayLower:w,tickArrayUpper:k,positionNftAccount:h,metadataAccount:x,personalPosition:T,protocolPosition:B}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:i,base:s,baseAmount:a,otherAmountMax:c,withMetadata:u,getEphemeralSigners:l,nft2022:d}){let m=[],[p,y]=[new U(e.programId),new U(e.id)],f;if(l)f=new U((await l(1))[0]);else{let I=Cr.generate();m.push(I),f=I.publicKey}let b=H.getTickArrayStartIndexByTick(o,e.config.tickSpacing),g=H.getTickArrayStartIndexByTick(i,e.config.tickSpacing),{publicKey:w}=be(p,y,b),{publicKey:k}=be(p,y,g),{publicKey:h}=d?Y(n.wallet,f,Fe):Y(n.wallet,f,Ie),{publicKey:x}=An(f),{publicKey:T}=Pt(p,f),{publicKey:B}=$t(p,y,o,i),S=d?this.openPositionFromBaseInstruction22(p,n.feePayer,y,n.wallet,f,h,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),o,i,b,g,u,s,a,c,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?De(p,y).publicKey:void 0):this.openPositionFromBaseInstruction(p,n.feePayer,y,n.wallet,f,h,x,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),o,i,b,g,u,s,a,c,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?De(p,y).publicKey:void 0);return{address:{nftMint:f,tickArrayLower:w,tickArrayUpper:k,positionNftAccount:h,metadataAccount:x,personalPosition:T,protocolPosition:B},instructions:[S],signers:m,instructionTypes:[V.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I,K){let N=O([Ne("tickLowerIndex"),Ne("tickUpperIndex"),Ne("tickArrayLowerStartIndex"),Ne("tickArrayUpperStartIndex"),$("liquidity"),P("amountMaxA"),P("amountMaxB"),Ee("withMetadata"),F("optionBaseFlag"),Ee("baseFlag")]),v=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],_=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:wn.programId,isSigner:!1,isWritable:!1},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:fi,isSigner:!1,isWritable:!1},{pubkey:Ut,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...v],D=Buffer.alloc(N.span);N.encode({tickLowerIndex:w,tickUpperIndex:k,tickArrayLowerStartIndex:h,tickArrayUpperStartIndex:x,liquidity:new fa(0),amountMaxA:B==="MintA"?S:I,amountMaxB:B==="MintA"?I:S,withMetadata:T==="create",baseFlag:B==="MintA",optionBaseFlag:1},D);let q=Buffer.from([...Ot.openPosition,...D]);return new st({keys:_,programId:e,data:q})}static openPositionFromBaseInstruction22(e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x,T,B,S,I){let K=O([Ne("tickLowerIndex"),Ne("tickUpperIndex"),Ne("tickArrayLowerStartIndex"),Ne("tickArrayUpperStartIndex"),$("liquidity"),P("amountMaxA"),P("amountMaxB"),Ee("withMetadata"),F("optionBaseFlag"),Ee("baseFlag")]),N=[...I?[{pubkey:I,isSigner:!1,isWritable:!0}]:[]],v=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:wn.programId,isSigner:!1,isWritable:!1},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:fi,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...N],_=Buffer.alloc(K.span);K.encode({tickLowerIndex:g,tickUpperIndex:w,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:h,liquidity:new fa(0),amountMaxA:T==="MintA"?B:S,amountMaxB:T==="MintA"?S:B,withMetadata:x==="create",baseFlag:T==="MintA",optionBaseFlag:1},_);let D=Buffer.from([...Ot.openPositionWithTokenEx,..._]);return new st({keys:v,programId:e,data:D})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:i,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:d}){let m,p=[];if(l)m=new U((await l(1))[0]);else{let I=Cr.generate();p.push(I),m=I.publicKey}let[y,f]=[new U(e.programId),new U(e.id)],b=H.getTickArrayStartIndexByTick(o,e.config.tickSpacing),g=H.getTickArrayStartIndexByTick(i,e.config.tickSpacing),{publicKey:w}=be(y,f,b),{publicKey:k}=be(y,f,g),{publicKey:h}=d?Y(n.wallet,m,Fe):Y(n.wallet,m,Ie),{publicKey:x}=An(m),{publicKey:T}=Pt(y,m),{publicKey:B}=$t(y,f,o,i),S=d?this.openPositionFromLiquidityInstruction22(y,n.wallet,f,n.wallet,m,h,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(t.mintA.address),new U(t.mintB.address),o,i,b,g,s,a,c,u,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?De(y,f).publicKey:void 0):this.openPositionFromLiquidityInstruction(y,n.wallet,f,n.wallet,m,h,x,B,w,k,T,n.tokenAccountA,n.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(t.mintA.address),new U(t.mintB.address),o,i,b,g,s,a,c,u,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?De(y,f).publicKey:void 0);return{address:{nftMint:m,tickArrayLower:w,tickArrayUpper:k,positionNftAccount:h,metadataAccount:x,personalPosition:T,protocolPosition:B},instructions:[S],signers:p,instructionTypes:[V.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,o,i,s){let a=O([]),c=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:wn.programId,isSigner:!1,isWritable:!1},{pubkey:s?Fe:Ie,isSigner:!1,isWritable:!1}],u=Buffer.alloc(a.span);a.encode({},u);let l=Buffer.from([...Ot.closePosition,...u]);return new st({keys:c,programId:e,data:l})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:o,nft2022:i}){let s=new U(e.programId),a=i?Y(n.wallet,o.nftMint,Fe).publicKey:Y(n.wallet,o.nftMint,Ie).publicKey,{publicKey:c}=Pt(s,o.nftMint),u=[];return u.push(this.closePositionInstruction(s,n.wallet,o.nftMint,a,c,i)),{address:{positionNftAccount:a,personalPosition:c},signers:[],instructions:u,instructionTypes:[V.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g,w){let k=O([$("liquidity"),P("amountMaxA"),P("amountMaxB"),F("optionBaseFlag"),Ee("baseFlag")]),h=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[]],x=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...h],T=Buffer.alloc(k.span);k.encode({liquidity:f,amountMaxA:b,amountMaxB:g,optionBaseFlag:0,baseFlag:!1},T);let B=Buffer.from([...Ot.increaseLiquidity,...T]);return new st({keys:x,programId:e,data:B})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,liquidity:i,amountMaxA:s,amountMaxB:a,nft2022:c}){let[u,l]=[new U(e.programId),new U(e.id)],d=H.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=H.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=be(u,l,d),{publicKey:y}=be(u,l,m),{publicKey:f}=c?Y(o.wallet,n.nftMint,Fe):Y(o.wallet,n.nftMint,Ie),{publicKey:b}=Pt(u,n.nftMint),{publicKey:g}=$t(u,l,n.tickLower,n.tickUpper),w=this.increasePositionFromLiquidityInstruction(u,o.wallet,f,b,l,g,p,y,o.tokenAccountA,o.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),i,s,a,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[d,m])?De(u,l).publicKey:void 0);return{address:{tickArrayLower:p,tickArrayUpper:y,positionNftAccount:f,personalPosition:b,protocolPosition:g},signers:[],instructions:[w],instructionTypes:[V.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,base:i,baseAmount:s,otherAmountMax:a,nft2022:c}){let[u,l]=[new U(e.programId),new U(e.id)],d=H.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),m=H.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=be(u,l,d),{publicKey:y}=be(u,l,m),{publicKey:f}=c?Y(o.wallet,n.nftMint,Fe):Y(o.wallet,n.nftMint,Ie),{publicKey:b}=Pt(u,n.nftMint),{publicKey:g}=$t(u,l,n.tickLower,n.tickUpper);return{address:{tickArrayLower:p,tickArrayUpper:y,positionNftAccount:f,personalPosition:b,protocolPosition:g},instructions:[this.increasePositionFromBaseInstruction(u,o.wallet,f,b,l,g,p,y,o.tokenAccountA,o.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),i,s,a,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[d,m])?De(u,l).publicKey:void 0)],signers:[],instructionTypes:[V.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g,w){let k=O([$("liquidity"),P("amountMaxA"),P("amountMaxB"),F("optionBaseFlag"),Ee("baseFlag")]),h=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[]],x=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...h],T=Buffer.alloc(k.span);k.encode({liquidity:new fa(0),amountMaxA:f==="MintA"?b:g,amountMaxB:f==="MintA"?g:b,baseFlag:f==="MintA",optionBaseFlag:1},T);let B=Buffer.from([...Ot.increaseLiquidity,...T]);return new st({keys:x,programId:e,data:B})}static decreaseLiquidityInstruction(e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g,w,k){let h=O([$("liquidity"),P("amountMinA"),P("amountMinB")]),x=[...k?[{pubkey:k,isSigner:!1,isWritable:!0}]:[],...f.map(I=>[{pubkey:I.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:I.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:I.rewardMint,isSigner:!1,isWritable:!1}]).flat()],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:ji,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},...x],B=Buffer.alloc(h.span);h.encode({liquidity:b,amountMinA:g,amountMinB:w},B);let S=Buffer.from([...Ot.decreaseLiquidity,...B]);return new st({keys:T,programId:e,data:S})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,liquidity:i,amountMinA:s,amountMinB:a,programId:c,nft2022:u}){let[l,d]=[new U(e.programId),new U(e.id)],m=H.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),p=H.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:y}=be(l,d,m),{publicKey:f}=be(l,d,p),{publicKey:b}=u?Y(o.wallet,n.nftMint,Fe):Y(o.wallet,n.nftMint,c),{publicKey:g}=Pt(l,n.nftMint),{publicKey:w}=$t(l,d,n.tickLower,n.tickUpper),k=[];for(let T=0;T<e.rewardDefaultInfos.length;T++)k.push({poolRewardVault:new U(t.rewardInfos[T].vault),ownerRewardVault:o.rewardAccounts[T],rewardMint:new U(e.rewardDefaultInfos[T].mint.address)});let h=[],x=this.decreaseLiquidityInstruction(l,o.wallet,b,g,d,w,y,f,o.tokenAccountA,o.tokenAccountB,new U(t.vault.A),new U(t.vault.B),new U(e.mintA.address),new U(e.mintB.address),k,i,s,a,Ce.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,p])?De(l,d).publicKey:void 0);return h.push(x),{address:{tickArrayLower:y,tickArrayUpper:f,positionNftAccount:b,personalPosition:g,protocolPosition:w},signers:[],instructions:h,instructionTypes:[V.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g){let w=O([P("amount"),P("otherAmountThreshold"),$("sqrtPriceLimitX64"),Ee("isBaseInput")]),k=[...g?[{pubkey:g,isSigner:!1,isWritable:!0}]:[],...d.map(B=>({pubkey:B,isSigner:!1,isWritable:!0}))],h=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:ji,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...k],x=Buffer.alloc(w.span);w.encode({amount:p,otherAmountThreshold:y,sqrtPriceLimitX64:f,isBaseInput:b},x);let T=Buffer.from([...Ot.swap,...x]);return new st({keys:h,programId:e,data:T})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:o,inputMint:i,amountIn:s,amountOutMin:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,d]=[new U(e.programId),new U(e.id)],[m,p]=[new U(t.vault.A),new U(t.vault.B)],[y,f]=[new U(e.mintA.address),new U(e.mintB.address)],b=e.mintA.address===i.toString(),g=[this.swapInstruction(l,o.wallet,d,new U(e.config.id),b?o.tokenAccountA:o.tokenAccountB,b?o.tokenAccountB:o.tokenAccountA,b?m:p,b?p:m,b?y:f,b?f:y,u,n,s,a,c,!0,De(l,d).publicKey)];return{signers:[],instructions:g,instructionTypes:[V.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static makeSwapBaseOutInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:o,outputMint:i,amountOut:s,amountInMax:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,d]=[new U(e.programId),new U(e.id)],[m,p]=[new U(t.vault.A),new U(t.vault.B)],[y,f]=[new U(e.mintA.address),new U(e.mintB.address)],b=e.mintA.address===i.toBase58(),g=[this.swapInstruction(l,o.wallet,d,new U(e.config.id),b?o.tokenAccountB:o.tokenAccountA,b?o.tokenAccountA:o.tokenAccountB,b?p:m,b?m:p,b?f:y,b?y:f,u,n,s,a,c,!1,De(l,d).publicKey)];return{signers:[],instructions:g,instructionTypes:[V.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,o,i,s,a,c,u,l,d,m){let p=O([P("openTime"),P("endTime"),$("emissionsPerSecondX64")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:wn.programId,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1}],f=Buffer.alloc(p.span);p.encode({openTime:Z(l),endTime:Z(d),emissionsPerSecondX64:m},f);let b=Buffer.from([...Ot.initReward,...f]);return new st({keys:y,programId:e,data:b})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:o}){let[i,s]=[new U(e.programId),new U(e.id)],a=Kc(i,s,o.mint).publicKey,c=ui(i).publicKey,u=[this.initRewardInstruction(i,n.wallet,s,c,new U(e.config.id),n.tokenAccount,o.programId,o.mint,a,o.openTime,o.endTime,o.emissionsPerSecondX64)];return{address:{poolRewardVault:a,operationId:c},signers:[],instructions:u,instructionTypes:[V.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,o,i,s,a,c,u,l,d,m){let p=O([F("rewardIndex"),$("emissionsPerSecondX64"),P("openTime"),P("endTime")]),y=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0}],f=Buffer.alloc(p.span);p.encode({rewardIndex:u,emissionsPerSecondX64:m,openTime:Z(l),endTime:Z(d)},f);let b=Buffer.from([...Ot.setRewardEmissions,...f]);return new st({keys:y,programId:e,data:b})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:o}){let[i,s]=[new U(e.programId),new U(e.id)],a,c,u;for(let m=0;m<e.rewardDefaultInfos.length;m++)e.rewardDefaultInfos[m].mint.address===o.mint.toString()&&(a=m,c=new U(t.rewardInfos[m].vault),u=new U(t.rewardInfos[m].mint.address));(a===void 0||c===void 0)&&_c.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=ui(i).publicKey,d=[this.setRewardInstruction(i,n.wallet,s,l,new U(e.config.id),n.tokenAccount,c,u,a,o.openTime,o.endTime,o.emissionsPerSecondX64)];return{address:{rewardVault:c,operationId:l},signers:[],instructions:d,instructionTypes:[V.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,o,i,s,a){let c=O([F("rewardIndex")]),u=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:ji,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({rewardIndex:a},l);let d=Buffer.from([...Ot.collectReward,...l]);return new st({keys:u,programId:e,data:d})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:o}){let[i,s]=[new U(e.programId),new U(e.id)],a,c;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===o.toString()&&(a=l,c=new U(t.rewardInfos[l].vault));(a===void 0||c===void 0)&&_c.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let u=[this.collectRewardInstruction(i,n.wallet,s,n.tokenAccount,c,o,a)];return{address:{rewardVault:c},signers:[],instructions:u,instructionTypes:[V.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static async makeLockPositions({programId:e,authProgramId:t,poolProgramId:n,payer:o,wallet:i,nftMint:s,nft2022:a,getEphemeralSigners:c}){let u=[],l;if(c)l=new U((await c(1))[0]);else{let g=Cr.generate();u.push(g),l=g.publicKey}let d=a?Y(i,s,Fe).publicKey:Y(i,s,Ie).publicKey,{publicKey:m}=Pt(n,s),p=ci(e,l).publicKey,y=Y(i,l,Ie).publicKey,f=An(l).publicKey,b=Be.lockPositionInstructionV2({programId:e,auth:t,payer:o,positionOwner:i,lockOwner:i,positionNftAccount:d,positionId:m,lockPositionId:p,lockNftMint:l,lockNftAccount:y,metadataAccount:f,withMetadata:!0,nft2022:a,positionNftMint:s,authPositionNftAccount:Y(t,s,a?Fe:Ie).publicKey,positionNftProgram:a?Fe:Ie});return{address:{positionId:m,lockPositionId:p,lockNftAccount:y,lockNftMint:l,positionNftAccount:d,metadataAccount:f},instructions:[b],signers:u,instructionTypes:[V.ClmmLockPosition],lookupTableAddress:[]}}static lockPositionInstructionV2({programId:e,auth:t,payer:n,positionOwner:o,lockOwner:i,positionNftAccount:s,positionId:a,positionNftMint:c,authPositionNftAccount:u,positionNftProgram:l,lockPositionId:d,lockNftMint:m,lockNftAccount:p,metadataAccount:y,withMetadata:f}){let b=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!0,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:Ut,isSigner:!1,isWritable:!1},{pubkey:fi,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:wn.programId,isSigner:!1,isWritable:!1}],g=O([Ee("withMetadata")]),w=Buffer.alloc(g.span);g.encode({withMetadata:f},w);let k=Buffer.from([...Fc,...w]);return new st({keys:b,programId:e,data:k})}static lockPositionInstruction({programId:e,authProgramId:t,poolProgramId:n,owner:o,positionNft:i}){let{publicKey:s}=Y(o,i,Ie),{publicKey:a}=Pt(n,i),c=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:ca(e,a).publicKey,isSigner:!1,isWritable:!0},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:wn.programId,isSigner:!1,isWritable:!1}];return new st({keys:c,programId:e,data:Buffer.from(Fc)})}static harvestLockPositionInstruction(e){let[t,n]=[new U(e.poolKeys.programId),new U(e.poolKeys.id)],o=H.getTickArrayStartIndexByTick(e.ownerPosition.tickLower,e.poolKeys.config.tickSpacing),i=H.getTickArrayStartIndexByTick(e.ownerPosition.tickUpper,e.poolKeys.config.tickSpacing),{publicKey:s}=be(t,n,o),{publicKey:a}=be(t,n,i),{publicKey:c}=Y(e.owner,e.ownerPosition.nftMint,Ie),{publicKey:u}=Pt(t,e.ownerPosition.nftMint),{publicKey:l}=$t(t,n,e.ownerPosition.tickLower,e.ownerPosition.tickUpper),d=[];for(let y=0;y<e.poolKeys.rewardInfos.length;y++)d.push({poolRewardVault:new U(e.poolKeys.rewardInfos[y].vault),ownerRewardVault:e.ownerRewardAccounts[y],rewardMint:new U(e.poolKeys.rewardInfos[y].mint.address)});let m=[...d.map(y=>[{pubkey:y.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:y.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:y.rewardMint,isSigner:!1,isWritable:!1}]).flat()],p=[{pubkey:e.authProgramId,isSigner:!1,isWritable:!1},{pubkey:ca(e.programId,u).publicKey,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e.owner,isSigner:!0,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:new U(e.poolKeys.vault.A),isSigner:!1,isWritable:!0},{pubkey:new U(e.poolKeys.vault.B),isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:e.userVaultA,isSigner:!1,isWritable:!0},{pubkey:e.userVaultB,isSigner:!1,isWritable:!0},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:on,isSigner:!1,isWritable:!1},{pubkey:new U(e.poolKeys.mintA.address),isSigner:!1,isWritable:!1},{pubkey:new U(e.poolKeys.mintB.address),isSigner:!1,isWritable:!1},...m];return new st({keys:p,programId:e.programId,data:Buffer.from(Vc)})}static harvestLockPositionInstructionV2({programId:e,auth:t,lockPositionId:n,clmmProgram:o,lockOwner:i,lockNftMint:s,lockNftAccount:a,positionNftAccount:c,positionId:u,poolId:l,protocolPosition:d,vaultA:m,vaultB:p,tickArrayLower:y,tickArrayUpper:f,userVaultA:b,userVaultB:g,mintA:w,mintB:k,rewardAccounts:h,exTickArrayBitmap:x}){let T=[...x?[{pubkey:x,isSigner:!1,isWritable:!0}]:[],...h.map(S=>[{pubkey:S.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:S.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:S.rewardMint,isSigner:!1,isWritable:!1}]).flat()],B=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0},{pubkey:Ie,isSigner:!1,isWritable:!1},{pubkey:Fe,isSigner:!1,isWritable:!1},{pubkey:on,isSigner:!1,isWritable:!1},{pubkey:w,isSigner:!1,isWritable:!1},{pubkey:k,isSigner:!1,isWritable:!1},...T];return new st({keys:B,programId:e,data:Buffer.from(Vc)})}};var Wc=O([rt("mintAuthorityOption"),L("mintAuthority"),P("supply"),F("decimals"),F("isInitialized"),rt("freezeAuthorityOption"),L("freezeAuthority")]);import{PublicKey as Hp}from"@solana/web3.js";import{MintLayout as Dc,TOKEN_PROGRAM_ID as jp}from"@solana/spl-token";var ZT=async({connection:r,mint:e})=>{let t=await r.getAccountInfo(new Hp(e));return!t||t.data.length!==Dc.span?void 0:Dc.decode(t.data)},$T=({mint:r,decimals:e,programId:t=jp,logoURI:n="",priority:o=3})=>{let i=r.toBase58().substring(0,6);return{address:r.toBase58(),decimals:e,symbol:i,logoURI:n,extensions:{},chainId:101,programId:t.toString(),name:i,tags:[],priority:o}},Lr=r=>new Me({mint:r.address,decimals:r.decimals,symbol:r.symbol,name:r.name}),yi=({amount:r,isRaw:e,name:t,...n})=>new he(new Me({mint:ct(n.address).toBase58(),decimals:n.decimals,symbol:n.symbol,name:t}),r,e,t);function JT(r){return r.address===nn.address?Je:r}function eI(r){return r.address===Je.address?nn:r}var pt=({address:r,programId:e,decimals:t,...n})=>({chainId:101,address:ct(r).toBase58(),programId:e,logoURI:"",symbol:"",name:"",decimals:t,tags:[],extensions:n.extensions||{},...n}),Mn=r=>r?{...r,transferFeeConfigAuthority:r.transferFeeConfigAuthority.toBase58(),withdrawWithheldAuthority:r.withdrawWithheldAuthority.toBase58(),withheldAmount:r.withheldAmount.toString(),olderTransferFee:{...r.olderTransferFee,epoch:r.olderTransferFee.epoch.toString(),maximumFee:r.olderTransferFee.maximumFee.toString()},newerTransferFee:{...r.newerTransferFee,epoch:r.newerTransferFee.epoch.toString(),maximumFee:r.newerTransferFee.maximumFee.toString()}}:void 0;import qc from"bn.js";var ya=new qc(25),Rr=new qc(1e4),Yp={4:3,5:3};import{PublicKey as xe,SystemProgram as Yc,SYSVAR_RENT_PUBKEY as mf,TransactionInstruction as kn}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as df,TOKEN_PROGRAM_ID as ho}from"@solana/spl-token";var ba=O([F("instruction"),P("amountIn"),P("minAmountOut")]),ga=O([F("instruction"),P("maxAmountIn"),P("amountOut")]),mI=O([F("instruction"),F("nonce")]),Aa=O([F("instruction"),F("nonce"),P("startTime")]),Hn=O([P("status"),P("nonce"),P("maxOrder"),P("depth"),P("baseDecimal"),P("quoteDecimal"),P("state"),P("resetFlag"),P("minSize"),P("volMaxCutRatio"),P("amountWaveRatio"),P("baseLotSize"),P("quoteLotSize"),P("minPriceMultiplier"),P("maxPriceMultiplier"),P("systemDecimalValue"),P("minSeparateNumerator"),P("minSeparateDenominator"),P("tradeFeeNumerator"),P("tradeFeeDenominator"),P("pnlNumerator"),P("pnlDenominator"),P("swapFeeNumerator"),P("swapFeeDenominator"),P("baseNeedTakePnl"),P("quoteNeedTakePnl"),P("quoteTotalPnl"),P("baseTotalPnl"),P("poolOpenTime"),P("punishPcAmount"),P("punishCoinAmount"),P("orderbookToInitTime"),$("swapBaseInAmount"),$("swapQuoteOutAmount"),P("swapBase2QuoteFee"),$("swapQuoteInAmount"),$("swapBaseOutAmount"),P("swapQuote2BaseFee"),L("baseVault"),L("quoteVault"),L("baseMint"),L("quoteMint"),L("lpMint"),L("openOrders"),L("marketId"),L("marketProgramId"),L("targetOrders"),L("withdrawQueue"),L("lpVault"),L("owner"),P("lpReserve"),Q(P(),3,"padding")]),Zp=O([P("accountType"),P("status"),P("nonce"),P("maxOrder"),P("depth"),P("baseDecimal"),P("quoteDecimal"),P("state"),P("resetFlag"),P("minSize"),P("volMaxCutRatio"),P("amountWaveRatio"),P("baseLotSize"),P("quoteLotSize"),P("minPriceMultiplier"),P("maxPriceMultiplier"),P("systemDecimalsValue"),P("abortTradeFactor"),P("priceTickMultiplier"),P("priceTick"),P("minSeparateNumerator"),P("minSeparateDenominator"),P("tradeFeeNumerator"),P("tradeFeeDenominator"),P("pnlNumerator"),P("pnlDenominator"),P("swapFeeNumerator"),P("swapFeeDenominator"),P("baseNeedTakePnl"),P("quoteNeedTakePnl"),P("quoteTotalPnl"),P("baseTotalPnl"),P("poolOpenTime"),P("punishPcAmount"),P("punishCoinAmount"),P("orderbookToInitTime"),$("swapBaseInAmount"),$("swapQuoteOutAmount"),$("swapQuoteInAmount"),$("swapBaseOutAmount"),P("swapQuote2BaseFee"),P("swapBase2QuoteFee"),L("baseVault"),L("quoteVault"),L("baseMint"),L("quoteMint"),L("lpMint"),L("modelDataAccount"),L("openOrders"),L("marketId"),L("marketProgramId"),L("targetOrders"),L("owner"),Q(P(),64,"padding")]),Pa=O([F("instruction"),P("baseAmountIn"),P("quoteAmountIn"),P("fixedSide"),P("otherAmountMin")]),wa=O([F("instruction"),P("lpAmount"),P("baseAmountMin"),P("quoteAmountMin")]),dI={4:Hn,5:Zp},Uc=O([P("fee")]);import{PublicKey as $p}from"@solana/web3.js";var ko=new $p("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Yn=5e4,Jp=O([P("x"),P("y"),P("price")]),ef=O([P("accountType"),P("status"),P("multiplier"),P("validDataCount"),Q(Jp,Yn,"DataElement")]);function tf(r,e){return[0,Yn-2]}function nf(r){return[0,Yn-2]}function of(r){return[0,Yn-2]}function rf(r,e,t){let[n,o]=tf(e,t),i=n,s=o,a=0,c=e*r.multiplier/t;for(;i<=s;){if(a=Math.floor((s+i)/2),a===0||a>=Yn-2)return[a,a,!1];let u=r.DataElement[a].x*r.multiplier/r.DataElement[a].y,l=r.DataElement[a-1].x*r.multiplier/r.DataElement[a-1].y,d=r.DataElement[a+1].x*r.multiplier/r.DataElement[a+1].y;if(c===u)return[a,a,!0];if(c===l)return[a-1,a-1,!0];if(c===d)return[a+1,a+1,!0];if(c<l)s=a-1;else{if(c>l&&c<u)return[a-1,a,!0];if(c>u&&c<d)return[a,a+1,!0];i=a+1}}return[a,a,!1]}function ka(r,e,t){let[n,o,i]=rf(r,e,t);if(!i)return 0;if(n===o){let s=r.DataElement[n].x;return e*r.multiplier/s}else{let s=r.DataElement[n].x,a=r.DataElement[n].y,c=r.DataElement[o].x,u=r.DataElement[o].y,l=t*(c*a-s*u),d=s*l,m=(c-s)*(e*a-s*t)*u,p=d+m;return e*r.multiplier*l/p}}function jn(r,e,t){return e*r.multiplier/t}function Gc(r,e,t){return e*t/r.multiplier}function sf(r,e){let[t,n]=nf(e),o=t,i=n,s=0,a=e;for(;o<i;){if(s=Math.floor((i+o)/2),s<=0||s>Yn-2)return[s,s,!1];let c=r.DataElement[s].x,u=r.DataElement[s-1].x,l=r.DataElement[s+1].x;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<u)i=s-1;else{if(a>u&&a<c)return[s-1,s,!0];if(a>c&&a<l)return[s,s+1,!0];o=s+1}}return[s,s,!1]}function af(r,e){let[t,n]=of(e),o=t,i=n,s=0,a=e;for(;o<=i;){if(s=Math.floor((i+o)/2),s<=0||s>=Yn-2)return[s,s,!1];let c=r.DataElement[s].y,u=r.DataElement[s-1].y,l=r.DataElement[s+1].y;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<l)o=s+1;else{if(a<u&&a>c)return[s-1,s,!0];if(a<c&&a>l)return[s,s+1,!0];i=s-1}}return[s,s,!1]}function Xc(r,e,t,n){let o=n?e+t:e-t,[i,s,a]=sf(r,o);if(!a)return[0,0,!1,a];if(i===s)return[r.DataElement[s].price,r.DataElement[s].y,!1,a];{let c=r.DataElement[i].x,u=r.DataElement[s].x,l=r.DataElement[i].price,d=r.DataElement[s].price,m=r.DataElement[i].y,p=r.DataElement[s].y;if(e>=c&&e<=u)return n?[d,p,!0,a]:[l,m,!0,a];{let y,f;return n?(y=l+(d-l)*(e-c)/(u-c),f=m-(o-c)*r.multiplier/d):(y=l+(d-l)*(e-c)/(u-c),f=p+(u-o)*r.multiplier/l),[y,f,!1,a]}}}function uf(r,e,t,n){let o=n?e-t:e+t,[i,s,a]=af(r,o);if(!a)return[0,0,!1,a];if(i===s)return[r.DataElement[s].price,r.DataElement[s].x,!1,a];{let c=r.DataElement[i].x,u=r.DataElement[s].x,l=r.DataElement[i].price,d=r.DataElement[s].price,m=r.DataElement[i].y,p=r.DataElement[s].y;if(e>=p&&e<=m)return n?[d,u,!0,a]:[l,c,!0,a];{let y,f;return n?(y=l+(d-l)*(m-e)/(m-p),f=c+d*(m-o)/r.multiplier):(y=l+(d-l)*(m-e)/(m-p),f=u-l*(o-p)/r.multiplier),[y,f,!1,a]}}}function cf(r,e){let t=Xc(r,e,0,!1);return t[3]?t[0]:0}function Qc(r,e,t,n){let o=ka(r,e,t),i=jn(r,e,o),s=jn(r,t,o),a=jn(r,n,o),c=!0,[u,l,d,m]=Xc(r,i,a,c);if(!m)return 0;if(d)return n*r.multiplier/u;{let p=s-l;return Gc(r,p,o)}}function zc(r,e,t,n){let o=ka(r,e,t),i=jn(r,e,o),s=jn(r,t,o),a=jn(r,n,o),c=!1,[u,l,d,m]=uf(r,s,a,c);if(!m)return 0;if(d)return n*u/r.multiplier;{let p=i-l;return Gc(r,p,o)}}function lf(r){let e=ef.decode(r);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function Hc(r,e,t,n){let o=cf(r,jn(r,e,ka(r,e,t)))/r.multiplier;return n?o:1/o}var wo=class{connection;_layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};constructor({connection:e}){this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(ko);e&&(this._layoutData=lf(e?.data))}}};var jc=de("Raydium_liquidity_instruction");function Zc(r){let{poolInfo:e,poolKeys:t,userKeys:n,baseAmountIn:o,quoteAmountIn:i,fixedSide:s,otherAmountMin:a}=r,c=Buffer.alloc(Pa.span);Pa.encode({instruction:3,baseAmountIn:Z(o),quoteAmountIn:Z(i),otherAmountMin:Z(a),fixedSide:s==="base"?Tt:Pu},c);let u=[A({pubkey:ho,isWritable:!1}),A({pubkey:new xe(e.id)}),A({pubkey:new xe(t.authority),isWritable:!1}),A({pubkey:new xe(t.openOrders),isWritable:!1}),A({pubkey:new xe(t.targetOrders)}),A({pubkey:new xe(e.lpMint.address)}),A({pubkey:new xe(t.vault.A)}),A({pubkey:new xe(t.vault.B)})];return e.pooltype.includes("StablePool")&&u.push(A({pubkey:ko})),u.push(A({pubkey:new xe(e.marketId),isWritable:!1}),A({pubkey:n.baseTokenAccount}),A({pubkey:n.quoteTokenAccount}),A({pubkey:n.lpTokenAccount}),A({pubkey:n.owner,isWritable:!1,isSigner:!0}),A({pubkey:new xe(t.marketEventQueue),isWritable:!1})),new kn({programId:new xe(e.programId),keys:u,data:c})}function ha(r){let{poolInfo:e,poolKeys:t,userKeys:n,lpAmount:o,baseAmountMin:i,quoteAmountMin:s}=r,a=Le(t),c=4;if(e.pooltype.includes("StablePool")&&(c=5),c===4||c===5){let u=Buffer.alloc(wa.span);wa.encode({instruction:4,lpAmount:Z(o),baseAmountMin:Z(i),quoteAmountMin:Z(s)},u);let l=[A({pubkey:ho,isWritable:!1}),A({pubkey:a.id}),A({pubkey:a.authority,isWritable:!1}),A({pubkey:a.openOrders}),A({pubkey:a.targetOrders}),A({pubkey:a.mintLp.address}),A({pubkey:a.vault.A}),A({pubkey:a.vault.B})];return c===5?l.push(A({pubkey:ko})):(l.push(A({pubkey:a.id})),l.push(A({pubkey:a.id}))),l.push(A({pubkey:a.marketProgramId,isWritable:!1}),A({pubkey:a.marketId}),A({pubkey:a.marketBaseVault}),A({pubkey:a.marketQuoteVault}),A({pubkey:a.marketAuthority,isWritable:!1}),A({pubkey:n.lpTokenAccount}),A({pubkey:n.baseTokenAccount}),A({pubkey:n.quoteTokenAccount}),A({pubkey:n.owner,isWritable:!1,isSigner:!0}),A({pubkey:a.marketEventQueue}),A({pubkey:a.marketBids}),A({pubkey:a.marketAsks})),new kn({programId:a.programId,keys:l,data:u})}return new kn({programId:a.programId,keys:[]})}function Ta({programId:r,ammId:e,ammAuthority:t,ammOpenOrders:n,lpMint:o,coinMint:i,pcMint:s,coinVault:a,pcVault:c,withdrawQueue:u,ammTargetOrders:l,poolTempLp:d,marketProgramId:m,marketId:p,userWallet:y,userCoinVault:f,userPcVault:b,userLpVault:g,nonce:w,openTime:k,coinAmount:h,pcAmount:x,ammConfigId:T,feeDestinationId:B}){let S=O([F("instruction"),F("nonce"),P("openTime"),P("pcAmount"),P("coinAmount")]),I=[{pubkey:ho,isSigner:!1,isWritable:!1},{pubkey:df,isSigner:!1,isWritable:!1},{pubkey:Yc.programId,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:T,isSigner:!1,isWritable:!1},{pubkey:B,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!0,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0}],K=Buffer.alloc(S.span);return S.encode({instruction:1,nonce:w,openTime:k,coinAmount:h,pcAmount:x},K),{instruction:new kn({keys:I,programId:r,data:K}),instructionType:V.AmmV4CreatePool}}function KI(r){let e=O([F("instruction"),F("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[A({pubkey:new xe(r.id),isWritable:!1}),A({pubkey:new xe(r.authority),isWritable:!1}),A({pubkey:new xe(r.openOrders),isWritable:!1}),A({pubkey:new xe(r.vault.A),isWritable:!1}),A({pubkey:new xe(r.vault.B),isWritable:!1}),A({pubkey:new xe(r.mintLp.address),isWritable:!1}),A({pubkey:new xe(r.marketId),isWritable:!1}),A({pubkey:new xe(r.marketEventQueue),isWritable:!1})];return new kn({programId:new xe(r.programId),keys:n,data:t})}function pf({poolKeys:r,userKeys:e,amountIn:t,minAmountOut:n},o){let i=Le(r),s=Buffer.alloc(ba.span);ba.encode({instruction:9,amountIn:Z(t),minAmountOut:Z(n)},s);let a=[A({pubkey:ho,isWritable:!1}),A({pubkey:i.id}),A({pubkey:i.authority,isWritable:!1}),A({pubkey:i.openOrders})];return o===4&&a.push(A({pubkey:i.targetOrders})),a.push(A({pubkey:i.vault.A}),A({pubkey:i.vault.B})),o===5&&a.push(A({pubkey:ko})),a.push(A({pubkey:i.marketProgramId,isWritable:!1}),A({pubkey:i.marketId}),A({pubkey:i.marketBids}),A({pubkey:i.marketAsks}),A({pubkey:i.marketEventQueue}),A({pubkey:i.marketBaseVault}),A({pubkey:i.marketQuoteVault}),A({pubkey:i.marketAuthority,isWritable:!1}),A({pubkey:e.tokenAccountIn}),A({pubkey:e.tokenAccountOut}),A({pubkey:e.owner,isWritable:!1,isSigner:!0})),new kn({programId:i.programId,keys:a,data:s})}function ff({poolKeys:r,userKeys:e,maxAmountIn:t,amountOut:n},o){let i=Le(r),s=Buffer.alloc(ga.span);ga.encode({instruction:11,maxAmountIn:Z(t),amountOut:Z(n)},s);let a=[A({pubkey:ho,isWritable:!1}),A({pubkey:i.id}),A({pubkey:i.authority,isWritable:!1}),A({pubkey:i.openOrders}),A({pubkey:i.targetOrders}),A({pubkey:i.vault.A}),A({pubkey:i.vault.B})];return o===5&&a.push(A({pubkey:ko})),a.push(A({pubkey:i.marketProgramId,isWritable:!1}),A({pubkey:i.marketId}),A({pubkey:i.marketBids}),A({pubkey:i.marketAsks}),A({pubkey:i.marketEventQueue}),A({pubkey:i.marketBaseVault}),A({pubkey:i.marketQuoteVault}),A({pubkey:i.marketAuthority,isWritable:!1}),A({pubkey:e.tokenAccountIn}),A({pubkey:e.tokenAccountOut}),A({pubkey:e.owner,isWritable:!1,isSigner:!0})),new kn({programId:i.programId,keys:a,data:s})}function Nr(r){let{poolKeys:e,version:t,userKeys:n,amountIn:o,amountOut:i,fixedSide:s}=r;if(t===4||t===5){let a={poolKeys:e,userKeys:n};if(s==="in")return pf({...a,amountIn:o,minAmountOut:i},t);if(s==="out")return ff({...a,maxAmountIn:o,amountOut:i},t);jc.logWithError("invalid params","params",r)}throw jc.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}function CI({poolKeys:r,userKeys:e,startTime:t}){let n=Buffer.alloc(Aa.span);Aa.encode({instruction:0,nonce:5,startTime:Z(t)},n);let o=Le(r),i=[A({pubkey:ho,isWritable:!1}),A({pubkey:Yc.programId,isWritable:!1}),A({pubkey:mf,isWritable:!1}),A({pubkey:o.id}),A({pubkey:o.authority,isWritable:!1}),A({pubkey:o.openOrders}),A({pubkey:o.mintLp.address}),A({pubkey:o.mintA.address,isWritable:!1}),A({pubkey:o.mintB.address,isWritable:!1}),A({pubkey:o.vault.A,isWritable:!1}),A({pubkey:o.vault.B,isWritable:!1}),A({pubkey:o.id}),A({pubkey:o.targetOrders}),A({pubkey:e.lpTokenAccount}),A({pubkey:o.id,isWritable:!1}),A({pubkey:o.marketProgramId,isWritable:!1}),A({pubkey:o.marketId,isWritable:!1}),A({pubkey:e.payer,isSigner:!0})];return new kn({programId:o.programId,keys:i,data:n})}function $c({poolKeys:r}){let e=O([F("instruction"),F("simulateType")]),t=Buffer.alloc(e.span);e.encode({instruction:12,simulateType:0},t);let n=[A({pubkey:new xe(r.id),isWritable:!1}),A({pubkey:new xe(r.authority),isWritable:!1}),A({pubkey:new xe(r.openOrders),isWritable:!1}),A({pubkey:new xe(r.vault.A),isWritable:!1}),A({pubkey:new xe(r.vault.B),isWritable:!1}),A({pubkey:new xe(r.mintLp.address),isWritable:!1}),A({pubkey:new xe(r.marketId),isWritable:!1}),A({pubkey:new xe(r.marketEventQueue),isWritable:!1})];return{instruction:new kn({programId:new xe(r.programId),keys:n,data:t})}}import{PublicKey as gi}from"@solana/web3.js";import bi from"bn.js";import{TOKEN_PROGRAM_ID as gf}from"@solana/spl-token";import{PublicKey as yf}from"@solana/web3.js";var bf=de("Raydium_liquidity_serum");function Jc({programId:r,marketId:e}){let t=[e.toBuffer()],n=0,o;for(;n<100;){try{let i=t.concat(Buffer.from([n]),Buffer.alloc(7));o=yf.createProgramAddressSync(i,r)}catch(i){if(i instanceof TypeError)throw i;n++;continue}return{publicKey:o,nonce:n}}throw bf.logWithError("unable to find a viable program address nonce","params",{programId:r,marketId:e}),new Error("unable to find a viable program address nonce")}function Or({programId:r}){let{publicKey:e}=ee([Buffer.from("amm_config_account_seed","utf-8")],r);return e}function Zn({name:r,programId:e,marketId:t}){let{publicKey:n}=ee([e.toBuffer(),t.toBuffer(),Buffer.from(r,"utf-8")],e);return n}function Af({programId:r,marketId:e}){let{publicKey:t}=ee([r.toBuffer(),e.toBuffer(),Buffer.from("open_order_associated_seed","utf-8")],r);return t}function xa({programId:r}){return ee([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],r)}function Sa({version:r,marketVersion:e,marketId:t,baseMint:n,quoteMint:o,baseDecimals:i,quoteDecimals:s,programId:a,marketProgramId:c}){let u=Zn({name:"amm_associated_seed",programId:a,marketId:t}),l=Zn({name:"lp_mint_associated_seed",programId:a,marketId:t}),{publicKey:d,nonce:m}=xa({programId:a}),p=Zn({name:"coin_vault_associated_seed",programId:a,marketId:t}),y=Zn({name:"pc_vault_associated_seed",programId:a,marketId:t}),f=Zn({name:"temp_lp_token_associated_seed",programId:a,marketId:t}),b=Af({programId:a,marketId:t}),g=Zn({name:"target_associated_seed",programId:a,marketId:t}),w=Zn({name:"withdraw_associated_seed",programId:a,marketId:t}),{publicKey:k}=Jc({programId:c,marketId:t});return{id:u,baseMint:n,quoteMint:o,lpMint:l,baseDecimals:i,quoteDecimals:s,lpDecimals:i,version:r,programId:a,authority:d,nonce:m,baseVault:p,quoteVault:y,lpVault:f,openOrders:b,targetOrders:g,withdrawQueue:w,marketVersion:e,marketProgramId:c,marketId:t,marketAuthority:k,lookupTableAccount:gi.default,configId:Or({programId:a})}}var Ia;async function JI({connection:r,poolKeysList:e,config:t}){return e.find(o=>o.modelDataAccount)&&(Ia||(Ia=new wo({connection:r}),await Ia.initStableModelLayout())),await Promise.all(e.map(async o=>{if(o.modelDataAccount){let i=$c({poolKeys:o});return(await Ku(r,[i.instruction],"GetPoolData")).map(c=>{let u=Cu(c,"GetPoolData"),l=new bi(yn(u,"status")),d=Number(yn(u,"coin_decimals")),m=Number(yn(u,"pc_decimals")),p=Number(yn(u,"lp_decimals")),y=new bi(yn(u,"pool_coin_amount")),f=new bi(yn(u,"pool_pc_amount")),b=new bi(yn(u,"pool_lp_supply")),g="0";try{g=yn(u,"pool_open_time")}catch{}return{status:l,baseDecimals:d,quoteDecimals:m,lpDecimals:p,baseReserve:y,quoteReserve:f,lpSupply:b,startTime:new bi(g)}})[0]}else{let[i,s,a,c]=await r.getMultipleAccountsInfo([new gi(o.id),new gi(o.vault.A),new gi(o.vault.B),new gi(o.mintLp.address)]);if(i===null)throw Error("fetch pool error");if(s===null)throw Error("fetch vaultAccA error");if(a===null)throw Error("fetch vaultAccB error");if(c===null)throw Error("fetch mintAccLp error");let u=Hn.decode(i.data),l=Zt.decode(s.data),d=Zt.decode(a.data),m=Wc.decode(c.data);return{status:u.status,baseDecimals:u.baseDecimal.toNumber(),quoteDecimals:u.quoteDecimal.toNumber(),lpDecimals:m.decimals,baseReserve:l.amount.sub(u.baseNeedTakePnl),quoteReserve:d.amount.sub(u.quoteNeedTakePnl),lpSupply:u.lpReserve,startTime:u.poolOpenTime}}}))}var Ba={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]},vr=r=>{let e={},t=gf.toBase58();return Object.keys(r).map(n=>{let o=r[n],[i,s]=[o.baseMint.toBase58(),o.quoteMint.toBase58()];e[n]={id:n,version:4,status:o.status.toNumber(),programId:o.programId.toBase58(),mintA:pt({address:i,programId:t,decimals:o.baseDecimal.toNumber()}),mintB:pt({address:s,programId:t,decimals:o.quoteDecimal.toNumber()}),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:o.poolPrice.toNumber(),mintAmountA:new C(o.mintAAmount.toString()).div(10**o.baseDecimal.toNumber()).toNumber(),mintAmountB:new C(o.mintBAmount.toString()).div(10**o.quoteDecimal.toNumber()).toNumber(),baseReserve:o.baseReserve,quoteReserve:o.quoteReserve,feeRate:new C(o.tradeFeeNumerator.toString()).div(o.tradeFeeDenominator.toString()).toNumber(),openTime:o.poolOpenTime.toString(),tvl:0,day:Ba,week:Ba,month:Ba,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,type:"Standard",marketId:o.marketId.toBase58(),configId:Or({programId:o.programId}).toBase58(),lpPrice:0,lpAmount:new C(o.lpReserve.toString()).div(10**Math.min(o.baseDecimal.toNumber(),o.quoteDecimal.toNumber())).toNumber(),lpMint:pt({address:o.lpMint.toBase58(),programId:t,decimals:Math.min(o.baseDecimal.toNumber(),o.quoteDecimal.toNumber())}),burnPercent:0}}),e};import Ve from"bn.js";import{PublicKey as Ai}from"@solana/web3.js";import Pi from"bn.js";import{TOKEN_PROGRAM_ID as ol}from"@solana/spl-token";import{SystemProgram as $n,SYSVAR_RENT_PUBKEY as wf,Transaction as el,TransactionInstruction as kf}from"@solana/web3.js";import{createInitializeAccountInstruction as tl,TOKEN_PROGRAM_ID as nl}from"@solana/spl-token";function Pf(r="accountFlags"){let e=new wr(r);return e.addBoolean("initialized"),e.addBoolean("market"),e.addBoolean("openOrders"),e.addBoolean("requestQueue"),e.addBoolean("eventQueue"),e.addBoolean("bids"),e.addBoolean("asks"),e}var Ka=O([ke(5),Pf("accountFlags"),L("ownAddress"),P("vaultSignerNonce"),L("baseMint"),L("quoteMint"),L("baseVault"),P("baseDepositsTotal"),P("baseFeesAccrued"),L("quoteVault"),P("quoteDepositsTotal"),P("quoteFeesAccrued"),P("quoteDustThreshold"),L("requestQueue"),L("eventQueue"),L("bids"),L("asks"),P("baseLotSize"),P("quoteLotSize"),P("feeRateBps"),P("referrerRebatesAccrued"),ke(7)]);function hf({programId:r,marketInfo:e}){let t=O([F("version"),rt("instruction"),P("baseLotSize"),P("quoteLotSize"),jt("feeRateBps"),P("vaultSignerNonce"),P("quoteDustThreshold")]),n=[{pubkey:e.id,isSigner:!1,isWritable:!0},{pubkey:e.requestQueue,isSigner:!1,isWritable:!0},{pubkey:e.eventQueue,isSigner:!1,isWritable:!0},{pubkey:e.bids,isSigner:!1,isWritable:!0},{pubkey:e.asks,isSigner:!1,isWritable:!0},{pubkey:e.baseVault,isSigner:!1,isWritable:!0},{pubkey:e.quoteVault,isSigner:!1,isWritable:!0},{pubkey:e.baseMint,isSigner:!1,isWritable:!1},{pubkey:e.quoteMint,isSigner:!1,isWritable:!1},{pubkey:e.authority?e.quoteMint:wf,isSigner:!1,isWritable:!1}].concat(e.authority?{pubkey:e.authority,isSigner:!1,isWritable:!1}:[]).concat(e.authority&&e.pruneAuthority?{pubkey:e.pruneAuthority,isSigner:!1,isWritable:!1}:[]),o=Buffer.alloc(t.span);return t.encode({version:0,instruction:0,baseLotSize:e.baseLotSize,quoteLotSize:e.quoteLotSize,feeRateBps:e.feeRateBps,vaultSignerNonce:e.vaultSignerNonce,quoteDustThreshold:e.quoteDustThreshold},o),new kf({keys:n,programId:r,data:o})}async function Mr({connection:r,wallet:e,marketInfo:t}){let n=new el,o=await r.getMinimumBalanceForRentExemption(165);n.add($n.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.baseVault.seed,newAccountPubkey:t.baseVault.publicKey,lamports:o,space:165,programId:nl}),$n.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.quoteVault.seed,newAccountPubkey:t.quoteVault.publicKey,lamports:o,space:165,programId:nl}),tl(t.baseVault.publicKey,t.baseMint,t.vaultOwner),tl(t.quoteVault.publicKey,t.quoteMint,t.vaultOwner),$n.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.id.seed,newAccountPubkey:t.id.publicKey,lamports:await r.getMinimumBalanceForRentExemption(Ka.span),space:Ka.span,programId:t.programId}));let i=new el;return i.add($n.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.requestQueue.seed,newAccountPubkey:t.requestQueue.publicKey,lamports:t.lowestFeeMarket?6208320:await r.getMinimumBalanceForRentExemption(t.requestQueueSpace??5120+12),space:t.lowestFeeMarket?764:t.requestQueueSpace??5120+12,programId:t.programId}),$n.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.eventQueue.seed,newAccountPubkey:t.eventQueue.publicKey,lamports:t.lowestFeeMarket?79594560:await r.getMinimumBalanceForRentExemption(t.eventQueueSpace??262144+12),space:t.lowestFeeMarket?11308:t.eventQueueSpace??262144+12,programId:t.programId}),$n.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.bids.seed,newAccountPubkey:t.bids.publicKey,lamports:t.lowestFeeMarket?101977920:await r.getMinimumBalanceForRentExemption(t.orderbookQueueSpace??65536+12),space:t.lowestFeeMarket?14524:t.orderbookQueueSpace??65536+12,programId:t.programId}),$n.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.asks.seed,newAccountPubkey:t.asks.publicKey,lamports:t.lowestFeeMarket?101977920:await r.getMinimumBalanceForRentExemption(t.orderbookQueueSpace??65536+12),space:t.lowestFeeMarket?14524:t.orderbookQueueSpace??65536+12,programId:t.programId}),hf({programId:t.programId,marketInfo:{id:t.id.publicKey,requestQueue:t.requestQueue.publicKey,eventQueue:t.eventQueue.publicKey,bids:t.bids.publicKey,asks:t.asks.publicKey,baseVault:t.baseVault.publicKey,quoteVault:t.quoteVault.publicKey,baseMint:t.baseMint,quoteMint:t.quoteMint,baseLotSize:t.baseLotSize,quoteLotSize:t.quoteLotSize,feeRateBps:t.feeRateBps,vaultSignerNonce:t.vaultSignerNonce,quoteDustThreshold:t.quoteDustThreshold}})),[{transaction:n,signer:[],instructionTypes:[V.CreateAccount,V.CreateAccount,V.InitAccount,V.InitAccount]},{transaction:i,signer:[],instructionTypes:[V.CreateAccount,V.CreateAccount,V.CreateAccount,V.CreateAccount,V.CreateAccount,V.InitMarket]}]}var To=class extends Re{async create({baseInfo:e,quoteInfo:t,lotSize:n,tickSize:o,dexProgramId:i,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u,assignSeed:l,txVersion:d,computeBudgetConfig:m,txTipConfig:p,feePayer:y}){let f=this.scope.ownerPubKey,b=l?`${e.mint.toBase58().slice(0,10)}-${t.mint.toBase58().slice(0,10)}-${l}`:void 0,g=We({fromPublicKey:f,programId:i,assignSeed:b&&`${b}-market`}),w=We({fromPublicKey:f,programId:i,assignSeed:b&&`${b}-request`}),k=We({fromPublicKey:f,programId:i,assignSeed:b&&`${b}-event`}),h=We({fromPublicKey:f,programId:i,assignSeed:b&&`${b}-bids`}),x=We({fromPublicKey:f,programId:i,assignSeed:b&&`${b}-asks`}),T=We({fromPublicKey:f,programId:ol,assignSeed:b&&`${b}-baseVault`}),B=We({fromPublicKey:f,programId:ol,assignSeed:b&&`${b}-quoteVault`}),S=0,I=new Pi(100);function K(){let ne=new Pi(0);for(;;)try{return{vaultOwner:Ai.createProgramAddressSync([g.publicKey.toBuffer(),ne.toArrayLike(Buffer,"le",8)],i),vaultSignerNonce:ne}}catch{if(ne.iaddn(1),ne.gt(new Pi(25555)))throw Error("find vault owner error")}}let{vaultOwner:N,vaultSignerNonce:v}=K(),_=new Pi(Math.round(10**e.decimals*n)),D=new Pi(Math.round(n*10**t.decimals*o));if(_.eq(Tt))throw Error("lot size is too small");if(D.eq(Tt))throw Error("tick size or lot size is too small");let q=await Mr({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:i,id:g,baseMint:e.mint,quoteMint:t.mint,baseVault:T,quoteVault:B,vaultOwner:N,requestQueue:w,eventQueue:k,bids:h,asks:x,feeRateBps:S,quoteDustThreshold:I,vaultSignerNonce:v,baseLotSize:_,quoteLotSize:D,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u}}),G=this.createTxBuilder(y);G.addInstruction({instructions:q[0].transaction.instructions,signers:q[0].signer});for await(let ne of q.slice(1,q.length))G.addInstruction({instructions:ne.transaction.instructions,signers:ne.signer,instructionTypes:ne.instructionTypes});return d===0?G.sizeCheckBuildV0({computeBudgetConfig:m,address:{marketId:g.publicKey,requestQueue:w.publicKey,eventQueue:k.publicKey,bids:h.publicKey,asks:x.publicKey,baseVault:T.publicKey,quoteVault:B.publicKey,baseMint:new Ai(e.mint),quoteMint:new Ai(t.mint)}}):G.sizeCheckBuild({computeBudgetConfig:m,address:{marketId:g.publicKey,requestQueue:w.publicKey,eventQueue:k.publicKey,bids:h.publicKey,asks:x.publicKey,baseVault:T.publicKey,quoteVault:B.publicKey,baseMint:new Ai(e.mint),quoteMint:new Ai(t.mint)}})}};var wi=class extends Re{stableLayout;constructor(e){super(e),this.stableLayout=new wo({connection:this.scope.connection})}async initLayout(){await this.stableLayout.initStableModelLayout()}async load(){this.checkDisabled()}computePairAmount({poolInfo:e,amount:t,slippage:n,baseIn:o}){let i=new Ve(new C(t).mul(10**e[o?"mintA":"mintB"].decimals).toFixed(0)),s=Lr(e[o?"mintB":"mintA"]),[a,c]=[new Ve(new C(e.mintAmountA).mul(10**e.mintA.decimals).toString()),new Ve(new C(e.mintAmountB).mul(10**e.mintB.decimals).toString())],u=new Ve(new C(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,C.ROUND_DOWN));this.logDebug("baseReserve:",a.toString(),"quoteReserve:",c.toString()),this.logDebug("tokenIn:",o?e.mintA.symbol:e.mintB.symbol,"amountIn:",i.toString(),"anotherToken:",o?e.mintB.symbol:e.mintA.symbol,"slippage:",`${n.toSignificant()}%`,"baseReserve",a.toString(),"quoteReserve",c.toString());let l=o?"base":"quote";this.logDebug("input side:",l);let d=Tt;i.isZero()||(d=l==="base"?Ji(i.mul(c),a):Ji(i.mul(a),c)),this.logDebug("amountRaw:",d.toString(),"lpAmount:",u.toString());let m=Ji(i.mul(u),l==="base"?a:c);this.logDebug("liquidity:",m.toString());let p=new tt(new Ve(1)).add(n),y=new tt(new Ve(1)).sub(n),f=p.mul(d).quotient,b=y.mul(d).quotient,g=new he(s,d),w=new he(s,f),k=new he(s,b);return this.logDebug("anotherAmount:",g.toFixed(),"maxAnotherAmount:",w.toFixed()),{anotherAmount:g,maxAnotherAmount:w,minAnotherAmount:k,liquidity:m}}async getAmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async addLiquidity(e){let{poolInfo:t,poolKeys:n,amountInA:o,amountInB:i,otherAmountMin:s,fixedSide:a,config:c,txVersion:u,computeBudgetConfig:l,txTipConfig:d,feePayer:m}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),this.logDebug("amountInA:",o,"amountInB:",i),(o.isZero()||i.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:o.toFixed(),amountInB:i.toFixed()});let{account:p}=this.scope,{bypassAssociatedCheck:y,checkCreateATAOwner:f}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...c},[b,g]=[o.token,i.token],w=await p.getCreatedTokenAccount({mint:b.mint,associatedOnly:!1}),k=await p.getCreatedTokenAccount({mint:g.mint,associatedOnly:!1});!w&&!k&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",p.tokenAccounts);let h=await p.getCreatedTokenAccount({mint:new Ue(t.lpMint.address)}),x=[b,g],T=[w,k],B=[o.raw,i.raw],S=o.token.mint.toBase58()===t.mintA.address?"base":"quote",I="base";["quote","base"].includes(S)||this.logAndCreateError("invalid fixedSide","fixedSide",a),S==="quote"?(x.reverse(),T.reverse(),B.reverse(),I=a==="a"?"quote":"base"):S==="base"&&(I=a==="a"?"base":"quote");let[K,N]=x,[v,_]=T,[D,q]=B,G=n??await this.getAmmPoolKeys(t.id),ne=this.createTxBuilder(m),{tokenAccount:ie,...me}=await p.handleTokenAccount({side:"in",amount:D,mint:K.mint,tokenAccount:v,bypassAssociatedCheck:y,checkCreateATAOwner:f});ne.addInstruction(me);let{tokenAccount:re,...fe}=await p.handleTokenAccount({side:"in",amount:q,mint:N.mint,tokenAccount:_,bypassAssociatedCheck:y,checkCreateATAOwner:f});ne.addInstruction(fe);let{tokenAccount:at,...ze}=await p.handleTokenAccount({side:"out",amount:0,mint:new Ue(t.lpMint.address),tokenAccount:h,bypassAssociatedCheck:y,checkCreateATAOwner:f});return ne.addInstruction(ze),ne.addInstruction({instructions:[Zc({poolInfo:t,poolKeys:G,userKeys:{baseTokenAccount:ie,quoteTokenAccount:re,lpTokenAccount:at,owner:this.scope.ownerPubKey},baseAmountIn:D,quoteAmountIn:q,otherAmountMin:s.raw,fixedSide:I})],instructionTypes:[t.pooltype.includes("StablePool")?V.AmmV5AddLiquidity:V.AmmV4AddLiquidity],lookupTableAddress:G.lookupTableAccount?[G.lookupTableAccount]:[]}),ne.addCustomComputeBudget(l),ne.addTipInstruction(d),u===0?await ne.buildV0():ne.build()}async removeLiquidity(e){this.scope.availability.removeStandardPosition===!1&&this.logAndCreateError("remove liquidity feature disabled in your region");let{poolInfo:t,poolKeys:n,lpAmount:o,baseAmountMin:i,quoteAmountMin:s,config:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:d}=e,m=n??await this.getAmmPoolKeys(t.id),[p,y,f]=[new Ue(t.mintA.address),new Ue(t.mintB.address),new Ue(t.lpMint.address)];this.logDebug("lpAmount:",o),this.logDebug("baseAmountMin:",i),this.logDebug("quoteAmountMin:",s),o.isZero()&&this.logAndCreateError("amount must greater than zero","lpAmount",o.toString());let{account:b}=this.scope,g=await b.getCreatedTokenAccount({mint:f,associatedOnly:!1});g||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",b.tokenAccounts);let w=await b.getCreatedTokenAccount({mint:p}),k=await b.getCreatedTokenAccount({mint:y}),h=this.createTxBuilder(d),{bypassAssociatedCheck:x,checkCreateATAOwner:T}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...a},{tokenAccount:B,...S}=await b.handleTokenAccount({side:"out",amount:0,mint:p,tokenAccount:w,bypassAssociatedCheck:x,checkCreateATAOwner:T});h.addInstruction(S);let{tokenAccount:I,...K}=await b.handleTokenAccount({side:"out",amount:0,mint:y,tokenAccount:k,bypassAssociatedCheck:x,checkCreateATAOwner:T});return h.addInstruction(K),h.addInstruction({instructions:[ha({poolInfo:t,poolKeys:m,userKeys:{lpTokenAccount:g,baseTokenAccount:B,quoteTokenAccount:I,owner:this.scope.ownerPubKey},lpAmount:o,baseAmountMin:i,quoteAmountMin:s})],lookupTableAddress:m.lookupTableAccount?[m.lookupTableAccount]:[],instructionTypes:[t.pooltype.includes("StablePool")?V.AmmV5RemoveLiquidity:V.AmmV4RemoveLiquidity]}),h.addCustomComputeBudget(u),h.addTipInstruction(l),c===0?await h.buildV0():h.build()}async removeAllLpAndCreateClmmPosition({poolInfo:e,clmmPoolInfo:t,removeLpAmount:n,createPositionInfo:o,farmInfo:i,userFarmLpAmount:s,base:a,computeBudgetConfig:c,payer:u,userAuxiliaryLedgers:l,tokenProgram:d=En,checkCreateATAOwner:m=!0,getEphemeralSigners:p,txVersion:y,feePayer:f}){if((this.scope.availability.removeStandardPosition===!1||this.scope.availability.createConcentratedPosition===!1)&&this.logAndCreateError("remove liquidity or create position feature disabled in your region"),!(e.mintA.address===t.mintA.address||e.mintA.address===t.mintB.address)||!(e.mintB.address===t.mintA.address||e.mintB.address===t.mintB.address))throw Error("mint check error");let b=this.createTxBuilder(f),g={};for(let G of this.scope.account.tokenAccountRawInfos)(g[G.accountInfo.mint.toString()]===void 0||Y(this.scope.ownerPubKey,G.accountInfo.mint,En).publicKey.equals(G.pubkey))&&(g[G.accountInfo.mint.toString()]=G.pubkey);let w=g[e.lpMint.address];if(w===void 0)throw Error("find lp account error in trade accounts");let k=n.add(s??new Ve(0)),h=e.mintA.address===Me.WSOL.mint.toString(),x=e.mintB.address===Me.WSOL.mint.toString(),{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:En,mint:new Ue(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:h?{payer:this.scope.ownerPubKey}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:!0,checkCreateATAOwner:m});if(b.addInstruction(B||{}),T===void 0)throw new Error("base token account not found");let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:En,mint:new Ue(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:x?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:!0,checkCreateATAOwner:m});if(b.addInstruction(I||{}),S===void 0)throw new Error("quote token account not found");if(g[e.mintA.address]=T,g[e.mintB.address]=S,i!==void 0&&!s?.isZero()){let G=Mt[i.programId],ne=mt({programId:new Ue(i.programId),poolId:new Ue(i.id),owner:this.scope.ownerPubKey,version:G}),ie,me=await this.scope.connection.getAccountInfo(ne);if(me&&(ie=Ao(G).decode(me.data)),G!==6&&!ie){let{instruction:Ct,instructionType:Jt}=ei({id:new Ue(i.id),programId:new Ue(i.programId),version:G,ledger:ne,owner:this.scope.ownerPubKey});b.addInstruction({instructions:[Ct],instructionTypes:[Jt]})}let re=[];for(let Ct of i.rewardInfos){let Jt=Ct.mint.address===Me.WSOL.mint.toString();if(g[Ct.mint.address])re.push(g[Ct.mint.address]);else{let{account:dn,instructionParams:ut}=await this.scope.account.getOrCreateTokenAccount({mint:new Ue(Ct.mint.address),tokenProgram:d,owner:this.scope.ownerPubKey,skipCloseAccount:!Jt,createInfo:{payer:u||this.scope.ownerPubKey},associatedOnly:!0,checkCreateATAOwner:m});dn||this.logAndCreateError("farm reward account not found:",Ct.mint.address),ut&&b.addInstruction(ut),re.push(dn)}}let fe=(await this.scope.api.fetchFarmKeysById({ids:i.id}))[0],at={userAuxiliaryLedgers:l,amount:s,owner:this.scope.ownerPubKey,farmInfo:i,farmKeys:fe,lpAccount:w,rewardAccounts:re},ze=Mt[i.programId],Ze=ze===6?ti(at):ze===5?ni(at):oi(at),wt={3:V.FarmV3Withdraw,5:V.FarmV5Withdraw,6:V.FarmV6Withdraw};b.addInstruction({instructions:[Ze],instructionTypes:[wt[ze]]})}let K=await this.getAmmPoolKeys(e.id),N=ha({poolInfo:e,poolKeys:K,userKeys:{lpTokenAccount:w,baseTokenAccount:T,quoteTokenAccount:S,owner:this.scope.ownerPubKey},lpAmount:k,baseAmountMin:0,quoteAmountMin:0});b.addInstruction({instructions:[N],instructionTypes:[e.pooltype.includes("StablePool")?V.AmmV5RemoveLiquidity:V.AmmV4RemoveLiquidity],lookupTableAddress:K.lookupTableAccount?[K.lookupTableAccount]:[]});let[v,_]=e.mintA.address===t.mintA.address?[T,S]:[S,T],D=await this.scope.clmm.getClmmPoolKeys(t.id),q=await Be.openPositionFromBaseInstructions({poolInfo:t,poolKeys:D,ownerInfo:{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:v,tokenAccountB:_},withMetadata:"create",...o,base:a,getEphemeralSigners:p});return b.addInstruction({instructions:[...q.instructions],signers:q.signers,instructionTypes:[...q.instructionTypes],lookupTableAddress:D.lookupTableAccount?[D.lookupTableAccount]:[]}),y===0?b.sizeCheckBuildV0({computeBudgetConfig:c}):b.sizeCheckBuild({computeBudgetConfig:c})}async createPoolV4({programId:e,marketInfo:t,baseMintInfo:n,quoteMintInfo:o,baseAmount:i,quoteAmount:s,startTime:a,ownerInfo:c,associatedOnly:u=!1,checkCreateATAOwner:l=!1,tokenProgram:d,txVersion:m,feeDestinationId:p,computeBudgetConfig:y,txTipConfig:f,feePayer:b}){let g=c.feePayer||this.scope.owner?.publicKey,w=c.useSOLBalance&&n.mint.equals(Er),k=c.useSOLBalance&&o.mint.equals(Er),h=this.createTxBuilder(b),{account:x,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({mint:n.mint,owner:this.scope.ownerPubKey,createInfo:w?{payer:g,amount:i}:void 0,notUseTokenAccount:w,skipCloseAccount:!w,associatedOnly:w?!1:u,checkCreateATAOwner:l});h.addInstruction(T||{});let{account:B,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:o.mint,owner:this.scope.ownerPubKey,createInfo:k?{payer:g,amount:s}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:u,checkCreateATAOwner:l});if(h.addInstruction(S||{}),x===void 0||B===void 0)throw Error("you don't has some token account");let I=Sa({version:4,marketVersion:3,marketId:t.marketId,baseMint:n.mint,quoteMint:o.mint,baseDecimals:n.decimals,quoteDecimals:o.decimals,programId:e,marketProgramId:t.programId}),K={programId:e,ammId:I.id,ammAuthority:I.authority,ammOpenOrders:I.openOrders,lpMint:I.lpMint,coinMint:I.baseMint,pcMint:I.quoteMint,coinVault:I.baseVault,pcVault:I.quoteVault,withdrawQueue:I.withdrawQueue,ammTargetOrders:I.targetOrders,poolTempLp:I.lpVault,marketProgramId:I.marketProgramId,marketId:I.marketId,ammConfigId:I.configId,feeDestinationId:p},{instruction:N,instructionType:v}=Ta({...K,userWallet:this.scope.ownerPubKey,userCoinVault:x,userPcVault:B,userLpVault:Y(this.scope.ownerPubKey,I.lpMint,d).publicKey,nonce:I.nonce,openTime:a,coinAmount:i,pcAmount:s});return h.addInstruction({instructions:[N],instructionTypes:[v]}),h.addCustomComputeBudget(y),h.addTipInstruction(f),h.versionBuild({txVersion:m,extInfo:{address:K}})}async createMarketAndPoolV4({programId:e=Fo,marketProgram:t=Ss,feeDestinationId:n=Ru,tokenProgram:o,baseMintInfo:i,quoteMintInfo:s,baseAmount:a,quoteAmount:c,startTime:u,ownerInfo:l,lowestFeeMarket:d,assignSeed:m,associatedOnly:p=!1,checkCreateATAOwner:y=!1,lotSize:f=1,tickSize:b=.01,txVersion:g,computeBudgetConfig:w,txTipConfig:k,feePayer:h}){let x=this.scope.ownerPubKey,T=l.feePayer||this.scope.owner?.publicKey,B=l.useSOLBalance&&i.mint.equals(Er),S=l.useSOLBalance&&s.mint.equals(Er),I=m?`${i.mint.toBase58().slice(0,7)}-${s.mint.toBase58().slice(0,7)}-${m}`:void 0,K=We({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-market`}),N=We({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-request`}),v=We({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-event`}),_=We({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-bids`}),D=We({fromPublicKey:x,programId:t,assignSeed:I&&`${I}-asks`}),q=We({fromPublicKey:x,programId:En,assignSeed:I&&`${I}-baseVault`}),G=We({fromPublicKey:x,programId:En,assignSeed:I&&`${I}-quoteVault`}),ne=0,ie=new Ve(100);function me(){let en=new Ve(0);for(;;)try{return{vaultOwner:Ue.createProgramAddressSync([K.publicKey.toBuffer(),en.toArrayLike(Buffer,"le",8)],t),vaultSignerNonce:en}}catch{if(en.iaddn(1),en.gt(new Ve(25555)))throw Error("find vault owner error")}}let{vaultOwner:re,vaultSignerNonce:fe}=me(),at=new Ve(Math.round(10**i.decimals*f)),ze=new Ve(Math.round(f*10**s.decimals*b));if(at.eq(Tt))throw Error("lot size is too small");if(ze.eq(Tt))throw Error("tick size or lot size is too small");let Ze=await Mr({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:t,vaultOwner:re,baseMint:i.mint,quoteMint:s.mint,id:K,baseVault:q,quoteVault:G,requestQueue:N,eventQueue:v,bids:_,asks:D,feeRateBps:ne,quoteDustThreshold:ie,vaultSignerNonce:fe,baseLotSize:at,quoteLotSize:ze,lowestFeeMarket:d}}),wt=this.createTxBuilder(h);wt.addInstruction({instructions:Ze[0].transaction.instructions,signers:Ze[0].signer});for await(let en of Ze.slice(1,Ze.length))wt.addInstruction({instructions:en.transaction.instructions,signers:en.signer,instructionTypes:en.instructionTypes});let{account:Ct,instructionParams:Jt}=await this.scope.account.getOrCreateTokenAccount({mint:i.mint,owner:this.scope.ownerPubKey,createInfo:B?{payer:T,amount:a}:void 0,notUseTokenAccount:B,skipCloseAccount:!B,associatedOnly:B?!1:p,checkCreateATAOwner:y,assignSeed:B&&I?`${I}-wsol`:void 0});wt.addInstruction(Jt||{});let{account:dn,instructionParams:ut}=await this.scope.account.getOrCreateTokenAccount({mint:s.mint,owner:this.scope.ownerPubKey,createInfo:S?{payer:T,amount:c}:void 0,notUseTokenAccount:S,skipCloseAccount:!S,associatedOnly:S?!1:p,checkCreateATAOwner:y,assignSeed:S&&I?`${I}-wsol`:void 0});if(wt.addInstruction(ut||{}),Ct===void 0)throw Error("you don't has base token account");if(dn===void 0)throw Error("you don't has quote token account");let $e=Sa({version:4,marketVersion:3,marketId:K.publicKey,baseMint:i.mint,quoteMint:s.mint,baseDecimals:i.decimals,quoteDecimals:s.decimals,programId:e,marketProgramId:t}),is={programId:e,ammId:$e.id,ammAuthority:$e.authority,ammOpenOrders:$e.openOrders,lpMint:$e.lpMint,coinMint:$e.baseMint,pcMint:$e.quoteMint,coinVault:$e.baseVault,pcVault:$e.quoteVault,withdrawQueue:$e.withdrawQueue,ammTargetOrders:$e.targetOrders,poolTempLp:$e.lpVault,marketProgramId:$e.marketProgramId,marketId:$e.marketId,ammConfigId:$e.configId,feeDestinationId:n},{instruction:Ml,instructionType:El}=Ta({...is,userWallet:this.scope.ownerPubKey,userCoinVault:Ct,userPcVault:dn,userLpVault:Y(this.scope.ownerPubKey,$e.lpMint,o).publicKey,nonce:$e.nonce,openTime:u,coinAmount:a,pcAmount:c});wt.addInstruction({instructions:[Ml],instructionTypes:[El]});let ja=B||S?[Jt?.instructions?.[0]||ut?.instructions?.[0]].filter(en=>!!en):void 0;return g===0?wt.sizeCheckBuildV0({computeBudgetConfig:w,splitIns:ja,address:{requestQueue:N.publicKey,eventQueue:v.publicKey,bids:_.publicKey,asks:D.publicKey,baseVault:q.publicKey,quoteVault:G.publicKey,baseMint:new Ue(i.mint),quoteMint:new Ue(s.mint),...is}}):wt.sizeCheckBuild({computeBudgetConfig:w,splitIns:ja,address:{requestQueue:N.publicKey,eventQueue:v.publicKey,bids:_.publicKey,asks:D.publicKey,baseVault:q.publicKey,quoteVault:G.publicKey,baseMint:new Ue(i.mint),quoteMint:new Ue(s.mint),...is}})}async getCreatePoolFee({programId:e}){let t=Or({programId:e}),n=await this.scope.connection.getAccountInfo(t,{dataSlice:{offset:536,length:8}});if(n===null)throw Error("get config account error");return Uc.decode(n.data).fee}computeAmountOut({poolInfo:e,amountIn:t,mintIn:n,mintOut:o,slippage:i}){let[s,a]=[n.toString(),o.toString()];if(s!==e.mintA.address&&s!==e.mintB.address)throw new Error("toke not match");if(a!==e.mintA.address&&a!==e.mintB.address)throw new Error("toke not match");let{baseReserve:c,quoteReserve:u}=e,l=[c,u],d=[e.mintA.decimals,e.mintB.decimals],m=s==e.mintA.address?"base":"quote";m==="quote"&&(l.reverse(),d.reverse());let[p,y]=l,[f,b]=d,g=e.version===4,w;if(g)w=new C(y.toString()).div(10**b).div(new C(p.toString()).div(10**f));else{let v=Hc(this.stableLayout.stableModelData,c.toNumber(),u.toNumber(),!1);m==="quote"?w=new C(1e6).div(v*1e6):w=new C(v*1e6).div(1e6)}let k=t,h=new Ve(0),x=new Ve(0);if(!k.isZero())if(g){x=Cn(k.mul(ya),Rr);let v=k.sub(x),_=p.add(v);h=y.mul(v).div(_)}else{x=k.mul(new Ve(2)).div(new Ve(1e4));let v=k.sub(x);m==="quote"?h=new Ve(Qc(this.stableLayout.stableModelData,u.toNumber(),c.toNumber(),v.toNumber())):h=new Ve(zc(this.stableLayout.stableModelData,u.toNumber(),c.toNumber(),v.toNumber()))}let T=new Ve(new C(h.toString()).mul(1-i).toFixed(0)),B=h,S=T,I=new C(h.toString()).div(new C(k.sub(x).toString()).toFixed(0));!k.isZero()&&!h.isZero()&&(I=new C(h.toString()).div(10**b).div(new C(k.sub(x).toString()).div(10**f)));let K=w.sub(I).div(w).mul(100);return{amountOut:B,minAmountOut:S,currentPrice:w,executionPrice:I,priceImpact:K,fee:x}}computeAmountIn({poolInfo:e,amountOut:t,mintIn:n,mintOut:o,slippage:i}){let{baseReserve:s,quoteReserve:a}=e;n.toString()!==e.mintA.address&&n.toString()!==e.mintB.address&&this.logAndCreateError("mintIn does not match pool"),o.toString()!==e.mintA.address&&o.toString()!==e.mintB.address&&this.logAndCreateError("mintOut does not match pool"),this.logDebug("baseReserve:",s.toString()),this.logDebug("quoteReserve:",a.toString());let c=n.toString()===e.mintA.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA];this.logDebug("currencyOut:",l.symbol||l.address),this.logDebug("amountOut:",new C(t.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString(),u.symbol||u.address),this.logDebug("slippage:",`${i*100}%`);let d=[s,a],m=c?"quote":"base";m==="base"&&d.reverse(),this.logDebug("output side:",m);let[p,y]=d,f=new C(y.toString()).div(10**e[c?"mintB":"mintA"].decimals).div(new C(p.toString()).div(10**e[c?"mintA":"mintB"].decimals));this.logDebug("currentPrice:",`1 ${u.symbol||u.address} \u2248 ${f.toString()} ${l.symbol||l.address}`),this.logDebug("currentPrice invert:",`1 ${l.symbol||l.address} \u2248 ${new C(1).div(f).toString()} ${u.symbol||u.address}`);let b=new Ve(0),g=t;if(!g.isZero()){g.gt(y)&&(g=y.sub(new Ve(1)));let S=y.sub(g);b=p.mul(g).div(S).mul(Rr).div(Rr.sub(ya))}let w=new Ve(new C(b.toString()).mul(1+i).toFixed(0)),k=b,h=w;this.logDebug("amountIn:",new C(k.toString()).div(10**u.decimals).toDecimalPlaces(u.decimals).toString()),this.logDebug("maxAmountIn:",new C(h.toString()).div(10**u.decimals).toDecimalPlaces(u.decimals).toString());let x=null;!b.isZero()&&!g.isZero()&&(x=new C(g.toString()).div(10**l.decimals).div(new C(b.toString()).div(10**u.decimals)),this.logDebug("executionPrice:",`1 ${l.symbol||l.address} \u2248 ${x.toDecimalPlaces(Math.max(e.mintA.decimals,e.mintB.decimals)).toString()} ${u.symbol||u.address}`),this.logDebug("executionPrice invert:",`1 ${l.symbol||l.address} \u2248 ${new C(1).div(x).toDecimalPlaces(Math.max(e.mintA.decimals,e.mintB.decimals)).toString()} ${u.symbol||u.address}`));let T=f.mul(k.toString()),B=T.sub(t.toString()).abs().div(T);return this.logDebug("priceImpact:",`${B.toString()}%`),{amountIn:k,maxAmountIn:h,currentPrice:f,executionPrice:x,priceImpact:B}}async swap({poolInfo:e,poolKeys:t,amountIn:n,amountOut:o,inputMint:i,fixedSide:s,txVersion:a,config:c,computeBudgetConfig:u,txTipConfig:l,feePayer:d}){let m=this.createTxBuilder(d),{associatedOnly:p=!0,inputUseSolBalance:y=!0,outputUseSolBalance:f=!0}=c||{},[b,g]=i===e.mintA.address?[e.mintA,e.mintB]:[e.mintB,e.mintA],w=y&&b.address===j.toBase58(),k=f&&g.address===j.toBase58(),{account:h,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:En,mint:new Ue(b.address),owner:this.scope.ownerPubKey,createInfo:w?{payer:this.scope.ownerPubKey,amount:n}:void 0,skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:p});m.addInstruction(x||{}),h||this.logAndCreateError("input token account not found",{token:b.symbol||b.address,tokenAccountIn:h,inputTokenUseSolBalance:w,associatedOnly:p});let{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:En,mint:new Ue(g.address),owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:k?!1:p});m.addInstruction(B||{}),T===void 0&&this.logAndCreateError("output token account not found",{token:g.symbol||g.address,tokenAccountOut:T,outputTokenUseSolBalance:k,associatedOnly:p});let S=t||await this.getAmmPoolKeys(e.id),I=4;return e.pooltype.includes("StablePool")&&(I=5),m.addInstruction({instructions:[Nr({version:I,poolKeys:S,userKeys:{tokenAccountIn:h,tokenAccountOut:T,owner:this.scope.ownerPubKey},amountIn:n,amountOut:o,fixedSide:s})],instructionTypes:[I===4?V.AmmV4SwapBaseIn:V.AmmV5SwapBaseIn]}),m.addCustomComputeBudget(u),m.addTipInstruction(l),m.versionBuild({txVersion:a})}async getRpcPoolInfo(e){return(await this.getRpcPoolInfos([e]))[e]}async getRpcPoolInfos(e,t){let n=await Se(this.scope.connection,e.map(u=>({pubkey:new Ue(u)})),t),o={},i=[];for(let u=0;u<e.length;u++){let l=n[u];if(l===null||!l.accountInfo)throw Error("fetch pool info error: "+String(e[u]));let d=Hn.decode(l.accountInfo.data);o[String(e[u])]={...d,programId:l.accountInfo.owner},i.push(d.baseVault,d.quoteVault)}let s={},a=await Se(this.scope.connection,i.map(u=>({pubkey:new Ue(u)})),t);for(let u=0;u<i.length;u++){let l=a[u].accountInfo;if(l===null)throw Error("fetch vault info error: "+i[u]);s[String(i[u])]=new Ve(Tf.decode(l.data).amount.toString())}let c={};for(let[u,l]of Object.entries(o)){let d=s[l.baseVault.toString()].sub(l.baseNeedTakePnl),m=s[l.quoteVault.toString()].sub(l.quoteNeedTakePnl);c[u]={...l,baseReserve:d,mintAAmount:s[l.baseVault.toString()],mintBAmount:s[l.quoteVault.toString()],quoteReserve:m,poolPrice:new C(m.toString()).div(new C(10).pow(l.quoteDecimal.toString())).div(new C(d.toString()).div(new C(10).pow(l.baseDecimal.toString())))}}return c}async getPoolInfoFromRpc({poolId:e}){let t=await this.getRpcPoolInfo(e),n=vr({[e]:t}),o=n[e],i=await this.scope.tradeV2.computePoolToPoolKeys({pools:[n[e]],ammRpcData:{[e]:t}});return{poolRpcData:t,poolInfo:o,poolKeys:i[0]}}};import{PublicKey as z}from"@solana/web3.js";import xt from"bn.js";import{AccountLayout as il,TOKEN_2022_PROGRAM_ID as _n,TOKEN_PROGRAM_ID as ki}from"@solana/spl-token";var hi=class extends Re{constructor(e){super(e)}async getClmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async createPool(e){let{programId:t,owner:n=this.scope.owner?.publicKey||z.default,mint1:o,mint2:i,ammConfig:s,initialPrice:a,computeBudgetConfig:c,forerunCreate:u,getObserveState:l,txVersion:d,txTipConfig:m,feePayer:p}=e,y=this.createTxBuilder(p),[f,b,g]=new xt(new z(o.address).toBuffer()).gt(new xt(new z(i.address).toBuffer()))?[i,o,new C(1).div(a)]:[o,i,a],w=te.priceToSqrtPriceX64(g,f.decimals,b.decimals),k=[],h=[];f.programId===_n.toBase58()&&h.push(la(t,new z(f.address)).publicKey),b.programId===_n.toBase58()&&h.push(la(t,new z(b.address)).publicKey),(await this.scope.connection.getMultipleAccountsInfo(h)).forEach((B,S)=>{B&&k.push(h[S])});let T=await Be.createPoolInstructions({connection:this.scope.connection,programId:t,owner:n,mintA:f,mintB:b,ammConfigId:s.id,initialPriceX64:w,forerunCreate:!l&&u,extendMintAccount:k});return y.addInstruction(T),y.addCustomComputeBudget(c),y.addTipInstruction(m),y.versionBuild({txVersion:d,extInfo:{address:{...T.address,observationId:T.address.observationId.toBase58(),exBitmapAccount:T.address.exBitmapAccount.toBase58(),programId:t.toString(),id:T.address.poolId.toString(),mintA:f,mintB:b,openTime:"0",vault:{A:T.address.mintAVault.toString(),B:T.address.mintBVault.toString()},rewardInfos:[],config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}},mockPoolInfo:{type:"Concentrated",rewardDefaultPoolInfos:"Clmm",id:T.address.poolId.toString(),mintA:f,mintB:b,feeRate:s.tradeFeeRate,openTime:"0",programId:t.toString(),price:g.toNumber(),config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]},burnPercent:0,...Tc},forerunCreate:u}})}async openPositionFromBase({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:i,base:s,baseAmount:a,otherAmountMax:c,nft2022:u,associatedOnly:l=!0,checkCreateATAOwner:d=!1,withMetadata:m="create",getEphemeralSigners:p,computeBudgetConfig:y,txTipConfig:f,txVersion:b,feePayer:g}){this.scope.availability.addConcentratedPosition===!1&&this.logAndCreateError("add position feature disabled in your region"),this.scope.checkOwner();let w=this.createTxBuilder(g),k=null,h=null,x=n.useSOLBalance&&e.mintA.address===j.toString(),T=n.useSOLBalance&&e.mintB.address===j.toString(),[B,S]=s==="MintA"?[a,c]:[c,a],{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new z(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:x||B.isZero()?{payer:this.scope.ownerPubKey,amount:B}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:x?!1:l,checkCreateATAOwner:d});I&&(k=I),w.addInstruction(K||{});let{account:N,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new z(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:T||S.isZero()?{payer:this.scope.ownerPubKey,amount:S}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:T?!1:l,checkCreateATAOwner:d});N&&(h=N),w.addInstruction(v||{}),(!k||!h)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",{ownerTokenAccountA:k?.toBase58(),ownerTokenAccountB:h?.toBase58()});let _=t||await this.getClmmPoolKeys(e.id),D=await Be.openPositionFromBaseInstructions({poolInfo:e,poolKeys:_,ownerInfo:{...n,feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:k,tokenAccountB:h},tickLower:o,tickUpper:i,base:s,baseAmount:a,otherAmountMax:c,withMetadata:m,getEphemeralSigners:p,nft2022:u});return w.addInstruction(D),w.addCustomComputeBudget(y),w.addTipInstruction(f),w.versionBuild({txVersion:b,extInfo:{...D.address}})}async openPositionFromLiquidity({poolInfo:e,poolKeys:t,ownerInfo:n,amountMaxA:o,amountMaxB:i,tickLower:s,tickUpper:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,withMetadata:d="create",txVersion:m,computeBudgetConfig:p,txTipConfig:y,getEphemeralSigners:f,nft2022:b,feePayer:g}){this.scope.availability.createConcentratedPosition===!1&&this.logAndCreateError("open position feature disabled in your region");let w=this.createTxBuilder(g),k=null,h=null,x=n.useSOLBalance&&e.mintA.address===j.toBase58(),T=n.useSOLBalance&&e.mintB.address===j.toBase58(),{account:B,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new z(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:x||o.isZero()?{payer:this.scope.ownerPubKey,amount:o}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:x?!1:u,checkCreateATAOwner:l});B&&(k=B),w.addInstruction(S||{});let{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new z(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:T||i.isZero()?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:T?!1:u,checkCreateATAOwner:l});I&&(h=I),w.addInstruction(K||{}),(k===void 0||h===void 0)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let N=t||await this.getClmmPoolKeys(e.id),v=await Be.openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:N,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:k,tokenAccountB:h},tickLower:s,tickUpper:a,liquidity:c,amountMaxA:o,amountMaxB:i,withMetadata:d,getEphemeralSigners:f,nft2022:b});return w.addInstruction(v),w.addCustomComputeBudget(p),w.addTipInstruction(y),w.versionBuild({txVersion:m,extInfo:{address:v.address}})}async increasePositionFromLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:o,amountMaxA:i,amountMaxB:s,liquidity:a,ownerInfo:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:d,txTipConfig:m,txVersion:p,feePayer:y}=e,f=this.createTxBuilder(y),b,g,w=c.useSOLBalance&&t.mintA.address===j.toString(),k=c.useSOLBalance&&t.mintB.address===j.toString(),{account:h,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,createInfo:w||i.isZero()?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!w,associatedOnly:w?!1:u,checkCreateATAOwner:l});h&&(b=h),f.addInstruction(x||{});let{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:k||s.isZero()?{payer:this.scope.ownerPubKey,amount:s}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:u,checkCreateATAOwner:l});T&&(g=T),f.addInstruction(B||{}),!b&&!g&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let S=n??await this.getClmmPoolKeys(t.id),I=Be.increasePositionFromLiquidityInstructions({poolInfo:t,poolKeys:S,ownerPosition:o,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g},liquidity:a,amountMaxA:i,amountMaxB:s,nft2022:(await this.scope.connection.getAccountInfo(o.nftMint))?.owner.equals(_n)});return f.addInstruction(I),f.addCustomComputeBudget(d),f.addTipInstruction(m),f.versionBuild({txVersion:p,extInfo:{address:I.address}})}async increasePositionFromBase(e){let{poolInfo:t,ownerPosition:n,base:o,baseAmount:i,otherAmountMax:s,ownerInfo:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:d,txVersion:m,feePayer:p}=e,y=this.createTxBuilder(p),f,b,g=a.useSOLBalance&&t.mintA.address===j.toString(),w=a.useSOLBalance&&t.mintB.address===j.toString(),{account:k,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:g||(o==="MintA"?i:s).isZero()?{payer:this.scope.ownerPubKey,amount:o==="MintA"?i:s}:void 0,skipCloseAccount:!g,associatedOnly:g?!1:c,checkCreateATAOwner:u});k&&(f=k),y.addInstruction(h||{});let{account:x,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:w||(o==="MintA"?s:i).isZero()?{payer:this.scope.ownerPubKey,amount:o==="MintA"?s:i}:void 0,notUseTokenAccount:w,skipCloseAccount:!w,associatedOnly:w?!1:c,checkCreateATAOwner:u});x&&(b=x),y.addInstruction(T||{}),!f&&!b&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let B=await this.getClmmPoolKeys(t.id),S=Be.increasePositionFromBaseInstructions({poolInfo:t,poolKeys:B,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:f,tokenAccountB:b},base:o,baseAmount:i,otherAmountMax:s,nft2022:(await this.scope.connection.getAccountInfo(n.nftMint))?.owner.equals(_n)});return y.addInstruction(S),y.addCustomComputeBudget(l),y.addTipInstruction(d),y.versionBuild({txVersion:m,extInfo:{address:S.address}})}async decreaseLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:o,ownerInfo:i,amountMinA:s,amountMinB:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:d,txTipConfig:m,txVersion:p,feePayer:y}=e;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let f=this.createTxBuilder(y),b=i.useSOLBalance&&t.mintA.address===j.toString(),g=i.useSOLBalance&&t.mintB.address===j.toString(),w,k,{account:h,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new z(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:l});w=h,x&&f.addInstruction(x);let{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new z(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!g,associatedOnly:g?!1:u,checkCreateATAOwner:l});k=T,B&&f.addInstruction(B);let S=[];for(let _ of t.rewardDefaultInfos){let D=i.useSOLBalance&&_.mint.address===j.toString(),q;if(_.mint.address===t.mintA.address)q=w;else if(_.mint.address===t.mintB.address)q=k;else{let{account:G,instructionParams:ne}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(_.mint.programId),mint:new z(_.mint.address),notUseTokenAccount:D,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!D,associatedOnly:D?!1:u,checkCreateATAOwner:l});q=G,ne&&f.addInstruction(ne)}S.push(q)}!w&&!k&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccountRawInfos);let I=n??await this.getClmmPoolKeys(t.id),K=(await this.scope.connection.getAccountInfo(o.nftMint))?.owner.equals(_n),N=await Be.decreaseLiquidityInstructions({poolInfo:t,poolKeys:I,ownerPosition:o,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:w,tokenAccountB:k,rewardAccounts:S},liquidity:c,amountMinA:s,amountMinB:a,nft2022:K});f.addInstruction({instructions:N.instructions,instructionTypes:[V.ClmmDecreasePosition]});let v={...N.address};if(i.closePosition){let _=await Be.closePositionInstructions({poolInfo:t,poolKeys:I,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:o,nft2022:K});f.addInstruction({endInstructions:_.instructions,endInstructionTypes:_.instructionTypes}),v={...v,..._.address}}return f.addCustomComputeBudget(d),f.addTipInstruction(m),f.versionBuild({txVersion:p,extInfo:{address:v}})}async lockPosition(e){let{programId:t=lo,authProgramId:n=Vo,poolProgramId:o=Kn,ownerPosition:i,payer:s,computeBudgetConfig:a,txTipConfig:c,txVersion:u,getEphemeralSigners:l,feePayer:d}=e,m=this.createTxBuilder(d),p=await Be.makeLockPositions({programId:t,authProgramId:n,poolProgramId:o,wallet:this.scope.ownerPubKey,payer:s??this.scope.ownerPubKey,nftMint:i.nftMint,getEphemeralSigners:l,nft2022:(await this.scope.connection.getAccountInfo(i.nftMint))?.owner.equals(_n)});return m.addInstruction(p),m.addCustomComputeBudget(a),m.addTipInstruction(c),m.versionBuild({txVersion:u,extInfo:p.address})}async harvestLockPosition(e){let{programId:t=lo,authProgramId:n=Vo,clmmProgram:o=Kn,poolKeys:i,lockData:s,ownerInfo:a={useSOLBalance:!0},associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:d,txVersion:m,feePayer:p}=e,y=i||await this.getClmmPoolKeys(s.poolId.toString()),f=this.createTxBuilder(p),b=await this.scope.connection.getAccountInfo(s.positionId);b||this.logger.logWithError("position not found",s.positionId);let g=pi.decode(b.data),w=a.useSOLBalance&&y.mintA.address===j.toString(),k=a.useSOLBalance&&y.mintB.address===j.toString(),h,x,{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.mintA.programId,mint:new z(y.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!w,associatedOnly:w?!1:c,checkCreateATAOwner:u});h=T,B&&f.addInstruction(B);let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.mintB.programId,mint:new z(y.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!k,associatedOnly:k?!1:c,checkCreateATAOwner:u});x=S,I&&f.addInstruction(I);let K={},N=[];for(let fe of y.rewardInfos){let at=a.useSOLBalance&&fe.mint.address===j.toString(),ze=K[fe.mint.address];if(!ze){let{account:Ze,instructionParams:wt}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(fe.mint.programId),mint:new z(fe.mint.address),notUseTokenAccount:at,owner:this.scope.ownerPubKey,skipCloseAccount:!at,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:at?!1:c});ze=Ze,wt&&f.addInstruction(wt)}K[fe.mint.address]=ze,N.push(ze)}let v=ci(t,s.lockNftMint).publicKey,_=Y(this.scope.ownerPubKey,s.lockNftMint,ki).publicKey,D=H.getTickArrayStartIndexByTick(g.tickLower,y.config.tickSpacing),q=H.getTickArrayStartIndexByTick(g.tickUpper,y.config.tickSpacing),{publicKey:G}=be(new z(y.programId),s.poolId,D),{publicKey:ne}=be(new z(y.programId),s.poolId,q),{publicKey:ie}=$t(new z(y.programId),s.poolId,g.tickLower,g.tickUpper),me=[];for(let fe=0;fe<y.rewardInfos.length;fe++)me.push({poolRewardVault:new z(y.rewardInfos[fe].vault),ownerRewardVault:N[fe],rewardMint:new z(y.rewardInfos[fe].mint.address)});let re=await Be.harvestLockPositionInstructionV2({programId:t,auth:n,lockPositionId:v,clmmProgram:o,lockOwner:this.scope.ownerPubKey,lockNftMint:s.lockNftMint,lockNftAccount:_,positionNftAccount:s.nftAccount,positionId:s.positionId,poolId:s.poolId,protocolPosition:ie,vaultA:new z(y.vault.A),vaultB:new z(y.vault.B),tickArrayLower:G,tickArrayUpper:ne,userVaultA:h,userVaultB:x,mintA:new z(y.mintA.address),mintB:new z(y.mintB.address),rewardAccounts:me,exTickArrayBitmap:De(o,s.poolId).publicKey});return f.addInstruction({instructions:[re],instructionTypes:[V.ClmmHarvestLockPosition]}),f.addCustomComputeBudget(l),f.addTipInstruction(d),f.versionBuild({txVersion:m})}async closePosition({poolInfo:e,poolKeys:t,ownerPosition:n,txVersion:o,computeBudgetConfig:i,txTipConfig:s,feePayer:a}){this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let c=this.createTxBuilder(a),u=t??await this.getClmmPoolKeys(e.id),l=Be.closePositionInstructions({poolInfo:e,poolKeys:u,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:n,nft2022:(await this.scope.connection.getAccountInfo(n.nftMint))?.owner.equals(_n)});return c.addCustomComputeBudget(i),c.addTipInstruction(s),c.addInstruction(l).versionBuild({txVersion:o,extInfo:{address:l.address}})}async initReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:o=!0,checkCreateATAOwner:i=!1,computeBudgetConfig:s,txVersion:a,feePayer:c}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(c),l=t.useSOLBalance&&n.mint.address.toString()===j.toString(),d=n.perSecond.mul(n.endTime-n.openTime),{account:m,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(n.mint.address),mint:new z(n.mint.address),notUseTokenAccount:!!l,skipCloseAccount:!l,owner:this.scope.ownerPubKey,createInfo:l?{payer:t.feePayer||this.scope.ownerPubKey,amount:new xt(new C(d.toFixed(0)).gte(d)?d.toFixed(0):d.add(1).toFixed(0))}:void 0,associatedOnly:l?!1:o,checkCreateATAOwner:i});p&&u.addInstruction(p),m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let y=await this.getClmmPoolKeys(e.id),f=Be.initRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardInfo:{programId:new z(n.mint.programId),mint:new z(n.mint.address),openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ae.decimalToX64(n.perSecond)}});return u.addInstruction(f),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:f.address}})}async initRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:o,associatedOnly:i=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){for(let p of o)p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let d=this.createTxBuilder(l),m={};for(let p of o){let y=n.useSOLBalance&&p.mint.address===j.toString(),f=p.perSecond.mul(p.endTime-p.openTime),{account:b,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(p.mint.programId),mint:new z(p.mint.address),notUseTokenAccount:!!y,skipCloseAccount:!y,owner:this.scope.ownerPubKey,createInfo:y?{payer:n.feePayer||this.scope.ownerPubKey,amount:new xt(new C(f.toFixed(0)).gte(f)?f.toFixed(0):f.add(1).toFixed(0))}:void 0,associatedOnly:y?!1:i,checkCreateATAOwner:s});g&&d.addInstruction(g),b||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let w=t??await this.getClmmPoolKeys(e.id),k=Be.initRewardInstructions({poolInfo:e,poolKeys:w,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:b},rewardInfo:{programId:new z(p.mint.programId),mint:new z(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:ae.decimalToX64(p.perSecond)}});m={...m,...k.address},d.addInstruction(k)}return d.addCustomComputeBudget(a),d.addTipInstruction(c),d.versionBuild({txVersion:u,extInfo:{address:m}})}async setReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:o=!0,checkCreateATAOwner:i=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let l=this.createTxBuilder(u),d=t.useSOLBalance&&n.mint.equals(j),{account:m,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n.programId,mint:n.mint,notUseTokenAccount:d,owner:this.scope.ownerPubKey,createInfo:d?{payer:t.feePayer||this.scope.ownerPubKey,amount:new xt(new C(n.perSecond.mul(n.endTime-n.openTime).toFixed(0)).gte(n.perSecond.mul(n.endTime-n.openTime))?n.perSecond.mul(n.endTime-n.openTime).toFixed(0):n.perSecond.mul(n.endTime-n.openTime).add(1).toFixed(0))}:void 0,associatedOnly:d?!1:o,checkCreateATAOwner:i});p&&l.addInstruction(p),m||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let y=await this.getClmmPoolKeys(e.id),f=Be.setRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:m},rewardInfo:{mint:n.mint,openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:ae.decimalToX64(n.perSecond)}});return l.addInstruction(f),l.addCustomComputeBudget(s),l.addTipInstruction(a),l.versionBuild({txVersion:c,extInfo:{address:f.address}})}async setRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:o,associatedOnly:i=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){let d=this.createTxBuilder(l),m={};for(let p of o){p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let y=n.useSOLBalance&&p.mint.address===j.toString(),{account:f,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(p.mint.programId),mint:new z(p.mint.address),notUseTokenAccount:y,owner:this.scope.ownerPubKey,createInfo:y?{payer:n.feePayer||this.scope.ownerPubKey,amount:new xt(new C(p.perSecond.mul(p.endTime-p.openTime).toFixed(0)).gte(p.perSecond.mul(p.endTime-p.openTime))?p.perSecond.mul(p.endTime-p.openTime).toFixed(0):p.perSecond.mul(p.endTime-p.openTime).add(1).toFixed(0))}:void 0,associatedOnly:y?!1:i,checkCreateATAOwner:s});b&&d.addInstruction(b),f||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let g=t??await this.getClmmPoolKeys(e.id),w=Be.setRewardInstructions({poolInfo:e,poolKeys:g,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:f},rewardInfo:{mint:new z(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:ae.decimalToX64(p.perSecond)}});d.addInstruction(w),m={...m,...w.address}}return d.addCustomComputeBudget(a),d.addTipInstruction(c),d.versionBuild({txVersion:u,extInfo:{address:m}})}async collectReward({poolInfo:e,ownerInfo:t,rewardMint:n,associatedOnly:o=!0,checkCreateATAOwner:i=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){let l=e.rewardDefaultInfos.find(g=>g.mint.address===n.toString());l||this.logAndCreateError("reward mint error","not found reward mint",n);let d=this.createTxBuilder(u),m=t.useSOLBalance&&n.equals(j),{account:p,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(l.mint.programId),mint:n,notUseTokenAccount:m,owner:this.scope.ownerPubKey,skipCloseAccount:!m,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:m?!1:o,checkCreateATAOwner:i});y&&d.addInstruction(y),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=await this.getClmmPoolKeys(e.id),b=Be.collectRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardMint:n});return d.addInstruction(b),d.addCustomComputeBudget(s),d.addTipInstruction(a),d.versionBuild({txVersion:c,extInfo:{address:b.address}})}async collectRewards({poolInfo:e,ownerInfo:t,rewardMints:n,associatedOnly:o=!0,checkCreateATAOwner:i=!1,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l={};for(let d of n){let m=e.rewardDefaultInfos.find(w=>w.mint.address===d.toString());if(!m){this.logAndCreateError("reward mint error","not found reward mint",d);continue}let p=t.useSOLBalance&&d.equals(j),{account:y,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(m.mint.programId),mint:d,notUseTokenAccount:p,owner:this.scope.ownerPubKey,skipCloseAccount:!p,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:p?!1:o,checkCreateATAOwner:i});y||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos),f&&u.addInstruction(f);let b=await this.getClmmPoolKeys(e.id),g=Be.collectRewardInstructions({poolInfo:e,poolKeys:b,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:y},rewardMint:d});u.addInstruction(g),l={...l,...g.address}}return u.addCustomComputeBudget(s),u.addTipInstruction(a),u.build({address:l})}async swap({poolInfo:e,poolKeys:t,inputMint:n,amountIn:o,amountOutMin:i,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:d=!1,txVersion:m,computeBudgetConfig:p,txTipConfig:y,feePayer:f}){let b=this.createTxBuilder(f),g=n.toString()===e.mintA.address,w=c.useSOLBalance&&e.mintA.address===j.toBase58(),k=c.useSOLBalance&&e.mintB.address===j.toBase58(),h;!s||s.equals(new C(0))?h=g?_t.add(new xt(1)):Ft.sub(new xt(1)):h=te.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let x;if(!x){let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new z(e.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,skipCloseAccount:!w,createInfo:w||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?o:0}:void 0,associatedOnly:w?!1:l,checkCreateATAOwner:d});x=S,I&&b.addInstruction(I)}let T;if(!T){let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new z(e.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,skipCloseAccount:!k,createInfo:k||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:o}:void 0,associatedOnly:k?!1:l,checkCreateATAOwner:d});T=S,I&&b.addInstruction(I)}(!x||!T)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:x,ownerTokenAccountB:T,mintAUseSOLBalance:w,mintBUseSOLBalance:k,associatedOnly:l});let B=t??await this.getClmmPoolKeys(e.id);return b.addInstruction(Be.makeSwapBaseInInstructions({poolInfo:e,poolKeys:B,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:x,tokenAccountB:T},inputMint:new z(n),amountIn:o,amountOutMin:i,sqrtPriceLimitX64:h,remainingAccounts:u})),b.addCustomComputeBudget(p),b.addTipInstruction(y),b.versionBuild({txVersion:m})}async swapBaseOut({poolInfo:e,poolKeys:t,outputMint:n,amountOut:o,amountInMax:i,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:d=!1,txVersion:m,computeBudgetConfig:p,txTipConfig:y,feePayer:f}){let b=this.createTxBuilder(f),g=n.toString()===e.mintB.address,w=c.useSOLBalance&&e.mintA.address===j.toBase58(),k=c.useSOLBalance&&e.mintB.address===j.toBase58(),h;!s||s.equals(new C(0))?h=n.toString()===e.mintB.address?_t.add(new xt(1)):Ft.sub(new xt(1)):h=te.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let x;if(!x){let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new z(e.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,skipCloseAccount:!w,createInfo:w||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?i:0}:void 0,associatedOnly:w?!1:l,checkCreateATAOwner:d});x=S,I&&b.addInstruction(I)}let T;if(!T){let{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new z(e.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,skipCloseAccount:!k,createInfo:k||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:i}:void 0,associatedOnly:k?!1:l,checkCreateATAOwner:d});T=S,I&&b.addInstruction(I)}(!x||!T)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:x,ownerTokenAccountB:T,mintAUseSOLBalance:w,mintBUseSOLBalance:k,associatedOnly:l});let B=t??await this.getClmmPoolKeys(e.id);return b.addInstruction(Be.makeSwapBaseOutInstructions({poolInfo:e,poolKeys:B,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:x,tokenAccountB:T},outputMint:new z(n),amountOut:o,amountInMax:i,sqrtPriceLimitX64:h,remainingAccounts:u})),b.addCustomComputeBudget(p),b.addTipInstruction(y),b.versionBuild({txVersion:m})}async harvestAllRewards({allPoolInfo:e,allPositions:t,lockInfo:n,ownerInfo:o,associatedOnly:i=!0,checkCreateATAOwner:s=!1,programId:a,txVersion:c,computeBudgetConfig:u,feePayer:l}){let d={};for(let b of this.scope.account.tokenAccountRawInfos)i?Y(this.scope.ownerPubKey,b.accountInfo.mint,a).publicKey.equals(b.pubkey)&&(d[b.accountInfo.mint.toString()]=b.pubkey):d[b.accountInfo.mint.toString()]=b.pubkey;let m=Object.values(t).flat().map(b=>b.nftMint),p=await Se(this.scope.connection,m.map(b=>({pubkey:b}))),y={};p.forEach(b=>{y[b.pubkey.toBase58()]=b?.accountInfo?.owner??null});let f=this.createTxBuilder(l);for(let b of Object.values(e)){if(t[b.id]===void 0||!t[b.id].find(I=>!I.liquidity.isZero()||I.rewardInfos.find(K=>!K.rewardAmountOwed.isZero())))continue;let g=b,w=o.useSOLBalance&&g.mintA.address===j.toString(),k=o.useSOLBalance&&g.mintB.address===j.toString(),h=d[g.mintA.address];if(!h){let{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:g.mintA.programId,mint:new z(g.mintA.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,skipCloseAccount:!w,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:w?!1:i,checkCreateATAOwner:s});h=I,K&&f.addInstruction(K)}let x=d[g.mintB.address];if(!x){let{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:g.mintB.programId,mint:new z(g.mintB.address),notUseTokenAccount:k,owner:this.scope.ownerPubKey,skipCloseAccount:!k,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:k?!1:i,checkCreateATAOwner:s});x=I,K&&f.addInstruction(K)}d[g.mintA.address]=h,d[g.mintB.address]=x;let T=[];for(let I of g.rewardDefaultInfos){let K=o.useSOLBalance&&I.mint.address===j.toString(),N=d[I.mint.address];if(!N){let{account:v,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new z(I.mint.programId),mint:new z(I.mint.address),notUseTokenAccount:K,owner:this.scope.ownerPubKey,skipCloseAccount:!K,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:K?!1:i});N=v,_&&f.addInstruction(_)}d[I.mint.address]=N,T.push(N)}let B=await this.getClmmPoolKeys(g.id),S=[];for(let I=0;I<B.rewardInfos.length;I++)S.push({poolRewardVault:new z(B.rewardInfos[I].vault),ownerRewardVault:T[I],rewardMint:new z(B.rewardInfos[I].mint.address)});for(let I of t[b.id]){let K=n?.[b.id]?.[I.nftMint.toBase58()];if(K){let N=Y(this.scope.ownerPubKey,K.lockNftMint,ki).publicKey,v=H.getTickArrayStartIndexByTick(I.tickLower,B.config.tickSpacing),_=H.getTickArrayStartIndexByTick(I.tickUpper,B.config.tickSpacing),{publicKey:D}=be(new z(B.programId),K.poolId,v),{publicKey:q}=be(new z(B.programId),K.poolId,_),{publicKey:G}=$t(new z(B.programId),K.poolId,I.tickLower,I.tickUpper),ne=ci(lo,K.lockNftMint).publicKey,ie=Be.harvestLockPositionInstructionV2({programId:lo,auth:Vo,lockPositionId:ne,clmmProgram:Kn,lockOwner:this.scope.ownerPubKey,lockNftMint:K.lockNftMint,lockNftAccount:N,positionNftAccount:K.nftAccount,positionId:K.positionId,poolId:K.poolId,protocolPosition:G,vaultA:new z(B.vault.A),vaultB:new z(B.vault.B),tickArrayLower:D,tickArrayUpper:q,userVaultA:h,userVaultB:x,mintA:new z(B.mintA.address),mintB:new z(B.mintB.address),rewardAccounts:S,exTickArrayBitmap:De(Kn,K.poolId).publicKey});f.addInstruction({instructions:[ie],instructionTypes:[V.ClmmHarvestLockPosition],lookupTableAddress:B.lookupTableAccount?[B.lookupTableAccount]:[]})}else{let N=Be.decreaseLiquidityInstructions({poolInfo:g,poolKeys:B,ownerPosition:I,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:h,tokenAccountB:x,rewardAccounts:T},liquidity:new xt(0),amountMinA:new xt(0),amountMinB:new xt(0),nft2022:y[I.nftMint.toBase58()]?.equals(_n)});f.addInstruction(N)}}}return c===0?f.sizeCheckBuildV0({computeBudgetConfig:u}):f.sizeCheckBuild({computeBudgetConfig:u})}async getWhiteListMint({programId:e}){let t=await this.scope.connection.getAccountInfo(ui(e).publicKey);return t?Ec.decode(t.data).whitelistMints.filter(o=>!o.equals(z.default)):[]}async getOwnerPositionInfo({programId:e}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(s=>s.accountInfo.amount.eq(new xt(1))).map(s=>Pt(new z(e),s.accountInfo.mint).publicKey),o=await this.scope.connection.getMultipleAccountsInfo(n),i=[];return o.forEach(s=>{if(!s)return;let a=pi.decode(s.data);i.push(a)}),i}async getRpcClmmPoolInfo({poolId:e}){return(await this.getRpcClmmPoolInfos({poolIds:[e]}))[String(e)]}async getRpcClmmPoolInfos({poolIds:e,config:t}){let n=await Se(this.scope.connection,e.map(i=>({pubkey:new z(i)})),t),o={};for(let i=0;i<e.length;i++){let s=n[i];if(s===null||!s.accountInfo)throw Error("fetch pool info error: "+String(e[i]));let a=Qn.decode(s.accountInfo.data),c=te.sqrtPriceX64ToPrice(a.sqrtPriceX64,a.mintDecimalsA,a.mintDecimalsB).toNumber();o[String(e[i])]={...a,currentPrice:c,programId:s.accountInfo.owner}}return o}async getComputeClmmPoolInfos({clmmPoolsRpcInfo:e,mintInfos:t}){let n=new Set(Object.keys(e).map(c=>e[c].ammConfig.toBase58())),o=await Se(this.scope.connection,Array.from(n).map(c=>({pubkey:new z(c)}))),i={};o.forEach(c=>{!c.accountInfo||(i[c.pubkey.toBase58()]=vc.decode(c.accountInfo.data))});let s=await Ce.fetchComputeMultipleClmmInfo({connection:this.scope.connection,rpcDataMap:e,poolList:Object.keys(e).map(c=>{let[u,l]=[e[c].mintA.toBase58(),e[c].mintB.toBase58()];return{id:c,programId:e[c].programId.toBase58(),mintA:pt({address:u,decimals:e[c].mintDecimalsA,programId:t[u].programId.toBase58()||ki.toBase58(),extensions:{feeConfig:t[u]?.feeConfig?Mn(t[u]?.feeConfig):void 0}}),mintB:pt({address:l,decimals:e[c].mintDecimalsB,programId:t[l].programId.toBase58()||ki.toBase58(),extensions:{feeConfig:t[l]?.feeConfig?Mn(t[l]?.feeConfig):void 0}}),price:e[c].currentPrice,config:{...i[e[c].ammConfig.toBase58()],id:e[c].ammConfig.toBase58(),fundFeeRate:0,description:"",defaultRange:0,defaultRangePoint:[]}}})}),a=await Ce.fetchMultiplePoolTickArrays({connection:this.scope.connection,poolKeys:Object.values(s)});return{computeClmmPoolInfo:s,computePoolTickData:a}}async getPoolInfoFromRpc(e){let t=await this.getRpcClmmPoolInfo({poolId:e}),n=new Set([t.mintA.toBase58(),t.mintB.toBase58()]),o=await io({connection:this.scope.connection,mints:Array.from(n).map(l=>new z(l))}),{computeClmmPoolInfo:i,computePoolTickData:s}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:{[e]:t},mintInfos:o}),a=await Se(this.scope.connection,[{pubkey:t.vaultA},{pubkey:t.vaultB}]),c=Nc(i[e]);if(!a[0].accountInfo||!a[1].accountInfo)throw new Error("pool vault data not found");c.mintAmountA=Number(il.decode(a[0].accountInfo.data).amount.toString()),c.mintAmountB=Number(il.decode(a[1].accountInfo?.data).amount.toString());let u={...i[e],exBitmapAccount:i[e].exBitmapAccount.toBase58(),observationId:i[e].observationId.toBase58(),id:e,programId:t.programId.toBase58(),openTime:t.startTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},config:c.config,rewardInfos:i[e].rewardInfos.filter(l=>!l.tokenVault.equals(z.default)).map(l=>({mint:pt({address:l.tokenMint.toBase58(),programId:ki.toBase58(),decimals:10}),vault:l.tokenVault.toBase58()}))};return{poolInfo:c,poolKeys:u,computePoolInfo:i[e],tickData:s}}};import{PublicKey as X}from"@solana/web3.js";import{AccountLayout as Oa,createAssociatedTokenAccountIdempotentInstruction as yl,getAssociatedTokenAddressSync as bl,NATIVE_MINT as xo,TOKEN_PROGRAM_ID as vt}from"@solana/spl-token";import Ca from"bn.js";import Wr from"decimal.js-light";import Ti from"bn.js";function _r(r,e){if(e.isZero())throw Error("divisor is zero");return r.mod(e)}function If(r,e){if(e.isZero())throw Error("rhs is zero");let t=r.div(e);if(t.isZero())throw Error("quotient is zero");let n=_r(r,e);return n.gt(Io)&&(t=t.add(new Ti(1)),e=r.div(t),n=_r(r,t),n.gt(Io)&&(e=e.add(new Ti(1)))),[t,e]}var Io=new Ti(0),Fr=class{static swapWithoutFees(e,t,n){let o=t.mul(n),i=t.add(e),[s]=If(o,i),a=n.sub(s);if(a.isZero())throw Error("destinationAmountSwapped is zero");return{destinationAmountSwapped:a}}static lpTokensToTradingTokens(e,t,n,o,i){let s=e.mul(n).div(t),a=e.mul(o).div(t);if(i===0)return{tokenAmount0:s,tokenAmount1:a};if(i===1)return _r(e.mul(n),t).gt(Io)&&s.gt(Io)&&(s=s.add(new Ti(1))),_r(e.mul(o),t).gt(Io)&&a.gt(Io)&&(a=a.add(new Ti(1))),{tokenAmount0:s,tokenAmount1:a};throw Error("roundDirection value error")}};var Vr=class{static tradingFee(e,t){return er(e,t,zt)}static protocolFee(e,t){return Is(e,t,zt)}static fundFee(e,t){return Is(e,t,zt)}};var rl=(t=>(t[t.Floor=0]="Floor",t[t.Ceiling=1]="Ceiling",t))(rl||{}),Dr=class{static validate_supply(e,t){if(e.isZero())throw Error("tokenAmount0 is zero");if(t.isZero())throw Error("tokenAmount1 is zero")}static swap(e,t,n,o){let i=Vr.tradingFee(e,o),s=e.sub(i),{destinationAmountSwapped:a}=Fr.swapWithoutFees(s,t,n);return{newSwapDestinationAmount:n.sub(a),sourceAmountSwapped:e,destinationAmountSwapped:a,tradeFee:i}}static swapBaseOut({poolMintA:e,poolMintB:t,tradeFeeRate:n,baseReserve:o,quoteReserve:i,outputMint:s,outputAmount:a}){let[c,u,l,d,m]=t.address===s.toString()?[o,i,e.decimals,t.decimals,e.address]:[i,o,t.decimals,e.decimals,t.address],p=new Wr(u.toString()).div(10**d).div(new Wr(c.toString()).div(10**l)),y=a.gte(u)?u.sub(new Ca(1)):a,f=u.sub(y),b=Cn(c.mul(y),f),g=Cn(b.mul(new Ca(1e6)),new Ca(1e6).sub(n)),w=g.sub(b),k=new Wr(y.toString()).div(10**d).div(new Wr(g.toString()).div(10**l)),h=p.isZero()?0:k.sub(p).div(p).abs().toNumber();return{amountRealOut:y,amountIn:g,amountInWithoutFee:b,tradeFee:w,priceImpact:h}}};import _e from"bn.js";import{PublicKey as Bi,TransactionInstruction as Jn,Keypair as vf,SystemProgram as Mf}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as ul,TOKEN_2022_PROGRAM_ID as Ra,TOKEN_PROGRAM_ID as Fn}from"@solana/spl-token";var Bf=Buffer.from("vault_and_lp_mint_auth_seed","utf8"),xf=Buffer.from("amm_config","utf8"),Sf=Buffer.from("pool","utf8"),Kf=Buffer.from("pool_lp_mint","utf8"),Cf=Buffer.from("pool_vault","utf8"),Lf=Buffer.from("observation","utf8");function Bo(r){return ee([Bf],r)}function $x(r,e){return ee([xf,Nf(e)],r)}function La(r,e,t,n){return ee([Sf,e.toBuffer(),t.toBuffer(),n.toBuffer()],r)}function Rf(r,e){return ee([Kf,e.toBuffer()],r)}function sl(r,e,t){return ee([Cf,e.toBuffer(),t.toBuffer()],r)}function Ii(r,e){return ee([Lf,e.toBuffer()],r)}function Nf(r){let e=new ArrayBuffer(2);return new DataView(e).setUint16(0,r,!1),new Uint8Array(e)}function al({poolId:r,programId:e,configId:t,mintA:n,mintB:o}){let i=Bo(e).publicKey,s=r||La(e,t,n,o).publicKey,a=Rf(e,s).publicKey,c=sl(e,s,n).publicKey,u=sl(e,s,o).publicKey,l=Ii(e,s).publicKey;return{poolId:s,configId:t,authority:i,lpMint:a,vaultA:c,vaultB:u,observationId:l}}var Of=Buffer.from("locked_liquidity","utf8");function qr(r,e){return ee([Of,e.toBuffer()],r)}var Ef=de("Raydium_cpmm"),eo={initialize:[175,175,109,31,13,152,155,237],deposit:[242,35,198,137,82,225,242,182],withdraw:[183,18,70,156,148,109,161,34],swapBaseInput:[143,190,90,218,196,30,51,222],swapBaseOutput:[55,217,98,86,163,74,180,173],lockCpLiquidity:[216,157,29,78,38,51,31,26],collectCpFee:[8,30,51,199,209,184,247,133]};function cl(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g,w,k){let h=O([P("amountMaxA"),P("amountMaxB"),P("openTime")]),x=La(r,t,i,s).publicKey,T=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!o.equals(x),isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:Fn,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:ul,isSigner:!1,isWritable:!1},{pubkey:Zi,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1}],B=Buffer.alloc(h.span);return h.encode({amountMaxA:g,amountMaxB:w,openTime:k},B),new Jn({keys:T,programId:r,data:Buffer.from([...eo.initialize,...B])})}function ll(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y){let f=O([P("lpAmount"),P("amountMaxA"),P("amountMaxB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Fn,isSigner:!1,isWritable:!1},{pubkey:Ra,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!0}],g=Buffer.alloc(f.span);return Ef.debug("cpmm deposit data",{lpAmount:m.toString(),amountMaxA:p.toString(),amountMaxB:y.toString()}),f.encode({lpAmount:m,amountMaxA:p,amountMaxB:y},g),new Jn({keys:b,programId:r,data:Buffer.from([...eo.deposit,...g])})}function ml(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y){let f=O([P("lpAmount"),P("amountMinA"),P("amountMinB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Fn,isSigner:!1,isWritable:!1},{pubkey:Ra,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:on,isSigner:!1,isWritable:!1}],g=Buffer.alloc(f.span);return f.encode({lpAmount:m,amountMinA:p,amountMinB:y},g),new Jn({keys:b,programId:r,data:Buffer.from([...eo.withdraw,...g])})}function Ur(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y,f){let b=O([P("amountIn"),P("amounOutMin")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],w=Buffer.alloc(b.span);return b.encode({amountIn:y,amounOutMin:f},w),new Jn({keys:g,programId:r,data:Buffer.from([...eo.swapBaseInput,...w])})}function dl(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y,f){let b=O([P("amountInMax"),P("amountOut")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],w=Buffer.alloc(b.span);return b.encode({amountInMax:y,amountOut:f},w),new Jn({keys:g,programId:r,data:Buffer.from([...eo.swapBaseOutput,...w])})}async function pl(r){let{ownerInfo:e,poolInfo:t,poolKeys:n,feeNftOwner:o,getEphemeralSigners:i}=r,s=[],[a,c]=[new Bi(t.id),new Bi(t.lpMint.address)],u;if(i)u=new Bi((await i(1))[0]);else{let b=vf.generate();s.push(b),u=b.publicKey}let{publicKey:l}=Y(o,u,Fn),{publicKey:d}=An(u),{publicKey:m}=qr(r.lockProgram,u),{publicKey:p}=Y(e.wallet,c,Fn),{publicKey:y}=Y(r.lockAuthProgram,c,Fn),f=_f({programId:r.lockProgram,auth:r.lockAuthProgram,payer:e.feePayer,liquidityOwner:e.wallet,nftOwner:o,nftMint:u,nftAccount:l,poolId:a,lockPda:m,mintLp:c,userLpVault:p,lockLpVault:y,poolVaultA:new Bi(n.vault.A),poolVaultB:new Bi(n.vault.B),metadataAccount:d,lpAmount:r.lpAmount,withMetadata:r.withMetadata??!0});return{address:{nftMint:u,nftAccount:l,metadataAccount:d,lockPda:m,userLpVault:p,lockLpVault:y},instructions:[f],signers:s,instructionTypes:[V.CpmmLockLp],lookupTableAddress:[]}}function _f({programId:r,auth:e,payer:t,liquidityOwner:n,nftOwner:o,nftMint:i,nftAccount:s,poolId:a,lockPda:c,mintLp:u,userLpVault:l,lockLpVault:d,poolVaultA:m,poolVaultB:p,metadataAccount:y,lpAmount:f,withMetadata:b}){let g=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:Mf.programId,isSigner:!1,isWritable:!1},{pubkey:Fn,isSigner:!1,isWritable:!1},{pubkey:ul,isSigner:!1,isWritable:!1},{pubkey:Ut,isSigner:!1,isWritable:!1}],w=O([P("lpAmount"),Ee("withMetadata")]),k=Buffer.alloc(w.span);w.encode({lpAmount:f,withMetadata:b},k);let h=Buffer.from([...eo.lockCpLiquidity,...k]);return new Jn({keys:g,programId:r,data:h})}function fl({programId:r,nftOwner:e,auth:t,nftAccount:n,lockPda:o,poolId:i,mintLp:s,userVaultA:a,userVaultB:c,poolVaultA:u,poolVaultB:l,mintA:d,mintB:m,lockLpVault:p,lpFeeAmount:y,cpmmProgram:f,cpmmAuthProgram:b}){let g=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:f??Wo,isSigner:!1,isWritable:!1},{pubkey:b??Ks,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:Fn,isSigner:!1,isWritable:!1},{pubkey:Ra,isSigner:!1,isWritable:!1},{pubkey:on,isSigner:!1,isWritable:!1}],w=O([P("lpFeeAmount")]),k=Buffer.alloc(w.span);w.encode({lpFeeAmount:y},k);let h=Buffer.from([...eo.collectCpFee,...k]);return new Jn({keys:g,programId:r,data:h})}var Na=O([ke(8),F("bump"),Ee("disableCreatePool"),jt("index"),P("tradeFeeRate"),P("protocolFeeRate"),P("fundFeeRate"),P("createPoolFee"),L("protocolOwner"),L("fundOwner"),Q(P(),16)]),xi=O([ke(8),L("configId"),L("poolCreator"),L("vaultA"),L("vaultB"),L("mintLp"),L("mintA"),L("mintB"),L("mintProgramA"),L("mintProgramB"),L("observationId"),F("bump"),F("status"),F("lpDecimals"),F("mintDecimalA"),F("mintDecimalB"),P("lpAmount"),P("protocolFeesMintA"),P("protocolFeesMintB"),P("fundFeesMintA"),P("fundFeesMintB"),P("openTime"),Q(P(),32)]);var Qe=r=>((performance.now()-r)/1e3).toFixed(2),Si=class extends Re{constructor(e){super(e)}async load(){this.checkDisabled()}async getCpmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async getRpcPoolInfo(e,t,n){if(!e&&!t?.marketAccount)throw new Error("Either poolId or accountInfos.marketAccount must be provided");let o=e?(await Se(this.scope.connection,[{pubkey:new X(e)}]))[0]:t.marketAccount;if(!o?.accountInfo){let x=e||t?.marketAccount?.pubkey?.toBase58()||"unknown";throw new Error(`Pool account not found: ${x}`)}let i={...xi.decode(o.accountInfo.data),programId:o.accountInfo.owner},s=[],a=[i.vaultA,i.vaultB];e&&(s.push(...a.map(x=>({pubkey:new X(x)}))),n&&s.push({pubkey:new X(i.configId)}));let c=[];e&&s.length>0&&(c=await Se(this.scope.connection,s));let u;if(n){let x=e?c[c.length-1]:t?.configState;if(!x?.accountInfo)throw new Error(`Config account not found: ${i.configId}`);u=Na.decode(x.accountInfo.data)}let l=e?c[0]?.accountInfo:t?.vaultAInfo?.accountInfo,d=e?c[1]?.accountInfo:t?.vaultBInfo?.accountInfo;if(!l||!d)throw new Error(`Vault accounts not found: A=${i.vaultA}, B=${i.vaultB}`);let m=new _e(Oa.decode(l.data).amount.toString()),p=new _e(Oa.decode(d.data).amount.toString()),y=m.sub(i.protocolFeesMintA).sub(i.fundFeesMintA),f=p.sub(i.protocolFeesMintB).sub(i.fundFeesMintB),b=new C(10).pow(i.mintDecimalA),g=new C(10).pow(i.mintDecimalB),w=new C(y.toString()).div(b),k=new C(f.toString()).div(g),h=w.isZero()?new C(0):k.div(w);return{...i,baseReserve:y,quoteReserve:f,vaultAAmount:m,vaultBAmount:p,configInfo:u,poolPrice:h}}async getRpcPoolInfos(e,t){let n=await Se(this.scope.connection,e.map(d=>({pubkey:new X(d)}))),o={},i=new Set,s=[];for(let d=0;d<e.length;d++){let m=n[d];if(m.accountInfo===null)throw Error("fetch pool info error: "+String(e[d]));let p=xi.decode(m.accountInfo.data);o[String(e[d])]={...p,programId:m.accountInfo.owner},i.add(String(p.configId)),s.push(p.vaultA,p.vaultB)}let a={};if(t){let d=[...i],m=await Se(this.scope.connection,d.map(p=>({pubkey:new X(p)})));for(let p=0;p<d.length;p++){let y=m[p].accountInfo;if(y===null)throw Error("fetch pool config error: "+d[p]);a[d[p]]=Na.decode(y.data)}}let c={},u=await Se(this.scope.connection,s.map(d=>({pubkey:new X(d)})));for(let d=0;d<s.length;d++){let m=u[d].accountInfo;if(m===null)throw Error("fetch vault info error: "+s[d]);c[String(s[d])]=new _e(Oa.decode(m.data).amount.toString())}let l={};for(let[d,m]of Object.entries(o)){let p=c[m.vaultA.toString()].sub(m.protocolFeesMintA).sub(m.fundFeesMintA),y=c[m.vaultB.toString()].sub(m.protocolFeesMintB).sub(m.fundFeesMintB);l[d]={...m,baseReserve:p,quoteReserve:y,vaultAAmount:c[m.vaultA.toString()],vaultBAmount:c[m.vaultB.toString()],configInfo:a[m.configId.toString()],poolPrice:new C(y.toString()).div(new C(10).pow(m.mintDecimalB)).div(new C(p.toString()).div(new C(10).pow(m.mintDecimalA)))}}return l}toComputePoolInfos({pools:e,mintInfos:t}){return Object.keys(e).reduce((n,o)=>{let i=e[o],[s,a]=[i.mintA.toBase58(),i.mintB.toBase58()];return{...n,[o]:{...i,id:new X(o),configInfo:i.configInfo,version:7,authority:Bo(i.programId).publicKey,mintA:pt({address:s,decimals:i.mintDecimalA,programId:i.mintProgramA.toBase58(),extensions:{feeConfig:t[s]?.feeConfig?Mn(t[s]?.feeConfig):void 0}}),mintB:pt({address:a,decimals:i.mintDecimalB,programId:i.mintProgramB.toBase58(),extensions:{feeConfig:t[a]?.feeConfig?Mn(t[a]?.feeConfig):void 0}})}}},{})}async getPoolInfoFromRpc(e,t,n){t=t||await this.getRpcPoolInfo(e,void 0,!0),n=n||await io({connection:this.scope.connection,mints:[t.mintA,t.mintB]});let o=pt({address:t.mintA.toBase58(),decimals:t.mintDecimalA,programId:t.mintProgramA.toBase58(),extensions:{feeConfig:n[t.mintA.toBase58()].feeConfig?Mn(n[t.mintA.toBase58()].feeConfig):void 0}}),i=pt({address:t.mintB.toBase58(),decimals:t.mintDecimalB,programId:t.mintProgramB.toBase58(),extensions:{feeConfig:n[t.mintB.toBase58()].feeConfig?Mn(n[t.mintB.toBase58()].feeConfig):void 0}}),s=pt({address:t.mintLp.toBase58(),decimals:t.lpDecimals,programId:vt.toBase58()}),a={id:t.configId.toBase58(),index:t.configInfo.index,protocolFeeRate:t.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:t.configInfo.tradeFeeRate.toNumber(),fundFeeRate:t.configInfo.fundFeeRate.toNumber(),createPoolFee:t.configInfo.createPoolFee.toString()},c={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};return{poolInfo:{programId:t.programId.toBase58(),id:e,type:"Standard",lpMint:s,lpPrice:0,lpAmount:t.lpAmount.toNumber(),config:a,mintA:o,mintB:i,rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:t.poolPrice.toNumber(),mintAmountA:new C(t.vaultAAmount.toString()).div(10**o.decimals).toNumber(),mintAmountB:new C(t.vaultBAmount.toString()).div(10**i.decimals).toNumber(),feeRate:t.configInfo.tradeFeeRate.toNumber(),openTime:t.openTime.toString(),tvl:0,burnPercent:0,day:c,week:c,month:c,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0},poolKeys:{programId:t.programId.toBase58(),id:e,mintA:o,mintB:i,openTime:t.openTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},authority:Bo(t.programId).publicKey.toBase58(),mintLp:s,config:a,observationId:Ii(t.programId,new X(e)).publicKey.toBase58()},rpcData:t}}async createPool({poolId:e,programId:t,poolFeeAccount:n,startTime:o,ownerInfo:i,associatedOnly:s=!1,checkCreateATAOwner:a=!1,txVersion:c,feeConfig:u,computeBudgetConfig:l,txTipConfig:d,feePayer:m,...p}){let y=i.feePayer||this.scope.owner?.publicKey,f=new _e(new X(p.mintA.address).toBuffer()).lte(new _e(new X(p.mintB.address).toBuffer())),[b,g]=f?[p.mintA,p.mintB]:[p.mintB,p.mintA],[w,k]=f?[p.mintAAmount,p.mintBAmount]:[p.mintBAmount,p.mintAAmount],h=i.useSOLBalance&&b.address===xo.toBase58(),x=i.useSOLBalance&&g.address===xo.toBase58(),[T,B]=[new X(b.address),new X(g.address)],S=this.createTxBuilder(m),{account:I,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:T,tokenProgram:b.programId,owner:this.scope.ownerPubKey,createInfo:h?{payer:y,amount:w}:void 0,notUseTokenAccount:h,skipCloseAccount:!h,associatedOnly:h?!1:s,checkCreateATAOwner:a});S.addInstruction(K||{});let{account:N,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({mint:new X(g.address),tokenProgram:g.programId,owner:this.scope.ownerPubKey,createInfo:x?{payer:y,amount:k}:void 0,notUseTokenAccount:x,skipCloseAccount:!x,associatedOnly:x?!1:s,checkCreateATAOwner:a});if(S.addInstruction(v||{}),I===void 0||N===void 0)throw Error("you don't has some token account");let _=al({poolId:e,programId:t,configId:new X(u.id),mintA:T,mintB:B});return S.addInstruction({instructions:[cl(t,this.scope.ownerPubKey,new X(u.id),_.authority,_.poolId,T,B,_.lpMint,I,N,Y(this.scope.ownerPubKey,_.lpMint).publicKey,_.vaultA,_.vaultB,n,new X(b.programId??vt),new X(g.programId??vt),_.observationId,w,k,o)],instructionTypes:[V.CpmmCreatePool]}),S.addCustomComputeBudget(l),S.addTipInstruction(d),S.versionBuild({txVersion:c,extInfo:{address:{..._,mintA:b,mintB:g,programId:t,poolFeeAccount:n,feeConfig:u}}})}async addLiquidity(e){let{poolInfo:t,poolKeys:n,inputAmount:o,baseIn:i,slippage:s,computeResult:a,computeBudgetConfig:c,txTipConfig:u,config:l,txVersion:d,feePayer:m}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),o.isZero()&&this.logAndCreateError("amounts must greater than zero","amountInA",{amountInA:o.toString()});let{account:p}=this.scope,{bypassAssociatedCheck:y,checkCreateATAOwner:f}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...l},b=a?void 0:await this.getRpcPoolInfo(t.id),{liquidity:g,inputAmountFee:w,anotherAmount:k}=a||this.computePairAmount({poolInfo:{...t,lpAmount:new C(b.lpAmount.toString()).div(10**t.lpMint.decimals).toNumber()},baseReserve:b.baseReserve,quoteReserve:b.quoteReserve,slippage:new tt(0),baseIn:i,epochInfo:await this.scope.fetchEpochInfo(),amount:new C(o.toString()).div(10**(i?t.mintA.decimals:t.mintB.decimals))}),h=k.amount,x=t.mintA.address===xo.toString(),T=t.mintB.address===xo.toString(),B=this.createTxBuilder(m),[S,I]=[new X(t.mintA.address),new X(t.mintB.address)],{account:K,instructionParams:N}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new X(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:x||(i?o:h).isZero()?{payer:this.scope.ownerPubKey,amount:i?o:h}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:!1,checkCreateATAOwner:f});B.addInstruction(N||{});let{account:v,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new X(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:T||(i?h:o).isZero()?{payer:this.scope.ownerPubKey,amount:i?h:o}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:!1,checkCreateATAOwner:f});B.addInstruction(_||{}),!K&&!v&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",p.tokenAccounts);let D=await p.getCreatedTokenAccount({mint:new X(t.lpMint.address)}),{tokenAccount:q,...G}=await p.handleTokenAccount({side:"out",amount:0,mint:new X(t.lpMint.address),tokenAccount:D,bypassAssociatedCheck:y,checkCreateATAOwner:f});B.addInstruction(G);let ne=n??await this.getCpmmPoolKeys(t.id),ie=new tt(new _e(1)).sub(s);return B.addInstruction({instructions:[ll(new X(t.programId),this.scope.ownerPubKey,new X(ne.authority),new X(t.id),q,K,v,new X(ne.vault.A),new X(ne.vault.B),S,I,new X(t.lpMint.address),a?a?.liquidity:ie.mul(g).quotient,i?w.amount:h,i?h:w.amount)],instructionTypes:[V.CpmmAddLiquidity],lookupTableAddress:ne.lookupTableAccount?[ne.lookupTableAccount]:[]}),B.addCustomComputeBudget(c),B.addTipInstruction(u),B.versionBuild({txVersion:d})}async withdrawLiquidity(e){let{poolInfo:t,poolKeys:n,lpAmount:o,slippage:i,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u,closeWsol:l=!0}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region");let d=new tt(new _e(1)).sub(i),m=await this.getRpcPoolInfo(t.id),[p,y]=[d.mul(o.mul(m.baseReserve).div(m.lpAmount)).quotient,d.mul(o.mul(m.quoteReserve).div(m.lpAmount)).quotient],f=await this.scope.fetchEpochInfo(),[b,g]=[we(p,t.mintA.extensions.feeConfig,f,!1),we(y,t.mintB.extensions.feeConfig,f,!1)],{account:w}=this.scope,k=this.createTxBuilder(u),[h,x]=[new X(t.mintA.address),new X(t.mintB.address)],T=h.equals(j),B=x.equals(j),S,I,{account:K,instructionParams:N}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new X(t.mintA.address),notUseTokenAccount:T,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(T&&l),associatedOnly:!T,checkCreateATAOwner:!1});S=K,N&&k.addInstruction(N);let{account:v,instructionParams:_}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new X(t.mintB.address),notUseTokenAccount:B,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(B&&l),associatedOnly:!B,checkCreateATAOwner:!1});I=v,_&&k.addInstruction(_),(!S||!I)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",w.tokenAccounts);let D=await w.getCreatedTokenAccount({mint:new X(t.lpMint.address)});D||this.logAndCreateError("cannot found lp token account","tokenAccounts",w.tokenAccounts);let q=n??await this.getCpmmPoolKeys(t.id);return k.addInstruction({instructions:[ml(new X(t.programId),this.scope.ownerPubKey,new X(q.authority),new X(t.id),D,S,I,new X(q.vault.A),new X(q.vault.B),h,x,new X(t.lpMint.address),o,p.sub(b.fee??new _e(0)),y.sub(g.fee??new _e(0)))],instructionTypes:[V.CpmmWithdrawLiquidity],lookupTableAddress:q.lookupTableAccount?[q.lookupTableAccount]:[]}),k.addCustomComputeBudget(s),k.addTipInstruction(a),k.versionBuild({txVersion:c})}async swap(e){let{poolInfo:t,poolKeys:n,baseIn:o,fixedOut:i,inputAmount:s,swapResult:a,slippage:c=0,config:u,computeBudgetConfig:l,txTipConfig:d,txVersion:m,feePayer:p,nonce:y}=e,{bypassAssociatedCheck:f,checkCreateATAOwner:b,associatedOnly:g,useIdempotent:w=!1}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,associatedOnly:!0,useIdempotent:!1,...u},k=performance.now();console.log(`Swap start: ${Qe(k)}s, baseIn: ${o}, fixedOut: ${i}, inputAmount: ${s.toString()}`);let h=this.createTxBuilder(p);if(console.log(`TxBuilder created: ${Qe(k)}s`),y&&y?.instruction&&(h.addInstruction({instructions:[y.instruction],instructionTypes:[y.instruction].map(()=>V.NonceAccount)}),console.log(`Nonce instruction added: ${Qe(k)}s`)),l){let{instructions:ie,instructionTypes:me}=ao(l);h.addInstruction({instructions:ie,instructionTypes:me}),console.log(`Compute budget added: ${Qe(k)}s`)}i?a.sourceAmountSwapped=a.sourceAmountSwapped.mul(new _e((1+c)*1e4)).div(new _e(1e4)):a.destinationAmountSwapped=a.destinationAmountSwapped.mul(new _e((1-c)*1e4)).div(new _e(1e4)),console.log(`Slippage applied: ${Qe(k)}s`);let[x,T]=[new X(t.mintA.address),new X(t.mintB.address)],B,S;if(console.log(`Mints prepared: ${Qe(k)}s`),w){let ie=new X(t.mintA.programId??vt),me=new X(t.mintB.programId??vt),re=x.equals(xo),fe=T.equals(xo);console.log(`${Qe(k)}s: mintAIsSOL: ${re}, mintBIsSOL: ${fe}`),B=bl(x,this.scope.ownerPubKey,!1,ie),console.log(`${Qe(k)}s: mintATokenAcc prepared: ${B.toBase58()}`),S=bl(T,this.scope.ownerPubKey,!1,me),console.log(`${Qe(k)}s: mintBTokenAcc prepared: ${S.toBase58()}`),re||(h.addInstruction({instructions:[yl(this.scope.ownerPubKey,B,this.scope.ownerPubKey,x,ie)],instructionTypes:[V.CreateATA]}),console.log(`Idempotent ATA for mintA added: ${Qe(k)}s`)),fe||(h.addInstruction({instructions:[yl(this.scope.ownerPubKey,S,this.scope.ownerPubKey,T,me)],instructionTypes:[V.CreateATA]}),console.log(`Idempotent ATA for mintB added: ${Qe(k)}s`))}else{let ie=t.mintA.address===j.toBase58(),me=t.mintB.address===j.toBase58();console.log(`mintAUseSOLBalance: ${ie}, mintBUseSOLBalance: ${me}, ${Qe(k)}s`);let{account:re,instructionParams:fe}=await this.scope.account.getOrCreateTokenAccount({mint:x,tokenProgram:new X(t.mintA.programId??vt),owner:this.scope.ownerPubKey,createInfo:ie||!o?{payer:this.scope.ownerPubKey,amount:o?a.sourceAmountSwapped:0}:void 0,notUseTokenAccount:ie,skipCloseAccount:!ie,associatedOnly:ie?!1:g,checkCreateATAOwner:b});console.log(`mintATokenAccResult: ${JSON.stringify(re)}, ${Qe(k)}s`),fe&&h.addInstruction(fe),console.log(`mintATokenAccInstruction added: ${Qe(k)}s`),B=re;let{account:at,instructionParams:ze}=await this.scope.account.getOrCreateTokenAccount({mint:T,tokenProgram:new X(t.mintB.programId??vt),owner:this.scope.ownerPubKey,createInfo:me||o?{payer:this.scope.ownerPubKey,amount:o?0:a.sourceAmountSwapped}:void 0,notUseTokenAccount:me,skipCloseAccount:!me,associatedOnly:me?!1:g,checkCreateATAOwner:b});console.log(`mintBTokenAccResult: ${JSON.stringify(at)}, ${Qe(k)}s`),ze&&h.addInstruction(ze),console.log(`mintBTokenAccInstruction added: ${Qe(k)}s`),S=at,(!B||!S)&&this.logAndCreateError("user do not have token account",{mintA:t.mintA.symbol||t.mintA.address,mintB:t.mintB.symbol||t.mintB.address,mintATokenAcc:B,mintBTokenAcc:S,mintAUseSOLBalance:ie,mintBUseSOLBalance:me,associatedOnly:g})}let I=n??await this.getCpmmPoolKeys(t.id);console.log(`Pool keys fetched: ${Qe(k)}s`);let K=o?B:S,N=o?S:B,v=o?x:T,_=o?T:x,D=o?I.vault.A:I.vault.B,q=o?I.vault.B:I.vault.A,G=o?new X(t.mintA.programId??vt):new X(t.mintB.programId??vt),ne=o?new X(t.mintB.programId??vt):new X(t.mintA.programId??vt);return console.log(`Swap parameters prepared: ${Qe(k)}s`),h.addInstruction({instructions:[i?dl(new X(t.programId),this.scope.ownerPubKey,new X(I.authority),new X(I.config.id),new X(t.id),K,N,new X(D),new X(q),G,ne,v,_,Ii(new X(t.programId),new X(t.id)).publicKey,a.sourceAmountSwapped,a.destinationAmountSwapped):Ur(new X(t.programId),this.scope.ownerPubKey,new X(I.authority),new X(I.config.id),new X(t.id),K,N,new X(D),new X(q),G,ne,v,_,Ii(new X(t.programId),new X(t.id)).publicKey,s,a.destinationAmountSwapped)],instructionTypes:[i?V.CpmmSwapBaseOut:V.CpmmSwapBaseIn]}),console.log(`Swap instruction added: ${Qe(k)}s`),h.addTipInstruction(d),console.log(`Tip instruction added: ${Qe(k)}s`),h.versionBuild({txVersion:m},y?.nonce)}async lockLp(e){let{poolInfo:t,lpAmount:n,computeBudgetConfig:o,txTipConfig:i,txVersion:s,feePayer:a,feeNftOwner:c}=e;n.isZero()&&this.logAndCreateError("lpAmount must greater than zero",{lpAmount:n.toString()});let u=this.createTxBuilder(a),l=e.poolKeys??await this.getCpmmPoolKeys(t.id),d=await pl({poolInfo:t,poolKeys:l,ownerInfo:{wallet:this.scope.ownerPubKey,feePayer:e.feePayer??this.scope.ownerPubKey},feeNftOwner:c??this.scope.ownerPubKey,lockProgram:e.programId??Do,lockAuthProgram:e.authProgram??qo,lpAmount:n,withMetadata:e.withMetadata??!0,getEphemeralSigners:e.getEphemeralSigners});return u.addInstruction(d),u.addCustomComputeBudget(o),u.addTipInstruction(i),u.versionBuild({txVersion:s,extInfo:d.address})}async harvestLockLp(e){let{poolInfo:t,lpFeeAmount:n,nftMint:o,programId:i=Do,authProgram:s=qo,cpmmProgram:a,computeBudgetConfig:c,txTipConfig:u,txVersion:l,closeWsol:d=!0}=e;n.isZero()&&this.logAndCreateError("lpFeeAmount must greater than zero",{lpAmount:n.toString()});let m=e.feePayer||this.scope.ownerPubKey,p=this.createTxBuilder(m),[y,f]=[new X(t.mintA.address),new X(t.mintB.address)],b=y.equals(j),g=f.equals(j),w,k,{account:h,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new X(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(b&&d),associatedOnly:!b,checkCreateATAOwner:!1});w=h,x&&p.addInstruction(x);let{account:T,instructionParams:B}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new X(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(g&&d),associatedOnly:!g,checkCreateATAOwner:!1});k=T,B&&p.addInstruction(B),(!w||!k)&&this.logAndCreateError("cannot found target token accounts",{tokenAccountA:w,tokenAccountB:k});let S=e.poolKeys??await this.getCpmmPoolKeys(t.id),{publicKey:I}=Y(m,o,vt),{publicKey:K}=qr(i,o),{publicKey:N}=Y(s,new X(t.lpMint.address),vt);return p.addInstruction({instructions:[fl({programId:i??Do,nftOwner:this.scope.ownerPubKey,auth:s??qo,nftMint:o,nftAccount:I,lockPda:K,poolId:new X(t.id),mintLp:new X(S.mintLp.address),userVaultA:w,userVaultB:k,poolVaultA:new X(S.vault.A),poolVaultB:new X(S.vault.B),mintA:y,mintB:f,lockLpVault:N,lpFeeAmount:n,cpmmProgram:a?.programId,cpmmAuthProgram:a?.authProgram})],instructionTypes:[V.CpmmCollectLockFee]}),p.addCustomComputeBudget(c),p.addTipInstruction(u),p.versionBuild({txVersion:l})}computeSwapAmount({pool:e,amountIn:t,outputMint:n,slippage:o}){let i=n.toString()===e.mintB.address,s=Dr.swap(t,i?e.baseReserve:e.quoteReserve,i?e.quoteReserve:e.baseReserve,e.configInfo.tradeFeeRate),a=new C(s.destinationAmountSwapped.toString()).div(s.sourceAmountSwapped.toString()),c=s.destinationAmountSwapped.mul(new _e((1-o)*1e4)).div(new _e(1e4));return{allTrade:s.sourceAmountSwapped.eq(t),amountIn:t,amountOut:s.destinationAmountSwapped,minAmountOut:c,executionPrice:a,fee:s.tradeFee,priceImpact:e.poolPrice.sub(a).div(e.poolPrice)}}computePairAmount({poolInfo:e,baseReserve:t,quoteReserve:n,amount:o,slippage:i,epochInfo:s,baseIn:a}){let c=1-Number(i.toSignificant())/100,u=new _e(new C(o).mul(10**e[a?"mintA":"mintB"].decimals).mul(c).toFixed(0)),l=we(u,e[a?"mintA":"mintB"].extensions.feeConfig,s,!1),d=u.sub(l.fee??new _e(0)),m=new _e(new C(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,C.ROUND_DOWN));this.logDebug("baseReserve:",t.toString(),"quoteReserve:",n.toString()),this.logDebug("tokenIn:",a?e.mintA.symbol:e.mintB.symbol,"amountIn:",u.toString(),"amountInFee:",l.fee?.toString()??0,"anotherToken:",a?e.mintB.symbol:e.mintA.symbol,"slippage:",`${i.toSignificant()}%`);let p=a?"base":"quote";this.logDebug("input side:",p);let y=d.mul(m).div(p==="base"?t:n),f={amount:Tt,fee:void 0,expirationTime:void 0};if(!d.isZero()){let h=Ff(y,t,n,m);this.logDebug("lpAmountData:",{amountA:h.amountA.toString(),amountB:h.amountB.toString()}),f=we(h[a?"amountB":"amountA"],e[a?"mintB":"mintA"].extensions.feeConfig,s,!0)}let b=new tt(new _e(1)).add(i),g=new tt(new _e(1)).sub(i),w=we(b.mul(f.amount.sub(f.fee??new _e(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0),k=we(g.mul(f.amount.sub(f.fee??new _e(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0);return this.logDebug("anotherAmount:",f.amount.toString(),"anotherAmountFee:",f.fee?.toString()??0,"maxAnotherAmount:",w.amount.toString(),"maxAnotherAmountFee:",w.fee?.toString()??0),{inputAmountFee:l,anotherAmount:f,maxAnotherAmount:w,minAnotherAmount:k,liquidity:y}}};function Ff(r,e,t,n){let o=r.mul(e).div(n);!o.isZero()&&!r.mul(e).mod(n).isZero()&&(o=o.add(new _e(1)));let i=r.mul(t).div(n);return!i.isZero()&&!r.mul(t).mod(n).isZero()&&(i=i.add(new _e(1))),{amountA:o,amountB:i}}import{PublicKey as to}from"@solana/web3.js";import{createTransferInstruction as hl,TOKEN_PROGRAM_ID as qe,TOKEN_2022_PROGRAM_ID as Qr}from"@solana/spl-token";import zr from"bn.js";var gl={[ir.toBase58()]:3},Al={3:ir};var va=O([ke(5),ke(8),L("ownAddress"),P("vaultSignerNonce"),L("baseMint"),L("quoteMint"),L("baseVault"),P("baseDepositsTotal"),P("baseFeesAccrued"),L("quoteVault"),P("quoteDepositsTotal"),P("quoteFeesAccrued"),P("quoteDustThreshold"),L("requestQueue"),L("eventQueue"),L("bids"),L("asks"),P("baseLotSize"),P("quoteLotSize"),P("feeRateBps"),P("referrerRebatesAccrued"),ke(7)]),Pl={3:va};import{PublicKey as wl}from"@solana/web3.js";var Gr=de("Serum"),Xr=class{static getProgramId(e){let t=Al[e];return t||Gr.logWithError("invalid version","version",e),t}static getVersion(e){let t=e.toBase58(),n=gl[t];return n||Gr.logWithError("invalid program id","programId",t),n}static getStateLayout(e){let t=Pl[e];return t||Gr.logWithError(!!t,"invalid version","version",e),t}static getLayouts(e){return{state:this.getStateLayout(e)}}static getAssociatedAuthority({programId:e,marketId:t}){let n=[t.toBuffer()],o=0,i;for(;o<100;){try{let s=n.concat(Buffer.from([o]),Buffer.alloc(7));i=wl.createProgramAddressSync(s,e)}catch(s){if(s instanceof TypeError)throw s;o++;continue}return{publicKey:i,nonce:o}}return Gr.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),{publicKey:wl.default,nonce:o}}};import{PublicKey as R,SystemProgram as Ki,TransactionInstruction as Ci}from"@solana/web3.js";import an from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Ma,TOKEN_2022_PROGRAM_ID as Ea,TOKEN_PROGRAM_ID as Vn}from"@solana/spl-token";function wK(r,e,t,n,o,i,s,a,c,u,l,d){let m=O([F("instruction"),P("amountIn"),P("amountOut")]),p=[{pubkey:Ki.programId,isSigner:!1,isWritable:!1},{pubkey:Vn,isSigner:!1,isWritable:!1},{pubkey:new R(t.programId),isSigner:!1,isWritable:!1},{pubkey:new R(t.id),isSigner:!1,isWritable:!0},{pubkey:new R(n.id),isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let f=Le(t);p.push({pubkey:f.config.id,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(c)?f.vault.A:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.mintA.address.equals(c)?f.vault.B:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},...d.map(b=>({pubkey:b,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let f=Le(t);p.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:new R("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0})}else{let f=Le(t);p.push({pubkey:f.authority,isSigner:!1,isWritable:!1},{pubkey:f.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:f.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:f.openOrders,isSigner:!1,isWritable:!0},{pubkey:f.vault.A,isSigner:!1,isWritable:!0},{pubkey:f.vault.B,isSigner:!1,isWritable:!0},{pubkey:f.marketId,isSigner:!1,isWritable:!0},{pubkey:f.marketBids,isSigner:!1,isWritable:!0},{pubkey:f.marketAsks,isSigner:!1,isWritable:!0},{pubkey:f.marketEventQueue,isSigner:!1,isWritable:!0},...f.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:f.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:f.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:f.id,isSigner:!1,isWritable:!0},{pubkey:f.id,isSigner:!1,isWritable:!0}])}let y=Buffer.alloc(m.span);return m.encode({instruction:4,amountIn:u,amountOut:l},y),new Ci({keys:p,programId:r,data:y})}function kK(r,e,t,n,o,i,s,a,c,u){let l=O([F("instruction")]),d=[{pubkey:Ki.programId,isSigner:!1,isWritable:!1},{pubkey:Vn,isSigner:!1,isWritable:!1},{pubkey:new R(String(n.programId)),isSigner:!1,isWritable:!1},{pubkey:new R(String(n.id)),isSigner:!1,isWritable:!0},{pubkey:new R(String(t.id)),isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!1}];if(e.type==="Concentrated"){let p=Le(n);d.push({pubkey:p.config.id,isSigner:!1,isWritable:!1},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.mintA.address.equals(c)?p.vault.A:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.mintA.address.equals(c)?p.vault.B:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0},...u.map(y=>({pubkey:y,isSigner:!1,isWritable:!0})))}else if(e.pooltype.includes("StablePool")){let p=Le(n);d.push({pubkey:p.authority,isSigner:!1,isWritable:!1},{pubkey:p.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:new R("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),isSigner:!1,isWritable:!1},{pubkey:p.openOrders,isSigner:!1,isWritable:!0},{pubkey:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.marketId,isSigner:!1,isWritable:!0},{pubkey:p.marketBids,isSigner:!1,isWritable:!0},{pubkey:p.marketAsks,isSigner:!1,isWritable:!0},{pubkey:p.marketEventQueue,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0})}else{let p=Le(n);d.push({pubkey:p.authority,isSigner:!1,isWritable:!1},{pubkey:p.marketProgramId,isSigner:!1,isWritable:!1},{pubkey:p.marketAuthority,isSigner:!1,isWritable:!1},{pubkey:p.openOrders,isSigner:!1,isWritable:!0},{pubkey:p.vault.A,isSigner:!1,isWritable:!0},{pubkey:p.vault.B,isSigner:!1,isWritable:!0},{pubkey:p.marketId,isSigner:!1,isWritable:!0},{pubkey:p.marketBids,isSigner:!1,isWritable:!0},{pubkey:p.marketAsks,isSigner:!1,isWritable:!0},{pubkey:p.marketEventQueue,isSigner:!1,isWritable:!0},...p.marketProgramId.toString()==="srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"?[{pubkey:p.marketBaseVault,isSigner:!1,isWritable:!0},{pubkey:p.marketQuoteVault,isSigner:!1,isWritable:!0}]:[{pubkey:p.id,isSigner:!1,isWritable:!0},{pubkey:p.id,isSigner:!1,isWritable:!0}])}let m=Buffer.alloc(l.span);return l.encode({instruction:5},m),new Ci({keys:d,programId:r,data:m})}function Vf(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y){let f=[],b=[A({pubkey:Vn,isWritable:!1}),A({pubkey:Ea,isWritable:!1}),A({pubkey:Ma,isWritable:!1}),A({pubkey:Ki.programId,isWritable:!1}),A({pubkey:e,isSigner:!0})];b.push(A({pubkey:t})),b.push(A({pubkey:o}));let g=[c,u],w=[l,d],k=[i,s,a];for(let T=0;T<g.length;T++){let B=g[T],S=k[T]===B.mintA.address;if(b.push(A({pubkey:new R(B.programId),isWritable:!1})),T===g.length-1?b.push(A({pubkey:o})):b.push(A({pubkey:n})),b.push(A({pubkey:new R(k[T])})),b.push(A({pubkey:new R(k[T+1])})),B.version===6){let I=w[T];b.push(A({pubkey:new R(I.config.id)})),b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(S?I.vault.A:I.vault.B)})),b.push(A({pubkey:new R(S?I.vault.B:I.vault.A)})),b.push(A({pubkey:new R(B.observationId)})),b.push(A({pubkey:on})),b.push(A({pubkey:De(new R(B.programId),new R(B.id)).publicKey})),f.push(_a(B.sqrtPriceX64.toString(),S));for(let K of y[T]??[])b.push(A({pubkey:new R(K)}))}else if(B.version===5){let I=w[T];b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(I.authority),isWritable:!1})),b.push(A({pubkey:new R(I.marketProgramId)})),b.push(A({pubkey:new R(I.marketAuthority)})),b.push(A({pubkey:rr,isWritable:!1})),b.push(A({pubkey:new R(I.openOrders)})),b.push(A({pubkey:new R(I.vault.A)})),b.push(A({pubkey:new R(I.vault.B)})),b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(I.marketId)})),b.push(A({pubkey:new R(I.marketBids)})),b.push(A({pubkey:new R(I.marketAsks)})),b.push(A({pubkey:new R(I.marketEventQueue)})),b.push(A({pubkey:new R(I.marketBaseVault)})),b.push(A({pubkey:new R(I.marketQuoteVault)}))}else if(B.version===4){let I=w[T],K=B.status!==1;b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(I.authority),isWritable:!1})),b.push(A({pubkey:new R(K?I.id:I.marketProgramId)})),b.push(A({pubkey:new R(K?I.id:I.marketAuthority)})),b.push(A({pubkey:new R(K?I.id:I.openOrders)})),b.push(A({pubkey:new R(I.vault.A)})),b.push(A({pubkey:new R(I.vault.B)})),b.push(A({pubkey:new R(K?I.id:I.marketId)})),b.push(A({pubkey:new R(K?I.id:I.marketBids)})),b.push(A({pubkey:new R(K?I.id:I.marketAsks)})),b.push(A({pubkey:new R(K?I.id:I.marketEventQueue)})),b.push(A({pubkey:new R(K?I.id:I.marketBaseVault)})),b.push(A({pubkey:new R(K?I.id:I.marketQuoteVault)}))}else if(B.version===7){let I=w[T];b.push(A({pubkey:new R(I.authority)})),b.push(A({pubkey:new R(I.config.id)})),b.push(A({pubkey:new R(I.id)})),b.push(A({pubkey:new R(S?I.vault.A:I.vault.B)})),b.push(A({pubkey:new R(S?I.vault.B:I.vault.A)})),b.push(A({pubkey:new R(B.observationId)}))}else throw Error("pool type error")}let h=O([F("insId"),P("amountIn"),P("amountOut"),Q($(),f.length,"clmmPriceLimit")]),x=Buffer.alloc(h.span);return h.encode({insId:0,amountIn:m,amountOut:p,clmmPriceLimit:f},x),new Ci({keys:b,programId:r,data:x})}function _a(r,e){if(r)if(e){let t=new an(r).div(new an(25));return t.gt(Ir)?t:Ir}else{let t=new an(r).mul(new an(25));return t.lt(Br)?t:Br}else return e?Ir:Br}function kl({routeProgram:r,ownerInfo:e,inputMint:t,swapInfo:n}){if(n.routeType==="amm")if(n.poolInfo[0].version===6){let o=n.poolKey[0],i=Le(o),s=t.equals(i.mintA.address)?_t.add(Rt):Ft.sub(Rt);return Be.makeSwapBaseInInstructions({poolInfo:o,poolKeys:o,observationId:n.poolInfo[0].observationId,ownerInfo:{wallet:e.wallet,tokenAccountA:i.mintA.address.equals(t)?e.sourceToken:e.destinationToken,tokenAccountB:i.mintA.address.equals(t)?e.destinationToken:e.sourceToken},inputMint:t,amountIn:n.amountIn.amount.raw,amountOutMin:n.minAmountOut.amount.raw.sub(n.minAmountOut.fee?.raw??new an(0)),sqrtPriceLimitX64:s,remainingAccounts:n.remainingAccounts[0]??[]})}else if(n.poolInfo[0].version===7){let o=n.poolInfo[0],i=t.toString()===n.poolInfo[0].mintA.address;return{signers:[],instructions:[Ur(o.programId,e.wallet,o.authority,o.configId,o.id,e.sourceToken,e.destinationToken,i?o.vaultA:o.vaultB,i?o.vaultB:o.vaultA,i?o.mintProgramA:o.mintProgramB,i?o.mintProgramB:o.mintProgramA,new R(o[i?"mintA":"mintB"].address),new R(o[i?"mintB":"mintA"].address),o.observationId,n.amountIn.amount.raw,n.minAmountOut.amount.raw)],lookupTableAddress:[],instructionTypes:[i?V.CpmmSwapBaseIn:V.CpmmSwapBaseOut],address:{}}}else{let o=n.poolKey[0];return{signers:[],instructions:[Nr({poolKeys:o,version:n.poolInfo[0].pooltype.includes("StablePool")?5:4,userKeys:{tokenAccountIn:e.sourceToken,tokenAccountOut:e.destinationToken,owner:e.wallet},amountIn:n.amountIn.amount.raw,amountOut:n.minAmountOut.amount.raw.sub(n.minAmountOut.fee?.raw??new an(0)),fixedSide:"in"})],lookupTableAddress:o.lookupTableAccount?[o.lookupTableAccount]:[],instructionTypes:[n.poolInfo[0].pooltype.includes("StablePool")?V.AmmV5SwapBaseIn:V.AmmV4SwapBaseIn],address:{}}}else if(n.routeType==="route"){let o=n.poolInfo[0],i=n.poolInfo[1],s=n.poolKey[0],a=n.poolKey[1];if(e.routeToken===void 0)throw Error("owner route token account check error");return{signers:[],instructions:[Vf(r,e.wallet,e.sourceToken,e.routeToken,e.destinationToken,t.toString(),n.middleToken.mint.toString(),n.outputMint.toString(),o,i,s,a,n.amountIn.amount.raw,n.minAmountOut.amount.raw.sub(n.minAmountOut.fee?.raw??new an(0)),n.remainingAccounts)],instructionTypes:[V.RouteSwap],lookupTableAddress:[s.lookupTableAccount,a.lookupTableAccount].filter(c=>c!==void 0),address:{}}}else throw Error("route type error")}function hK({programId:r,wallet:e,amount:t,inputAccount:n,outputAccount:o,routeInfo:i,poolKeys:s}){if(i.success===!1)throw Error("route info error");let a=[],c=[A({pubkey:Vn,isWritable:!1}),A({pubkey:Ea,isWritable:!1}),A({pubkey:Ma,isWritable:!1}),A({pubkey:Ki.programId,isWritable:!1}),A({pubkey:e,isSigner:!0})],u={[i.data.inputMint]:n,[i.data.outputMint]:o};c.push(A({pubkey:u[i.data.inputMint]})),c.push(A({pubkey:u[i.data.outputMint]}));for(let m=0;m<s.length;m++){let p=i.data.routePlan[m],y=s[m],f=p.inputMint===y.mintA.address;if(c.push(A({pubkey:new R(y.programId),isWritable:!1})),m===s.length-1)c.push(A({pubkey:u[p.outputMint]}));else{let b=p.outputMint;if(u[b]===void 0){let g=Y(e,new R(b),y.programId===yt.CLMM_PROGRAM_ID.toBase58()||y.programId===yt.CREATE_CPMM_POOL_PROGRAM.toBase58()?new R(f?y.mintB.programId:y.mintA.programId):Vn).publicKey;u[b]=g}c.push(A({pubkey:u[b]}))}if(c.push(A({pubkey:new R(p.inputMint)})),c.push(A({pubkey:new R(p.outputMint)})),y.programId===yt.CLMM_PROGRAM_ID.toBase58()){let b=y;c.push(A({pubkey:new R(b.config.id)})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(f?b.vault.A:b.vault.B)})),c.push(A({pubkey:new R(f?b.vault.B:b.vault.A)})),c.push(A({pubkey:new R(b.observationId)})),c.push(A({pubkey:on,isWritable:!1})),c.push(A({pubkey:new R(b.exBitmapAccount)})),a.push(_a(p.lastPoolPriceX64,f));for(let g of p.remainingAccounts??[])c.push(A({pubkey:new R(g)}))}else if(y.programId===yt.AMM_STABLE.toBase58()){let b=y;c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.authority),isWritable:!1})),c.push(A({pubkey:new R(b.marketProgramId),isWritable:!1})),c.push(A({pubkey:new R(b.marketAuthority),isWritable:!1})),c.push(A({pubkey:rr,isWritable:!1})),c.push(A({pubkey:new R(b.openOrders)})),c.push(A({pubkey:new R(b.vault.A)})),c.push(A({pubkey:new R(b.vault.B)})),c.push(A({pubkey:new R(b.marketId)})),c.push(A({pubkey:new R(b.marketBids)})),c.push(A({pubkey:new R(b.marketAsks)})),c.push(A({pubkey:new R(b.marketEventQueue)})),c.push(A({pubkey:new R(b.marketBaseVault)})),c.push(A({pubkey:new R(b.marketQuoteVault)}))}else if(y.programId===yt.AMM_V4.toBase58()){let b=y;c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.authority),isWritable:!1})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.vault.A)})),c.push(A({pubkey:new R(b.vault.B)})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(b.id)}))}else if(y.programId===yt.CREATE_CPMM_POOL_PROGRAM.toBase58()){let b=y;c.push(A({pubkey:new R(b.authority)})),c.push(A({pubkey:new R(b.config.id)})),c.push(A({pubkey:new R(b.id)})),c.push(A({pubkey:new R(f?b.vault.A:b.vault.B)})),c.push(A({pubkey:new R(f?b.vault.B:b.vault.A)})),c.push(A({pubkey:new R(b.observationId)}))}else throw Error("pool type error")}let l=O([F("insId"),P("amountIn"),P("amountOut"),Q($(),a.length,"clmmPriceLimit")]),d=Buffer.alloc(l.span);return l.encode({insId:0,amountIn:t,amountOut:new an(i.data.otherAmountThreshold),clmmPriceLimit:a},d),new Ci({keys:c,programId:r,data:d})}function TK({programId:r,wallet:e,inputAccount:t,outputAccount:n,routeInfo:o,poolKeys:i}){if(o.success===!1)throw Error("route info error");let s=[],a=[A({pubkey:Vn,isWritable:!1}),A({pubkey:Ea,isWritable:!1}),A({pubkey:Ma,isWritable:!1}),A({pubkey:Ki.programId,isWritable:!1}),A({pubkey:e,isSigner:!0})],c={[o.data.inputMint]:t,[o.data.outputMint]:n};for(let d=i.length-1;d>=0;d--){let m=o.data.routePlan[d],p=i[d],y=m.inputMint===p.mintA.address;if(a.push(A({pubkey:new R(p.programId)})),d===0)a.push(A({pubkey:c[m.inputMint]}));else{let f=m.inputMint;if(c[f]===void 0){let b=Y(e,new R(f),p.programId===yt.CLMM_PROGRAM_ID.toBase58()||p.programId===yt.CREATE_CPMM_POOL_PROGRAM.toBase58()?new R(y?p.mintA.programId:p.mintB.programId):Vn).publicKey;c[f]=b}a.push(A({pubkey:c[f]}))}if(d===i.length-1)a.push(A({pubkey:c[m.outputMint]}));else{let f=m.outputMint;if(c[f]===void 0){let b=Y(e,new R(f),p.programId===yt.CLMM_PROGRAM_ID.toBase58()||p.programId===yt.CREATE_CPMM_POOL_PROGRAM.toBase58()?new R(y?p.mintB.programId:p.mintA.programId):Vn).publicKey;c[f]=b}a.push(A({pubkey:c[f]}))}if(a.push(A({pubkey:new R(m.inputMint)})),a.push(A({pubkey:new R(m.outputMint)})),p.programId===yt.CLMM_PROGRAM_ID.toBase58()){let f=p;a.push(A({pubkey:new R(f.config.id)})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(y?f.vault.A:f.vault.B)})),a.push(A({pubkey:new R(y?f.vault.B:f.vault.A)})),a.push(A({pubkey:new R(f.observationId)})),a.push(A({pubkey:on,isWritable:!1})),a.push(A({pubkey:new R(f.exBitmapAccount)})),s.push(_a(m.lastPoolPriceX64,y));for(let b of m.remainingAccounts??[])a.push(A({pubkey:new R(b)}))}else if(p.programId===yt.AMM_STABLE.toBase58()){let f=p;a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.authority),isWritable:!1})),a.push(A({pubkey:new R(f.marketProgramId),isWritable:!1})),a.push(A({pubkey:new R(f.marketAuthority),isWritable:!1})),a.push(A({pubkey:rr,isWritable:!1})),a.push(A({pubkey:new R(f.openOrders)})),a.push(A({pubkey:new R(f.vault.A)})),a.push(A({pubkey:new R(f.vault.B)})),a.push(A({pubkey:new R(f.marketId)})),a.push(A({pubkey:new R(f.marketBids)})),a.push(A({pubkey:new R(f.marketAsks)})),a.push(A({pubkey:new R(f.marketEventQueue)})),a.push(A({pubkey:new R(f.marketBaseVault)})),a.push(A({pubkey:new R(f.marketQuoteVault)}))}else if(p.programId===yt.AMM_V4.toBase58()){let f=p;a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.authority),isWritable:!1})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.vault.A)})),a.push(A({pubkey:new R(f.vault.B)})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(f.id)}))}else if(p.programId===yt.CREATE_CPMM_POOL_PROGRAM.toBase58()){let f=p;a.push(A({pubkey:new R(f.authority)})),a.push(A({pubkey:new R(f.config.id)})),a.push(A({pubkey:new R(f.id)})),a.push(A({pubkey:new R(y?f.vault.A:f.vault.B)})),a.push(A({pubkey:new R(y?f.vault.B:f.vault.A)})),a.push(A({pubkey:new R(f.observationId)}))}else throw Error("pool type error")}let u=O([F("insId"),P("amountIn"),P("amountOut"),Q($(),s.length,"clmmPriceLimit")]),l=Buffer.alloc(u.span);return u.encode({insId:1,amountIn:new an(o.data.otherAmountThreshold),amountOut:new an(o.data.outputAmount),clmmPriceLimit:s},l),new Ci({keys:a,programId:r,data:l})}var hn=new zr(0),Li=class extends Re{constructor(e){super(e)}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals(j));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n,txVersion:o=1,feePayer:i}=e,s=await this.getWSolAccounts(),a=this.createTxBuilder(i);a.addCustomComputeBudget(e.computeBudgetConfig);let c=Z(t);for(let u=0;u<s.length;u++)c.gte(s[u].amount)?(a.addInstruction({instructions:[bn({tokenAccount:s[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),c.sub(s[u].amount)):a.addInstruction({instructions:[bn({tokenAccount:s[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]});return a.versionBuild({txVersion:o})}async wrapWSol(e,t,n,o){let i=this.createTxBuilder(o),s=await Nn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return i.addInstruction(s),i.versionBuild({txVersion:n??1})}async swap({swapInfo:e,swapPoolKeys:t,ownerInfo:n,computeBudgetConfig:o,routeProgram:i,txVersion:s,feePayer:a}){let c=this.createTxBuilder(a),u=e.amountIn,l=e.amountOut,d=u.amount.token.mint.equals(j),m=l.amount.token.mint.equals(j),p=u.amount.token.mint,y=l.amount.token.mint,{account:f,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.amount.token.isToken2022?Qr:qe,mint:p,notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!d,createInfo:d?{payer:this.scope.ownerPubKey,amount:u.amount.raw}:void 0,associatedOnly:d?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});if(b&&c.addInstruction(b),f===void 0)throw Error("input account check error");let g;if(e.routeType==="route"&&!m)g=this.scope.account.getAssociatedTokenAccount(y,l.amount.token.isToken2022?Qr:qe);else{let{account:x,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:l.amount.token.isToken2022?Qr:qe,mint:y,notUseTokenAccount:m,owner:this.scope.ownerPubKey,skipCloseAccount:!0,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:m?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});g=x,T&&c.addInstruction(T)}m&&c.addInstruction({endInstructions:[bn({owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,tokenAccount:g,programId:qe})],endInstructionTypes:[V.CloseAccount]});let w;if(e.routeType==="route"){let x=e.middleToken;w=this.scope.account.getAssociatedTokenAccount(x.mint,x.isToken2022?Qr:qe)}let k=t||await this.computePoolToPoolKeys({pools:e.poolInfoList}),h=kl({routeProgram:i,inputMint:p,swapInfo:{...e,poolInfo:[...e.poolInfoList],poolKey:k,outputMint:y},ownerInfo:{wallet:this.scope.ownerPubKey,sourceToken:f,routeToken:w,destinationToken:g}});if(e.feeConfig!==void 0){let x=this.createTxBuilder();x.addInstruction({instructions:[hl(f,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[V.TransferAmount]}),x.addInstruction(h);let{transactions:T}=s===0?await x.sizeCheckBuildV0():await x.sizeCheckBuild();T.length<2&&c.addInstruction({instructions:[hl(f,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[V.TransferAmount]})}return c.addInstruction(h),s===0?c.sizeCheckBuildV0({computeBudgetConfig:o,address:h.address}):c.sizeCheckBuild({computeBudgetConfig:o,address:h.address})}async fetchRoutePoolBasicInfo(e){let{amm:t=Fo,clmm:n=Kn,cpmm:o=Wo}=e||{},i=await this.scope.connection.getProgramAccounts(t,{dataSlice:{offset:Hn.offsetOf("baseMint"),length:64}}),s=O([L("baseMint"),L("quoteMint")]),a=i.map(p=>({id:p.pubkey,version:4,mintA:s.decode(p.account.data).baseMint,mintB:s.decode(p.account.data).quoteMint})),c=O([L("mintA"),L("mintB")]),l=(await this.scope.connection.getProgramAccounts(n,{filters:[{dataSize:Qn.span}],dataSlice:{offset:Qn.offsetOf("mintA"),length:64}})).map(p=>{let y=c.decode(p.account.data);return{id:p.pubkey,version:6,mintA:y.mintA,mintB:y.mintB}}),m=(await this.scope.connection.getProgramAccounts(o,{dataSlice:{offset:xi.offsetOf("mintA"),length:64}})).map(p=>{let y=c.decode(p.account.data);return{id:p.pubkey,version:7,mintA:y.mintA,mintB:y.mintB}});return{clmmPools:l,ammPools:a,cpmmPools:m}}getAllRoute({inputMint:e,outputMint:t,clmmPools:n,ammPools:o,cpmmPools:i}){e=e.toString()===to.default.toString()?j:e,t=t.toString()===to.default.toString()?j:t;let s={},a={},c={},u=[],l={};for(let m of n??[]){if((m.mintA.equals(e)&&m.mintB.equals(t)||m.mintA.equals(t)&&m.mintB.equals(e))&&(u.push(m),a[m.id.toString()]=m),m.mintA.equals(e)){let p=m.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[p].in.push(m)}if(m.mintB.equals(e)){let p=m.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[p].in.push(m)}if(m.mintA.equals(t)){let p=m.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[p].out.push(m)}if(m.mintB.equals(t)){let p=m.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[p].out.push(m)}}let d=[];for(let m of o)(m.mintA.equals(e)&&m.mintB.equals(t)||m.mintA.equals(t)&&m.mintB.equals(e))&&(u.push(m),s[m.id.toBase58()]=m,d.push(m)),m.mintA.equals(e)&&(l[m.mintB.toBase58()]===void 0&&(l[m.mintB.toBase58()]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[m.mintB.toBase58()].in.push(m)),m.mintB.equals(e)&&(l[m.mintA.toBase58()]===void 0&&(l[m.mintA.toBase58()]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[m.mintA.toBase58()].in.push(m)),m.mintA.equals(t)&&(l[m.mintB.toBase58()]===void 0&&(l[m.mintB.toBase58()]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[m.mintB.toBase58()].out.push(m)),m.mintB.equals(t)&&(l[m.mintA.toBase58()]===void 0&&(l[m.mintA.toBase58()]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[m.mintA.toBase58()].out.push(m));for(let m of i)(m.mintA.equals(e)&&m.mintB.equals(t)||m.mintA.equals(t)&&m.mintB.equals(e))&&(u.push(m),c[m.id.toBase58()]=m),m.mintA.equals(e)&&(l[m.mintB.toBase58()]===void 0&&(l[m.mintB.toBase58()]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[m.mintB.toBase58()].in.push(m)),m.mintB.equals(e)&&(l[m.mintA.toBase58()]===void 0&&(l[m.mintA.toBase58()]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[m.mintA.toBase58()].in.push(m)),m.mintA.equals(t)&&(l[m.mintB.toBase58()]===void 0&&(l[m.mintB.toBase58()]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[m.mintB.toBase58()].out.push(m)),m.mintB.equals(t)&&(l[m.mintA.toBase58()]===void 0&&(l[m.mintA.toBase58()]={mintProgram:qe,in:[],out:[],mDecimals:0}),l[m.mintA.toBase58()].out.push(m));for(let m of Object.keys(l)){if(l[m].in.length===1&&l[m].out.length===1&&l[m].in[0].id.equals(l[m].out[0].id)){delete l[m];continue}if(l[m].in.length===0||l[m].out.length===0){delete l[m];continue}let p=l[m];for(let y of p.in)for(let f of p.out)y.version===6&&a[y.id.toString()]===void 0?a[y.id.toString()]=y:y.version===7&&c[y.id.toString()]===void 0?c[y.id.toString()]=y:(y.version===4||y.version===5)&&s[y.id.toString()]===void 0&&(s[y.id.toString()]=y),f.version===6&&a[f.id.toString()]===void 0?a[f.id.toString()]=f:f.version===7&&c[f.id.toString()]===void 0?c[f.id.toString()]=f:(f.version===4||f.version===5)&&s[f.id.toString()]===void 0&&(s[f.id.toString()]=f)}return{directPath:u,addLiquidityPools:d,routePathDict:l,needSimulate:Object.values(s),needTickArray:Object.values(a),cpmmPoolList:Object.values(c)}}async fetchSwapRoutesData({routes:e,inputMint:t,outputMint:n}){let o=new Set([...e.needTickArray.map(f=>[f.mintA.toBase58(),f.mintB.toBase58()]).flat(),t.toString(),n.toString()]);console.log("fetching amm pools info, total: ",e.needSimulate.length);let i=await this.scope.liquidity.getRpcPoolInfos(e.needSimulate.map(f=>f.id)),s=vr(i),a={};Object.values(s).forEach(f=>{o.delete(f.mintA.address),a[f.mintA.address]={address:new to(f.mintA.address),programId:qe,mintAuthority:null,supply:BigInt(0),decimals:f.mintA.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0},o.delete(f.mintB.address),a[f.mintB.address]={address:new to(f.mintB.address),programId:qe,mintAuthority:null,supply:BigInt(0),decimals:f.mintB.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}}),console.log("fetching cpmm pools info, total: ",e.cpmmPoolList.length);let c=await this.scope.cpmm.getRpcPoolInfos(e.cpmmPoolList.map(f=>f.id.toBase58()),!0);Object.values(c).forEach(f=>{let[b,g]=[f.mintA.toBase58(),f.mintB.toBase58()];f.mintProgramA.equals(qe)?(o.delete(b),a[b]={address:f.mintA,programId:f.mintProgramA,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalA,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):o.add(b),f.mintProgramB.equals(qe)?(o.delete(g),a[g]={address:f.mintB,programId:f.mintProgramB,mintAuthority:null,supply:BigInt(0),decimals:f.mintDecimalB,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):o.add(g)}),console.log("fetching mints info, total: ",o.size);let u=await io({connection:this.scope.connection,mints:Array.from(o).map(f=>new to(f))});a={...a,...u};let l=this.scope.cpmm.toComputePoolInfos({pools:c,mintInfos:a});console.log("fetching clmm pools info, total:",e.needTickArray.length);let d=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:e.needTickArray.map(f=>f.id)}),{computeClmmPoolInfo:m,computePoolTickData:p}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:d,mintInfos:a}),y=Object.keys(e.routePathDict).reduce((f,b)=>({...f,[b]:{...e.routePathDict[b],mintProgram:a[b].programId,mDecimals:a[b].decimals,in:e.routePathDict[b].in.map(g=>s[g.id.toBase58()]||m[g.id.toBase58()]||l[g.id.toBase58()]),out:e.routePathDict[b].out.map(g=>s[g.id.toBase58()]||m[g.id.toBase58()]||l[g.id.toBase58()])}}),{});return{mintInfos:a,ammPoolsRpcInfo:i,ammSimulateCache:s,clmmPoolsRpcInfo:d,computeClmmPoolInfo:m,computePoolTickData:p,computeCpmmData:l,routePathDict:y}}getAllRouteComputeAmountOut({inputTokenAmount:e,outputToken:t,directPath:n,routePathDict:o,simulateCache:i,tickCache:s,slippage:a,chainTime:c,epochInfo:u,feeConfig:l}){let d=l===void 0?new zr(0):e.raw.mul(new zr(l.feeBps.toNumber())).div(new zr(1e4)),m=e.raw.sub(d),p=new he(e.token,m),y=l===void 0?void 0:{feeAmount:d,feeAccount:l.feeAccount},f={...t,address:ct(t.address).toString()},b=[];for(let g of n)try{b.push({...this.computeAmountOut({itemPool:g,tickCache:s,simulateCache:i,chainTime:c,epochInfo:u,slippage:a,outputToken:f,amountIn:p}),feeConfig:y})}catch(w){this.logDebug("direct error",g.version,g.id.toString(),w.message)}this.logDebug("direct done");for(let[g,w]of Object.entries(o)){let k={chainId:101,address:g,programId:w.mintProgram.toBase58(),logoURI:"",symbol:"",name:"",decimals:w.mDecimals,tags:[],extensions:{}},h=w.in.map(T=>{try{return{pool:T,data:this.computeAmountOut({itemPool:T,tickCache:s,simulateCache:i,chainTime:c,epochInfo:u,slippage:a,outputToken:k,amountIn:p})}}catch(B){this.logDebug("route in error",T.version,T.id.toString(),B.message);return}}).sort((T,B)=>{let S=T===void 0?hn:T.data.amountOut.amount.raw.sub(T.data.amountOut.fee?.raw??hn),I=B===void 0?hn:B.data.amountOut.amount.raw.sub(B.data.amountOut.fee?.raw??hn);return S.lt(I)?1:-1})[0];if(h===void 0)continue;let x=new he(Lr(k),h.data.amountOut.amount.raw.sub(h.data.amountOut.fee?.raw??hn));for(let T of w.out)try{let B=this.computeAmountOut({itemPool:T,tickCache:s,simulateCache:i,chainTime:c,epochInfo:u,slippage:a,outputToken:f,amountIn:x});b.push({...B,allTrade:!!(h.data.allTrade&&B.allTrade),amountIn:h.data.amountIn,amountOut:B.amountOut,minAmountOut:B.minAmountOut,currentPrice:void 0,executionPrice:new C(new ht({baseToken:h.data.amountIn.amount.token,denominator:h.data.amountIn.amount.raw,quoteToken:B.amountOut.amount.token,numerator:B.amountOut.amount.raw.sub(B.amountOut.fee?.raw??hn)}).toFixed()),priceImpact:new C(h.data.priceImpact.add(B.priceImpact).toFixed()),fee:[h.data.fee[0],B.fee[0]],routeType:"route",poolInfoList:[h.pool,T],remainingAccounts:[h.data.remainingAccounts[0],B.remainingAccounts[0]],minMiddleAmountFee:B.amountOut.fee?.raw?new he(h.data.amountOut.amount.token,(h.data.amountOut.fee?.raw??hn).add(B.amountOut.fee?.raw??hn)):void 0,middleToken:h.data.amountOut.amount.token,poolReady:h.data.poolReady&&B.poolReady,poolType:[h.data.poolType,B.poolType],feeConfig:y,expirationTime:Qt(h.data.expirationTime,B.expirationTime)})}catch(B){this.logDebug("route out error",T.version,T.id.toString(),B.message)}}return b.filter(g=>(g.allTrade||this.logDebug(`pool ${g.poolInfoList.map(w=>w.id.toString()).join(",")} filter out since not all trade`),g.allTrade)).sort((g,w)=>g.amountOut.amount.raw.sub(w.amountOut.amount.raw).gt(hn)?-1:1)}computeAmountOut({itemPool:e,tickCache:t,simulateCache:n,chainTime:o,epochInfo:i,slippage:s,outputToken:a,amountIn:c}){if(e.version===6){let{allTrade:u,realAmountIn:l,amountOut:d,minAmountOut:m,expirationTime:p,currentPrice:y,executionPrice:f,priceImpact:b,fee:g,remainingAccounts:w,executionPriceX64:k}=Ce.computeAmountOutFormat({poolInfo:e,tickArrayCache:t[e.id.toString()],amountIn:c.raw,tokenOut:a,slippage:s,epochInfo:i,catchLiquidityInsufficient:!0});return{allTrade:u,amountIn:l,amountOut:d,minAmountOut:m,currentPrice:new C(y.toFixed()),executionPrice:new C(f.toFixed()),priceImpact:new C(b.toFixed()),fee:[g],remainingAccounts:[w],routeType:"amm",poolInfoList:[e],poolReady:e.startTime<o,poolType:"CLMM",slippage:s,clmmExPriceX64:[k],expirationTime:Qt(l.expirationTime,p)}}else if(e.version===7){let{allTrade:u,executionPrice:l,amountOut:d,minAmountOut:m,priceImpact:p,fee:y}=this.scope.cpmm.computeSwapAmount({pool:e,outputMint:a.address,amountIn:c.raw,slippage:s});return{allTrade:u,amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:yi({...a,amount:d}),fee:void 0,expirationTime:void 0},minAmountOut:{amount:yi({...a,amount:m}),fee:void 0,expirationTime:void 0},currentPrice:e.poolPrice,executionPrice:l,priceImpact:p,fee:[new he(c.token,y)],remainingAccounts:[],routeType:"amm",poolInfoList:[e],poolReady:e.openTime.toNumber()<o,poolType:"CPMM",slippage:s,clmmExPriceX64:[void 0],expirationTime:void 0}}else{if(![1,6,7].includes(n[e.id.toString()].status))throw Error("swap error");let{amountOut:u,minAmountOut:l,currentPrice:d,executionPrice:m,priceImpact:p,fee:y}=this.scope.liquidity.computeAmountOut({poolInfo:n[e.id.toString()],amountIn:c.raw,mintIn:c.token.mint,mintOut:a.address,slippage:s});return{amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:yi({...a,amount:u}),fee:void 0,expirationTime:void 0},minAmountOut:{amount:yi({...a,amount:l}),fee:void 0,expirationTime:void 0},currentPrice:d,executionPrice:m,priceImpact:p,fee:[new he(c.token,y)],routeType:"amm",poolInfoList:[e],remainingAccounts:[],poolReady:Number(n[e.id].openTime)<o,poolType:e.version===5?"STABLE":void 0,expirationTime:void 0,allTrade:!0,slippage:s,clmmExPriceX64:[void 0]}}}async computePoolToPoolKeys({pools:e,clmmRpcData:t={},ammRpcData:n={}}){let o=new Set(e.filter(u=>u.version===6&&!t[u.id.toString()]).map(u=>u.id.toString()));if(o.size>0){let u=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:Array.from(o)});Object.keys(u).forEach(l=>{t[l]=u[l]})}let i=new Set(e.filter(u=>u.version===4&&!n[u.id.toString()]).map(u=>u.id.toString()));if(i.size>0){let u=await this.scope.liquidity.getRpcPoolInfos(Array.from(i));Object.keys(u).forEach(l=>{n[l]=u[l]})}let s=new Set(e.filter(u=>u.version===4).map(u=>u.marketId)),a={};s.size>0&&(await Se(this.scope.connection,Array.from(s).map(l=>({pubkey:new to(l)})))).forEach(l=>{if(!l.accountInfo)return;let d=va.decode(l.accountInfo.data);a[l.pubkey.toBase58()]={marketId:l.pubkey.toString(),marketProgramId:l.accountInfo.owner.toString(),marketAuthority:Xr.getAssociatedAuthority({programId:l.accountInfo.owner,marketId:l.pubkey}).publicKey.toString(),marketBaseVault:d.baseVault.toString(),marketQuoteVault:d.quoteVault.toString(),marketBids:d.bids.toString(),marketAsks:d.asks.toString(),marketEventQueue:d.eventQueue.toString()}});let c=[];return e.forEach(u=>{if(u.version===6){let l=t[u.id.toString()],d={programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.startTime),vault:{A:l.vaultA.toBase58(),B:l.vaultB.toBase58()},config:{...u.ammConfig,id:u.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]},rewardInfos:[],observationId:u.observationId.toBase58(),exBitmapAccount:u.exBitmapAccount.toBase58()};c.push(d)}else if(u.version===4){let l=n[u.id.toString()],d={programId:u.programId,id:u.id,mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),vault:{A:l.baseVault.toBase58(),B:l.quoteVault.toBase58()},authority:xa({programId:new to(u.programId)}).publicKey.toString(),openOrders:l.openOrders.toBase58(),targetOrders:l.targetOrders.toBase58(),mintLp:u.lpMint,...a[u.marketId]};c.push(d)}else u.version===7&&c.push({observationId:u.observationId.toBase58(),programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),authority:Bo(u.programId).publicKey.toBase58(),vault:{A:u.vaultA.toBase58(),B:u.vaultB.toBase58()},mintLp:pt({address:u.mintLp.toBase58(),programId:qe.toBase58(),decimals:u.lpDecimals}),config:{id:u.configId.toBase58(),...u.configInfo,protocolFeeRate:u.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:u.configInfo.tradeFeeRate.toNumber(),fundFeeRate:u.configInfo.fundFeeRate.toNumber(),createPoolFee:u.configInfo.createPoolFee.toString()}})}),c}};import{PublicKey as Wf,Transaction as Fa,TransactionInstruction as Df}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as qf}from"@solana/spl-token";import Tl from"bn.js";var ft=class extends Re{static getPdaPoolId(e,t){return ee([ft.SEED_CONFIG.pool.id,t.toBuffer()],e)}static getPdaOwnerId(e,t,n,o){return ee([ft.SEED_CONFIG.owner.id,t.toBuffer(),n.toBuffer(),Buffer.from(new Tl(o).toArray())],e)}static async getAllInfo({connection:e,programId:t,poolIds:n,wallet:o,chainTime:i}){if(n.length===0)return[];let s=n.map(l=>ft.getPdaPoolId(t,l).publicKey),a=[];for(let l=0;l<ft.VERSION_PROJECT.length;l++)a.push(...s.map(d=>ft.getPdaOwnerId(t,d,o,l).publicKey));let c=await Wt(e,[...s,...a]),u=[];for(let l=0;l<c.length;l++){let d=Math.floor(l/n.length),m=l%n.length,p=s[m],y=a[l],f=c[m],b=c[n.length+l];if(!(f&&b)||f.data.length!==ft.POOL_LAYOUT.span||b.data.length!==ft.OWNER_LAYOUT.span)continue;let g=ft.POOL_LAYOUT.decode(f.data),w=ft.OWNER_LAYOUT.decode(b.data),k=g.openTime.toNumber(),h=g.endTime.toNumber(),x=w.tokenInfo.map(S=>S.debtAmount.gt(new Tl(0))).filter(S=>!S).length!==3,T=i>k&&i<h&&g.status===1,B=x&&T;u.push({programId:t,poolId:p,ammId:g.ammId,ownerAccountId:y,snapshotLpAmount:w.lpAmount,project:ft.VERSION_PROJECT[d],openTime:k,endTime:h,canClaim:B,canClaimErrorType:x?T?void 0:"outOfOperationalTime":"alreadyClaimIt",tokenInfo:g.tokenInfo.map((S,I)=>({mintAddress:S.mintAddress,mintVault:S.mintVault,mintDecimals:S.mintDecimals,perLpLoss:S.perLpLoss,debtAmount:w.tokenInfo[I].debtAmount.add(w.tokenInfo[I].claimedAmount)}))})}return u}async makeClaimTransaction({poolInfo:e,ownerInfo:t,feePayer:n}){t.wallet||this.scope.checkOwner();let o=this.createTxBuilder(n),i=t.wallet||this.scope.ownerPubKey,s=[];for(let u of e.tokenInfo){let{account:l,instructionParams:d}=await this.scope.account.getOrCreateTokenAccount({mint:u.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:u.mintAddress.equals(Me.WSOL.mint),createInfo:{payer:i,amount:0},skipCloseAccount:!u.mintAddress.equals(Me.WSOL.mint),associatedOnly:u.mintAddress.equals(Me.WSOL.mint)?!1:t.associatedOnly});d&&o.addInstruction(d),s.push(l)}o.addInstruction({instructions:[ft.makeClaimInstruction({programId:e.programId,poolInfo:e,ownerInfo:{wallet:i,ownerPda:e.ownerAccountId,claimAddress:s}})]});let{transaction:a,signers:c}=o.build();return[{transaction:a,signer:c}]}async makeClaimAllTransaction({poolInfos:e,ownerInfo:t,feePayer:n}){let o=this.createTxBuilder(n),i=t.wallet||this.scope.ownerPubKey,s={};for(let l of e){let d=[];for(let m of l.tokenInfo){let{account:p,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({mint:m.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:m.mintAddress.equals(Me.WSOL.mint),createInfo:{payer:i,amount:0},skipCloseAccount:!m.mintAddress.equals(Me.WSOL.mint),associatedOnly:m.mintAddress.equals(Me.WSOL.mint)?!1:t.associatedOnly});y&&o.addInstruction(y),p&&(s[m.mintAddress.toString()]=p,d.push(p))}o.addInstruction({instructions:[ft.makeClaimInstruction({programId:l.programId,poolInfo:l,ownerInfo:{wallet:i,ownerPda:l.ownerAccountId,claimAddress:d}})]})}let{transaction:a,signers:c}=o.build(),u=o.allInstructions;return or(u,[i,...c.map(l=>l.publicKey)])?[{transaction:a,signer:c}]:[{transaction:new Fa().add(...u.slice(0,o.AllTxData.instructions.length-1)),signer:c},{transaction:new Fa().add(...u.slice(o.AllTxData.instructions.length-1)),signer:[]},{transaction:new Fa().add(...o.AllTxData.endInstructions),signer:[]}]}static makeClaimInstruction({programId:e,poolInfo:t,ownerInfo:n}){let o=O([]),i=[{pubkey:n.wallet,isSigner:!0,isWritable:!0},{pubkey:t.poolId,isSigner:!1,isWritable:!0},{pubkey:n.ownerPda,isSigner:!1,isWritable:!0},...n.claimAddress.map(c=>({pubkey:c,isSigner:!1,isWritable:!0})),...t.tokenInfo.map(({mintVault:c})=>({pubkey:c,isSigner:!1,isWritable:!0})),{pubkey:qf,isSigner:!1,isWritable:!1}],s=Buffer.alloc(o.span);o.encode({},s);let a=Buffer.from([10,66,208,184,161,6,191,98,...s]);return new Df({keys:i,programId:e,data:a})}},Vt=ft;Lt(Vt,"CLAIMED_NUM",3),Lt(Vt,"POOL_LAYOUT",O([ke(8),F("bump"),F("status"),P("openTime"),P("endTime"),L("ammId"),Q(O([F("mintDecimals"),L("mintAddress"),L("mintVault"),P("perLpLoss"),P("totalClaimedAmount")]),ft.CLAIMED_NUM,"tokenInfo"),Q(P(),10,"padding")])),Lt(Vt,"OWNER_LAYOUT",O([ke(8),F("bump"),F("version"),L("poolId"),L("owner"),P("lpAmount"),Q(O([L("mintAddress"),P("debtAmount"),P("claimedAmount")]),ft.CLAIMED_NUM,"tokenInfo"),Q(P(),4,"padding")])),Lt(Vt,"DEFAULT_POOL_ID",["58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2","6UmmUiYoBjSrhakAobJw8BvkmJtDVxaeBtbt7rxWo1mg","AVs9TA4nWDzfPJE9gGVNJMVhcQy3V9PGazuz33BfG2RA","DVa7Qmb5ct9RCpaU7UTpSaf3GVMYz17vNVU67XpdCRut","7XawhbbxtsRcQA8KTkHT9f9nc6d69UwqCDh6U5EEbEmX","6a1CsrpeZubDjEJE9s1CMVheB6HWM5d7m1cj2jkhyXhj","EoNrn8iUhwgJySD1pHu8Qxm5gSQqLK3za4m8xzD2RuEb","AceAyRTWt4PyB2pHqf2qhDgNZDtKVNaxgL8Ru3V4aN1P","6tmFJbMk5yVHFcFy7X2K8RwHjKLr6KVFLYXpgpBNeAxB"].map(e=>new Wf(e))),Lt(Vt,"SEED_CONFIG",{pool:{id:Buffer.from("pool_seed","utf8")},owner:{id:Buffer.from("user_claim_seed","utf8")}}),Lt(Vt,"VERSION_PROJECT",[void 0,"Francium","Tulip","Larix"]);import{PublicKey as Ni}from"@solana/web3.js";import Il from"bn.js";import{SYSVAR_CLOCK_PUBKEY as Uf,TransactionInstruction as Wa}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Da}from"@solana/spl-token";var Va=O([F("instruction"),Uu("amount")]),Ri=O([F("instruction")]);function bC({programId:r,amount:e,instructionKeys:t}){let n=[{pubkey:Zi,isSigner:!1,isWritable:!1},{pubkey:Da,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:Ps,isSigner:!1,isWritable:!1},...Object.entries(t).map(([i,s])=>({pubkey:s,isSigner:i==="userOwner",isWritable:!["authority","userOwner","userIdoCheck","userStakeInfo"].includes(i)}))],o=Buffer.alloc(Va.span);return Va.encode({instruction:1,amount:Number(e)},o),new Wa({keys:n,programId:r,data:o})}function Hr({programId:r},e){let t=[{pubkey:Da,isSigner:!1,isWritable:!1},{pubkey:Ps,isSigner:!1,isWritable:!1},...Object.entries(e).map(([o,i])=>({pubkey:i,isSigner:o==="userOwner",isWritable:!["authority","userOwner"].includes(o)}))],n=Buffer.alloc(Ri.span);return Ri.encode({instruction:2},n),new Wa({keys:t,programId:r,data:n})}function qa(r){let{poolConfig:e,userKeys:t,side:n}=r,o=n==="base"?t.baseTokenAccount:t.quoteTokenAccount,i=n==="base"?e.baseVault:e.quoteVault,s=Buffer.alloc(Ri.span);Ri.encode({instruction:2},s);let a=[{pubkey:Da,isWritable:!1,isSigner:!1},{pubkey:Uf,isWritable:!1,isSigner:!1},{pubkey:e.id,isWritable:!0,isSigner:!1},{pubkey:e.authority,isWritable:!1,isSigner:!1},{pubkey:i,isWritable:!0,isSigner:!1},{pubkey:o,isWritable:!0,isSigner:!1},{pubkey:t.ledgerAccount,isWritable:!0,isSigner:!1},{pubkey:t.owner,isWritable:!1,isSigner:!0}];return new Wa({programId:e.programId,keys:a,data:s})}var Gf={[Uo.IDO_PROGRAM_ID_V1.toString()]:1,[Uo.IDO_PROGRAM_ID_V2.toString()]:2,[Uo.IDO_PROGRAM_ID_V3.toString()]:3,[Uo.IDO_PROGRAM_ID_V4.toString()]:4},So=class extends Re{async claim({ownerInfo:e,idoKeys:t,associatedOnly:n=!0,checkCreateATAOwner:o=!1,txVersion:i,feePayer:s}){let a=this.createTxBuilder(s),c=Gf[t.programId];c||this.logAndCreateError("invalid version",c);let u=Le(t),[l,d]=[!new Il(e.coin).isZero(),!new Il(e.pc).isZero()],m=u.projectInfo.mint.address.equals(j),{account:p,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.projectInfo.mint.programId,mint:u.projectInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!m,notUseTokenAccount:m,associatedOnly:m?!1:n,checkCreateATAOwner:o});!p&&l&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),l&&y&&a.addInstruction(y);let f=u.buyInfo.mint.address.equals(j),{account:b,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.buyInfo.mint.programId,mint:u.buyInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!f,notUseTokenAccount:f,associatedOnly:f?!1:n,checkCreateATAOwner:o});if(!p&&d&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),d&&g&&a.addInstruction(g),(!p||!b)&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address,t.buyInfo.mint.address),c===3)return a.addInstruction({instructions:[...l?[Hr({programId:u.programId},{idoId:u.id,authority:u.authority,poolTokenAccount:u.projectInfo.vault,userTokenAccount:p,userIdoInfo:new Ni(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[],...d?[Hr({programId:new Ni(t.programId)},{idoId:u.id,authority:u.authority,poolTokenAccount:u.buyInfo.vault,userTokenAccount:b,userIdoInfo:new Ni(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[]]}).versionBuild({txVersion:i});if(c<3)return!l&&!d&&this.logAndCreateError("no claimable rewards"),a.addInstruction({instructions:[Hr({programId:u.programId},{idoId:u.id,authority:u.authority,poolQuoteTokenAccount:u.buyInfo.vault,poolBaseTokenAccount:u.projectInfo.vault,userQuoteTokenAccount:b,userBaseTokenAccount:p,userIdoInfo:new Ni(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]}).versionBuild({txVersion:i});let w={poolConfig:{id:u.id,programId:u.programId,authority:u.authority,baseVault:u.projectInfo.vault,quoteVault:u.buyInfo.vault,baseToken:t.projectInfo.mint,quoteToken:t.buyInfo.mint},userKeys:{baseTokenAccount:p,quoteTokenAccount:b,ledgerAccount:new Ni(e.userIdoInfo),owner:this.scope.ownerPubKey}};return a.addInstruction({instructions:[...l?[qa({...w,side:"base"})]:[],...d?[qa({...w,side:"quote"})]:[]]}).versionBuild({txVersion:i})}};var Xf=Buffer.from("vault_auth_seed","utf8"),Qf=Buffer.from("global_config","utf8"),zf=Buffer.from("pool","utf8"),Hf=Buffer.from("pool_vault","utf8"),jf=Buffer.from("pool_vesting","utf8"),Yf=Buffer.from("platform_config","utf8");function no(r){return ee([Xf],r)}function MC(r,e,t,n){return ee([Qf,e.toBuffer(),Zf(t),Sr(n)],r)}function jr(r,e,t){return ee([zf,e.toBuffer(),t.toBuffer()],r)}function Ua(r,e,t){return ee([Hf,e.toBuffer(),t.toBuffer()],r)}function Zf(r){let e=new ArrayBuffer(1);return new DataView(e).setUint8(0,r),new Uint8Array(e)}function Ko(r){return ee([Buffer.from("__event_authority","utf8")],r)}function Ga(r,e){return ee([Yf,e.toBuffer()],r)}function Xa(r,e,t){return ee([jf,e.toBuffer(),t.toBuffer()],r)}import{SystemProgram as Oi,TransactionInstruction as un}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Bl}from"@solana/spl-token";import Yr from"bn.js";var cn={initialize:Buffer.from([175,175,109,31,13,152,155,237]),buyExactIn:Buffer.from([250,234,13,123,213,156,19,236]),buyExactOut:Buffer.from([24,211,116,40,105,3,153,56]),sellExactIn:Buffer.from([149,39,222,155,211,124,152,26]),sellExactOut:Buffer.from([95,200,71,34,8,9,11,166]),createVestingAccount:Buffer.from([129,178,2,13,217,172,230,218]),claimVestedToken:Buffer.from([49,33,104,30,189,157,79,35]),createPlatformConfig:Buffer.from([176,90,196,175,253,113,220,20]),claimPlatformFee:Buffer.from([156,39,208,135,76,237,61,72]),updatePlaformConfig:Buffer.from([195,60,76,129,146,45,67,143])};function xl(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g,w,k,h,x){let T=O([F("decimals"),Yt("name"),Yt("symbol"),Yt("uri")]),B=O([P("totalLockedAmount"),P("cliffPeriod"),P("unlockPeriod")]),S=O([F("index"),P("supply"),P("totalFundRaisingB"),F("migrateType")]),I=O([F("index"),P("supply"),P("totalSellA"),P("totalFundRaisingB"),F("migrateType")]),K=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Ut,isSigner:!1,isWritable:!1},{pubkey:Oi.programId,isSigner:!1,isWritable:!1},{pubkey:Ge,isSigner:!1,isWritable:!1},{pubkey:Ko(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}],N=Buffer.alloc(Buffer.from(f,"utf-8").length+Buffer.from(b,"utf-8").length+Buffer.from(g,"utf-8").length+4*3+1),v=Buffer.alloc(B.span),_=Buffer.alloc(w.type==="ConstantCurve"?I.span:S.span);return T.encode({decimals:y,name:f,symbol:b,uri:g},N),w.type==="ConstantCurve"?I.encode({index:0,...w,migrateType:w.migrateType==="amm"?0:1},_):w.type==="FixedCurve"?S.encode({index:1,...w,migrateType:w.migrateType==="amm"?0:1},_):w.type==="LinearCurve"&&S.encode({index:2,...w,migrateType:w.migrateType==="amm"?0:1},_),B.encode({totalLockedAmount:k,cliffPeriod:h,unlockPeriod:x},v),new un({keys:K,programId:r,data:Buffer.from([...cn.initialize,...N,..._,...v])})}function Sl(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g){let w=O([P("amountB"),P("minAmountA"),P("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Ko(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0}),console.log({amountB:y.toString(),minAmountA:f.toString()});let h=Buffer.alloc(w.span);return w.encode({amountB:y,minAmountA:f,shareFeeRate:b??new Yr(0)},h),new un({keys:k,programId:r,data:Buffer.from([...cn.buyExactIn,...h])})}function XC(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g){let w=O([P("amountA"),P("maxAmountB"),P("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Ko(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let h=Buffer.alloc(w.span);return w.encode({amountA:y,maxAmountB:f,shareFeeRate:b??new Yr(0)},h),new un({keys:k,programId:r,data:Buffer.from([...cn.buyExactOut,...h])})}function Kl(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g){let w=O([P("amountA"),P("minAmountB"),P("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Ko(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let h=Buffer.alloc(w.span);return w.encode({amountA:y,minAmountB:f,shareFeeRate:b??new Yr(0)},h),new un({keys:k,programId:r,data:Buffer.from([...cn.sellExactIn,...h])})}function QC(r,e,t,n,o,i,s,a,c,u,l,d,m,p,y,f,b,g){let w=O([P("amountB"),P("maxAmountA"),P("shareFeeRate")]),k=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Ko(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}];g&&k.push({pubkey:g,isSigner:!1,isWritable:!0});let h=Buffer.alloc(w.span);return w.encode({amountB:y,maxAmountA:f,shareFeeRate:b??new Yr(0)},h),new un({keys:k,programId:r,data:Buffer.from([...cn.sellExactOut,...h])})}function Cl(r,e,t,n,o,i,s,a,c){let u=O([]),l=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:Oi.programId,isSigner:!1,isWritable:!1},{pubkey:Bl,isSigner:!1,isWritable:!1}],d=Buffer.alloc(u.span);return u.encode({},d),new un({keys:l,programId:r,data:Buffer.from([...cn.claimVestedToken,...d])})}function Ll(r,e,t,n,o,i){let s=O([P("shareAmount")]),a=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:Oi.programId,isSigner:!1,isWritable:!1}],c=Buffer.alloc(s.span);return s.encode({shareAmount:i},c),new un({keys:a,programId:r,data:Buffer.from([...cn.createVestingAccount,...c])})}function Qa(r,e,t,n,o,i,s,a,c){let u=[{pubkey:e,isSigner:!0,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Oi.programId,isSigner:!1,isWritable:!0},{pubkey:Bl,isSigner:!1,isWritable:!0}];return new un({keys:u,programId:r,data:cn.claimPlatformFee})}function Rl(r,e,t,n,o,i,s,a,c,u,l){let d=O([P("platformScale"),P("creatorScale"),P("burnScale"),P("feeRate"),Yt("name"),Yt("web"),Yt("img")]),m=[{pubkey:e,isSigner:!0,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:Oi.programId,isSigner:!1,isWritable:!1}],p=Buffer.alloc(8*4+Buffer.from(c,"utf-8").length+Buffer.from(u,"utf-8").length+Buffer.from(l,"utf-8").length+4*3);return d.encode({platformScale:s.platformScale,creatorScale:s.creatorScale,burnScale:s.burnScale,feeRate:a,name:c,web:u,img:l},p),new un({keys:m,programId:r,data:Buffer.from([...cn.createPlatformConfig,...p])})}function Nl(r,e,t,n){let o=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0}],i;if(n.type==="updateClaimFeeWallet"){let s=O([F("index"),L("value")]);i=Buffer.alloc(s.span),s.encode({index:0,value:n.value},i)}else if(n.type==="updateLockNftWallet"){let s=O([F("index"),L("value")]);i=Buffer.alloc(s.span),s.encode({index:1,value:n.value},i)}else if(n.type==="migrateCpLockNftScale"){let s=O([F("index"),P("platformScale"),P("creatorScale"),P("burnScale")]);i=Buffer.alloc(s.span),s.encode({index:2,...n.value},i)}else if(n.type==="updateFeeRate"){let s=O([F("index"),P("value")]);i=Buffer.alloc(s.span),s.encode({index:3,value:n.value},i)}else if(n.type==="updateImg"||n.type==="updateName"||n.type==="updateWeb"){let s=O([F("index"),Yt("value")]);i=Buffer.alloc(Buffer.from(n.value,"utf-8").length+4+1*1),n.type==="updateName"?s.encode({index:4,value:n.value},i):n.type==="updateWeb"?s.encode({index:5,value:n.value},i):n.type==="updateImg"&&s.encode({index:6,value:n.value},i)}else if(n.type==="updateCpConfigId"){o.push({pubkey:n.value,isSigner:!1,isWritable:!1});let s=O([F("index")]);i=Buffer.alloc(s.span),s.encode({index:7},i)}else if(n.type==="updateAll"){console.log("Please note that this update will overwrite all data in the platform account with the new data."),o.push({pubkey:n.value.cpConfigId,isSigner:!1,isWritable:!1});let s=O([F("index"),L("platformClaimFeeWallet"),L("platformLockNftWallet"),P("platformScale"),P("creatorScale"),P("burnScale"),P("feeRate"),Yt("name"),Yt("web"),Yt("img")]);i=Buffer.alloc(1+32+32+8*4+4*3+Buffer.from(n.value.name,"utf-8").length+Buffer.from(n.value.web,"utf-8").length+Buffer.from(n.value.img,"utf-8").length),s.encode({index:8,platformClaimFeeWallet:n.value.platformClaimFeeWallet,platformLockNftWallet:n.value.platformLockNftWallet,platformScale:n.value.migrateCpLockNftScale.platformScale,creatorScale:n.value.migrateCpLockNftScale.creatorScale,burnScale:n.value.migrateCpLockNftScale.burnScale,feeRate:n.value.feeRate,name:n.value.name,web:n.value.web,img:n.value.img},i)}else throw Error("updateInfo params type error");return new un({keys:o,programId:r,data:Buffer.from([...cn.updatePlaformConfig,...i])})}import{NATIVE_MINT as ts,TOKEN_PROGRAM_ID as Kt,createAssociatedTokenAccountIdempotentInstruction as Ei}from"@solana/spl-token";import pe from"bn.js";import{PublicKey as vl}from"@solana/web3.js";var Co=O([P(),P("epoch"),F("curveType"),jt("index"),P("migrateFee"),P("tradeFeeRate"),P("maxShareFeeRate"),P("minSupplyA"),P("maxLockRate"),P("minSellRateA"),P("minMigrateRateA"),P("minFundRaisingB"),L("mintB"),L("protocolFeeOwner"),L("migrateFeeOwner"),L("migrateToAmmWallet"),L("migrateToCpmmWallet"),Q(P(),16)]),$f=O([P("totalLockedAmount"),P("cliffPeriod"),P("unlockPeriod"),P("startTime"),P("totalAllocatedShare")]),Tn=O([P(),P("epoch"),F("bump"),F("status"),F("mintDecimalsA"),F("mintDecimalsB"),F("migrateType"),P("supply"),P("totalSellA"),P("virtualA"),P("virtualB"),P("realA"),P("realB"),P("totalFundRaisingB"),P("protocolFee"),P("platformFee"),P("migrateFee"),$f.replicate("vestingSchedule"),L("configId"),L("platformId"),L("mintA"),L("mintB"),L("vaultA"),L("vaultB"),L("creator"),Q(P(),8)]),jC=O([P(),P("epoch"),L("poolId"),L("beneficiary"),P("claimedAmount"),P("tokenShareAmount"),Q(P(),8)]),Zr=O([P(),P("epoch"),L("platformClaimFeeWallet"),L("platformLockNftWallet"),P("platformScale"),P("creatorScale"),P("burnScale"),P("feeRate"),Q(F(),64,"name"),Q(F(),256,"web"),Q(F(),256,"img"),L("cpConfigId"),Q(F(),224)]);import ln from"bn.js";import vi from"bn.js";var Wn=class{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){throw Error()}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:i,decimalA:s,decimalB:a}){throw Error()}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:i}){throw Error()}static buyExactIn({poolInfo:e,amount:t}){throw Error()}static buyExactOut({poolInfo:e,amount:t}){throw Error()}static sellExactIn({poolInfo:e,amount:t}){throw Error()}static sellExactOut({poolInfo:e,amount:t}){throw Error()}};var $r=class extends Wn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){return new C(t.toString()).div(e.toString()).mul(10**(n-o))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualB.add(e.realB).toString()).div(e.virtualA.sub(e.realA).toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:i,decimalA:s,decimalB:a}){return new C(o.sub(i).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let o=e.totalSellA.sub(e.realA),i=e.totalFundRaisingB.sub(e.realB);return new C(e.virtualB.add(e.realB.add(i)).toString()).div(e.virtualA.sub(e.realA.add(o)).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:i}){if(e.lte(n))throw Error("supply need gt total sell");let s=e.sub(n).sub(o);if(s.lte(new vi(0)))throw Error("supplyMinusSellLocked <= 0");let a=t.sub(i);if(a.lte(new vi(0)))throw Error("tfMinusMf <= 0");let c=a.mul(n).mul(n).div(s),u=a.mul(n).div(s).sub(t);if(u.lt(new vi(0)))throw Error("supply/totalSell/totalLockedAmount diff too high");let l=c.div(u),d=t.mul(t).div(u);if(l.lt(new vi(0))||d.lt(new vi(0)))throw Error("invalid input 0");return{a:l,b:d,c:n}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static getAmountOut({amountIn:e,inputReserve:t,outputReserve:n}){let o=e.mul(n),i=t.add(e);return o.div(i)}static getAmountIn({amountOut:e,inputReserve:t,outputReserve:n}){let o=t.mul(e),i=n.sub(e);return sr(o,i)}};import Ol from"bn.js";var Jr=class extends Wn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){return new C(t.toString()).div(e.toString()).mul(10**(n-o))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:i,decimalA:s,decimalB:a}){return new C(o.sub(i).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let o=e.totalSellA.sub(e.realA),i=e.totalFundRaisingB.sub(e.realB);return new C(e.virtualB.add(e.realB).add(i).toString()).div(e.virtualA.sub(e.realA).add(o).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:i}){let s=e.sub(o);if(s.lte(new Ol(0)))throw Error("invalid input 1");let a=new Ol(2).mul(t).sub(i),u=t.mul(s).div(a);return{a:u,b:t,c:u}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualB,initOutput:e.virtualA})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualB,initOutput:e.virtualA})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualA,initOutput:e.virtualB})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualA,initOutput:e.virtualB})}static getAmountOut({amountIn:e,initInput:t,initOutput:n}){return n.mul(e).div(t)}static getAmountIn({amountOut:e,initInput:t,initOutput:n}){let o=t.mul(e);return sr(o,n)}};import St from"bn.js";import Lo from"bn.js";var Mi=class{static _multipler(e){return new C(10).pow(e)}static getPrice({priceX64:e,decimalA:t,decimalB:n}){return new C(e.toString()).div(this._Q64).mul(this._multipler(t)).div(this._multipler(n))}static getPriceX64({price:e,decimalA:t,decimalB:n}){let o=e.mul(this._multipler(n)).div(this._multipler(t));return new Lo(o.mul(this._Q64).toFixed(0))}};Lt(Mi,"_Q64",new C(new Lo(1).shln(64).toString()));function p0({supply:r,totalFundRaisingB:e,totalLockedAmount:t,totalSellA:n,migrateType:o,decimalsA:i}){let s=r.sub(n).sub(t),a=new Lo(new C(s.mul(e).toString()).sqrt().toFixed(0));if(o==="amm"){if(a.gt(new Lo(10).pow(new Lo(i))))return!0}else if(o==="cpmm"){if(a.gt(new Lo(100)))return!0}else throw Error("migrate type error");return!1}var es=class extends Wn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new C(0)}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){return new C(0)}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new C(e.virtualA.mul(e.realA).toString()).div(Mi._Q64).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:i,decimalA:s,decimalB:a}){return new C(o.sub(i).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let o=e.totalSellA.sub(e.realA),i=e.totalFundRaisingB.sub(e.realB);return new C(e.virtualB.add(e.realB).add(i).toString()).div(e.virtualA.sub(e.realA).add(o).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:i}){let s=e.sub(o);if(s.lte(new St(0)))throw Error("supplyMinusLocked need gt 0");let a=t.mul(new St(3)).sub(i),u=t.mul(new St(2)).mul(s).div(a),l=u.mul(u),d=t.mul(new St(2)).mul(Xe).div(l);if(!d.gt(new St(0)))throw Error("a need gt 0");if(!ri.gt(d))throw Error("a need lt u64 max");return{a:d,b:new St(0),c:u}}static buyExactIn({poolInfo:e,amount:t}){let n=e.realB.add(t),o=new St(2).mul(n).mul(Xe).div(e.virtualA);return new St(new C(o.toString()).sqrt().toFixed(0)).sub(e.realA)}static buyExactOut({poolInfo:e,amount:t}){let n=e.realA.add(t),o=n.mul(n),{div:i,mod:s}=e.virtualA.mul(o).divmod(new St(2).mul(Xe));return(s.isZero()?i:i.add(new St(1))).sub(e.realB)}static sellExactIn({poolInfo:e,amount:t}){let n=e.realA.sub(t),o=n.mul(n),{div:i,mod:s}=e.virtualA.mul(o).divmod(new St(2).mul(Xe)),a=s.isZero()?i:i.add(new St(1));return e.realB.sub(a)}static sellExactOut({poolInfo:e,amount:t}){let n=e.realB.sub(t),o=new St(2).mul(n).mul(Xe).div(e.virtualA),i=new St(new C(o.toString()).sqrt().toFixed(0));return e.realA.sub(i)}};var mn=class{static getPoolCurvePointByPoolInfo({curveType:e,pointCount:t,poolInfo:n}){return this.getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n.supply,totalFundRaising:n.totalFundRaisingB,totalSell:n.totalSellA,totalLockedAmount:n.vestingSchedule.totalLockedAmount,migrateFee:n.migrateFee,decimalA:n.mintDecimalsA,decimalB:n.mintDecimalsB})}static getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n,totalFundRaising:o,totalSell:i,totalLockedAmount:s,migrateFee:a,decimalA:c,decimalB:u}){if(t<3)throw Error("point count < 3");let l=this.getCurve(e),d=l.getInitParam({supply:n,totalFundRaising:o,totalSell:i,totalLockedAmount:s,migrateFee:a}),m=l.getPoolInitPriceByInit({...d,decimalA:c,decimalB:u}),p=o.div(new ln(t-1)),y=new ln(0),f=[{price:m,totalSellSupply:0}],{a:b,b:g}=d,w=y,k=y;for(let h=1;h<t;h++){let x=h!==t-1?p:o.sub(k),T=this.buyExactIn({poolInfo:{virtualA:b,virtualB:g,realA:w,realB:k,totalFundRaisingB:o,totalSellA:i},amountB:x,protocolFeeRate:y,platformFeeRate:y,curveType:e,shareFeeRate:y});w=w.add(T.amountA),k=k.add(T.amountB);let B=this.getPrice({poolInfo:{virtualA:b,virtualB:g,realA:w,realB:k},decimalA:c,decimalB:u,curveType:e});f.push({price:B,totalSellSupply:new C(w.toString()).div(10**c).toNumber()})}return f}static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n,curveType:o}){return this.getCurve(o).getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n})}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o,curveType:i}){return this.getCurve(i).getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o})}static getPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:o}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:o})}static getEndPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:o}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:o})}static getPoolEndPriceReal({poolInfo:e,curveType:t,decimalA:n,decimalB:o}){return this.getCurve(t).getPoolEndPriceReal({poolInfo:e,decimalA:n,decimalB:o})}static checkParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,decimals:i,config:s,migrateType:a}){if(Number(i)!==6)throw Error("decimals = 6");if(e.mul(s.maxLockRate).div(zt).lt(o))throw Error("total lock amount gte max lock amount");if(e.lt(s.minSupplyA.mul(new ln(10**i))))throw Error("supply lt min supply");let u=e.mul(s.minSellRateA).div(zt);if(n.lt(u))throw Error("invalid input");if(t.lt(s.minFundRaisingB))throw Error("total fund raising lt min fund raising");let l=e.sub(n).sub(o),d=e.mul(s.minMigrateRateA).div(zt);if(l.lt(d))throw Error("migrate lt min migrate amount");let m=e.sub(n).sub(o),p=new ln(new C(m.mul(t).toString()).sqrt().toFixed(0));if(a==="amm"){let y=new ln(10).pow(new ln(i));if(p.lte(y))throw Error("check migrate lp error")}else if(a==="cpmm"){let y=new ln(100);if(p.lte(y))throw Error("check migrate lp error")}else throw Error("migrate type error")}static buyExactIn({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:o,curveType:i,shareFeeRate:s}){let a=n.add(s).add(o),c=this.calculateFee({amount:t,feeRate:a}),u=t.sub(c),l=this.getCurve(i),d=l.buyExactIn({poolInfo:e,amount:u}),m=e.totalSellA.sub(e.realA),p,y,f;if(d.gt(m)){p=m;let g=l.buyExactOut({poolInfo:e,amount:p});y=this.calculatePreFee({postFeeAmount:g,feeRate:a}),f=y.sub(g)}else p=d,y=t,f=c;let b=this.splitFee({totalFee:f,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:p,amountB:y,splitFee:b}}static buyExactOut({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:o,curveType:i,shareFeeRate:s}){let a=e.totalSellA.sub(e.realA),c=t;t.gt(a)&&(c=a);let l=this.getCurve(i).buyExactOut({poolInfo:e,amount:t}),d=n.add(s).add(o),m=this.calculatePreFee({postFeeAmount:l,feeRate:d}),p=m.sub(l),y=this.splitFee({totalFee:p,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:c,amountB:m,splitFee:y}}static sellExactIn({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:o,curveType:i,shareFeeRate:s}){let c=this.getCurve(i).sellExactIn({poolInfo:e,amount:t}),u=this.calculateFee({amount:c,feeRate:n.add(s).add(o)}),l=this.splitFee({totalFee:u,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:t,amountB:c.sub(u),splitFee:l}}static sellExactOut({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:o,curveType:i,shareFeeRate:s}){let a=n.add(s).add(o),c=this.calculatePreFee({postFeeAmount:t,feeRate:a});if(e.realB.lt(c))throw Error("Insufficient liquidity");let u=c.sub(t),d=mn.getCurve(i).sellExactOut({poolInfo:e,amount:c});if(d.gt(e.realA))throw Error();let m=this.splitFee({totalFee:u,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:d,amountB:t,splitFee:m}}static splitFee({totalFee:e,protocolFeeRate:t,platformFeeRate:n,shareFeeRate:o}){let i=t.add(n).add(o),s=i.isZero()?new ln(0):e.mul(n).div(i),a=i.isZero()?new ln(0):e.mul(o).div(i),c=e.sub(s).sub(a);return{platformFee:s,shareFee:a,protocolFee:c}}static calculateFee({amount:e,feeRate:t}){return er(e,t,zt)}static calculatePreFee({postFeeAmount:e,feeRate:t}){if(t.isZero())return e;let n=e.mul(zt),o=zt.sub(t);return n.add(o).sub(new ln(1)).div(o)}static getCurve(e){switch(e){case 0:return $r;case 1:return Jr;case 2:return es}throw Error("find curve error")}};var oo={initPriceX64:new pe("515752397214619"),supply:new pe(1e15),totalSellA:new pe(7931e11),totalFundRaisingB:new pe(85e9),totalLockedAmount:new pe("0"),cliffPeriod:new pe("0"),unlockPeriod:new pe("0"),decimals:6,virtualA:new pe("1073471847374405"),virtualB:new pe("30050573465"),realA:new pe(0),realB:new pe(0),protocolFee:new pe(0),platformId:new vl("4Bu96XjU84XjPDSpveTVf6LYGCkfW5FK7SNkREWcEfV4"),vestingSchedule:{totalLockedAmount:new pe(0),cliffPeriod:new pe(0),unlockPeriod:new pe(0),startTime:new pe(0),totalAllocatedShare:new pe(0)}},ns=new pe(1e4),_i=class extends Re{constructor(e){super(e)}async createLaunchpad({programId:e=Xt,authProgramId:t,platformId:n=oo.platformId,mintA:o,decimals:i=6,mintBDecimals:s=9,name:a,symbol:c,uri:u,migrateType:l,configId:d,configInfo:m,platformFeeRate:p,txVersion:y,computeBudgetConfig:f,txTipConfig:b,feePayer:g,buyAmount:w,minMintAAmount:k,slippage:h,associatedOnly:x=!0,checkCreateATAOwner:T=!1,extraSigners:B,...S}){let I=this.createTxBuilder(g);t=t??no(e).publicKey;let K=m;if(!K&&d){let ut=await this.scope.connection.getAccountInfo(d);ut&&(K=Co.decode(ut.data))}K||this.logAndCreateError("config not found");let N=K.mintB,v=K.curveType,{publicKey:_}=jr(e,o,N),{publicKey:D}=Ua(e,_,o),{publicKey:q}=Ua(e,_,N),{publicKey:G}=An(o);console.log(`create token: ${o.toBase58()}, mintB: ${N.toBase58()}, decimals A:${i}/B:${s}, config:${d.toBase58()}`),c.length>10&&this.logAndCreateError("Symbol length should shorter than 11"),u||this.logAndCreateError("uri should not empty"),w.lte(new pe(0))&&this.logAndCreateError("buy amount should gt 0:",w.toString());let ne=S?.supply??oo.supply,ie=S?.totalSellA??oo.totalSellA,me=S?.totalFundRaisingB??oo.totalFundRaisingB,re=S?.totalLockedAmount??new pe(0),fe=p;if(!p){let ut=await this.scope.connection.getAccountInfo(n);ut||this.logAndCreateError("platform id not found:",n.toString()),fe=Zr.decode(ut.data).feeRate}let ze=mn.getCurve(K.curveType).getInitParam({supply:ne,totalFundRaising:me,totalSell:ie,totalLockedAmount:re,migrateFee:K.migrateFee}),Ze={epoch:new pe(896),bump:254,status:0,mintDecimalsA:i,mintDecimalsB:s,supply:ne,totalSellA:ie,mintA:new vl(o),mintB:N,virtualA:ze.a,virtualB:ze.b,realA:oo.realA,realB:oo.realB,migrateFee:K.migrateFee,migrateType:l==="amm"?0:1,protocolFee:oo.protocolFee,platformFee:fe,platformId:n,configId:d,vaultA:D,vaultB:q,creator:this.scope.ownerPubKey,totalFundRaisingB:me,vestingSchedule:{totalLockedAmount:re,cliffPeriod:new pe(0),unlockPeriod:new pe(0),startTime:new pe(0),totalAllocatedShare:new pe(0)}},wt=mn.getCurve(K.curveType),{c:Ct}=wt.getInitParam({supply:Ze.supply,totalFundRaising:Ze.totalFundRaisingB,totalLockedAmount:re,totalSell:K.curveType===0?Ze.totalSellA:new pe(0),migrateFee:K.migrateFee});try{mn.checkParam({supply:Ze.supply,totalFundRaising:Ze.totalFundRaisingB,totalSell:Ct,totalLockedAmount:re,decimals:Ze.mintDecimalsA,config:K,migrateType:l}),console.log("check init params success")}catch(ut){this.logAndCreateError(`check create mint params failed, ${ut.message}`)}I.addInstruction({instructions:[xl(e,g??this.scope.ownerPubKey,this.scope.ownerPubKey,d,n,t,_,o,N,D,q,G,Kt,Kt,i,a,c,u||"https://",{type:v===0?"ConstantCurve":v===1?"FixedCurve":v===2?"LinearCurve":"ConstantCurve",totalSellA:ie,migrateType:l,supply:ne,totalFundRaisingB:me},re,S?.cliffPeriod??new pe(0),S?.unlockPeriod??new pe(0))]});let Jt=new pe(0),dn;if(B?.length&&I.addInstruction({signers:B}),!S.createOnly){let{builder:ut,extInfo:$e}=await this.buyToken({programId:e,authProgramId:t,mintA:o,mintB:N,poolInfo:Ze,buyAmount:w,minMintAAmount:k,shareFeeRate:S.shareFeeRate,shareFeeReceiver:S.shareFeeReceiver,configInfo:K,platformFeeRate:fe,slippage:h,associatedOnly:x,checkCreateATAOwner:T});I.addInstruction({...ut.AllTxData}),Jt=$e.outAmount,dn=(this.scope.cluster==="devnet"||y===1)&&S.shareFeeReceiver?[ut.allInstructions[0]]:void 0}return I.addTipInstruction(b),y===0?I.sizeCheckBuildV0({computeBudgetConfig:f,outAmount:Jt,splitIns:dn,address:{...Ze,poolId:_}}):I.sizeCheckBuild({computeBudgetConfig:f,outAmount:Jt,splitIns:dn,address:{...Ze,poolId:_}})}async buyToken({programId:e=Xt,authProgramId:t,mintA:n,mintB:o=ts,poolInfo:i,configInfo:s,platformFeeRate:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:d,buyAmount:m,minMintAAmount:p,slippage:y,shareFeeRate:f=new pe(0),shareFeeReceiver:b,associatedOnly:g=!0,checkCreateATAOwner:w=!1}){m.lte(new pe(0))&&this.logAndCreateError("buy amount should gt 0:",m.toString());let k=this.createTxBuilder(d),{publicKey:h}=jr(e,n,o);t=t??no(e).publicKey;let x=null,T=null,B=o.equals(ts),{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:n,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:g,checkCreateATAOwner:w});S&&(x=S),k.addInstruction(I||{}),x===void 0&&this.logAndCreateError(`cannot found mintA(${n.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let{account:K,instructionParams:N}=await this.scope.account.getOrCreateTokenAccount({mint:o,owner:this.scope.ownerPubKey,createInfo:B?{payer:this.scope.ownerPubKey,amount:m}:void 0,skipCloseAccount:!B,notUseTokenAccount:B,associatedOnly:B?!1:g,checkCreateATAOwner:w});K&&(T=K),k.addInstruction(N||{}),T===void 0&&this.logAndCreateError(`cannot found mintB(${o.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let v=i;if(!v){let re=await this.scope.connection.getAccountInfo(h,{commitment:"processed"});re||this.logAndCreateError("cannot found pool:",h.toBase58()),v=Tn.decode(re.data)}let _=s,D=await Se(this.scope.connection,[_?void 0:v.configId,a?void 0:v.platformId].filter(Boolean).map(re=>({pubkey:re})));if(!_){let re=D.find(fe=>fe.pubkey.equals(v.configId));(!re||!re.accountInfo)&&this.logAndCreateError("config not found: ",v.configId.toBase58()),_=Co.decode(re.accountInfo.data)}if(!a){let re=D.find(fe=>fe.pubkey.equals(v.platformId));(!re||!re.accountInfo)&&this.logAndCreateError("platform info not found: ",v.configId.toBase58()),a=Zr.decode(re.accountInfo.data).feeRate}let q=mn.buyExactIn({poolInfo:v,amountB:m,protocolFeeRate:_.tradeFeeRate,platformFeeRate:a,curveType:_.curveType,shareFeeRate:f}),G=new C(q.amountA.toString()),ne=y?new C(ns.sub(y).toNumber()/ns.toNumber()).clampedTo(0,1):new C(1),ie=p??(y?new pe(G.mul(ne).toFixed(0)):q.amountA);q.amountB.lt(m)&&console.log(`maximum ${n.toBase58()} amount can buy is ${q.amountA.toString()}, input ${o.toBase58()} amount: ${q.amountB.toString()}`);let me=b?Y(b,o,Kt).publicKey:void 0;return me&&k.addInstruction({instructions:[Ei(this.scope.ownerPubKey,me,b,o)]}),k.addInstruction({instructions:[Sl(e,this.scope.ownerPubKey,t,v.configId,v.platformId,h,x,T,v.vaultA,v.vaultB,n,o,Kt,Kt,q.amountB.lt(m)?q.amountB:m,ie,f,me)]}),k.addCustomComputeBudget(u),k.addTipInstruction(l),k.versionBuild({txVersion:c,extInfo:{outAmount:ie}})}async sellToken({programId:e=Xt,authProgramId:t,mintA:n,mintB:o=ts,poolInfo:i,configInfo:s,platformFeeRate:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:d,sellAmount:m,minAmountB:p,slippage:y,shareFeeRate:f=new pe(0),shareFeeReceiver:b,associatedOnly:g=!0,checkCreateATAOwner:w=!1}){t=t??no(e).publicKey;let k=this.createTxBuilder(d);m.lte(new pe(0))&&this.logAndCreateError("sell amount should be gt 0");let{publicKey:h}=jr(e,n,o),x=null,T=null,B=o.equals(ts),{account:S,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({mint:n,owner:this.scope.ownerPubKey,createInfo:void 0,skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:g,checkCreateATAOwner:w});S&&(x=S),k.addInstruction(I||{}),x===void 0&&this.logAndCreateError("cannot found mintA token accounts","tokenAccounts",this.scope.account.tokenAccounts);let{account:K,instructionParams:N}=await this.scope.account.getOrCreateTokenAccount({mint:o,owner:this.scope.ownerPubKey,createInfo:B?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!B,notUseTokenAccount:B,associatedOnly:B?!1:g,checkCreateATAOwner:w});K&&(T=K),k.addInstruction(N||{}),T===void 0&&this.logAndCreateError("cannot found mintB token accounts","tokenAccounts",this.scope.account.tokenAccounts);let v=i;if(!v){let re=await this.scope.connection.getAccountInfo(h,{commitment:"processed"});re||this.logAndCreateError("cannot found pool",h.toBase58()),v=Tn.decode(re.data)}let _=s,D=await Se(this.scope.connection,[_?void 0:v.configId,a?void 0:v.platformId].filter(Boolean).map(re=>({pubkey:re})));if(!_){let re=D.find(fe=>fe.pubkey.equals(v.configId));(!re||!re.accountInfo)&&this.logAndCreateError("config not found: ",v.configId.toBase58()),_=Co.decode(re.accountInfo.data)}if(!a){let re=D.find(fe=>fe.pubkey.equals(v.platformId));(!re||!re.accountInfo)&&this.logAndCreateError("platform info not found: ",v.configId.toBase58()),a=Zr.decode(re.accountInfo.data).feeRate}let q=mn.sellExactIn({poolInfo:v,amountA:m,protocolFeeRate:_.tradeFeeRate,platformFeeRate:a,curveType:_.curveType,shareFeeRate:f}),G=new C(q.amountB.toString()),ne=y?new C(ns.sub(y).toNumber()/ns.toNumber()).clampedTo(0,1):new C(1),ie=p??(y?new pe(G.mul(ne).toFixed(0)):q.amountB);ie.lte(new pe(0))&&this.logAndCreateError(`out ${o.toBase58()} amount should be gt 0`);let me=b?Y(b,o,Kt).publicKey:void 0;return me&&k.addInstruction({instructions:[Ei(this.scope.ownerPubKey,me,b,o)]}),k.addInstruction({instructions:[Kl(e,this.scope.ownerPubKey,t,v.configId,v.platformId,h,x,T,v.vaultA,v.vaultB,n,o,Kt,Kt,q.amountA.lt(m)?q.amountA:m,ie,f,me)]}),k.addCustomComputeBudget(u),k.addTipInstruction(l),k.versionBuild({txVersion:c,extInfo:{outAmount:ie}})}async createPlatformConfig({programId:e=Xt,platformAdmin:t,platformClaimFeeWallet:n,platformLockNftWallet:o,cpConfigId:i,migrateCpLockNftScale:s,feeRate:a,name:c,web:u,img:l,txVersion:d,computeBudgetConfig:m,txTipConfig:p,feePayer:y}){let f=this.createTxBuilder(y),{publicKey:b}=Ga(e,t);return f.addInstruction({instructions:[Rl(e,t,n,o,b,i,s,a,c,u,l)]}),f.addCustomComputeBudget(m),f.addTipInstruction(p),f.versionBuild({txVersion:d,extInfo:{platformId:b}})}async updatePlatformConfig({programId:e=Xt,platformAdmin:t,platformId:n,updateInfo:o,txVersion:i,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l=n??Ga(e,t).publicKey;return u.addInstruction({instructions:[Nl(e,t,l,o)]}),u.addCustomComputeBudget(s),u.addTipInstruction(a),u.versionBuild({txVersion:i})}async claimPlatformFee({programId:e=Xt,authProgramId:t,platformId:n,poolId:o,platformClaimFeeWallet:i,mintB:s,vaultB:a,mintBProgram:c=Kt,txVersion:u,computeBudgetConfig:l,txTipConfig:d,feePayer:m}){let p=this.createTxBuilder(m);t=t??no(e).publicKey;let y=s,f=a;if(!y){let g=await this.scope.connection.getAccountInfo(o,{commitment:"processed"});g||this.logAndCreateError("cannot found pool:",o.toBase58());let w=Tn.decode(g.data),k=await this.scope.connection.getAccountInfo(w.configId,{commitment:"processed"});k||this.logAndCreateError("cannot found config:",w.configId.toBase58()),y=Co.decode(k.data).mintB,f=f??w.vaultB}(!y||!f)&&this.logAndCreateError("cannot found mint info, mintB: ",y.toBase58(),", vaultB: ",f?.toBase58()??"");let b=Y(this.scope.ownerPubKey,y,Kt).publicKey;return p.addInstruction({instructions:[Ei(this.scope.ownerPubKey,b,this.scope.ownerPubKey,y)]}),p.addInstruction({instructions:[Qa(e,i,t,o,n,f,b,y,c)]}),p.addCustomComputeBudget(l),p.addTipInstruction(d),p.versionBuild({txVersion:u})}async claimAllPlatformFee({programId:e=Xt,authProgramId:t,platformId:n,platformClaimFeeWallet:o,txVersion:i,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c);return t=t??no(e).publicKey,(await this.scope.connection.getProgramAccounts(e,{filters:[{dataSize:Tn.span},{memcmp:{offset:Tn.offsetOf("platformId"),bytes:n.toString()}}]})).forEach(d=>{let m=Tn.decode(d.account.data),p=Y(this.scope.ownerPubKey,m.mintB,Kt).publicKey;u.addInstruction({instructions:[Ei(this.scope.ownerPubKey,p,this.scope.ownerPubKey,m.mintB)]}),u.addInstruction({instructions:[Qa(e,o,t,d.pubkey,n,m.vaultB,p,m.mintB,Kt)]})}),u.addTipInstruction(a),i===0?u.sizeCheckBuildV0({computeBudgetConfig:s}):u.sizeCheckBuild({computeBudgetConfig:s})}async createVesting({programId:e=Xt,poolId:t,beneficiary:n,shareAmount:o,txVersion:i,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l=Xa(e,t,n).publicKey;return u.addInstruction({instructions:[Ll(e,this.scope.ownerPubKey,n,t,l,o)]}),u.addCustomComputeBudget(s),u.addTipInstruction(a),u.versionBuild({txVersion:i})}async claimVesting({programId:e=Xt,poolId:t,poolInfo:n,txVersion:o,computeBudgetConfig:i,txTipConfig:s,feePayer:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1}){let l=this.createTxBuilder(a),d=no(e).publicKey,m=Xa(e,t,this.scope.ownerPubKey).publicKey,p=n;if(!p){let f=await this.scope.connection.getAccountInfo(t);f||this.logAndCreateError("pool not found"),p=Tn.decode(f.data)}let y=Y(this.scope.ownerPubKey,p.mintA,Kt).publicKey;return l.addInstruction({instructions:[Ei(this.scope.ownerPubKey,y,this.scope.ownerPubKey,p.mintA)]}),l.addInstruction({instructions:[Cl(e,this.scope.ownerPubKey,d,t,m,y,p.vaultA,p.mintA,Kt)]}),l.addCustomComputeBudget(i),l.addTipInstruction(s),l.versionBuild({txVersion:o})}async getRpcPoolInfo({poolId:e}){return(await this.getRpcPoolsInfo({poolIdList:[e]})).poolInfoMap[e.toBase58()]}async getRpcPoolsInfo({poolIdList:e,config:t}){let n=await Se(this.scope.connection,e.map(c=>({pubkey:c})),t),o={},i=[];for(let c=0;c<e.length;c++){let u=n[c];if(u===null||!u.accountInfo)throw Error("fetch pool info error: "+e[c].toBase58());let l=Tn.decode(u.accountInfo.data);o[e[c].toBase58()]={...l,poolId:u.accountInfo.owner},i.push(l.configId)}let s=await Se(this.scope.connection,i.map(c=>({pubkey:c})),t),a={};for(let c=0;c<i.length;c++){let u=s[c];if(u===null||!u.accountInfo)throw Error("fetch config info error: "+i[c].toBase58());let l=Co.decode(u.accountInfo.data);a[i[c].toBase58()]={...l,configId:u.accountInfo.owner}}return{poolInfoMap:Object.keys(o).reduce((c,u)=>({...c,[u]:{...o[u],configInfo:a[o[u].configId.toBase58()]}}),{})}}};import{PublicKey as Jf}from"@solana/web3.js";import{MintLayout as ey,TOKEN_2022_PROGRAM_ID as za,TOKEN_PROGRAM_ID as Ha}from"@solana/spl-token";var Fi=class extends Re{_tokenList=[];_tokenMap=new Map;_blackTokenMap=new Set;_mintGroup={official:new Set,jup:new Set,extra:new Set};_whiteMap=new Set;_extraTokenList=[];constructor(e){super(e)}async load(e){this.checkDisabled();let{forceUpdate:t=!1,type:n="strict"}=e||{},{mintList:o,blacklist:i,whiteList:s}=await this.scope.fetchV3TokenList(t),a=await this.scope.fetchJupTokenList(t);this._tokenList=[],this._tokenMap=new Map,this._blackTokenMap=new Set(i),this._mintGroup={official:new Set,jup:new Set,extra:new Set},this._whiteMap=new Set(s),this._tokenMap.set(nn.address,nn),this._mintGroup.official.add(nn.address),o.forEach(c=>{this._blackTokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"raydium",priority:2,programId:c.programId??(c.tags.includes("token-2022")?za.toBase58():Ha.toBase58())}),this._mintGroup.official.add(c.address))}),a.forEach(c=>{this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"jupiter",priority:1,programId:c.programId??(c.tags.includes("token-2022")?za.toBase58():Ha.toBase58()),tags:c.freezeAuthority?[...c.tags||[],"hasFreeze"]:c.tags}),this._mintGroup.jup.add(c.address))}),this._extraTokenList.forEach(c=>{this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"extra",priority:1,programId:c.programId||c.tags.includes("token-2022")?za.toBase58():Ha.toBase58()}),this._mintGroup.extra.add(c.address))}),this._tokenList=Array.from(this._tokenMap).map(c=>c[1])}get tokenList(){return this._tokenList}get tokenMap(){return this._tokenMap}get blackTokenMap(){return this._blackTokenMap}get mintGroup(){return this._mintGroup}get whiteListMap(){return this._whiteMap}async getTokenInfo(e){if(!e)throw new Error("please input mint");let t=e.toString(),n=this._tokenMap.get(t);if(n)return n;if(t.toLocaleUpperCase()==="SOL")return nn;let o=(await this.scope.api.getTokenInfo([t]))[0];if(o)return this._mintGroup.extra.add(t),this._tokenMap.set(t,{...o,priority:2}),o;let i=await this.scope.connection.getAccountInfo(new Jf(t));if(!i)throw new Error(`mint address not found: ${t}`);let s=ey.decode(i.data),a=t.toString().substring(0,6),c={chainId:101,address:t,programId:i.owner.toBase58(),logoURI:"",symbol:a,name:a,decimals:s.decimals,tags:[],extensions:{},priority:0,type:"unknown"};return this._mintGroup.extra.add(t),this._tokenMap.set(t,c),c}};var os=class{cluster;farm;account;liquidity;clmm;cpmm;tradeV2;utils1216;marketV2;ido;token;launchpad;rawBalances=new Map;apiData;availability;blockhashCommitment;loopMultiTxStatus;_connection;_owner;api;_apiCacheTime;_signAllTransactions;logger;_chainTime;_epochInfo;constructor(e){let{connection:t,cluster:n,owner:o,api:i,defaultChainTime:s,defaultChainTimeOffset:a,apiCacheTime:c,blockhashCommitment:u="confirmed",loopMultiTxStatus:l}=e;this._connection=t,this.cluster=n||"mainnet",this._owner=o?new Gt(o):void 0,this._signAllTransactions=e.signAllTransactions,this.blockhashCommitment=u,this.loopMultiTxStatus=l,this.api=i,this._apiCacheTime=c||5*60*1e3,this.logger=de("Raydium"),this.farm=new ii({scope:this,moduleName:"Raydium_Farm"}),this.account=new Ho({scope:this,moduleName:"Raydium_Account",tokenAccounts:e.tokenAccounts,tokenAccountRawInfos:e.tokenAccountRawInfos}),this.liquidity=new wi({scope:this,moduleName:"Raydium_LiquidityV2"}),this.token=new Fi({scope:this,moduleName:"Raydium_tokenV2"}),this.tradeV2=new Li({scope:this,moduleName:"Raydium_tradeV2"}),this.clmm=new hi({scope:this,moduleName:"Raydium_clmm"}),this.cpmm=new Si({scope:this,moduleName:"Raydium_cpmm"}),this.utils1216=new Vt({scope:this,moduleName:"Raydium_utils1216"}),this.marketV2=new To({scope:this,moduleName:"Raydium_marketV2"}),this.ido=new So({scope:this,moduleName:"Raydium_ido"}),this.launchpad=new _i({scope:this,moduleName:"Raydium_lauchpad"}),this.availability={};let d=new Date().getTime();this.apiData={},a&&(this._chainTime={fetched:d,value:{chainTime:s||Date.now()-a,offset:a}})}static async load(e){let t=ty({cluster:"mainnet",owner:null,apiRequestInterval:3e5,apiRequestTimeout:1e4},e),{cluster:n,apiRequestTimeout:o,logCount:i,logRequests:s,urlConfigs:a}=t,c=new pr({cluster:n,timeout:o,urlConfigs:a,logCount:i,logRequests:s}),u=new os({...t,api:c});return await u.fetchAvailabilityStatus(e.disableFeatureCheck??!0),e.disableLoadToken||await u.token.load({type:e.jupTokenType}),u}get owner(){return this._owner}get ownerPubKey(){if(!this._owner)throw new Error(fr);return this._owner.publicKey}setOwner(e){return this._owner=e?new Gt(e):void 0,this.account.resetTokenAccounts(),this}get connection(){if(!this._connection)throw new Error(Mu);return this._connection}setConnection(e){return this._connection=e,this}get signAllTransactions(){return this._signAllTransactions}setSignAllTransactions(e){return this._signAllTransactions=e,this}checkOwner(){if(!this.owner)throw console.error(fr),new Error(fr)}isCacheInvalidate(e){return new Date().getTime()-e>this._apiCacheTime}async fetchChainTime(){try{let e=await this.api.getChainTimeOffset();this._chainTime={fetched:Date.now(),value:{chainTime:Date.now()+e.offset*1e3,offset:e.offset*1e3}}}catch{this._chainTime=void 0}}async fetchV3TokenList(e){if(this.apiData.tokenList&&!this.isCacheInvalidate(this.apiData.tokenList.fetched)&&!e)return this.apiData.tokenList.data;try{let t=await this.api.getTokenList(),n={fetched:Date.now(),data:t};return this.apiData.tokenList=n,n.data}catch(t){return console.error(t),{mintList:[],blacklist:[],whiteList:[]}}}async fetchJupTokenList(e){let t=this.apiData.jupTokenList;if(t&&!this.isCacheInvalidate(t.fetched)&&!e)return t.data;try{let n=await this.api.getJupTokenList();return this.apiData.jupTokenList={fetched:Date.now(),data:n.map(o=>({...o,mintAuthority:o.mint_authority||void 0,freezeAuthority:o.freeze_authority||void 0}))},this.apiData.jupTokenList.data}catch(n){return console.error(n),[]}}get chainTimeData(){return this._chainTime?.value}async chainTimeOffset(){return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.offset:(await this.fetchChainTime(),this._chainTime?.value.offset||0)}async currentBlockChainTime(){return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.chainTime:(await this.fetchChainTime(),this._chainTime?.value.chainTime||Date.now())}async fetchEpochInfo(){return this._epochInfo&&Date.now()-this._epochInfo.fetched<=1e3*30?this._epochInfo.value:(this._epochInfo={fetched:Date.now(),value:await this.connection.getEpochInfo()},this._epochInfo.value)}async fetchAvailabilityStatus(e){if(e)return{};try{let t=await this.api.fetchAvailabilityStatus(),n=t.all===!1;return this.availability={all:t.all,swap:n?!1:t.swap,createConcentratedPosition:n?!1:t.createConcentratedPosition,addConcentratedPosition:n?!1:t.addConcentratedPosition,addStandardPosition:n?!1:t.addStandardPosition,removeConcentratedPosition:n?!1:t.removeConcentratedPosition,removeStandardPosition:n?!1:t.removeStandardPosition,addFarm:n?!1:t.addFarm,removeFarm:n?!1:t.removeFarm},t}catch{return{}}}};var C1=r=>r;export{Np as AMM_CONFIG_SEED,Pc as BIT_PRECISION,hi as Clmm,vc as ClmmConfigLayout,Be as ClmmInstrument,Fr as ConstantProductCurve,Na as CpmmConfigInfoLayout,Vr as CpmmFee,xi as CpmmPoolInfoLayout,mn as Curve,Wn as CurveBase,Dr as CurveCalculator,Jp as DataElement,ma as EXTENSION_TICKARRAY_BITMAP_SIZE,sc as FARM_LOCK_MINT,ac as FARM_LOCK_VAULT,Mt as FARM_PROGRAM_TO_VERSION,cc as FARM_VERSION_TO_LEDGER_LAYOUT,uc as FARM_VERSION_TO_STATE_LAYOUT,xr as FEE_RATE_DENOMINATOR,Dp as FETCH_TICKARRAY_COUNT,Rp as Fee,Jr as FixedPriceCurve,Xf as LAUNCHPAD_AUTH_SEED,Qf as LAUNCHPAD_CONFIG_SEED,Yf as LAUNCHPAD_POOL_PLATFORM_SEED,zf as LAUNCHPAD_POOL_SEED,Hf as LAUNCHPAD_POOL_VAULT_SEED,jf as LAUNCHPAD_POOL_VESTING_SEED,Rr as LIQUIDITY_FEES_DENOMINATOR,ya as LIQUIDITY_FEES_NUMERATOR,Yp as LIQUIDITY_VERSION_TO_SERUM_VERSION,dI as LIQUIDITY_VERSION_TO_STATE_LAYOUT,Of as LOCK_LIQUIDITY_SEED,wc as LOG_B_2_X32,kc as LOG_B_P_ERR_MARGIN_LOWER_X64,hc as LOG_B_P_ERR_MARGIN_UPPER_X64,$r as LaunchPadConstantProductCurve,Co as LaunchpadConfig,Tn as LaunchpadPool,oo as LaunchpadPoolInitParam,jC as LaunchpadVesting,$f as LaunchpadVestingSchedule,es as LinearPriceCurve,ge as LiquidityMath,IT as LockClPositionLayoutV2,TT as LockPositionLayout,Ka as MARKET_STATE_LAYOUT_V2,va as MARKET_STATE_LAYOUT_V3,Pl as MARKET_VERSION_TO_STATE_LAYOUT,Ft as MAX_SQRT_PRICE_X64,Br as MAX_SQRT_PRICE_X64_SUB_ONE,At as MAX_TICK,_t as MIN_SQRT_PRICE_X64,Ir as MIN_SQRT_PRICE_X64_ADD_ONE,dt as MIN_TICK,ko as MODEL_DATA_PUBKEY,Xr as Market,Mi as MathLaunch,ae as MathUtil,ri as MaxU64,Ac as MaxUint128,gn as NEGATIVE_ONE,Vp as OBSERVATION_SEED,Rt as ONE,_p as OPERATION_SEED,Mc as ObservationInfoLayout,Gp as ObservationLayout,Ec as OperationLayout,Lc as POOL_LOCK_ID_SEED,Mp as POOL_REWARD_VAULT_SEED,Op as POOL_SEED,Fp as POOL_TICK_ARRAY_BITMAP_SEED,vp as POOL_VAULT_SEED,xc as POSITION_SEED,Zr as PlatformConfig,Qn as PoolInfoLayout,Ce as PoolUtils,pi as PositionInfoLayout,Qp as PositionRewardInfoLayout,li as PositionUtils,hT as ProtocolPositionLayout,Tr as Q128,Xe as Q64,os as Raydium,Xp as RewardInfo,rl as RoundDirection,gl as SERUM_PROGRAMID_TO_VERSION,Al as SERUM_VERSION_TO_PROGRAMID,nn as SOL_INFO,Wc as SPL_MINT_LAYOUT,Wp as SUPPORT_MINT_SEED,te as SqrtPriceMath,wo as StableLayout,Xn as SwapMath,Gn as TICK_ARRAY_BITMAP_SIZE,Ep as TICK_ARRAY_SEED,Ye as TICK_ARRAY_SIZE,ih as TICK_SPACINGS,Je as TOKEN_WSOL,Pn as TickArrayBitmap,Oc as TickArrayBitmapExtensionLayout,di as TickArrayBitmapExtensionUtils,mi as TickArrayLayout,zp as TickLayout,zn as TickMath,Ae as TickQuery,H as TickUtils,si as U64Resolution,sh as U64_IGNORE_RANGE,ic as Voter,bp as VoterDepositEntry,yp as VoterLockup,oc as VoterRegistrar,fp as VoterVotingMintConfig,ye as ZERO,Pa as addLiquidityLayout,cn as anchorDataBuf,Us as associatedLedgerAccountLayout,Sl as buyExactInInstruction,XC as buyExactOutInstruction,na as calFarmRewardAmount,p0 as checkPoolToAmm,Ri as claimLayout,Qa as claimPlatformFee,Cl as claimVestedToken,Nc as clmmComputeInfoToApiInfo,bn as closeAccountInstruction,fl as collectCpFeeInstruction,_f as cpmmLockPositionInstruction,ei as createAssociatedLedgerAccountInstruction,Rl as createPlatformConfig,Uc as createPoolFeeLayout,Ta as createPoolV4InstructionV2,mI as createPoolV4Layout,Ll as createVestingAccount,Nn as createWSolAccountInstructions,gt as dwLayout,zs as farmAddRewardLayout,Ew as farmLedgerLayoutV3_1,Yo as farmLedgerLayoutV3_2,_w as farmLedgerLayoutV5_1,tc as farmLedgerLayoutV5_2,nc as farmLedgerLayoutV6_1,mc as farmRewardInfoToConfig,Xs as farmRewardLayout,Qs as farmRewardRestartLayout,pp as farmRewardTimeInfoLayout,Ju as farmStateV3Layout,ec as farmStateV5Layout,jo as farmStateV6Layout,uk as fetchMultipleFarmInfoAndUpdate,JI as fetchMultipleInfo,ba as fixedSwapInLayout,ga as fixedSwapOutLayout,lf as formatLayout,We as generatePubKey,lc as getAssociatedAuthority,Or as getAssociatedConfigId,mt as getAssociatedLedgerAccount,$o as getAssociatedLedgerPoolAccount,Af as getAssociatedOpenOrders,Sa as getAssociatedPoolKeys,qr as getCpLockPda,$x as getCpmmPdaAmmConfigId,La as getCpmmPdaPoolId,al as getCreatePoolKeys,oa as getDepositEntryIndex,zc as getDxByDyBaseIn,Qc as getDyByDxBaseIn,Ao as getFarmLedgerLayout,gp as getFarmStateLayout,xa as getLiquidityAssociatedAuthority,Zn as getLiquidityAssociatedId,$h as getLiquidityFromAmounts,ph as getPdaAmmConfigId,Ko as getPdaCpiEvent,De as getPdaExBitmapAccount,no as getPdaLaunchpadAuth,MC as getPdaLaunchpadConfigId,jr as getPdaLaunchpadPoolId,Ua as getPdaLaunchpadVaultId,ci as getPdaLockClPositionIdV2,ca as getPdaLockPositionId,Rf as getPdaLpMint,An as getPdaMetadataKey,la as getPdaMintExAccount,Cc as getPdaObservationAccount,Ii as getPdaObservationId,ui as getPdaOperationAccount,Pt as getPdaPersonalPositionAddress,Ga as getPdaPlatformId,Bo as getPdaPoolAuthority,Sc as getPdaPoolId,Kc as getPdaPoolRewardVaulId,ua as getPdaPoolVaultId,$t as getPdaProtocolPositionAddress,be as getPdaTickArrayAddress,sl as getPdaVault,Xa as getPdaVestId,Ys as getRegistrarAddress,Hc as getStablePrice,ta as getTokenOwnerRecordAddress,Js as getVoterAddress,ea as getVoterWeightRecordAddress,$s as getVotingMintAuthority,Zs as getVotingTokenMint,xp as governanceCreateTokenOwnerRecord,uh as i16ToBytes,Kr as i32ToBytes,Aa as initPoolLayout,Ds as initTokenAccountInstruction,xl as initialize,hf as initializeMarket,Hs as isValidFarmVersion,ai as isZero,ck as judgeFarmType,sa as leadingZeros,Bc as leastSignificantBit,Hn as liquidityStateV4Layout,Zp as liquidityStateV5Layout,Nr as makeAMMSwapInstruction,Zc as makeAddLiquidityInstruction,ra as makeAddNewRewardInstruction,Hr as makeClaimInstruction,qa as makeClaimInstructionV4,pl as makeCpmmLockInstruction,cl as makeCreateCpmmPoolInInstruction,dc as makeCreateFarmInstruction,Mr as makeCreateMarketInstruction,pc as makeCreatorWithdrawFarmRewardInstruction,ll as makeDepositCpmmInInstruction,yc as makeDepositInstructionV3,bc as makeDepositInstructionV5,gc as makeDepositInstructionV6,Bk as makeDepositTokenInstruction,Sk as makeDepositWithdrawInstruction,CI as makeInitPoolInstructionV4,bC as makePurchaseInstruction,ia as makeRestartRewardInstruction,$c as makeSimulatePoolInfoInstruction,Ur as makeSwapCpmmBaseInInstruction,dl as makeSwapCpmmBaseOutInstruction,pf as makeSwapFixedInInstruction,ff as makeSwapFixedOutInstruction,kl as makeSwapInstruction,$u as makeTransferInstruction,ml as makeWithdrawCpmmInInstruction,oi as makeWithdrawInstructionV3,fc as makeWithdrawInstructionV4,ni as makeWithdrawInstructionV5,ti as makeWithdrawInstructionV6,xk as makeWithdrawTokenInstruction,rh as mockCreatePoolInfo,Tc as mockV3CreatePoolInfo,ef as modelDataInfoLayout,Ic as mostSignificantBit,Zu as parseTokenAccountResp,ZT as parseTokenInfo,vn as poolTypeV6,Va as purchaseLayout,lp as realFarmStateV3Layout,mp as realFarmStateV5Layout,dp as realFarmV6Layout,ha as removeLiquidityInstruction,wa as removeLiquidityLayout,wK as route1Instruction,kK as route2Instruction,Vf as routeInstruction,Kl as sellExactInInstruction,QC as sellExactOut,KI as simulatePoolInfoInstruction,JT as solToWSolToken,Zt as splAccountLayout,hK as swapBaseInAutoAccount,TK as swapBaseOutAutoAccount,vr as toAmmComputePoolInfo,pt as toApiV3Token,Mn as toFeeConfig,Lr as toToken,yi as toTokenAmount,$T as toTokenInfo,aa as trailingZeros,Sr as u16ToBytes,ch as u32ToBytes,Zf as u8ToBytes,C1 as unionArr,Ap as updateFarmPoolInfo,Nl as updatePlatformConfig,js as validateFarmRewards,Kp as voterStakeRegistryCreateDepositEntry,Sp as voterStakeRegistryCreateVoter,Tp as voterStakeRegistryDeposit,Ip as voterStakeRegistryUpdateVoterWeightRecord,Bp as voterStakeRegistryWithdraw,eI as wSolToSolToken,Gs as withdrawRewardLayout};
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=index.mjs.map