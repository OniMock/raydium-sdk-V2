var us=Object.defineProperty;var cs=(r,e,t)=>e in r?us(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var In=(r,e,t)=>(cs(r,typeof e!="symbol"?e+"":e,t),t);import{PublicKey as ke}from"@solana/web3.js";import{AccountLayout as kc,NATIVE_MINT as cr,TOKEN_PROGRAM_ID as xt}from"@solana/spl-token";import{PublicKey as qa}from"@solana/web3.js";import ut from"bn.js";var Ut=9e15,wt=1e9,mr="0123456789abcdef",Ln="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",Nn="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",dr={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-Ut,maxE:Ut,crypto:!1},wi,st,z=!0,Rn="[DecimalError] ",gt=Rn+"Invalid argument: ",ki=Rn+"Precision limit exceeded",hi=Rn+"crypto unavailable",Ai="[object Decimal]",Ce=Math.floor,Ae=Math.pow,ls=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,ms=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,ds=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,Pi=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,He=1e7,U=7,ps=9007199254740991,fs=Ln.length-1,pr=Nn.length-1,I={toStringTag:Ai};I.absoluteValue=I.abs=function(){var r=new this.constructor(this);return r.s<0&&(r.s=1),F(r)};I.ceil=function(){return F(new this.constructor(this),this.e+1,2)};I.clampedTo=I.clamp=function(r,e){var t,n=this,i=n.constructor;if(r=new i(r),e=new i(e),!r.s||!e.s)return new i(NaN);if(r.gt(e))throw Error(gt+e);return t=n.cmp(r),t<0?r:n.cmp(e)>0?e:new i(n)};I.comparedTo=I.cmp=function(r){var e,t,n,i,o=this,a=o.d,s=(r=new o.constructor(r)).d,c=o.s,u=r.s;if(!a||!s)return!c||!u?NaN:c!==u?c:a===s?0:!a^c<0?1:-1;if(!a[0]||!s[0])return a[0]?c:s[0]?-u:0;if(c!==u)return c;if(o.e!==r.e)return o.e>r.e^c<0?1:-1;for(n=a.length,i=s.length,e=0,t=n<i?n:i;e<t;++e)if(a[e]!==s[e])return a[e]>s[e]^c<0?1:-1;return n===i?0:n>i^c<0?1:-1};I.cosine=I.cos=function(){var r,e,t=this,n=t.constructor;return t.d?t.d[0]?(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+U,n.rounding=1,t=bs(n,Ii(n,t)),n.precision=r,n.rounding=e,F(st==2||st==3?t.neg():t,r,e,!0)):new n(1):new n(NaN)};I.cubeRoot=I.cbrt=function(){var r,e,t,n,i,o,a,s,c,u,l=this,m=l.constructor;if(!l.isFinite()||l.isZero())return new m(l);for(z=!1,o=l.s*Ae(l.s*l,1/3),!o||Math.abs(o)==1/0?(t=Se(l.d),r=l.e,(o=(r-t.length+1)%3)&&(t+=o==1||o==-2?"0":"00"),o=Ae(t,1/3),r=Ce((r+1)/3)-(r%3==(r<0?-1:2)),o==1/0?t="5e"+r:(t=o.toExponential(),t=t.slice(0,t.indexOf("e")+1)+r),n=new m(t),n.s=l.s):n=new m(o.toString()),a=(r=m.precision)+3;;)if(s=n,c=s.times(s).times(s),u=c.plus(l),n=ae(u.plus(l).times(s),u.plus(c),a+2,1),Se(s.d).slice(0,a)===(t=Se(n.d)).slice(0,a))if(t=t.slice(a-3,a+1),t=="9999"||!i&&t=="4999"){if(!i&&(F(s,r+1,0),s.times(s).times(s).eq(l))){n=s;break}a+=4,i=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&(F(n,r+1,1),e=!n.times(n).times(n).eq(l));break}return z=!0,F(n,r,m.rounding,e)};I.decimalPlaces=I.dp=function(){var r,e=this.d,t=NaN;if(e){if(r=e.length-1,t=(r-Ce(this.e/U))*U,r=e[r],r)for(;r%10==0;r/=10)t--;t<0&&(t=0)}return t};I.dividedBy=I.div=function(r){return ae(this,new this.constructor(r))};I.dividedToIntegerBy=I.divToInt=function(r){var e=this,t=e.constructor;return F(ae(e,new t(r),0,1,1),t.precision,t.rounding)};I.equals=I.eq=function(r){return this.cmp(r)===0};I.floor=function(){return F(new this.constructor(this),this.e+1,3)};I.greaterThan=I.gt=function(r){return this.cmp(r)>0};I.greaterThanOrEqualTo=I.gte=function(r){var e=this.cmp(r);return e==1||e===0};I.hyperbolicCosine=I.cosh=function(){var r,e,t,n,i,o=this,a=o.constructor,s=new a(1);if(!o.isFinite())return new a(o.s?1/0:NaN);if(o.isZero())return s;t=a.precision,n=a.rounding,a.precision=t+Math.max(o.e,o.sd())+4,a.rounding=1,i=o.d.length,i<32?(r=Math.ceil(i/3),e=(1/vn(4,r)).toString()):(r=16,e="2.3283064365386962890625e-10"),o=Gt(a,1,o.times(e),new a(1),!0);for(var c,u=r,l=new a(8);u--;)c=o.times(o),o=s.minus(c.times(l.minus(c.times(l))));return F(o,a.precision=t,a.rounding=n,!0)};I.hyperbolicSine=I.sinh=function(){var r,e,t,n,i=this,o=i.constructor;if(!i.isFinite()||i.isZero())return new o(i);if(e=o.precision,t=o.rounding,o.precision=e+Math.max(i.e,i.sd())+4,o.rounding=1,n=i.d.length,n<3)i=Gt(o,2,i,i,!0);else{r=1.4*Math.sqrt(n),r=r>16?16:r|0,i=i.times(1/vn(5,r)),i=Gt(o,2,i,i,!0);for(var a,s=new o(5),c=new o(16),u=new o(20);r--;)a=i.times(i),i=i.times(s.plus(a.times(c.times(a).plus(u))))}return o.precision=e,o.rounding=t,F(i,e,t,!0)};I.hyperbolicTangent=I.tanh=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+7,n.rounding=1,ae(t.sinh(),t.cosh(),n.precision=r,n.rounding=e)):new n(t.s)};I.inverseCosine=I.acos=function(){var r,e=this,t=e.constructor,n=e.abs().cmp(1),i=t.precision,o=t.rounding;return n!==-1?n===0?e.isNeg()?ze(t,i,o):new t(0):new t(NaN):e.isZero()?ze(t,i+4,o).times(.5):(t.precision=i+6,t.rounding=1,e=e.asin(),r=ze(t,i+4,o).times(.5),t.precision=i,t.rounding=o,r.minus(e))};I.inverseHyperbolicCosine=I.acosh=function(){var r,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(r=n.precision,e=n.rounding,n.precision=r+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,z=!1,t=t.times(t).minus(1).sqrt().plus(t),z=!0,n.precision=r,n.rounding=e,t.ln()):new n(t)};I.inverseHyperbolicSine=I.asinh=function(){var r,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,z=!1,t=t.times(t).plus(1).sqrt().plus(t),z=!0,n.precision=r,n.rounding=e,t.ln())};I.inverseHyperbolicTangent=I.atanh=function(){var r,e,t,n,i=this,o=i.constructor;return i.isFinite()?i.e>=0?new o(i.abs().eq(1)?i.s/0:i.isZero()?i:NaN):(r=o.precision,e=o.rounding,n=i.sd(),Math.max(n,r)<2*-i.e-1?F(new o(i),r,e,!0):(o.precision=t=n-i.e,i=ae(i.plus(1),new o(1).minus(i),t+r,1),o.precision=r+4,o.rounding=1,i=i.ln(),o.precision=r,o.rounding=e,i.times(.5))):new o(NaN)};I.inverseSine=I.asin=function(){var r,e,t,n,i=this,o=i.constructor;return i.isZero()?new o(i):(e=i.abs().cmp(1),t=o.precision,n=o.rounding,e!==-1?e===0?(r=ze(o,t+4,n).times(.5),r.s=i.s,r):new o(NaN):(o.precision=t+6,o.rounding=1,i=i.div(new o(1).minus(i.times(i)).sqrt().plus(1)).atan(),o.precision=t,o.rounding=n,i.times(2)))};I.inverseTangent=I.atan=function(){var r,e,t,n,i,o,a,s,c,u=this,l=u.constructor,m=l.precision,d=l.rounding;if(u.isFinite()){if(u.isZero())return new l(u);if(u.abs().eq(1)&&m+4<=pr)return a=ze(l,m+4,d).times(.25),a.s=u.s,a}else{if(!u.s)return new l(NaN);if(m+4<=pr)return a=ze(l,m+4,d).times(.5),a.s=u.s,a}for(l.precision=s=m+10,l.rounding=1,t=Math.min(28,s/U+2|0),r=t;r;--r)u=u.div(u.times(u).plus(1).sqrt().plus(1));for(z=!1,e=Math.ceil(s/U),n=1,c=u.times(u),a=new l(u),i=u;r!==-1;)if(i=i.times(c),o=a.minus(i.div(n+=2)),i=i.times(c),a=o.plus(i.div(n+=2)),a.d[e]!==void 0)for(r=e;a.d[r]===o.d[r]&&r--;);return t&&(a=a.times(2<<t-1)),z=!0,F(a,l.precision=m,l.rounding=d,!0)};I.isFinite=function(){return!!this.d};I.isInteger=I.isInt=function(){return!!this.d&&Ce(this.e/U)>this.d.length-2};I.isNaN=function(){return!this.s};I.isNegative=I.isNeg=function(){return this.s<0};I.isPositive=I.isPos=function(){return this.s>0};I.isZero=function(){return!!this.d&&this.d[0]===0};I.lessThan=I.lt=function(r){return this.cmp(r)<0};I.lessThanOrEqualTo=I.lte=function(r){return this.cmp(r)<1};I.logarithm=I.log=function(r){var e,t,n,i,o,a,s,c,u=this,l=u.constructor,m=l.precision,d=l.rounding,p=5;if(r==null)r=new l(10),e=!0;else{if(r=new l(r),t=r.d,r.s<0||!t||!t[0]||r.eq(1))return new l(NaN);e=r.eq(10)}if(t=u.d,u.s<0||!t||!t[0]||u.eq(1))return new l(t&&!t[0]?-1/0:u.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)o=!0;else{for(i=t[0];i%10===0;)i/=10;o=i!==1}if(z=!1,s=m+p,a=yt(u,s),n=e?Cn(l,s+10):yt(r,s),c=ae(a,n,s,1),sn(c.d,i=m,d))do if(s+=10,a=yt(u,s),n=e?Cn(l,s+10):yt(r,s),c=ae(a,n,s,1),!o){+Se(c.d).slice(i+1,i+15)+1==1e14&&(c=F(c,m+1,0));break}while(sn(c.d,i+=10,d));return z=!0,F(c,m,d)};I.minus=I.sub=function(r){var e,t,n,i,o,a,s,c,u,l,m,d,p=this,f=p.constructor;if(r=new f(r),!p.d||!r.d)return!p.s||!r.s?r=new f(NaN):p.d?r.s=-r.s:r=new f(r.d||p.s!==r.s?p:NaN),r;if(p.s!=r.s)return r.s=-r.s,p.plus(r);if(u=p.d,d=r.d,s=f.precision,c=f.rounding,!u[0]||!d[0]){if(d[0])r.s=-r.s;else if(u[0])r=new f(p);else return new f(c===3?-0:0);return z?F(r,s,c):r}if(t=Ce(r.e/U),l=Ce(p.e/U),u=u.slice(),o=l-t,o){for(m=o<0,m?(e=u,o=-o,a=d.length):(e=d,t=l,a=u.length),n=Math.max(Math.ceil(s/U),a)+2,o>n&&(o=n,e.length=1),e.reverse(),n=o;n--;)e.push(0);e.reverse()}else{for(n=u.length,a=d.length,m=n<a,m&&(a=n),n=0;n<a;n++)if(u[n]!=d[n]){m=u[n]<d[n];break}o=0}for(m&&(e=u,u=d,d=e,r.s=-r.s),a=u.length,n=d.length-a;n>0;--n)u[a++]=0;for(n=d.length;n>o;){if(u[--n]<d[n]){for(i=n;i&&u[--i]===0;)u[i]=He-1;--u[i],u[n]+=He}u[n]-=d[n]}for(;u[--a]===0;)u.pop();for(;u[0]===0;u.shift())--t;return u[0]?(r.d=u,r.e=Mn(u,t),z?F(r,s,c):r):new f(c===3?-0:0)};I.modulo=I.mod=function(r){var e,t=this,n=t.constructor;return r=new n(r),!t.d||!r.s||r.d&&!r.d[0]?new n(NaN):!r.d||t.d&&!t.d[0]?F(new n(t),n.precision,n.rounding):(z=!1,n.modulo==9?(e=ae(t,r.abs(),0,3,1),e.s*=r.s):e=ae(t,r,0,n.modulo,1),e=e.times(r),z=!0,t.minus(e))};I.naturalExponential=I.exp=function(){return fr(this)};I.naturalLogarithm=I.ln=function(){return yt(this)};I.negated=I.neg=function(){var r=new this.constructor(this);return r.s=-r.s,F(r)};I.plus=I.add=function(r){var e,t,n,i,o,a,s,c,u,l,m=this,d=m.constructor;if(r=new d(r),!m.d||!r.d)return!m.s||!r.s?r=new d(NaN):m.d||(r=new d(r.d||m.s===r.s?m:NaN)),r;if(m.s!=r.s)return r.s=-r.s,m.minus(r);if(u=m.d,l=r.d,s=d.precision,c=d.rounding,!u[0]||!l[0])return l[0]||(r=new d(m)),z?F(r,s,c):r;if(o=Ce(m.e/U),n=Ce(r.e/U),u=u.slice(),i=o-n,i){for(i<0?(t=u,i=-i,a=l.length):(t=l,n=o,a=u.length),o=Math.ceil(s/U),a=o>a?o+1:a+1,i>a&&(i=a,t.length=1),t.reverse();i--;)t.push(0);t.reverse()}for(a=u.length,i=l.length,a-i<0&&(i=a,t=l,l=u,u=t),e=0;i;)e=(u[--i]=u[i]+l[i]+e)/He|0,u[i]%=He;for(e&&(u.unshift(e),++n),a=u.length;u[--a]==0;)u.pop();return r.d=u,r.e=Mn(u,n),z?F(r,s,c):r};I.precision=I.sd=function(r){var e,t=this;if(r!==void 0&&r!==!!r&&r!==1&&r!==0)throw Error(gt+r);return t.d?(e=Ti(t.d),r&&t.e+1>e&&(e=t.e+1)):e=NaN,e};I.round=function(){var r=this,e=r.constructor;return F(new e(r),r.e+1,e.rounding)};I.sine=I.sin=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+U,n.rounding=1,t=gs(n,Ii(n,t)),n.precision=r,n.rounding=e,F(st>2?t.neg():t,r,e,!0)):new n(NaN)};I.squareRoot=I.sqrt=function(){var r,e,t,n,i,o,a=this,s=a.d,c=a.e,u=a.s,l=a.constructor;if(u!==1||!s||!s[0])return new l(!u||u<0&&(!s||s[0])?NaN:s?a:1/0);for(z=!1,u=Math.sqrt(+a),u==0||u==1/0?(e=Se(s),(e.length+c)%2==0&&(e+="0"),u=Math.sqrt(e),c=Ce((c+1)/2)-(c<0||c%2),u==1/0?e="5e"+c:(e=u.toExponential(),e=e.slice(0,e.indexOf("e")+1)+c),n=new l(e)):n=new l(u.toString()),t=(c=l.precision)+3;;)if(o=n,n=o.plus(ae(a,o,t+2,1)).times(.5),Se(o.d).slice(0,t)===(e=Se(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!i&&e=="4999"){if(!i&&(F(o,c+1,0),o.times(o).eq(a))){n=o;break}t+=4,i=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&(F(n,c+1,1),r=!n.times(n).eq(a));break}return z=!0,F(n,c,l.rounding,r)};I.tangent=I.tan=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+10,n.rounding=1,t=t.sin(),t.s=1,t=ae(t,new n(1).minus(t.times(t)).sqrt(),r+10,0),n.precision=r,n.rounding=e,F(st==2||st==4?t.neg():t,r,e,!0)):new n(NaN)};I.times=I.mul=function(r){var e,t,n,i,o,a,s,c,u,l=this,m=l.constructor,d=l.d,p=(r=new m(r)).d;if(r.s*=l.s,!d||!d[0]||!p||!p[0])return new m(!r.s||d&&!d[0]&&!p||p&&!p[0]&&!d?NaN:!d||!p?r.s/0:r.s*0);for(t=Ce(l.e/U)+Ce(r.e/U),c=d.length,u=p.length,c<u&&(o=d,d=p,p=o,a=c,c=u,u=a),o=[],a=c+u,n=a;n--;)o.push(0);for(n=u;--n>=0;){for(e=0,i=c+n;i>n;)s=o[i]+p[n]*d[i-n-1]+e,o[i--]=s%He|0,e=s/He|0;o[i]=(o[i]+e)%He|0}for(;!o[--a];)o.pop();return e?++t:o.shift(),r.d=o,r.e=Mn(o,t),z?F(r,m.precision,m.rounding):r};I.toBinary=function(r,e){return yr(this,2,r,e)};I.toDecimalPlaces=I.toDP=function(r,e){var t=this,n=t.constructor;return t=new n(t),r===void 0?t:(Ve(r,0,wt),e===void 0?e=n.rounding:Ve(e,0,8),F(t,r+t.e+1,e))};I.toExponential=function(r,e){var t,n=this,i=n.constructor;return r===void 0?t=$e(n,!0):(Ve(r,0,wt),e===void 0?e=i.rounding:Ve(e,0,8),n=F(new i(n),r+1,e),t=$e(n,!0,r+1)),n.isNeg()&&!n.isZero()?"-"+t:t};I.toFixed=function(r,e){var t,n,i=this,o=i.constructor;return r===void 0?t=$e(i):(Ve(r,0,wt),e===void 0?e=o.rounding:Ve(e,0,8),n=F(new o(i),r+i.e+1,e),t=$e(n,!1,r+n.e+1)),i.isNeg()&&!i.isZero()?"-"+t:t};I.toFraction=function(r){var e,t,n,i,o,a,s,c,u,l,m,d,p=this,f=p.d,y=p.constructor;if(!f)return new y(p);if(u=t=new y(1),n=c=new y(0),e=new y(n),o=e.e=Ti(f)-p.e-1,a=o%U,e.d[0]=Ae(10,a<0?U+a:a),r==null)r=o>0?e:u;else{if(s=new y(r),!s.isInt()||s.lt(u))throw Error(gt+s);r=s.gt(e)?o>0?e:u:s}for(z=!1,s=new y(Se(f)),l=y.precision,y.precision=o=f.length*U*2;m=ae(s,e,0,1,1),i=t.plus(m.times(n)),i.cmp(r)!=1;)t=n,n=i,i=u,u=c.plus(m.times(i)),c=i,i=e,e=s.minus(m.times(i)),s=i;return i=ae(r.minus(t),n,0,1,1),c=c.plus(i.times(u)),t=t.plus(i.times(n)),c.s=u.s=p.s,d=ae(u,n,o,1).minus(p).abs().cmp(ae(c,t,o,1).minus(p).abs())<1?[u,n]:[c,t],y.precision=l,z=!0,d};I.toHexadecimal=I.toHex=function(r,e){return yr(this,16,r,e)};I.toNearest=function(r,e){var t=this,n=t.constructor;if(t=new n(t),r==null){if(!t.d)return t;r=new n(1),e=n.rounding}else{if(r=new n(r),e===void 0?e=n.rounding:Ve(e,0,8),!t.d)return r.s?t:r;if(!r.d)return r.s&&(r.s=t.s),r}return r.d[0]?(z=!1,t=ae(t,r,0,e,1).times(r),z=!0,F(t)):(r.s=t.s,t=r),t};I.toNumber=function(){return+this};I.toOctal=function(r,e){return yr(this,8,r,e)};I.toPower=I.pow=function(r){var e,t,n,i,o,a,s=this,c=s.constructor,u=+(r=new c(r));if(!s.d||!r.d||!s.d[0]||!r.d[0])return new c(Ae(+s,u));if(s=new c(s),s.eq(1))return s;if(n=c.precision,o=c.rounding,r.eq(1))return F(s,n,o);if(e=Ce(r.e/U),e>=r.d.length-1&&(t=u<0?-u:u)<=ps)return i=xi(c,s,t,n),r.s<0?new c(1).div(i):F(i,n,o);if(a=s.s,a<0){if(e<r.d.length-1)return new c(NaN);if((r.d[e]&1)==0&&(a=1),s.e==0&&s.d[0]==1&&s.d.length==1)return s.s=a,s}return t=Ae(+s,u),e=t==0||!isFinite(t)?Ce(u*(Math.log("0."+Se(s.d))/Math.LN10+s.e+1)):new c(t+"").e,e>c.maxE+1||e<c.minE-1?new c(e>0?a/0:0):(z=!1,c.rounding=s.s=1,t=Math.min(12,(e+"").length),i=fr(r.times(yt(s,n+t)),n),i.d&&(i=F(i,n+5,1),sn(i.d,n,o)&&(e=n+10,i=F(fr(r.times(yt(s,e+t)),e),e+5,1),+Se(i.d).slice(n+1,n+15)+1==1e14&&(i=F(i,n+1,0)))),i.s=a,z=!0,c.rounding=o,F(i,n,o))};I.toPrecision=function(r,e){var t,n=this,i=n.constructor;return r===void 0?t=$e(n,n.e<=i.toExpNeg||n.e>=i.toExpPos):(Ve(r,1,wt),e===void 0?e=i.rounding:Ve(e,0,8),n=F(new i(n),r,e),t=$e(n,r<=n.e||n.e<=i.toExpNeg,r)),n.isNeg()&&!n.isZero()?"-"+t:t};I.toSignificantDigits=I.toSD=function(r,e){var t=this,n=t.constructor;return r===void 0?(r=n.precision,e=n.rounding):(Ve(r,1,wt),e===void 0?e=n.rounding:Ve(e,0,8)),F(new n(t),r,e)};I.toString=function(){var r=this,e=r.constructor,t=$e(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()&&!r.isZero()?"-"+t:t};I.truncated=I.trunc=function(){return F(new this.constructor(this),this.e+1,1)};I.valueOf=I.toJSON=function(){var r=this,e=r.constructor,t=$e(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()?"-"+t:t};function Se(r){var e,t,n,i=r.length-1,o="",a=r[0];if(i>0){for(o+=a,e=1;e<i;e++)n=r[e]+"",t=U-n.length,t&&(o+=bt(t)),o+=n;a=r[e],n=a+"",t=U-n.length,t&&(o+=bt(t))}else if(a===0)return"0";for(;a%10===0;)a/=10;return o+a}function Ve(r,e,t){if(r!==~~r||r<e||r>t)throw Error(gt+r)}function sn(r,e,t,n){var i,o,a,s;for(o=r[0];o>=10;o/=10)--e;return--e<0?(e+=U,i=0):(i=Math.ceil((e+1)/U),e%=U),o=Ae(10,U-e),s=r[i]%o|0,n==null?e<3?(e==0?s=s/100|0:e==1&&(s=s/10|0),a=t<4&&s==99999||t>3&&s==49999||s==5e4||s==0):a=(t<4&&s+1==o||t>3&&s+1==o/2)&&(r[i+1]/o/100|0)==Ae(10,e-2)-1||(s==o/2||s==0)&&(r[i+1]/o/100|0)==0:e<4?(e==0?s=s/1e3|0:e==1?s=s/100|0:e==2&&(s=s/10|0),a=(n||t<4)&&s==9999||!n&&t>3&&s==4999):a=((n||t<4)&&s+1==o||!n&&t>3&&s+1==o/2)&&(r[i+1]/o/1e3|0)==Ae(10,e-3)-1,a}function Kn(r,e,t){for(var n,i=[0],o,a=0,s=r.length;a<s;){for(o=i.length;o--;)i[o]*=e;for(i[0]+=mr.indexOf(r.charAt(a++)),n=0;n<i.length;n++)i[n]>t-1&&(i[n+1]===void 0&&(i[n+1]=0),i[n+1]+=i[n]/t|0,i[n]%=t)}return i.reverse()}function bs(r,e){var t,n,i;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),i=(1/vn(4,t)).toString()):(t=16,i="2.3283064365386962890625e-10"),r.precision+=t,e=Gt(r,1,e.times(i),new r(1));for(var o=t;o--;){var a=e.times(e);e=a.times(a).minus(a).times(8).plus(1)}return r.precision-=t,e}var ae=function(){function r(n,i,o){var a,s=0,c=n.length;for(n=n.slice();c--;)a=n[c]*i+s,n[c]=a%o|0,s=a/o|0;return s&&n.unshift(s),n}function e(n,i,o,a){var s,c;if(o!=a)c=o>a?1:-1;else for(s=c=0;s<o;s++)if(n[s]!=i[s]){c=n[s]>i[s]?1:-1;break}return c}function t(n,i,o,a){for(var s=0;o--;)n[o]-=s,s=n[o]<i[o]?1:0,n[o]=s*a+n[o]-i[o];for(;!n[0]&&n.length>1;)n.shift()}return function(n,i,o,a,s,c){var u,l,m,d,p,f,y,g,w,h,k,P,T,A,S,L,x,R,v,W,X=n.constructor,$=n.s==i.s?1:-1,J=n.d,G=i.d;if(!J||!J[0]||!G||!G[0])return new X(!n.s||!i.s||(J?G&&J[0]==G[0]:!G)?NaN:J&&J[0]==0||!G?$*0:$/0);for(c?(p=1,l=n.e-i.e):(c=He,p=U,l=Ce(n.e/p)-Ce(i.e/p)),v=G.length,x=J.length,w=new X($),h=w.d=[],m=0;G[m]==(J[m]||0);m++);if(G[m]>(J[m]||0)&&l--,o==null?(A=o=X.precision,a=X.rounding):s?A=o+(n.e-i.e)+1:A=o,A<0)h.push(1),f=!0;else{if(A=A/p+2|0,m=0,v==1){for(d=0,G=G[0],A++;(m<x||d)&&A--;m++)S=d*c+(J[m]||0),h[m]=S/G|0,d=S%G|0;f=d||m<x}else{for(d=c/(G[0]+1)|0,d>1&&(G=r(G,d,c),J=r(J,d,c),v=G.length,x=J.length),L=v,k=J.slice(0,v),P=k.length;P<v;)k[P++]=0;W=G.slice(),W.unshift(0),R=G[0],G[1]>=c/2&&++R;do d=0,u=e(G,k,v,P),u<0?(T=k[0],v!=P&&(T=T*c+(k[1]||0)),d=T/R|0,d>1?(d>=c&&(d=c-1),y=r(G,d,c),g=y.length,P=k.length,u=e(y,k,g,P),u==1&&(d--,t(y,v<g?W:G,g,c))):(d==0&&(u=d=1),y=G.slice()),g=y.length,g<P&&y.unshift(0),t(k,y,P,c),u==-1&&(P=k.length,u=e(G,k,v,P),u<1&&(d++,t(k,v<P?W:G,P,c))),P=k.length):u===0&&(d++,k=[0]),h[m++]=d,u&&k[0]?k[P++]=J[L]||0:(k=[J[L]],P=1);while((L++<x||k[0]!==void 0)&&A--);f=k[0]!==void 0}h[0]||h.shift()}if(p==1)w.e=l,wi=f;else{for(m=1,d=h[0];d>=10;d/=10)m++;w.e=m+l*p-1,F(w,s?o+w.e+1:o,a,f)}return w}}();function F(r,e,t,n){var i,o,a,s,c,u,l,m,d,p=r.constructor;e:if(e!=null){if(m=r.d,!m)return r;for(i=1,s=m[0];s>=10;s/=10)i++;if(o=e-i,o<0)o+=U,a=e,l=m[d=0],c=l/Ae(10,i-a-1)%10|0;else if(d=Math.ceil((o+1)/U),s=m.length,d>=s)if(n){for(;s++<=d;)m.push(0);l=c=0,i=1,o%=U,a=o-U+1}else break e;else{for(l=s=m[d],i=1;s>=10;s/=10)i++;o%=U,a=o-U+i,c=a<0?0:l/Ae(10,i-a-1)%10|0}if(n=n||e<0||m[d+1]!==void 0||(a<0?l:l%Ae(10,i-a-1)),u=t<4?(c||n)&&(t==0||t==(r.s<0?3:2)):c>5||c==5&&(t==4||n||t==6&&(o>0?a>0?l/Ae(10,i-a):0:m[d-1])%10&1||t==(r.s<0?8:7)),e<1||!m[0])return m.length=0,u?(e-=r.e+1,m[0]=Ae(10,(U-e%U)%U),r.e=-e||0):m[0]=r.e=0,r;if(o==0?(m.length=d,s=1,d--):(m.length=d+1,s=Ae(10,U-o),m[d]=a>0?(l/Ae(10,i-a)%Ae(10,a)|0)*s:0),u)for(;;)if(d==0){for(o=1,a=m[0];a>=10;a/=10)o++;for(a=m[0]+=s,s=1;a>=10;a/=10)s++;o!=s&&(r.e++,m[0]==He&&(m[0]=1));break}else{if(m[d]+=s,m[d]!=He)break;m[d--]=0,s=1}for(o=m.length;m[--o]===0;)m.pop()}return z&&(r.e>p.maxE?(r.d=null,r.e=NaN):r.e<p.minE&&(r.e=0,r.d=[0])),r}function $e(r,e,t){if(!r.isFinite())return Bi(r);var n,i=r.e,o=Se(r.d),a=o.length;return e?(t&&(n=t-a)>0?o=o.charAt(0)+"."+o.slice(1)+bt(n):a>1&&(o=o.charAt(0)+"."+o.slice(1)),o=o+(r.e<0?"e":"e+")+r.e):i<0?(o="0."+bt(-i-1)+o,t&&(n=t-a)>0&&(o+=bt(n))):i>=a?(o+=bt(i+1-a),t&&(n=t-i-1)>0&&(o=o+"."+bt(n))):((n=i+1)<a&&(o=o.slice(0,n)+"."+o.slice(n)),t&&(n=t-a)>0&&(i+1===a&&(o+="."),o+=bt(n))),o}function Mn(r,e){var t=r[0];for(e*=U;t>=10;t/=10)e++;return e}function Cn(r,e,t){if(e>fs)throw z=!0,t&&(r.precision=t),Error(ki);return F(new r(Ln),e,1,!0)}function ze(r,e,t){if(e>pr)throw Error(ki);return F(new r(Nn),e,t,!0)}function Ti(r){var e=r.length-1,t=e*U+1;if(e=r[e],e){for(;e%10==0;e/=10)t--;for(e=r[0];e>=10;e/=10)t++}return t}function bt(r){for(var e="";r--;)e+="0";return e}function xi(r,e,t,n){var i,o=new r(1),a=Math.ceil(n/U+4);for(z=!1;;){if(t%2&&(o=o.times(e),yi(o.d,a)&&(i=!0)),t=Ce(t/2),t===0){t=o.d.length-1,i&&o.d[t]===0&&++o.d[t];break}e=e.times(e),yi(e.d,a)}return z=!0,o}function bi(r){return r.d[r.d.length-1]&1}function Si(r,e,t){for(var n,i=new r(e[0]),o=0;++o<e.length;)if(n=new r(e[o]),n.s)i[t](n)&&(i=n);else{i=n;break}return i}function fr(r,e){var t,n,i,o,a,s,c,u=0,l=0,m=0,d=r.constructor,p=d.rounding,f=d.precision;if(!r.d||!r.d[0]||r.e>17)return new d(r.d?r.d[0]?r.s<0?0:1/0:1:r.s?r.s<0?0:r:0/0);for(e==null?(z=!1,c=f):c=e,s=new d(.03125);r.e>-2;)r=r.times(s),m+=5;for(n=Math.log(Ae(2,m))/Math.LN10*2+5|0,c+=n,t=o=a=new d(1),d.precision=c;;){if(o=F(o.times(r),c,1),t=t.times(++l),s=a.plus(ae(o,t,c,1)),Se(s.d).slice(0,c)===Se(a.d).slice(0,c)){for(i=m;i--;)a=F(a.times(a),c,1);if(e==null)if(u<3&&sn(a.d,c-n,p,u))d.precision=c+=10,t=o=s=new d(1),l=0,u++;else return F(a,d.precision=f,p,z=!0);else return d.precision=f,a}a=s}}function yt(r,e){var t,n,i,o,a,s,c,u,l,m,d,p=1,f=10,y=r,g=y.d,w=y.constructor,h=w.rounding,k=w.precision;if(y.s<0||!g||!g[0]||!y.e&&g[0]==1&&g.length==1)return new w(g&&!g[0]?-1/0:y.s!=1?NaN:g?0:y);if(e==null?(z=!1,l=k):l=e,w.precision=l+=f,t=Se(g),n=t.charAt(0),Math.abs(o=y.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)y=y.times(r),t=Se(y.d),n=t.charAt(0),p++;o=y.e,n>1?(y=new w("0."+t),o++):y=new w(n+"."+t.slice(1))}else return u=Cn(w,l+2,k).times(o+""),y=yt(new w(n+"."+t.slice(1)),l-f).plus(u),w.precision=k,e==null?F(y,k,h,z=!0):y;for(m=y,c=a=y=ae(y.minus(1),y.plus(1),l,1),d=F(y.times(y),l,1),i=3;;){if(a=F(a.times(d),l,1),u=c.plus(ae(a,new w(i),l,1)),Se(u.d).slice(0,l)===Se(c.d).slice(0,l))if(c=c.times(2),o!==0&&(c=c.plus(Cn(w,l+2,k).times(o+""))),c=ae(c,new w(p),l,1),e==null)if(sn(c.d,l-f,h,s))w.precision=l+=f,u=a=y=ae(m.minus(1),m.plus(1),l,1),d=F(y.times(y),l,1),i=s=1;else return F(c,w.precision=k,h,z=!0);else return w.precision=k,c;c=u,i+=2}}function Bi(r){return String(r.s*r.s/0)}function br(r,e){var t,n,i;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(i=e.length;e.charCodeAt(i-1)===48;--i);if(e=e.slice(n,i),e){if(i-=n,r.e=t=t-n-1,r.d=[],n=(t+1)%U,t<0&&(n+=U),n<i){for(n&&r.d.push(+e.slice(0,n)),i-=U;n<i;)r.d.push(+e.slice(n,n+=U));e=e.slice(n),n=U-e.length}else n-=i;for(;n--;)e+="0";r.d.push(+e),z&&(r.e>r.constructor.maxE?(r.d=null,r.e=NaN):r.e<r.constructor.minE&&(r.e=0,r.d=[0]))}else r.e=0,r.d=[0];return r}function ys(r,e){var t,n,i,o,a,s,c,u,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),Pi.test(e))return br(r,e)}else if(e==="Infinity"||e==="NaN")return+e||(r.s=NaN),r.e=NaN,r.d=null,r;if(ms.test(e))t=16,e=e.toLowerCase();else if(ls.test(e))t=2;else if(ds.test(e))t=8;else throw Error(gt+e);for(o=e.search(/p/i),o>0?(c=+e.slice(o+1),e=e.substring(2,o)):e=e.slice(2),o=e.indexOf("."),a=o>=0,n=r.constructor,a&&(e=e.replace(".",""),s=e.length,o=s-o,i=xi(n,new n(t),o,o*2)),u=Kn(e,t,He),l=u.length-1,o=l;u[o]===0;--o)u.pop();return o<0?new n(r.s*0):(r.e=Mn(u,l),r.d=u,z=!1,a&&(r=ae(r,i,s*4)),c&&(r=r.times(Math.abs(c)<54?Ae(2,c):an.pow(2,c))),z=!0,r)}function gs(r,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:Gt(r,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/vn(5,t)),e=Gt(r,2,e,e);for(var i,o=new r(5),a=new r(16),s=new r(20);t--;)i=e.times(e),e=e.times(o.plus(i.times(a.times(i).minus(s))));return e}function Gt(r,e,t,n,i){var o,a,s,c,u=1,l=r.precision,m=Math.ceil(l/U);for(z=!1,c=t.times(t),s=new r(n);;){if(a=ae(s.times(c),new r(e++*e++),l,1),s=i?n.plus(a):n.minus(a),n=ae(a.times(c),new r(e++*e++),l,1),a=s.plus(n),a.d[m]!==void 0){for(o=m;a.d[o]===s.d[o]&&o--;);if(o==-1)break}o=s,s=n,n=a,a=o,u++}return z=!0,a.d.length=m+1,a}function vn(r,e){for(var t=r;--e;)t*=r;return t}function Ii(r,e){var t,n=e.s<0,i=ze(r,r.precision,1),o=i.times(.5);if(e=e.abs(),e.lte(o))return st=n?4:1,e;if(t=e.divToInt(i),t.isZero())st=n?3:2;else{if(e=e.minus(t.times(i)),e.lte(o))return st=bi(t)?n?2:3:n?4:1,e;st=bi(t)?n?1:4:n?3:2}return e.minus(i).abs()}function yr(r,e,t,n){var i,o,a,s,c,u,l,m,d,p=r.constructor,f=t!==void 0;if(f?(Ve(t,1,wt),n===void 0?n=p.rounding:Ve(n,0,8)):(t=p.precision,n=p.rounding),!r.isFinite())l=Bi(r);else{for(l=$e(r),a=l.indexOf("."),f?(i=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):i=e,a>=0&&(l=l.replace(".",""),d=new p(1),d.e=l.length-a,d.d=Kn($e(d),10,i),d.e=d.d.length),m=Kn(l,10,i),o=c=m.length;m[--c]==0;)m.pop();if(!m[0])l=f?"0p+0":"0";else{if(a<0?o--:(r=new p(r),r.d=m,r.e=o,r=ae(r,d,t,n,0,i),m=r.d,o=r.e,u=wi),a=m[t],s=i/2,u=u||m[t+1]!==void 0,u=n<4?(a!==void 0||u)&&(n===0||n===(r.s<0?3:2)):a>s||a===s&&(n===4||u||n===6&&m[t-1]&1||n===(r.s<0?8:7)),m.length=t,u)for(;++m[--t]>i-1;)m[t]=0,t||(++o,m.unshift(1));for(c=m.length;!m[c-1];--c);for(a=0,l="";a<c;a++)l+=mr.charAt(m[a]);if(f){if(c>1)if(e==16||e==8){for(a=e==16?4:3,--c;c%a;c++)l+="0";for(m=Kn(l,i,e),c=m.length;!m[c-1];--c);for(a=1,l="1.";a<c;a++)l+=mr.charAt(m[a])}else l=l.charAt(0)+"."+l.slice(1);l=l+(o<0?"p":"p+")+o}else if(o<0){for(;++o;)l="0"+l;l="0."+l}else if(++o>c)for(o-=c;o--;)l+="0";else o<c&&(l=l.slice(0,o)+"."+l.slice(o))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return r.s<0?"-"+l:l}function yi(r,e){if(r.length>e)return r.length=e,!0}function ws(r){return new this(r).abs()}function ks(r){return new this(r).acos()}function hs(r){return new this(r).acosh()}function As(r,e){return new this(r).plus(e)}function Ps(r){return new this(r).asin()}function Ts(r){return new this(r).asinh()}function xs(r){return new this(r).atan()}function Ss(r){return new this(r).atanh()}function Bs(r,e){r=new this(r),e=new this(e);var t,n=this.precision,i=this.rounding,o=n+4;return!r.s||!e.s?t=new this(NaN):!r.d&&!e.d?(t=ze(this,o,1).times(e.s>0?.25:.75),t.s=r.s):!e.d||r.isZero()?(t=e.s<0?ze(this,n,i):new this(0),t.s=r.s):!r.d||e.isZero()?(t=ze(this,o,1).times(.5),t.s=r.s):e.s<0?(this.precision=o,this.rounding=1,t=this.atan(ae(r,e,o,1)),e=ze(this,o,1),this.precision=n,this.rounding=i,t=r.s<0?t.minus(e):t.plus(e)):t=this.atan(ae(r,e,o,1)),t}function Is(r){return new this(r).cbrt()}function Ks(r){return F(r=new this(r),r.e+1,2)}function Ls(r,e,t){return new this(r).clamp(e,t)}function Ns(r){if(!r||typeof r!="object")throw Error(Rn+"Object expected");var e,t,n,i=r.defaults===!0,o=["precision",1,wt,"rounding",0,8,"toExpNeg",-Ut,0,"toExpPos",0,Ut,"maxE",0,Ut,"minE",-Ut,0,"modulo",0,9];for(e=0;e<o.length;e+=3)if(t=o[e],i&&(this[t]=dr[t]),(n=r[t])!==void 0)if(Ce(n)===n&&n>=o[e+1]&&n<=o[e+2])this[t]=n;else throw Error(gt+t+": "+n);if(t="crypto",i&&(this[t]=dr[t]),(n=r[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(hi);else this[t]=!1;else throw Error(gt+t+": "+n);return this}function Cs(r){return new this(r).cos()}function Rs(r){return new this(r).cosh()}function Ki(r){var e,t,n;function i(o){var a,s,c,u=this;if(!(u instanceof i))return new i(o);if(u.constructor=i,gi(o)){u.s=o.s,z?!o.d||o.e>i.maxE?(u.e=NaN,u.d=null):o.e<i.minE?(u.e=0,u.d=[0]):(u.e=o.e,u.d=o.d.slice()):(u.e=o.e,u.d=o.d?o.d.slice():o.d);return}if(c=typeof o,c==="number"){if(o===0){u.s=1/o<0?-1:1,u.e=0,u.d=[0];return}if(o<0?(o=-o,u.s=-1):u.s=1,o===~~o&&o<1e7){for(a=0,s=o;s>=10;s/=10)a++;z?a>i.maxE?(u.e=NaN,u.d=null):a<i.minE?(u.e=0,u.d=[0]):(u.e=a,u.d=[o]):(u.e=a,u.d=[o]);return}else if(o*0!==0){o||(u.s=NaN),u.e=NaN,u.d=null;return}return br(u,o.toString())}else if(c!=="string")throw Error(gt+o);return(s=o.charCodeAt(0))===45?(o=o.slice(1),u.s=-1):(s===43&&(o=o.slice(1)),u.s=1),Pi.test(o)?br(u,o):ys(u,o)}if(i.prototype=I,i.ROUND_UP=0,i.ROUND_DOWN=1,i.ROUND_CEIL=2,i.ROUND_FLOOR=3,i.ROUND_HALF_UP=4,i.ROUND_HALF_DOWN=5,i.ROUND_HALF_EVEN=6,i.ROUND_HALF_CEIL=7,i.ROUND_HALF_FLOOR=8,i.EUCLID=9,i.config=i.set=Ns,i.clone=Ki,i.isDecimal=gi,i.abs=ws,i.acos=ks,i.acosh=hs,i.add=As,i.asin=Ps,i.asinh=Ts,i.atan=xs,i.atanh=Ss,i.atan2=Bs,i.cbrt=Is,i.ceil=Ks,i.clamp=Ls,i.cos=Cs,i.cosh=Rs,i.div=Ms,i.exp=vs,i.floor=Es,i.hypot=_s,i.ln=Vs,i.log=Os,i.log10=Fs,i.log2=Ws,i.max=Ds,i.min=qs,i.mod=Us,i.mul=Gs,i.pow=Xs,i.random=Qs,i.round=zs,i.sign=Hs,i.sin=js,i.sinh=Zs,i.sqrt=Ys,i.sub=Js,i.sum=$s,i.tan=ea,i.tanh=ta,i.trunc=na,r===void 0&&(r={}),r&&r.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)r.hasOwnProperty(t=n[e++])||(r[t]=this[t]);return i.config(r),i}function Ms(r,e){return new this(r).div(e)}function vs(r){return new this(r).exp()}function Es(r){return F(r=new this(r),r.e+1,3)}function _s(){var r,e,t=new this(0);for(z=!1,r=0;r<arguments.length;)if(e=new this(arguments[r++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return z=!0,new this(1/0);t=e}return z=!0,t.sqrt()}function gi(r){return r instanceof an||r&&r.toStringTag===Ai||!1}function Vs(r){return new this(r).ln()}function Os(r,e){return new this(r).log(e)}function Ws(r){return new this(r).log(2)}function Fs(r){return new this(r).log(10)}function Ds(){return Si(this,arguments,"lt")}function qs(){return Si(this,arguments,"gt")}function Us(r,e){return new this(r).mod(e)}function Gs(r,e){return new this(r).mul(e)}function Xs(r,e){return new this(r).pow(e)}function Qs(r){var e,t,n,i,o=0,a=new this(1),s=[];if(r===void 0?r=this.precision:Ve(r,1,wt),n=Math.ceil(r/U),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));o<n;)i=e[o],i>=429e7?e[o]=crypto.getRandomValues(new Uint32Array(1))[0]:s[o++]=i%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);o<n;)i=e[o]+(e[o+1]<<8)+(e[o+2]<<16)+((e[o+3]&127)<<24),i>=214e7?crypto.randomBytes(4).copy(e,o):(s.push(i%1e7),o+=4);o=n/4}else throw Error(hi);else for(;o<n;)s[o++]=Math.random()*1e7|0;for(n=s[--o],r%=U,n&&r&&(i=Ae(10,U-r),s[o]=(n/i|0)*i);s[o]===0;o--)s.pop();if(o<0)t=0,s=[0];else{for(t=-1;s[0]===0;t-=U)s.shift();for(n=1,i=s[0];i>=10;i/=10)n++;n<U&&(t-=U-n)}return a.e=t,a.d=s,a}function zs(r){return F(r=new this(r),r.e+1,this.rounding)}function Hs(r){return r=new this(r),r.d?r.d[0]?r.s:0*r.s:r.s||NaN}function js(r){return new this(r).sin()}function Zs(r){return new this(r).sinh()}function Ys(r){return new this(r).sqrt()}function Js(r,e){return new this(r).sub(e)}function $s(){var r=0,e=arguments,t=new this(e[r]);for(z=!1;t.s&&++r<e.length;)t=t.plus(e[r]);return z=!0,F(t,this.precision,this.rounding)}function ea(r){return new this(r).tan()}function ta(r){return new this(r).tanh()}function na(r){return F(r=new this(r),r.e+1,1)}I[Symbol.for("nodejs.util.inspect.custom")]=I.toString;I[Symbol.toStringTag]="Decimal";var an=I.constructor=Ki(dr);Ln=new an(Ln);Nn=new an(Nn);var N=an;import da from"big.js";import Vn from"bn.js";import{get as Li,set as ra}from"lodash";var gr=class{logLevel;name;constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},Ni={},ia={};function oe(r){let e=Li(Ni,r);if(!e){let t=Li(ia,r);e=new gr({name:r,logLevel:t}),ra(Ni,r,e)}return e}import oa from"toformat";var sa=oa,un=sa;import _n from"big.js";import ua from"bn.js";import ca from"decimal.js-light";import cn from"bn.js";var Ci=9007199254740991;function ee(r){let e=oe("Raydium_parseBigNumberish");if(r instanceof cn)return r;if(typeof r=="string"){if(r.match(/^-?[0-9]+$/))return new cn(r);e.logWithError(`invalid BigNumberish string: ${r}`)}return typeof r=="number"?(r%1&&e.logWithError(`BigNumberish number underflow: ${r}`),(r>=Ci||r<=-Ci)&&e.logWithError(`BigNumberish number overflow: ${r}`),new cn(String(r))):typeof r=="bigint"?new cn(r.toString()):(e.error(`invalid BigNumberish value: ${r}`),new cn(0))}var En=oe("module/fraction"),wr=un(_n),ln=un(ca),la={[0]:ln.ROUND_DOWN,[1]:ln.ROUND_HALF_UP,[2]:ln.ROUND_UP},ma={[0]:_n.roundDown,[1]:_n.roundHalfUp,[2]:_n.roundUp},re=class{numerator;denominator;constructor(e,t=new ua(1)){this.numerator=ee(e),this.denominator=ee(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new re(this.denominator,this.numerator)}add(e){let t=e instanceof re?e:new re(ee(e));return this.denominator.eq(t.denominator)?new re(this.numerator.add(t.numerator),this.denominator):new re(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof re?e:new re(ee(e));return this.denominator.eq(t.denominator)?new re(this.numerator.sub(t.numerator),this.denominator):new re(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof re?e:new re(ee(e));return new re(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof re?e:new re(ee(e));return new re(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||En.logWithError(`${e} is not an integer.`),e<=0&&En.logWithError(`${e} is not positive.`),ln.set({precision:e+1,rounding:la[n]});let i=new ln(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return i.toFormat(i.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||En.logWithError(`${e} is not an integer.`),e<0&&En.logWithError(`${e} is negative.`),wr.DP=e,wr.RM=ma[n]||1,new wr(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var pa=oe("Raydium_amount"),Ri=un(da);function fa(r,e){let t="0",n="0";if(r.includes(".")){let i=r.split(".");i.length===2?([t,n]=i,n=n.padEnd(e,"0")):pa.logWithError(`invalid number string, num: ${r}`)}else t=r;return[t,n.slice(0,e)||n]}var ye=class extends re{token;logger;constructor(e,t,n=!0,i){let o=new Vn(0),a=kr.pow(new Vn(e.decimals));if(n)o=ee(t);else{let s=new Vn(0),c=new Vn(0);if(typeof t=="string"||typeof t=="number"||typeof t=="bigint"){let[u,l]=fa(t.toString(),e.decimals);s=ee(u),c=ee(l)}s=s.mul(a),o=s.add(c)}super(o,a),this.logger=oe(i||"TokenAmount"),this.token=e}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(e){return this.token.equals(e.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(e.raw)}lt(e){return this.token.equals(e.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(e.raw)}add(e){return this.token.equals(e.token)||this.logger.logWithError("add token not equals"),new ye(this.token,this.raw.add(e.raw))}subtract(e){return this.token.equals(e.token)||this.logger.logWithError("sub token not equals"),new ye(this.token,this.raw.sub(e.raw))}toSignificant(e=this.token.decimals,t,n=0){return super.toSignificant(e,t,n)}toFixed(e=this.token.decimals,t,n=0){return e>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(e,t,n)}toExact(e={groupSeparator:""}){return Ri.DP=this.token.decimals,new Ri(this.numerator.toString()).div(this.denominator.toString()).toFormat(e)}};import{PublicKey as ba}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Mi}from"@solana/spl-token";var hr={chainId:101,address:ba.default.toBase58(),programId:Mi.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},at={chainId:101,address:"So11111111111111111111111111111111111111112",programId:Mi.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};import{PublicKey as xr}from"@solana/web3.js";import{PublicKey as me,SystemProgram as vi,SYSVAR_RENT_PUBKEY as ya}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as ga}from"@solana/spl-token";function B({pubkey:r,isSigner:e=!1,isWritable:t=!0}){return{pubkey:r,isWritable:t,isSigner:e}}var wa=[B({pubkey:ga,isWritable:!1}),B({pubkey:vi.programId,isWritable:!1}),B({pubkey:ya,isWritable:!1})];function Ar({publicKey:r,transformSol:e}){let t=Pr(r.toString());if(t instanceof me)return e&&t.equals(Qt)?Xt:t;if(e&&t.toString()===Qt.toBase58())return Xt;if(typeof t=="string"){if(t===me.default.toBase58())return me.default;try{return new me(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function Pr(r){try{return new me(r)}catch{return r}}var On=new me("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),Tr=new me("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),je=new me("SysvarRent111111111111111111111111111111111"),el=new me("SysvarC1ock11111111111111111111111111111111"),St=new me("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),ka=new me("Sysvar1nstructions1111111111111111111111111"),tl=vi.programId,nl=new me("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),rl=new me("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),il=new me("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),ol=new me("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),sl=new me("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),al=new me("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),ul=new me("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),cl=new me("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),ll=new me("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),ml=new me("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),dl=new me("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),Xt=new me("So11111111111111111111111111111111111111112"),Qt=me.default;function zt(r){return Ar({publicKey:r,transformSol:!0})}var Sr=class{symbol;name;decimals;isToken2022;mint;constructor({mint:e,decimals:t,symbol:n,name:i,skipMint:o=!1,isToken2022:a=!1}){if(e===Qt.toBase58()||e instanceof xr&&Qt.equals(e)){this.decimals=at.decimals,this.symbol=at.symbol,this.name=at.name,this.mint=new xr(at.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=i||e.toString().substring(0,6),this.mint=o?xr.default:Ar({publicKey:e}),this.isToken2022=a}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Re=Sr;In(Re,"WSOL",new Sr({...at,mint:at.address}));var Br=class{symbol;name;decimals;constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},Wn=Br;In(Wn,"SOL",new Br(hr));import ha from"bn.js";var Ei=new re(new ha(100)),qe=class extends re{toSignificant(e=5,t,n){return this.mul(Ei).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(Ei).toFixed(e,t,n)}};var Aa=oe("Raydium_price"),Ue=class extends re{baseToken;quoteToken;scalar;constructor(e){let{baseToken:t,quoteToken:n,numerator:i,denominator:o}=e;super(i,o),this.baseToken=t,this.quoteToken=n,this.scalar=new re(Ir(t.decimals),Ir(n.decimals))}get raw(){return new re(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new Ue({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(e){this.quoteToken!==e.baseToken&&Aa.logWithError("mul token not equals");let t=super.mul(e);return new Ue({baseToken:this.baseToken,quoteToken:e.quoteToken,denominator:t.denominator,numerator:t.numerator})}toSignificant(e=this.quoteToken.decimals,t,n){return this.adjusted.toSignificant(e,t,n)}toFixed(e=this.quoteToken.decimals,t,n){return this.adjusted.toFixed(e,t,n)}};import{PublicKey as Pa}from"@solana/web3.js";import Ta from"bn.js";function _i(r){return typeof r=="object"&&r!==null&&![Re,ye,Pa,re,Ta,Ue,qe].some(e=>typeof e=="object"&&r instanceof e)}function Bt(r){return typeof r=="string"?Pr(r):Array.isArray(r)?r.map(e=>Bt(e)):_i(r)?Object.fromEntries(Object.entries(r).map(([e,t])=>[e,Bt(t)])):r}var kt=new ut(0),Vi=new ut(1),am=new ut(2),um=new ut(3),cm=new ut(5),kr=new ut(10),lm=new ut(100),mm=new ut(1e3),dm=new ut(1e4);function Ir(r){return kr.pow(ee(r))}function Fn(r,e){let t=r.divmod(e);return t.mod.isZero()?t.div:t.div.isNeg()?t.div.isubn(1):t.div.iaddn(1)}function Kr(r,e=1,t=[]){let n=[...r];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}import{PublicKey as Na}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Ca}from"@solana/spl-token";import{ComputeBudgetProgram as Oi,Keypair as Fi,PublicKey as xa,Transaction as Di,TransactionMessage as Sa,VersionedTransaction as qi}from"@solana/web3.js";var Q={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",ClmmLockPosition:"ClmmLockPosition",ClmmHarvestLockPosition:"ClmmHarvestLockPosition",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV4Withdraw:"FarmV4Withdraw",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut",CpmmLockLp:"CpmmLockLp",CpmmCollectLockFee:"CpmmCollectLockFee",TransferTip:"TransferTip",NonceAccount:"NonceAccount"};import{TOKEN_PROGRAM_ID as Ba}from"@solana/spl-token";var Wi=oe("Raydium_txUtil"),Ui=1644;function Dn(r){let e=[],t=[];return r.microLamports&&(e.push(Oi.setComputeUnitPrice({microLamports:r.microLamports})),t.push(Q.SetComputeUnitPrice)),r.units&&(e.push(Oi.setComputeUnitLimit({units:r.units})),t.push(Q.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function Ht(r,e){let t=e??"confirmed";return(await r.getLatestBlockhash?.({commitment:t}))?.blockhash}async function qn(r,e){return r.getSignatureStatuses([e]),new Promise((t,n)=>{let i=setTimeout(n,6e4);r.onSignature(e,o=>{if(clearTimeout(i),!o.err){t("");return}n(Object.assign(o.err,{txId:e}))},"confirmed")})}function Ia(r,e){r.length<1&&Wi.logWithError(`no instructions provided: ${r.toString()}`),e.length<1&&Wi.logWithError(`no signers provided:, ${e.toString()}`);let t=new Di;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...r);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<Ui}catch{return!1}}function pe(r,e){let[t,n]=xa.findProgramAddressSync(r,e);return{publicKey:t,nonce:n}}function mn({instructions:r,payer:e,signers:t}){return Ia(r,[e,...t])}function dn({instructions:r,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=Fi.generate().publicKey.toString()}){let o=new Sa({payerKey:e,recentBlockhash:n,instructions:r}).compileToV0Message(Object.values(t??{}));try{return Buffer.from(new qi(o).serialize()).toString("base64").length<Ui}catch{return!1}}var Ka=r=>Buffer.isBuffer(r)?r:r instanceof Uint8Array?Buffer.from(r.buffer,r.byteOffset,r.byteLength):Buffer.from(r),La=r=>{let e=r.serialize({requireAllSignatures:!1,verifySignatures:!1});r instanceof qi&&(e=Ka(e));try{return e instanceof Buffer?e.toString("base64"):Buffer.from(e).toString("base64")}catch{return e.toString("base64")}};function It(r){let e=[];return r.forEach(t=>{t instanceof Di&&(t.recentBlockhash||(t.recentBlockhash=Ba.toBase58()),t.feePayer||(t.feePayer=Fi.generate().publicKey)),e.push(La(t))}),console.log("simulate tx string:",e),e}function ue(r,e,t){return pe([r.toBuffer(),(t??Ca).toBuffer(),e.toBuffer()],new Na("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import{PublicKey as H}from"@solana/web3.js";var Gi=new H("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),Xi=new H("CBuCnLe26faBpcBP2fktp4rp8abpcAnTWft6ZrP5Q4T"),Qi=new H("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),zi=new H("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),Mm=new H("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),Hi=new H("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),vm=new H("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),ji=new H("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),Em=new H("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),_m=new H("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Vm=new H("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),Om=new H("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Wm=new H("kN1kEznaF5Xbd8LYuqtEFcxzWSBk5Fv6ygX6SqEGJVy"),Fm=new H("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),Zi=new H("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),Dm=new H("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),qm=new H("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),Um=new H("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),Gm=new H("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),Xm=new H("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),Qm=new H("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),zm=new H("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),Ra=new H("CPMDWBwJDtYax9qW7AyRuVC19Cc4L4Vcy4n2BHAbHkCW"),Ma=new H("7rQ1QFNosMkUCuh7Z7fPbTHvh73b68sQYdirycEzJVuw"),va=new H("G11FKBRaAkHAKuLCgLM6K6NUc9rTjPAznRCjZifrTQe2"),Hm=new H("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Ea=new H("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),jm=new H("3f7GcQFG397GAaEnv51zR6tsTVihYRydnydDD1cXekxH"),_a=new H("7AFUeLVRjBfzqK3tTGw8hN48KLQWSk6DTE8xprWdPqix"),Zm=new H("LanMV9sAd7wArD4vJFi2qDdfnVhFxYSUg6eADduJ3uj"),Ym=new H("WLHv2UAZm6z4KyaaELi5pjdbJh6RESMva1Rnn8pJVVh"),Va=new H("LanD8FpTBBvzZFXjTxsAoipkFsxPUCDB4qAqKxYDiNP"),Oa=new H("HYNHiyKJ3gGVFvyxJAurK7qr7P2o5J9THmvCGMdULtpW");var Jm={SERUM_MARKET:H.default,OPENBOOK_MARKET:new H("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),UTIL1216:H.default,FarmV3:new H("85BFyr98MbCUU9MVTEgzx1nbhWACbJqLzho6zd6DZcWL"),FarmV5:new H("EcLzTrNg9V7qhcdyXDe2qjtPkiGzDM2UbdRaeaadU5r2"),FarmV6:new H("Farm2hJLcqPtPg8M4rR6DMrsRNc5TPm5Cs4bVQrMe2T7"),AmmV4:new H("HWy1jotHpo6UqeQxx49dpYYdQB8wj9Qk9MdxwjLvDHB8"),AmmStable:new H("DDg4VmQaJV9ogWce7LpcjBA9bv22wRp5uaTPa5pGjijF"),CLMM:new H("devi51mZmdwUJGU9hjN27vEz64Gps7uUefqxg27EAtH"),CLMM_LOCK_PROGRAM_ID:new H("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),CLMM_LOCK_AUTH_ID:new H("8qmHNvu2Kr2C7U8mJL4Vz1vTDxMhVuXKREwU7TNoaVEo"),Router:new H("BVChZ3XFEwTMUk1o9i3HAf91H6mFxSwa5X2wFAWhYPhU"),CREATE_CPMM_POOL_PROGRAM:Ra,CREATE_CPMM_POOL_AUTH:Ma,CREATE_CPMM_POOL_FEE_ACC:va,FEE_DESTINATION_ID:new H("3XMrhbv989VxAMi3DErLV9eJht1pHppW5LbKxe9fkEFR"),LOCK_CPMM_PROGRAM:Ea,LCOK_CPMM_AUTH:_a,LAUNCHPAD_PROGRAM:Va,LAUNCHPAD_AUTH:Oa};import Ze from"bn.js";var pn=1e4;function ge(r,e,t,n){if(e===void 0)return{amount:r,fee:void 0,expirationTime:void 0};let i={...e,olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}},o=t.epoch<i.newerTransferFee.epoch?i.olderTransferFee:i.newerTransferFee,a=new Ze(o.maximumFee.toString()),s=t.epoch<i.newerTransferFee.epoch?(Number(i.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(o.transferFeeBasisPoints===pn){let c=new Ze(o.maximumFee.toString());return{amount:r.add(c),fee:c,expirationTime:s}}else{let c=fn(r.mul(new Ze(pn)),new Ze(pn-o.transferFeeBasisPoints)),u=new Ze(o.maximumFee.toString()),l=c.sub(r).gt(u)?r.add(u):c,m=fn(l.mul(new Ze(o.transferFeeBasisPoints)),new Ze(pn)),d=m.gt(a)?a:m;return{amount:l,fee:d,expirationTime:s}}else{let c=fn(r.mul(new Ze(o.transferFeeBasisPoints)),new Ze(pn)),u=c.gt(a)?a:c;return{amount:r,fee:u,expirationTime:s}}}function ht(r,e){return r===void 0?e:e===void 0?r:Math.min(r,e)}function fn(r,e){let{div:t,mod:n}=r.divmod(e);return n.gt(new Ze(0))?t.add(new Ze(1)):t}import{PublicKey as Yi,AddressLookupTableAccount as Un}from"@solana/web3.js";async function Lr({connection:r,address:e}){let t=await ct(r,[...new Set(e.map(i=>i.toString()))].map(i=>new Yi(i))),n={};for(let i=0;i<e.length;i++){let o=t[i],a=e[i];if(!o)continue;let s=new Un({key:a,state:Un.deserialize(o.data)});n[a.toString()]=s,Gn[a.toString()]=s}return n}var Gn={AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU:new Un({key:new Yi("AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU"),state:Un.deserialize(Buffer.from("AQAAAP//////////I1rcEwAAAAAvAQYwun9CU6c5Ikm2pAj+D9IEnCOR45nK+SFTGSdpd6J6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAbd9uHXZaGT2cvhRs7reawctIXtX1s3kTqM9YV+/wCpBt324e51j94YQl285GzN2rYa/E2DuQ0n/r35KNihi/wFSlNQ+F3IgtYUpVZyeIopbd8eq6vQpgZ4iEky9O72oAVKU1qZKSEGTSTocWDaOHx8NbXdvJK7geQfqEBBBUSNBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvBkX2T9y7AHdNGviJAqQNtlDUDCnauQRWybsLji6nPM8Qkw5asQRvCdB3MbX6IEBwytOrpM32l4jQygKG9TKgR0vZScQ2AsM/IHeQ7RajUkyhuZdc8SGiqQz/7H34torNR/Wir3sl0ruUrVxJWEZfUg+QLNAxxODdBi53/OP7Ioil1cqeBM9dtZC3FLov4yyxWRM/wcGStyJX/QfTnLBAHqkqWotPKVlShCVQqpP9W5W1rOao65IMk5QuQ2kMIOxzDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu/YsA/yfEEFGcr8Z57VKDw8uQzpiru7g4lvjnfapW62W030syevD8k07SGoxUHiuT/ai7gAHWWhDsVmg/C63ajgpkH7Sn3GdutArDTfyqOkdqv4/IPC/EFFy7mGkfDd2C57N5a/4jC+BbmJy7wQaSEZr0CQU88lPtUxIVvzGjC95b8Ooss2TqmkrayGKofkPMGQn7Ux+9lfwBSNfxwH8NgbpqC/7LNlV4I7nCvsXf3p+ohQk9NrAJb2KAFpUqEIJ9ZBV7BYDzHF/ORKYlgtvPnXjudZQ6CEo5OzUDaNIomTCCsvhD16TxJjsbgne1kGnQPCFSoaxUbq2V1bPMFQ3VYP6wDZ9bKStCFKx9A3tNbwZFC5ZGAN83MFK7XoTy+OmmcFEr6rLOjfSuTfPvHJkSVxW6Qllwkl67XcBi5v00u2gQsbu+38sp+rd5pA/LvyWj4P94ZGZwc1tE2P88xekCLcAwZGb+UhFzL/7K26csOb57yM5bvF9xJrLEObOkAAAAAn+HWRkdcPKyFFMnVwEoD7vnD0jCKFIU1sImubYCxNTSVzsKpaQX+fzNxrLAI3L14JQnJx/D6Uk2LADIHGqnGELzjEbkBDAlaM77NkXMPfqXNLSveCkWI7UEgNs31WEWB6XHSYI/v5DklHOb4QTtDOR804PVbi3fjloZeLR2F8d4FuZmMMO7ck3Fnkn2zEMG5gOmqsygb6PjTitArVl52NhcSznTxVnguaIJxiZkAnurDmn3MWR0PC2GLghp2KJqHCc6QQ85odeIjFHKOlRlJyeSXVJmL8vb1UgOzsbJPVP8p6zM4M3C1Sd7uWIHP33G42AP2Zg8ucn/n6meQjjD266JgCWdxZD6PXs9CsnIeL7SSG0/6lGb9xfP0ZcWkCXB/3hjxHYVXjra/GPOeXGk0fLLKjCbk+mgs2w6d2oCwimBipTzuoZ30GiI8ij8VRzD5CzMWtu2m21eDBIfjGAEo4pQeNNonKcqzV/cleX8ySZLOHsz8PtBCrLqF+VkLm9hOzIT+6i/nIf6keR4GWKMOD4AvqfpjHoD4DuhBpz8P28+DxkGrDXXr/nr20x291VPvcTU/b+b+o2kC9G0kcXeTlLjU6a2TQXWlZ4gBUdBl1jgT7mObSTpLblNiXZsLkbmVXZwvFKXua5cUKlWed/w30skmEUraTuQqtqr5fHZPW9n57EmeTif6LjHL2YJFZkQU+TrJmFzqzmF4/b8OwrPQAprl8mX3q4LUIdAS/a+11B6DWD1Xk2++Sn94dLC4xjkO4Wtlw8c4XuzciVbepHOmnoWzVu/0y3KCrLCSfQxQ3br8DJCoVzhgtPsS2nZZjsBGIZgnU0QpMv+2MnRsnKwdp1VsrCX84j/qvaZn4WhKunippgTbN2EUs0tPTP55Qfgj+nKmjtWW5IYs72FrEwJKYoNfsmqaF4o5pf4v9zgPwVwY/5I4XJKUL2L25m9kAQcW/K+H1RTFEUoj8Z4ajpOmAB/dG0COmCphVMW2CCMvnxhcGiSgPnpDuWu6qiJ7NG7ye5kvHgefgqPLeicspNJ5EpL3XiRNLM2tmJLI1awAwOyd6iHv0dCkMYRKaa6rcaZeYwmKCkckm0kM2JNmnmmAaBQQ7mwmIM0IMxX4f5W6j9PqZWcJxF7r17T/lQBAmcjoupRiJifbnXCNUv9GhpRF19WcBdeKbivRJVlGop6I2RS6lGImJ9udcI1S/0aGlEXX1ZwF14puK9ElWUainojZFYVHLHD6dIP2ESjqBzg3ol1/wB7+/ylGwd9LS7wSZ2A630CJSVKwH47K9P4bB8PEQP8BwjMFa7xQHOqZFP1XqaQ==","base64"))})};import{PublicKey as jt,sendAndConfirmTransaction as Nr,SystemProgram as Wa,Transaction as bn,TransactionMessage as yn,VersionedTransaction as gn}from"@solana/web3.js";import Fa from"axios";var Xn=2e3,Qn=class{connection;owner;instructions=[];endInstructions=[];lookupTableAddress=[];signers=[];instructionTypes=[];endInstructionTypes=[];feePayer;cluster;signAllTransactions;blockhashCommitment;loopMultiTxStatus;constructor(e){this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster,this.blockhashCommitment=e.blockhashCommitment,this.loopMultiTxStatus=!!e.loopMultiTxStatus}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){let e=(await Fa.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=e?.[15]??{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=Dn(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}addTipInstruction(e){return e?(this.endInstructions.push(Wa.transfer({fromPubkey:e.feePayer??this.feePayer,toPubkey:new jt(e.address),lamports:BigInt(e.amount.toString())})),this.endInstructionTypes.push(Q.TransferTip),!0):!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:i=[],endInstructionTypes:o=[],lookupTableAddress:a=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...i),this.endInstructionTypes.push(...o),this.lookupTableAddress.push(...a.filter(s=>s!==jt.default.toString())),this}async versionBuild({txVersion:e,extInfo:t},n){return e===0?await this.buildV0({...t||{}},n):this.build(t,n)}build(e,t){let n=new bn;return this.allInstructions.length&&n.add(...this.allInstructions),n.feePayer=this.feePayer,this.owner?.signer&&!this.signers.some(i=>i.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer),{builder:this,transaction:n,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async i=>{let{recentBlockHash:o,skipPreflight:a=!0,sendAndConfirm:s,notSendToRpc:c}=i||{},u=o??t??await Ht(this.connection,this.blockhashCommitment);if(n.recentBlockhash=u,this.signers.length&&n.sign(...this.signers),It([n]),this.owner?.isKeyPair)return{txId:s?await Nr(this.connection,n,this.signers.find(m=>m.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:a}):await this.connection.sendRawTransaction(n.serialize(),{skipPreflight:a}),signedTx:n};if(this.signAllTransactions){let l=await this.signAllTransactions([n]);if(this.signers.length)for(let m of l)try{m.sign(...this.signers)}catch{}return{txId:c?"":await this.connection.sendRawTransaction(l[0].serialize(),{skipPreflight:a}),signedTx:l[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:i}=this.build(n),o=t.filter(u=>u.transaction.instructions.length>0),a=[i,...o.map(u=>u.transaction)],s=[this.signers,...o.map(u=>u.signers)],c=[...this.instructionTypes,...o.map(u=>u.instructionTypes).flat()];return this.owner?.signer&&s.forEach(u=>{u.some(l=>l.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),{builder:this,transactions:a,signers:s,instructionTypes:c,execute:async u=>{let{sequentially:l,onTxUpdate:m,skipTxCount:d=0,recentBlockHash:p,skipPreflight:f=!0}=u||{},y=p??await Ht(this.connection,this.blockhashCommitment);if(this.owner?.isKeyPair){if(l){let g=[],w=0;for(let h of a){if(++w,w<=d)continue;let k=await Nr(this.connection,h,this.signers.find(P=>P.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:f});g.push(k)}return{txIds:g,signedTxs:a}}return{txIds:await await Promise.all(a.map(async g=>(g.recentBlockhash=y,await this.connection.sendRawTransaction(g.serialize(),{skipPreflight:f})))),signedTxs:a}}if(this.signAllTransactions){let g=a.map((h,k)=>(h.recentBlockhash=y,s[k].length&&h.sign(...s[k]),h));It(g);let w=await this.signAllTransactions(g);if(l){let h=0,k=[],P=async()=>{if(!w[h])return;let T=await this.connection.sendRawTransaction(w[h].serialize(),{skipPreflight:f});k.push({txId:T,status:"sent",signedTx:w[h]}),m?.([...k]),h++;let A=!1,S=null,L=null,x=R=>{S!==null&&clearInterval(S),L!==null&&this.connection.removeSignatureListener(L);let v=k.findIndex(W=>W.txId===T);if(v>-1){if(k[v].status==="error"||k[v].status==="success")return;k[v].status=R.err?"error":"success"}m?.([...k]),R.err||P()};this.loopMultiTxStatus&&(S=setInterval(async()=>{if(A){clearInterval(S);return}try{let R=await this.connection.getTransaction(T,{commitment:"confirmed",maxSupportedTransactionVersion:0});R&&(A=!0,clearInterval(S),x({err:R.meta?.err||null}),console.log("tx status from getTransaction:",T))}catch(R){A=!0,clearInterval(S),console.error("getTransaction timeout:",R,T)}},Xn)),L=this.connection.onSignature(T,R=>{if(A){this.connection.removeSignatureListener(L);return}A=!0,x(R)},"confirmed"),this.connection.getSignatureStatus(T)};return await P(),{txIds:k.map(T=>T.txId),signedTxs:w}}else{let h=[];for(let k=0;k<w.length;k+=1){let P=await this.connection.sendRawTransaction(w[k].serialize(),{skipPreflight:f});h.push(P)}return{txIds:h,signedTxs:w}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e,t){let{lookupTableCache:n={},lookupTableAddress:i=[],forerunCreate:o,recentBlockhash:a,...s}=e||{},c={...this.cluster==="devnet"?{}:Gn,...n},u=Array.from(new Set([...i,...this.lookupTableAddress])),l=[];for(let f of u)c[f]===void 0&&l.push(new jt(f));if(l.length>0){let f=await Lr({connection:this.connection,address:l});for(let[y,g]of Object.entries(f))c[y]=g}let m=t??(o?jt.default.toBase58():a??await Ht(this.connection,this.blockhashCommitment)),d=new yn({payerKey:this.feePayer,recentBlockhash:m,instructions:[...this.allInstructions]}).compileToV0Message(Object.values(c));this.owner?.signer&&!this.signers.some(f=>f.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer);let p=new gn(d);return p.sign(this.signers),{builder:this,transaction:p,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async f=>{let{skipPreflight:y=!0,sendAndConfirm:g,notSendToRpc:w}=f||{};if(It([p]),this.owner?.isKeyPair){let h=await this.connection.sendTransaction(p,{skipPreflight:y});return g&&await qn(this.connection,h),{txId:h,signedTx:p}}if(this.signAllTransactions){let h=await this.signAllTransactions([p]);if(this.signers.length)for(let k of h)try{k.sign(this.signers)}catch{}return{txId:w?"":await this.connection.sendTransaction(h[0],{skipPreflight:y}),signedTx:h[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}async buildV0MultiTx(e){let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:i}=await this.buildV0(n),o=t.filter(u=>u.builder.instructions.length>0),a=[i,...o.map(u=>u.transaction)],s=[this.signers,...o.map(u=>u.signers)],c=[...this.instructionTypes,...o.map(u=>u.instructionTypes).flat()];return this.owner?.signer&&s.forEach(u=>{u.some(l=>l.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),a.forEach(async(u,l)=>{u.sign(s[l])}),{builder:this,transactions:a,signers:s,instructionTypes:c,buildProps:n,execute:async u=>{let{sequentially:l,onTxUpdate:m,recentBlockHash:d,skipPreflight:p=!0}=u||{};if(d&&a.forEach(f=>f.message.recentBlockhash=d),It(a),this.owner?.isKeyPair){if(l){let f=[];for(let y of a){let g=await this.connection.sendTransaction(y,{skipPreflight:p});await qn(this.connection,g),f.push(g)}return{txIds:f,signedTxs:a}}return{txIds:await Promise.all(a.map(async f=>await this.connection.sendTransaction(f,{skipPreflight:p}))),signedTxs:a}}if(this.signAllTransactions){let f=await this.signAllTransactions(a);if(l){let y=0,g=[],w=async()=>{if(!f[y])return;let h=await this.connection.sendTransaction(f[y],{skipPreflight:p});g.push({txId:h,status:"sent",signedTx:f[y]}),m?.([...g]),y++;let k=!1,P=null,T=null,A=S=>{P!==null&&clearInterval(P),T!==null&&this.connection.removeSignatureListener(T);let L=g.findIndex(x=>x.txId===h);if(L>-1){if(g[L].status==="error"||g[L].status==="success")return;g[L].status=S.err?"error":"success"}m?.([...g]),S.err||w()};this.loopMultiTxStatus&&(P=setInterval(async()=>{if(k){clearInterval(P);return}try{let S=await this.connection.getTransaction(h,{commitment:"confirmed",maxSupportedTransactionVersion:0});S&&(k=!0,clearInterval(P),A({err:S.meta?.err||null}),console.log("tx status from getTransaction:",h))}catch(S){k=!0,clearInterval(P),console.error("getTransaction timeout:",S,h)}},Xn)),T=this.connection.onSignature(h,S=>{if(k){this.connection.removeSignatureListener(T);return}k=!0,A(S)},"confirmed"),this.connection.getSignatureStatus(h)};return w(),{txIds:[],signedTxs:f}}else{let y=[];for(let g=0;g<f.length;g+=1){let w=await this.connection.sendTransaction(f[g],{skipPreflight:p});y.push(w)}return{txIds:y,signedTxs:f}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){let{splitIns:t=[],computeBudgetConfig:n,...i}=e||{},o=n?Dn(n):{instructions:[],instructionTypes:[]},a=this.signers.reduce((m,d)=>({...m,[d.publicKey.toBase58()]:d}),{}),s=[],c=[],u=[],l=0;if(this.allInstructions.forEach(m=>{let d=[...u,m],p=n?[...o.instructions,...d]:d,y=[...new Set(d.map(g=>g.keys.filter(w=>w.isSigner).map(w=>w.pubkey.toString())).flat()).values()].map(g=>new jt(g));if(m!==t[l]&&u.length<12&&(mn({instructions:p,payer:this.feePayer,signers:y})||mn({instructions:d,payer:this.feePayer,signers:y})))u.push(m);else{if(u.length===0)throw Error("item ins too big");l+=m===t[l]?1:0,mn({instructions:n?[...o.instructions,...u]:[...u],payer:this.feePayer,signers:y})?s.push(new bn().add(...o.instructions,...u)):s.push(new bn().add(...u)),c.push(Array.from(new Set(u.map(g=>g.keys.filter(w=>w.isSigner).map(w=>w.pubkey.toString())).flat())).map(g=>a[g]).filter(g=>g!==void 0)),u=[m]}}),u.length>0){let d=[...new Set(u.map(p=>p.keys.filter(f=>f.isSigner).map(f=>f.pubkey.toString())).flat()).values()].map(p=>a[p]).filter(p=>p!==void 0);mn({instructions:n?[...o.instructions,...u]:[...u],payer:this.feePayer,signers:d.map(p=>p.publicKey)})?s.push(new bn().add(...o.instructions,...u)):s.push(new bn().add(...u)),c.push(d)}return s.forEach(m=>m.feePayer=this.feePayer),this.owner?.signer&&c.forEach(m=>{m.some(d=>d.publicKey.equals(this.owner.publicKey))||m.push(this.owner.signer)}),{builder:this,transactions:s,signers:c,instructionTypes:this.instructionTypes,execute:async m=>{let{sequentially:d,onTxUpdate:p,skipTxCount:f=0,recentBlockHash:y,skipPreflight:g=!0}=m||{},w=y??await Ht(this.connection,this.blockhashCommitment);if(s.forEach(async(h,k)=>{h.recentBlockhash=w,c[k].length&&h.sign(...c[k])}),It(s),this.owner?.isKeyPair){if(d){let h=0,k=[];for(let P of s){if(++h,h<=f){k.push("tx skipped");continue}let T=await Nr(this.connection,P,this.signers.find(A=>A.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:g});k.push(T)}return{txIds:k,signedTxs:s}}return{txIds:await Promise.all(s.map(async h=>await this.connection.sendRawTransaction(h.serialize(),{skipPreflight:g}))),signedTxs:s}}if(this.signAllTransactions){let h=await this.signAllTransactions(s.slice(f,s.length)),k=[...s.slice(0,f),...h];if(d){let P=0,T=[],A=async()=>{if(!k[P])return;P<f&&(T.push({txId:"",status:"success",signedTx:k[P]}),p?.([...T]),P++,A());let S=await this.connection.sendRawTransaction(k[P].serialize(),{skipPreflight:g});T.push({txId:S,status:"sent",signedTx:k[P]}),p?.([...T]),P++;let L=!1,x=null,R=null,v=W=>{x!==null&&clearInterval(x),R!==null&&this.connection.removeSignatureListener(R);let X=T.findIndex($=>$.txId===S);if(X>-1){if(T[X].status==="error"||T[X].status==="success")return;T[X].status=W.err?"error":"success"}p?.([...T]),W.err||A()};this.loopMultiTxStatus&&(x=setInterval(async()=>{if(L){clearInterval(x);return}try{let W=await this.connection.getTransaction(S,{commitment:"confirmed",maxSupportedTransactionVersion:0});W&&(L=!0,clearInterval(x),v({err:W.meta?.err||null}),console.log("tx status from getTransaction:",S))}catch(W){L=!0,clearInterval(x),console.error("getTransaction timeout:",W,S)}},Xn)),R=this.connection.onSignature(S,W=>{if(L){this.connection.removeSignatureListener(R);return}L=!0,v(W)},"confirmed"),this.connection.getSignatureStatus(S)};return await A(),{txIds:T.map(S=>S.txId),signedTxs:k}}else{let P=[];for(let T=0;T<k.length;T+=1){let A=await this.connection.sendRawTransaction(k[T].serialize(),{skipPreflight:g});P.push(A)}return{txIds:P,signedTxs:k}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:i||{}}}async sizeCheckBuildV0(e){let{computeBudgetConfig:t,splitIns:n=[],lookupTableCache:i={},lookupTableAddress:o=[],...a}=e||{},s={...this.cluster==="devnet"?{}:Gn,...i},c=Array.from(new Set([...this.lookupTableAddress,...o])),u=[];for(let h of c)s[h]===void 0&&u.push(new jt(h));let l=await Lr({connection:this.connection,address:u});for(let[h,k]of Object.entries(l))s[h]=k;let m=t?Dn(t):{instructions:[],instructionTypes:[]},d=await Ht(this.connection,this.blockhashCommitment),p=this.signers.reduce((h,k)=>({...h,[k.publicKey.toBase58()]:k}),{}),f=[],y=[],g=[],w=0;if(this.allInstructions.forEach(h=>{let k=[...g,h],P=t?[...m.instructions,...k]:k;if(h!==n[w]&&g.length<12&&(dn({instructions:P,payer:this.feePayer,lookupTableAddressAccount:s})||dn({instructions:k,payer:this.feePayer,lookupTableAddressAccount:s})))g.push(h);else{if(g.length===0)throw Error("item ins too big");w+=h===n[w]?1:0;let T={};for(let A of[...new Set(c)])s[A]!==void 0&&(T[A]=s[A]);if(t&&dn({instructions:[...m.instructions,...g],payer:this.feePayer,lookupTableAddressAccount:s,recentBlockhash:d})){let A=new yn({payerKey:this.feePayer,recentBlockhash:d,instructions:[...m.instructions,...g]}).compileToV0Message(Object.values(s));f.push(new gn(A))}else{let A=new yn({payerKey:this.feePayer,recentBlockhash:d,instructions:[...g]}).compileToV0Message(Object.values(s));f.push(new gn(A))}y.push(Array.from(new Set(g.map(A=>A.keys.filter(S=>S.isSigner).map(S=>S.pubkey.toString())).flat())).map(A=>p[A]).filter(A=>A!==void 0)),g=[h]}}),g.length>0){let k=[...new Set(g.map(P=>P.keys.filter(T=>T.isSigner).map(T=>T.pubkey.toString())).flat()).values()].map(P=>p[P]).filter(P=>P!==void 0);if(t&&dn({instructions:[...m.instructions,...g],payer:this.feePayer,lookupTableAddressAccount:s,recentBlockhash:d})){let P=new yn({payerKey:this.feePayer,recentBlockhash:d,instructions:[...m.instructions,...g]}).compileToV0Message(Object.values(s));f.push(new gn(P))}else{let P=new yn({payerKey:this.feePayer,recentBlockhash:d,instructions:[...g]}).compileToV0Message(Object.values(s));f.push(new gn(P))}y.push(k)}return this.owner?.signer&&y.forEach(h=>{h.some(k=>k.publicKey.equals(this.owner.publicKey))||h.push(this.owner.signer)}),f.forEach((h,k)=>{h.sign(y[k])}),{builder:this,transactions:f,buildProps:e,signers:y,instructionTypes:this.instructionTypes,execute:async h=>{let{sequentially:k,onTxUpdate:P,skipTxCount:T=0,recentBlockHash:A,skipPreflight:S=!0}=h||{};if(f.map(async(L,x)=>{y[x].length&&L.sign(y[x]),A&&(L.message.recentBlockhash=A)}),It(f),this.owner?.isKeyPair){if(k){let L=0,x=[];for(let R of f){if(++L,L<=T){console.log("skip tx: ",L),x.push("tx skipped");continue}let v=await this.connection.sendTransaction(R,{skipPreflight:S});await qn(this.connection,v),x.push(v)}return{txIds:x,signedTxs:f}}return{txIds:await Promise.all(f.map(async L=>await this.connection.sendTransaction(L,{skipPreflight:S}))),signedTxs:f}}if(this.signAllTransactions){let L=await this.signAllTransactions(f.slice(T,f.length)),x=[...f.slice(0,T),...L];if(k){let R=0,v=[],W=async()=>{if(!x[R])return;if(R<T){v.push({txId:"",status:"success",signedTx:x[R]}),P?.([...v]),R++,W();return}let X=await this.connection.sendTransaction(x[R],{skipPreflight:S});v.push({txId:X,status:"sent",signedTx:x[R]}),P?.([...v]),R++;let $=!1,J=null,G=null,Ke=Le=>{J!==null&&clearInterval(J),G!==null&&this.connection.removeSignatureListener(G);let Xe=v.findIndex(it=>it.txId===X);if(Xe>-1){if(v[Xe].status==="error"||v[Xe].status==="success")return;v[Xe].status=Le.err?"error":"success"}P?.([...v]),Le.err||W()};this.loopMultiTxStatus&&(J=setInterval(async()=>{if($){clearInterval(J);return}try{let Le=await this.connection.getTransaction(X,{commitment:"confirmed",maxSupportedTransactionVersion:0});Le&&($=!0,clearInterval(J),Ke({err:Le.meta?.err||null}),console.log("tx status from getTransaction:",X))}catch(Le){$=!0,clearInterval(J),console.error("getTransaction timeout:",Le,X)}},Xn)),G=this.connection.onSignature(X,Le=>{if($){this.connection.removeSignatureListener(G);return}$=!0,Ke(Le)},"confirmed"),this.connection.getSignatureStatus(X)};return W(),{txIds:[],signedTxs:x}}else{let R=[];for(let v=0;v<x.length;v+=1){let W=await this.connection.sendTransaction(x[v],{skipPreflight:S});R.push(W)}return{txIds:R,signedTxs:x}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:a||{}}}};import Da from"bn.js";var kd=new Da(1e6);import{MINT_SIZE as zd,TOKEN_PROGRAM_ID as Hd,getTransferFeeConfig as jd,unpackMint as Zd}from"@solana/spl-token";var Cr=oe("Raydium_accountInfo_util");async function ct(r,e,t){let{batchRequest:n,commitment:i="confirmed",chunkCount:o=100}={batchRequest:!1,...t},a=Kr(e,o),s=new Array(a.length).fill([]);if(n){let c=a.map(m=>{let d=r._buildArgs([m.map(p=>p.toBase58())],i,"base64");return{methodName:"getMultipleAccounts",args:d}}),u=Kr(c,10);s=(await(await Promise.all(u.map(async m=>await r._rpcBatchRequest(m)))).flat()).map(m=>(m.error&&Cr.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${m.error.message}`),m.result.value.map(d=>{if(d){let{data:p,executable:f,lamports:y,owner:g,rentEpoch:w}=d;return p.length!==2&&p[1]!=="base64"&&Cr.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(p[0],"base64"),executable:f,lamports:y,owner:new qa(g),rentEpoch:w}}return null})))}else try{s=await Promise.all(a.map(c=>r.getMultipleAccountsInfo(c,i)))}catch(c){c instanceof Error&&Cr.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${c.message}`)}return s.flat()}async function Kt(r,e,t){let n=await ct(r,e.map(i=>i.pubkey),t);return e.map((i,o)=>({...i,accountInfo:n[o]}))}import{PublicKey as $a}from"@solana/web3.js";import no,{isBN as ro}from"bn.js";import{bits as Ua,BitStructure as $d,blob as Ga,Blob as ep,cstr as tp,f32 as np,f32be as rp,f64 as ip,f64be as op,greedy as sp,Layout as Xa,ns64 as ap,ns64be as up,nu64 as cp,nu64be as lp,offset as mp,s16 as dp,s16be as pp,s24 as fp,s24be as bp,s32 as Qa,s32be as yp,s40 as gp,s40be as wp,s48 as kp,s48be as hp,s8 as Ap,seq as za,struct as Pp,Structure as Ha,u16 as ja,u16be as Tp,u24 as xp,u24be as Sp,u32 as Za,u32be as Bp,u40 as Ip,u40be as Kp,u48 as Lp,u48be as Np,u8 as Ya,UInt as Ja,union as Cp,Union as Rp,unionLayoutDiscriminator as Mp,utf8 as vp}from"@solana/buffer-layout";var zn=Xa,$i=Ha;var Rr=Ja;var eo=Ya,Lt=ja;var Mr=Za;var ce=Qa;var to=za;var he=Ga;var vr=Ua;var Nt=class extends zn{blob;signed;constructor(e,t,n){super(e,n),this.blob=he(e),this.signed=t}decode(e,t=0){let n=new no(this.blob.decode(e,t),10,"le");return this.signed?n.fromTwos(this.span*8).clone():n}encode(e,t,n=0){return typeof e=="number"&&(e=new no(e)),this.signed&&(e=e.toTwos(this.span*8)),this.blob.encode(e.toArrayLike(Buffer,"le",this.span),t,n)}},Hn=class extends zn{_lower;_upper;constructor(e){super(8,e),this._lower=vr(Mr(),!1),this._upper=vr(Mr(),!1)}addBoolean(e){this._lower.fields.length<32?this._lower.addBoolean(e):this._upper.addBoolean(e)}decode(e,t=0){let n=this._lower.decode(e,t),i=this._upper.decode(e,t+this._lower.span);return{...n,...i}}encode(e,t,n=0){return this._lower.encode(e,t,n)+this._upper.encode(e,t,n+this._lower.span)}};function V(r){return new Rr(1,r)}function Me(r){return new Rr(4,r)}function b(r){return new Nt(8,!1,r)}function D(r){return new Nt(16,!1,r)}function io(r){return new Nt(1,!0,r)}function Zt(r){return new Nt(8,!0,r)}function oo(r){return new Nt(16,!0,r)}var jn=class extends zn{layout;decoder;encoder;constructor(e,t,n,i){super(e.span,i),this.layout=e,this.decoder=t,this.encoder=n}decode(e,t){return this.decoder(this.layout.decode(e,t))}encode(e,t,n){return this.layout.encode(this.encoder(e),t,n)}getSpan(e,t){return this.layout.getSpan(e,t)}};function K(r){return new jn(he(32),e=>new $a(e),e=>e.toBuffer(),r)}function Pe(r){return new jn(eo(),eu,tu,r)}function eu(r){if(r===0)return!1;if(r===1)return!0;throw new Error("Invalid bool: "+r)}function tu(r){return r?1:0}var Er=class extends $i{decode(e,t){return super.decode(e,t)}};function M(r,e,t){return new Er(r,e,t)}function q(r,e,t){let n,i=typeof e=="number"?e:ro(e)?e.toNumber():new Proxy(e,{get(o,a){if(!n){let s=Reflect.get(o,"count");n=ro(s)?s.toNumber():s,Reflect.set(o,"count",n)}return Reflect.get(o,a)},set(o,a,s){return a==="count"&&(n=s),Reflect.set(o,a,s)}});return to(r,i,t)}import{PublicKey as so}from"@solana/web3.js";var Yp=oe("Raydium_farm_config"),Jp=new so("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),$p=new so("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1");var ao={3:Vr,5:uo,6:co};var Zn={"Standard SPL":0,"Option tokens":1},_r={[Gi.toString()]:3,[Xi.toString()]:4,[Qi.toString()]:5,[zi.toString()]:6};var Or=M([V("instruction")]),ou=M([V("instruction")]),su=M([b("rewardState"),b("rewardOpenTime"),b("rewardEndTime"),b("rewardLastUpdateTime"),b("totalReward"),b("totalRewardEmissioned"),b("rewardClaimed"),b("rewardPerSecond"),D("accRewardPerShare"),K("rewardVault"),K("rewardMint"),K("rewardSender"),b("rewardType"),q(b(),15,"padding")]),au=M([b("state"),b("nonce"),K("lpVault"),K("rewardVault"),K(),K(),b(),b(),b("totalReward"),D("perShareReward"),b("lastSlot"),b("perSlotReward")]),uu=M([b("state"),b("nonce"),K("lpVault"),K("rewardVaultA"),b("totalRewardA"),D("perShareRewardA"),b("perSlotRewardA"),V("option"),K("rewardVaultB"),he(7),b("totalRewardB"),D("perShareRewardB"),b("perSlotRewardB"),b("lastSlot"),K()]),cu=M([b(),b("state"),b("nonce"),b("validRewardTokenNum"),D("rewardMultiplier"),b("rewardPeriodMax"),b("rewardPeriodMin"),b("rewardPeriodExtend"),K("lpMint"),K("lpVault"),q(su,5,"rewardInfos"),K("creator"),K(),q(b(),32,"padding")]),nu=new Proxy(au,{get(r,e,t){return e==="decode"?(...n)=>{let i=r.decode(...n);return{...i,version:3,rewardInfos:[{rewardVault:i.rewardVault,totalReward:i.totalReward,perSlotReward:i.perSlotReward,perShareReward:i.perShareReward}]}}:Reflect.get(r,e,t)}}),ru=new Proxy(uu,{get(r,e,t){return e==="decode"?(...n)=>{let i=r.decode(...n);return{...i,version:5,rewardInfos:[{rewardVault:i.rewardVaultA,totalReward:i.totalRewardA,perSlotReward:i.perSlotRewardA,perShareReward:i.perShareRewardA},{rewardVault:i.rewardVaultB,totalReward:i.totalRewardB,perSlotReward:i.perSlotRewardB,perShareReward:i.perShareRewardB}]}}:Reflect.get(r,e,t)}}),iu=new Proxy(cu,{get(r,e,t){return e==="decode"?(...n)=>{let i=r.decode(...n);return{...i,version:6,rewardInfos:i.rewardInfos.map(o=>({...o,rewardType:(Object.entries(Zn).find(a=>String(a[1])===o.rewardType.toString())??["Standard SPL"])[0]}))}}:Reflect.get(r,e,t)}}),lu=M([b("isSet"),b("rewardPerSecond"),b("rewardOpenTime"),b("rewardEndTime"),b("rewardType")]),mu=M([V("instruction"),b("nonce"),q(lu,5,"rewardTimeInfo")]),du=M([V("instruction"),b("rewardReopenTime"),b("rewardEndTime"),b("rewardPerSecond")]),pu=M([V("instruction"),b("isSet"),b("rewardPerSecond"),b("rewardOpenTime"),b("rewardEndTime"),b("rewardType")]),af=M([b("state"),K("id"),K("owner"),b("deposited"),q(b(),1,"rewardDebts")]),Vr=M([b("state"),K("id"),K("owner"),b("deposited"),q(D(),1,"rewardDebts"),b(""),b("voteLockedBalance"),q(b(),15)]),uf=M([b("state"),K("id"),K("owner"),b("deposited"),q(b(),2,"rewardDebts")]),uo=M([b("state"),K("id"),K("owner"),b("deposited"),q(D(),2,"rewardDebts"),q(b(),17)]),co=M([b(),b("state"),K("id"),K("owner"),b("deposited"),q(D(),5,"rewardDebts"),q(b(),16)]),Ct=M([V("instruction"),b("amount")]),fu=M([K("mint"),K("grantAuthority"),b("baselineVoteWeightScaledFactor"),b("maxExtraLockupVoteWeightScaledFactor"),b("lockupSaturationSecs"),io("digitShift"),q(V(),7,"reserved1"),q(b(),7,"reserved2")]),bu=M([he(8),K("governanceProgramId"),K("realm"),K("realmGoverningTokenMint"),K("realmAuthority"),q(V(),32,"reserved1"),q(fu,4,"votingMints"),Zt("timeOffset"),V("bump"),q(V(),7,"reserved2"),q(b(),11,"reserved3")]),yu=M([Zt("startTime"),Zt("endTime"),V("kind"),q(V(),15,"reserved")]),gu=M([q(yu,1,"lockup"),b("amountDeposited_native"),b("amountInitiallyLockedNative"),Pe("isUsed"),Pe("allowClawback"),V("votingMintConfigIdx"),q(V(),29,"reserved")]),wu=M([he(8),K("voterAuthority"),K("registrar"),q(gu,32,"deposits"),V("voterBump"),V("voterWweightRecordBump"),q(V(),94,"reserved")]);import yf from"bn.js";var Yn=M([K("mint"),K("owner"),b("amount"),Me("delegateOption"),K("delegate"),V("state"),Me("isNativeOption"),b("isNative"),b("delegatedAmount"),Me("closeAuthorityOption"),K("closeAuthority")]);var ku=oe("Raydium.farm.util");function Yt({programId:r,poolId:e,owner:t,version:n}){let{publicKey:i}=pe([e.toBuffer(),t.toBuffer(),Buffer.from(n===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],r);return i}function lo(r){let e=ao[r];return e||ku.logWithError("invalid version",r),e}import{PublicKey as ve,SystemProgram as hu,SYSVAR_CLOCK_PUBKEY as mo,SYSVAR_RENT_PUBKEY as Au,TransactionInstruction as Jn}from"@solana/web3.js";import qf from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Gf,createAssociatedTokenAccountInstruction as Xf,TOKEN_PROGRAM_ID as Wr}from"@solana/spl-token";var Pu=oe("Raydium_farm_instruction"),nb={voterStakeRegistryCreateVoter:Buffer.from([6,24,245,52,243,255,148,25]),voterStakeRegistryCreateDepositEntry:Buffer.from([185,131,167,186,159,125,19,67]),voterStakeRegistryDeposit:Buffer.from([242,35,198,137,82,225,242,182]),voterStakeRegistryWithdraw:Buffer.from([183,18,70,156,148,109,161,34]),voterStakeRegistryUpdateVoterWeightRecord:Buffer.from([45,185,3,36,109,190,115,169])};function po(r){let{version:e,id:t,ledger:n,programId:i,owner:o}=r,a={3:9,5:10}[e];a||Pu.logWithError(`invalid farm pool version: ${e}`);let s=Buffer.alloc(Or.span);Or.encode({instruction:a},s);let c=[B({pubkey:t}),B({pubkey:n}),B({pubkey:o,isWritable:!1}),B({pubkey:hu.programId,isWritable:!1}),B({pubkey:Au,isWritable:!1})];return{instruction:new Jn({programId:i,keys:c,data:s}),instructionType:Q.FarmV3CreateLedger}}function fo(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:a}=r,[s,c]=[new ve(e.programId),new ve(e.id)],u=Yt({programId:s,poolId:c,owner:o,version:6}),l=Buffer.alloc(Ct.span);Ct.encode({instruction:2,amount:ee(a)},l);let m=[B({pubkey:Wr,isWritable:!1}),B({pubkey:c}),B({pubkey:new ve(t.authority),isWritable:!1}),B({pubkey:new ve(t.lpVault)}),B({pubkey:u}),B({pubkey:o,isWritable:!1,isSigner:!0}),B({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(B({pubkey:new ve(t.rewardInfos[d].vault)})),m.push(B({pubkey:i[d]}));return new Jn({programId:s,keys:m,data:l})}function bo(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:a,userAuxiliaryLedgers:s}=r,[c,u]=[new ve(e.programId),new ve(e.id)],l=Yt({programId:c,poolId:u,owner:o,version:5}),m=Buffer.alloc(Ct.span);Ct.encode({instruction:12,amount:ee(a)},m);let d=[B({pubkey:u}),B({pubkey:new ve(t.authority),isWritable:!1}),B({pubkey:l}),B({pubkey:o,isWritable:!1,isSigner:!0}),B({pubkey:n}),B({pubkey:new ve(t.lpVault)}),B({pubkey:i[0]}),B({pubkey:new ve(t.rewardInfos[0].vault)}),B({pubkey:mo,isWritable:!1}),B({pubkey:Wr,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(B({pubkey:i[p]})),d.push(B({pubkey:new ve(t.rewardInfos[p].vault)}));if(s)for(let p of s)d.push(B({pubkey:p}));return new Jn({programId:c,keys:d,data:m})}function yo(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:i,owner:o,amount:a,userAuxiliaryLedgers:s}=r,[c,u]=[new ve(e.programId),new ve(e.id)],l=Yt({programId:c,poolId:u,owner:o,version:3}),m=Buffer.alloc(Ct.span);Ct.encode({instruction:11,amount:ee(a)},m);let d=[B({pubkey:u}),B({pubkey:new ve(t.authority),isWritable:!1}),B({pubkey:l}),B({pubkey:o,isWritable:!1,isSigner:!0}),B({pubkey:n}),B({pubkey:new ve(t.lpVault)}),B({pubkey:i[0]}),B({pubkey:new ve(t.rewardInfos[0].vault)}),B({pubkey:mo,isWritable:!1}),B({pubkey:Wr,isWritable:!1})];if(s)for(let p of s)d.push(B({pubkey:p}));return new Jn({programId:c,keys:d,data:m})}import{Keypair as nr,PublicKey as C,SystemProgram as dt,TransactionInstruction as Ie}from"@solana/web3.js";import Hr from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as xn,TOKEN_2022_PROGRAM_ID as fe,TOKEN_PROGRAM_ID as se}from"@solana/spl-token";import Ru from"bn.js";import Ge from"bn.js";var de=new Ge(0),et=new Ge(1),lt=new Ge(-1),Oe=new Ge(1).shln(64),$n=new Ge(1).shln(128),Fr=Oe.sub(et),wn=64,go=$n.subn(1),Ee=-443636,_e=-Ee,Rt=new Ge("4295048016"),Mt=new Ge("79226673521066979257578248091"),db=new Ge("4295048017"),pb=new Ge("79226673521066979257578248090"),wo=16,ko="59543866431248",ho="184467440737095516",Ao="15793534762490258745",er=new Ge(10).pow(new Ge(6));var fb=new Ge("18446744073700000000");import Y from"bn.js";function tr(r){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,r,!1),new Uint8Array(e)}function Dr(r,e){let t=0;for(let n=r-1;n>=0&&!e.testn(n);n--)t++;return t}function qr(r,e){let t=0;for(let n=0;n<r&&!e.testn(n);n++)t++;return t}function kn(r,e){for(let t=0;t<r;t++)if(e.testn(t))return!1;return!0}function Po(r,e){return kn(r,e)?null:Dr(r,e)}function To(r,e){return kn(r,e)?null:qr(r,e)}var hb=Buffer.from("amm_config","utf8"),Tu=Buffer.from("pool","utf8"),xu=Buffer.from("pool_vault","utf8"),Su=Buffer.from("pool_reward_vault","utf8"),xo=Buffer.from("position","utf8"),Bu=Buffer.from("tick_array","utf8"),Iu=Buffer.from("operation","utf8"),Ku=Buffer.from("pool_tick_array_bitmap_extension","utf8"),Lu=Buffer.from("observation","utf8");function So(r,e,t,n){return pe([Tu,e.toBuffer(),t.toBuffer(),n.toBuffer()],r)}function Ur(r,e,t){return pe([xu,e.toBuffer(),t.toBuffer()],r)}function Bo(r,e,t){return pe([Su,e.toBuffer(),t.toBuffer()],r)}function ie(r,e,t){return pe([Bu,e.toBuffer(),tr(t)],r)}function At(r,e,t,n){return pe([xo,e.toBuffer(),tr(t),tr(n)],r)}function We(r,e){return pe([xo,e.toBuffer()],r)}function hn(r){return pe([Buffer.from("metadata","utf8"),St.toBuffer(),r.toBuffer()],St)}function Gr(r){return pe([Iu],r)}function Be(r,e){return pe([Ku,e.toBuffer()],r)}function Io(r,e){return pe([Lu,e.toBuffer()],r)}var Ko=Buffer.from("locked_position","utf8");function Xr(r,e){return pe([Ko,e.toBuffer()],r)}function Lo(r,e){return pe([Ko,e.toBuffer()],r)}var Ab=Buffer.from("support_mint","utf8");import{PublicKey as Fe}from"@solana/web3.js";import{TOKEN_2022_PROGRAM_ID as No}from"@solana/spl-token";import le from"bn.js";import tt from"bn.js";var An=class{static getfeeGrowthInside(e,t,n){let i=new tt(0),o=new tt(0);e.tickCurrent>=t.tick?(i=t.feeGrowthOutsideX64A,o=t.feeGrowthOutsideX64B):(i=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),o=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let a=new tt(0),s=new tt(0);e.tickCurrent<n.tick?(a=n.feeGrowthOutsideX64A,s=n.feeGrowthOutsideX64B):(a=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),s=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let c=Z.wrappingSubU128(Z.wrappingSubU128(e.feeGrowthGlobalX64A,i),a),u=Z.wrappingSubU128(Z.wrappingSubU128(e.feeGrowthGlobalX64B,o),s);return{feeGrowthInsideX64A:c,feeGrowthInsideBX64:u}}static GetPositionFees(e,t,n,i){let{feeGrowthInsideX64A:o,feeGrowthInsideBX64:a}=this.getfeeGrowthInside(e,n,i),s=Z.mulDivFloor(Z.wrappingSubU128(o,t.feeGrowthInsideLastX64A),t.liquidity,Oe),c=t.tokenFeesOwedA.add(s),u=Z.mulDivFloor(Z.wrappingSubU128(a,t.feeGrowthInsideLastX64B),t.liquidity,Oe),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,i){let{feeGrowthInsideX64A:o,feeGrowthInsideBX64:a}=this.getfeeGrowthInside(e,n,i),s=Z.mulDivFloor(Z.wrappingSubU128(o,t.feeGrowthInsideLastX64A),t.liquidity,Oe),c=t.tokenFeesOwedA.add(s),u=Z.mulDivFloor(Z.wrappingSubU128(a,t.feeGrowthInsideLastX64B),t.liquidity,Oe),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,i){let o=[],a=this.getRewardGrowthInsideV2(e.tickCurrent,n,i,e.rewardInfos);for(let s=0;s<a.length;s++){let c=a[s],u=t.rewardInfos[s],l=Z.wrappingSubU128(c,u.growthInsideLastX64),m=Z.mulDivFloor(l,t.liquidity,Oe),d=u.rewardAmountOwed.add(m);o.push(d)}return o}static GetPositionRewards(e,t,n,i){let o=[],a=this.getRewardGrowthInside(e.tickCurrent,n,i,e.rewardInfos);for(let s=0;s<a.length;s++){let c=a[s],u=t.rewardInfos[s],l=Z.wrappingSubU128(c,u.growthInsideLastX64),m=Z.mulDivFloor(l,t.liquidity,Oe),d=u.rewardAmountOwed.add(m);o.push(d)}return o}static getRewardGrowthInside(e,t,n,i){let o=[];for(let a=0;a<i.length;a++){let s=new tt(0);t.liquidityGross.eqn(0)?s=i[a].rewardGrowthGlobalX64:e<t.tick?s=i[a].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[a]):s=t.rewardGrowthsOutsideX64[a];let c=new tt(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[a]:c=i[a].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[a])),o.push(Z.wrappingSubU128(Z.wrappingSubU128(i[a].rewardGrowthGlobalX64,s),c))}return o}static getRewardGrowthInsideV2(e,t,n,i){let o=[];for(let a=0;a<i.length;a++){let s=new tt(0);t.liquidityGross.eqn(0)?s=i[a].rewardGrowthGlobalX64:e<t.tick?s=i[a].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[a]):s=t.rewardGrowthsOutsideX64[a];let c=new tt(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[a]:c=i[a].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[a])),o.push(Z.wrappingSubU128(Z.wrappingSubU128(i[a].rewardGrowthGlobalX64,s),c))}return o}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:i,add:o,epochInfo:a}){let s=j.priceToSqrtPriceX64(new N(e.price),e.mintA.decimals,e.mintB.decimals),c=j.getSqrtPriceX64FromTick(t.tickLower),u=j.getSqrtPriceX64FromTick(t.tickUpper),l=o?1+i:1-i,m=ne.getAmountsFromLiquidity(s,c,u,n,o),[d,p]=[ge(m.amountA,e.mintA.extensions?.feeConfig,a,!0),ge(m.amountB,e.mintB.extensions?.feeConfig,a,!0)],[f,y]=[ge(new tt(new N(m.amountA.toString()).mul(l).toFixed(0)),e.mintA.extensions?.feeConfig,a,!0),ge(new tt(new N(m.amountB.toString()).mul(l).toFixed(0)),e.mintB.extensions?.feeConfig,a,!0)];return{liquidity:n,amountA:d,amountB:p,amountSlippageA:f,amountSlippageB:y,expirationTime:ht(d.expirationTime,p.expirationTime)}}};var Nu=15,te=class{static async getTickArrays(e,t,n,i,o,a,s){let c=[],u=O.getTickArrayStartIndexByTick(i,o),l=O.getInitializedTickArrayInRange(a,s,o,u,Math.floor(Nu/2));for(let p=0;p<l.length;p++){let{publicKey:f}=ie(t,n,l[p]);c.push(f)}let m=(await ct(e,c)).map(p=>p!==null?Pn.decode(p.data):null),d={};for(let p=0;p<c.length;p++){let f=m[p];f!==null&&(d[f.startTickIndex]={...f,address:c[p]})}return d}static nextInitializedTick(e,t,n,i,o,a){let{initializedTick:s,tickArrayAddress:c,tickArrayStartTickIndex:u}=this.nextInitializedTickInOneArray(e,t,n,i,o,a);for(;s==null||s.liquidityGross.lten(0);){if(u=O.getNextTickArrayStartIndex(u,o,a),this.checkIsValidStartIndex(u,o))throw new Error("No enough initialized tickArray");let l=n[u];if(l===void 0)continue;let{nextTick:m,tickArrayAddress:d,tickArrayStartTickIndex:p}=this.firstInitializedTickInOneArray(e,t,l,a);[s,c,u]=[m,d,p]}if(s==null)throw new Error("No invaild tickArray cache");return{nextTick:s,tickArrayAddress:c,tickArrayStartTickIndex:u}}static nextInitializedTickArray(e,t,n,i,o){let a=Math.floor(e/te.tickCount(t)),s=n?O.searchLowBitFromStart(i,o,a-1,1,t):O.searchHightBitFromStart(i,o,a+1,1,t);return s.length>0?{isExist:!0,nextStartIndex:s[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,i){let o;if(i){let s=Te-1;for(;s>=0;){let c=n.ticks[s];if(c.liquidityGross.gtn(0)){o=c;break}s=s-1}}else{let s=0;for(;s<Te;){let c=n.ticks[s];if(c.liquidityGross.gtn(0)){o=c;break}s=s+1}}let{publicKey:a}=ie(e,t,n.startTickIndex);return{nextTick:o,tickArrayAddress:a,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,i,o,a){let s=O.getTickArrayStartIndexByTick(i,o),c=Math.floor((i-s)/o),u=n[s];if(u==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:s};let l;if(a)for(;c>=0;){let d=u.ticks[c];if(d.liquidityGross.gtn(0)){l=d;break}c=c-1}else for(c=c+1;c<Te;){let d=u.ticks[c];if(d.liquidityGross.gtn(0)){l=d;break}c=c+1}let{publicKey:m}=ie(e,t,s);return{initializedTick:l,tickArrayAddress:m,tickArrayStartTickIndex:u.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(O.checkIsOutOfBoundary(e)){if(e>_e)return!1;let n=O.getTickArrayStartIndexByTick(Ee,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return Te*e}};var Qr=14,mt=class{static maxTickInTickarrayBitmap(e){return e*Te*vt}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(i+=1);let o=n*i;return e<0?{minValue:-o,maxValue:-o+n}:{minValue:o,maxValue:o+n}}static nextInitializedTickArrayStartIndex(e,t,n,i){if(!te.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let o=this.maxTickInTickarrayBitmap(n),a=i?t-te.tickCount(n):t+te.tickCount(n);if(a<-o||a>=o)return{isInit:!1,tickIndex:t};let s=n*Te,c=a/s+512;a<0&&a%s!=0&&c--;let u=Math.abs(c);if(i){let l=e.shln(1024-u-1),m=Po(1024,l);if(m!==null){let d=(u-m-512)*s;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:-o}}else{let l=e.shrn(u),m=To(1024,l);if(m!==null){let d=(u+m-512)*s;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:o-te.tickCount(n)}}}},Tn=class{static getBitmapOffset(e,t){if(!te.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=mt.maxTickInTickarrayBitmap(t),i=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&i--,i}static getBitmap(e,t,n){let i=this.getBitmapOffset(e,t);return e<0?{offset:i,tickarrayBitmap:n.negativeTickArrayBitmap[i]}:{offset:i,tickarrayBitmap:n.positiveTickArrayBitmap[i]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:i}=this.extensionTickBoundary(t);if(e>=i&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=mt.maxTickInTickarrayBitmap(e),n=-t;if(_e<=t)throw Error(`extensionTickBoundary check error: ${_e}, ${t}`);if(n<=Ee)throw Error(`extensionTickBoundary check error: ${n}, ${Ee}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:i}=this.getBitmap(e,t,n),o=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:O.mergeTickArrayBitmap(i).testn(o),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,i){let o=te.tickCount(t),a=n?e-o:e+o,{tickarrayBitmap:s}=this.getBitmap(a,t,i);return this.nextInitializedTickArrayInBitmap(s,a,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,i){let{minValue:o,maxValue:a}=mt.getBitmapTickBoundary(t,n),s=this.tickArrayOffsetInBitmap(t,n);if(i){let c=O.mergeTickArrayBitmap(e).shln(vt-1-s),u=kn(512,c)?null:Dr(512,c);if(u!==null){let l=t-u*te.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:o}}else{let c=O.mergeTickArrayBitmap(e).shrn(s),u=kn(512,c)?null:qr(512,c);if(u!==null){let l=t+u*te.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:a-te.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%mt.maxTickInTickarrayBitmap(t),i=Math.floor(n/te.tickCount(t));return e<0&&n!=0&&(i=vt-i),i}};var we=class{static getOutputAmountAndRemainAccounts(e,t,n,i,o,a=!1){let s=n.toBase58()===e.mintA.address,c=[],{isExist:u,startIndex:l,nextAccountMeta:m}=this.getFirstInitializedTickArray(e,s);if(!u||l===void 0||!m)throw new Error("Invalid tick array");c.push(m);let{allTrade:d,amountCalculated:p,accounts:f,sqrtPriceX64:y,feeAmount:g}=Et.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i,l,o,a);return c.push(...f),{allTrade:d,expectedAmountOut:p.mul(lt),remainingAccounts:c,executionPrice:y,feeAmount:g}}static getInputAmountAndRemainAccounts(e,t,n,i,o){let a=n.toBase58()===e.mintB.address,s=[],{isExist:c,startIndex:u,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,a);if(!c||u===void 0||!l)throw new Error("Invalid tick array");try{let y=this.preInitializedTickArrayStartIndex(e,a);if(y.isExist){let{publicKey:g}=ie(e.programId,e.id,y.nextStartIndex);s.push(g)}}catch{}s.push(l);let{amountCalculated:m,accounts:d,sqrtPriceX64:p,feeAmount:f}=Et.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,a,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,i.mul(lt),u,o);return s.push(...d),{expectedAmountIn:m,remainingAccounts:s,executionPrice:p,feeAmount:f}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:i}=we.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?Tn.checkTickArrayIsInit(te.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):O.checkTickArrayIsInitialized(O.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:s}=ie(e.programId,e.id,i);return{isExist:!0,startIndex:i,nextAccountMeta:s}}let{isExist:o,nextStartIndex:a}=this.nextInitializedTickArrayStartIndex(e,te.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(o){let{publicKey:s}=ie(e.programId,e.id,a);return{isExist:!0,startIndex:a,nextAccountMeta:s}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/te.tickCount(e.tickSpacing)),i=t?O.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):O.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return i.length>0?{isExist:!0,nextStartIndex:i[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=te.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:i,tickIndex:o}=mt.nextInitializedTickArrayStartIndex(O.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(i)return{isExist:!0,nextStartIndex:o};t=o;let{isInit:a,tickIndex:s}=Tn.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(a)return{isExist:!0,nextStartIndex:s};if(t=s,t<Ee||t>_e)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:i,rewardInfos:o}){let a=[];for(let s=0;s<o.length;s++){let c=o[s],u=t.rewardDefaultInfos[s]?.mint.programId??(await e.getAccountInfo(c.tokenMint))?.owner;if(u===void 0)throw Error("get new reward mint info error");let l={...c,perSecond:Z.x64ToDecimal(c.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new Fe(u)};if(l.tokenMint.equals(Fe.default))continue;if(n<=l.openTime.toNumber()||i.eq(de)){a.push(l);continue}let m=new le(Math.min(l.endTime.toNumber(),n)),d=m.sub(l.lastUpdateTime),p=Z.mulDivFloor(d,l.emissionsPerSecondX64,i),f=l.rewardGrowthGlobalX64.add(p),y=Z.mulDivFloor(d,l.emissionsPerSecondX64,Oe),g=l.rewardTotalEmissioned.add(y);a.push({...l,rewardGrowthGlobalX64:f,rewardTotalEmissioned:g,lastUpdateTime:m})}return a}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:i}=this.tickRange(e);for(let o of t){let a=O.getTickArrayStartIndexByTick(o,e);if(a>=n||a<i)return!0}return!1}static tickRange(e){let t=mt.maxTickInTickarrayBitmap(e),n=-t;return t>_e&&(t=te.getArrayStartIndex(_e,e)+te.tickCount(e)),n<Ee&&(n=te.getArrayStartIndex(Ee,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!te.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/te.tickCount(t)*vt}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let i=await Kt(e,t.map(a=>({pubkey:a})),{batchRequest:n}),o={};for(let a of i)a.accountInfo!==null&&(o[a.pubkey.toString()]=Mo.decode(a.accountInfo.data));return o}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let i={},o=[];for(let c of t){let u=O.getTickArrayStartIndexByTick(c.tickCurrent,c.tickSpacing),l=O.getInitializedTickArrayInRange(c.tickArrayBitmap,c.exBitmapInfo,c.tickSpacing,u,7);for(let m of l){let{publicKey:d}=ie(c.programId,c.id,m);o.push({pubkey:d}),i[d.toString()]=c.id}}let a=await Kt(e,o,{batchRequest:n}),s={};for(let c of a){if(!c.accountInfo)continue;let u=i[c.pubkey.toString()];if(!u)continue;s[u.toString()]===void 0&&(s[u.toString()]={});let l=Pn.decode(c.accountInfo.data);s[u.toString()][l.startTickIndex]={...l,address:c.pubkey}}return s}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:i=!1,updateOwnerRewardAndFee:o=!0}){let a=[];for(let s=0;s<e.length;s++){let c=e[s];c!==null&&(a.find(u=>u.equals(c.state.programId))||a.push(c.state.programId))}if(n){let s=n.tokenAccounts.map(m=>m.accountInfo.mint),c=[];for(let m of s)for(let d of a)c.push(We(d,m).publicKey);let u=await ct(t,c,{batchRequest:i}),l={};for(let m of u){if(m===null)continue;let d=Ro.decode(m.data),p=d.poolId.toString(),f=e.find(S=>S.state.id.toBase58()===p);if(f===void 0)continue;let y=f.state,g=O._getTickPriceLegacy({poolInfo:y,tick:d.tickLower,baseIn:!0}),w=O._getTickPriceLegacy({poolInfo:y,tick:d.tickUpper,baseIn:!0}),{amountA:h,amountB:k}=ne.getAmountsFromLiquidity(y.sqrtPriceX64,g.tickSqrtPriceX64,w.tickSqrtPriceX64,d.liquidity,!1),P=1/(1-Math.sqrt(Math.sqrt(g.price.div(w.price).toNumber())));f.positionAccount=[...f.positionAccount??[],{poolId:d.poolId,nftMint:d.nftMint,priceLower:g.price,priceUpper:w.price,amountA:h,amountB:k,tickLower:d.tickLower,tickUpper:d.tickUpper,liquidity:d.liquidity,feeGrowthInsideLastX64A:d.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:d.feeGrowthInsideLastX64B,tokenFeesOwedA:d.tokenFeesOwedA,tokenFeesOwedB:d.tokenFeesOwedB,rewardInfos:d.rewardInfos.map(S=>({...S,pendingReward:new le(0)})),leverage:P,tokenFeeAmountA:new le(0),tokenFeeAmountB:new le(0)}];let T=await O.getTickArrayAddressByTick(f.state.programId,d.poolId,d.tickLower,f.state.tickSpacing),A=await O.getTickArrayAddressByTick(f.state.programId,d.poolId,d.tickUpper,f.state.tickSpacing);l[`${f.state.programId.toString()}-${d.poolId.toString()}-${d.tickLower}`]=T,l[`${f.state.programId.toString()}-${d.poolId.toString()}-${d.tickUpper}`]=A}if(o){let m=Object.values(l),d=await ct(t,m,{batchRequest:i}),p={};for(let f=0;f<m.length;f++){let y=d[f];if(y===null)continue;let g=m[f].toString();p[g]=Pn.decode(y.data)}for(let{state:f,positionAccount:y}of e)if(!!y)for(let g of y){let w=`${f.programId.toString()}-${f.id.toString()}-${g.tickLower}`,h=`${f.programId.toString()}-${f.id.toString()}-${g.tickUpper}`,k=p[l[w].toString()],P=p[l[h].toString()],T=k.ticks[O.getTickOffsetInArray(g.tickLower,f.tickSpacing)],A=P.ticks[O.getTickOffsetInArray(g.tickUpper,f.tickSpacing)],{tokenFeeAmountA:S,tokenFeeAmountB:L}=await An.GetPositionFees(f,g,T,A),x=await An.GetPositionRewards(f,g,T,A);g.tokenFeeAmountA=S.gte(new le(0))?S:new le(0),g.tokenFeeAmountB=L.gte(new le(0))?L:new le(0);for(let R=0;R<x.length;R++)g.rewardInfos[R].pendingReward=x[R].gte(new le(0))?x[R]:new le(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountIn:o,slippage:a,priceLimit:s=new N(0),catchLiquidityInsufficient:c=!1}){let u,l=n.toBase58()===e.mintA.address,[m,d]=l?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];s.equals(new N(0))?u=l?Rt.add(new le(1)):Mt.sub(new le(1)):u=j.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let p=ge(o,m,i,!1),{allTrade:f,expectedAmountOut:y,remainingAccounts:g,executionPrice:w,feeAmount:h}=we.getOutputAmountAndRemainAccounts(e,t,n,p.amount.sub(p.fee??de),u,c),k=ge(y,d,i,!1),P=j.sqrtPriceX64ToPrice(w,e.mintA.decimals,e.mintB.decimals),T=l?P:new N(1).div(P),A=y.mul(new le(Math.floor((1-a)*1e10))).div(new le(1e10)),S=ge(A,d,i,!1),L=l?e.currentPrice:new N(1).div(e.currentPrice),x=new N(T).sub(L).abs(),R=L,v=new qe(new N(x).mul(10**15).toFixed(0),new N(R).mul(10**15).toFixed(0));return{allTrade:f,realAmountIn:p,amountOut:k,minAmountOut:S,expirationTime:ht(p.expirationTime,k.expirationTime),currentPrice:e.currentPrice,executionPrice:T,priceImpact:v,fee:h,remainingAccounts:g,executionPriceX64:w}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:i,slippage:o,epochInfo:a,catchLiquidityInsufficient:s=!1}){let c=i.address===e.mintB.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA],[m,d]=[new Re({...u,mint:u.address,isToken2022:u.programId===No.toBase58()}),new Re({...l,mint:l.address,isToken2022:l.programId===No.toBase58()})],{allTrade:p,realAmountIn:f,amountOut:y,minAmountOut:g,expirationTime:w,currentPrice:h,executionPrice:k,priceImpact:P,fee:T,remainingAccounts:A,executionPriceX64:S}=we.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new Fe(u.address),amountIn:n,slippage:o,epochInfo:a,catchLiquidityInsufficient:s}),L={...f,amount:new ye(m,f.amount),fee:f.fee===void 0?void 0:new ye(m,f.fee)},x={...y,amount:new ye(d,y.amount),fee:y.fee===void 0?void 0:new ye(d,y.fee)},R={...g,amount:new ye(d,g.amount),fee:g.fee===void 0?void 0:new ye(d,g.fee)},v=new Ue({baseToken:m,denominator:new le(10).pow(new le(20+m.decimals)),quoteToken:d,numerator:h.mul(new N(10**(20+d.decimals))).toFixed(0)}),W=new Ue({baseToken:m,denominator:new le(10).pow(new le(20+m.decimals)),quoteToken:d,numerator:k.mul(new N(10**(20+d.decimals))).toFixed(0)}),X=new ye(m,T);return{allTrade:p,realAmountIn:L,amountOut:x,minAmountOut:R,expirationTime:w,currentPrice:v,executionPrice:W,priceImpact:P,fee:X,remainingAccounts:A,executionPriceX64:S}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:i,amountOut:o,slippage:a,priceLimit:s=new N(0)}){let c=n.toBase58()===e.mintA.address,u={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},l;s.equals(new N(0))?l=c?Mt.sub(new le(1)):Rt.add(new le(1)):l=j.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let m=ge(o,u[n.toString()],i,!0),{expectedAmountIn:d,remainingAccounts:p,executionPrice:f,feeAmount:y}=we.getInputAmountAndRemainAccounts(e,t,n,m.amount.sub(m.fee??de),l),g=c?e.mintB.address:e.mintA.address,w=ge(d,u[g],i,!1),h=j.sqrtPriceX64ToPrice(f,e.mintA.decimals,e.mintB.decimals),k=c?h:new N(1).div(h),P=d.mul(new le(Math.floor((1+a)*1e10))).div(new le(1e10)),T=ge(P,u[g],i,!0),A=c?e.currentPrice:new N(1).div(e.currentPrice),S=new N(k).sub(A).abs(),L=A,x=new qe(new N(S).mul(10**15).toFixed(0),new N(L).mul(10**15).toFixed(0));return{amountIn:w,maxAmountIn:T,realAmountOut:m,expirationTime:ht(w.expirationTime,m.expirationTime),currentPrice:e.currentPrice,executionPrice:k,priceImpact:x,fee:y,remainingAccounts:p}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:i}){let o=e[t],a=O.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),s=O.getTickPrice({poolInfo:e,tick:i,baseIn:!0}).price.toNumber(),c=Math.max(a,o.priceMin),l=Math.min(s,o.priceMax)-c,m=s-a,d=o.priceMax-o.priceMin,p;return l<=0?p=0:m===l?p=d/l:d===l?p=l/m:p=l/d*(l/m),{feeApr:o.feeApr*p,rewardsApr:[(o.rewardApr[0]??0)*p,(o.rewardApr[1]??0)*p,(o.rewardApr[2]??0)*p],apr:o.apr*p}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:i,liquidity:o,positionTickLowerIndex:a,positionTickUpperIndex:s,chainTime:c}){let u=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],m=i[zt(e.mintA.address).toString()],d=i[zt(e.mintB.address).toString()],p=e.mintA.decimals,f=e.mintB.decimals;if(!l||!m||!d)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let y=j.priceToSqrtPriceX64(new N(e.price),e.mintA.decimals,e.mintB.decimals),g=j.getSqrtPriceX64FromTick(a),w=j.getSqrtPriceX64FromTick(s),{amountSlippageA:h,amountSlippageB:k}=ne.getAmountsFromLiquidityWithSlippage(y,g,w,t,!1,!1,0),{amountSlippageA:P,amountSlippageB:T}=ne.getAmountsFromLiquidityWithSlippage(y,g,w,o,!1,!1,0),A=new N(h.toString()).div(new N(10).pow(p)).mul(m.value).add(new N(k.toString()).div(new N(10).pow(f)).mul(d.value)),S=new N(P.toString()).div(new N(10).pow(p)).mul(m.value).add(new N(T.toString()).div(new N(10).pow(f)).mul(d.value)),L=new N(1).div(A.add(S)),R=new N(l.volumeFee).mul(365).div(u).mul(L).mul(100).toNumber(),v=3600*24*365,W=e.rewardDefaultInfos.map(X=>{let $=X.mint.decimals,J=i[X.mint.address];return c<(X.startTime??0)||c>(X.endTime??0)||!X.perSecond||!J||$===void 0?0:new N(J.value).mul(new N(X.perSecond).mul(v)).div(new N(10).pow($)).mul(L).mul(100).toNumber()});return{feeApr:R,rewardsApr:W,apr:R+W.reduce((X,$)=>X+$,0)}}static async getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:i,amount:o,slippage:a,add:s,epochInfo:c,amountHasFee:u}){let l=j.priceToSqrtPriceX64(new N(e.price),e.mintA.decimals,e.mintB.decimals),m=j.getSqrtPriceX64FromTick(n),d=j.getSqrtPriceX64FromTick(i),p=ge(o,e[t?"mintA":"mintB"].extensions?.feeConfig,c,!u),f=new le(new N(p.amount.sub(p.fee??de).toString()).toFixed(0)),y;if(l.lte(m))y=t?ne.getLiquidityFromTokenAmountA(m,d,f,!s):new le(0);else if(l.lte(d)){let w=ne.getLiquidityFromTokenAmountA(l,d,f,!s),h=ne.getLiquidityFromTokenAmountB(m,l,f);y=t?w:h}else y=t?new le(0):ne.getLiquidityFromTokenAmountB(m,d,f);let g=await we.getAmountsFromLiquidity({epochInfo:c,poolInfo:e,tickLower:n,tickUpper:i,liquidity:y,slippage:a,add:s});return{liquidity:y,amountA:t?p:g.amountA,amountB:t?g.amountB:p,amountSlippageA:t?p:g.amountSlippageA,amountSlippageB:t?g.amountSlippageB:p,expirationTime:g.expirationTime}}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:i,liquidity:o,slippage:a,add:s}){let c=j.getSqrtPriceX64FromTick(n),u=j.getSqrtPriceX64FromTick(i),l=s?1+a:1-a,m=ne.getAmountsFromLiquidity(j.priceToSqrtPriceX64(new N(t.price),t.mintA.decimals,t.mintB.decimals),c,u,o,s),[d,p]=[ge(m.amountA,t.mintA.extensions?.feeConfig,e,!0),ge(m.amountB,t.mintB.extensions?.feeConfig,e,!0)],[f,y]=[ge(m.amountA.muln(l),t.mintA.extensions?.feeConfig,e,!0),ge(m.amountB.muln(l),t.mintB.extensions?.feeConfig,e,!0)];return{liquidity:o,amountA:d,amountB:p,amountSlippageA:f,amountSlippageB:y,expirationTime:ht(d.expirationTime,p.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let i=t.filter(c=>!n[c.id]).map(c=>new Fe(c.id));(await ct(e,i)).forEach((c,u)=>{!c||(n[i[u].toBase58()]=Co.decode(c.data))});let a=t.map(c=>Be(new Fe(c.programId),new Fe(c.id)).publicKey),s=await we.fetchExBitmaps({connection:e,exBitmapAddress:a,batchRequest:!1});return t.reduce((c,u)=>({...c,[u.id]:{...n[u.id],id:new Fe(u.id),version:6,programId:new Fe(u.programId),mintA:u.mintA,mintB:u.mintB,ammConfig:{...u.config,id:new Fe(u.config.id),fundOwner:""},currentPrice:new N(u.price),exBitmapAccount:Be(new Fe(u.programId),new Fe(u.id)).publicKey,exBitmapInfo:s[Be(new Fe(u.programId),new Fe(u.id)).publicKey.toBase58()],startTime:n[u.id].startTime.toNumber(),rewardInfos:n[u.id].rewardInfos}}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};var Z=class{static mulDivRoundingUp(e,t,n){let i=e.mul(t),o=i.div(n);return i.mod(n).eq(de)||(o=o.add(et)),o}static mulDivFloor(e,t,n){if(n.eq(de))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(de))throw new Error("division by 0");return e.mul(t).add(n.sub(et)).div(n)}static x64ToDecimal(e,t){return new N(e.toString()).div(N.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new Y(e.mul(N.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add($n).sub(t).mod($n)}};function xe(r,e){return zr(r.mul(e),64,256)}function Cu(r,e,t){let n=r.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function zr(r,e,t){let n=r.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var j=class{static sqrtPriceX64ToPrice(e,t,n){return Z.x64ToDecimal(e).pow(2).mul(N.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return Z.decimalToX64(e.mul(N.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,i){if(!e.gt(de))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(de))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,i){if(!e.gt(de))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(de))throw new Error("liquidity must greater than 0");return i?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,i){if(n.eq(de))return e;let o=t.shln(wn);if(i){let a=o,s=o.add(n.mul(e));return s.gte(a)?Z.mulDivCeil(a,e,s):Z.mulDivRoundingUp(a,et,a.div(e).add(n))}else{let a=n.mul(e);if(!o.gt(a))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let s=o.sub(a);return Z.mulDivCeil(o,e,s)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,i){let o=n.shln(wn);if(i)return e.add(o.div(t));{let a=Z.mulDivRoundingUp(o,et,t);if(!e.gt(a))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(a)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<Ee||e>_e)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new Y("18445821805675395072"):new Y("18446744073709551616");return(t&2)!=0&&(n=xe(n,new Y("18444899583751176192"))),(t&4)!=0&&(n=xe(n,new Y("18443055278223355904"))),(t&8)!=0&&(n=xe(n,new Y("18439367220385607680"))),(t&16)!=0&&(n=xe(n,new Y("18431993317065453568"))),(t&32)!=0&&(n=xe(n,new Y("18417254355718170624"))),(t&64)!=0&&(n=xe(n,new Y("18387811781193609216"))),(t&128)!=0&&(n=xe(n,new Y("18329067761203558400"))),(t&256)!=0&&(n=xe(n,new Y("18212142134806163456"))),(t&512)!=0&&(n=xe(n,new Y("17980523815641700352"))),(t&1024)!=0&&(n=xe(n,new Y("17526086738831433728"))),(t&2048)!=0&&(n=xe(n,new Y("16651378430235570176"))),(t&4096)!=0&&(n=xe(n,new Y("15030750278694412288"))),(t&8192)!=0&&(n=xe(n,new Y("12247334978884435968"))),(t&16384)!=0&&(n=xe(n,new Y("8131365268886854656"))),(t&32768)!=0&&(n=xe(n,new Y("3584323654725218816"))),(t&65536)!=0&&(n=xe(n,new Y("696457651848324352"))),(t&131072)!=0&&(n=xe(n,new Y("26294789957507116"))),(t&262144)!=0&&(n=xe(n,new Y("37481735321082"))),e>0&&(n=go.div(n)),n}static getTickFromPrice(e,t,n){return j.getTickFromSqrtPriceX64(j.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(Mt)||e.lt(Rt))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new Y(t-64),i=Cu(n,32,128),o=new Y("8000000000000000","hex"),a=0,s=new Y(0),c=t>=64?e.shrn(t-63):e.shln(63-t);for(;o.gt(new Y(0))&&a<wo;){c=c.mul(c);let f=c.shrn(127);c=c.shrn(63+f.toNumber()),s=s.add(o.mul(f)),o=o.shrn(1),a+=1}let u=s.shrn(32),m=i.add(u).mul(new Y(ko)),d=zr(m.sub(new Y(ho)),64,128).toNumber(),p=zr(m.add(new Y(Ao)),64,128).toNumber();return d==p?d:j.getSqrtPriceX64FromTick(p).lte(e)?p:d}},_t=class{static getTickWithPriceAndTickspacing(e,t,n,i){let a=j.getTickFromSqrtPriceX64(j.priceToSqrtPriceX64(e,n,i))/t;return a<0?a=Math.floor(a):a=Math.ceil(a),a*t}static roundPriceWithTickspacing(e,t,n,i){let o=_t.getTickWithPriceAndTickspacing(e,t,n,i),a=j.getSqrtPriceX64FromTick(o);return j.sqrtPriceX64ToPrice(a,n,i)}},ne=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(de))throw new Error("sqrtPriceX64A must greater than 0");let o=n.ushln(wn),a=t.sub(e);return i?Z.mulDivRoundingUp(Z.mulDivCeil(o,a,t),et,e):Z.mulDivFloor(o,a,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,i){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(de))throw new Error("sqrtPriceX64A must greater than 0");return i?Z.mulDivCeil(n,t.sub(e),Oe):Z.mulDivFloor(n,t.sub(e),Oe)}static getLiquidityFromTokenAmountA(e,t,n,i){e.gt(t)&&([e,t]=[t,e]);let o=n.mul(e).mul(t),a=t.sub(e),s=o.div(a);return i?Z.mulDivRoundingUp(s,et,Fr):s.shrn(wn)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),Z.mulDivFloor(n,Fr,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,i,o){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return ne.getLiquidityFromTokenAmountA(t,n,i,!1);if(e.lt(n)){let a=ne.getLiquidityFromTokenAmountA(e,n,i,!1),s=ne.getLiquidityFromTokenAmountB(t,e,o);return a.lt(s)?a:s}else return ne.getLiquidityFromTokenAmountB(t,n,o)}static getAmountsFromLiquidity(e,t,n,i,o){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:ne.getTokenAmountAFromLiquidity(t,n,i,o),amountB:new Y(0)};if(e.lt(n)){let a=ne.getTokenAmountAFromLiquidity(e,n,i,o),s=ne.getTokenAmountBFromLiquidity(t,e,i,o);return{amountA:a,amountB:s}}else return{amountA:new Y(0),amountB:ne.getTokenAmountBFromLiquidity(t,n,i,o)}}static getAmountsFromLiquidityWithSlippage(e,t,n,i,o,a,s){let{amountA:c,amountB:u}=ne.getAmountsFromLiquidity(e,t,n,i,a),l=o?1+s:1-s,m=new Y(new N(c.toString()).mul(l).toFixed(0)),d=new Y(new N(u.toString()).mul(l).toFixed(0));return{amountSlippageA:m,amountSlippageB:d}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:i,slippage:o,add:a,epochInfo:s,amountAddFee:c}){let u=j.priceToSqrtPriceX64(new N(e.price),e.mintA.decimals,e.mintB.decimals),l=j.getSqrtPriceX64FromTick(t),m=j.getSqrtPriceX64FromTick(n),d=a?1+o:1-o,p=ne.getAmountsFromLiquidity(u,l,m,i,a),[f,y]=[ge(p.amountA,e.mintA.extensions?.feeConfig,s,c),ge(p.amountB,e.mintB.extensions?.feeConfig,s,c)],[g,w]=[ge(new Y(new N(p.amountA.toString()).mul(d).toFixed(0)),e.mintA.extensions?.feeConfig,s,c),ge(new Y(new N(p.amountB.toString()).mul(d).toFixed(0)),e.mintB.extensions?.feeConfig,s,c)];return{liquidity:i,amountA:f,amountB:y,amountSlippageA:g,amountSlippageB:w,expirationTime:ht(f.expirationTime,y.expirationTime)}}},Et=class{static swapCompute(e,t,n,i,o,a,s,c,u,l,m,d,p,f,y=!1){if(d.eq(de))throw new Error("amountSpecified must not be 0");if(f||(f=a?Rt.add(et):Mt.sub(et)),a){if(f.lt(Rt))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(f.gte(m))throw new Error("sqrtPriceX64 must smaller than current")}else{if(f.gt(Mt))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(f.lte(m))throw new Error("sqrtPriceX64 must greater than current")}let g=d.gt(de),w={amountSpecifiedRemaining:d,amountCalculated:de,sqrtPriceX64:m,tick:u>p?Math.min(p+te.tickCount(l)-1,u):p,accounts:[],liquidity:c,feeAmount:new Y(0)},h=p,k=n[p],P=0,T=!a&&k.startTickIndex===w.tick;for(;!w.amountSpecifiedRemaining.eq(de)&&!w.sqrtPriceX64.eq(f);){P>10;let A={};A.sqrtPriceStartX64=w.sqrtPriceX64;let S=O.nextInitTick(k,w.tick,l,a,T),L=S||null,x=null;if(!L?.liquidityGross.gtn(0)){let v=we.nextInitializedTickArrayStartIndex({tickCurrent:w.tick,tickSpacing:l,tickArrayBitmap:i,exBitmapInfo:o},h,a);if(!v.isExist){if(y)return{allTrade:!1,amountSpecifiedRemaining:w.amountSpecifiedRemaining,amountCalculated:w.amountCalculated,feeAmount:w.feeAmount,sqrtPriceX64:w.sqrtPriceX64,liquidity:w.liquidity,tickCurrent:w.tick,accounts:w.accounts};throw Error("swapCompute LiquidityInsufficient")}h=v.nextStartIndex;let{publicKey:W}=ie(e,t,h);x=W,k=n[h];try{L=O.firstInitializedTick(k,a)}catch{throw Error("not found next tick info")}}A.tickNext=L.tick,A.initialized=L.liquidityGross.gtn(0),p!==h&&x&&(w.accounts.push(x),p=h),A.tickNext<Ee?A.tickNext=Ee:A.tickNext>_e&&(A.tickNext=_e),A.sqrtPriceNextX64=j.getSqrtPriceX64FromTick(A.tickNext);let R;if(a&&A.sqrtPriceNextX64.lt(f)||!a&&A.sqrtPriceNextX64.gt(f)?R=f:R=A.sqrtPriceNextX64,[w.sqrtPriceX64,A.amountIn,A.amountOut,A.feeAmount]=Et.swapStepCompute(w.sqrtPriceX64,R,w.liquidity,w.amountSpecifiedRemaining,s,a),w.feeAmount=w.feeAmount.add(A.feeAmount),g?(w.amountSpecifiedRemaining=w.amountSpecifiedRemaining.sub(A.amountIn.add(A.feeAmount)),w.amountCalculated=w.amountCalculated.sub(A.amountOut)):(w.amountSpecifiedRemaining=w.amountSpecifiedRemaining.add(A.amountOut),w.amountCalculated=w.amountCalculated.add(A.amountIn.add(A.feeAmount))),w.sqrtPriceX64.eq(A.sqrtPriceNextX64)){if(A.initialized){let v=L.liquidityNet;a&&(v=v.mul(lt)),w.liquidity=ne.addDelta(w.liquidity,v)}T=A.tickNext!=w.tick&&!a&&k.startTickIndex===A.tickNext,w.tick=a?A.tickNext-1:A.tickNext}else if(w.sqrtPriceX64!=A.sqrtPriceStartX64){let v=j.getTickFromSqrtPriceX64(w.sqrtPriceX64);T=v!=w.tick&&!a&&k.startTickIndex===v,w.tick=v}++P}try{let{nextStartIndex:A,isExist:S}=te.nextInitializedTickArray(w.tick,l,a,i,o);S&&p!==A&&(w.accounts.push(ie(e,t,A).publicKey),p=A)}catch{}return{allTrade:!0,amountSpecifiedRemaining:de,amountCalculated:w.amountCalculated,feeAmount:w.feeAmount,sqrtPriceX64:w.sqrtPriceX64,liquidity:w.liquidity,tickCurrent:w.tick,accounts:w.accounts}}static swapStepCompute(e,t,n,i,o,a){let s={sqrtPriceX64Next:new Y(0),amountIn:new Y(0),amountOut:new Y(0),feeAmount:new Y(0)},c=i.gte(de);if(c){let l=Z.mulDivFloor(i,er.sub(new Y(o.toString())),er);s.amountIn=a?ne.getTokenAmountAFromLiquidity(t,e,n,!0):ne.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(s.amountIn)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=j.getNextSqrtPriceX64FromInput(e,n,l,a)}else s.amountOut=a?ne.getTokenAmountBFromLiquidity(t,e,n,!1):ne.getTokenAmountAFromLiquidity(e,t,n,!1),i.mul(lt).gte(s.amountOut)?s.sqrtPriceX64Next=t:s.sqrtPriceX64Next=j.getNextSqrtPriceX64FromOutput(e,n,i.mul(lt),a);let u=t.eq(s.sqrtPriceX64Next);return a?(u&&c||(s.amountIn=ne.getTokenAmountAFromLiquidity(s.sqrtPriceX64Next,e,n,!0)),u&&!c||(s.amountOut=ne.getTokenAmountBFromLiquidity(s.sqrtPriceX64Next,e,n,!1))):(s.amountIn=u&&c?s.amountIn:ne.getTokenAmountBFromLiquidity(e,s.sqrtPriceX64Next,n,!0),s.amountOut=u&&!c?s.amountOut:ne.getTokenAmountAFromLiquidity(e,s.sqrtPriceX64Next,n,!1)),!c&&s.amountOut.gt(i.mul(lt))&&(s.amountOut=i.mul(lt)),c&&!s.sqrtPriceX64Next.eq(t)?s.feeAmount=i.sub(s.amountIn):s.feeAmount=Z.mulDivCeil(s.amountIn,new Y(o),er.sub(new Y(o))),[s.sqrtPriceX64Next,s.amountIn,s.amountOut,s.feeAmount]}};var Te=60,vt=512,O=class{static getTickArrayAddressByTick(e,t,n,i){let o=O.getTickArrayStartIndexByTick(n,i),{publicKey:a}=ie(e,t,o);return a}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=O.getTickArrayStartIndexByTick(e,t),i=Math.floor((e-n)/t);if(i<0||i>=Te)throw new Error("tick offset in array overflow");return i}static getTickArrayBitIndex(e,t){let n=te.tickCount(t),i=e/n;return e<0&&e%n!=0?i=Math.ceil(i)-1:i=Math.floor(i),i}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*te.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*Te,i=Math.floor(e/n)+512;return Math.abs(i)}static checkTickArrayIsInitialized(e,t,n){let i=n*Te,o=Math.floor(t/i)+512,a=Math.abs(o);return{isInitialized:e.testn(a),startIndex:(a-512)*i}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*Te:e+t*Te}static mergeTickArrayBitmap(e){let t=new Ru(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,i,o){let a=Math.floor(i/(n*Te));return[...O.searchLowBitFromStart(e,t,a-1,o,n),...O.searchHightBitFromStart(e,t,a,o,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return O.searchHightBitFromStart(e,t,-7680,vt,n)}static getAllInitializedTickArrayInfo(e,t,n,i,o){let a=[],s=O.getAllInitializedTickArrayStartIndex(n,i,o);for(let c of s){let{publicKey:u}=ie(e,t,c);a.push({tickArrayStartIndex:c,tickArrayAddress:u})}return a}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,i,o){let a=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>O.mergeTickArrayBitmap(u)),s=[];for(;n>=-7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(a[u].testn(l)&&s.push(n),n--,s.length===i)break}let c=te.tickCount(o);return s.map(u=>u*c)}static searchHightBitFromStart(e,t,n,i,o){let a=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>O.mergeTickArrayBitmap(u)),s=[];for(;n<7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(a[u].testn(l)&&s.push(n),n++,s.length===i)break}let c=te.tickCount(o);return s.map(u=>u*c)}static checkIsOutOfBoundary(e){return e<Ee||e>_e}static nextInitTick(e,t,n,i,o){if(te.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let s=Math.floor((t-e.startTickIndex)/n);if(i)for(;s>=0;){if(e.ticks[s].liquidityGross.gtn(0))return e.ticks[s];s=s-1}else for(o||(s=s+1);s<Te;){if(e.ticks[s].liquidityGross.gtn(0))return e.ticks[s];s=s+1}return null}static firstInitializedTick(e,t){if(t){let n=Te-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<Te;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let i=j.getSqrtPriceX64FromTick(t),o=j.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:o,tickSqrtPriceX64:i}:{tick:t,price:new N(1).div(o),tickSqrtPriceX64:i}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let i=n?t:new N(1).div(t),o=_t.getTickWithPriceAndTickspacing(i,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),a=j.getSqrtPriceX64FromTick(o),s=j.sqrtPriceX64ToPrice(a,e.mintA.decimals,e.mintB.decimals);return n?{tick:o,price:s}:{tick:o,price:new N(1).div(s)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let i=j.getSqrtPriceX64FromTick(t),o=j.sqrtPriceX64ToPrice(i,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:o,tickSqrtPriceX64:i}:{tick:t,price:new N(1).div(o),tickSqrtPriceX64:i}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let i=n?t:new N(1).div(t),o=_t.getTickWithPriceAndTickspacing(i,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),a=j.getSqrtPriceX64FromTick(o),s=j.sqrtPriceX64ToPrice(a,e.mintA.decimals,e.mintB.decimals);return n?{tick:o,price:s}:{tick:o,price:new N(1).div(s)}}};var Ly=M([he(8),V("bump"),Lt("index"),K(""),Me("protocolFeeRate"),Me("tradeFeeRate"),Lt("tickSpacing"),q(b(),8,"")]),Mu=M([Me("blockTimestamp"),Zt("tickCumulative"),q(b(),4)]),vo=M([he(8),Pe("initialized"),b("recentEpoch"),Lt("observationIndex"),K("poolId"),q(Mu,100,"observations"),q(b(),4)]),vu=M([V("rewardState"),b("openTime"),b("endTime"),b("lastUpdateTime"),D("emissionsPerSecondX64"),b("rewardTotalEmissioned"),b("rewardClaimed"),K("tokenMint"),K("tokenVault"),K("creator"),D("rewardGrowthGlobalX64")]),Co=M([he(8),V("bump"),K("ammConfig"),K("creator"),K("mintA"),K("mintB"),K("vaultA"),K("vaultB"),K("observationId"),V("mintDecimalsA"),V("mintDecimalsB"),Lt("tickSpacing"),D("liquidity"),D("sqrtPriceX64"),ce("tickCurrent"),Me(),D("feeGrowthGlobalX64A"),D("feeGrowthGlobalX64B"),b("protocolFeesTokenA"),b("protocolFeesTokenB"),D("swapInAmountTokenA"),D("swapOutAmountTokenB"),D("swapInAmountTokenB"),D("swapOutAmountTokenA"),V("status"),q(V(),7,""),q(vu,3,"rewardInfos"),q(b(),16,"tickArrayBitmap"),b("totalFeesTokenA"),b("totalFeesClaimedTokenA"),b("totalFeesTokenB"),b("totalFeesClaimedTokenB"),b("fundFeesTokenA"),b("fundFeesTokenB"),b("startTime"),q(b(),15*4-3,"padding")]),Eu=M([D("growthInsideLastX64"),b("rewardAmountOwed")]),Ro=M([he(8),V("bump"),K("nftMint"),K("poolId"),ce("tickLower"),ce("tickUpper"),D("liquidity"),D("feeGrowthInsideLastX64A"),D("feeGrowthInsideLastX64B"),b("tokenFeesOwedA"),b("tokenFeesOwedB"),q(Eu,3,"rewardInfos"),q(b(),8,"")]),Ny=M([he(8),V("bump"),K("poolId"),ce("tickLowerIndex"),ce("tickUpperIndex"),D("liquidity"),D("feeGrowthInsideLastX64A"),D("feeGrowthInsideLastX64B"),b("tokenFeesOwedA"),b("tokenFeesOwedB"),q(D(),3,"rewardGrowthInside"),q(b(),8,"")]),_u=M([ce("tick"),oo("liquidityNet"),D("liquidityGross"),D("feeGrowthOutsideX64A"),D("feeGrowthOutsideX64B"),q(D(),3,"rewardGrowthsOutsideX64"),q(Me(),13,"")]),Pn=M([he(8),K("poolId"),ce("startTickIndex"),q(_u,Te,"ticks"),V("initializedTickCount"),q(V(),115,"")]),Cy=M([he(329),q(K(),100,"whitelistMints")]),Mo=M([he(8),K("poolId"),q(q(b(),8),Qr,"positiveTickArrayBitmap"),q(q(b(),8),Qr,"negativeTickArrayBitmap")]),Ry=M([b(),V("bump"),K("owner"),K("poolId"),K("positionId"),K("nftAccount"),q(b(),8)]),My=M([he(8),V("bump"),K("lockOwner"),K("poolId"),K("positionId"),K("nftAccount"),K("lockNftMint"),b("recentEpoch"),q(b(),8)]);vo.span;var Eo=oe("Raydium_Clmm"),De={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],openPositionWithTokenEx:[77,255,174,82,125,29,201,46],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},_o=[188,37,179,131,82,150,84,73],Vo=[16,72,250,198,14,162,212,19],Jt=class{static createPoolInstruction(e,t,n,i,o,a,s,c,u,l,m,d,p,f){let y=M([D("sqrtPriceX64"),b("zero")]),g=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:dt.programId,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},...f?.map(k=>({pubkey:k,isSigner:!1,isWritable:!1}))||[]],w=Buffer.alloc(y.span);y.encode({sqrtPriceX64:p,zero:de},w);let h=Buffer.from([...De.createPool,...w]);return new Ie({keys:g,programId:e,data:h})}static async createPoolInstructions(e){let{programId:t,owner:n,mintA:i,mintB:o,ammConfigId:a,initialPriceX64:s,extendMintAccount:c}=e,[u,l]=[new C(i.address),new C(o.address)],{publicKey:m}=So(t,a,u,l),{publicKey:d}=Io(t,m),{publicKey:p}=Ur(t,m,u),{publicKey:f}=Ur(t,m,l),y=Be(t,m).publicKey,g=[this.createPoolInstruction(t,m,n,a,d,u,p,new C(i.programId||se),l,f,new C(o.programId||se),y,s,c)];return{signers:[],instructions:g,instructionTypes:[Q.CreateAccount,Q.ClmmCreatePool],address:{poolId:m,observationId:d,exBitmapAccount:y,mintAVault:p,mintBVault:f},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,i,o,a,s,c,u,l,m,d,p,f,y,g,w,h,k,P,T,A,S,L,x,R){let v=M([ce("tickLowerIndex"),ce("tickUpperIndex"),ce("tickArrayLowerStartIndex"),ce("tickArrayUpperStartIndex"),D("liquidity"),b("amountMaxA"),b("amountMaxB"),Pe("withMetadata"),V("optionBaseFlag"),Pe("baseFlag")]),W=[...R?[{pubkey:R,isSigner:!1,isWritable:!0}]:[]],X=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:dt.programId,isSigner:!1,isWritable:!1},{pubkey:se,isSigner:!1,isWritable:!1},{pubkey:xn,isSigner:!1,isWritable:!1},{pubkey:St,isSigner:!1,isWritable:!1},{pubkey:fe,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},{pubkey:w,isSigner:!1,isWritable:!1},...W],$=Buffer.alloc(v.span);v.encode({tickLowerIndex:h,tickUpperIndex:k,tickArrayLowerStartIndex:P,tickArrayUpperStartIndex:T,liquidity:A,amountMaxA:S,amountMaxB:L,withMetadata:x==="create",baseFlag:!1,optionBaseFlag:0},$);let J=Buffer.from([...De.openPosition,...$]);return new Ie({keys:X,programId:e,data:J})}static openPositionFromLiquidityInstruction22(e,t,n,i,o,a,s,c,u,l,m,d,p,f,y,g,w,h,k,P,T,A,S,L,x){let R=M([ce("tickLowerIndex"),ce("tickUpperIndex"),ce("tickArrayLowerStartIndex"),ce("tickArrayUpperStartIndex"),D("liquidity"),b("amountMaxA"),b("amountMaxB"),Pe("withMetadata"),V("optionBaseFlag"),Pe("baseFlag")]),v=[...x?[{pubkey:x,isSigner:!1,isWritable:!0}]:[]],W=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:dt.programId,isSigner:!1,isWritable:!1},{pubkey:se,isSigner:!1,isWritable:!1},{pubkey:xn,isSigner:!1,isWritable:!1},{pubkey:fe,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...v],X=Buffer.alloc(R.span);R.encode({tickLowerIndex:w,tickUpperIndex:h,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:P,liquidity:T,amountMaxA:A,amountMaxB:S,withMetadata:L==="create",baseFlag:!1,optionBaseFlag:0},X);let $=Buffer.from([...De.openPositionWithTokenEx,...X]);return new Ie({keys:W,programId:e,data:$})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:o,liquidity:a,amountMaxA:s,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d=[],[p,f]=[new C(e.programId),new C(e.id)],y;if(l)y=new C((await l(1))[0]);else{let x=nr.generate();d.push(x),y=x.publicKey}let g=O.getTickArrayStartIndexByTick(i,e.config.tickSpacing),w=O.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:h}=ie(p,f,g),{publicKey:k}=ie(p,f,w),{publicKey:P}=m?ue(n.wallet,y,fe):ue(n.wallet,y,se),{publicKey:T}=hn(y),{publicKey:A}=We(p,y),{publicKey:S}=At(p,f,i,o),L=m?this.openPositionFromLiquidityInstruction22(p,n.feePayer,f,n.wallet,y,P,S,h,k,A,n.tokenAccountA,n.tokenAccountB,new C(t.vault.A),new C(t.vault.B),new C(e.mintA.address),new C(e.mintB.address),i,o,g,w,a,s,c,u,we.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[g,w])?Be(p,f).publicKey:void 0):this.openPositionFromLiquidityInstruction(p,n.feePayer,f,n.wallet,y,P,T,S,h,k,A,n.tokenAccountA,n.tokenAccountB,new C(t.vault.A),new C(t.vault.B),new C(e.mintA.address),new C(e.mintB.address),i,o,g,w,a,s,c,u,we.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[g,w])?Be(p,f).publicKey:void 0);return{signers:d,instructions:[L],instructionTypes:[Q.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:y,tickArrayLower:h,tickArrayUpper:k,positionNftAccount:P,metadataAccount:T,personalPosition:A,protocolPosition:S}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:o,base:a,baseAmount:s,otherAmountMax:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d=[],[p,f]=[new C(e.programId),new C(e.id)],y;if(l)y=new C((await l(1))[0]);else{let x=nr.generate();d.push(x),y=x.publicKey}let g=O.getTickArrayStartIndexByTick(i,e.config.tickSpacing),w=O.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:h}=ie(p,f,g),{publicKey:k}=ie(p,f,w),{publicKey:P}=m?ue(n.wallet,y,fe):ue(n.wallet,y,se),{publicKey:T}=hn(y),{publicKey:A}=We(p,y),{publicKey:S}=At(p,f,i,o),L=m?this.openPositionFromBaseInstruction22(p,n.feePayer,f,n.wallet,y,P,S,h,k,A,n.tokenAccountA,n.tokenAccountB,new C(t.vault.A),new C(t.vault.B),new C(e.mintA.address),new C(e.mintB.address),i,o,g,w,u,a,s,c,we.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[g,w])?Be(p,f).publicKey:void 0):this.openPositionFromBaseInstruction(p,n.feePayer,f,n.wallet,y,P,T,S,h,k,A,n.tokenAccountA,n.tokenAccountB,new C(t.vault.A),new C(t.vault.B),new C(e.mintA.address),new C(e.mintB.address),i,o,g,w,u,a,s,c,we.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[g,w])?Be(p,f).publicKey:void 0);return{address:{nftMint:y,tickArrayLower:h,tickArrayUpper:k,positionNftAccount:P,metadataAccount:T,personalPosition:A,protocolPosition:S},instructions:[L],signers:d,instructionTypes:[Q.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,i,o,a,s,c,u,l,m,d,p,f,y,g,w,h,k,P,T,A,S,L,x,R){let v=M([ce("tickLowerIndex"),ce("tickUpperIndex"),ce("tickArrayLowerStartIndex"),ce("tickArrayUpperStartIndex"),D("liquidity"),b("amountMaxA"),b("amountMaxB"),Pe("withMetadata"),V("optionBaseFlag"),Pe("baseFlag")]),W=[...R?[{pubkey:R,isSigner:!1,isWritable:!0}]:[]],X=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:dt.programId,isSigner:!1,isWritable:!1},{pubkey:se,isSigner:!1,isWritable:!1},{pubkey:xn,isSigner:!1,isWritable:!1},{pubkey:St,isSigner:!1,isWritable:!1},{pubkey:fe,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},{pubkey:w,isSigner:!1,isWritable:!1},...W],$=Buffer.alloc(v.span);v.encode({tickLowerIndex:h,tickUpperIndex:k,tickArrayLowerStartIndex:P,tickArrayUpperStartIndex:T,liquidity:new Hr(0),amountMaxA:S==="MintA"?L:x,amountMaxB:S==="MintA"?x:L,withMetadata:A==="create",baseFlag:S==="MintA",optionBaseFlag:1},$);let J=Buffer.from([...De.openPosition,...$]);return new Ie({keys:X,programId:e,data:J})}static openPositionFromBaseInstruction22(e,t,n,i,o,a,s,c,u,l,m,d,p,f,y,g,w,h,k,P,T,A,S,L,x){let R=M([ce("tickLowerIndex"),ce("tickUpperIndex"),ce("tickArrayLowerStartIndex"),ce("tickArrayUpperStartIndex"),D("liquidity"),b("amountMaxA"),b("amountMaxB"),Pe("withMetadata"),V("optionBaseFlag"),Pe("baseFlag")]),v=[...x?[{pubkey:x,isSigner:!1,isWritable:!0}]:[]],W=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:dt.programId,isSigner:!1,isWritable:!1},{pubkey:se,isSigner:!1,isWritable:!1},{pubkey:xn,isSigner:!1,isWritable:!1},{pubkey:fe,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...v],X=Buffer.alloc(R.span);R.encode({tickLowerIndex:w,tickUpperIndex:h,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:P,liquidity:new Hr(0),amountMaxA:A==="MintA"?S:L,amountMaxB:A==="MintA"?L:S,withMetadata:T==="create",baseFlag:A==="MintA",optionBaseFlag:1},X);let $=Buffer.from([...De.openPositionWithTokenEx,...X]);return new Ie({keys:W,programId:e,data:$})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:i,tickUpper:o,liquidity:a,amountMaxA:s,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d,p=[];if(l)d=new C((await l(1))[0]);else{let x=nr.generate();p.push(x),d=x.publicKey}let[f,y]=[new C(e.programId),new C(e.id)],g=O.getTickArrayStartIndexByTick(i,e.config.tickSpacing),w=O.getTickArrayStartIndexByTick(o,e.config.tickSpacing),{publicKey:h}=ie(f,y,g),{publicKey:k}=ie(f,y,w),{publicKey:P}=m?ue(n.wallet,d,fe):ue(n.wallet,d,se),{publicKey:T}=hn(d),{publicKey:A}=We(f,d),{publicKey:S}=At(f,y,i,o),L=m?this.openPositionFromLiquidityInstruction22(f,n.wallet,y,n.wallet,d,P,S,h,k,A,n.tokenAccountA,n.tokenAccountB,new C(t.vault.A),new C(t.vault.B),new C(t.mintA.address),new C(t.mintB.address),i,o,g,w,a,s,c,u,we.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[g,w])?Be(f,y).publicKey:void 0):this.openPositionFromLiquidityInstruction(f,n.wallet,y,n.wallet,d,P,T,S,h,k,A,n.tokenAccountA,n.tokenAccountB,new C(t.vault.A),new C(t.vault.B),new C(t.mintA.address),new C(t.mintB.address),i,o,g,w,a,s,c,u,we.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[g,w])?Be(f,y).publicKey:void 0);return{address:{nftMint:d,tickArrayLower:h,tickArrayUpper:k,positionNftAccount:P,metadataAccount:T,personalPosition:A,protocolPosition:S},instructions:[L],signers:p,instructionTypes:[Q.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,i,o,a){let s=M([]),c=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:dt.programId,isSigner:!1,isWritable:!1},{pubkey:a?fe:se,isSigner:!1,isWritable:!1}],u=Buffer.alloc(s.span);s.encode({},u);let l=Buffer.from([...De.closePosition,...u]);return new Ie({keys:c,programId:e,data:l})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:i,nft2022:o}){let a=new C(e.programId),s=o?ue(n.wallet,i.nftMint,fe).publicKey:ue(n.wallet,i.nftMint,se).publicKey,{publicKey:c}=We(a,i.nftMint),u=[];return u.push(this.closePositionInstruction(a,n.wallet,i.nftMint,s,c,o)),{address:{positionNftAccount:s,personalPosition:c},signers:[],instructions:u,instructionTypes:[Q.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,i,o,a,s,c,u,l,m,d,p,f,y,g,w,h){let k=M([D("liquidity"),b("amountMaxA"),b("amountMaxB"),V("optionBaseFlag"),Pe("baseFlag")]),P=[...h?[{pubkey:h,isSigner:!1,isWritable:!0}]:[]],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:se,isSigner:!1,isWritable:!1},{pubkey:fe,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...P],A=Buffer.alloc(k.span);k.encode({liquidity:y,amountMaxA:g,amountMaxB:w,optionBaseFlag:0,baseFlag:!1},A);let S=Buffer.from([...De.increaseLiquidity,...A]);return new Ie({keys:T,programId:e,data:S})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:o,amountMaxA:a,amountMaxB:s,nft2022:c}){let[u,l]=[new C(e.programId),new C(e.id)],m=O.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=O.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=ie(u,l,m),{publicKey:f}=ie(u,l,d),{publicKey:y}=c?ue(i.wallet,n.nftMint,fe):ue(i.wallet,n.nftMint,se),{publicKey:g}=We(u,n.nftMint),{publicKey:w}=At(u,l,n.tickLower,n.tickUpper),h=this.increasePositionFromLiquidityInstruction(u,i.wallet,y,g,l,w,p,f,i.tokenAccountA,i.tokenAccountB,new C(t.vault.A),new C(t.vault.B),new C(e.mintA.address),new C(e.mintB.address),o,a,s,we.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?Be(u,l).publicKey:void 0);return{address:{tickArrayLower:p,tickArrayUpper:f,positionNftAccount:y,personalPosition:g,protocolPosition:w},signers:[],instructions:[h],instructionTypes:[Q.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,base:o,baseAmount:a,otherAmountMax:s,nft2022:c}){let[u,l]=[new C(e.programId),new C(e.id)],m=O.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=O.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=ie(u,l,m),{publicKey:f}=ie(u,l,d),{publicKey:y}=c?ue(i.wallet,n.nftMint,fe):ue(i.wallet,n.nftMint,se),{publicKey:g}=We(u,n.nftMint),{publicKey:w}=At(u,l,n.tickLower,n.tickUpper);return{address:{tickArrayLower:p,tickArrayUpper:f,positionNftAccount:y,personalPosition:g,protocolPosition:w},instructions:[this.increasePositionFromBaseInstruction(u,i.wallet,y,g,l,w,p,f,i.tokenAccountA,i.tokenAccountB,new C(t.vault.A),new C(t.vault.B),new C(e.mintA.address),new C(e.mintB.address),o,a,s,we.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?Be(u,l).publicKey:void 0)],signers:[],instructionTypes:[Q.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,i,o,a,s,c,u,l,m,d,p,f,y,g,w,h){let k=M([D("liquidity"),b("amountMaxA"),b("amountMaxB"),V("optionBaseFlag"),Pe("baseFlag")]),P=[...h?[{pubkey:h,isSigner:!1,isWritable:!0}]:[]],T=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:se,isSigner:!1,isWritable:!1},{pubkey:fe,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...P],A=Buffer.alloc(k.span);k.encode({liquidity:new Hr(0),amountMaxA:y==="MintA"?g:w,amountMaxB:y==="MintA"?w:g,baseFlag:y==="MintA",optionBaseFlag:1},A);let S=Buffer.from([...De.increaseLiquidity,...A]);return new Ie({keys:T,programId:e,data:S})}static decreaseLiquidityInstruction(e,t,n,i,o,a,s,c,u,l,m,d,p,f,y,g,w,h,k){let P=M([D("liquidity"),b("amountMinA"),b("amountMinB")]),T=[...k?[{pubkey:k,isSigner:!1,isWritable:!0}]:[],...y.map(x=>[{pubkey:x.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:x.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:x.rewardMint,isSigner:!1,isWritable:!1}]).flat()],A=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:se,isSigner:!1,isWritable:!1},{pubkey:fe,isSigner:!1,isWritable:!1},{pubkey:On,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...T],S=Buffer.alloc(P.span);P.encode({liquidity:g,amountMinA:w,amountMinB:h},S);let L=Buffer.from([...De.decreaseLiquidity,...S]);return new Ie({keys:A,programId:e,data:L})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:i,liquidity:o,amountMinA:a,amountMinB:s,programId:c,nft2022:u}){let[l,m]=[new C(e.programId),new C(e.id)],d=O.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),p=O.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:f}=ie(l,m,d),{publicKey:y}=ie(l,m,p),{publicKey:g}=u?ue(i.wallet,n.nftMint,fe):ue(i.wallet,n.nftMint,c),{publicKey:w}=We(l,n.nftMint),{publicKey:h}=At(l,m,n.tickLower,n.tickUpper),k=[];for(let A=0;A<e.rewardDefaultInfos.length;A++)k.push({poolRewardVault:new C(t.rewardInfos[A].vault),ownerRewardVault:i.rewardAccounts[A],rewardMint:new C(e.rewardDefaultInfos[A].mint.address)});let P=[],T=this.decreaseLiquidityInstruction(l,i.wallet,g,w,m,h,f,y,i.tokenAccountA,i.tokenAccountB,new C(t.vault.A),new C(t.vault.B),new C(e.mintA.address),new C(e.mintB.address),k,o,a,s,we.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[d,p])?Be(l,m).publicKey:void 0);return P.push(T),{address:{tickArrayLower:f,tickArrayUpper:y,positionNftAccount:g,personalPosition:w,protocolPosition:h},signers:[],instructions:P,instructionTypes:[Q.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,i,o,a,s,c,u,l,m,d,p,f,y,g,w){let h=M([b("amount"),b("otherAmountThreshold"),D("sqrtPriceLimitX64"),Pe("isBaseInput")]),k=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[],...m.map(S=>({pubkey:S,isSigner:!1,isWritable:!0}))],P=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:se,isSigner:!1,isWritable:!1},{pubkey:fe,isSigner:!1,isWritable:!1},{pubkey:On,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...k],T=Buffer.alloc(h.span);h.encode({amount:p,otherAmountThreshold:f,sqrtPriceLimitX64:y,isBaseInput:g},T);let A=Buffer.from([...De.swap,...T]);return new Ie({keys:P,programId:e,data:A})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,inputMint:o,amountIn:a,amountOutMin:s,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new C(e.programId),new C(e.id)],[d,p]=[new C(t.vault.A),new C(t.vault.B)],[f,y]=[new C(e.mintA.address),new C(e.mintB.address)],g=e.mintA.address===o.toString(),w=[this.swapInstruction(l,i.wallet,m,new C(e.config.id),g?i.tokenAccountA:i.tokenAccountB,g?i.tokenAccountB:i.tokenAccountA,g?d:p,g?p:d,g?f:y,g?y:f,u,n,a,s,c,!0,Be(l,m).publicKey)];return{signers:[],instructions:w,instructionTypes:[Q.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static makeSwapBaseOutInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:i,outputMint:o,amountOut:a,amountInMax:s,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new C(e.programId),new C(e.id)],[d,p]=[new C(t.vault.A),new C(t.vault.B)],[f,y]=[new C(e.mintA.address),new C(e.mintB.address)],g=e.mintA.address===o.toBase58(),w=[this.swapInstruction(l,i.wallet,m,new C(e.config.id),g?i.tokenAccountB:i.tokenAccountA,g?i.tokenAccountA:i.tokenAccountB,g?p:d,g?d:p,g?y:f,g?f:y,u,n,a,s,c,!1,Be(l,m).publicKey)];return{signers:[],instructions:w,instructionTypes:[Q.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,i,o,a,s,c,u,l,m,d){let p=M([b("openTime"),b("endTime"),D("emissionsPerSecondX64")]),f=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:dt.programId,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1}],y=Buffer.alloc(p.span);p.encode({openTime:ee(l),endTime:ee(m),emissionsPerSecondX64:d},y);let g=Buffer.from([...De.initReward,...y]);return new Ie({keys:f,programId:e,data:g})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[o,a]=[new C(e.programId),new C(e.id)],s=Bo(o,a,i.mint).publicKey,c=Gr(o).publicKey,u=[this.initRewardInstruction(o,n.wallet,a,c,new C(e.config.id),n.tokenAccount,i.programId,i.mint,s,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{poolRewardVault:s,operationId:c},signers:[],instructions:u,instructionTypes:[Q.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,i,o,a,s,c,u,l,m,d){let p=M([V("rewardIndex"),D("emissionsPerSecondX64"),b("openTime"),b("endTime")]),f=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:se,isSigner:!1,isWritable:!1},{pubkey:fe,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0}],y=Buffer.alloc(p.span);p.encode({rewardIndex:u,emissionsPerSecondX64:d,openTime:ee(l),endTime:ee(m)},y);let g=Buffer.from([...De.setRewardEmissions,...y]);return new Ie({keys:f,programId:e,data:g})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:i}){let[o,a]=[new C(e.programId),new C(e.id)],s,c,u;for(let d=0;d<e.rewardDefaultInfos.length;d++)e.rewardDefaultInfos[d].mint.address===i.mint.toString()&&(s=d,c=new C(t.rewardInfos[d].vault),u=new C(t.rewardInfos[d].mint.address));(s===void 0||c===void 0)&&Eo.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=Gr(o).publicKey,m=[this.setRewardInstruction(o,n.wallet,a,l,new C(e.config.id),n.tokenAccount,c,u,s,i.openTime,i.endTime,i.emissionsPerSecondX64)];return{address:{rewardVault:c,operationId:l},signers:[],instructions:m,instructionTypes:[Q.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,i,o,a,s){let c=M([V("rewardIndex")]),u=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:se,isSigner:!1,isWritable:!1},{pubkey:fe,isSigner:!1,isWritable:!1},{pubkey:On,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({rewardIndex:s},l);let m=Buffer.from([...De.collectReward,...l]);return new Ie({keys:u,programId:e,data:m})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:i}){let[o,a]=[new C(e.programId),new C(e.id)],s,c;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===i.toString()&&(s=l,c=new C(t.rewardInfos[l].vault));(s===void 0||c===void 0)&&Eo.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let u=[this.collectRewardInstruction(o,n.wallet,a,n.tokenAccount,c,i,s)];return{address:{rewardVault:c},signers:[],instructions:u,instructionTypes:[Q.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static async makeLockPositions({programId:e,authProgramId:t,poolProgramId:n,payer:i,wallet:o,nftMint:a,nft2022:s,getEphemeralSigners:c}){let u=[],l;if(c)l=new C((await c(1))[0]);else{let w=nr.generate();u.push(w),l=w.publicKey}let m=s?ue(o,a,fe).publicKey:ue(o,a,se).publicKey,{publicKey:d}=We(n,a),p=Lo(e,l).publicKey,f=ue(o,l,se).publicKey,y=hn(l).publicKey,g=Jt.lockPositionInstructionV2({programId:e,auth:t,payer:i,positionOwner:o,lockOwner:o,positionNftAccount:m,positionId:d,lockPositionId:p,lockNftMint:l,lockNftAccount:f,metadataAccount:y,withMetadata:!0,nft2022:s,positionNftMint:a,authPositionNftAccount:ue(t,a,s?fe:se).publicKey,positionNftProgram:s?fe:se});return{address:{positionId:d,lockPositionId:p,lockNftAccount:f,lockNftMint:l,positionNftAccount:m,metadataAccount:y},instructions:[g],signers:u,instructionTypes:[Q.ClmmLockPosition],lookupTableAddress:[]}}static lockPositionInstructionV2({programId:e,auth:t,payer:n,positionOwner:i,lockOwner:o,positionNftAccount:a,positionId:s,positionNftMint:c,authPositionNftAccount:u,positionNftProgram:l,lockPositionId:m,lockNftMint:d,lockNftAccount:p,metadataAccount:f,withMetadata:y}){let g=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!0,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:St,isSigner:!1,isWritable:!1},{pubkey:xn,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:se,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:dt.programId,isSigner:!1,isWritable:!1}],w=M([Pe("withMetadata")]),h=Buffer.alloc(w.span);w.encode({withMetadata:y},h);let k=Buffer.from([..._o,...h]);return new Ie({keys:g,programId:e,data:k})}static lockPositionInstruction({programId:e,authProgramId:t,poolProgramId:n,owner:i,positionNft:o}){let{publicKey:a}=ue(i,o,se),{publicKey:s}=We(n,o),c=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:Xr(e,s).publicKey,isSigner:!1,isWritable:!0},{pubkey:se,isSigner:!1,isWritable:!1},{pubkey:dt.programId,isSigner:!1,isWritable:!1}];return new Ie({keys:c,programId:e,data:Buffer.from(_o)})}static harvestLockPositionInstruction(e){let[t,n]=[new C(e.poolKeys.programId),new C(e.poolKeys.id)],i=O.getTickArrayStartIndexByTick(e.ownerPosition.tickLower,e.poolKeys.config.tickSpacing),o=O.getTickArrayStartIndexByTick(e.ownerPosition.tickUpper,e.poolKeys.config.tickSpacing),{publicKey:a}=ie(t,n,i),{publicKey:s}=ie(t,n,o),{publicKey:c}=ue(e.owner,e.ownerPosition.nftMint,se),{publicKey:u}=We(t,e.ownerPosition.nftMint),{publicKey:l}=At(t,n,e.ownerPosition.tickLower,e.ownerPosition.tickUpper),m=[];for(let f=0;f<e.poolKeys.rewardInfos.length;f++)m.push({poolRewardVault:new C(e.poolKeys.rewardInfos[f].vault),ownerRewardVault:e.ownerRewardAccounts[f],rewardMint:new C(e.poolKeys.rewardInfos[f].mint.address)});let d=[...m.map(f=>[{pubkey:f.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:f.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:f.rewardMint,isSigner:!1,isWritable:!1}]).flat()],p=[{pubkey:e.authProgramId,isSigner:!1,isWritable:!1},{pubkey:Xr(e.programId,u).publicKey,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e.owner,isSigner:!0,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:new C(e.poolKeys.vault.A),isSigner:!1,isWritable:!0},{pubkey:new C(e.poolKeys.vault.B),isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:e.userVaultA,isSigner:!1,isWritable:!0},{pubkey:e.userVaultB,isSigner:!1,isWritable:!0},{pubkey:se,isSigner:!1,isWritable:!1},{pubkey:fe,isSigner:!1,isWritable:!1},{pubkey:Tr,isSigner:!1,isWritable:!1},{pubkey:new C(e.poolKeys.mintA.address),isSigner:!1,isWritable:!1},{pubkey:new C(e.poolKeys.mintB.address),isSigner:!1,isWritable:!1},...d];return new Ie({keys:p,programId:e.programId,data:Buffer.from(Vo)})}static harvestLockPositionInstructionV2({programId:e,auth:t,lockPositionId:n,clmmProgram:i,lockOwner:o,lockNftMint:a,lockNftAccount:s,positionNftAccount:c,positionId:u,poolId:l,protocolPosition:m,vaultA:d,vaultB:p,tickArrayLower:f,tickArrayUpper:y,userVaultA:g,userVaultB:w,mintA:h,mintB:k,rewardAccounts:P,exTickArrayBitmap:T}){let A=[...T?[{pubkey:T,isSigner:!1,isWritable:!0}]:[],...P.map(L=>[{pubkey:L.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:L.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:L.rewardMint,isSigner:!1,isWritable:!1}]).flat()],S=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0},{pubkey:w,isSigner:!1,isWritable:!0},{pubkey:se,isSigner:!1,isWritable:!1},{pubkey:fe,isSigner:!1,isWritable:!1},{pubkey:Tr,isSigner:!1,isWritable:!1},{pubkey:h,isSigner:!1,isWritable:!1},{pubkey:k,isSigner:!1,isWritable:!1},...A];return new Ie({keys:S,programId:e,data:Buffer.from(Vo)})}};var jr=(...r)=>r.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),$t=class{scope;disabled=!1;logger;constructor({scope:e,moduleName:t}){this.scope=e,this.logger=oe(t)}createTxBuilder(e){return this.scope.checkOwner(),new Qn({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,blockhashCommitment:this.scope.blockhashCommitment,loopMultiTxStatus:this.scope.loopMultiTxStatus,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(jr(e))}logInfo(...e){this.logger.info(jr(e))}logAndCreateError(...e){let t=jr(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};var Vu=M([Me("mintAuthorityOption"),K("mintAuthority"),b("supply"),V("decimals"),V("isInitialized"),Me("freezeAuthorityOption"),K("freezeAuthority")]);import{PublicKey as ig}from"@solana/web3.js";import{MintLayout as sg,TOKEN_PROGRAM_ID as ug}from"@solana/spl-token";var Oo=r=>new Re({mint:r.address,decimals:r.decimals,symbol:r.symbol,name:r.name});var rr=({address:r,programId:e,decimals:t,...n})=>({chainId:101,address:zt(r).toBase58(),programId:e,logoURI:"",symbol:"",name:"",decimals:t,tags:[],extensions:n.extensions||{},...n});import Wo from"bn.js";var Zr=new Wo(25),ir=new Wo(1e4);import{PublicKey as nt,SystemProgram as Yu,SYSVAR_RENT_PUBKEY as Cg,TransactionInstruction as tn}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Ju,TOKEN_PROGRAM_ID as Bn}from"@solana/spl-token";var Yr=M([V("instruction"),b("amountIn"),b("minAmountOut")]),Jr=M([V("instruction"),b("maxAmountIn"),b("amountOut")]),Tg=M([V("instruction"),V("nonce")]),Ou=M([V("instruction"),V("nonce"),b("startTime")]),$r=M([b("status"),b("nonce"),b("maxOrder"),b("depth"),b("baseDecimal"),b("quoteDecimal"),b("state"),b("resetFlag"),b("minSize"),b("volMaxCutRatio"),b("amountWaveRatio"),b("baseLotSize"),b("quoteLotSize"),b("minPriceMultiplier"),b("maxPriceMultiplier"),b("systemDecimalValue"),b("minSeparateNumerator"),b("minSeparateDenominator"),b("tradeFeeNumerator"),b("tradeFeeDenominator"),b("pnlNumerator"),b("pnlDenominator"),b("swapFeeNumerator"),b("swapFeeDenominator"),b("baseNeedTakePnl"),b("quoteNeedTakePnl"),b("quoteTotalPnl"),b("baseTotalPnl"),b("poolOpenTime"),b("punishPcAmount"),b("punishCoinAmount"),b("orderbookToInitTime"),D("swapBaseInAmount"),D("swapQuoteOutAmount"),b("swapBase2QuoteFee"),D("swapQuoteInAmount"),D("swapBaseOutAmount"),b("swapQuote2BaseFee"),K("baseVault"),K("quoteVault"),K("baseMint"),K("quoteMint"),K("lpMint"),K("openOrders"),K("marketId"),K("marketProgramId"),K("targetOrders"),K("withdrawQueue"),K("lpVault"),K("owner"),b("lpReserve"),q(b(),3,"padding")]),xg=M([b("accountType"),b("status"),b("nonce"),b("maxOrder"),b("depth"),b("baseDecimal"),b("quoteDecimal"),b("state"),b("resetFlag"),b("minSize"),b("volMaxCutRatio"),b("amountWaveRatio"),b("baseLotSize"),b("quoteLotSize"),b("minPriceMultiplier"),b("maxPriceMultiplier"),b("systemDecimalsValue"),b("abortTradeFactor"),b("priceTickMultiplier"),b("priceTick"),b("minSeparateNumerator"),b("minSeparateDenominator"),b("tradeFeeNumerator"),b("tradeFeeDenominator"),b("pnlNumerator"),b("pnlDenominator"),b("swapFeeNumerator"),b("swapFeeDenominator"),b("baseNeedTakePnl"),b("quoteNeedTakePnl"),b("quoteTotalPnl"),b("baseTotalPnl"),b("poolOpenTime"),b("punishPcAmount"),b("punishCoinAmount"),b("orderbookToInitTime"),D("swapBaseInAmount"),D("swapQuoteOutAmount"),D("swapQuoteInAmount"),D("swapBaseOutAmount"),b("swapQuote2BaseFee"),b("swapBase2QuoteFee"),K("baseVault"),K("quoteVault"),K("baseMint"),K("quoteMint"),K("lpMint"),K("modelDataAccount"),K("openOrders"),K("marketId"),K("marketProgramId"),K("targetOrders"),K("owner"),q(b(),64,"padding")]),ei=M([V("instruction"),b("baseAmountIn"),b("quoteAmountIn"),b("fixedSide"),b("otherAmountMin")]),ti=M([V("instruction"),b("lpAmount"),b("baseAmountMin"),b("quoteAmountMin")]);var Fo=M([b("fee")]);import{PublicKey as Wu}from"@solana/web3.js";var en=new Wu("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Ot=5e4,Fu=M([b("x"),b("y"),b("price")]),Du=M([b("accountType"),b("status"),b("multiplier"),b("validDataCount"),q(Fu,Ot,"DataElement")]);function qu(r,e){return[0,Ot-2]}function Uu(r){return[0,Ot-2]}function Gu(r){return[0,Ot-2]}function Xu(r,e,t){let[n,i]=qu(e,t),o=n,a=i,s=0,c=e*r.multiplier/t;for(;o<=a;){if(s=Math.floor((a+o)/2),s===0||s>=Ot-2)return[s,s,!1];let u=r.DataElement[s].x*r.multiplier/r.DataElement[s].y,l=r.DataElement[s-1].x*r.multiplier/r.DataElement[s-1].y,m=r.DataElement[s+1].x*r.multiplier/r.DataElement[s+1].y;if(c===u)return[s,s,!0];if(c===l)return[s-1,s-1,!0];if(c===m)return[s+1,s+1,!0];if(c<l)a=s-1;else{if(c>l&&c<u)return[s-1,s,!0];if(c>u&&c<m)return[s,s+1,!0];o=s+1}}return[s,s,!1]}function ni(r,e,t){let[n,i,o]=Xu(r,e,t);if(!o)return 0;if(n===i){let a=r.DataElement[n].x;return e*r.multiplier/a}else{let a=r.DataElement[n].x,s=r.DataElement[n].y,c=r.DataElement[i].x,u=r.DataElement[i].y,l=t*(c*s-a*u),m=a*l,d=(c-a)*(e*s-a*t)*u,p=m+d;return e*r.multiplier*l/p}}function Vt(r,e,t){return e*r.multiplier/t}function Do(r,e,t){return e*t/r.multiplier}function Qu(r,e){let[t,n]=Uu(e),i=t,o=n,a=0,s=e;for(;i<o;){if(a=Math.floor((o+i)/2),a<=0||a>Ot-2)return[a,a,!1];let c=r.DataElement[a].x,u=r.DataElement[a-1].x,l=r.DataElement[a+1].x;if(s===c)return[a,a,!0];if(s===u)return[a-1,a-1,!0];if(s===l)return[a+1,a+1,!0];if(s<u)o=a-1;else{if(s>u&&s<c)return[a-1,a,!0];if(s>c&&s<l)return[a,a+1,!0];i=a+1}}return[a,a,!1]}function zu(r,e){let[t,n]=Gu(e),i=t,o=n,a=0,s=e;for(;i<=o;){if(a=Math.floor((o+i)/2),a<=0||a>=Ot-2)return[a,a,!1];let c=r.DataElement[a].y,u=r.DataElement[a-1].y,l=r.DataElement[a+1].y;if(s===c)return[a,a,!0];if(s===u)return[a-1,a-1,!0];if(s===l)return[a+1,a+1,!0];if(s<l)i=a+1;else{if(s<u&&s>c)return[a-1,a,!0];if(s<c&&s>l)return[a,a+1,!0];o=a-1}}return[a,a,!1]}function qo(r,e,t,n){let i=n?e+t:e-t,[o,a,s]=Qu(r,i);if(!s)return[0,0,!1,s];if(o===a)return[r.DataElement[a].price,r.DataElement[a].y,!1,s];{let c=r.DataElement[o].x,u=r.DataElement[a].x,l=r.DataElement[o].price,m=r.DataElement[a].price,d=r.DataElement[o].y,p=r.DataElement[a].y;if(e>=c&&e<=u)return n?[m,p,!0,s]:[l,d,!0,s];{let f,y;return n?(f=l+(m-l)*(e-c)/(u-c),y=d-(i-c)*r.multiplier/m):(f=l+(m-l)*(e-c)/(u-c),y=p+(u-i)*r.multiplier/l),[f,y,!1,s]}}}function Hu(r,e,t,n){let i=n?e-t:e+t,[o,a,s]=zu(r,i);if(!s)return[0,0,!1,s];if(o===a)return[r.DataElement[a].price,r.DataElement[a].x,!1,s];{let c=r.DataElement[o].x,u=r.DataElement[a].x,l=r.DataElement[o].price,m=r.DataElement[a].price,d=r.DataElement[o].y,p=r.DataElement[a].y;if(e>=p&&e<=d)return n?[m,u,!0,s]:[l,c,!0,s];{let f,y;return n?(f=l+(m-l)*(d-e)/(d-p),y=c+m*(d-i)/r.multiplier):(f=l+(m-l)*(d-e)/(d-p),y=u-l*(i-p)/r.multiplier),[f,y,!1,s]}}}function ju(r,e){let t=qo(r,e,0,!1);return t[3]?t[0]:0}function Uo(r,e,t,n){let i=ni(r,e,t),o=Vt(r,e,i),a=Vt(r,t,i),s=Vt(r,n,i),c=!0,[u,l,m,d]=qo(r,o,s,c);if(!d)return 0;if(m)return n*r.multiplier/u;{let p=a-l;return Do(r,p,i)}}function Go(r,e,t,n){let i=ni(r,e,t),o=Vt(r,e,i),a=Vt(r,t,i),s=Vt(r,n,i),c=!1,[u,l,m,d]=Hu(r,a,s,c);if(!d)return 0;if(m)return n*u/r.multiplier;{let p=o-l;return Do(r,p,i)}}function Zu(r){let e=Du.decode(r);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function Xo(r,e,t,n){let i=ju(r,Vt(r,e,ni(r,e,t)))/r.multiplier;return n?i:1/i}var Sn=class{connection;_layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};constructor({connection:e}){this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(en);e&&(this._layoutData=Zu(e?.data))}}};var Qo=oe("Raydium_liquidity_instruction");function zo(r){let{poolInfo:e,poolKeys:t,userKeys:n,baseAmountIn:i,quoteAmountIn:o,fixedSide:a,otherAmountMin:s}=r,c=Buffer.alloc(ei.span);ei.encode({instruction:3,baseAmountIn:ee(i),quoteAmountIn:ee(o),otherAmountMin:ee(s),fixedSide:a==="base"?kt:Vi},c);let u=[B({pubkey:Bn,isWritable:!1}),B({pubkey:new nt(e.id)}),B({pubkey:new nt(t.authority),isWritable:!1}),B({pubkey:new nt(t.openOrders),isWritable:!1}),B({pubkey:new nt(t.targetOrders)}),B({pubkey:new nt(e.lpMint.address)}),B({pubkey:new nt(t.vault.A)}),B({pubkey:new nt(t.vault.B)})];return e.pooltype.includes("StablePool")&&u.push(B({pubkey:en})),u.push(B({pubkey:new nt(e.marketId),isWritable:!1}),B({pubkey:n.baseTokenAccount}),B({pubkey:n.quoteTokenAccount}),B({pubkey:n.lpTokenAccount}),B({pubkey:n.owner,isWritable:!1,isSigner:!0}),B({pubkey:new nt(t.marketEventQueue),isWritable:!1})),new tn({programId:new nt(e.programId),keys:u,data:c})}function ri(r){let{poolInfo:e,poolKeys:t,userKeys:n,lpAmount:i,baseAmountMin:o,quoteAmountMin:a}=r,s=Bt(t),c=4;if(e.pooltype.includes("StablePool")&&(c=5),c===4||c===5){let u=Buffer.alloc(ti.span);ti.encode({instruction:4,lpAmount:ee(i),baseAmountMin:ee(o),quoteAmountMin:ee(a)},u);let l=[B({pubkey:Bn,isWritable:!1}),B({pubkey:s.id}),B({pubkey:s.authority,isWritable:!1}),B({pubkey:s.openOrders}),B({pubkey:s.targetOrders}),B({pubkey:s.mintLp.address}),B({pubkey:s.vault.A}),B({pubkey:s.vault.B})];return c===5?l.push(B({pubkey:en})):(l.push(B({pubkey:s.id})),l.push(B({pubkey:s.id}))),l.push(B({pubkey:s.marketProgramId,isWritable:!1}),B({pubkey:s.marketId}),B({pubkey:s.marketBaseVault}),B({pubkey:s.marketQuoteVault}),B({pubkey:s.marketAuthority,isWritable:!1}),B({pubkey:n.lpTokenAccount}),B({pubkey:n.baseTokenAccount}),B({pubkey:n.quoteTokenAccount}),B({pubkey:n.owner,isWritable:!1,isSigner:!0}),B({pubkey:s.marketEventQueue}),B({pubkey:s.marketBids}),B({pubkey:s.marketAsks})),new tn({programId:s.programId,keys:l,data:u})}return new tn({programId:s.programId,keys:[]})}function ii({programId:r,ammId:e,ammAuthority:t,ammOpenOrders:n,lpMint:i,coinMint:o,pcMint:a,coinVault:s,pcVault:c,withdrawQueue:u,ammTargetOrders:l,poolTempLp:m,marketProgramId:d,marketId:p,userWallet:f,userCoinVault:y,userPcVault:g,userLpVault:w,nonce:h,openTime:k,coinAmount:P,pcAmount:T,ammConfigId:A,feeDestinationId:S}){let L=M([V("instruction"),V("nonce"),b("openTime"),b("pcAmount"),b("coinAmount")]),x=[{pubkey:Bn,isSigner:!1,isWritable:!1},{pubkey:Ju,isSigner:!1,isWritable:!1},{pubkey:Yu.programId,isSigner:!1,isWritable:!1},{pubkey:je,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:A,isSigner:!1,isWritable:!1},{pubkey:S,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!0,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0},{pubkey:w,isSigner:!1,isWritable:!0}],R=Buffer.alloc(L.span);return L.encode({instruction:1,nonce:h,openTime:k,coinAmount:P,pcAmount:T},R),{instruction:new tn({keys:x,programId:r,data:R}),instructionType:Q.AmmV4CreatePool}}function $u({poolKeys:r,userKeys:e,amountIn:t,minAmountOut:n},i){let o=Bt(r),a=Buffer.alloc(Yr.span);Yr.encode({instruction:9,amountIn:ee(t),minAmountOut:ee(n)},a);let s=[B({pubkey:Bn,isWritable:!1}),B({pubkey:o.id}),B({pubkey:o.authority,isWritable:!1}),B({pubkey:o.openOrders})];return i===4&&s.push(B({pubkey:o.targetOrders})),s.push(B({pubkey:o.vault.A}),B({pubkey:o.vault.B})),i===5&&s.push(B({pubkey:en})),s.push(B({pubkey:o.marketProgramId,isWritable:!1}),B({pubkey:o.marketId}),B({pubkey:o.marketBids}),B({pubkey:o.marketAsks}),B({pubkey:o.marketEventQueue}),B({pubkey:o.marketBaseVault}),B({pubkey:o.marketQuoteVault}),B({pubkey:o.marketAuthority,isWritable:!1}),B({pubkey:e.tokenAccountIn}),B({pubkey:e.tokenAccountOut}),B({pubkey:e.owner,isWritable:!1,isSigner:!0})),new tn({programId:o.programId,keys:s,data:a})}function ec({poolKeys:r,userKeys:e,maxAmountIn:t,amountOut:n},i){let o=Bt(r),a=Buffer.alloc(Jr.span);Jr.encode({instruction:11,maxAmountIn:ee(t),amountOut:ee(n)},a);let s=[B({pubkey:Bn,isWritable:!1}),B({pubkey:o.id}),B({pubkey:o.authority,isWritable:!1}),B({pubkey:o.openOrders}),B({pubkey:o.targetOrders}),B({pubkey:o.vault.A}),B({pubkey:o.vault.B})];return i===5&&s.push(B({pubkey:en})),s.push(B({pubkey:o.marketProgramId,isWritable:!1}),B({pubkey:o.marketId}),B({pubkey:o.marketBids}),B({pubkey:o.marketAsks}),B({pubkey:o.marketEventQueue}),B({pubkey:o.marketBaseVault}),B({pubkey:o.marketQuoteVault}),B({pubkey:o.marketAuthority,isWritable:!1}),B({pubkey:e.tokenAccountIn}),B({pubkey:e.tokenAccountOut}),B({pubkey:e.owner,isWritable:!1,isSigner:!0})),new tn({programId:o.programId,keys:s,data:a})}function Ho(r){let{poolKeys:e,version:t,userKeys:n,amountIn:i,amountOut:o,fixedSide:a}=r;if(t===4||t===5){let s={poolKeys:e,userKeys:n};if(a==="in")return $u({...s,amountIn:i,minAmountOut:o},t);if(a==="out")return ec({...s,maxAmountIn:i,amountOut:o},t);Qo.logWithError("invalid params","params",r)}throw Qo.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}import{PublicKey as mc}from"@solana/web3.js";import jw from"bn.js";import{TOKEN_PROGRAM_ID as dc}from"@solana/spl-token";import{PublicKey as tc}from"@solana/web3.js";var nc=oe("Raydium_liquidity_serum");function jo({programId:r,marketId:e}){let t=[e.toBuffer()],n=0,i;for(;n<100;){try{let o=t.concat(Buffer.from([n]),Buffer.alloc(7));i=tc.createProgramAddressSync(o,r)}catch(o){if(o instanceof TypeError)throw o;n++;continue}return{publicKey:i,nonce:n}}throw nc.logWithError("unable to find a viable program address nonce","params",{programId:r,marketId:e}),new Error("unable to find a viable program address nonce")}import{Keypair as ac,PublicKey as uc}from"@solana/web3.js";import cw from"bn.js";import{TOKEN_PROGRAM_ID as cc}from"@solana/spl-token";function rc(r){return r instanceof Uint8Array||r!=null&&typeof r=="object"&&r.constructor.name==="Uint8Array"}function oi(r,...e){if(!rc(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${r.length}`)}function si(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function Zo(r,e){oi(r);let t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var sr=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),Ye=(r,e)=>r<<32-e|r>>>e;var jg=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function ic(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function ai(r){return typeof r=="string"&&(r=ic(r)),oi(r),r}var or=class{clone(){return this._cloneInto()}},Zg={}.toString;function Yo(r){let e=n=>r().update(ai(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function oc(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let i=BigInt(32),o=BigInt(4294967295),a=Number(t>>i&o),s=Number(t&o),c=n?4:0,u=n?0:4;r.setUint32(e+c,a,n),r.setUint32(e+u,s,n)}var Jo=(r,e,t)=>r&e^~r&t,$o=(r,e,t)=>r&e^r&t^e&t,ar=class extends or{constructor(e,t,n,i){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=i,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=sr(this.buffer)}update(e){si(this);let{view:t,buffer:n,blockLen:i}=this;e=ai(e);let o=e.length;for(let a=0;a<o;){let s=Math.min(i-this.pos,o-a);if(s===i){let c=sr(e);for(;i<=o-a;a+=i)this.process(c,a);continue}n.set(e.subarray(a,a+s),this.pos),this.pos+=s,a+=s,this.pos===i&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){si(this),Zo(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:i,isLE:o}=this,{pos:a}=this;t[a++]=128,this.buffer.subarray(a).fill(0),this.padOffset>i-a&&(this.process(n,0),a=0);for(let m=a;m<i;m++)t[m]=0;oc(n,i-8,BigInt(this.length*8),o),this.process(n,0);let s=sr(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let u=c/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let m=0;m<u;m++)s.setUint32(4*m,l[m],o)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:i,finished:o,destroyed:a,pos:s}=this;return e.length=i,e.pos=s,e.finished=o,e.destroyed=a,i%t&&e.buffer.set(n),e}};var sc=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),Pt=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),Tt=new Uint32Array(64),ui=class extends ar{constructor(){super(64,32,8,!1),this.A=Pt[0]|0,this.B=Pt[1]|0,this.C=Pt[2]|0,this.D=Pt[3]|0,this.E=Pt[4]|0,this.F=Pt[5]|0,this.G=Pt[6]|0,this.H=Pt[7]|0}get(){let{A:e,B:t,C:n,D:i,E:o,F:a,G:s,H:c}=this;return[e,t,n,i,o,a,s,c]}set(e,t,n,i,o,a,s,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=i|0,this.E=o|0,this.F=a|0,this.G=s|0,this.H=c|0}process(e,t){for(let m=0;m<16;m++,t+=4)Tt[m]=e.getUint32(t,!1);for(let m=16;m<64;m++){let d=Tt[m-15],p=Tt[m-2],f=Ye(d,7)^Ye(d,18)^d>>>3,y=Ye(p,17)^Ye(p,19)^p>>>10;Tt[m]=y+Tt[m-7]+f+Tt[m-16]|0}let{A:n,B:i,C:o,D:a,E:s,F:c,G:u,H:l}=this;for(let m=0;m<64;m++){let d=Ye(s,6)^Ye(s,11)^Ye(s,25),p=l+d+Jo(s,c,u)+sc[m]+Tt[m]|0,y=(Ye(n,2)^Ye(n,13)^Ye(n,22))+$o(n,i,o)|0;l=u,u=c,c=s,s=a+p|0,a=o,o=i,i=n,n=p+y|0}n=n+this.A|0,i=i+this.B|0,o=o+this.C|0,a=a+this.D|0,s=s+this.E|0,c=c+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(n,i,o,a,s,c,u,l)}roundClean(){Tt.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var es=Yo(()=>new ui);var fw=oe("Raydium_Util");function rt({fromPublicKey:r,programId:e=cc,assignSeed:t}){let n=t?btoa(t).slice(0,32):ac.generate().publicKey.toBase58().slice(0,32);return{publicKey:lc(r,n,e),seed:n}}function lc(r,e,t){let n=Buffer.concat([r.toBuffer(),Buffer.from(e),t.toBuffer()]),i=es(n);return new uc(i)}import{PublicKey as kw,SystemProgram as Aw}from"@solana/web3.js";import xw from"bn.js";import{createCloseAccountInstruction as Kw,createInitializeAccountInstruction as Lw,createTransferInstruction as Nw,TOKEN_PROGRAM_ID as Cw}from"@solana/spl-token";function ur({programId:r}){let{publicKey:e}=pe([Buffer.from("amm_config_account_seed","utf-8")],r);return e}function Wt({name:r,programId:e,marketId:t}){let{publicKey:n}=pe([e.toBuffer(),t.toBuffer(),Buffer.from(r,"utf-8")],e);return n}function pc({programId:r,marketId:e}){let{publicKey:t}=pe([r.toBuffer(),e.toBuffer(),Buffer.from("open_order_associated_seed","utf-8")],r);return t}function fc({programId:r}){return pe([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],r)}function li({version:r,marketVersion:e,marketId:t,baseMint:n,quoteMint:i,baseDecimals:o,quoteDecimals:a,programId:s,marketProgramId:c}){let u=Wt({name:"amm_associated_seed",programId:s,marketId:t}),l=Wt({name:"lp_mint_associated_seed",programId:s,marketId:t}),{publicKey:m,nonce:d}=fc({programId:s}),p=Wt({name:"coin_vault_associated_seed",programId:s,marketId:t}),f=Wt({name:"pc_vault_associated_seed",programId:s,marketId:t}),y=Wt({name:"temp_lp_token_associated_seed",programId:s,marketId:t}),g=pc({programId:s,marketId:t}),w=Wt({name:"target_associated_seed",programId:s,marketId:t}),h=Wt({name:"withdraw_associated_seed",programId:s,marketId:t}),{publicKey:k}=jo({programId:c,marketId:t});return{id:u,baseMint:n,quoteMint:i,lpMint:l,baseDecimals:o,quoteDecimals:a,lpDecimals:o,version:r,programId:s,authority:m,nonce:d,baseVault:p,quoteVault:f,lpVault:y,openOrders:g,targetOrders:w,withdrawQueue:h,marketVersion:e,marketProgramId:c,marketId:t,marketAuthority:k,lookupTableAccount:mc.default,configId:ur({programId:s})}}var ci={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]},ts=r=>{let e={},t=dc.toBase58();return Object.keys(r).map(n=>{let i=r[n],[o,a]=[i.baseMint.toBase58(),i.quoteMint.toBase58()];e[n]={id:n,version:4,status:i.status.toNumber(),programId:i.programId.toBase58(),mintA:rr({address:o,programId:t,decimals:i.baseDecimal.toNumber()}),mintB:rr({address:a,programId:t,decimals:i.quoteDecimal.toNumber()}),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:i.poolPrice.toNumber(),mintAmountA:new N(i.mintAAmount.toString()).div(10**i.baseDecimal.toNumber()).toNumber(),mintAmountB:new N(i.mintBAmount.toString()).div(10**i.quoteDecimal.toNumber()).toNumber(),baseReserve:i.baseReserve,quoteReserve:i.quoteReserve,feeRate:new N(i.tradeFeeNumerator.toString()).div(i.tradeFeeDenominator.toString()).toNumber(),openTime:i.poolOpenTime.toString(),tvl:0,day:ci,week:ci,month:ci,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,type:"Standard",marketId:i.marketId.toBase58(),configId:ur({programId:i.programId}).toBase58(),lpPrice:0,lpAmount:new N(i.lpReserve.toString()).div(10**Math.min(i.baseDecimal.toNumber(),i.quoteDecimal.toNumber())).toNumber(),lpMint:rr({address:i.lpMint.toBase58(),programId:t,decimals:Math.min(i.baseDecimal.toNumber(),i.quoteDecimal.toNumber())}),burnPercent:0}}),e};import be from"bn.js";import{PublicKey as kk}from"@solana/web3.js";import Ak from"bn.js";import{TOKEN_PROGRAM_ID as Tk}from"@solana/spl-token";import{SystemProgram as Ft,SYSVAR_RENT_PUBKEY as yc,Transaction as ns,TransactionInstruction as gc}from"@solana/web3.js";import{createInitializeAccountInstruction as rs,TOKEN_PROGRAM_ID as is}from"@solana/spl-token";function bc(r="accountFlags"){let e=new Hn(r);return e.addBoolean("initialized"),e.addBoolean("market"),e.addBoolean("openOrders"),e.addBoolean("requestQueue"),e.addBoolean("eventQueue"),e.addBoolean("bids"),e.addBoolean("asks"),e}var mi=M([he(5),bc("accountFlags"),K("ownAddress"),b("vaultSignerNonce"),K("baseMint"),K("quoteMint"),K("baseVault"),b("baseDepositsTotal"),b("baseFeesAccrued"),K("quoteVault"),b("quoteDepositsTotal"),b("quoteFeesAccrued"),b("quoteDustThreshold"),K("requestQueue"),K("eventQueue"),K("bids"),K("asks"),b("baseLotSize"),b("quoteLotSize"),b("feeRateBps"),b("referrerRebatesAccrued"),he(7)]);function wc({programId:r,marketInfo:e}){let t=M([V("version"),Me("instruction"),b("baseLotSize"),b("quoteLotSize"),Lt("feeRateBps"),b("vaultSignerNonce"),b("quoteDustThreshold")]),n=[{pubkey:e.id,isSigner:!1,isWritable:!0},{pubkey:e.requestQueue,isSigner:!1,isWritable:!0},{pubkey:e.eventQueue,isSigner:!1,isWritable:!0},{pubkey:e.bids,isSigner:!1,isWritable:!0},{pubkey:e.asks,isSigner:!1,isWritable:!0},{pubkey:e.baseVault,isSigner:!1,isWritable:!0},{pubkey:e.quoteVault,isSigner:!1,isWritable:!0},{pubkey:e.baseMint,isSigner:!1,isWritable:!1},{pubkey:e.quoteMint,isSigner:!1,isWritable:!1},{pubkey:e.authority?e.quoteMint:yc,isSigner:!1,isWritable:!1}].concat(e.authority?{pubkey:e.authority,isSigner:!1,isWritable:!1}:[]).concat(e.authority&&e.pruneAuthority?{pubkey:e.pruneAuthority,isSigner:!1,isWritable:!1}:[]),i=Buffer.alloc(t.span);return t.encode({version:0,instruction:0,baseLotSize:e.baseLotSize,quoteLotSize:e.quoteLotSize,feeRateBps:e.feeRateBps,vaultSignerNonce:e.vaultSignerNonce,quoteDustThreshold:e.quoteDustThreshold},i),new gc({keys:n,programId:r,data:i})}async function di({connection:r,wallet:e,marketInfo:t}){let n=new ns,i=await r.getMinimumBalanceForRentExemption(165);n.add(Ft.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.baseVault.seed,newAccountPubkey:t.baseVault.publicKey,lamports:i,space:165,programId:is}),Ft.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.quoteVault.seed,newAccountPubkey:t.quoteVault.publicKey,lamports:i,space:165,programId:is}),rs(t.baseVault.publicKey,t.baseMint,t.vaultOwner),rs(t.quoteVault.publicKey,t.quoteMint,t.vaultOwner),Ft.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.id.seed,newAccountPubkey:t.id.publicKey,lamports:await r.getMinimumBalanceForRentExemption(mi.span),space:mi.span,programId:t.programId}));let o=new ns;return o.add(Ft.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.requestQueue.seed,newAccountPubkey:t.requestQueue.publicKey,lamports:t.lowestFeeMarket?6208320:await r.getMinimumBalanceForRentExemption(t.requestQueueSpace??5120+12),space:t.lowestFeeMarket?764:t.requestQueueSpace??5120+12,programId:t.programId}),Ft.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.eventQueue.seed,newAccountPubkey:t.eventQueue.publicKey,lamports:t.lowestFeeMarket?79594560:await r.getMinimumBalanceForRentExemption(t.eventQueueSpace??262144+12),space:t.lowestFeeMarket?11308:t.eventQueueSpace??262144+12,programId:t.programId}),Ft.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.bids.seed,newAccountPubkey:t.bids.publicKey,lamports:t.lowestFeeMarket?101977920:await r.getMinimumBalanceForRentExemption(t.orderbookQueueSpace??65536+12),space:t.lowestFeeMarket?14524:t.orderbookQueueSpace??65536+12,programId:t.programId}),Ft.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.asks.seed,newAccountPubkey:t.asks.publicKey,lamports:t.lowestFeeMarket?101977920:await r.getMinimumBalanceForRentExemption(t.orderbookQueueSpace??65536+12),space:t.lowestFeeMarket?14524:t.orderbookQueueSpace??65536+12,programId:t.programId}),wc({programId:t.programId,marketInfo:{id:t.id.publicKey,requestQueue:t.requestQueue.publicKey,eventQueue:t.eventQueue.publicKey,bids:t.bids.publicKey,asks:t.asks.publicKey,baseVault:t.baseVault.publicKey,quoteVault:t.quoteVault.publicKey,baseMint:t.baseMint,quoteMint:t.quoteMint,baseLotSize:t.baseLotSize,quoteLotSize:t.quoteLotSize,feeRateBps:t.feeRateBps,vaultSignerNonce:t.vaultSignerNonce,quoteDustThreshold:t.quoteDustThreshold}})),[{transaction:n,signer:[],instructionTypes:[Q.CreateAccount,Q.CreateAccount,Q.InitAccount,Q.InitAccount]},{transaction:o,signer:[],instructionTypes:[Q.CreateAccount,Q.CreateAccount,Q.CreateAccount,Q.CreateAccount,Q.CreateAccount,Q.InitMarket]}]}var pi=class extends $t{stableLayout;constructor(e){super(e),this.stableLayout=new Sn({connection:this.scope.connection})}async initLayout(){await this.stableLayout.initStableModelLayout()}async load(){this.checkDisabled()}computePairAmount({poolInfo:e,amount:t,slippage:n,baseIn:i}){let o=new be(new N(t).mul(10**e[i?"mintA":"mintB"].decimals).toFixed(0)),a=Oo(e[i?"mintB":"mintA"]),[s,c]=[new be(new N(e.mintAmountA).mul(10**e.mintA.decimals).toString()),new be(new N(e.mintAmountB).mul(10**e.mintB.decimals).toString())],u=new be(new N(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,N.ROUND_DOWN));this.logDebug("baseReserve:",s.toString(),"quoteReserve:",c.toString()),this.logDebug("tokenIn:",i?e.mintA.symbol:e.mintB.symbol,"amountIn:",o.toString(),"anotherToken:",i?e.mintB.symbol:e.mintA.symbol,"slippage:",`${n.toSignificant()}%`,"baseReserve",s.toString(),"quoteReserve",c.toString());let l=i?"base":"quote";this.logDebug("input side:",l);let m=kt;o.isZero()||(m=l==="base"?Fn(o.mul(c),s):Fn(o.mul(s),c)),this.logDebug("amountRaw:",m.toString(),"lpAmount:",u.toString());let d=Fn(o.mul(u),l==="base"?s:c);this.logDebug("liquidity:",d.toString());let p=new qe(new be(1)).add(n),f=new qe(new be(1)).sub(n),y=p.mul(m).quotient,g=f.mul(m).quotient,w=new ye(a,m),h=new ye(a,y),k=new ye(a,g);return this.logDebug("anotherAmount:",w.toFixed(),"maxAnotherAmount:",h.toFixed()),{anotherAmount:w,maxAnotherAmount:h,minAnotherAmount:k,liquidity:d}}async getAmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async addLiquidity(e){let{poolInfo:t,poolKeys:n,amountInA:i,amountInB:o,otherAmountMin:a,fixedSide:s,config:c,txVersion:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),this.logDebug("amountInA:",i,"amountInB:",o),(i.isZero()||o.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:i.toFixed(),amountInB:o.toFixed()});let{account:p}=this.scope,{bypassAssociatedCheck:f,checkCreateATAOwner:y}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...c},[g,w]=[i.token,o.token],h=await p.getCreatedTokenAccount({mint:g.mint,associatedOnly:!1}),k=await p.getCreatedTokenAccount({mint:w.mint,associatedOnly:!1});!h&&!k&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",p.tokenAccounts);let P=await p.getCreatedTokenAccount({mint:new ke(t.lpMint.address)}),T=[g,w],A=[h,k],S=[i.raw,o.raw],L=i.token.mint.toBase58()===t.mintA.address?"base":"quote",x="base";["quote","base"].includes(L)||this.logAndCreateError("invalid fixedSide","fixedSide",s),L==="quote"?(T.reverse(),A.reverse(),S.reverse(),x=s==="a"?"quote":"base"):L==="base"&&(x=s==="a"?"base":"quote");let[R,v]=T,[W,X]=A,[$,J]=S,G=n??await this.getAmmPoolKeys(t.id),Ke=this.createTxBuilder(d),{tokenAccount:Le,...Xe}=await p.handleTokenAccount({side:"in",amount:$,mint:R.mint,tokenAccount:W,bypassAssociatedCheck:f,checkCreateATAOwner:y});Ke.addInstruction(Xe);let{tokenAccount:it,...nn}=await p.handleTokenAccount({side:"in",amount:J,mint:v.mint,tokenAccount:X,bypassAssociatedCheck:f,checkCreateATAOwner:y});Ke.addInstruction(nn);let{tokenAccount:pt,...ft}=await p.handleTokenAccount({side:"out",amount:0,mint:new ke(t.lpMint.address),tokenAccount:P,bypassAssociatedCheck:f,checkCreateATAOwner:y});return Ke.addInstruction(ft),Ke.addInstruction({instructions:[zo({poolInfo:t,poolKeys:G,userKeys:{baseTokenAccount:Le,quoteTokenAccount:it,lpTokenAccount:pt,owner:this.scope.ownerPubKey},baseAmountIn:$,quoteAmountIn:J,otherAmountMin:a.raw,fixedSide:x})],instructionTypes:[t.pooltype.includes("StablePool")?Q.AmmV5AddLiquidity:Q.AmmV4AddLiquidity],lookupTableAddress:G.lookupTableAccount?[G.lookupTableAccount]:[]}),Ke.addCustomComputeBudget(l),Ke.addTipInstruction(m),u===0?await Ke.buildV0():Ke.build()}async removeLiquidity(e){this.scope.availability.removeStandardPosition===!1&&this.logAndCreateError("remove liquidity feature disabled in your region");let{poolInfo:t,poolKeys:n,lpAmount:i,baseAmountMin:o,quoteAmountMin:a,config:s,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:m}=e,d=n??await this.getAmmPoolKeys(t.id),[p,f,y]=[new ke(t.mintA.address),new ke(t.mintB.address),new ke(t.lpMint.address)];this.logDebug("lpAmount:",i),this.logDebug("baseAmountMin:",o),this.logDebug("quoteAmountMin:",a),i.isZero()&&this.logAndCreateError("amount must greater than zero","lpAmount",i.toString());let{account:g}=this.scope,w=await g.getCreatedTokenAccount({mint:y,associatedOnly:!1});w||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",g.tokenAccounts);let h=await g.getCreatedTokenAccount({mint:p}),k=await g.getCreatedTokenAccount({mint:f}),P=this.createTxBuilder(m),{bypassAssociatedCheck:T,checkCreateATAOwner:A}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...s},{tokenAccount:S,...L}=await g.handleTokenAccount({side:"out",amount:0,mint:p,tokenAccount:h,bypassAssociatedCheck:T,checkCreateATAOwner:A});P.addInstruction(L);let{tokenAccount:x,...R}=await g.handleTokenAccount({side:"out",amount:0,mint:f,tokenAccount:k,bypassAssociatedCheck:T,checkCreateATAOwner:A});return P.addInstruction(R),P.addInstruction({instructions:[ri({poolInfo:t,poolKeys:d,userKeys:{lpTokenAccount:w,baseTokenAccount:S,quoteTokenAccount:x,owner:this.scope.ownerPubKey},lpAmount:i,baseAmountMin:o,quoteAmountMin:a})],lookupTableAddress:d.lookupTableAccount?[d.lookupTableAccount]:[],instructionTypes:[t.pooltype.includes("StablePool")?Q.AmmV5RemoveLiquidity:Q.AmmV4RemoveLiquidity]}),P.addCustomComputeBudget(u),P.addTipInstruction(l),c===0?await P.buildV0():P.build()}async removeAllLpAndCreateClmmPosition({poolInfo:e,clmmPoolInfo:t,removeLpAmount:n,createPositionInfo:i,farmInfo:o,userFarmLpAmount:a,base:s,computeBudgetConfig:c,payer:u,userAuxiliaryLedgers:l,tokenProgram:m=xt,checkCreateATAOwner:d=!0,getEphemeralSigners:p,txVersion:f,feePayer:y}){if((this.scope.availability.removeStandardPosition===!1||this.scope.availability.createConcentratedPosition===!1)&&this.logAndCreateError("remove liquidity or create position feature disabled in your region"),!(e.mintA.address===t.mintA.address||e.mintA.address===t.mintB.address)||!(e.mintB.address===t.mintA.address||e.mintB.address===t.mintB.address))throw Error("mint check error");let g=this.createTxBuilder(y),w={};for(let G of this.scope.account.tokenAccountRawInfos)(w[G.accountInfo.mint.toString()]===void 0||ue(this.scope.ownerPubKey,G.accountInfo.mint,xt).publicKey.equals(G.pubkey))&&(w[G.accountInfo.mint.toString()]=G.pubkey);let h=w[e.lpMint.address];if(h===void 0)throw Error("find lp account error in trade accounts");let k=n.add(a??new be(0)),P=e.mintA.address===Re.WSOL.mint.toString(),T=e.mintB.address===Re.WSOL.mint.toString(),{account:A,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:xt,mint:new ke(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:P?{payer:this.scope.ownerPubKey}:void 0,skipCloseAccount:!P,notUseTokenAccount:P,associatedOnly:!0,checkCreateATAOwner:d});if(g.addInstruction(S||{}),A===void 0)throw new Error("base token account not found");let{account:L,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:xt,mint:new ke(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:T?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!T,notUseTokenAccount:T,associatedOnly:!0,checkCreateATAOwner:d});if(g.addInstruction(x||{}),L===void 0)throw new Error("quote token account not found");if(w[e.mintA.address]=A,w[e.mintB.address]=L,o!==void 0&&!a?.isZero()){let G=_r[o.programId],Ke=Yt({programId:new ke(o.programId),poolId:new ke(o.id),owner:this.scope.ownerPubKey,version:G}),Le,Xe=await this.scope.connection.getAccountInfo(Ke);if(Xe&&(Le=lo(G).decode(Xe.data)),G!==6&&!Le){let{instruction:Qe,instructionType:qt}=po({id:new ke(o.id),programId:new ke(o.programId),version:G,ledger:Ke,owner:this.scope.ownerPubKey});g.addInstruction({instructions:[Qe],instructionTypes:[qt]})}let it=[];for(let Qe of o.rewardInfos){let qt=Qe.mint.address===Re.WSOL.mint.toString();if(w[Qe.mint.address])it.push(w[Qe.mint.address]);else{let{account:rn,instructionParams:on}=await this.scope.account.getOrCreateTokenAccount({mint:new ke(Qe.mint.address),tokenProgram:m,owner:this.scope.ownerPubKey,skipCloseAccount:!qt,createInfo:{payer:u||this.scope.ownerPubKey},associatedOnly:!0,checkCreateATAOwner:d});rn||this.logAndCreateError("farm reward account not found:",Qe.mint.address),on&&g.addInstruction(on),it.push(rn)}}let nn=(await this.scope.api.fetchFarmKeysById({ids:o.id}))[0],pt={userAuxiliaryLedgers:l,amount:a,owner:this.scope.ownerPubKey,farmInfo:o,farmKeys:nn,lpAccount:h,rewardAccounts:it},ft=_r[o.programId],Dt=ft===6?fo(pt):ft===5?bo(pt):yo(pt),ot={3:Q.FarmV3Withdraw,5:Q.FarmV5Withdraw,6:Q.FarmV6Withdraw};g.addInstruction({instructions:[Dt],instructionTypes:[ot[ft]]})}let R=await this.getAmmPoolKeys(e.id),v=ri({poolInfo:e,poolKeys:R,userKeys:{lpTokenAccount:h,baseTokenAccount:A,quoteTokenAccount:L,owner:this.scope.ownerPubKey},lpAmount:k,baseAmountMin:0,quoteAmountMin:0});g.addInstruction({instructions:[v],instructionTypes:[e.pooltype.includes("StablePool")?Q.AmmV5RemoveLiquidity:Q.AmmV4RemoveLiquidity],lookupTableAddress:R.lookupTableAccount?[R.lookupTableAccount]:[]});let[W,X]=e.mintA.address===t.mintA.address?[A,L]:[L,A],$=await this.scope.clmm.getClmmPoolKeys(t.id),J=await Jt.openPositionFromBaseInstructions({poolInfo:t,poolKeys:$,ownerInfo:{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:W,tokenAccountB:X},withMetadata:"create",...i,base:s,getEphemeralSigners:p});return g.addInstruction({instructions:[...J.instructions],signers:J.signers,instructionTypes:[...J.instructionTypes],lookupTableAddress:$.lookupTableAccount?[$.lookupTableAccount]:[]}),f===0?g.sizeCheckBuildV0({computeBudgetConfig:c}):g.sizeCheckBuild({computeBudgetConfig:c})}async createPoolV4({programId:e,marketInfo:t,baseMintInfo:n,quoteMintInfo:i,baseAmount:o,quoteAmount:a,startTime:s,ownerInfo:c,associatedOnly:u=!1,checkCreateATAOwner:l=!1,tokenProgram:m,txVersion:d,feeDestinationId:p,computeBudgetConfig:f,txTipConfig:y,feePayer:g}){let w=c.feePayer||this.scope.owner?.publicKey,h=c.useSOLBalance&&n.mint.equals(cr),k=c.useSOLBalance&&i.mint.equals(cr),P=this.createTxBuilder(g),{account:T,instructionParams:A}=await this.scope.account.getOrCreateTokenAccount({mint:n.mint,owner:this.scope.ownerPubKey,createInfo:h?{payer:w,amount:o}:void 0,notUseTokenAccount:h,skipCloseAccount:!h,associatedOnly:h?!1:u,checkCreateATAOwner:l});P.addInstruction(A||{});let{account:S,instructionParams:L}=await this.scope.account.getOrCreateTokenAccount({mint:i.mint,owner:this.scope.ownerPubKey,createInfo:k?{payer:w,amount:a}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:u,checkCreateATAOwner:l});if(P.addInstruction(L||{}),T===void 0||S===void 0)throw Error("you don't has some token account");let x=li({version:4,marketVersion:3,marketId:t.marketId,baseMint:n.mint,quoteMint:i.mint,baseDecimals:n.decimals,quoteDecimals:i.decimals,programId:e,marketProgramId:t.programId}),R={programId:e,ammId:x.id,ammAuthority:x.authority,ammOpenOrders:x.openOrders,lpMint:x.lpMint,coinMint:x.baseMint,pcMint:x.quoteMint,coinVault:x.baseVault,pcVault:x.quoteVault,withdrawQueue:x.withdrawQueue,ammTargetOrders:x.targetOrders,poolTempLp:x.lpVault,marketProgramId:x.marketProgramId,marketId:x.marketId,ammConfigId:x.configId,feeDestinationId:p},{instruction:v,instructionType:W}=ii({...R,userWallet:this.scope.ownerPubKey,userCoinVault:T,userPcVault:S,userLpVault:ue(this.scope.ownerPubKey,x.lpMint,m).publicKey,nonce:x.nonce,openTime:s,coinAmount:o,pcAmount:a});return P.addInstruction({instructions:[v],instructionTypes:[W]}),P.addCustomComputeBudget(f),P.addTipInstruction(y),P.versionBuild({txVersion:d,extInfo:{address:R}})}async createMarketAndPoolV4({programId:e=ji,marketProgram:t=Hi,feeDestinationId:n=Zi,tokenProgram:i,baseMintInfo:o,quoteMintInfo:a,baseAmount:s,quoteAmount:c,startTime:u,ownerInfo:l,lowestFeeMarket:m,assignSeed:d,associatedOnly:p=!1,checkCreateATAOwner:f=!1,lotSize:y=1,tickSize:g=.01,txVersion:w,computeBudgetConfig:h,txTipConfig:k,feePayer:P}){let T=this.scope.ownerPubKey,A=l.feePayer||this.scope.owner?.publicKey,S=l.useSOLBalance&&o.mint.equals(cr),L=l.useSOLBalance&&a.mint.equals(cr),x=d?`${o.mint.toBase58().slice(0,7)}-${a.mint.toBase58().slice(0,7)}-${d}`:void 0,R=rt({fromPublicKey:T,programId:t,assignSeed:x&&`${x}-market`}),v=rt({fromPublicKey:T,programId:t,assignSeed:x&&`${x}-request`}),W=rt({fromPublicKey:T,programId:t,assignSeed:x&&`${x}-event`}),X=rt({fromPublicKey:T,programId:t,assignSeed:x&&`${x}-bids`}),$=rt({fromPublicKey:T,programId:t,assignSeed:x&&`${x}-asks`}),J=rt({fromPublicKey:T,programId:xt,assignSeed:x&&`${x}-baseVault`}),G=rt({fromPublicKey:T,programId:xt,assignSeed:x&&`${x}-quoteVault`}),Ke=0,Le=new be(100);function Xe(){let Je=new be(0);for(;;)try{return{vaultOwner:ke.createProgramAddressSync([R.publicKey.toBuffer(),Je.toArrayLike(Buffer,"le",8)],t),vaultSignerNonce:Je}}catch{if(Je.iaddn(1),Je.gt(new be(25555)))throw Error("find vault owner error")}}let{vaultOwner:it,vaultSignerNonce:nn}=Xe(),pt=new be(Math.round(10**o.decimals*y)),ft=new be(Math.round(y*10**a.decimals*g));if(pt.eq(kt))throw Error("lot size is too small");if(ft.eq(kt))throw Error("tick size or lot size is too small");let Dt=await di({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:t,vaultOwner:it,baseMint:o.mint,quoteMint:a.mint,id:R,baseVault:J,quoteVault:G,requestQueue:v,eventQueue:W,bids:X,asks:$,feeRateBps:Ke,quoteDustThreshold:Le,vaultSignerNonce:nn,baseLotSize:pt,quoteLotSize:ft,lowestFeeMarket:m}}),ot=this.createTxBuilder(P);ot.addInstruction({instructions:Dt[0].transaction.instructions,signers:Dt[0].signer});for await(let Je of Dt.slice(1,Dt.length))ot.addInstruction({instructions:Je.transaction.instructions,signers:Je.signer,instructionTypes:Je.instructionTypes});let{account:Qe,instructionParams:qt}=await this.scope.account.getOrCreateTokenAccount({mint:o.mint,owner:this.scope.ownerPubKey,createInfo:S?{payer:A,amount:s}:void 0,notUseTokenAccount:S,skipCloseAccount:!S,associatedOnly:S?!1:p,checkCreateATAOwner:f,assignSeed:S&&x?`${x}-wsol`:void 0});ot.addInstruction(qt||{});let{account:rn,instructionParams:on}=await this.scope.account.getOrCreateTokenAccount({mint:a.mint,owner:this.scope.ownerPubKey,createInfo:L?{payer:A,amount:c}:void 0,notUseTokenAccount:L,skipCloseAccount:!L,associatedOnly:L?!1:p,checkCreateATAOwner:f,assignSeed:L&&x?`${x}-wsol`:void 0});if(ot.addInstruction(on||{}),Qe===void 0)throw Error("you don't has base token account");if(rn===void 0)throw Error("you don't has quote token account");let Ne=li({version:4,marketVersion:3,marketId:R.publicKey,baseMint:o.mint,quoteMint:a.mint,baseDecimals:o.decimals,quoteDecimals:a.decimals,programId:e,marketProgramId:t}),lr={programId:e,ammId:Ne.id,ammAuthority:Ne.authority,ammOpenOrders:Ne.openOrders,lpMint:Ne.lpMint,coinMint:Ne.baseMint,pcMint:Ne.quoteMint,coinVault:Ne.baseVault,pcVault:Ne.quoteVault,withdrawQueue:Ne.withdrawQueue,ammTargetOrders:Ne.targetOrders,poolTempLp:Ne.lpVault,marketProgramId:Ne.marketProgramId,marketId:Ne.marketId,ammConfigId:Ne.configId,feeDestinationId:n},{instruction:os,instructionType:ss}=ii({...lr,userWallet:this.scope.ownerPubKey,userCoinVault:Qe,userPcVault:rn,userLpVault:ue(this.scope.ownerPubKey,Ne.lpMint,i).publicKey,nonce:Ne.nonce,openTime:u,coinAmount:s,pcAmount:c});ot.addInstruction({instructions:[os],instructionTypes:[ss]});let fi=S||L?[qt?.instructions?.[0]||on?.instructions?.[0]].filter(Je=>!!Je):void 0;return w===0?ot.sizeCheckBuildV0({computeBudgetConfig:h,splitIns:fi,address:{requestQueue:v.publicKey,eventQueue:W.publicKey,bids:X.publicKey,asks:$.publicKey,baseVault:J.publicKey,quoteVault:G.publicKey,baseMint:new ke(o.mint),quoteMint:new ke(a.mint),...lr}}):ot.sizeCheckBuild({computeBudgetConfig:h,splitIns:fi,address:{requestQueue:v.publicKey,eventQueue:W.publicKey,bids:X.publicKey,asks:$.publicKey,baseVault:J.publicKey,quoteVault:G.publicKey,baseMint:new ke(o.mint),quoteMint:new ke(a.mint),...lr}})}async getCreatePoolFee({programId:e}){let t=ur({programId:e}),n=await this.scope.connection.getAccountInfo(t,{dataSlice:{offset:536,length:8}});if(n===null)throw Error("get config account error");return Fo.decode(n.data).fee}computeAmountOut({poolInfo:e,amountIn:t,mintIn:n,mintOut:i,slippage:o}){let[a,s]=[n.toString(),i.toString()];if(a!==e.mintA.address&&a!==e.mintB.address)throw new Error("toke not match");if(s!==e.mintA.address&&s!==e.mintB.address)throw new Error("toke not match");let{baseReserve:c,quoteReserve:u}=e,l=[c,u],m=[e.mintA.decimals,e.mintB.decimals],d=a==e.mintA.address?"base":"quote";d==="quote"&&(l.reverse(),m.reverse());let[p,f]=l,[y,g]=m,w=e.version===4,h;if(w)h=new N(f.toString()).div(10**g).div(new N(p.toString()).div(10**y));else{let W=Xo(this.stableLayout.stableModelData,c.toNumber(),u.toNumber(),!1);d==="quote"?h=new N(1e6).div(W*1e6):h=new N(W*1e6).div(1e6)}let k=t,P=new be(0),T=new be(0);if(!k.isZero())if(w){T=fn(k.mul(Zr),ir);let W=k.sub(T),X=p.add(W);P=f.mul(W).div(X)}else{T=k.mul(new be(2)).div(new be(1e4));let W=k.sub(T);d==="quote"?P=new be(Uo(this.stableLayout.stableModelData,u.toNumber(),c.toNumber(),W.toNumber())):P=new be(Go(this.stableLayout.stableModelData,u.toNumber(),c.toNumber(),W.toNumber()))}let A=new be(new N(P.toString()).mul(1-o).toFixed(0)),S=P,L=A,x=new N(P.toString()).div(new N(k.sub(T).toString()).toFixed(0));!k.isZero()&&!P.isZero()&&(x=new N(P.toString()).div(10**g).div(new N(k.sub(T).toString()).div(10**y)));let R=h.sub(x).div(h).mul(100);return{amountOut:S,minAmountOut:L,currentPrice:h,executionPrice:x,priceImpact:R,fee:T}}computeAmountIn({poolInfo:e,amountOut:t,mintIn:n,mintOut:i,slippage:o}){let{baseReserve:a,quoteReserve:s}=e;n.toString()!==e.mintA.address&&n.toString()!==e.mintB.address&&this.logAndCreateError("mintIn does not match pool"),i.toString()!==e.mintA.address&&i.toString()!==e.mintB.address&&this.logAndCreateError("mintOut does not match pool"),this.logDebug("baseReserve:",a.toString()),this.logDebug("quoteReserve:",s.toString());let c=n.toString()===e.mintA.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA];this.logDebug("currencyOut:",l.symbol||l.address),this.logDebug("amountOut:",new N(t.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString(),u.symbol||u.address),this.logDebug("slippage:",`${o*100}%`);let m=[a,s],d=c?"quote":"base";d==="base"&&m.reverse(),this.logDebug("output side:",d);let[p,f]=m,y=new N(f.toString()).div(10**e[c?"mintB":"mintA"].decimals).div(new N(p.toString()).div(10**e[c?"mintA":"mintB"].decimals));this.logDebug("currentPrice:",`1 ${u.symbol||u.address} \u2248 ${y.toString()} ${l.symbol||l.address}`),this.logDebug("currentPrice invert:",`1 ${l.symbol||l.address} \u2248 ${new N(1).div(y).toString()} ${u.symbol||u.address}`);let g=new be(0),w=t;if(!w.isZero()){w.gt(f)&&(w=f.sub(new be(1)));let L=f.sub(w);g=p.mul(w).div(L).mul(ir).div(ir.sub(Zr))}let h=new be(new N(g.toString()).mul(1+o).toFixed(0)),k=g,P=h;this.logDebug("amountIn:",new N(k.toString()).div(10**u.decimals).toDecimalPlaces(u.decimals).toString()),this.logDebug("maxAmountIn:",new N(P.toString()).div(10**u.decimals).toDecimalPlaces(u.decimals).toString());let T=null;!g.isZero()&&!w.isZero()&&(T=new N(w.toString()).div(10**l.decimals).div(new N(g.toString()).div(10**u.decimals)),this.logDebug("executionPrice:",`1 ${l.symbol||l.address} \u2248 ${T.toDecimalPlaces(Math.max(e.mintA.decimals,e.mintB.decimals)).toString()} ${u.symbol||u.address}`),this.logDebug("executionPrice invert:",`1 ${l.symbol||l.address} \u2248 ${new N(1).div(T).toDecimalPlaces(Math.max(e.mintA.decimals,e.mintB.decimals)).toString()} ${u.symbol||u.address}`));let A=y.mul(k.toString()),S=A.sub(t.toString()).abs().div(A);return this.logDebug("priceImpact:",`${S.toString()}%`),{amountIn:k,maxAmountIn:P,currentPrice:y,executionPrice:T,priceImpact:S}}async swap({poolInfo:e,poolKeys:t,amountIn:n,amountOut:i,inputMint:o,fixedSide:a,txVersion:s,config:c,computeBudgetConfig:u,txTipConfig:l,feePayer:m}){let d=this.createTxBuilder(m),{associatedOnly:p=!0,inputUseSolBalance:f=!0,outputUseSolBalance:y=!0}=c||{},[g,w]=o===e.mintA.address?[e.mintA,e.mintB]:[e.mintB,e.mintA],h=f&&g.address===Xt.toBase58(),k=y&&w.address===Xt.toBase58(),{account:P,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:xt,mint:new ke(g.address),owner:this.scope.ownerPubKey,createInfo:h?{payer:this.scope.ownerPubKey,amount:n}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:p});d.addInstruction(T||{}),P||this.logAndCreateError("input token account not found",{token:g.symbol||g.address,tokenAccountIn:P,inputTokenUseSolBalance:h,associatedOnly:p});let{account:A,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:xt,mint:new ke(w.address),owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:k?!1:p});d.addInstruction(S||{}),A===void 0&&this.logAndCreateError("output token account not found",{token:w.symbol||w.address,tokenAccountOut:A,outputTokenUseSolBalance:k,associatedOnly:p});let L=t||await this.getAmmPoolKeys(e.id),x=4;return e.pooltype.includes("StablePool")&&(x=5),d.addInstruction({instructions:[Ho({version:x,poolKeys:L,userKeys:{tokenAccountIn:P,tokenAccountOut:A,owner:this.scope.ownerPubKey},amountIn:n,amountOut:i,fixedSide:a})],instructionTypes:[x===4?Q.AmmV4SwapBaseIn:Q.AmmV5SwapBaseIn]}),d.addCustomComputeBudget(u),d.addTipInstruction(l),d.versionBuild({txVersion:s})}async getRpcPoolInfo(e){return(await this.getRpcPoolInfos([e]))[e]}async getRpcPoolInfos(e,t){let n=await Kt(this.scope.connection,e.map(u=>({pubkey:new ke(u)})),t),i={},o=[];for(let u=0;u<e.length;u++){let l=n[u];if(l===null||!l.accountInfo)throw Error("fetch pool info error: "+String(e[u]));let m=$r.decode(l.accountInfo.data);i[String(e[u])]={...m,programId:l.accountInfo.owner},o.push(m.baseVault,m.quoteVault)}let a={},s=await Kt(this.scope.connection,o.map(u=>({pubkey:new ke(u)})),t);for(let u=0;u<o.length;u++){let l=s[u].accountInfo;if(l===null)throw Error("fetch vault info error: "+o[u]);a[String(o[u])]=new be(kc.decode(l.data).amount.toString())}let c={};for(let[u,l]of Object.entries(i)){let m=a[l.baseVault.toString()].sub(l.baseNeedTakePnl),d=a[l.quoteVault.toString()].sub(l.quoteNeedTakePnl);c[u]={...l,baseReserve:m,mintAAmount:a[l.baseVault.toString()],mintBAmount:a[l.quoteVault.toString()],quoteReserve:d,poolPrice:new N(d.toString()).div(new N(10).pow(l.quoteDecimal.toString())).div(new N(m.toString()).div(new N(10).pow(l.baseDecimal.toString())))}}return c}async getPoolInfoFromRpc({poolId:e}){let t=await this.getRpcPoolInfo(e),n=ts({[e]:t}),i=n[e],o=await this.scope.tradeV2.computePoolToPoolKeys({pools:[n[e]],ammRpcData:{[e]:t}});return{poolRpcData:t,poolInfo:i,poolKeys:o[0]}}};export{pi as default};
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=liquidity.mjs.map