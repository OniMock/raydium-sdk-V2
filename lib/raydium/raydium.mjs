var Zc=Object.defineProperty;var $c=(r,e,t)=>e in r?Zc(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var Tt=(r,e,t)=>($c(r,typeof e!="symbol"?e+"":e,t),t);import{merge as af}from"lodash";import Za from"axios";import{PublicKey as pa}from"@solana/web3.js";import{get as ma,set as Jc}from"lodash";var _r=class{logLevel;name;constructor(e){this.logLevel=e.logLevel!==void 0?e.logLevel:0,this.name=e.name}set level(e){this.logLevel=e}get time(){return Date.now().toString()}get moduleName(){return this.name}isLogLevel(e){return e<=this.logLevel}error(...e){return this.isLogLevel(0)?(console.error(this.time,this.name,"sdk logger error",...e),this):this}logWithError(...e){let t=e.map(n=>typeof n=="object"?JSON.stringify(n):n).join(", ");throw new Error(t)}warning(...e){return this.isLogLevel(1)?(console.warn(this.time,this.name,"sdk logger warning",...e),this):this}info(...e){return this.isLogLevel(2)?(console.info(this.time,this.name,"sdk logger info",...e),this):this}debug(...e){return this.isLogLevel(3)?(console.debug(this.time,this.name,"sdk logger debug",...e),this):this}},da={},el={};function de(r){let e=ma(da,r);if(!e){let t=ma(el,r);e=new _r({name:r,logLevel:t}),Jc(da,r,e)}return e}import{MINT_SIZE as tl,TOKEN_PROGRAM_ID as nl,getTransferFeeConfig as ol,unpackMint as il}from"@solana/spl-token";var Er=de("Raydium_accountInfo_util");async function _t(r,e,t){let{batchRequest:n,commitment:o="confirmed",chunkCount:i=100}={batchRequest:!1,...t},s=Fr(e,i),a=new Array(s.length).fill([]);if(n){let c=s.map(m=>{let d=r._buildArgs([m.map(p=>p.toBase58())],o,"base64");return{methodName:"getMultipleAccounts",args:d}}),u=Fr(c,10);a=(await(await Promise.all(u.map(async m=>await r._rpcBatchRequest(m)))).flat()).map(m=>(m.error&&Er.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${m.error.message}`),m.result.value.map(d=>{if(d){let{data:p,executable:f,lamports:y,owner:b,rentEpoch:g}=d;return p.length!==2&&p[1]!=="base64"&&Er.logWithError("info must be base64 encoded, RPC_ERROR"),{data:Buffer.from(p[0],"base64"),executable:f,lamports:y,owner:new pa(b),rentEpoch:g}}return null})))}else try{a=await Promise.all(s.map(c=>r.getMultipleAccountsInfo(c,o)))}catch(c){c instanceof Error&&Er.logWithError(`failed to get info for multiple accounts, RPC_ERROR, ${c.message}`)}return a.flat()}async function xe(r,e,t){let n=await _t(r,e.map(o=>o.pubkey),t);return e.map((o,i)=>({...o,accountInfo:n[i]}))}async function Yn({connection:r,mints:e,config:t}){if(e.length===0)return{};let n=await xe(r,e.map(i=>({pubkey:rt(i)})),t),o={};for(let i of n){if(!i.accountInfo||i.accountInfo.data.length<tl){console.log("invalid mint account",i.pubkey.toBase58());continue}let s=il(i.pubkey,i.accountInfo,i.accountInfo?.owner);o[i.pubkey.toString()]={...s,programId:i.accountInfo?.owner||nl,feeConfig:ol(s)??void 0}}return o[pa.default.toBase58()]=o[H.toBase58()],o}import Yt from"bn.js";var Zn=9e15,yn=1e9,Vr="0123456789abcdef",Pi="2.3025850929940456840179914546843642076011014886287729760333279009675726096773524802359972050895982983419677840422862486334095254650828067566662873690987816894829072083255546808437998948262331985283935053089653777326288461633662222876982198867465436674744042432743651550489343149393914796194044002221051017141748003688084012647080685567743216228355220114804663715659121373450747856947683463616792101806445070648000277502684916746550586856935673420670581136429224554405758925724208241314695689016758940256776311356919292033376587141660230105703089634572075440370847469940168269282808481184289314848524948644871927809676271275775397027668605952496716674183485704422507197965004714951050492214776567636938662976979522110718264549734772662425709429322582798502585509785265383207606726317164309505995087807523710333101197857547331541421808427543863591778117054309827482385045648019095610299291824318237525357709750539565187697510374970888692180205189339507238539205144634197265287286965110862571492198849978748873771345686209167058",wi="3.1415926535897932384626433832795028841971693993751058209749445923078164062862089986280348253421170679821480865132823066470938446095505822317253594081284811174502841027019385211055596446229489549303819644288109756659334461284756482337867831652712019091456485669234603486104543266482133936072602491412737245870066063155881748815209209628292540917153643678925903600113305305488204665213841469519415116094330572703657595919530921861173819326117931051185480744623799627495673518857527248912279381830119491298336733624406566430860213949463952247371907021798609437027705392171762931767523846748184676694051320005681271452635608277857713427577896091736371787214684409012249534301465495853710507922796892589235420199561121290219608640344181598136297747713099605187072113499999983729780499510597317328160963185950244594553469083026425223082533446850352619311881710100031378387528865875332083814206171776691473035982534904287554687311595628638823537875937519577818577805321712268066130019278766111959092164201989380952572010654858632789",Wr={precision:20,rounding:4,modulo:1,toExpNeg:-7,toExpPos:21,minE:-Zn,maxE:Zn,crypto:!1},ga,on,se=!0,hi="[DecimalError] ",bn=hi+"Invalid argument: ",Aa=hi+"Precision limit exceeded",Pa=hi+"crypto unavailable",wa="[object Decimal]",st=Math.floor,Xe=Math.pow,rl=/^0b([01]+(\.[01]*)?|\.[01]+)(p[+-]?\d+)?$/i,sl=/^0x([0-9a-f]+(\.[0-9a-f]*)?|\.[0-9a-f]+)(p[+-]?\d+)?$/i,al=/^0o([0-7]+(\.[0-7]*)?|\.[0-7]+)(p[+-]?\d+)?$/i,ka=/^(\d+(\.\d*)?|\.\d+)(e[+-]?\d+)?$/i,Ft=1e7,te=7,ul=9007199254740991,cl=Pi.length-1,Dr=wi.length-1,F={toStringTag:wa};F.absoluteValue=F.abs=function(){var r=new this.constructor(this);return r.s<0&&(r.s=1),Y(r)};F.ceil=function(){return Y(new this.constructor(this),this.e+1,2)};F.clampedTo=F.clamp=function(r,e){var t,n=this,o=n.constructor;if(r=new o(r),e=new o(e),!r.s||!e.s)return new o(NaN);if(r.gt(e))throw Error(bn+e);return t=n.cmp(r),t<0?r:n.cmp(e)>0?e:new o(n)};F.comparedTo=F.cmp=function(r){var e,t,n,o,i=this,s=i.d,a=(r=new i.constructor(r)).d,c=i.s,u=r.s;if(!s||!a)return!c||!u?NaN:c!==u?c:s===a?0:!s^c<0?1:-1;if(!s[0]||!a[0])return s[0]?c:a[0]?-u:0;if(c!==u)return c;if(i.e!==r.e)return i.e>r.e^c<0?1:-1;for(n=s.length,o=a.length,e=0,t=n<o?n:o;e<t;++e)if(s[e]!==a[e])return s[e]>a[e]^c<0?1:-1;return n===o?0:n>o^c<0?1:-1};F.cosine=F.cos=function(){var r,e,t=this,n=t.constructor;return t.d?t.d[0]?(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+te,n.rounding=1,t=ll(n,xa(n,t)),n.precision=r,n.rounding=e,Y(on==2||on==3?t.neg():t,r,e,!0)):new n(1):new n(NaN)};F.cubeRoot=F.cbrt=function(){var r,e,t,n,o,i,s,a,c,u,l=this,m=l.constructor;if(!l.isFinite()||l.isZero())return new m(l);for(se=!1,i=l.s*Xe(l.s*l,1/3),!i||Math.abs(i)==1/0?(t=Je(l.d),r=l.e,(i=(r-t.length+1)%3)&&(t+=i==1||i==-2?"0":"00"),i=Xe(t,1/3),r=st((r+1)/3)-(r%3==(r<0?-1:2)),i==1/0?t="5e"+r:(t=i.toExponential(),t=t.slice(0,t.indexOf("e")+1)+r),n=new m(t),n.s=l.s):n=new m(i.toString()),s=(r=m.precision)+3;;)if(a=n,c=a.times(a).times(a),u=c.plus(l),n=Be(u.plus(l).times(a),u.plus(c),s+2,1),Je(a.d).slice(0,s)===(t=Je(n.d)).slice(0,s))if(t=t.slice(s-3,s+1),t=="9999"||!o&&t=="4999"){if(!o&&(Y(a,r+1,0),a.times(a).times(a).eq(l))){n=a;break}s+=4,o=1}else{(!+t||!+t.slice(1)&&t.charAt(0)=="5")&&(Y(n,r+1,1),e=!n.times(n).times(n).eq(l));break}return se=!0,Y(n,r,m.rounding,e)};F.decimalPlaces=F.dp=function(){var r,e=this.d,t=NaN;if(e){if(r=e.length-1,t=(r-st(this.e/te))*te,r=e[r],r)for(;r%10==0;r/=10)t--;t<0&&(t=0)}return t};F.dividedBy=F.div=function(r){return Be(this,new this.constructor(r))};F.dividedToIntegerBy=F.divToInt=function(r){var e=this,t=e.constructor;return Y(Be(e,new t(r),0,1,1),t.precision,t.rounding)};F.equals=F.eq=function(r){return this.cmp(r)===0};F.floor=function(){return Y(new this.constructor(this),this.e+1,3)};F.greaterThan=F.gt=function(r){return this.cmp(r)>0};F.greaterThanOrEqualTo=F.gte=function(r){var e=this.cmp(r);return e==1||e===0};F.hyperbolicCosine=F.cosh=function(){var r,e,t,n,o,i=this,s=i.constructor,a=new s(1);if(!i.isFinite())return new s(i.s?1/0:NaN);if(i.isZero())return a;t=s.precision,n=s.rounding,s.precision=t+Math.max(i.e,i.sd())+4,s.rounding=1,o=i.d.length,o<32?(r=Math.ceil(o/3),e=(1/Ii(4,r)).toString()):(r=16,e="2.3283064365386962890625e-10"),i=$n(s,1,i.times(e),new s(1),!0);for(var c,u=r,l=new s(8);u--;)c=i.times(i),i=a.minus(c.times(l.minus(c.times(l))));return Y(i,s.precision=t,s.rounding=n,!0)};F.hyperbolicSine=F.sinh=function(){var r,e,t,n,o=this,i=o.constructor;if(!o.isFinite()||o.isZero())return new i(o);if(e=i.precision,t=i.rounding,i.precision=e+Math.max(o.e,o.sd())+4,i.rounding=1,n=o.d.length,n<3)o=$n(i,2,o,o,!0);else{r=1.4*Math.sqrt(n),r=r>16?16:r|0,o=o.times(1/Ii(5,r)),o=$n(i,2,o,o,!0);for(var s,a=new i(5),c=new i(16),u=new i(20);r--;)s=o.times(o),o=o.times(a.plus(s.times(c.times(s).plus(u))))}return i.precision=e,i.rounding=t,Y(o,e,t,!0)};F.hyperbolicTangent=F.tanh=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+7,n.rounding=1,Be(t.sinh(),t.cosh(),n.precision=r,n.rounding=e)):new n(t.s)};F.inverseCosine=F.acos=function(){var r,e=this,t=e.constructor,n=e.abs().cmp(1),o=t.precision,i=t.rounding;return n!==-1?n===0?e.isNeg()?Et(t,o,i):new t(0):new t(NaN):e.isZero()?Et(t,o+4,i).times(.5):(t.precision=o+6,t.rounding=1,e=e.asin(),r=Et(t,o+4,i).times(.5),t.precision=o,t.rounding=i,r.minus(e))};F.inverseHyperbolicCosine=F.acosh=function(){var r,e,t=this,n=t.constructor;return t.lte(1)?new n(t.eq(1)?0:NaN):t.isFinite()?(r=n.precision,e=n.rounding,n.precision=r+Math.max(Math.abs(t.e),t.sd())+4,n.rounding=1,se=!1,t=t.times(t).minus(1).sqrt().plus(t),se=!0,n.precision=r,n.rounding=e,t.ln()):new n(t)};F.inverseHyperbolicSine=F.asinh=function(){var r,e,t=this,n=t.constructor;return!t.isFinite()||t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+2*Math.max(Math.abs(t.e),t.sd())+6,n.rounding=1,se=!1,t=t.times(t).plus(1).sqrt().plus(t),se=!0,n.precision=r,n.rounding=e,t.ln())};F.inverseHyperbolicTangent=F.atanh=function(){var r,e,t,n,o=this,i=o.constructor;return o.isFinite()?o.e>=0?new i(o.abs().eq(1)?o.s/0:o.isZero()?o:NaN):(r=i.precision,e=i.rounding,n=o.sd(),Math.max(n,r)<2*-o.e-1?Y(new i(o),r,e,!0):(i.precision=t=n-o.e,o=Be(o.plus(1),new i(1).minus(o),t+r,1),i.precision=r+4,i.rounding=1,o=o.ln(),i.precision=r,i.rounding=e,o.times(.5))):new i(NaN)};F.inverseSine=F.asin=function(){var r,e,t,n,o=this,i=o.constructor;return o.isZero()?new i(o):(e=o.abs().cmp(1),t=i.precision,n=i.rounding,e!==-1?e===0?(r=Et(i,t+4,n).times(.5),r.s=o.s,r):new i(NaN):(i.precision=t+6,i.rounding=1,o=o.div(new i(1).minus(o.times(o)).sqrt().plus(1)).atan(),i.precision=t,i.rounding=n,o.times(2)))};F.inverseTangent=F.atan=function(){var r,e,t,n,o,i,s,a,c,u=this,l=u.constructor,m=l.precision,d=l.rounding;if(u.isFinite()){if(u.isZero())return new l(u);if(u.abs().eq(1)&&m+4<=Dr)return s=Et(l,m+4,d).times(.25),s.s=u.s,s}else{if(!u.s)return new l(NaN);if(m+4<=Dr)return s=Et(l,m+4,d).times(.5),s.s=u.s,s}for(l.precision=a=m+10,l.rounding=1,t=Math.min(28,a/te+2|0),r=t;r;--r)u=u.div(u.times(u).plus(1).sqrt().plus(1));for(se=!1,e=Math.ceil(a/te),n=1,c=u.times(u),s=new l(u),o=u;r!==-1;)if(o=o.times(c),i=s.minus(o.div(n+=2)),o=o.times(c),s=i.plus(o.div(n+=2)),s.d[e]!==void 0)for(r=e;s.d[r]===i.d[r]&&r--;);return t&&(s=s.times(2<<t-1)),se=!0,Y(s,l.precision=m,l.rounding=d,!0)};F.isFinite=function(){return!!this.d};F.isInteger=F.isInt=function(){return!!this.d&&st(this.e/te)>this.d.length-2};F.isNaN=function(){return!this.s};F.isNegative=F.isNeg=function(){return this.s<0};F.isPositive=F.isPos=function(){return this.s>0};F.isZero=function(){return!!this.d&&this.d[0]===0};F.lessThan=F.lt=function(r){return this.cmp(r)<0};F.lessThanOrEqualTo=F.lte=function(r){return this.cmp(r)<1};F.logarithm=F.log=function(r){var e,t,n,o,i,s,a,c,u=this,l=u.constructor,m=l.precision,d=l.rounding,p=5;if(r==null)r=new l(10),e=!0;else{if(r=new l(r),t=r.d,r.s<0||!t||!t[0]||r.eq(1))return new l(NaN);e=r.eq(10)}if(t=u.d,u.s<0||!t||!t[0]||u.eq(1))return new l(t&&!t[0]?-1/0:u.s!=1?NaN:t?0:1/0);if(e)if(t.length>1)i=!0;else{for(o=t[0];o%10===0;)o/=10;i=o!==1}if(se=!1,a=m+p,s=fn(u,a),n=e?ki(l,a+10):fn(r,a),c=Be(s,n,a,1),yo(c.d,o=m,d))do if(a+=10,s=fn(u,a),n=e?ki(l,a+10):fn(r,a),c=Be(s,n,a,1),!i){+Je(c.d).slice(o+1,o+15)+1==1e14&&(c=Y(c,m+1,0));break}while(yo(c.d,o+=10,d));return se=!0,Y(c,m,d)};F.minus=F.sub=function(r){var e,t,n,o,i,s,a,c,u,l,m,d,p=this,f=p.constructor;if(r=new f(r),!p.d||!r.d)return!p.s||!r.s?r=new f(NaN):p.d?r.s=-r.s:r=new f(r.d||p.s!==r.s?p:NaN),r;if(p.s!=r.s)return r.s=-r.s,p.plus(r);if(u=p.d,d=r.d,a=f.precision,c=f.rounding,!u[0]||!d[0]){if(d[0])r.s=-r.s;else if(u[0])r=new f(p);else return new f(c===3?-0:0);return se?Y(r,a,c):r}if(t=st(r.e/te),l=st(p.e/te),u=u.slice(),i=l-t,i){for(m=i<0,m?(e=u,i=-i,s=d.length):(e=d,t=l,s=u.length),n=Math.max(Math.ceil(a/te),s)+2,i>n&&(i=n,e.length=1),e.reverse(),n=i;n--;)e.push(0);e.reverse()}else{for(n=u.length,s=d.length,m=n<s,m&&(s=n),n=0;n<s;n++)if(u[n]!=d[n]){m=u[n]<d[n];break}i=0}for(m&&(e=u,u=d,d=e,r.s=-r.s),s=u.length,n=d.length-s;n>0;--n)u[s++]=0;for(n=d.length;n>i;){if(u[--n]<d[n]){for(o=n;o&&u[--o]===0;)u[o]=Ft-1;--u[o],u[n]+=Ft}u[n]-=d[n]}for(;u[--s]===0;)u.pop();for(;u[0]===0;u.shift())--t;return u[0]?(r.d=u,r.e=Ti(u,t),se?Y(r,a,c):r):new f(c===3?-0:0)};F.modulo=F.mod=function(r){var e,t=this,n=t.constructor;return r=new n(r),!t.d||!r.s||r.d&&!r.d[0]?new n(NaN):!r.d||t.d&&!t.d[0]?Y(new n(t),n.precision,n.rounding):(se=!1,n.modulo==9?(e=Be(t,r.abs(),0,3,1),e.s*=r.s):e=Be(t,r,0,n.modulo,1),e=e.times(r),se=!0,t.minus(e))};F.naturalExponential=F.exp=function(){return qr(this)};F.naturalLogarithm=F.ln=function(){return fn(this)};F.negated=F.neg=function(){var r=new this.constructor(this);return r.s=-r.s,Y(r)};F.plus=F.add=function(r){var e,t,n,o,i,s,a,c,u,l,m=this,d=m.constructor;if(r=new d(r),!m.d||!r.d)return!m.s||!r.s?r=new d(NaN):m.d||(r=new d(r.d||m.s===r.s?m:NaN)),r;if(m.s!=r.s)return r.s=-r.s,m.minus(r);if(u=m.d,l=r.d,a=d.precision,c=d.rounding,!u[0]||!l[0])return l[0]||(r=new d(m)),se?Y(r,a,c):r;if(i=st(m.e/te),n=st(r.e/te),u=u.slice(),o=i-n,o){for(o<0?(t=u,o=-o,s=l.length):(t=l,n=i,s=u.length),i=Math.ceil(a/te),s=i>s?i+1:s+1,o>s&&(o=s,t.length=1),t.reverse();o--;)t.push(0);t.reverse()}for(s=u.length,o=l.length,s-o<0&&(o=s,t=l,l=u,u=t),e=0;o;)e=(u[--o]=u[o]+l[o]+e)/Ft|0,u[o]%=Ft;for(e&&(u.unshift(e),++n),s=u.length;u[--s]==0;)u.pop();return r.d=u,r.e=Ti(u,n),se?Y(r,a,c):r};F.precision=F.sd=function(r){var e,t=this;if(r!==void 0&&r!==!!r&&r!==1&&r!==0)throw Error(bn+r);return t.d?(e=ha(t.d),r&&t.e+1>e&&(e=t.e+1)):e=NaN,e};F.round=function(){var r=this,e=r.constructor;return Y(new e(r),r.e+1,e.rounding)};F.sine=F.sin=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+Math.max(t.e,t.sd())+te,n.rounding=1,t=dl(n,xa(n,t)),n.precision=r,n.rounding=e,Y(on>2?t.neg():t,r,e,!0)):new n(NaN)};F.squareRoot=F.sqrt=function(){var r,e,t,n,o,i,s=this,a=s.d,c=s.e,u=s.s,l=s.constructor;if(u!==1||!a||!a[0])return new l(!u||u<0&&(!a||a[0])?NaN:a?s:1/0);for(se=!1,u=Math.sqrt(+s),u==0||u==1/0?(e=Je(a),(e.length+c)%2==0&&(e+="0"),u=Math.sqrt(e),c=st((c+1)/2)-(c<0||c%2),u==1/0?e="5e"+c:(e=u.toExponential(),e=e.slice(0,e.indexOf("e")+1)+c),n=new l(e)):n=new l(u.toString()),t=(c=l.precision)+3;;)if(i=n,n=i.plus(Be(s,i,t+2,1)).times(.5),Je(i.d).slice(0,t)===(e=Je(n.d)).slice(0,t))if(e=e.slice(t-3,t+1),e=="9999"||!o&&e=="4999"){if(!o&&(Y(i,c+1,0),i.times(i).eq(s))){n=i;break}t+=4,o=1}else{(!+e||!+e.slice(1)&&e.charAt(0)=="5")&&(Y(n,c+1,1),r=!n.times(n).eq(s));break}return se=!0,Y(n,c,l.rounding,r)};F.tangent=F.tan=function(){var r,e,t=this,n=t.constructor;return t.isFinite()?t.isZero()?new n(t):(r=n.precision,e=n.rounding,n.precision=r+10,n.rounding=1,t=t.sin(),t.s=1,t=Be(t,new n(1).minus(t.times(t)).sqrt(),r+10,0),n.precision=r,n.rounding=e,Y(on==2||on==4?t.neg():t,r,e,!0)):new n(NaN)};F.times=F.mul=function(r){var e,t,n,o,i,s,a,c,u,l=this,m=l.constructor,d=l.d,p=(r=new m(r)).d;if(r.s*=l.s,!d||!d[0]||!p||!p[0])return new m(!r.s||d&&!d[0]&&!p||p&&!p[0]&&!d?NaN:!d||!p?r.s/0:r.s*0);for(t=st(l.e/te)+st(r.e/te),c=d.length,u=p.length,c<u&&(i=d,d=p,p=i,s=c,c=u,u=s),i=[],s=c+u,n=s;n--;)i.push(0);for(n=u;--n>=0;){for(e=0,o=c+n;o>n;)a=i[o]+p[n]*d[o-n-1]+e,i[o--]=a%Ft|0,e=a/Ft|0;i[o]=(i[o]+e)%Ft|0}for(;!i[--s];)i.pop();return e?++t:i.shift(),r.d=i,r.e=Ti(i,t),se?Y(r,m.precision,m.rounding):r};F.toBinary=function(r,e){return Gr(this,2,r,e)};F.toDecimalPlaces=F.toDP=function(r,e){var t=this,n=t.constructor;return t=new n(t),r===void 0?t:(yt(r,0,yn),e===void 0?e=n.rounding:yt(e,0,8),Y(t,r+t.e+1,e))};F.toExponential=function(r,e){var t,n=this,o=n.constructor;return r===void 0?t=jt(n,!0):(yt(r,0,yn),e===void 0?e=o.rounding:yt(e,0,8),n=Y(new o(n),r+1,e),t=jt(n,!0,r+1)),n.isNeg()&&!n.isZero()?"-"+t:t};F.toFixed=function(r,e){var t,n,o=this,i=o.constructor;return r===void 0?t=jt(o):(yt(r,0,yn),e===void 0?e=i.rounding:yt(e,0,8),n=Y(new i(o),r+o.e+1,e),t=jt(n,!1,r+n.e+1)),o.isNeg()&&!o.isZero()?"-"+t:t};F.toFraction=function(r){var e,t,n,o,i,s,a,c,u,l,m,d,p=this,f=p.d,y=p.constructor;if(!f)return new y(p);if(u=t=new y(1),n=c=new y(0),e=new y(n),i=e.e=ha(f)-p.e-1,s=i%te,e.d[0]=Xe(10,s<0?te+s:s),r==null)r=i>0?e:u;else{if(a=new y(r),!a.isInt()||a.lt(u))throw Error(bn+a);r=a.gt(e)?i>0?e:u:a}for(se=!1,a=new y(Je(f)),l=y.precision,y.precision=i=f.length*te*2;m=Be(a,e,0,1,1),o=t.plus(m.times(n)),o.cmp(r)!=1;)t=n,n=o,o=u,u=c.plus(m.times(o)),c=o,o=e,e=a.minus(m.times(o)),a=o;return o=Be(r.minus(t),n,0,1,1),c=c.plus(o.times(u)),t=t.plus(o.times(n)),c.s=u.s=p.s,d=Be(u,n,i,1).minus(p).abs().cmp(Be(c,t,i,1).minus(p).abs())<1?[u,n]:[c,t],y.precision=l,se=!0,d};F.toHexadecimal=F.toHex=function(r,e){return Gr(this,16,r,e)};F.toNearest=function(r,e){var t=this,n=t.constructor;if(t=new n(t),r==null){if(!t.d)return t;r=new n(1),e=n.rounding}else{if(r=new n(r),e===void 0?e=n.rounding:yt(e,0,8),!t.d)return r.s?t:r;if(!r.d)return r.s&&(r.s=t.s),r}return r.d[0]?(se=!1,t=Be(t,r,0,e,1).times(r),se=!0,Y(t)):(r.s=t.s,t=r),t};F.toNumber=function(){return+this};F.toOctal=function(r,e){return Gr(this,8,r,e)};F.toPower=F.pow=function(r){var e,t,n,o,i,s,a=this,c=a.constructor,u=+(r=new c(r));if(!a.d||!r.d||!a.d[0]||!r.d[0])return new c(Xe(+a,u));if(a=new c(a),a.eq(1))return a;if(n=c.precision,i=c.rounding,r.eq(1))return Y(a,n,i);if(e=st(r.e/te),e>=r.d.length-1&&(t=u<0?-u:u)<=ul)return o=Ta(c,a,t,n),r.s<0?new c(1).div(o):Y(o,n,i);if(s=a.s,s<0){if(e<r.d.length-1)return new c(NaN);if((r.d[e]&1)==0&&(s=1),a.e==0&&a.d[0]==1&&a.d.length==1)return a.s=s,a}return t=Xe(+a,u),e=t==0||!isFinite(t)?st(u*(Math.log("0."+Je(a.d))/Math.LN10+a.e+1)):new c(t+"").e,e>c.maxE+1||e<c.minE-1?new c(e>0?s/0:0):(se=!1,c.rounding=a.s=1,t=Math.min(12,(e+"").length),o=qr(r.times(fn(a,n+t)),n),o.d&&(o=Y(o,n+5,1),yo(o.d,n,i)&&(e=n+10,o=Y(qr(r.times(fn(a,e+t)),e),e+5,1),+Je(o.d).slice(n+1,n+15)+1==1e14&&(o=Y(o,n+1,0)))),o.s=s,se=!0,c.rounding=i,Y(o,n,i))};F.toPrecision=function(r,e){var t,n=this,o=n.constructor;return r===void 0?t=jt(n,n.e<=o.toExpNeg||n.e>=o.toExpPos):(yt(r,1,yn),e===void 0?e=o.rounding:yt(e,0,8),n=Y(new o(n),r,e),t=jt(n,r<=n.e||n.e<=o.toExpNeg,r)),n.isNeg()&&!n.isZero()?"-"+t:t};F.toSignificantDigits=F.toSD=function(r,e){var t=this,n=t.constructor;return r===void 0?(r=n.precision,e=n.rounding):(yt(r,1,yn),e===void 0?e=n.rounding:yt(e,0,8)),Y(new n(t),r,e)};F.toString=function(){var r=this,e=r.constructor,t=jt(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()&&!r.isZero()?"-"+t:t};F.truncated=F.trunc=function(){return Y(new this.constructor(this),this.e+1,1)};F.valueOf=F.toJSON=function(){var r=this,e=r.constructor,t=jt(r,r.e<=e.toExpNeg||r.e>=e.toExpPos);return r.isNeg()?"-"+t:t};function Je(r){var e,t,n,o=r.length-1,i="",s=r[0];if(o>0){for(i+=s,e=1;e<o;e++)n=r[e]+"",t=te-n.length,t&&(i+=pn(t)),i+=n;s=r[e],n=s+"",t=te-n.length,t&&(i+=pn(t))}else if(s===0)return"0";for(;s%10===0;)s/=10;return i+s}function yt(r,e,t){if(r!==~~r||r<e||r>t)throw Error(bn+r)}function yo(r,e,t,n){var o,i,s,a;for(i=r[0];i>=10;i/=10)--e;return--e<0?(e+=te,o=0):(o=Math.ceil((e+1)/te),e%=te),i=Xe(10,te-e),a=r[o]%i|0,n==null?e<3?(e==0?a=a/100|0:e==1&&(a=a/10|0),s=t<4&&a==99999||t>3&&a==49999||a==5e4||a==0):s=(t<4&&a+1==i||t>3&&a+1==i/2)&&(r[o+1]/i/100|0)==Xe(10,e-2)-1||(a==i/2||a==0)&&(r[o+1]/i/100|0)==0:e<4?(e==0?a=a/1e3|0:e==1?a=a/100|0:e==2&&(a=a/10|0),s=(n||t<4)&&a==9999||!n&&t>3&&a==4999):s=((n||t<4)&&a+1==i||!n&&t>3&&a+1==i/2)&&(r[o+1]/i/1e3|0)==Xe(10,e-3)-1,s}function Ai(r,e,t){for(var n,o=[0],i,s=0,a=r.length;s<a;){for(i=o.length;i--;)o[i]*=e;for(o[0]+=Vr.indexOf(r.charAt(s++)),n=0;n<o.length;n++)o[n]>t-1&&(o[n+1]===void 0&&(o[n+1]=0),o[n+1]+=o[n]/t|0,o[n]%=t)}return o.reverse()}function ll(r,e){var t,n,o;if(e.isZero())return e;n=e.d.length,n<32?(t=Math.ceil(n/3),o=(1/Ii(4,t)).toString()):(t=16,o="2.3283064365386962890625e-10"),r.precision+=t,e=$n(r,1,e.times(o),new r(1));for(var i=t;i--;){var s=e.times(e);e=s.times(s).minus(s).times(8).plus(1)}return r.precision-=t,e}var Be=function(){function r(n,o,i){var s,a=0,c=n.length;for(n=n.slice();c--;)s=n[c]*o+a,n[c]=s%i|0,a=s/i|0;return a&&n.unshift(a),n}function e(n,o,i,s){var a,c;if(i!=s)c=i>s?1:-1;else for(a=c=0;a<i;a++)if(n[a]!=o[a]){c=n[a]>o[a]?1:-1;break}return c}function t(n,o,i,s){for(var a=0;i--;)n[i]-=a,a=n[i]<o[i]?1:0,n[i]=a*s+n[i]-o[i];for(;!n[0]&&n.length>1;)n.shift()}return function(n,o,i,s,a,c){var u,l,m,d,p,f,y,b,g,P,w,k,x,h,I,S,T,K,R,N,v=n.constructor,W=n.s==o.s?1:-1,D=n.d,U=o.d;if(!D||!D[0]||!U||!U[0])return new v(!n.s||!o.s||(D?U&&D[0]==U[0]:!U)?NaN:D&&D[0]==0||!U?W*0:W/0);for(c?(p=1,l=n.e-o.e):(c=Ft,p=te,l=st(n.e/p)-st(o.e/p)),R=U.length,T=D.length,g=new v(W),P=g.d=[],m=0;U[m]==(D[m]||0);m++);if(U[m]>(D[m]||0)&&l--,i==null?(h=i=v.precision,s=v.rounding):a?h=i+(n.e-o.e)+1:h=i,h<0)P.push(1),f=!0;else{if(h=h/p+2|0,m=0,R==1){for(d=0,U=U[0],h++;(m<T||d)&&h--;m++)I=d*c+(D[m]||0),P[m]=I/U|0,d=I%U|0;f=d||m<T}else{for(d=c/(U[0]+1)|0,d>1&&(U=r(U,d,c),D=r(D,d,c),R=U.length,T=D.length),S=R,w=D.slice(0,R),k=w.length;k<R;)w[k++]=0;N=U.slice(),N.unshift(0),K=U[0],U[1]>=c/2&&++K;do d=0,u=e(U,w,R,k),u<0?(x=w[0],R!=k&&(x=x*c+(w[1]||0)),d=x/K|0,d>1?(d>=c&&(d=c-1),y=r(U,d,c),b=y.length,k=w.length,u=e(y,w,b,k),u==1&&(d--,t(y,R<b?N:U,b,c))):(d==0&&(u=d=1),y=U.slice()),b=y.length,b<k&&y.unshift(0),t(w,y,k,c),u==-1&&(k=w.length,u=e(U,w,R,k),u<1&&(d++,t(w,R<k?N:U,k,c))),k=w.length):u===0&&(d++,w=[0]),P[m++]=d,u&&w[0]?w[k++]=D[S]||0:(w=[D[S]],k=1);while((S++<T||w[0]!==void 0)&&h--);f=w[0]!==void 0}P[0]||P.shift()}if(p==1)g.e=l,ga=f;else{for(m=1,d=P[0];d>=10;d/=10)m++;g.e=m+l*p-1,Y(g,a?i+g.e+1:i,s,f)}return g}}();function Y(r,e,t,n){var o,i,s,a,c,u,l,m,d,p=r.constructor;e:if(e!=null){if(m=r.d,!m)return r;for(o=1,a=m[0];a>=10;a/=10)o++;if(i=e-o,i<0)i+=te,s=e,l=m[d=0],c=l/Xe(10,o-s-1)%10|0;else if(d=Math.ceil((i+1)/te),a=m.length,d>=a)if(n){for(;a++<=d;)m.push(0);l=c=0,o=1,i%=te,s=i-te+1}else break e;else{for(l=a=m[d],o=1;a>=10;a/=10)o++;i%=te,s=i-te+o,c=s<0?0:l/Xe(10,o-s-1)%10|0}if(n=n||e<0||m[d+1]!==void 0||(s<0?l:l%Xe(10,o-s-1)),u=t<4?(c||n)&&(t==0||t==(r.s<0?3:2)):c>5||c==5&&(t==4||n||t==6&&(i>0?s>0?l/Xe(10,o-s):0:m[d-1])%10&1||t==(r.s<0?8:7)),e<1||!m[0])return m.length=0,u?(e-=r.e+1,m[0]=Xe(10,(te-e%te)%te),r.e=-e||0):m[0]=r.e=0,r;if(i==0?(m.length=d,a=1,d--):(m.length=d+1,a=Xe(10,te-i),m[d]=s>0?(l/Xe(10,o-s)%Xe(10,s)|0)*a:0),u)for(;;)if(d==0){for(i=1,s=m[0];s>=10;s/=10)i++;for(s=m[0]+=a,a=1;s>=10;s/=10)a++;i!=a&&(r.e++,m[0]==Ft&&(m[0]=1));break}else{if(m[d]+=a,m[d]!=Ft)break;m[d--]=0,a=1}for(i=m.length;m[--i]===0;)m.pop()}return se&&(r.e>p.maxE?(r.d=null,r.e=NaN):r.e<p.minE&&(r.e=0,r.d=[0])),r}function jt(r,e,t){if(!r.isFinite())return Ba(r);var n,o=r.e,i=Je(r.d),s=i.length;return e?(t&&(n=t-s)>0?i=i.charAt(0)+"."+i.slice(1)+pn(n):s>1&&(i=i.charAt(0)+"."+i.slice(1)),i=i+(r.e<0?"e":"e+")+r.e):o<0?(i="0."+pn(-o-1)+i,t&&(n=t-s)>0&&(i+=pn(n))):o>=s?(i+=pn(o+1-s),t&&(n=t-o-1)>0&&(i=i+"."+pn(n))):((n=o+1)<s&&(i=i.slice(0,n)+"."+i.slice(n)),t&&(n=t-s)>0&&(o+1===s&&(i+="."),i+=pn(n))),i}function Ti(r,e){var t=r[0];for(e*=te;t>=10;t/=10)e++;return e}function ki(r,e,t){if(e>cl)throw se=!0,t&&(r.precision=t),Error(Aa);return Y(new r(Pi),e,1,!0)}function Et(r,e,t){if(e>Dr)throw Error(Aa);return Y(new r(wi),e,t,!0)}function ha(r){var e=r.length-1,t=e*te+1;if(e=r[e],e){for(;e%10==0;e/=10)t--;for(e=r[0];e>=10;e/=10)t++}return t}function pn(r){for(var e="";r--;)e+="0";return e}function Ta(r,e,t,n){var o,i=new r(1),s=Math.ceil(n/te+4);for(se=!1;;){if(t%2&&(i=i.times(e),ba(i.d,s)&&(o=!0)),t=st(t/2),t===0){t=i.d.length-1,o&&i.d[t]===0&&++i.d[t];break}e=e.times(e),ba(e.d,s)}return se=!0,i}function fa(r){return r.d[r.d.length-1]&1}function Ia(r,e,t){for(var n,o=new r(e[0]),i=0;++i<e.length;)if(n=new r(e[i]),n.s)o[t](n)&&(o=n);else{o=n;break}return o}function qr(r,e){var t,n,o,i,s,a,c,u=0,l=0,m=0,d=r.constructor,p=d.rounding,f=d.precision;if(!r.d||!r.d[0]||r.e>17)return new d(r.d?r.d[0]?r.s<0?0:1/0:1:r.s?r.s<0?0:r:0/0);for(e==null?(se=!1,c=f):c=e,a=new d(.03125);r.e>-2;)r=r.times(a),m+=5;for(n=Math.log(Xe(2,m))/Math.LN10*2+5|0,c+=n,t=i=s=new d(1),d.precision=c;;){if(i=Y(i.times(r),c,1),t=t.times(++l),a=s.plus(Be(i,t,c,1)),Je(a.d).slice(0,c)===Je(s.d).slice(0,c)){for(o=m;o--;)s=Y(s.times(s),c,1);if(e==null)if(u<3&&yo(s.d,c-n,p,u))d.precision=c+=10,t=i=a=new d(1),l=0,u++;else return Y(s,d.precision=f,p,se=!0);else return d.precision=f,s}s=a}}function fn(r,e){var t,n,o,i,s,a,c,u,l,m,d,p=1,f=10,y=r,b=y.d,g=y.constructor,P=g.rounding,w=g.precision;if(y.s<0||!b||!b[0]||!y.e&&b[0]==1&&b.length==1)return new g(b&&!b[0]?-1/0:y.s!=1?NaN:b?0:y);if(e==null?(se=!1,l=w):l=e,g.precision=l+=f,t=Je(b),n=t.charAt(0),Math.abs(i=y.e)<15e14){for(;n<7&&n!=1||n==1&&t.charAt(1)>3;)y=y.times(r),t=Je(y.d),n=t.charAt(0),p++;i=y.e,n>1?(y=new g("0."+t),i++):y=new g(n+"."+t.slice(1))}else return u=ki(g,l+2,w).times(i+""),y=fn(new g(n+"."+t.slice(1)),l-f).plus(u),g.precision=w,e==null?Y(y,w,P,se=!0):y;for(m=y,c=s=y=Be(y.minus(1),y.plus(1),l,1),d=Y(y.times(y),l,1),o=3;;){if(s=Y(s.times(d),l,1),u=c.plus(Be(s,new g(o),l,1)),Je(u.d).slice(0,l)===Je(c.d).slice(0,l))if(c=c.times(2),i!==0&&(c=c.plus(ki(g,l+2,w).times(i+""))),c=Be(c,new g(p),l,1),e==null)if(yo(c.d,l-f,P,a))g.precision=l+=f,u=s=y=Be(m.minus(1),m.plus(1),l,1),d=Y(y.times(y),l,1),o=a=1;else return Y(c,g.precision=w,P,se=!0);else return g.precision=w,c;c=u,o+=2}}function Ba(r){return String(r.s*r.s/0)}function Ur(r,e){var t,n,o;for((t=e.indexOf("."))>-1&&(e=e.replace(".","")),(n=e.search(/e/i))>0?(t<0&&(t=n),t+=+e.slice(n+1),e=e.substring(0,n)):t<0&&(t=e.length),n=0;e.charCodeAt(n)===48;n++);for(o=e.length;e.charCodeAt(o-1)===48;--o);if(e=e.slice(n,o),e){if(o-=n,r.e=t=t-n-1,r.d=[],n=(t+1)%te,t<0&&(n+=te),n<o){for(n&&r.d.push(+e.slice(0,n)),o-=te;n<o;)r.d.push(+e.slice(n,n+=te));e=e.slice(n),n=te-e.length}else n-=o;for(;n--;)e+="0";r.d.push(+e),se&&(r.e>r.constructor.maxE?(r.d=null,r.e=NaN):r.e<r.constructor.minE&&(r.e=0,r.d=[0]))}else r.e=0,r.d=[0];return r}function ml(r,e){var t,n,o,i,s,a,c,u,l;if(e.indexOf("_")>-1){if(e=e.replace(/(\d)_(?=\d)/g,"$1"),ka.test(e))return Ur(r,e)}else if(e==="Infinity"||e==="NaN")return+e||(r.s=NaN),r.e=NaN,r.d=null,r;if(sl.test(e))t=16,e=e.toLowerCase();else if(rl.test(e))t=2;else if(al.test(e))t=8;else throw Error(bn+e);for(i=e.search(/p/i),i>0?(c=+e.slice(i+1),e=e.substring(2,i)):e=e.slice(2),i=e.indexOf("."),s=i>=0,n=r.constructor,s&&(e=e.replace(".",""),a=e.length,i=a-i,o=Ta(n,new n(t),i,i*2)),u=Ai(e,t,Ft),l=u.length-1,i=l;u[i]===0;--i)u.pop();return i<0?new n(r.s*0):(r.e=Ti(u,l),r.d=u,se=!1,s&&(r=Be(r,o,a*4)),c&&(r=r.times(Math.abs(c)<54?Xe(2,c):go.pow(2,c))),se=!0,r)}function dl(r,e){var t,n=e.d.length;if(n<3)return e.isZero()?e:$n(r,2,e,e);t=1.4*Math.sqrt(n),t=t>16?16:t|0,e=e.times(1/Ii(5,t)),e=$n(r,2,e,e);for(var o,i=new r(5),s=new r(16),a=new r(20);t--;)o=e.times(e),e=e.times(i.plus(o.times(s.times(o).minus(a))));return e}function $n(r,e,t,n,o){var i,s,a,c,u=1,l=r.precision,m=Math.ceil(l/te);for(se=!1,c=t.times(t),a=new r(n);;){if(s=Be(a.times(c),new r(e++*e++),l,1),a=o?n.plus(s):n.minus(s),n=Be(s.times(c),new r(e++*e++),l,1),s=a.plus(n),s.d[m]!==void 0){for(i=m;s.d[i]===a.d[i]&&i--;);if(i==-1)break}i=a,a=n,n=s,s=i,u++}return se=!0,s.d.length=m+1,s}function Ii(r,e){for(var t=r;--e;)t*=r;return t}function xa(r,e){var t,n=e.s<0,o=Et(r,r.precision,1),i=o.times(.5);if(e=e.abs(),e.lte(i))return on=n?4:1,e;if(t=e.divToInt(o),t.isZero())on=n?3:2;else{if(e=e.minus(t.times(o)),e.lte(i))return on=fa(t)?n?2:3:n?4:1,e;on=fa(t)?n?1:4:n?3:2}return e.minus(o).abs()}function Gr(r,e,t,n){var o,i,s,a,c,u,l,m,d,p=r.constructor,f=t!==void 0;if(f?(yt(t,1,yn),n===void 0?n=p.rounding:yt(n,0,8)):(t=p.precision,n=p.rounding),!r.isFinite())l=Ba(r);else{for(l=jt(r),s=l.indexOf("."),f?(o=2,e==16?t=t*4-3:e==8&&(t=t*3-2)):o=e,s>=0&&(l=l.replace(".",""),d=new p(1),d.e=l.length-s,d.d=Ai(jt(d),10,o),d.e=d.d.length),m=Ai(l,10,o),i=c=m.length;m[--c]==0;)m.pop();if(!m[0])l=f?"0p+0":"0";else{if(s<0?i--:(r=new p(r),r.d=m,r.e=i,r=Be(r,d,t,n,0,o),m=r.d,i=r.e,u=ga),s=m[t],a=o/2,u=u||m[t+1]!==void 0,u=n<4?(s!==void 0||u)&&(n===0||n===(r.s<0?3:2)):s>a||s===a&&(n===4||u||n===6&&m[t-1]&1||n===(r.s<0?8:7)),m.length=t,u)for(;++m[--t]>o-1;)m[t]=0,t||(++i,m.unshift(1));for(c=m.length;!m[c-1];--c);for(s=0,l="";s<c;s++)l+=Vr.charAt(m[s]);if(f){if(c>1)if(e==16||e==8){for(s=e==16?4:3,--c;c%s;c++)l+="0";for(m=Ai(l,o,e),c=m.length;!m[c-1];--c);for(s=1,l="1.";s<c;s++)l+=Vr.charAt(m[s])}else l=l.charAt(0)+"."+l.slice(1);l=l+(i<0?"p":"p+")+i}else if(i<0){for(;++i;)l="0"+l;l="0."+l}else if(++i>c)for(i-=c;i--;)l+="0";else i<c&&(l=l.slice(0,i)+"."+l.slice(i))}l=(e==16?"0x":e==2?"0b":e==8?"0o":"")+l}return r.s<0?"-"+l:l}function ba(r,e){if(r.length>e)return r.length=e,!0}function pl(r){return new this(r).abs()}function fl(r){return new this(r).acos()}function bl(r){return new this(r).acosh()}function yl(r,e){return new this(r).plus(e)}function gl(r){return new this(r).asin()}function Al(r){return new this(r).asinh()}function Pl(r){return new this(r).atan()}function wl(r){return new this(r).atanh()}function kl(r,e){r=new this(r),e=new this(e);var t,n=this.precision,o=this.rounding,i=n+4;return!r.s||!e.s?t=new this(NaN):!r.d&&!e.d?(t=Et(this,i,1).times(e.s>0?.25:.75),t.s=r.s):!e.d||r.isZero()?(t=e.s<0?Et(this,n,o):new this(0),t.s=r.s):!r.d||e.isZero()?(t=Et(this,i,1).times(.5),t.s=r.s):e.s<0?(this.precision=i,this.rounding=1,t=this.atan(Be(r,e,i,1)),e=Et(this,i,1),this.precision=n,this.rounding=o,t=r.s<0?t.minus(e):t.plus(e)):t=this.atan(Be(r,e,i,1)),t}function hl(r){return new this(r).cbrt()}function Tl(r){return Y(r=new this(r),r.e+1,2)}function Il(r,e,t){return new this(r).clamp(e,t)}function Bl(r){if(!r||typeof r!="object")throw Error(hi+"Object expected");var e,t,n,o=r.defaults===!0,i=["precision",1,yn,"rounding",0,8,"toExpNeg",-Zn,0,"toExpPos",0,Zn,"maxE",0,Zn,"minE",-Zn,0,"modulo",0,9];for(e=0;e<i.length;e+=3)if(t=i[e],o&&(this[t]=Wr[t]),(n=r[t])!==void 0)if(st(n)===n&&n>=i[e+1]&&n<=i[e+2])this[t]=n;else throw Error(bn+t+": "+n);if(t="crypto",o&&(this[t]=Wr[t]),(n=r[t])!==void 0)if(n===!0||n===!1||n===0||n===1)if(n)if(typeof crypto<"u"&&crypto&&(crypto.getRandomValues||crypto.randomBytes))this[t]=!0;else throw Error(Pa);else this[t]=!1;else throw Error(bn+t+": "+n);return this}function xl(r){return new this(r).cos()}function Sl(r){return new this(r).cosh()}function Sa(r){var e,t,n;function o(i){var s,a,c,u=this;if(!(u instanceof o))return new o(i);if(u.constructor=o,ya(i)){u.s=i.s,se?!i.d||i.e>o.maxE?(u.e=NaN,u.d=null):i.e<o.minE?(u.e=0,u.d=[0]):(u.e=i.e,u.d=i.d.slice()):(u.e=i.e,u.d=i.d?i.d.slice():i.d);return}if(c=typeof i,c==="number"){if(i===0){u.s=1/i<0?-1:1,u.e=0,u.d=[0];return}if(i<0?(i=-i,u.s=-1):u.s=1,i===~~i&&i<1e7){for(s=0,a=i;a>=10;a/=10)s++;se?s>o.maxE?(u.e=NaN,u.d=null):s<o.minE?(u.e=0,u.d=[0]):(u.e=s,u.d=[i]):(u.e=s,u.d=[i]);return}else if(i*0!==0){i||(u.s=NaN),u.e=NaN,u.d=null;return}return Ur(u,i.toString())}else if(c!=="string")throw Error(bn+i);return(a=i.charCodeAt(0))===45?(i=i.slice(1),u.s=-1):(a===43&&(i=i.slice(1)),u.s=1),ka.test(i)?Ur(u,i):ml(u,i)}if(o.prototype=F,o.ROUND_UP=0,o.ROUND_DOWN=1,o.ROUND_CEIL=2,o.ROUND_FLOOR=3,o.ROUND_HALF_UP=4,o.ROUND_HALF_DOWN=5,o.ROUND_HALF_EVEN=6,o.ROUND_HALF_CEIL=7,o.ROUND_HALF_FLOOR=8,o.EUCLID=9,o.config=o.set=Bl,o.clone=Sa,o.isDecimal=ya,o.abs=pl,o.acos=fl,o.acosh=bl,o.add=yl,o.asin=gl,o.asinh=Al,o.atan=Pl,o.atanh=wl,o.atan2=kl,o.cbrt=hl,o.ceil=Tl,o.clamp=Il,o.cos=xl,o.cosh=Sl,o.div=Kl,o.exp=Cl,o.floor=Ll,o.hypot=Rl,o.ln=Nl,o.log=Ol,o.log10=Ml,o.log2=vl,o.max=_l,o.min=El,o.mod=Fl,o.mul=Vl,o.pow=Wl,o.random=Dl,o.round=ql,o.sign=Ul,o.sin=Gl,o.sinh=Xl,o.sqrt=Ql,o.sub=zl,o.sum=Hl,o.tan=jl,o.tanh=Yl,o.trunc=Zl,r===void 0&&(r={}),r&&r.defaults!==!0)for(n=["precision","rounding","toExpNeg","toExpPos","maxE","minE","modulo","crypto"],e=0;e<n.length;)r.hasOwnProperty(t=n[e++])||(r[t]=this[t]);return o.config(r),o}function Kl(r,e){return new this(r).div(e)}function Cl(r){return new this(r).exp()}function Ll(r){return Y(r=new this(r),r.e+1,3)}function Rl(){var r,e,t=new this(0);for(se=!1,r=0;r<arguments.length;)if(e=new this(arguments[r++]),e.d)t.d&&(t=t.plus(e.times(e)));else{if(e.s)return se=!0,new this(1/0);t=e}return se=!0,t.sqrt()}function ya(r){return r instanceof go||r&&r.toStringTag===wa||!1}function Nl(r){return new this(r).ln()}function Ol(r,e){return new this(r).log(e)}function vl(r){return new this(r).log(2)}function Ml(r){return new this(r).log(10)}function _l(){return Ia(this,arguments,"lt")}function El(){return Ia(this,arguments,"gt")}function Fl(r,e){return new this(r).mod(e)}function Vl(r,e){return new this(r).mul(e)}function Wl(r,e){return new this(r).pow(e)}function Dl(r){var e,t,n,o,i=0,s=new this(1),a=[];if(r===void 0?r=this.precision:yt(r,1,yn),n=Math.ceil(r/te),this.crypto)if(crypto.getRandomValues)for(e=crypto.getRandomValues(new Uint32Array(n));i<n;)o=e[i],o>=429e7?e[i]=crypto.getRandomValues(new Uint32Array(1))[0]:a[i++]=o%1e7;else if(crypto.randomBytes){for(e=crypto.randomBytes(n*=4);i<n;)o=e[i]+(e[i+1]<<8)+(e[i+2]<<16)+((e[i+3]&127)<<24),o>=214e7?crypto.randomBytes(4).copy(e,i):(a.push(o%1e7),i+=4);i=n/4}else throw Error(Pa);else for(;i<n;)a[i++]=Math.random()*1e7|0;for(n=a[--i],r%=te,n&&r&&(o=Xe(10,te-r),a[i]=(n/o|0)*o);a[i]===0;i--)a.pop();if(i<0)t=0,a=[0];else{for(t=-1;a[0]===0;t-=te)a.shift();for(n=1,o=a[0];o>=10;o/=10)n++;n<te&&(t-=te-n)}return s.e=t,s.d=a,s}function ql(r){return Y(r=new this(r),r.e+1,this.rounding)}function Ul(r){return r=new this(r),r.d?r.d[0]?r.s:0*r.s:r.s||NaN}function Gl(r){return new this(r).sin()}function Xl(r){return new this(r).sinh()}function Ql(r){return new this(r).sqrt()}function zl(r,e){return new this(r).sub(e)}function Hl(){var r=0,e=arguments,t=new this(e[r]);for(se=!1;t.s&&++r<e.length;)t=t.plus(e[r]);return se=!0,Y(t,this.precision,this.rounding)}function jl(r){return new this(r).tan()}function Yl(r){return new this(r).tanh()}function Zl(r){return Y(r=new this(r),r.e+1,1)}F[Symbol.for("nodejs.util.inspect.custom")]=F.toString;F[Symbol.toStringTag]="Decimal";var go=F.constructor=Sa(Wr);Pi=new go(Pi);wi=new go(wi);var L=go;import rm from"big.js";import Si from"bn.js";import $l from"toformat";var Jl=$l,Ao=Jl;import xi from"big.js";import tm from"bn.js";import nm from"decimal.js-light";import Po from"bn.js";var Ka=9007199254740991;function j(r){let e=de("Raydium_parseBigNumberish");if(r instanceof Po)return r;if(typeof r=="string"){if(r.match(/^-?[0-9]+$/))return new Po(r);e.logWithError(`invalid BigNumberish string: ${r}`)}return typeof r=="number"?(r%1&&e.logWithError(`BigNumberish number underflow: ${r}`),(r>=Ka||r<=-Ka)&&e.logWithError(`BigNumberish number overflow: ${r}`),new Po(String(r))):typeof r=="bigint"?new Po(r.toString()):(e.error(`invalid BigNumberish value: ${r}`),new Po(0))}var Bi=de("module/fraction"),Xr=Ao(xi),wo=Ao(nm),om={[0]:wo.ROUND_DOWN,[1]:wo.ROUND_HALF_UP,[2]:wo.ROUND_UP},im={[0]:xi.roundDown,[1]:xi.roundHalfUp,[2]:xi.roundUp},Ae=class{numerator;denominator;constructor(e,t=new tm(1)){this.numerator=j(e),this.denominator=j(t)}get quotient(){return this.numerator.div(this.denominator)}invert(){return new Ae(this.denominator,this.numerator)}add(e){let t=e instanceof Ae?e:new Ae(j(e));return this.denominator.eq(t.denominator)?new Ae(this.numerator.add(t.numerator),this.denominator):new Ae(this.numerator.mul(t.denominator).add(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}sub(e){let t=e instanceof Ae?e:new Ae(j(e));return this.denominator.eq(t.denominator)?new Ae(this.numerator.sub(t.numerator),this.denominator):new Ae(this.numerator.mul(t.denominator).sub(t.numerator.mul(this.denominator)),this.denominator.mul(t.denominator))}mul(e){let t=e instanceof Ae?e:new Ae(j(e));return new Ae(this.numerator.mul(t.numerator),this.denominator.mul(t.denominator))}div(e){let t=e instanceof Ae?e:new Ae(j(e));return new Ae(this.numerator.mul(t.denominator),this.denominator.mul(t.numerator))}toSignificant(e,t={groupSeparator:""},n=1){Number.isInteger(e)||Bi.logWithError(`${e} is not an integer.`),e<=0&&Bi.logWithError(`${e} is not positive.`),wo.set({precision:e+1,rounding:om[n]});let o=new wo(this.numerator.toString()).div(this.denominator.toString()).toSignificantDigits(e);return o.toFormat(o.decimalPlaces(),t)}toFixed(e,t={groupSeparator:""},n=1){return Number.isInteger(e)||Bi.logWithError(`${e} is not an integer.`),e<0&&Bi.logWithError(`${e} is negative.`),Xr.DP=e,Xr.RM=im[n]||1,new Xr(this.numerator.toString()).div(this.denominator.toString()).toFormat(e,t)}isZero(){return this.numerator.isZero()}};var sm=de("Raydium_amount"),Ca=Ao(rm);function am(r,e){let t="0",n="0";if(r.includes(".")){let o=r.split(".");o.length===2?([t,n]=o,n=n.padEnd(e,"0")):sm.logWithError(`invalid number string, num: ${r}`)}else t=r;return[t,n.slice(0,e)||n]}var we=class extends Ae{token;logger;constructor(e,t,n=!0,o){let i=new Si(0),s=Qr.pow(new Si(e.decimals));if(n)i=j(t);else{let a=new Si(0),c=new Si(0);if(typeof t=="string"||typeof t=="number"||typeof t=="bigint"){let[u,l]=am(t.toString(),e.decimals);a=j(u),c=j(l)}a=a.mul(s),i=a.add(c)}super(i,s),this.logger=de(o||"TokenAmount"),this.token=e}get raw(){return this.numerator}isZero(){return this.raw.isZero()}gt(e){return this.token.equals(e.token)||this.logger.logWithError("gt token not equals"),this.raw.gt(e.raw)}lt(e){return this.token.equals(e.token)||this.logger.logWithError("lt token not equals"),this.raw.lt(e.raw)}add(e){return this.token.equals(e.token)||this.logger.logWithError("add token not equals"),new we(this.token,this.raw.add(e.raw))}subtract(e){return this.token.equals(e.token)||this.logger.logWithError("sub token not equals"),new we(this.token,this.raw.sub(e.raw))}toSignificant(e=this.token.decimals,t,n=0){return super.toSignificant(e,t,n)}toFixed(e=this.token.decimals,t,n=0){return e>this.token.decimals&&this.logger.logWithError("decimals overflow"),super.toFixed(e,t,n)}toExact(e={groupSeparator:""}){return Ca.DP=this.token.decimals,new Ca(this.numerator.toString()).div(this.denominator.toString()).toFormat(e)}};import{PublicKey as um}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as La}from"@solana/spl-token";var gn={chainId:101,address:um.default.toBase58(),programId:La.toBase58(),decimals:9,symbol:"SOL",name:"solana",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}},at={chainId:101,address:"So11111111111111111111111111111111111111112",programId:La.toBase58(),decimals:9,symbol:"WSOL",name:"Wrapped SOL",logoURI:"https://img-v1.raydium.io/icon/So11111111111111111111111111111111111111112.png",tags:[],priority:2,type:"raydium",extensions:{coingeckoId:"solana"}};import{PublicKey as Zr}from"@solana/web3.js";import{PublicKey as Re,SystemProgram as Ra,SYSVAR_RENT_PUBKEY as cm}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as lm}from"@solana/spl-token";function B({pubkey:r,isSigner:e=!1,isWritable:t=!0}){return{pubkey:r,isWritable:t,isSigner:e}}var zr=[B({pubkey:lm,isWritable:!1}),B({pubkey:Ra.programId,isWritable:!1}),B({pubkey:cm,isWritable:!1})];function Hr({publicKey:r,transformSol:e}){let t=jr(r.toString());if(t instanceof Re)return e&&t.equals(je)?H:t;if(e&&t.toString()===je.toBase58())return H;if(typeof t=="string"){if(t===Re.default.toBase58())return Re.default;try{return new Re(t)}catch{throw new Error("invalid public key")}}throw new Error("invalid public key")}function jr(r){try{return new Re(r)}catch{return r}}var Ki=new Re("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),An=new Re("MemoSq4gqABAXKb96qnH8TysNcWxMyWCqXgDLGmfcHr"),et=new Re("SysvarRent111111111111111111111111111111111"),Na=new Re("SysvarC1ock11111111111111111111111111111111"),Vt=new Re("metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s"),mm=new Re("Sysvar1nstructions1111111111111111111111111"),Yr=Ra.programId,Yf=new Re("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),Zf=new Re("Ea5SjE2Y6yvCeW5dYTn7PYMuW5ikXkvbGdcmSnXeaLjS"),$f=new Re("SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt"),Jf=new Re("EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v"),eb=new Re("Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB"),tb=new Re("mSoLzYCxHdYgdzU16g5QSh3i5K3z3KZK7ytfqcJm7So"),nb=new Re("7dHbWXmci3dT8UFYWYZweBLXgycu7Y3iL6trKn1Y7ARj"),ob=new Re("USDH1SM1ojwWUga67PGrgFWUHibbjqMvuMaDkRJTgkX"),ib=new Re("NRVwhjBQiUPYtfDT5zRBVJajzFQHaBUNtC7SNVvqRFa"),rb=new Re("ANAxByE6G2WjFp7A4NqtWYXb3mgruyzZYg3spfxe6Lbo"),sb=new Re("7vfCXTUXx5WJV5JADk17DUJ4ksgau7utNKj4b963voxs"),H=new Re("So11111111111111111111111111111111111111112"),je=Re.default;function rt(r){return Hr({publicKey:r,transformSol:!0})}var $r=class{symbol;name;decimals;isToken2022;mint;constructor({mint:e,decimals:t,symbol:n,name:o,skipMint:i=!1,isToken2022:s=!1}){if(e===je.toBase58()||e instanceof Zr&&je.equals(e)){this.decimals=at.decimals,this.symbol=at.symbol,this.name=at.name,this.mint=new Zr(at.address),this.isToken2022=!1;return}this.decimals=t,this.symbol=n||e.toString().substring(0,6),this.name=o||e.toString().substring(0,6),this.mint=i?Zr.default:Hr({publicKey:e}),this.isToken2022=s}equals(e){return this===e?!0:this.mint.equals(e.mint)}},Ne=$r;Tt(Ne,"WSOL",new $r({...at,mint:at.address}));var Jr=class{symbol;name;decimals;constructor({decimals:e,symbol:t="UNKNOWN",name:n="UNKNOWN"}){this.decimals=e,this.symbol=t,this.name=n}equals(e){return this===e}},Ci=Jr;Tt(Ci,"SOL",new Jr(gn));import dm from"bn.js";var Oa=new Ae(new dm(100)),Ye=class extends Ae{toSignificant(e=5,t,n){return this.mul(Oa).toSignificant(e,t,n)}toFixed(e=2,t,n){return this.mul(Oa).toFixed(e,t,n)}};var pm=de("Raydium_price"),gt=class extends Ae{baseToken;quoteToken;scalar;constructor(e){let{baseToken:t,quoteToken:n,numerator:o,denominator:i}=e;super(o,i),this.baseToken=t,this.quoteToken=n,this.scalar=new Ae(es(t.decimals),es(n.decimals))}get raw(){return new Ae(this.numerator,this.denominator)}get adjusted(){return super.mul(this.scalar)}invert(){return new gt({baseToken:this.quoteToken,quoteToken:this.baseToken,denominator:this.numerator,numerator:this.denominator})}mul(e){this.quoteToken!==e.baseToken&&pm.logWithError("mul token not equals");let t=super.mul(e);return new gt({baseToken:this.baseToken,quoteToken:e.quoteToken,denominator:t.denominator,numerator:t.numerator})}toSignificant(e=this.quoteToken.decimals,t,n){return this.adjusted.toSignificant(e,t,n)}toFixed(e=this.quoteToken.decimals,t,n){return this.adjusted.toFixed(e,t,n)}};import{PublicKey as fm}from"@solana/web3.js";import bm from"bn.js";function va(r){return typeof r=="object"&&r!==null&&![Ne,we,fm,Ae,bm,gt,Ye].some(e=>typeof e=="object"&&r instanceof e)}function tt(r){return typeof r=="string"?jr(r):Array.isArray(r)?r.map(e=>tt(e)):va(r)?Object.fromEntries(Object.entries(r).map(([e,t])=>[e,tt(t)])):r}var At=new Yt(0),Ma=new Yt(1),ty=new Yt(2),ny=new Yt(3),oy=new Yt(5),Qr=new Yt(10),iy=new Yt(100),ry=new Yt(1e3),sy=new Yt(1e4);function es(r){return Qr.pow(j(r))}function Li(r,e){let t=r.divmod(e);return t.mod.isZero()?t.div:t.div.isNeg()?t.div.isubn(1):t.div.iaddn(1)}function Ri(r,e,t){return r.mul(e).add(t).sub(new Yt(1)).div(t)}function ts(r,e,t){return r.mul(e).div(t)}function Fr(r,e=1,t=[]){let n=[...r];if(e<=0)return t;for(;n.length;)t.push(n.splice(0,e));return t}var Wt=class{_owner;constructor(e){this._owner=e}get publicKey(){return Wt.isKeyPair(this._owner)?this._owner.publicKey:this._owner}get signer(){return Wt.isKeyPair(this._owner)?this._owner:void 0}get isKeyPair(){return Wt.isKeyPair(this._owner)}get isPublicKey(){return Wt.isPublicKey(this._owner)}static isKeyPair(e){return e.secretKey!==void 0}static isPublicKey(e){return!Wt.isKeyPair(e)}};import{PublicKey as km}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as hm}from"@solana/spl-token";import{ComputeBudgetProgram as _a,Keypair as Fa,PublicKey as ym,Transaction as Va,TransactionMessage as gm,VersionedTransaction as Wa}from"@solana/web3.js";var E={CreateAccount:"CreateAccount",InitAccount:"InitAccount",CreateATA:"CreateATA",CloseAccount:"CloseAccount",TransferAmount:"TransferAmount",InitMint:"InitMint",MintTo:"MintTo",InitMarket:"InitMarket",Util1216OwnerClaim:"Util1216OwnerClaim",SetComputeUnitPrice:"SetComputeUnitPrice",SetComputeUnitLimit:"SetComputeUnitLimit",ClmmCreatePool:"ClmmCreatePool",ClmmOpenPosition:"ClmmOpenPosition",ClmmIncreasePosition:"ClmmIncreasePosition",ClmmDecreasePosition:"ClmmDecreasePosition",ClmmClosePosition:"ClmmClosePosition",ClmmSwapBaseIn:"ClmmSwapBaseIn",ClmmSwapBaseOut:"ClmmSwapBaseOut",ClmmInitReward:"ClmmInitReward",ClmmSetReward:"ClmmSetReward",ClmmCollectReward:"ClmmCollectReward",ClmmLockPosition:"ClmmLockPosition",ClmmHarvestLockPosition:"ClmmHarvestLockPosition",AmmV4Swap:"AmmV4Swap",AmmV4AddLiquidity:"AmmV4AddLiquidity",AmmV4RemoveLiquidity:"AmmV4RemoveLiquidity",AmmV4SimulatePoolInfo:"AmmV4SimulatePoolInfo",AmmV4SwapBaseIn:"AmmV4SwapBaseIn",AmmV4SwapBaseOut:"AmmV4SwapBaseOut",AmmV4CreatePool:"AmmV4CreatePool",AmmV4InitPool:"AmmV4InitPool",AmmV5AddLiquidity:"AmmV5AddLiquidity",AmmV5RemoveLiquidity:"AmmV5RemoveLiquidity",AmmV5SimulatePoolInfo:"AmmV5SimulatePoolInfo",AmmV5SwapBaseIn:"AmmV5SwapBaseIn",AmmV5SwapBaseOut:"AmmV5SwapBaseOut",RouteSwap:"RouteSwap",RouteSwap1:"RouteSwap1",RouteSwap2:"RouteSwap2",FarmV3Deposit:"FarmV3Deposit",FarmV3Withdraw:"FarmV3Withdraw",FarmV3CreateLedger:"FarmV3CreateLedger",FarmV4Withdraw:"FarmV4Withdraw",FarmV5Deposit:"FarmV5Deposit",FarmV5Withdraw:"FarmV5Withdraw",FarmV5CreateLedger:"FarmV5CreateLedger",FarmV6Deposit:"FarmV6Deposit",FarmV6Withdraw:"FarmV6Withdraw",FarmV6Create:"FarmV6Create",FarmV6Restart:"FarmV6Restart",FarmV6CreatorAddReward:"FarmV6CreatorAddReward",FarmV6CreatorWithdraw:"FarmV6CreatorWithdraw",CpmmCreatePool:"CpmmCreatePool",CpmmAddLiquidity:"CpmmAddLiquidity",CpmmWithdrawLiquidity:"CpmmWithdrawLiquidity",CpmmSwapBaseIn:"CpmmSwapBaseIn",CpmmSwapBaseOut:"CpmmSwapBaseOut",CpmmLockLp:"CpmmLockLp",CpmmCollectLockFee:"CpmmCollectLockFee",TransferTip:"TransferTip",NonceAccount:"NonceAccount"};import{TOKEN_PROGRAM_ID as Am}from"@solana/spl-token";var Ea=de("Raydium_txUtil"),Da=1644;function Jn(r){let e=[],t=[];return r.microLamports&&(e.push(_a.setComputeUnitPrice({microLamports:r.microLamports})),t.push(E.SetComputeUnitPrice)),r.units&&(e.push(_a.setComputeUnitLimit({units:r.units})),t.push(E.SetComputeUnitLimit)),{instructions:e,instructionTypes:t}}async function eo(r,e){let t=e??"confirmed";return(await r.getLatestBlockhash?.({commitment:t}))?.blockhash}async function Ni(r,e){return r.getSignatureStatuses([e]),new Promise((t,n)=>{let o=setTimeout(n,6e4);r.onSignature(e,i=>{if(clearTimeout(o),!i.err){t("");return}n(Object.assign(i.err,{txId:e}))},"confirmed")})}function ns(r,e){r.length<1&&Ea.logWithError(`no instructions provided: ${r.toString()}`),e.length<1&&Ea.logWithError(`no signers provided:, ${e.toString()}`);let t=new Va;t.recentBlockhash="11111111111111111111111111111111",t.feePayer=e[0],t.add(...r);try{return Buffer.from(t.serialize({verifySignatures:!1})).toString("base64").length<Da}catch{return!1}}function ue(r,e){let[t,n]=ym.findProgramAddressSync(r,e);return{publicKey:t,nonce:n}}function ko({instructions:r,payer:e,signers:t}){return ns(r,[e,...t])}function ho({instructions:r,payer:e,lookupTableAddressAccount:t,recentBlockhash:n=Fa.generate().publicKey.toString()}){let i=new gm({payerKey:e,recentBlockhash:n,instructions:r}).compileToV0Message(Object.values(t??{}));try{return Buffer.from(new Wa(i).serialize()).toString("base64").length<Da}catch{return!1}}var Pm=r=>Buffer.isBuffer(r)?r:r instanceof Uint8Array?Buffer.from(r.buffer,r.byteOffset,r.byteLength):Buffer.from(r),wm=r=>{let e=r.serialize({requireAllSignatures:!1,verifySignatures:!1});r instanceof Wa&&(e=Pm(e));try{return e instanceof Buffer?e.toString("base64"):Buffer.from(e).toString("base64")}catch{return e.toString("base64")}};function Nn(r){let e=[];return r.forEach(t=>{t instanceof Va&&(t.recentBlockhash||(t.recentBlockhash=Am.toBase58()),t.feePayer||(t.feePayer=Fa.generate().publicKey)),e.push(wm(t))}),console.log("simulate tx string:",e),e}function $(r,e,t){return ue([r.toBuffer(),(t??hm).toBuffer(),e.toBuffer()],new km("ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL"))}import{PublicKey as ae}from"@solana/web3.js";var qa=new ae("EhhTKczWMGQt46ynNeRX1WfeagwwJd7ufHvCDjRxjo5Q"),Ua=new ae("CBuCnLe26faBpcBP2fktp4rp8abpcAnTWft6ZrP5Q4T"),Ga=new ae("9KEPoZmtHUrBbhWN1v1KWLMkkvwY6WLtAVUCPRtRjP4z"),To=new ae("FarmqiPv5eAj3j1GMdMCMUGXqPUvmquZtMy86QH6rzhG"),Sy=new ae("CLaimxFqjHzgTJtAGHU47NPhg6qrc5sCnpC4tBLyABQS"),Xa=new ae("srmqPvymJeFKQ4zGQed1GFppgkRHL9kaELCbyksJtPX"),os=new ae("9xQeWvG816bUx9EPjHmaT23yvVM2ZWbrrpZb9PusVFin"),Oi=new ae("675kPX9MHTjS2zt1qfr1NYHuzeLXfQM9H24wFSUt1Mp8"),Ky=new ae("5quBtoiQqxF9Jv6KYKctB59NT3gtJD2Y65kdnB1Uev3h"),Qa=new ae("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),On=new ae("CAMMCzo5YL8w4VFF8KVHrK22GGUsp5VTaW7grrKgrWqK"),Io=new ae("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),vi=new ae("kN1kEznaF5Xbd8LYuqtEFcxzWSBk5Fv6ygX6SqEGJVy"),Cy=new ae("routeUGWgWzqBWFcrCfv8tritsqukccJPu3q5GPP3xS"),za=new ae("7YttLkHDoNj9wyDur5pM1ejNaAvT9X4eqaYcHQqtj2G5"),Tm=new ae("6FJon3QE27qgPVggARueB22hLvoh22VzJpXv4rBEoSLF"),Im=new ae("CC12se5To1CdEuw7fDS27B7Geo5jJyL7t5UK2B44NgiH"),Bm=new ae("9HzJyW1qZsEiSfMUf6L2jo3CcTKAyBmSyKdwQeYisHrC"),xm=new ae("DropEU8AvevN3UrXWXTMuz3rqnMczQVNjq3kcSdW2SQi"),Mi=new ae("CPMMoo8L3F4NbTegBCKVNunggL7H1ZpdTHKxQB5qKP1C"),Ha=new ae("GpMZbSM2GgvTKHJirzeGfMFoaZ8UR2X7F4v8vHTvxFbL"),Ly=new ae("DNXgeM9EiiaAbaWvwjHj9fQQLAX5ZsfHyvmYUNRAdNC8"),Sm=new ae("CPMDWBwJDtYax9qW7AyRuVC19Cc4L4Vcy4n2BHAbHkCW"),Km=new ae("7rQ1QFNosMkUCuh7Z7fPbTHvh73b68sQYdirycEzJVuw"),Cm=new ae("G11FKBRaAkHAKuLCgLM6K6NUc9rTjPAznRCjZifrTQe2"),_i=new ae("LockrWmn6K5twhz3y9w1dQERbmgSaRkfnTeTKbpofwE"),Lm=new ae("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),Ei=new ae("3f7GcQFG397GAaEnv51zR6tsTVihYRydnydDD1cXekxH"),Rm=new ae("7AFUeLVRjBfzqK3tTGw8hN48KLQWSk6DTE8xprWdPqix"),Zt=new ae("LanMV9sAd7wArD4vJFi2qDdfnVhFxYSUg6eADduJ3uj"),Ry=new ae("WLHv2UAZm6z4KyaaELi5pjdbJh6RESMva1Rnn8pJVVh"),Nm=new ae("LanD8FpTBBvzZFXjTxsAoipkFsxPUCDB4qAqKxYDiNP"),Om=new ae("HYNHiyKJ3gGVFvyxJAurK7qr7P2o5J9THmvCGMdULtpW"),Bo={IDO_PROGRAM_ID_V1:Tm,IDO_PROGRAM_ID_V2:Im,IDO_PROGRAM_ID_V3:Bm,IDO_PROGRAM_ID_V4:xm};var Ny={SERUM_MARKET:ae.default,OPENBOOK_MARKET:new ae("EoTcMgcDRTJVZDMZWBoU6rhYHZfkNTVEAfz3uUJRcYGj"),UTIL1216:ae.default,FarmV3:new ae("85BFyr98MbCUU9MVTEgzx1nbhWACbJqLzho6zd6DZcWL"),FarmV5:new ae("EcLzTrNg9V7qhcdyXDe2qjtPkiGzDM2UbdRaeaadU5r2"),FarmV6:new ae("Farm2hJLcqPtPg8M4rR6DMrsRNc5TPm5Cs4bVQrMe2T7"),AmmV4:new ae("HWy1jotHpo6UqeQxx49dpYYdQB8wj9Qk9MdxwjLvDHB8"),AmmStable:new ae("DDg4VmQaJV9ogWce7LpcjBA9bv22wRp5uaTPa5pGjijF"),CLMM:new ae("devi51mZmdwUJGU9hjN27vEz64Gps7uUefqxg27EAtH"),CLMM_LOCK_PROGRAM_ID:new ae("DLockwT7X7sxtLmGH9g5kmfcjaBtncdbUmi738m5bvQC"),CLMM_LOCK_AUTH_ID:new ae("8qmHNvu2Kr2C7U8mJL4Vz1vTDxMhVuXKREwU7TNoaVEo"),Router:new ae("BVChZ3XFEwTMUk1o9i3HAf91H6mFxSwa5X2wFAWhYPhU"),CREATE_CPMM_POOL_PROGRAM:Sm,CREATE_CPMM_POOL_AUTH:Km,CREATE_CPMM_POOL_FEE_ACC:Cm,FEE_DESTINATION_ID:new ae("3XMrhbv989VxAMi3DErLV9eJht1pHppW5LbKxe9fkEFR"),LOCK_CPMM_PROGRAM:Lm,LCOK_CPMM_AUTH:Rm,LAUNCHPAD_PROGRAM:Nm,LAUNCHPAD_AUTH:Om};import dt from"bn.js";var xo=1e4;function ke(r,e,t,n){if(e===void 0)return{amount:r,fee:void 0,expirationTime:void 0};let o={...e,olderTransferFee:{epoch:BigInt(e.olderTransferFee.epoch),maximumFee:BigInt(e.olderTransferFee.maximumFee),transferFeeBasisPoints:e.olderTransferFee.transferFeeBasisPoints},newerTransferFee:{epoch:BigInt(e.newerTransferFee.epoch),maximumFee:BigInt(e.newerTransferFee.maximumFee),transferFeeBasisPoints:e.newerTransferFee.transferFeeBasisPoints}},i=t.epoch<o.newerTransferFee.epoch?o.olderTransferFee:o.newerTransferFee,s=new dt(i.maximumFee.toString()),a=t.epoch<o.newerTransferFee.epoch?(Number(o.newerTransferFee.epoch)*t.slotsInEpoch-t.absoluteSlot)*400/1e3:void 0;if(n)if(i.transferFeeBasisPoints===xo){let c=new dt(i.maximumFee.toString());return{amount:r.add(c),fee:c,expirationTime:a}}else{let c=Pn(r.mul(new dt(xo)),new dt(xo-i.transferFeeBasisPoints)),u=new dt(i.maximumFee.toString()),l=c.sub(r).gt(u)?r.add(u):c,m=Pn(l.mul(new dt(i.transferFeeBasisPoints)),new dt(xo)),d=m.gt(s)?s:m;return{amount:l,fee:d,expirationTime:a}}else{let c=Pn(r.mul(new dt(i.transferFeeBasisPoints)),new dt(xo)),u=c.gt(s)?s:c;return{amount:r,fee:u,expirationTime:a}}}function Dt(r,e){return r===void 0?e:e===void 0?r:Math.min(r,e)}function Pn(r,e){let{div:t,mod:n}=r.divmod(e);return n.gt(new dt(0))?t.add(new dt(1)):t}function Fi(r,e){if(r.isZero())return new dt(0);let t=r.div(e);return t.isZero()?new dt(1):r.mod(e).gt(new dt(0))?t.add(new dt(1)):t}import{PublicKey as ja,AddressLookupTableAccount as Vi}from"@solana/web3.js";async function is({connection:r,address:e}){let t=await _t(r,[...new Set(e.map(o=>o.toString()))].map(o=>new ja(o))),n={};for(let o=0;o<e.length;o++){let i=t[o],s=e[o];if(!i)continue;let a=new Vi({key:s,state:Vi.deserialize(i.data)});n[s.toString()]=a,Wi[s.toString()]=a}return n}var Wi={AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU:new Vi({key:new ja("AcL1Vo8oy1ULiavEcjSUcwfBSForXMudcZvDZy5nzJkU"),state:Vi.deserialize(Buffer.from("AQAAAP//////////I1rcEwAAAAAvAQYwun9CU6c5Ikm2pAj+D9IEnCOR45nK+SFTGSdpd6J6AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAbd9uHXZaGT2cvhRs7reawctIXtX1s3kTqM9YV+/wCpBt324e51j94YQl285GzN2rYa/E2DuQ0n/r35KNihi/wFSlNQ+F3IgtYUpVZyeIopbd8eq6vQpgZ4iEky9O72oAVKU1qZKSEGTSTocWDaOHx8NbXdvJK7geQfqEBBBUSNBqfVFxksXFEhjMlMPUrxf1ja7gibof1E49vZigAAAAAGp9UXGMd0yShWY5hpHV62i164o5tLbVxzVVshAAAAAIyXJY9OJInxuz0QKRSODYMLWhOZ2v8QhASOe9jb6fhZC3BlsePRfEU4nVJ/awTDzVi4bHMaoP21SbbRvAP4KUbIScv+6Yw2LHF/6K0ZjUPibbSWXCirYPGuuVl7zT789IUPLW4CpHr4JNCatp3ELXDLKMv6JJ+37le50lbBJ2LvBkX2T9y7AHdNGviJAqQNtlDUDCnauQRWybsLji6nPM8Qkw5asQRvCdB3MbX6IEBwytOrpM32l4jQygKG9TKgR0vZScQ2AsM/IHeQ7RajUkyhuZdc8SGiqQz/7H34torNR/Wir3sl0ruUrVxJWEZfUg+QLNAxxODdBi53/OP7Ioil1cqeBM9dtZC3FLov4yyxWRM/wcGStyJX/QfTnLBAHqkqWotPKVlShCVQqpP9W5W1rOao65IMk5QuQ2kMIOxzDMKAy2vjGSxQODgBz0QwGA+eP4ZjIjrIAQaXENv31QfLlOdXSRCkaybRniDHF4C8YcwhcvsqrOVuTP4B2Na+9wLdtrB31uz2rtlFI5kahdsnp/d1SrASDInYCtTYtdoke4kX+hoKWcEWM4Tle8pTUkUVv4BxS6fje/EzKBE4Qu/YsA/yfEEFGcr8Z57VKDw8uQzpiru7g4lvjnfapW62W030syevD8k07SGoxUHiuT/ai7gAHWWhDsVmg/C63ajgpkH7Sn3GdutArDTfyqOkdqv4/IPC/EFFy7mGkfDd2C57N5a/4jC+BbmJy7wQaSEZr0CQU88lPtUxIVvzGjC95b8Ooss2TqmkrayGKofkPMGQn7Ux+9lfwBSNfxwH8NgbpqC/7LNlV4I7nCvsXf3p+ohQk9NrAJb2KAFpUqEIJ9ZBV7BYDzHF/ORKYlgtvPnXjudZQ6CEo5OzUDaNIomTCCsvhD16TxJjsbgne1kGnQPCFSoaxUbq2V1bPMFQ3VYP6wDZ9bKStCFKx9A3tNbwZFC5ZGAN83MFK7XoTy+OmmcFEr6rLOjfSuTfPvHJkSVxW6Qllwkl67XcBi5v00u2gQsbu+38sp+rd5pA/LvyWj4P94ZGZwc1tE2P88xekCLcAwZGb+UhFzL/7K26csOb57yM5bvF9xJrLEObOkAAAAAn+HWRkdcPKyFFMnVwEoD7vnD0jCKFIU1sImubYCxNTSVzsKpaQX+fzNxrLAI3L14JQnJx/D6Uk2LADIHGqnGELzjEbkBDAlaM77NkXMPfqXNLSveCkWI7UEgNs31WEWB6XHSYI/v5DklHOb4QTtDOR804PVbi3fjloZeLR2F8d4FuZmMMO7ck3Fnkn2zEMG5gOmqsygb6PjTitArVl52NhcSznTxVnguaIJxiZkAnurDmn3MWR0PC2GLghp2KJqHCc6QQ85odeIjFHKOlRlJyeSXVJmL8vb1UgOzsbJPVP8p6zM4M3C1Sd7uWIHP33G42AP2Zg8ucn/n6meQjjD266JgCWdxZD6PXs9CsnIeL7SSG0/6lGb9xfP0ZcWkCXB/3hjxHYVXjra/GPOeXGk0fLLKjCbk+mgs2w6d2oCwimBipTzuoZ30GiI8ij8VRzD5CzMWtu2m21eDBIfjGAEo4pQeNNonKcqzV/cleX8ySZLOHsz8PtBCrLqF+VkLm9hOzIT+6i/nIf6keR4GWKMOD4AvqfpjHoD4DuhBpz8P28+DxkGrDXXr/nr20x291VPvcTU/b+b+o2kC9G0kcXeTlLjU6a2TQXWlZ4gBUdBl1jgT7mObSTpLblNiXZsLkbmVXZwvFKXua5cUKlWed/w30skmEUraTuQqtqr5fHZPW9n57EmeTif6LjHL2YJFZkQU+TrJmFzqzmF4/b8OwrPQAprl8mX3q4LUIdAS/a+11B6DWD1Xk2++Sn94dLC4xjkO4Wtlw8c4XuzciVbepHOmnoWzVu/0y3KCrLCSfQxQ3br8DJCoVzhgtPsS2nZZjsBGIZgnU0QpMv+2MnRsnKwdp1VsrCX84j/qvaZn4WhKunippgTbN2EUs0tPTP55Qfgj+nKmjtWW5IYs72FrEwJKYoNfsmqaF4o5pf4v9zgPwVwY/5I4XJKUL2L25m9kAQcW/K+H1RTFEUoj8Z4ajpOmAB/dG0COmCphVMW2CCMvnxhcGiSgPnpDuWu6qiJ7NG7ye5kvHgefgqPLeicspNJ5EpL3XiRNLM2tmJLI1awAwOyd6iHv0dCkMYRKaa6rcaZeYwmKCkckm0kM2JNmnmmAaBQQ7mwmIM0IMxX4f5W6j9PqZWcJxF7r17T/lQBAmcjoupRiJifbnXCNUv9GhpRF19WcBdeKbivRJVlGop6I2RS6lGImJ9udcI1S/0aGlEXX1ZwF14puK9ElWUainojZFYVHLHD6dIP2ESjqBzg3ol1/wB7+/ylGwd9LS7wSZ2A630CJSVKwH47K9P4bB8PEQP8BwjMFa7xQHOqZFP1XqaQ==","base64"))})};import{PublicKey as to,sendAndConfirmTransaction as rs,SystemProgram as vm,Transaction as So,TransactionMessage as Ko,VersionedTransaction as Co}from"@solana/web3.js";import Mm from"axios";var Di=2e3,qi=class{connection;owner;instructions=[];endInstructions=[];lookupTableAddress=[];signers=[];instructionTypes=[];endInstructionTypes=[];feePayer;cluster;signAllTransactions;blockhashCommitment;loopMultiTxStatus;constructor(e){this.connection=e.connection,this.feePayer=e.feePayer,this.signAllTransactions=e.signAllTransactions,this.owner=e.owner,this.cluster=e.cluster,this.blockhashCommitment=e.blockhashCommitment,this.loopMultiTxStatus=!!e.loopMultiTxStatus}get AllTxData(){return{instructions:this.instructions,endInstructions:this.endInstructions,signers:this.signers,instructionTypes:this.instructionTypes,endInstructionTypes:this.endInstructionTypes,lookupTableAddress:this.lookupTableAddress}}get allInstructions(){return[...this.instructions,...this.endInstructions]}async getComputeBudgetConfig(){let e=(await Mm.get(`https://solanacompass.com/api/fees?cacheFreshTime=${3e5}`)).data,{avg:t}=e?.[15]??{};if(!!t)return{units:6e5,microLamports:Math.min(Math.ceil(t*1e6/6e5),25e3)}}addCustomComputeBudget(e){if(e){let{instructions:t,instructionTypes:n}=Jn(e);return this.instructions.unshift(...t),this.instructionTypes.unshift(...n),!0}return!1}addTipInstruction(e){return e?(this.endInstructions.push(vm.transfer({fromPubkey:e.feePayer??this.feePayer,toPubkey:new to(e.address),lamports:BigInt(e.amount.toString())})),this.endInstructionTypes.push(E.TransferTip),!0):!1}async calComputeBudget({config:e,defaultIns:t}){try{let n=e||await this.getComputeBudgetConfig();if(this.addCustomComputeBudget(n))return;t&&this.instructions.unshift(...t)}catch{t&&this.instructions.unshift(...t)}}addInstruction({instructions:e=[],endInstructions:t=[],signers:n=[],instructionTypes:o=[],endInstructionTypes:i=[],lookupTableAddress:s=[]}){return this.instructions.push(...e),this.endInstructions.push(...t),this.signers.push(...n),this.instructionTypes.push(...o),this.endInstructionTypes.push(...i),this.lookupTableAddress.push(...s.filter(a=>a!==to.default.toString())),this}async versionBuild({txVersion:e,extInfo:t},n){return e===0?await this.buildV0({...t||{}},n):this.build(t,n)}build(e,t){let n=new So;return this.allInstructions.length&&n.add(...this.allInstructions),n.feePayer=this.feePayer,this.owner?.signer&&!this.signers.some(o=>o.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer),{builder:this,transaction:n,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async o=>{let{recentBlockHash:i,skipPreflight:s=!0,sendAndConfirm:a,notSendToRpc:c}=o||{},u=i??t??await eo(this.connection,this.blockhashCommitment);if(n.recentBlockhash=u,this.signers.length&&n.sign(...this.signers),Nn([n]),this.owner?.isKeyPair)return{txId:a?await rs(this.connection,n,this.signers.find(m=>m.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:s}):await this.connection.sendRawTransaction(n.serialize(),{skipPreflight:s}),signedTx:n};if(this.signAllTransactions){let l=await this.signAllTransactions([n]);if(this.signers.length)for(let m of l)try{m.sign(...this.signers)}catch{}return{txId:c?"":await this.connection.sendRawTransaction(l[0].serialize(),{skipPreflight:s}),signedTx:l[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:e||{}}}buildMultiTx(e){let{extraPreBuildData:t=[],extInfo:n}=e,{transaction:o}=this.build(n),i=t.filter(u=>u.transaction.instructions.length>0),s=[o,...i.map(u=>u.transaction)],a=[this.signers,...i.map(u=>u.signers)],c=[...this.instructionTypes,...i.map(u=>u.instructionTypes).flat()];return this.owner?.signer&&a.forEach(u=>{u.some(l=>l.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),{builder:this,transactions:s,signers:a,instructionTypes:c,execute:async u=>{let{sequentially:l,onTxUpdate:m,skipTxCount:d=0,recentBlockHash:p,skipPreflight:f=!0}=u||{},y=p??await eo(this.connection,this.blockhashCommitment);if(this.owner?.isKeyPair){if(l){let b=[],g=0;for(let P of s){if(++g,g<=d)continue;let w=await rs(this.connection,P,this.signers.find(k=>k.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:f});b.push(w)}return{txIds:b,signedTxs:s}}return{txIds:await await Promise.all(s.map(async b=>(b.recentBlockhash=y,await this.connection.sendRawTransaction(b.serialize(),{skipPreflight:f})))),signedTxs:s}}if(this.signAllTransactions){let b=s.map((P,w)=>(P.recentBlockhash=y,a[w].length&&P.sign(...a[w]),P));Nn(b);let g=await this.signAllTransactions(b);if(l){let P=0,w=[],k=async()=>{if(!g[P])return;let x=await this.connection.sendRawTransaction(g[P].serialize(),{skipPreflight:f});w.push({txId:x,status:"sent",signedTx:g[P]}),m?.([...w]),P++;let h=!1,I=null,S=null,T=K=>{I!==null&&clearInterval(I),S!==null&&this.connection.removeSignatureListener(S);let R=w.findIndex(N=>N.txId===x);if(R>-1){if(w[R].status==="error"||w[R].status==="success")return;w[R].status=K.err?"error":"success"}m?.([...w]),K.err||k()};this.loopMultiTxStatus&&(I=setInterval(async()=>{if(h){clearInterval(I);return}try{let K=await this.connection.getTransaction(x,{commitment:"confirmed",maxSupportedTransactionVersion:0});K&&(h=!0,clearInterval(I),T({err:K.meta?.err||null}),console.log("tx status from getTransaction:",x))}catch(K){h=!0,clearInterval(I),console.error("getTransaction timeout:",K,x)}},Di)),S=this.connection.onSignature(x,K=>{if(h){this.connection.removeSignatureListener(S);return}h=!0,T(K)},"confirmed"),this.connection.getSignatureStatus(x)};return await k(),{txIds:w.map(x=>x.txId),signedTxs:g}}else{let P=[];for(let w=0;w<g.length;w+=1){let k=await this.connection.sendRawTransaction(g[w].serialize(),{skipPreflight:f});P.push(k)}return{txIds:P,signedTxs:g}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async versionMultiBuild({extraPreBuildData:e,txVersion:t,extInfo:n}){return t===0?await this.buildV0MultiTx({extraPreBuildData:e,buildProps:n||{}}):this.buildMultiTx({extraPreBuildData:e,extInfo:n})}async buildV0(e,t){let{lookupTableCache:n={},lookupTableAddress:o=[],forerunCreate:i,recentBlockhash:s,...a}=e||{},c={...this.cluster==="devnet"?{}:Wi,...n},u=Array.from(new Set([...o,...this.lookupTableAddress])),l=[];for(let f of u)c[f]===void 0&&l.push(new to(f));if(l.length>0){let f=await is({connection:this.connection,address:l});for(let[y,b]of Object.entries(f))c[y]=b}let m=t??(i?to.default.toBase58():s??await eo(this.connection,this.blockhashCommitment)),d=new Ko({payerKey:this.feePayer,recentBlockhash:m,instructions:[...this.allInstructions]}).compileToV0Message(Object.values(c));this.owner?.signer&&!this.signers.some(f=>f.publicKey.equals(this.owner.publicKey))&&this.signers.push(this.owner.signer);let p=new Co(d);return p.sign(this.signers),{builder:this,transaction:p,signers:this.signers,instructionTypes:[...this.instructionTypes,...this.endInstructionTypes],execute:async f=>{let{skipPreflight:y=!0,sendAndConfirm:b,notSendToRpc:g}=f||{};if(Nn([p]),this.owner?.isKeyPair){let P=await this.connection.sendTransaction(p,{skipPreflight:y});return b&&await Ni(this.connection,P),{txId:P,signedTx:p}}if(this.signAllTransactions){let P=await this.signAllTransactions([p]);if(this.signers.length)for(let w of P)try{w.sign(this.signers)}catch{}return{txId:g?"":await this.connection.sendTransaction(P[0],{skipPreflight:y}),signedTx:P[0]}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:a||{}}}async buildV0MultiTx(e){let{extraPreBuildData:t=[],buildProps:n}=e,{transaction:o}=await this.buildV0(n),i=t.filter(u=>u.builder.instructions.length>0),s=[o,...i.map(u=>u.transaction)],a=[this.signers,...i.map(u=>u.signers)],c=[...this.instructionTypes,...i.map(u=>u.instructionTypes).flat()];return this.owner?.signer&&a.forEach(u=>{u.some(l=>l.publicKey.equals(this.owner.publicKey))||this.signers.push(this.owner.signer)}),s.forEach(async(u,l)=>{u.sign(a[l])}),{builder:this,transactions:s,signers:a,instructionTypes:c,buildProps:n,execute:async u=>{let{sequentially:l,onTxUpdate:m,recentBlockHash:d,skipPreflight:p=!0}=u||{};if(d&&s.forEach(f=>f.message.recentBlockhash=d),Nn(s),this.owner?.isKeyPair){if(l){let f=[];for(let y of s){let b=await this.connection.sendTransaction(y,{skipPreflight:p});await Ni(this.connection,b),f.push(b)}return{txIds:f,signedTxs:s}}return{txIds:await Promise.all(s.map(async f=>await this.connection.sendTransaction(f,{skipPreflight:p}))),signedTxs:s}}if(this.signAllTransactions){let f=await this.signAllTransactions(s);if(l){let y=0,b=[],g=async()=>{if(!f[y])return;let P=await this.connection.sendTransaction(f[y],{skipPreflight:p});b.push({txId:P,status:"sent",signedTx:f[y]}),m?.([...b]),y++;let w=!1,k=null,x=null,h=I=>{k!==null&&clearInterval(k),x!==null&&this.connection.removeSignatureListener(x);let S=b.findIndex(T=>T.txId===P);if(S>-1){if(b[S].status==="error"||b[S].status==="success")return;b[S].status=I.err?"error":"success"}m?.([...b]),I.err||g()};this.loopMultiTxStatus&&(k=setInterval(async()=>{if(w){clearInterval(k);return}try{let I=await this.connection.getTransaction(P,{commitment:"confirmed",maxSupportedTransactionVersion:0});I&&(w=!0,clearInterval(k),h({err:I.meta?.err||null}),console.log("tx status from getTransaction:",P))}catch(I){w=!0,clearInterval(k),console.error("getTransaction timeout:",I,P)}},Di)),x=this.connection.onSignature(P,I=>{if(w){this.connection.removeSignatureListener(x);return}w=!0,h(I)},"confirmed"),this.connection.getSignatureStatus(P)};return g(),{txIds:[],signedTxs:f}}else{let y=[];for(let b=0;b<f.length;b+=1){let g=await this.connection.sendTransaction(f[b],{skipPreflight:p});y.push(g)}return{txIds:y,signedTxs:f}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:n||{}}}async sizeCheckBuild(e){let{splitIns:t=[],computeBudgetConfig:n,...o}=e||{},i=n?Jn(n):{instructions:[],instructionTypes:[]},s=this.signers.reduce((m,d)=>({...m,[d.publicKey.toBase58()]:d}),{}),a=[],c=[],u=[],l=0;if(this.allInstructions.forEach(m=>{let d=[...u,m],p=n?[...i.instructions,...d]:d,y=[...new Set(d.map(b=>b.keys.filter(g=>g.isSigner).map(g=>g.pubkey.toString())).flat()).values()].map(b=>new to(b));if(m!==t[l]&&u.length<12&&(ko({instructions:p,payer:this.feePayer,signers:y})||ko({instructions:d,payer:this.feePayer,signers:y})))u.push(m);else{if(u.length===0)throw Error("item ins too big");l+=m===t[l]?1:0,ko({instructions:n?[...i.instructions,...u]:[...u],payer:this.feePayer,signers:y})?a.push(new So().add(...i.instructions,...u)):a.push(new So().add(...u)),c.push(Array.from(new Set(u.map(b=>b.keys.filter(g=>g.isSigner).map(g=>g.pubkey.toString())).flat())).map(b=>s[b]).filter(b=>b!==void 0)),u=[m]}}),u.length>0){let d=[...new Set(u.map(p=>p.keys.filter(f=>f.isSigner).map(f=>f.pubkey.toString())).flat()).values()].map(p=>s[p]).filter(p=>p!==void 0);ko({instructions:n?[...i.instructions,...u]:[...u],payer:this.feePayer,signers:d.map(p=>p.publicKey)})?a.push(new So().add(...i.instructions,...u)):a.push(new So().add(...u)),c.push(d)}return a.forEach(m=>m.feePayer=this.feePayer),this.owner?.signer&&c.forEach(m=>{m.some(d=>d.publicKey.equals(this.owner.publicKey))||m.push(this.owner.signer)}),{builder:this,transactions:a,signers:c,instructionTypes:this.instructionTypes,execute:async m=>{let{sequentially:d,onTxUpdate:p,skipTxCount:f=0,recentBlockHash:y,skipPreflight:b=!0}=m||{},g=y??await eo(this.connection,this.blockhashCommitment);if(a.forEach(async(P,w)=>{P.recentBlockhash=g,c[w].length&&P.sign(...c[w])}),Nn(a),this.owner?.isKeyPair){if(d){let P=0,w=[];for(let k of a){if(++P,P<=f){w.push("tx skipped");continue}let x=await rs(this.connection,k,this.signers.find(h=>h.publicKey.equals(this.owner.publicKey))?this.signers:[...this.signers,this.owner.signer],{skipPreflight:b});w.push(x)}return{txIds:w,signedTxs:a}}return{txIds:await Promise.all(a.map(async P=>await this.connection.sendRawTransaction(P.serialize(),{skipPreflight:b}))),signedTxs:a}}if(this.signAllTransactions){let P=await this.signAllTransactions(a.slice(f,a.length)),w=[...a.slice(0,f),...P];if(d){let k=0,x=[],h=async()=>{if(!w[k])return;k<f&&(x.push({txId:"",status:"success",signedTx:w[k]}),p?.([...x]),k++,h());let I=await this.connection.sendRawTransaction(w[k].serialize(),{skipPreflight:b});x.push({txId:I,status:"sent",signedTx:w[k]}),p?.([...x]),k++;let S=!1,T=null,K=null,R=N=>{T!==null&&clearInterval(T),K!==null&&this.connection.removeSignatureListener(K);let v=x.findIndex(W=>W.txId===I);if(v>-1){if(x[v].status==="error"||x[v].status==="success")return;x[v].status=N.err?"error":"success"}p?.([...x]),N.err||h()};this.loopMultiTxStatus&&(T=setInterval(async()=>{if(S){clearInterval(T);return}try{let N=await this.connection.getTransaction(I,{commitment:"confirmed",maxSupportedTransactionVersion:0});N&&(S=!0,clearInterval(T),R({err:N.meta?.err||null}),console.log("tx status from getTransaction:",I))}catch(N){S=!0,clearInterval(T),console.error("getTransaction timeout:",N,I)}},Di)),K=this.connection.onSignature(I,N=>{if(S){this.connection.removeSignatureListener(K);return}S=!0,R(N)},"confirmed"),this.connection.getSignatureStatus(I)};return await h(),{txIds:x.map(I=>I.txId),signedTxs:w}}else{let k=[];for(let x=0;x<w.length;x+=1){let h=await this.connection.sendRawTransaction(w[x].serialize(),{skipPreflight:b});k.push(h)}return{txIds:k,signedTxs:w}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:o||{}}}async sizeCheckBuildV0(e){let{computeBudgetConfig:t,splitIns:n=[],lookupTableCache:o={},lookupTableAddress:i=[],...s}=e||{},a={...this.cluster==="devnet"?{}:Wi,...o},c=Array.from(new Set([...this.lookupTableAddress,...i])),u=[];for(let P of c)a[P]===void 0&&u.push(new to(P));let l=await is({connection:this.connection,address:u});for(let[P,w]of Object.entries(l))a[P]=w;let m=t?Jn(t):{instructions:[],instructionTypes:[]},d=await eo(this.connection,this.blockhashCommitment),p=this.signers.reduce((P,w)=>({...P,[w.publicKey.toBase58()]:w}),{}),f=[],y=[],b=[],g=0;if(this.allInstructions.forEach(P=>{let w=[...b,P],k=t?[...m.instructions,...w]:w;if(P!==n[g]&&b.length<12&&(ho({instructions:k,payer:this.feePayer,lookupTableAddressAccount:a})||ho({instructions:w,payer:this.feePayer,lookupTableAddressAccount:a})))b.push(P);else{if(b.length===0)throw Error("item ins too big");g+=P===n[g]?1:0;let x={};for(let h of[...new Set(c)])a[h]!==void 0&&(x[h]=a[h]);if(t&&ho({instructions:[...m.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:a,recentBlockhash:d})){let h=new Ko({payerKey:this.feePayer,recentBlockhash:d,instructions:[...m.instructions,...b]}).compileToV0Message(Object.values(a));f.push(new Co(h))}else{let h=new Ko({payerKey:this.feePayer,recentBlockhash:d,instructions:[...b]}).compileToV0Message(Object.values(a));f.push(new Co(h))}y.push(Array.from(new Set(b.map(h=>h.keys.filter(I=>I.isSigner).map(I=>I.pubkey.toString())).flat())).map(h=>p[h]).filter(h=>h!==void 0)),b=[P]}}),b.length>0){let w=[...new Set(b.map(k=>k.keys.filter(x=>x.isSigner).map(x=>x.pubkey.toString())).flat()).values()].map(k=>p[k]).filter(k=>k!==void 0);if(t&&ho({instructions:[...m.instructions,...b],payer:this.feePayer,lookupTableAddressAccount:a,recentBlockhash:d})){let k=new Ko({payerKey:this.feePayer,recentBlockhash:d,instructions:[...m.instructions,...b]}).compileToV0Message(Object.values(a));f.push(new Co(k))}else{let k=new Ko({payerKey:this.feePayer,recentBlockhash:d,instructions:[...b]}).compileToV0Message(Object.values(a));f.push(new Co(k))}y.push(w)}return this.owner?.signer&&y.forEach(P=>{P.some(w=>w.publicKey.equals(this.owner.publicKey))||P.push(this.owner.signer)}),f.forEach((P,w)=>{P.sign(y[w])}),{builder:this,transactions:f,buildProps:e,signers:y,instructionTypes:this.instructionTypes,execute:async P=>{let{sequentially:w,onTxUpdate:k,skipTxCount:x=0,recentBlockHash:h,skipPreflight:I=!0}=P||{};if(f.map(async(S,T)=>{y[T].length&&S.sign(y[T]),h&&(S.message.recentBlockhash=h)}),Nn(f),this.owner?.isKeyPair){if(w){let S=0,T=[];for(let K of f){if(++S,S<=x){console.log("skip tx: ",S),T.push("tx skipped");continue}let R=await this.connection.sendTransaction(K,{skipPreflight:I});await Ni(this.connection,R),T.push(R)}return{txIds:T,signedTxs:f}}return{txIds:await Promise.all(f.map(async S=>await this.connection.sendTransaction(S,{skipPreflight:I}))),signedTxs:f}}if(this.signAllTransactions){let S=await this.signAllTransactions(f.slice(x,f.length)),T=[...f.slice(0,x),...S];if(w){let K=0,R=[],N=async()=>{if(!T[K])return;if(K<x){R.push({txId:"",status:"success",signedTx:T[K]}),k?.([...R]),K++,N();return}let v=await this.connection.sendTransaction(T[K],{skipPreflight:I});R.push({txId:v,status:"sent",signedTx:T[K]}),k?.([...R]),K++;let W=!1,D=null,U=null,ee=J=>{D!==null&&clearInterval(D),U!==null&&this.connection.removeSignatureListener(U);let le=R.findIndex(oe=>oe.txId===v);if(le>-1){if(R[le].status==="error"||R[le].status==="success")return;R[le].status=J.err?"error":"success"}k?.([...R]),J.err||N()};this.loopMultiTxStatus&&(D=setInterval(async()=>{if(W){clearInterval(D);return}try{let J=await this.connection.getTransaction(v,{commitment:"confirmed",maxSupportedTransactionVersion:0});J&&(W=!0,clearInterval(D),ee({err:J.meta?.err||null}),console.log("tx status from getTransaction:",v))}catch(J){W=!0,clearInterval(D),console.error("getTransaction timeout:",J,v)}},Di)),U=this.connection.onSignature(v,J=>{if(W){this.connection.removeSignatureListener(U);return}W=!0,ee(J)},"confirmed"),this.connection.getSignatureStatus(v)};return N(),{txIds:[],signedTxs:T}}else{let K=[];for(let R=0;R<T.length;R+=1){let N=await this.connection.sendTransaction(T[R],{skipPreflight:I});K.push(N)}return{txIds:K,signedTxs:T}}}throw new Error("please provide owner in keypair format or signAllTransactions function")},extInfo:s||{}}}};import _m from"bn.js";var qt=new _m(1e6);var Ze={BASE_HOST:"https://api-v3.raydium.io",OWNER_BASE_HOST:"https://owner-v1.raydium.io",SERVICE_BASE_HOST:"https://service.raydium.io",MONITOR_BASE_HOST:"https://monitor.raydium.io",SERVICE_1_BASE_HOST:"https://service-v1.raydium.io",SEND_TRANSACTION:"/send-transaction",FARM_ARP:"/main/farm/info",FARM_ARP_LINE:"/main/farm-apr-tv",CLMM_CONFIG:"/main/clmm-config",CPMM_CONFIG:"/main/cpmm-config",VERSION:"/main/version",CHECK_AVAILABILITY:"/v3/main/AvailabilityCheckAPI",RPCS:"/main/rpcs",INFO:"/main/info",STAKE_POOLS:"/main/stake-pools",CHAIN_TIME:"/main/chain-time",TOKEN_LIST:"/mint/list",MINT_INFO_ID:"/mint/ids",JUP_TOKEN_LIST:"https://lite-api.jup.ag/tokens/v1/tagged/verified",POOL_LIST:"/pools/info/list",POOL_SEARCH_BY_ID:"/pools/info/ids",POOL_SEARCH_MINT:"/pools/info/mint",POOL_SEARCH_LP:"/pools/info/lps",POOL_KEY_BY_ID:"/pools/key/ids",POOL_LIQUIDITY_LINE:"/pools/line/liquidity",POOL_POSITION_LINE:"/pools/line/position",FARM_INFO:"/farms/info/ids",FARM_LP_INFO:"/farms/info/lp",FARM_KEYS:"/farms/key/ids",OWNER_CREATED_FARM:"/create-pool/{owner}",OWNER_IDO:"/main/ido/{owner}",OWNER_STAKE_FARMS:"/position/stake/{owner}",OWNER_LOCK_POSITION:"/position/clmm-lock/{owner}",IDO_KEYS:"/ido/key/ids",SWAP_HOST:"https://transaction-v1.raydium.io",SWAP_COMPUTE:"/compute/",SWAP_TX:"/transaction/",MINT_PRICE:"/mint/price",MIGRATE_CONFIG:"/main/migrate-lp",PRIORITY_FEE:"/main/auto-fee",CPMM_LOCK:"https://dynamic-ipfs.raydium.io/lock/cpmm/position"},wg={...Ze};var Ya="ray_tab_hash",ss="ray_req_hash",Em=()=>{if(typeof window===void 0)return"";let r=sessionStorage.getItem(Ya);return r||(r=`ray-${Date.now()}`,sessionStorage.setItem(Ya,r)),r},Ui=async({logCount:r=1e3,removeLastLog:e,...t})=>{if(typeof window===void 0)return new Promise(o=>o());let n=JSON.parse(localStorage.getItem(ss)||"[]").slice(0,r-1);e&&n.pop(),new Blob([JSON.stringify(t.data)]).size>1024&&(t.data=JSON.stringify(t.data).substring(0,200)+"..."),n.unshift({...t,time:Date.now(),session:Em()});try{localStorage.setItem(ss,JSON.stringify(n))}catch{if(e){let o=!1,i=JSON.stringify(t.data).substring(0,100);for(n[0].data=i+(i.length>100?"...":"");!o;){n.pop();let s=JSON.stringify(t.data).substring(0,100);n[0].data=s+(s.length>100?"...":"");try{localStorage.setItem(ss,JSON.stringify(n)),o=!0}catch{o=!1}}return new Promise(s=>s())}return Ui({...t,logCount:r,removeLastLog:!0})}};import{TOKEN_2022_PROGRAM_ID as Fm,TOKEN_PROGRAM_ID as Vm}from"@solana/spl-token";var Gi=de("Raydium_Api"),as=new Map;var Xi=class{cluster;api;logCount;urlConfigs;constructor({cluster:e,timeout:t,logRequests:n,logCount:o,urlConfigs:i}){this.cluster=e,this.urlConfigs=i||{},this.logCount=o||1e3,this.api=Za.create({baseURL:this.urlConfigs.BASE_HOST||Ze.BASE_HOST,timeout:t}),this.api.interceptors.request.use(s=>{let{method:a,baseURL:c,url:u}=s;return Gi.debug(`${a?.toUpperCase()} ${c}${u}`),s},s=>(Gi.error("Request failed"),Promise.reject(s))),this.api.interceptors.response.use(s=>{let{config:a,data:c,status:u}=s,{method:l,baseURL:m,url:d}=a;return n&&Ui({status:u,url:`${m}${d}`,params:a.params,data:c,logCount:this.logCount}),Gi.debug(`${l?.toUpperCase()} ${m}${d}  ${u}`),c},s=>{let{config:a,response:c={}}=s,{status:u}=c,{method:l,baseURL:m,url:d}=a;return n&&Ui({status:u,url:`${m}${d}`,params:a.params,data:s.message,logCount:this.logCount}),Gi.error(`${l.toUpperCase()} ${m}${d} ${u||s.message}`),Promise.reject(s)})}async getClmmConfigs(){return(await this.api.get(this.urlConfigs.CLMM_CONFIG||Ze.CLMM_CONFIG)).data}async getCpmmConfigs(){return(await this.api.get(this.urlConfigs.CPMM_CONFIG||Ze.CPMM_CONFIG)).data}async getClmmPoolLines(e){return(await this.api.get(`${this.urlConfigs.POOL_LIQUIDITY_LINE||Ze.POOL_LIQUIDITY_LINE}?pool_id=${e}`)).data}async getBlockSlotCountForSecond(e){if(!e)return 2;let n=(await Za.post(e,{id:"getRecentPerformanceSamples",jsonrpc:"2.0",method:"getRecentPerformanceSamples",params:[4]})).result.map(o=>o.numSlots);return n.reduce((o,i)=>o+i,0)/n.length/60}async getChainTimeOffset(){return(await this.api.get(this.urlConfigs.CHAIN_TIME||Ze.CHAIN_TIME)).data}async getRpcs(){return this.api.get(this.urlConfigs.RPCS||Ze.RPCS)}async getTokenList(){return(await this.api.get(this.urlConfigs.TOKEN_LIST||Ze.TOKEN_LIST)).data}async getJupTokenList(){return(await this.api.get("",{baseURL:this.urlConfigs.JUP_TOKEN_LIST||Ze.JUP_TOKEN_LIST})).map(t=>({...t,chainId:101,programId:t.tags.includes("token-2022")?Fm.toBase58():Vm.toBase58()}))}async getTokenInfo(e){return(await this.api.get((this.urlConfigs.MINT_INFO_ID||Ze.MINT_INFO_ID)+`?mints=${e.map(n=>n.toString()).join(",")}`)).data}async getPoolList(e={}){let{type:t="all",sort:n="liquidity",order:o="desc",page:i=0,pageSize:s=100}=e;return(await this.api.get((this.urlConfigs.POOL_LIST||Ze.POOL_LIST)+`?poolType=${t}&poolSortField=${n}&sortType=${o}&page=${i}&pageSize=${s}`)).data}async fetchPoolById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.POOL_SEARCH_BY_ID||Ze.POOL_SEARCH_BY_ID)+`?ids=${t}`)).data}async fetchPoolKeysById(e){let{idList:t}=e,n=[],o=t.filter(s=>as.has(s)?(n.push(as.get(s)),!1):!0),i=[];return o.length&&(i=(await this.api.get((this.urlConfigs.POOL_KEY_BY_ID||Ze.POOL_KEY_BY_ID)+`?ids=${o.join(",")}`)).data.filter(Boolean),i.forEach(a=>{as.set(a.id,a)})),n.concat(i)}async fetchPoolByMints(e){let{mint1:t,mint2:n,type:o="all",sort:i="default",order:s="desc",page:a=1}=e,[c,u]=[t&&rt(t).toBase58(),n&&n!=="undefined"?rt(n).toBase58():""],[l,m]=u&&c>u?[u,c]:[c,u];return(await this.api.get((this.urlConfigs.POOL_SEARCH_MINT||Ze.POOL_SEARCH_MINT)+`?mint1=${l}&mint2=${m}&poolType=${o}&poolSortField=${i}&sortType=${s}&pageSize=100&page=${a}`)).data}async fetchFarmInfoById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_INFO||Ze.FARM_INFO)+`?ids=${t}`)).data}async fetchFarmKeysById(e){let{ids:t}=e;return(await this.api.get((this.urlConfigs.FARM_KEYS||Ze.FARM_KEYS)+`?ids=${t}`)).data}async fetchAvailabilityStatus(){return(await this.api.get(this.urlConfigs.CHECK_AVAILABILITY||Ze.CHECK_AVAILABILITY)).data}};var Qi="please provide owner in load() initialization or you can set by calling raydium.setOwner(owner)",$a="please provide connection in load() initialization or set it by raydium.setConnection(connection)";import{PublicKey as Ji,SystemProgram as yd}from"@solana/web3.js";import{AccountLayout as so,createAssociatedTokenAccountInstruction as gs,TOKEN_PROGRAM_ID as Tn,TOKEN_2022_PROGRAM_ID as gd}from"@solana/spl-token";var us=(...r)=>r.map(e=>{try{return typeof e=="object"?JSON.stringify(e):e}catch{return e}}).join(", "),Ke=class{scope;disabled=!1;logger;constructor({scope:e,moduleName:t}){this.scope=e,this.logger=de(t)}createTxBuilder(e){return this.scope.checkOwner(),new qi({connection:this.scope.connection,feePayer:e||this.scope.ownerPubKey,cluster:this.scope.cluster,owner:this.scope.owner,blockhashCommitment:this.scope.blockhashCommitment,loopMultiTxStatus:this.scope.loopMultiTxStatus,api:this.scope.api,signAllTransactions:this.scope.signAllTransactions})}logDebug(...e){this.logger.debug(us(e))}logInfo(...e){this.logger.info(us(e))}logAndCreateError(...e){let t=us(e);throw new Error(t)}checkDisabled(){(this.disabled||!this.scope)&&this.logAndCreateError("module not working")}};import{PublicKey as ld,SystemProgram as md}from"@solana/web3.js";import dd from"bn.js";import{createCloseAccountInstruction as pd,createInitializeAccountInstruction as fd,createTransferInstruction as bd,TOKEN_PROGRAM_ID as ro}from"@solana/spl-token";import{Keypair as sd,PublicKey as pu}from"@solana/web3.js";import ad from"bn.js";import{TOKEN_PROGRAM_ID as ud}from"@solana/spl-token";function Wm(r){return r instanceof Uint8Array||r!=null&&typeof r=="object"&&r.constructor.name==="Uint8Array"}function cs(r,...e){if(!Wm(r))throw new Error("Uint8Array expected");if(e.length>0&&!e.includes(r.length))throw new Error(`Uint8Array expected of length ${e}, not of length=${r.length}`)}function ls(r,e=!0){if(r.destroyed)throw new Error("Hash instance has been destroyed");if(e&&r.finished)throw new Error("Hash#digest() has already been called")}function Ja(r,e){cs(r);let t=e.outputLen;if(r.length<t)throw new Error(`digestInto() expects output buffer of length at least ${t}`)}var Hi=r=>new DataView(r.buffer,r.byteOffset,r.byteLength),Ut=(r,e)=>r<<32-e|r>>>e;var rA=new Uint8Array(new Uint32Array([287454020]).buffer)[0]===68;function Dm(r){if(typeof r!="string")throw new Error(`utf8ToBytes expected string, got ${typeof r}`);return new Uint8Array(new TextEncoder().encode(r))}function ms(r){return typeof r=="string"&&(r=Dm(r)),cs(r),r}var zi=class{clone(){return this._cloneInto()}},sA={}.toString;function eu(r){let e=n=>r().update(ms(n)).digest(),t=r();return e.outputLen=t.outputLen,e.blockLen=t.blockLen,e.create=()=>r(),e}function qm(r,e,t,n){if(typeof r.setBigUint64=="function")return r.setBigUint64(e,t,n);let o=BigInt(32),i=BigInt(4294967295),s=Number(t>>o&i),a=Number(t&i),c=n?4:0,u=n?0:4;r.setUint32(e+c,s,n),r.setUint32(e+u,a,n)}var tu=(r,e,t)=>r&e^~r&t,nu=(r,e,t)=>r&e^r&t^e&t,ji=class extends zi{constructor(e,t,n,o){super(),this.blockLen=e,this.outputLen=t,this.padOffset=n,this.isLE=o,this.finished=!1,this.length=0,this.pos=0,this.destroyed=!1,this.buffer=new Uint8Array(e),this.view=Hi(this.buffer)}update(e){ls(this);let{view:t,buffer:n,blockLen:o}=this;e=ms(e);let i=e.length;for(let s=0;s<i;){let a=Math.min(o-this.pos,i-s);if(a===o){let c=Hi(e);for(;o<=i-s;s+=o)this.process(c,s);continue}n.set(e.subarray(s,s+a),this.pos),this.pos+=a,s+=a,this.pos===o&&(this.process(t,0),this.pos=0)}return this.length+=e.length,this.roundClean(),this}digestInto(e){ls(this),Ja(e,this),this.finished=!0;let{buffer:t,view:n,blockLen:o,isLE:i}=this,{pos:s}=this;t[s++]=128,this.buffer.subarray(s).fill(0),this.padOffset>o-s&&(this.process(n,0),s=0);for(let m=s;m<o;m++)t[m]=0;qm(n,o-8,BigInt(this.length*8),i),this.process(n,0);let a=Hi(e),c=this.outputLen;if(c%4)throw new Error("_sha2: outputLen should be aligned to 32bit");let u=c/4,l=this.get();if(u>l.length)throw new Error("_sha2: outputLen bigger than state");for(let m=0;m<u;m++)a.setUint32(4*m,l[m],i)}digest(){let{buffer:e,outputLen:t}=this;this.digestInto(e);let n=e.slice(0,t);return this.destroy(),n}_cloneInto(e){e||(e=new this.constructor),e.set(...this.get());let{blockLen:t,buffer:n,length:o,finished:i,destroyed:s,pos:a}=this;return e.length=o,e.pos=a,e.finished=i,e.destroyed=s,o%t&&e.buffer.set(n),e}};var Um=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]),wn=new Uint32Array([1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225]),kn=new Uint32Array(64),ds=class extends ji{constructor(){super(64,32,8,!1),this.A=wn[0]|0,this.B=wn[1]|0,this.C=wn[2]|0,this.D=wn[3]|0,this.E=wn[4]|0,this.F=wn[5]|0,this.G=wn[6]|0,this.H=wn[7]|0}get(){let{A:e,B:t,C:n,D:o,E:i,F:s,G:a,H:c}=this;return[e,t,n,o,i,s,a,c]}set(e,t,n,o,i,s,a,c){this.A=e|0,this.B=t|0,this.C=n|0,this.D=o|0,this.E=i|0,this.F=s|0,this.G=a|0,this.H=c|0}process(e,t){for(let m=0;m<16;m++,t+=4)kn[m]=e.getUint32(t,!1);for(let m=16;m<64;m++){let d=kn[m-15],p=kn[m-2],f=Ut(d,7)^Ut(d,18)^d>>>3,y=Ut(p,17)^Ut(p,19)^p>>>10;kn[m]=y+kn[m-7]+f+kn[m-16]|0}let{A:n,B:o,C:i,D:s,E:a,F:c,G:u,H:l}=this;for(let m=0;m<64;m++){let d=Ut(a,6)^Ut(a,11)^Ut(a,25),p=l+d+tu(a,c,u)+Um[m]+kn[m]|0,y=(Ut(n,2)^Ut(n,13)^Ut(n,22))+nu(n,o,i)|0;l=u,u=c,c=a,a=s+p|0,s=i,i=o,o=n,n=p+y|0}n=n+this.A|0,o=o+this.B|0,i=i+this.C|0,s=s+this.D|0,a=a+this.E|0,c=c+this.F|0,u=u+this.G|0,l=l+this.H|0,this.set(n,o,i,s,a,c,u,l)}roundClean(){kn.fill(0)}destroy(){this.set(0,0,0,0,0,0,0,0),this.buffer.fill(0)}};var ou=eu(()=>new ds);import{PublicKey as nd}from"@solana/web3.js";import cu,{isBN as lu}from"bn.js";import{bits as Gm,BitStructure as bA,blob as Xm,Blob as yA,cstr as gA,f32 as AA,f32be as PA,f64 as wA,f64be as kA,greedy as hA,Layout as Qm,ns64 as TA,ns64be as IA,nu64 as zm,nu64be as BA,offset as Hm,s16 as xA,s16be as SA,s24 as KA,s24be as CA,s32 as jm,s32be as LA,s40 as RA,s40be as NA,s48 as OA,s48be as vA,s8 as MA,seq as Ym,struct as _A,Structure as Zm,u16 as $m,u16be as EA,u24 as FA,u24be as VA,u32 as Jm,u32be as WA,u40 as DA,u40be as qA,u48 as UA,u48be as GA,u8 as ed,UInt as td,union as XA,Union as QA,unionLayoutDiscriminator as zA,utf8 as HA}from"@solana/buffer-layout";var Yi=Qm,iu=Zm;var ps=td;var ru=ed,Gt=$m;var Zi=Jm;var su=zm;var Ce=jm;var au=Ym;var Pe=Xm;var fs=Gm,uu=Hm;var vn=class extends Yi{blob;signed;constructor(e,t,n){super(e,n),this.blob=Pe(e),this.signed=t}decode(e,t=0){let n=new cu(this.blob.decode(e,t),10,"le");return this.signed?n.fromTwos(this.span*8).clone():n}encode(e,t,n=0){return typeof e=="number"&&(e=new cu(e)),this.signed&&(e=e.toTwos(this.span*8)),this.blob.encode(e.toArrayLike(Buffer,"le",this.span),t,n)}},$i=class extends Yi{_lower;_upper;constructor(e){super(8,e),this._lower=fs(Zi(),!1),this._upper=fs(Zi(),!1)}addBoolean(e){this._lower.fields.length<32?this._lower.addBoolean(e):this._upper.addBoolean(e)}decode(e,t=0){let n=this._lower.decode(e,t),o=this._upper.decode(e,t+this._lower.span);return{...n,...o}}encode(e,t,n=0){return this._lower.encode(e,t,n)+this._upper.encode(e,t,n+this._lower.span)}};function V(r){return new ps(1,r)}function ut(r){return new ps(4,r)}function A(r){return new vn(8,!1,r)}function Z(r){return new vn(16,!1,r)}function mu(r){return new vn(1,!0,r)}function io(r){return new vn(8,!0,r)}function du(r){return new vn(16,!0,r)}var oo=class extends Yi{layout;decoder;encoder;constructor(e,t,n,o){super(e.span,o),this.layout=e,this.decoder=t,this.encoder=n}decode(e,t){return this.decoder(this.layout.decode(e,t))}encode(e,t,n){return this.layout.encode(this.encoder(e),t,n)}getSpan(e,t){return this.layout.getSpan(e,t)}};function C(r){return new oo(Pe(32),e=>new nd(e),e=>e.toBuffer(),r)}function Me(r){return new oo(ru(),od,id,r)}function od(r){if(r===0)return!1;if(r===1)return!0;throw new Error("Invalid bool: "+r)}function id(r){return r?1:0}function rd(r){let e=Zi("length"),t=O([e,Pe(uu(e,-e.span),"data")]);return new oo(t,({data:n})=>n,n=>({data:n}),r)}function Xt(r){return new oo(rd(),e=>e.toString("utf-8"),e=>Buffer.from(e,"utf-8"),r)}var bs=class extends iu{decode(e,t){return super.decode(e,t)}};function O(r,e,t){return new bs(r,e,t)}function X(r,e,t){let n,o=typeof e=="number"?e:lu(e)?e.toNumber():new Proxy(e,{get(i,s){if(!n){let a=Reflect.get(i,"count");n=lu(a)?a.toNumber():a,Reflect.set(i,"count",n)}return Reflect.get(i,s)},set(i,s,a){return s==="count"&&(n=a),Reflect.set(i,s,a)}});return au(r,o,t)}var Mn=O([C("mint"),C("owner"),A("amount"),ut("delegateOption"),C("delegate"),V("state"),ut("isNativeOption"),A("isNative"),A("delegatedAmount"),ut("closeAuthorityOption"),C("closeAuthority")]);var bP=de("Raydium_Util");function fu({owner:r,solAccountResp:e,tokenAccountResp:t}){let n=[],o=[];for(let{pubkey:i,account:s}of t.value){let a=Mn.decode(s.data),{mint:c,amount:u}=a;n.push({publicKey:i,mint:c,amount:u,isAssociated:$(r,c,s.owner).publicKey.equals(i),isNative:!1,programId:s.owner}),o.push({pubkey:i,accountInfo:a,programId:s.owner})}return e&&n.push({mint:pu.default,amount:new ad(String(e.lamports)),isNative:!0,programId:e.owner}),{tokenAccounts:n,tokenAccountRawInfos:o}}function Fe({fromPublicKey:r,programId:e=ud,assignSeed:t}){let n=t?btoa(t).slice(0,32):sd.generate().publicKey.toBase58().slice(0,32);return{publicKey:cd(r,n,e),seed:n}}function cd(r,e,t){let n=Buffer.concat([r.toBuffer(),Buffer.from(e),t.toBuffer()]),o=ou(n);return new pu(o)}function ys(r){let{mint:e,tokenAccount:t,owner:n,programId:o=ro}=r;return fd(t,e,n,o)}function rn(r){let{tokenAccount:e,payer:t,multiSigners:n=[],owner:o,programId:i=ro}=r;return pd(e,t,o,n,i)}async function hn(r){let{connection:e,amount:t,commitment:n,payer:o,owner:i,skipCloseAccount:s}=r,a=await e.getMinimumBalanceForRentExemption(Mn.span,n),c=j(t).add(new dd(a)),u=Fe({fromPublicKey:o,programId:ro});return{addresses:{newAccount:u.publicKey},signers:[],instructions:[md.createAccountWithSeed({fromPubkey:o,basePubkey:o,seed:u.seed,newAccountPubkey:u.publicKey,lamports:c.toNumber(),space:Mn.span,programId:ro}),ys({mint:new ld(at.address),tokenAccount:u.publicKey,owner:i,programId:ro})],instructionTypes:[E.CreateAccount,E.InitAccount],endInstructionTypes:s?[]:[E.CloseAccount],endInstructions:s?[]:[rn({tokenAccount:u.publicKey,payer:o,owner:i})]}}function bu({source:r,destination:e,owner:t,amount:n,multiSigners:o=[],tokenProgram:i=ro}){return bd(r,e,t,BigInt(String(n)),o,i)}var Lo=class extends Ke{_tokenAccounts=[];_tokenAccountRawInfos=[];_accountChangeListenerId;_accountListener=[];_clientOwnedToken=!1;_notSubscribeAccountChange=!1;_accountFetchTime=0;constructor(e){super(e);let{tokenAccounts:t,tokenAccountRawInfos:n,notSubscribeAccountChange:o}=e;this._tokenAccounts=t||[],this._tokenAccountRawInfos=n||[],this._notSubscribeAccountChange=o??!0,this._clientOwnedToken=!!(t||n)}get tokenAccounts(){return this._tokenAccounts}get tokenAccountRawInfos(){return this._tokenAccountRawInfos}set notSubscribeAccountChange(e){this._notSubscribeAccountChange=e}updateTokenAccount({tokenAccounts:e,tokenAccountRawInfos:t}){return e&&(this._tokenAccounts=e),t&&(this._tokenAccountRawInfos=t),this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=void 0,this._clientOwnedToken=!0,this}addAccountChangeListener(e){return this._accountListener.push(e),this}removeAccountChangeListener(e){return this._accountListener=this._accountListener.filter(t=>t!==e),this}getAssociatedTokenAccount(e,t){return $(this.scope.ownerPubKey,e,t).publicKey}resetTokenAccounts(){this._clientOwnedToken||(this._tokenAccounts=[],this._tokenAccountRawInfos=[])}async fetchWalletTokenAccounts(e){if(this._clientOwnedToken||!e?.forceUpdate&&this._tokenAccounts.length&&Date.now()-this._accountFetchTime<(this._notSubscribeAccountChange?1e3*5:1e3*60*3))return{tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos};this.scope.checkOwner();let n={...{},...e},[o,i,s]=await Promise.all([this.scope.connection.getAccountInfo(this.scope.ownerPubKey,n.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:Tn},n.commitment),this.scope.connection.getTokenAccountsByOwner(this.scope.ownerPubKey,{programId:gd},n.commitment)]),{tokenAccounts:a,tokenAccountRawInfos:c}=fu({owner:this.scope.ownerPubKey,solAccountResp:o,tokenAccountResp:{context:i.context,value:[...i.value,...s.value]}});return this._tokenAccounts=a,this._tokenAccountRawInfos=c,this._accountFetchTime=Date.now(),this._notSubscribeAccountChange||(this._accountChangeListenerId&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId),this._accountChangeListenerId=this.scope.connection.onAccountChange(this.scope.ownerPubKey,()=>{this.fetchWalletTokenAccounts({forceUpdate:!0}),this._accountListener.forEach(u=>u({tokenAccounts:this._tokenAccounts,tokenAccountRawInfos:this._tokenAccountRawInfos}))},{commitment:e?.commitment})),{tokenAccounts:a,tokenAccountRawInfos:c}}clearAccountChangeCkb(){this._accountChangeListenerId!==void 0&&this.scope.connection.removeAccountChangeListener(this._accountChangeListenerId)}async getCreatedTokenAccount({mint:e,programId:t=Tn,associatedOnly:n=!0}){await this.fetchWalletTokenAccounts();let o=this._tokenAccounts.filter(({mint:s})=>s?.equals(e)).sort((s,a)=>s.amount.lt(a.amount)?1:-1),i=this.getAssociatedTokenAccount(e,t);for(let s of o){let{publicKey:a}=s;if(a&&(!n||n&&i.equals(a)))return a}}async getOrCreateTokenAccount(e){await this.fetchWalletTokenAccounts();let{mint:t,createInfo:n,associatedOnly:o,owner:i,notUseTokenAccount:s=!1,skipCloseAccount:a=!1,checkCreateATAOwner:c=!1,assignSeed:u}=e,l=new Ji(e.tokenProgram||Tn),m=this.getAssociatedTokenAccount(t,new Ji(l)),d=(s?[]:this.tokenAccountRawInfos).filter(f=>f.accountInfo.mint.equals(t)&&(!o||f.pubkey.equals(m))).sort((f,y)=>f.accountInfo.amount.lt(y.accountInfo.amount)?1:-1);n===void 0||d.length>0;let p={instructions:[],endInstructions:[],signers:[],instructionTypes:[],endInstructionTypes:[]};if(o){let f=gs(i,m,i,t,l),y=this.tokenAccountRawInfos.find(b=>b.pubkey.equals(m));if(c){let b=await this.scope.connection.getAccountInfo(m);if(b===null)p.instructions?.push(f),p.instructionTypes.push(E.CreateATA);else if(!(b.owner.equals(l)&&so.decode(b.data).mint.equals(t)&&so.decode(b.data).owner.equals(i)))throw Error(`create ata check error -> mint: ${t.toString()}, ata: ${m.toString()}`)}else y===void 0&&(p.instructions.push(f),p.instructionTypes.push(E.CreateATA));if(t.equals(H)&&n?.amount){let b=await hn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:n.payer||this.scope.ownerPubKey,amount:n.amount??0,skipCloseAccount:a});p.instructions.push(...b.instructions||[]),p.endInstructions.push(...b.endInstructions||[]),p.instructionTypes.push(...b.instructionTypes||[]),p.endInstructionTypes.push(...b.endInstructionTypes||[]),n.amount&&(p.instructions.push(bu({source:b.addresses.newAccount,destination:m,owner:this.scope.ownerPubKey,amount:n.amount,tokenProgram:Tn})),p.instructionTypes.push(E.TransferAmount))}return!a&&y===void 0&&(p.endInstructions.push(rn({owner:i,payer:n?.payer||i,tokenAccount:m,programId:l})),p.endInstructionTypes.push(E.CloseAccount)),{account:m,instructionParams:p}}else{let f=Fe({fromPublicKey:i,programId:l,assignSeed:u}),y=await this.scope.connection.getMinimumBalanceForRentExemption(so.span),b=yd.createAccountWithSeed({fromPubkey:i,basePubkey:i,seed:f.seed,newAccountPubkey:f.publicKey,lamports:y+Number(n?.amount?.toString()??0),space:so.span,programId:l});return p.instructions.push(b,ys({mint:t,tokenAccount:f.publicKey,owner:this.scope.ownerPubKey,programId:l})),p.instructionTypes.push(E.CreateAccount),p.instructionTypes.push(E.InitAccount),a||(p.endInstructions.push(rn({owner:i,payer:n?.payer||i,tokenAccount:f.publicKey,programId:l})),p.endInstructionTypes.push(E.CloseAccount)),{account:f.publicKey,instructionParams:p}}}async checkOrCreateAta({mint:e,programId:t=Tn,autoUnwrapWSOLToSOL:n}){await this.fetchWalletTokenAccounts();let o=this.scope.account.tokenAccounts.find(({mint:a})=>a?.toBase58()===e.toBase58())?.publicKey,i=this.scope.ownerPubKey,s={};if(!o){let a=this.getAssociatedTokenAccount(e,t),c=await gs(i,a,i,e,t);s.instructions=[c],s.instructionTypes=[E.CreateATA],o=a}return n&&H.toBase58()===e.toBase58()&&(s.endInstructions=[rn({owner:i,payer:i,tokenAccount:o,programId:t})],s.endInstructionTypes=[E.CloseAccount]),{pubKey:o,newInstructions:s}}async handleTokenAccount(e){let{side:t,amount:n,mint:o,programId:i=Tn,tokenAccount:s,payer:a=this.scope.ownerPubKey,bypassAssociatedCheck:c,skipCloseAccount:u,checkCreateATAOwner:l}=e,m=this.getAssociatedTokenAccount(o,i);if(new Ji(H).equals(o)){let d=await hn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:a,amount:n,skipCloseAccount:u});return{tokenAccount:d.addresses.newAccount,...d}}else if(!s||t==="out"&&!m.equals(s)&&!c){let d=[],p=gs(this.scope.ownerPubKey,m,this.scope.ownerPubKey,o,i);if(l){let f=await this.scope.connection.getAccountInfo(m);if(f===null)d.push(p);else if(!(f.owner.equals(Tn)&&so.decode(f.data).mint.equals(o)&&so.decode(f.data).owner.equals(this.scope.ownerPubKey)))throw Error(`create ata check error -> mint: ${o.toString()}, ata: ${m.toString()}`)}else d.push(p);return{tokenAccount:m,instructions:d,instructionTypes:[E.CreateATA]}}return{tokenAccount:s}}async processTokenAccount(e){let{mint:t,programId:n=Tn,amount:o,useSOLBalance:i,handleTokenAccount:s,feePayer:a}=e,c,u=this.createTxBuilder(a);if(t.equals(new Ji(H))&&i){let{tokenAccount:l,...m}=await this.handleTokenAccount({side:"in",amount:o||0,mint:t,bypassAssociatedCheck:!0,programId:n});c=l,u.addInstruction(m)}else if(c=await this.getCreatedTokenAccount({mint:t,associatedOnly:!1,programId:n}),!c&&s){let{tokenAccount:l,...m}=await this.scope.account.handleTokenAccount({side:"in",amount:0,mint:t,bypassAssociatedCheck:!0,programId:n});c=l,u.addInstruction(m)}return{tokenAccount:c,...u.AllTxData}}};import{PublicKey as he,SystemProgram as vd}from"@solana/web3.js";import{createAssociatedTokenAccountInstruction as Md}from"@solana/spl-token";import{PublicKey as Au}from"@solana/web3.js";var As=O([V("instruction")]),Ps=O([V("instruction")]),Ad=O([A("rewardState"),A("rewardOpenTime"),A("rewardEndTime"),A("rewardLastUpdateTime"),A("totalReward"),A("totalRewardEmissioned"),A("rewardClaimed"),A("rewardPerSecond"),Z("accRewardPerShare"),C("rewardVault"),C("rewardMint"),C("rewardSender"),A("rewardType"),X(A(),15,"padding")]),Pd=O([A("state"),A("nonce"),C("lpVault"),C("rewardVault"),C(),C(),A(),A(),A("totalReward"),Z("perShareReward"),A("lastSlot"),A("perSlotReward")]),wd=O([A("state"),A("nonce"),C("lpVault"),C("rewardVaultA"),A("totalRewardA"),Z("perShareRewardA"),A("perSlotRewardA"),V("option"),C("rewardVaultB"),Pe(7),A("totalRewardB"),Z("perShareRewardB"),A("perSlotRewardB"),A("lastSlot"),C()]),kd=O([A(),A("state"),A("nonce"),A("validRewardTokenNum"),Z("rewardMultiplier"),A("rewardPeriodMax"),A("rewardPeriodMin"),A("rewardPeriodExtend"),C("lpMint"),C("lpVault"),X(Ad,5,"rewardInfos"),C("creator"),C(),X(A(),32,"padding")]),hd=new Proxy(Pd,{get(r,e,t){return e==="decode"?(...n)=>{let o=r.decode(...n);return{...o,version:3,rewardInfos:[{rewardVault:o.rewardVault,totalReward:o.totalReward,perSlotReward:o.perSlotReward,perShareReward:o.perShareReward}]}}:Reflect.get(r,e,t)}}),Td=new Proxy(wd,{get(r,e,t){return e==="decode"?(...n)=>{let o=r.decode(...n);return{...o,version:5,rewardInfos:[{rewardVault:o.rewardVaultA,totalReward:o.totalRewardA,perSlotReward:o.perSlotRewardA,perShareReward:o.perShareRewardA},{rewardVault:o.rewardVaultB,totalReward:o.totalRewardB,perSlotReward:o.perSlotRewardB,perShareReward:o.perShareRewardB}]}}:Reflect.get(r,e,t)}}),er=new Proxy(kd,{get(r,e,t){return e==="decode"?(...n)=>{let o=r.decode(...n);return{...o,version:6,rewardInfos:o.rewardInfos.map(i=>({...i,rewardType:(Object.entries(In).find(s=>String(s[1])===i.rewardType.toString())??["Standard SPL"])[0]}))}}:Reflect.get(r,e,t)}}),Id=O([A("isSet"),A("rewardPerSecond"),A("rewardOpenTime"),A("rewardEndTime"),A("rewardType")]),ws=O([V("instruction"),A("nonce"),X(Id,5,"rewardTimeInfo")]),ks=O([V("instruction"),A("rewardReopenTime"),A("rewardEndTime"),A("rewardPerSecond")]),hs=O([V("instruction"),A("isSet"),A("rewardPerSecond"),A("rewardOpenTime"),A("rewardEndTime"),A("rewardType")]),zP=O([A("state"),C("id"),C("owner"),A("deposited"),X(A(),1,"rewardDebts")]),Ts=O([A("state"),C("id"),C("owner"),A("deposited"),X(Z(),1,"rewardDebts"),A(""),A("voteLockedBalance"),X(A(),15)]),HP=O([A("state"),C("id"),C("owner"),A("deposited"),X(A(),2,"rewardDebts")]),yu=O([A("state"),C("id"),C("owner"),A("deposited"),X(Z(),2,"rewardDebts"),X(A(),17)]),gu=O([A(),A("state"),C("id"),C("owner"),A("deposited"),X(Z(),5,"rewardDebts"),X(A(),16)]),It=O([V("instruction"),A("amount")]),Bd=O([C("mint"),C("grantAuthority"),A("baselineVoteWeightScaledFactor"),A("maxExtraLockupVoteWeightScaledFactor"),A("lockupSaturationSecs"),mu("digitShift"),X(V(),7,"reserved1"),X(A(),7,"reserved2")]),xd=O([Pe(8),C("governanceProgramId"),C("realm"),C("realmGoverningTokenMint"),C("realmAuthority"),X(V(),32,"reserved1"),X(Bd,4,"votingMints"),io("timeOffset"),V("bump"),X(V(),7,"reserved2"),X(A(),11,"reserved3")]),Sd=O([io("startTime"),io("endTime"),V("kind"),X(V(),15,"reserved")]),Kd=O([X(Sd,1,"lockup"),A("amountDeposited_native"),A("amountInitiallyLockedNative"),Me("isUsed"),Me("allowClawback"),V("votingMintConfigIdx"),X(V(),29,"reserved")]),Cd=O([Pe(8),C("voterAuthority"),C("registrar"),X(Kd,32,"deposits"),V("voterBump"),V("voterWweightRecordBump"),X(V(),94,"reserved")]);var nw=de("Raydium_farm_config"),Pu=new Au("4k3Dyjzvzp8eMZWUXbBCjEvwSkkk59S5iCNLY3QrkX6R"),wu=new Au("FrspKwj8i3pNmKwXreTveC4fu7KL5ZbGeXdZBe2XViu1");var ku={3:Ts,5:yu,6:gu},Is=r=>[3,4,5,6].indexOf(r)!==-1,Bs=r=>{let{version:e,rewardInfos:t,rewardTokenAccountsPublicKeys:n}=r,o=`rewardInfo:${JSON.stringify(t)}, rewardAccount:${JSON.stringify(n)}`;return{3:()=>{if(t.length!==1||n.length!==1)return`rewardInfos or rewardTokenAccounts lengths not equal 1: ${o}`},5:()=>{if(t.length!==n.length)return`rewardInfos and rewardTokenAccounts lengths not equal: ${o}`},6:()=>{if(!n.length||t.length!==n.length)return`no rewardTokenAccounts or rewardInfos and rewardTokenAccounts lengths not equal: ${o}`}}[e]?.()},In={"Standard SPL":0,"Option tokens":1},Ct={[qa.toString()]:3,[Ua.toString()]:4,[Ga.toString()]:5,[To.toString()]:6};import{PublicKey as me,SystemProgram as Iu,SYSVAR_CLOCK_PUBKEY as Oo,SYSVAR_RENT_PUBKEY as Nd,TransactionInstruction as Rt}from"@solana/web3.js";import Bu from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as vw,createAssociatedTokenAccountInstruction as Mw,TOKEN_PROGRAM_ID as sn}from"@solana/spl-token";import Ld from"bn.js";var Rd=de("Raydium.farm.util");function Ro({programId:r,poolId:e,mint:t,type:n}){let{publicKey:o}=ue([e.toBuffer(),t.toBuffer(),Buffer.from(n==="lpVault"?"lp_vault_associated_seed":n==="rewardVault"?"reward_vault_associated_seed":"","utf-8")],r);return o}function Lt({programId:r,poolId:e,owner:t,version:n}){let{publicKey:o}=ue([e.toBuffer(),t.toBuffer(),Buffer.from(n===6?"farmer_info_associated_seed":"staker_info_v2_associated_seed","utf-8")],r);return o}var hu=({programId:r,poolId:e})=>ue([e.toBuffer()],r);function Tu(r){return{isSet:new Ld(1),rewardPerSecond:j(r.perSecond),rewardOpenTime:j(r.openTime),rewardEndTime:j(r.endTime),rewardType:j(In[r.rewardType])}}function xs(r){return j(r.endTime).sub(j(r.openTime)).mul(j(r.perSecond))}function No(r){let e=ku[r];return e||Rd.logWithError("invalid version",r),e}var Od=de("Raydium_farm_instruction"),Qw={voterStakeRegistryCreateVoter:Buffer.from([6,24,245,52,243,255,148,25]),voterStakeRegistryCreateDepositEntry:Buffer.from([185,131,167,186,159,125,19,67]),voterStakeRegistryDeposit:Buffer.from([242,35,198,137,82,225,242,182]),voterStakeRegistryWithdraw:Buffer.from([183,18,70,156,148,109,161,34]),voterStakeRegistryUpdateVoterWeightRecord:Buffer.from([45,185,3,36,109,190,115,169])};function vo(r){let{version:e,id:t,ledger:n,programId:o,owner:i}=r,s={3:9,5:10}[e];s||Od.logWithError(`invalid farm pool version: ${e}`);let a=Buffer.alloc(As.span);As.encode({instruction:s},a);let c=[B({pubkey:t}),B({pubkey:n}),B({pubkey:i,isWritable:!1}),B({pubkey:Iu.programId,isWritable:!1}),B({pubkey:Nd,isWritable:!1})];return{instruction:new Rt({programId:o,keys:c,data:a}),instructionType:E.FarmV3CreateLedger}}function xu(r){let e=Buffer.alloc(ws.span);ws.encode({instruction:0,nonce:new Bu(r.nonce),rewardTimeInfo:r.rewardInfoConfig},e);let t=[...zr,B({pubkey:r.farmId}),B({pubkey:r.farmAuthority,isWritable:!1}),B({pubkey:r.lpVault}),B({pubkey:r.lpMint,isWritable:!1}),B({pubkey:r.lockVault}),B({pubkey:r.lockMint,isWritable:!1}),B({pubkey:r.lockUserAccount??je}),B({pubkey:r.owner,isWritable:!1,isSigner:!0})];for(let n of r.rewardInfo)t.push(B({pubkey:n.rewardMint,isWritable:!1}),B({pubkey:n.rewardVault}),B({pubkey:n.userRewardToken}));return{instruction:new Rt({programId:r.programId,keys:t,data:e}),instructionType:E.FarmV6Create}}function Su(r){let e=Buffer.alloc(Ps.span);Ps.encode({instruction:5},e);let t=[B({pubkey:sn,isWritable:!1}),B({pubkey:r.id}),B({pubkey:r.authority,isWritable:!1}),B({pubkey:r.lpVault,isWritable:!1}),B({pubkey:r.rewardVault}),B({pubkey:r.userRewardToken}),B({pubkey:r.owner,isWritable:!1,isSigner:!0})];return{instruction:new Rt({programId:r.programId,keys:t,data:e}),instructionType:E.FarmV6CreatorWithdraw}}function Ss({payer:r,rewardVault:e,userRewardTokenPub:t,farmKeys:n,rewardInfo:o}){let i=Buffer.alloc(ks.span);ks.encode({instruction:3,rewardReopenTime:j(o.openTime),rewardEndTime:j(o.endTime),rewardPerSecond:j(o.perSecond)},i);let s=[B({pubkey:sn,isWritable:!1}),B({pubkey:n.id}),B({pubkey:n.lpVault,isWritable:!1}),B({pubkey:e}),B({pubkey:t}),B({pubkey:r,isWritable:!1,isSigner:!0})];return new Rt({programId:n.programId,keys:s,data:i})}function Ks({payer:r,userRewardTokenPub:e,farmKeys:t,rewardVault:n,rewardInfo:o}){let i=Buffer.alloc(hs.span);hs.encode({instruction:4,isSet:new Bu(1),rewardPerSecond:j(o.perSecond),rewardOpenTime:j(o.openTime),rewardEndTime:j(o.endTime),rewardType:j(In[o.rewardType])},i);let s=[...zr,B({pubkey:t.id}),B({pubkey:t.authority,isWritable:!1}),B({pubkey:o.mint,isWritable:!1}),B({pubkey:n}),B({pubkey:e}),B({pubkey:r,isWritable:!1,isSigner:!0})];return new Rt({programId:t.programId,keys:s,data:i})}function Mo(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s}=r,[a,c]=[new me(e.programId),new me(e.id)],u=Lt({programId:a,poolId:c,owner:i,version:6}),l=Buffer.alloc(It.span);It.encode({instruction:2,amount:j(s)},l);let m=[B({pubkey:sn,isWritable:!1}),B({pubkey:c}),B({pubkey:new me(t.authority),isWritable:!1}),B({pubkey:new me(t.lpVault)}),B({pubkey:u}),B({pubkey:i,isWritable:!1,isSigner:!0}),B({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(B({pubkey:new me(t.rewardInfos[d].vault)})),m.push(B({pubkey:o[d]}));return new Rt({programId:a,keys:m,data:l})}function _o(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new me(e.programId),new me(e.id)],l=Lt({programId:c,poolId:u,owner:i,version:5}),m=Buffer.alloc(It.span);It.encode({instruction:12,amount:j(s)},m);let d=[B({pubkey:u}),B({pubkey:new me(t.authority),isWritable:!1}),B({pubkey:l}),B({pubkey:i,isWritable:!1,isSigner:!0}),B({pubkey:n}),B({pubkey:new me(t.lpVault)}),B({pubkey:o[0]}),B({pubkey:new me(t.rewardInfos[0].vault)}),B({pubkey:Oo,isWritable:!1}),B({pubkey:sn,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(B({pubkey:o[p]})),d.push(B({pubkey:new me(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(B({pubkey:p}));return new Rt({programId:c,keys:d,data:m})}function Ku(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new me(e.programId),new me(e.id)],l=O([V("instruction"),A("amount")]),m=[B({pubkey:u}),B({pubkey:new me(t.authority),isWritable:!1}),B({pubkey:a[0]}),B({pubkey:i,isSigner:!0,isWritable:!1}),B({pubkey:n}),B({pubkey:new me(t.lpVault)}),B({pubkey:o[0]}),B({pubkey:new me(t.rewardInfos[0].vault)}),B({pubkey:Oo,isWritable:!1}),B({pubkey:sn,isWritable:!1}),B({pubkey:o[1]}),B({pubkey:new me(t.rewardInfos[1].vault)})],d=Buffer.alloc(l.span);return l.encode({instruction:2,amount:s},d),new Rt({keys:m,programId:c,data:d})}function Eo(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new me(e.programId),new me(e.id)],l=Lt({programId:c,poolId:u,owner:i,version:3}),m=Buffer.alloc(It.span);It.encode({instruction:11,amount:j(s)},m);let d=[B({pubkey:u}),B({pubkey:new me(t.authority),isWritable:!1}),B({pubkey:l}),B({pubkey:i,isWritable:!1,isSigner:!0}),B({pubkey:n}),B({pubkey:new me(t.lpVault)}),B({pubkey:o[0]}),B({pubkey:new me(t.rewardInfos[0].vault)}),B({pubkey:Oo,isWritable:!1}),B({pubkey:sn,isWritable:!1})];if(a)for(let p of a)d.push(B({pubkey:p}));return new Rt({programId:c,keys:d,data:m})}function Cu(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new me(e.programId),new me(e.id)],l=Lt({programId:c,poolId:u,owner:i,version:3}),m=Buffer.alloc(It.span);It.encode({instruction:10,amount:j(s)},m);let d=[B({pubkey:u}),B({pubkey:new me(t.authority),isWritable:!1}),B({pubkey:l}),B({pubkey:i,isWritable:!1,isSigner:!0}),B({pubkey:n}),B({pubkey:new me(t.lpVault)}),B({pubkey:o[0]}),B({pubkey:new me(t.rewardInfos[0].vault)}),B({pubkey:Oo,isWritable:!1}),B({pubkey:sn,isWritable:!1})];if(a)for(let p of a)d.push(B({pubkey:p}));return new Rt({programId:c,keys:d,data:m})}function Lu(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s,userAuxiliaryLedgers:a}=r,[c,u]=[new me(e.programId),new me(e.id)],l=Lt({programId:c,poolId:u,owner:i,version:5}),m=Buffer.alloc(It.span);It.encode({instruction:11,amount:j(s)},m);let d=[B({pubkey:u}),B({pubkey:new me(t.authority),isWritable:!1}),B({pubkey:l}),B({pubkey:i,isWritable:!1,isSigner:!0}),B({pubkey:n}),B({pubkey:new me(t.lpVault)}),B({pubkey:o[0]}),B({pubkey:new me(t.rewardInfos[0].vault)}),B({pubkey:Oo,isWritable:!1}),B({pubkey:sn,isWritable:!1})];for(let p=1;p<t.rewardInfos.length;p++)d.push(B({pubkey:o[p]})),d.push(B({pubkey:new me(t.rewardInfos[p].vault)}));if(a)for(let p of a)d.push(B({pubkey:p}));return new Rt({programId:c,keys:d,data:m})}function Ru(r){let{farmInfo:e,farmKeys:t,lpAccount:n,rewardAccounts:o,owner:i,amount:s}=r,[a,c]=[new me(e.programId),new me(e.id)],u=Lt({programId:a,poolId:c,owner:i,version:6}),l=Buffer.alloc(It.span);It.encode({instruction:1,amount:j(s)},l);let m=[B({pubkey:sn,isWritable:!1}),B({pubkey:Iu.programId,isWritable:!1}),B({pubkey:c}),B({pubkey:new me(t.authority),isWritable:!1}),B({pubkey:new me(t.lpVault)}),B({pubkey:u}),B({pubkey:i,isWritable:!1,isSigner:!0}),B({pubkey:n})];for(let d=0;d<t.rewardInfos.length;d++)m.push(B({pubkey:new me(t.rewardInfos[d].vault)})),m.push(B({pubkey:o[d]}));return new Rt({programId:a,keys:m,data:l})}var Fo=class extends Ke{async _getUserRewardInfo({payer:e,rewardInfo:t}){if(t.mint.equals(je)){let n=await hn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:e,amount:xs({...t,openTime:t.openTime.toString(),endTime:t.endTime.toString()})});return{rewardPubKey:n.addresses.newAccount,newInstruction:n}}return{rewardPubKey:await this.scope.account.getCreatedTokenAccount({mint:t.mint,associatedOnly:!1})}}async create({poolInfo:e,rewardInfos:t,payer:n,programId:o=To,txVersion:i,feePayer:s}){this.checkDisabled(),this.scope.checkOwner();let c={lpMint:new he(e.lpMint.address),lockInfo:{lockMint:Pu,lockVault:wu},version:6,rewardInfos:t,programId:o},u=this.createTxBuilder(s),l=n??this.scope.ownerPubKey,m=Fe({fromPublicKey:l,programId:c.programId}),d=await this.scope.connection.getMinimumBalanceForRentExemption(er.span);u.addInstruction({instructions:[vd.createAccountWithSeed({fromPubkey:l,basePubkey:l,seed:m.seed,newAccountPubkey:m.publicKey,lamports:d,space:er.span,programId:c.programId})]});let{publicKey:p,nonce:f}=hu({programId:new he(c.programId),poolId:m.publicKey}),y=Ro({programId:c.programId,poolId:m.publicKey,mint:c.lpMint,type:"lpVault"}),b=[],g=[];for(let h of c.rewardInfos){h.openTime>=h.endTime&&this.logAndCreateError("start time error","rewardInfo.rewardOpenTime",h.openTime.toString()),isNaN(In[h.rewardType])&&this.logAndCreateError("rewardType error",h.rewardType),Number(h.perSecond)<=0&&this.logAndCreateError("rewardPerSecond error",h.perSecond),b.push(Tu(h));let{rewardPubKey:I,newInstruction:S}=await this._getUserRewardInfo({rewardInfo:h,payer:l});S&&u.addInstruction(S),I||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let T=h.mint.equals(je)?new he(at.address):h.mint;g.push({rewardMint:T,rewardVault:Ro({programId:c.programId,poolId:m.publicKey,mint:T,type:"rewardVault"}),userRewardToken:I})}let{account:P,instructionParams:w}=await this.scope.account.getOrCreateTokenAccount({mint:new he(c.lockInfo.lockMint),owner:this.scope.ownerPubKey,skipCloseAccount:!1,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:!1});w&&u.addInstruction(w),P||this.logAndCreateError("cannot found lock vault","tokenAccounts",this.scope.account.tokenAccounts);let{instruction:k,instructionType:x}=xu({farmId:m.publicKey,owner:this.scope.ownerPubKey,farmAuthority:p,lpVault:y,lpMint:c.lpMint,lockVault:c.lockInfo.lockVault,lockMint:c.lockInfo.lockMint,lockUserAccount:P,programId:c.programId,rewardInfo:g,rewardInfoConfig:b,nonce:f});return u.addInstruction({instructions:[k],instructionTypes:[x]}).versionBuild({txVersion:i,extInfo:{farmId:m.publicKey,farmAuthority:p,lpVault:y,lockUserAccount:P,nonce:f}})}async restartReward({farmInfo:e,payer:t,newRewardInfo:n,txVersion:o,feePayer:i}){let s=Ct[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=tt((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.openTime>=n.endTime&&this.logAndCreateError("start time error","newRewardInfo",n);let u=t||this.scope.ownerPubKey,l=n.mint.equals(je)?new he(at.address):n.mint,m=c.rewardInfos.findIndex(g=>new he(g.mint.address).equals(l)),d=a.rewardInfos[m];d||this.logAndCreateError("configuration does not exist","rewardMint",l);let p=d.vault??je,f=this.createTxBuilder(i),{rewardPubKey:y,newInstruction:b}=await this._getUserRewardInfo({rewardInfo:n,payer:u});return b&&f.addInstruction(b),y||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts),f.addInstruction({instructions:[Ss({payer:this.scope.ownerPubKey,rewardVault:p,userRewardTokenPub:y,farmKeys:c,rewardInfo:n})],instructionTypes:[E.FarmV6Restart]}).versionBuild({txVersion:o})}async restartRewards({farmInfo:e,payer:t,newRewardInfos:n,txVersion:o,feePayer:i}){let s=Ct[e.programId];s!==6&&this.logAndCreateError("invalid farm version ",s);let a=tt((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c={id:a.id,rewardInfos:e.rewardInfos,lpVault:a.lpVault,programId:a.programId};n.forEach(m=>{m.openTime>=m.endTime&&this.logAndCreateError("start time error","newRewardInfo",m)});let u=t||this.scope.ownerPubKey,l=this.createTxBuilder(i);for(let m of n){let d=m.mint.equals(je)?new he(at.address):m.mint,p=c.rewardInfos.findIndex(w=>new he(w.mint.address).equals(d)),f=a.rewardInfos[p];f||this.logAndCreateError("configuration does not exist","rewardMint",d);let y=f.vault??je,{rewardPubKey:b,newInstruction:g}=await this._getUserRewardInfo({rewardInfo:m,payer:u});g&&l.addInstruction(g),b||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let P=Ss({payer:this.scope.ownerPubKey,rewardVault:y,userRewardTokenPub:b,farmKeys:c,rewardInfo:m});l.addInstruction({instructions:[P],instructionTypes:[E.FarmV6Restart]})}return l.versionBuild({txVersion:o})}async addNewRewardToken(e){let{txVersion:t,farmInfo:n,newRewardInfo:o,payer:i,feePayer:s}=e,a=Ct[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=tt((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=i??this.scope.ownerPubKey,l=this.createTxBuilder(s),m=o.mint.equals(je)?new he(at.address):o.mint,d=Ro({programId:new he(n.programId),poolId:new he(n.id),mint:m,type:"rewardVault"}),{rewardPubKey:p,newInstruction:f}=await this._getUserRewardInfo({rewardInfo:o,payer:u});return f&&l.addInstruction(f),p||this.logAndCreateError("annot found target token accounts",this.scope.account.tokenAccounts),o.mint=m,l.addInstruction({instructions:[Ks({payer:this.scope.ownerPubKey,userRewardTokenPub:p,farmKeys:c,rewardVault:d,rewardInfo:o})],instructionTypes:[E.FarmV6CreatorAddReward]}).versionBuild({txVersion:t})}async addNewRewardsToken(e){let{txVersion:t,farmInfo:n,newRewardInfos:o,payer:i,feePayer:s}=e,a=Ct[n.programId];a!==6&&this.logAndCreateError("invalid farm version ",a);let c=tt((await this.scope.api.fetchFarmKeysById({ids:n.id}))[0]),u=i??this.scope.ownerPubKey,l=this.createTxBuilder(s);for(let m of o){let d=m.mint.equals(je)?new he(at.address):m.mint,p=Ro({programId:new he(n.programId),poolId:new he(n.id),mint:d,type:"rewardVault"}),{rewardPubKey:f,newInstruction:y}=await this._getUserRewardInfo({rewardInfo:m,payer:u});y&&l.addInstruction(y),f||this.logAndCreateError("cannot found target token accounts",this.scope.account.tokenAccounts);let b=Ks({payer:this.scope.ownerPubKey,userRewardTokenPub:f,farmKeys:c,rewardVault:p,rewardInfo:{...m,mint:d}});l.addInstruction({instructions:[b],instructionTypes:[E.FarmV6CreatorAddReward]})}return l.versionBuild({txVersion:t})}async deposit(e){let{txVersion:t,farmInfo:n,amount:o,feePayer:i,useSOLBalance:s,associatedOnly:a=!0,checkCreateATAOwner:c=!1,userAuxiliaryLedgers:u,computeBudgetConfig:l,txTipConfig:m}=e;this.scope.availability.addFarm===!1&&this.logAndCreateError("farm deposit feature disabled in your region");let{rewardInfos:d,programId:p}=n,f=Ct[p];f===4&&this.logAndCreateError("V4 has suspended deposits:",n.programId),Is(f)||this.logAndCreateError("invalid farm program:",n.programId);let[y,b]=[new he(n.programId),new he(n.id)],g=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],P=Lt({programId:y,poolId:b,owner:this.scope.ownerPubKey,version:f}),w=this.createTxBuilder(i);w.addCustomComputeBudget(l),w.addTipInstruction(m);let k={};for(let W of this.scope.account.tokenAccounts)if(a){let D=$(this.scope.ownerPubKey,W.mint,W.programId).publicKey;W.publicKey&&D.equals(W.publicKey)&&(k[W.mint.toString()]=W.publicKey)}else k[W.mint.toString()]=W.publicKey;let x=g.lpMint,h=k[x.address];h||this.logAndCreateError("you don't have any lp","lp zero",k);let I=[];for(let W of d){let D=s&&W.mint.address===H.toString(),U=k[W.mint.address];if(!U){let{account:ee,instructionParams:J}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:W.mint.programId,mint:new he(W.mint.address),notUseTokenAccount:D,createInfo:{payer:i||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!D,associatedOnly:D?!1:a,checkCreateATAOwner:c});U=ee,J&&w.addInstruction(J)}k[W.mint.address]=U,I.push(U)}let S,T=await this.scope.connection.getAccountInfo(P);if(T&&(S=No(f).decode(T.data)),n.programId!==To.toString()&&!S){let{instruction:W,instructionType:D}=vo({id:b,programId:y,version:f,ledger:P,owner:this.scope.ownerPubKey});w.addInstruction({instructions:[W],instructionTypes:[D]})}let K=Bs({version:f,rewardInfos:d,rewardTokenAccountsPublicKeys:I});K&&this.logAndCreateError(K);let R={amount:j(o),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:g,lpAccount:h,rewardAccounts:I,userAuxiliaryLedgers:u?.map(W=>new he(W))},N=f===6?Ru(R):f===5?Lu(R):Cu(R),v={3:E.FarmV3Deposit,5:E.FarmV5Deposit,6:E.FarmV6Deposit};return w.addInstruction({instructions:[N],instructionTypes:[v[f]]}).versionBuild({txVersion:t})}async withdraw(e){let{txVersion:t,farmInfo:n,amount:o,deposited:i,useSOLBalance:s,feePayer:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,userAuxiliaryLedgers:l,computeBudgetConfig:m,txTipConfig:d}=e,{rewardInfos:p}=n;this.scope.availability.removeFarm===!1&&this.logAndCreateError("farm withdraw feature disabled in your region");let f=Ct[n.programId];Is(f)||this.logAndCreateError("invalid farm program:",n.programId);let y=(await this.scope.api.fetchFarmKeysById({ids:n.id}))[0],b=this.createTxBuilder(a);b.addCustomComputeBudget(m),b.addTipInstruction(d);let g={};for(let K of this.scope.account.tokenAccounts)if(c){let R=$(this.scope.ownerPubKey,K.mint).publicKey;K.publicKey&&R.equals(K.publicKey)&&(g[K.mint.toString()]=K.publicKey)}else g[K.mint.toString()]=K.publicKey;if(f!==4){let K=Lt({programId:new he(n.programId),poolId:new he(n.id),owner:this.scope.ownerPubKey,version:f}),R=await this.scope.connection.getAccountInfo(K);if(R)No(f).decode(R.data).deposited.isZero()&&this.logAndCreateError("no deposited lp",{farmId:n.id});else if(f!==6){let{instruction:N,instructionType:v}=vo({id:new he(y.id),programId:new he(y.programId),version:f,ledger:K,owner:this.scope.ownerPubKey});b.addInstruction({instructions:[N],instructionTypes:[v]})}}i&&i.isZero()&&!(l||[]).length&&this.logAndCreateError("no deposited lp",{farmId:n.id});let P=y.lpMint.address,w=s&&P===H.toString(),k=g[P.toString()];if(!k){let{account:K,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:y.lpMint.programId,mint:new he(P),notUseTokenAccount:w,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:w?!1:c,checkCreateATAOwner:u});k=K,R&&b.addInstruction(R)}g[P.toString()]=k;let x=[];for(let K of p){let R=s&&K.mint.address===H.toString(),N=g[K.mint.address];if(!N){let{account:v,instructionParams:W}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:K.mint.programId,mint:new he(K.mint.address),notUseTokenAccount:R,createInfo:{payer:a||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!R,associatedOnly:R?!1:c,checkCreateATAOwner:u});N=v,W&&b.addInstruction(W)}g[K.mint.address]=N,x.push(N)}let h=Bs({version:f,rewardInfos:p,rewardTokenAccountsPublicKeys:x});h&&this.logAndCreateError(h);let I={amount:j(o),owner:this.scope.ownerPubKey,farmInfo:n,farmKeys:y,lpAccount:k,rewardAccounts:x,userAuxiliaryLedgers:l?.map(K=>new he(K))},S=f===6?Mo(I):f===5?_o(I):f===4?Ku(I):Eo(I),T={3:E.FarmV3Withdraw,4:E.FarmV4Withdraw,5:E.FarmV5Withdraw,6:E.FarmV6Withdraw};return b.addInstruction({instructions:[S],instructionTypes:[T[f]]}).versionBuild({txVersion:t})}async withdrawFarmReward({farmInfo:e,withdrawMint:t,txVersion:n,computeBudgetConfig:o,txTipConfig:i,feePayer:s}){this.scope.checkOwner();let a=tt((await this.scope.api.fetchFarmKeysById({ids:e.id}))[0]),c=Ct[e.programId];c!==6&&this.logAndCreateError("invalid farm version",c);let u=a.rewardInfos.find(y=>rt(y.mint.address).equals(rt(t)));u||this.logAndCreateError("withdraw mint error","rewardInfos",e);let l=u?.vault??je,m=this.createTxBuilder(s),d;if(t.equals(je)||t.equals(he.default)){let y=await hn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:xs({...u,openTime:u.openTime,endTime:u.endTime,perSecond:new L(u.perSecond).mul(10**u.mint.decimals).toString()})});d=y.addresses.newAccount,m.addInstruction(y)}else{let y=await this.scope.account.getCreatedTokenAccount({mint:t});y===null?(d=await this.scope.account.getAssociatedTokenAccount(t),m.addInstruction({instructions:[Md(this.scope.ownerPubKey,d,this.scope.ownerPubKey,t)],instructionTypes:[E.CreateATA]})):d=y}let{instruction:p,instructionType:f}=Su({programId:a.programId,id:a.id,authority:a.authority,lpVault:a.lpVault,rewardVault:l,userRewardToken:d,owner:this.scope.ownerPubKey});return m.addCustomComputeBudget(o),m.addTipInstruction(i),m.addInstruction({instructions:[p],instructionTypes:[f]}).versionBuild({txVersion:n})}async harvestAllRewards(e){let{farmInfoList:t,useSOLBalance:n,feePayer:o,associatedOnly:i=!0,checkCreateATAOwner:s=!1,userAuxiliaryLedgers:a,txVersion:c,computeBudgetConfig:u}=e,l=this.createTxBuilder(o),m={};for(let f of this.scope.account.tokenAccounts)if(i){let y=$(this.scope.ownerPubKey,f.mint).publicKey;f.publicKey&&y.equals(f.publicKey)&&(m[f.mint.toString()]=f.publicKey)}else m[f.mint.toString()]=f.publicKey;let p=(await this.scope.api.fetchFarmKeysById({ids:Object.values(t).map(f=>f.id).join(",")})).reduce((f,y)=>({...f,[y.id]:y}),{});for(let f of Object.values(t)){let{programId:y,lpMint:b,rewardInfos:g,id:P}=f,w=Ct[y],k=b.address,x=n&&k===H.toString(),h=m[k];if(!h){let{account:N,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:b.programId,mint:new he(k),notUseTokenAccount:x,createInfo:{payer:o||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!0,associatedOnly:x?!1:i,checkCreateATAOwner:s});h=N,v&&l.addInstruction(v)}m[k.toString()]=h;let I=[];for(let N of g){let v=n&&N.mint.address===H.toString(),W=m[N.mint.address];if(!W){let{account:D,instructionParams:U}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:N.mint.programId,mint:new he(N.mint.address),notUseTokenAccount:v,createInfo:{payer:o||this.scope.ownerPubKey,amount:0},owner:this.scope.ownerPubKey,skipCloseAccount:!v,associatedOnly:v?!1:i,checkCreateATAOwner:s});W=D,U&&l.addInstruction(U)}m[N.mint.address]=W,I.push(W)}let S=p[P],T={amount:At,owner:this.scope.ownerPubKey,farmInfo:f,farmKeys:S,lpAccount:h,rewardAccounts:I,userAuxiliaryLedgers:a?.map(N=>new he(N))},K=w===6?Mo(T):w===5?_o(T):Eo(T),R={3:E.FarmV3Withdraw,5:E.FarmV5Withdraw,6:E.FarmV6Withdraw};l.addInstruction({instructions:[K],instructionTypes:[R[w]]})}return c===1?l.sizeCheckBuild({computeBudgetConfig:u}):l.sizeCheckBuildV0({computeBudgetConfig:u})}};import{PublicKey as De}from"@solana/web3.js";import{AccountLayout as Bp,NATIVE_MINT as pr,TOKEN_PROGRAM_ID as xn}from"@solana/spl-token";import{Keypair as sr,PublicKey as q,SystemProgram as ln,TransactionInstruction as nt}from"@solana/web3.js";import Es from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Ho,TOKEN_2022_PROGRAM_ID as _e,TOKEN_PROGRAM_ID as Te}from"@solana/spl-token";import zd from"bn.js";import Nt from"bn.js";var Oe=new Nt(0),Bt=new Nt(1),an=new Nt(-1),qe=new Nt(1).shln(64),tr=new Nt(1).shln(128),Vo=qe.sub(Bt),Wo=64,Nu=tr.subn(1),ct=-443636,pt=-ct,Ot=new Nt("4295048016"),vt=new Nt("79226673521066979257578248091"),nr=new Nt("4295048017"),or=new Nt("79226673521066979257578248090"),Ou=16,vu="59543866431248",Mu="184467440737095516",_u="15793534762490258745",ir=new Nt(10).pow(new Nt(6));var Eu={tvl:0,volumeQuote:0,mintAmountA:0,mintAmountB:0,rewardDefaultInfos:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,day:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},week:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},month:{volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[0]},pooltype:[]},Tk=new Nt("18446744073700000000");import ce from"bn.js";function rr(r){let e=new ArrayBuffer(4);return new DataView(e).setInt32(0,r,!1),new Uint8Array(e)}function Cs(r,e){let t=0;for(let n=r-1;n>=0&&!e.testn(n);n--)t++;return t}function Ls(r,e){let t=0;for(let n=0;n<r&&!e.testn(n);n++)t++;return t}function Do(r,e){for(let t=0;t<r;t++)if(e.testn(t))return!1;return!0}function Fu(r,e){return Do(r,e)?null:Cs(r,e)}function Vu(r,e){return Do(r,e)?null:Ls(r,e)}var Kk=Buffer.from("amm_config","utf8"),Ed=Buffer.from("pool","utf8"),Fd=Buffer.from("pool_vault","utf8"),Vd=Buffer.from("pool_reward_vault","utf8"),Wu=Buffer.from("position","utf8"),Wd=Buffer.from("tick_array","utf8"),Dd=Buffer.from("operation","utf8"),qd=Buffer.from("pool_tick_array_bitmap_extension","utf8"),Ud=Buffer.from("observation","utf8");function Du(r,e,t,n){return ue([Ed,e.toBuffer(),t.toBuffer(),n.toBuffer()],r)}function Rs(r,e,t){return ue([Fd,e.toBuffer(),t.toBuffer()],r)}function qu(r,e,t){return ue([Vd,e.toBuffer(),t.toBuffer()],r)}function be(r,e,t){return ue([Wd,e.toBuffer(),rr(t)],r)}function Qt(r,e,t,n){return ue([Wu,e.toBuffer(),rr(t),rr(n)],r)}function ft(r,e){return ue([Wu,e.toBuffer()],r)}function un(r){return ue([Buffer.from("metadata","utf8"),Vt.toBuffer(),r.toBuffer()],Vt)}function qo(r){return ue([Dd],r)}function Ve(r,e){return ue([qd,e.toBuffer()],r)}function Uu(r,e){return ue([Ud,e.toBuffer()],r)}var Gu=Buffer.from("locked_position","utf8");function Ns(r,e){return ue([Gu,e.toBuffer()],r)}function Uo(r,e){return ue([Gu,e.toBuffer()],r)}var Gd=Buffer.from("support_mint","utf8");function Os(r,e){return ue([Gd,e.toBuffer()],r)}import{PublicKey as xt}from"@solana/web3.js";import{TOKEN_2022_PROGRAM_ID as Xu}from"@solana/spl-token";import Le from"bn.js";import $t from"bn.js";var Go=class{static getfeeGrowthInside(e,t,n){let o=new $t(0),i=new $t(0);e.tickCurrent>=t.tick?(o=t.feeGrowthOutsideX64A,i=t.feeGrowthOutsideX64B):(o=e.feeGrowthGlobalX64A.sub(t.feeGrowthOutsideX64A),i=e.feeGrowthGlobalX64B.sub(t.feeGrowthOutsideX64B));let s=new $t(0),a=new $t(0);e.tickCurrent<n.tick?(s=n.feeGrowthOutsideX64A,a=n.feeGrowthOutsideX64B):(s=e.feeGrowthGlobalX64A.sub(n.feeGrowthOutsideX64A),a=e.feeGrowthGlobalX64B.sub(n.feeGrowthOutsideX64B));let c=re.wrappingSubU128(re.wrappingSubU128(e.feeGrowthGlobalX64A,o),s),u=re.wrappingSubU128(re.wrappingSubU128(e.feeGrowthGlobalX64B,i),a);return{feeGrowthInsideX64A:c,feeGrowthInsideBX64:u}}static GetPositionFees(e,t,n,o){let{feeGrowthInsideX64A:i,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,o),a=re.mulDivFloor(re.wrappingSubU128(i,t.feeGrowthInsideLastX64A),t.liquidity,qe),c=t.tokenFeesOwedA.add(a),u=re.mulDivFloor(re.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,qe),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionFeesV2(e,t,n,o){let{feeGrowthInsideX64A:i,feeGrowthInsideBX64:s}=this.getfeeGrowthInside(e,n,o),a=re.mulDivFloor(re.wrappingSubU128(i,t.feeGrowthInsideLastX64A),t.liquidity,qe),c=t.tokenFeesOwedA.add(a),u=re.mulDivFloor(re.wrappingSubU128(s,t.feeGrowthInsideLastX64B),t.liquidity,qe),l=t.tokenFeesOwedB.add(u);return{tokenFeeAmountA:c,tokenFeeAmountB:l}}static GetPositionRewardsV2(e,t,n,o){let i=[],s=this.getRewardGrowthInsideV2(e.tickCurrent,n,o,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=re.wrappingSubU128(c,u.growthInsideLastX64),m=re.mulDivFloor(l,t.liquidity,qe),d=u.rewardAmountOwed.add(m);i.push(d)}return i}static GetPositionRewards(e,t,n,o){let i=[],s=this.getRewardGrowthInside(e.tickCurrent,n,o,e.rewardInfos);for(let a=0;a<s.length;a++){let c=s[a],u=t.rewardInfos[a],l=re.wrappingSubU128(c,u.growthInsideLastX64),m=re.mulDivFloor(l,t.liquidity,qe),d=u.rewardAmountOwed.add(m);i.push(d)}return i}static getRewardGrowthInside(e,t,n,o){let i=[];for(let s=0;s<o.length;s++){let a=new $t(0);t.liquidityGross.eqn(0)?a=o[s].rewardGrowthGlobalX64:e<t.tick?a=o[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new $t(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=o[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),i.push(re.wrappingSubU128(re.wrappingSubU128(o[s].rewardGrowthGlobalX64,a),c))}return i}static getRewardGrowthInsideV2(e,t,n,o){let i=[];for(let s=0;s<o.length;s++){let a=new $t(0);t.liquidityGross.eqn(0)?a=o[s].rewardGrowthGlobalX64:e<t.tick?a=o[s].rewardGrowthGlobalX64.sub(t.rewardGrowthsOutsideX64[s]):a=t.rewardGrowthsOutsideX64[s];let c=new $t(0);n.liquidityGross.eqn(0)||(e<n.tick?c=n.rewardGrowthsOutsideX64[s]:c=o[s].rewardGrowthGlobalX64.sub(n.rewardGrowthsOutsideX64[s])),i.push(re.wrappingSubU128(re.wrappingSubU128(o[s].rewardGrowthGlobalX64,a),c))}return i}static getAmountsFromLiquidity({poolInfo:e,ownerPosition:t,liquidity:n,slippage:o,add:i,epochInfo:s}){let a=ie.priceToSqrtPriceX64(new L(e.price),e.mintA.decimals,e.mintB.decimals),c=ie.getSqrtPriceX64FromTick(t.tickLower),u=ie.getSqrtPriceX64FromTick(t.tickUpper),l=i?1+o:1-o,m=ge.getAmountsFromLiquidity(a,c,u,n,i),[d,p]=[ke(m.amountA,e.mintA.extensions?.feeConfig,s,!0),ke(m.amountB,e.mintB.extensions?.feeConfig,s,!0)],[f,y]=[ke(new $t(new L(m.amountA.toString()).mul(l).toFixed(0)),e.mintA.extensions?.feeConfig,s,!0),ke(new $t(new L(m.amountB.toString()).mul(l).toFixed(0)),e.mintB.extensions?.feeConfig,s,!0)];return{liquidity:n,amountA:d,amountB:p,amountSlippageA:f,amountSlippageB:y,expirationTime:Dt(d.expirationTime,p.expirationTime)}}};var Xd=15,ye=class{static async getTickArrays(e,t,n,o,i,s,a){let c=[],u=z.getTickArrayStartIndexByTick(o,i),l=z.getInitializedTickArrayInRange(s,a,i,u,Math.floor(Xd/2));for(let p=0;p<l.length;p++){let{publicKey:f}=be(t,n,l[p]);c.push(f)}let m=(await _t(e,c)).map(p=>p!==null?Xo.decode(p.data):null),d={};for(let p=0;p<c.length;p++){let f=m[p];f!==null&&(d[f.startTickIndex]={...f,address:c[p]})}return d}static nextInitializedTick(e,t,n,o,i,s){let{initializedTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}=this.nextInitializedTickInOneArray(e,t,n,o,i,s);for(;a==null||a.liquidityGross.lten(0);){if(u=z.getNextTickArrayStartIndex(u,i,s),this.checkIsValidStartIndex(u,i))throw new Error("No enough initialized tickArray");let l=n[u];if(l===void 0)continue;let{nextTick:m,tickArrayAddress:d,tickArrayStartTickIndex:p}=this.firstInitializedTickInOneArray(e,t,l,s);[a,c,u]=[m,d,p]}if(a==null)throw new Error("No invaild tickArray cache");return{nextTick:a,tickArrayAddress:c,tickArrayStartTickIndex:u}}static nextInitializedTickArray(e,t,n,o,i){let s=Math.floor(e/ye.tickCount(t)),a=n?z.searchLowBitFromStart(o,i,s-1,1,t):z.searchHightBitFromStart(o,i,s+1,1,t);return a.length>0?{isExist:!0,nextStartIndex:a[0]}:{isExist:!1,nextStartIndex:0}}static firstInitializedTickInOneArray(e,t,n,o){let i;if(o){let a=Qe-1;for(;a>=0;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){i=c;break}a=a-1}}else{let a=0;for(;a<Qe;){let c=n.ticks[a];if(c.liquidityGross.gtn(0)){i=c;break}a=a+1}}let{publicKey:s}=be(e,t,n.startTickIndex);return{nextTick:i,tickArrayAddress:s,tickArrayStartTickIndex:n.startTickIndex}}static nextInitializedTickInOneArray(e,t,n,o,i,s){let a=z.getTickArrayStartIndexByTick(o,i),c=Math.floor((o-a)/i),u=n[a];if(u==null)return{initializedTick:void 0,tickArrayAddress:void 0,tickArrayStartTickIndex:a};let l;if(s)for(;c>=0;){let d=u.ticks[c];if(d.liquidityGross.gtn(0)){l=d;break}c=c-1}else for(c=c+1;c<Qe;){let d=u.ticks[c];if(d.liquidityGross.gtn(0)){l=d;break}c=c+1}let{publicKey:m}=be(e,t,a);return{initializedTick:l,tickArrayAddress:m,tickArrayStartTickIndex:u.startTickIndex}}static getArrayStartIndex(e,t){let n=this.tickCount(t);return Math.floor(e/n)*n}static checkIsValidStartIndex(e,t){if(z.checkIsOutOfBoundary(e)){if(e>pt)return!1;let n=z.getTickArrayStartIndexByTick(ct,t);return e==n}return e%this.tickCount(t)==0}static tickCount(e){return Qe*e}};var vs=14,cn=class{static maxTickInTickarrayBitmap(e){return e*Qe*_n}static getBitmapTickBoundary(e,t){let n=this.maxTickInTickarrayBitmap(t),o=Math.floor(Math.abs(e)/n);e<0&&Math.abs(e)%n!=0&&(o+=1);let i=n*o;return e<0?{minValue:-i,maxValue:-i+n}:{minValue:i,maxValue:i+n}}static nextInitializedTickArrayStartIndex(e,t,n,o){if(!ye.checkIsValidStartIndex(t,n))throw Error("nextInitializedTickArrayStartIndex check error");let i=this.maxTickInTickarrayBitmap(n),s=o?t-ye.tickCount(n):t+ye.tickCount(n);if(s<-i||s>=i)return{isInit:!1,tickIndex:t};let a=n*Qe,c=s/a+512;s<0&&s%a!=0&&c--;let u=Math.abs(c);if(o){let l=e.shln(1024-u-1),m=Fu(1024,l);if(m!==null){let d=(u-m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:-i}}else{let l=e.shrn(u),m=Vu(1024,l);if(m!==null){let d=(u+m-512)*a;return{isInit:!0,tickIndex:d}}else return{isInit:!1,tickIndex:i-ye.tickCount(n)}}}},Qo=class{static getBitmapOffset(e,t){if(!ye.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");this.checkExtensionBoundary(e,t);let n=cn.maxTickInTickarrayBitmap(t),o=Math.floor(Math.abs(e)/n)-1;return e<0&&Math.abs(e)%n===0&&o--,o}static getBitmap(e,t,n){let o=this.getBitmapOffset(e,t);return e<0?{offset:o,tickarrayBitmap:n.negativeTickArrayBitmap[o]}:{offset:o,tickarrayBitmap:n.positiveTickArrayBitmap[o]}}static checkExtensionBoundary(e,t){let{positiveTickBoundary:n,negativeTickBoundary:o}=this.extensionTickBoundary(t);if(e>=o&&e<n)throw Error("checkExtensionBoundary -> InvalidTickArrayBoundary")}static extensionTickBoundary(e){let t=cn.maxTickInTickarrayBitmap(e),n=-t;if(pt<=t)throw Error(`extensionTickBoundary check error: ${pt}, ${t}`);if(n<=ct)throw Error(`extensionTickBoundary check error: ${n}, ${ct}`);return{positiveTickBoundary:t,negativeTickBoundary:n}}static checkTickArrayIsInit(e,t,n){let{tickarrayBitmap:o}=this.getBitmap(e,t,n),i=this.tickArrayOffsetInBitmap(e,t);return{isInitialized:z.mergeTickArrayBitmap(o).testn(i),startIndex:e}}static nextInitializedTickArrayFromOneBitmap(e,t,n,o){let i=ye.tickCount(t),s=n?e-i:e+i,{tickarrayBitmap:a}=this.getBitmap(s,t,o);return this.nextInitializedTickArrayInBitmap(a,s,t,n)}static nextInitializedTickArrayInBitmap(e,t,n,o){let{minValue:i,maxValue:s}=cn.getBitmapTickBoundary(t,n),a=this.tickArrayOffsetInBitmap(t,n);if(o){let c=z.mergeTickArrayBitmap(e).shln(_n-1-a),u=Do(512,c)?null:Cs(512,c);if(u!==null){let l=t-u*ye.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:i}}else{let c=z.mergeTickArrayBitmap(e).shrn(a),u=Do(512,c)?null:Ls(512,c);if(u!==null){let l=t+u*ye.tickCount(n);return{isInit:!0,tickIndex:l}}else return{isInit:!1,tickIndex:s-ye.tickCount(n)}}}static tickArrayOffsetInBitmap(e,t){let n=Math.abs(e)%cn.maxTickInTickarrayBitmap(t),o=Math.floor(n/ye.tickCount(t));return e<0&&n!=0&&(o=_n-o),o}};var Se=class{static getOutputAmountAndRemainAccounts(e,t,n,o,i,s=!1){let a=n.toBase58()===e.mintA.address,c=[],{isExist:u,startIndex:l,nextAccountMeta:m}=this.getFirstInitializedTickArray(e,a);if(!u||l===void 0||!m)throw new Error("Invalid tick array");c.push(m);let{allTrade:d,amountCalculated:p,accounts:f,sqrtPriceX64:y,feeAmount:b}=En.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,a,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,o,l,i,s);return c.push(...f),{allTrade:d,expectedAmountOut:p.mul(an),remainingAccounts:c,executionPrice:y,feeAmount:b}}static getInputAmountAndRemainAccounts(e,t,n,o,i){let s=n.toBase58()===e.mintB.address,a=[],{isExist:c,startIndex:u,nextAccountMeta:l}=this.getFirstInitializedTickArray(e,s);if(!c||u===void 0||!l)throw new Error("Invalid tick array");try{let y=this.preInitializedTickArrayStartIndex(e,s);if(y.isExist){let{publicKey:b}=be(e.programId,e.id,y.nextStartIndex);a.push(b)}}catch{}a.push(l);let{amountCalculated:m,accounts:d,sqrtPriceX64:p,feeAmount:f}=En.swapCompute(e.programId,e.id,t,e.tickArrayBitmap,e.exBitmapInfo,s,e.ammConfig.tradeFeeRate,e.liquidity,e.tickCurrent,e.tickSpacing,e.sqrtPriceX64,o.mul(an),u,i);return a.push(...d),{expectedAmountIn:m,remainingAccounts:a,executionPrice:p,feeAmount:f}}static getFirstInitializedTickArray(e,t){let{isInitialized:n,startIndex:o}=Se.isOverflowDefaultTickarrayBitmap(e.tickSpacing,[e.tickCurrent])?Qo.checkTickArrayIsInit(ye.getArrayStartIndex(e.tickCurrent,e.tickSpacing),e.tickSpacing,e.exBitmapInfo):z.checkTickArrayIsInitialized(z.mergeTickArrayBitmap(e.tickArrayBitmap),e.tickCurrent,e.tickSpacing);if(n){let{publicKey:a}=be(e.programId,e.id,o);return{isExist:!0,startIndex:o,nextAccountMeta:a}}let{isExist:i,nextStartIndex:s}=this.nextInitializedTickArrayStartIndex(e,ye.getArrayStartIndex(e.tickCurrent,e.tickSpacing),t);if(i){let{publicKey:a}=be(e.programId,e.id,s);return{isExist:!0,startIndex:s,nextAccountMeta:a}}return{isExist:!1,nextAccountMeta:void 0,startIndex:void 0}}static preInitializedTickArrayStartIndex(e,t){let n=Math.floor(e.tickCurrent/ye.tickCount(e.tickSpacing)),o=t?z.searchHightBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n+1,1,e.tickSpacing):z.searchLowBitFromStart(e.tickArrayBitmap,e.exBitmapInfo,n-1,1,e.tickSpacing);return o.length>0?{isExist:!0,nextStartIndex:o[0]}:{isExist:!1,nextStartIndex:0}}static nextInitializedTickArrayStartIndex(e,t,n){for(t=ye.getArrayStartIndex(e.tickCurrent,e.tickSpacing);;){let{isInit:o,tickIndex:i}=cn.nextInitializedTickArrayStartIndex(z.mergeTickArrayBitmap(e.tickArrayBitmap),t,e.tickSpacing,n);if(o)return{isExist:!0,nextStartIndex:i};t=i;let{isInit:s,tickIndex:a}=Qo.nextInitializedTickArrayFromOneBitmap(t,e.tickSpacing,n,e.exBitmapInfo);if(s)return{isExist:!0,nextStartIndex:a};if(t=a,t<ct||t>pt)return{isExist:!1,nextStartIndex:0}}}static async updatePoolRewardInfos({connection:e,apiPoolInfo:t,chainTime:n,poolLiquidity:o,rewardInfos:i}){let s=[];for(let a=0;a<i.length;a++){let c=i[a],u=t.rewardDefaultInfos[a]?.mint.programId??(await e.getAccountInfo(c.tokenMint))?.owner;if(u===void 0)throw Error("get new reward mint info error");let l={...c,perSecond:re.x64ToDecimal(c.emissionsPerSecondX64),remainingRewards:void 0,tokenProgramId:new xt(u)};if(l.tokenMint.equals(xt.default))continue;if(n<=l.openTime.toNumber()||o.eq(Oe)){s.push(l);continue}let m=new Le(Math.min(l.endTime.toNumber(),n)),d=m.sub(l.lastUpdateTime),p=re.mulDivFloor(d,l.emissionsPerSecondX64,o),f=l.rewardGrowthGlobalX64.add(p),y=re.mulDivFloor(d,l.emissionsPerSecondX64,qe),b=l.rewardTotalEmissioned.add(y);s.push({...l,rewardGrowthGlobalX64:f,rewardTotalEmissioned:b,lastUpdateTime:m})}return s}static isOverflowDefaultTickarrayBitmap(e,t){let{maxTickBoundary:n,minTickBoundary:o}=this.tickRange(e);for(let i of t){let s=z.getTickArrayStartIndexByTick(i,e);if(s>=n||s<o)return!0}return!1}static tickRange(e){let t=cn.maxTickInTickarrayBitmap(e),n=-t;return t>pt&&(t=ye.getArrayStartIndex(pt,e)+ye.tickCount(e)),n<ct&&(n=ye.getArrayStartIndex(ct,e)),{maxTickBoundary:t,minTickBoundary:n}}static get_tick_array_offset(e,t){if(!ye.checkIsValidStartIndex(e,t))throw new Error("No enough initialized tickArray");return e/ye.tickCount(t)*_n}static async fetchExBitmaps({connection:e,exBitmapAddress:t,batchRequest:n}){let o=await xe(e,t.map(s=>({pubkey:s})),{batchRequest:n}),i={};for(let s of o)s.accountInfo!==null&&(i[s.pubkey.toString()]=zu.decode(s.accountInfo.data));return i}static async fetchMultiplePoolTickArrays({connection:e,poolKeys:t,batchRequest:n}){let o={},i=[];for(let c of t){let u=z.getTickArrayStartIndexByTick(c.tickCurrent,c.tickSpacing),l=z.getInitializedTickArrayInRange(c.tickArrayBitmap,c.exBitmapInfo,c.tickSpacing,u,7);for(let m of l){let{publicKey:d}=be(c.programId,c.id,m);i.push({pubkey:d}),o[d.toString()]=c.id}}let s=await xe(e,i,{batchRequest:n}),a={};for(let c of s){if(!c.accountInfo)continue;let u=o[c.pubkey.toString()];if(!u)continue;a[u.toString()]===void 0&&(a[u.toString()]={});let l=Xo.decode(c.accountInfo.data);a[u.toString()][l.startTickIndex]={...l,address:c.pubkey}}return a}static async fetchPoolsAccountPosition({pools:e,connection:t,ownerInfo:n,batchRequest:o=!1,updateOwnerRewardAndFee:i=!0}){let s=[];for(let a=0;a<e.length;a++){let c=e[a];c!==null&&(s.find(u=>u.equals(c.state.programId))||s.push(c.state.programId))}if(n){let a=n.tokenAccounts.map(m=>m.accountInfo.mint),c=[];for(let m of a)for(let d of s)c.push(ft(d,m).publicKey);let u=await _t(t,c,{batchRequest:o}),l={};for(let m of u){if(m===null)continue;let d=zo.decode(m.data),p=d.poolId.toString(),f=e.find(I=>I.state.id.toBase58()===p);if(f===void 0)continue;let y=f.state,b=z._getTickPriceLegacy({poolInfo:y,tick:d.tickLower,baseIn:!0}),g=z._getTickPriceLegacy({poolInfo:y,tick:d.tickUpper,baseIn:!0}),{amountA:P,amountB:w}=ge.getAmountsFromLiquidity(y.sqrtPriceX64,b.tickSqrtPriceX64,g.tickSqrtPriceX64,d.liquidity,!1),k=1/(1-Math.sqrt(Math.sqrt(b.price.div(g.price).toNumber())));f.positionAccount=[...f.positionAccount??[],{poolId:d.poolId,nftMint:d.nftMint,priceLower:b.price,priceUpper:g.price,amountA:P,amountB:w,tickLower:d.tickLower,tickUpper:d.tickUpper,liquidity:d.liquidity,feeGrowthInsideLastX64A:d.feeGrowthInsideLastX64A,feeGrowthInsideLastX64B:d.feeGrowthInsideLastX64B,tokenFeesOwedA:d.tokenFeesOwedA,tokenFeesOwedB:d.tokenFeesOwedB,rewardInfos:d.rewardInfos.map(I=>({...I,pendingReward:new Le(0)})),leverage:k,tokenFeeAmountA:new Le(0),tokenFeeAmountB:new Le(0)}];let x=await z.getTickArrayAddressByTick(f.state.programId,d.poolId,d.tickLower,f.state.tickSpacing),h=await z.getTickArrayAddressByTick(f.state.programId,d.poolId,d.tickUpper,f.state.tickSpacing);l[`${f.state.programId.toString()}-${d.poolId.toString()}-${d.tickLower}`]=x,l[`${f.state.programId.toString()}-${d.poolId.toString()}-${d.tickUpper}`]=h}if(i){let m=Object.values(l),d=await _t(t,m,{batchRequest:o}),p={};for(let f=0;f<m.length;f++){let y=d[f];if(y===null)continue;let b=m[f].toString();p[b]=Xo.decode(y.data)}for(let{state:f,positionAccount:y}of e)if(!!y)for(let b of y){let g=`${f.programId.toString()}-${f.id.toString()}-${b.tickLower}`,P=`${f.programId.toString()}-${f.id.toString()}-${b.tickUpper}`,w=p[l[g].toString()],k=p[l[P].toString()],x=w.ticks[z.getTickOffsetInArray(b.tickLower,f.tickSpacing)],h=k.ticks[z.getTickOffsetInArray(b.tickUpper,f.tickSpacing)],{tokenFeeAmountA:I,tokenFeeAmountB:S}=await Go.GetPositionFees(f,b,x,h),T=await Go.GetPositionRewards(f,b,x,h);b.tokenFeeAmountA=I.gte(new Le(0))?I:new Le(0),b.tokenFeeAmountB=S.gte(new Le(0))?S:new Le(0);for(let K=0;K<T.length;K++)b.rewardInfos[K].pendingReward=T[K].gte(new Le(0))?T[K]:new Le(0)}}}return e}static computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:o,amountIn:i,slippage:s,priceLimit:a=new L(0),catchLiquidityInsufficient:c=!1}){let u,l=n.toBase58()===e.mintA.address,[m,d]=l?[e.mintA.extensions.feeConfig,e.mintB.extensions.feeConfig]:[e.mintB.extensions.feeConfig,e.mintA.extensions.feeConfig];a.equals(new L(0))?u=l?Ot.add(new Le(1)):vt.sub(new Le(1)):u=ie.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let p=ke(i,m,o,!1),{allTrade:f,expectedAmountOut:y,remainingAccounts:b,executionPrice:g,feeAmount:P}=Se.getOutputAmountAndRemainAccounts(e,t,n,p.amount.sub(p.fee??Oe),u,c),w=ke(y,d,o,!1),k=ie.sqrtPriceX64ToPrice(g,e.mintA.decimals,e.mintB.decimals),x=l?k:new L(1).div(k),h=y.mul(new Le(Math.floor((1-s)*1e10))).div(new Le(1e10)),I=ke(h,d,o,!1),S=l?e.currentPrice:new L(1).div(e.currentPrice),T=new L(x).sub(S).abs(),K=S,R=new Ye(new L(T).mul(10**15).toFixed(0),new L(K).mul(10**15).toFixed(0));return{allTrade:f,realAmountIn:p,amountOut:w,minAmountOut:I,expirationTime:Dt(p.expirationTime,w.expirationTime),currentPrice:e.currentPrice,executionPrice:x,priceImpact:R,fee:P,remainingAccounts:b,executionPriceX64:g}}static computeAmountOutFormat({poolInfo:e,tickArrayCache:t,amountIn:n,tokenOut:o,slippage:i,epochInfo:s,catchLiquidityInsufficient:a=!1}){let c=o.address===e.mintB.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA],[m,d]=[new Ne({...u,mint:u.address,isToken2022:u.programId===Xu.toBase58()}),new Ne({...l,mint:l.address,isToken2022:l.programId===Xu.toBase58()})],{allTrade:p,realAmountIn:f,amountOut:y,minAmountOut:b,expirationTime:g,currentPrice:P,executionPrice:w,priceImpact:k,fee:x,remainingAccounts:h,executionPriceX64:I}=Se.computeAmountOut({poolInfo:e,tickArrayCache:t,baseMint:new xt(u.address),amountIn:n,slippage:i,epochInfo:s,catchLiquidityInsufficient:a}),S={...f,amount:new we(m,f.amount),fee:f.fee===void 0?void 0:new we(m,f.fee)},T={...y,amount:new we(d,y.amount),fee:y.fee===void 0?void 0:new we(d,y.fee)},K={...b,amount:new we(d,b.amount),fee:b.fee===void 0?void 0:new we(d,b.fee)},R=new gt({baseToken:m,denominator:new Le(10).pow(new Le(20+m.decimals)),quoteToken:d,numerator:P.mul(new L(10**(20+d.decimals))).toFixed(0)}),N=new gt({baseToken:m,denominator:new Le(10).pow(new Le(20+m.decimals)),quoteToken:d,numerator:w.mul(new L(10**(20+d.decimals))).toFixed(0)}),v=new we(m,x);return{allTrade:p,realAmountIn:S,amountOut:T,minAmountOut:K,expirationTime:g,currentPrice:R,executionPrice:N,priceImpact:k,fee:v,remainingAccounts:h,executionPriceX64:I}}static computeAmountIn({poolInfo:e,tickArrayCache:t,baseMint:n,epochInfo:o,amountOut:i,slippage:s,priceLimit:a=new L(0)}){let c=n.toBase58()===e.mintA.address,u={[e.mintA.address]:e.mintA.extensions.feeConfig,[e.mintB.address]:e.mintB.extensions.feeConfig},l;a.equals(new L(0))?l=c?vt.sub(new Le(1)):Ot.add(new Le(1)):l=ie.priceToSqrtPriceX64(a,e.mintA.decimals,e.mintB.decimals);let m=ke(i,u[n.toString()],o,!0),{expectedAmountIn:d,remainingAccounts:p,executionPrice:f,feeAmount:y}=Se.getInputAmountAndRemainAccounts(e,t,n,m.amount.sub(m.fee??Oe),l),b=c?e.mintB.address:e.mintA.address,g=ke(d,u[b],o,!1),P=ie.sqrtPriceX64ToPrice(f,e.mintA.decimals,e.mintB.decimals),w=c?P:new L(1).div(P),k=d.mul(new Le(Math.floor((1+s)*1e10))).div(new Le(1e10)),x=ke(k,u[b],o,!0),h=c?e.currentPrice:new L(1).div(e.currentPrice),I=new L(w).sub(h).abs(),S=h,T=new Ye(new L(I).mul(10**15).toFixed(0),new L(S).mul(10**15).toFixed(0));return{amountIn:g,maxAmountIn:x,realAmountOut:m,expirationTime:Dt(g.expirationTime,m.expirationTime),currentPrice:e.currentPrice,executionPrice:w,priceImpact:T,fee:y,remainingAccounts:p}}static estimateAprsForPriceRangeMultiplier({poolInfo:e,aprType:t,positionTickLowerIndex:n,positionTickUpperIndex:o}){let i=e[t],s=z.getTickPrice({poolInfo:e,tick:n,baseIn:!0}).price.toNumber(),a=z.getTickPrice({poolInfo:e,tick:o,baseIn:!0}).price.toNumber(),c=Math.max(s,i.priceMin),l=Math.min(a,i.priceMax)-c,m=a-s,d=i.priceMax-i.priceMin,p;return l<=0?p=0:m===l?p=d/l:d===l?p=l/m:p=l/d*(l/m),{feeApr:i.feeApr*p,rewardsApr:[(i.rewardApr[0]??0)*p,(i.rewardApr[1]??0)*p,(i.rewardApr[2]??0)*p],apr:i.apr*p}}static estimateAprsForPriceRangeDelta({poolInfo:e,poolLiquidity:t,aprType:n,mintPrice:o,liquidity:i,positionTickLowerIndex:s,positionTickUpperIndex:a,chainTime:c}){let u=n==="day"?1:n==="week"?7:n==="month"?30:0,l=e[n],m=o[rt(e.mintA.address).toString()],d=o[rt(e.mintB.address).toString()],p=e.mintA.decimals,f=e.mintB.decimals;if(!l||!m||!d)return{feeApr:0,rewardsApr:[0,0,0],apr:0};let y=ie.priceToSqrtPriceX64(new L(e.price),e.mintA.decimals,e.mintB.decimals),b=ie.getSqrtPriceX64FromTick(s),g=ie.getSqrtPriceX64FromTick(a),{amountSlippageA:P,amountSlippageB:w}=ge.getAmountsFromLiquidityWithSlippage(y,b,g,t,!1,!1,0),{amountSlippageA:k,amountSlippageB:x}=ge.getAmountsFromLiquidityWithSlippage(y,b,g,i,!1,!1,0),h=new L(P.toString()).div(new L(10).pow(p)).mul(m.value).add(new L(w.toString()).div(new L(10).pow(f)).mul(d.value)),I=new L(k.toString()).div(new L(10).pow(p)).mul(m.value).add(new L(x.toString()).div(new L(10).pow(f)).mul(d.value)),S=new L(1).div(h.add(I)),K=new L(l.volumeFee).mul(365).div(u).mul(S).mul(100).toNumber(),R=3600*24*365,N=e.rewardDefaultInfos.map(v=>{let W=v.mint.decimals,D=o[v.mint.address];return c<(v.startTime??0)||c>(v.endTime??0)||!v.perSecond||!D||W===void 0?0:new L(D.value).mul(new L(v.perSecond).mul(R)).div(new L(10).pow(W)).mul(S).mul(100).toNumber()});return{feeApr:K,rewardsApr:N,apr:K+N.reduce((v,W)=>v+W,0)}}static async getLiquidityAmountOutFromAmountIn({poolInfo:e,inputA:t,tickLower:n,tickUpper:o,amount:i,slippage:s,add:a,epochInfo:c,amountHasFee:u}){let l=ie.priceToSqrtPriceX64(new L(e.price),e.mintA.decimals,e.mintB.decimals),m=ie.getSqrtPriceX64FromTick(n),d=ie.getSqrtPriceX64FromTick(o),p=ke(i,e[t?"mintA":"mintB"].extensions?.feeConfig,c,!u),f=new Le(new L(p.amount.sub(p.fee??Oe).toString()).toFixed(0)),y;if(l.lte(m))y=t?ge.getLiquidityFromTokenAmountA(m,d,f,!a):new Le(0);else if(l.lte(d)){let g=ge.getLiquidityFromTokenAmountA(l,d,f,!a),P=ge.getLiquidityFromTokenAmountB(m,l,f);y=t?g:P}else y=t?new Le(0):ge.getLiquidityFromTokenAmountB(m,d,f);let b=await Se.getAmountsFromLiquidity({epochInfo:c,poolInfo:e,tickLower:n,tickUpper:o,liquidity:y,slippage:s,add:a});return{liquidity:y,amountA:t?p:b.amountA,amountB:t?b.amountB:p,amountSlippageA:t?p:b.amountSlippageA,amountSlippageB:t?b.amountSlippageB:p,expirationTime:b.expirationTime}}static async getAmountsFromLiquidity({epochInfo:e,poolInfo:t,tickLower:n,tickUpper:o,liquidity:i,slippage:s,add:a}){let c=ie.getSqrtPriceX64FromTick(n),u=ie.getSqrtPriceX64FromTick(o),l=a?1+s:1-s,m=ge.getAmountsFromLiquidity(ie.priceToSqrtPriceX64(new L(t.price),t.mintA.decimals,t.mintB.decimals),c,u,i,a),[d,p]=[ke(m.amountA,t.mintA.extensions?.feeConfig,e,!0),ke(m.amountB,t.mintB.extensions?.feeConfig,e,!0)],[f,y]=[ke(m.amountA.muln(l),t.mintA.extensions?.feeConfig,e,!0),ke(m.amountB.muln(l),t.mintB.extensions?.feeConfig,e,!0)];return{liquidity:i,amountA:d,amountB:p,amountSlippageA:f,amountSlippageB:y,expirationTime:Dt(d.expirationTime,p.expirationTime)}}static async fetchComputeMultipleClmmInfo({connection:e,poolList:t,rpcDataMap:n={}}){let o=t.filter(c=>!n[c.id]).map(c=>new xt(c.id));(await _t(e,o)).forEach((c,u)=>{!c||(n[o[u].toBase58()]=Fn.decode(c.data))});let s=t.map(c=>Ve(new xt(c.programId),new xt(c.id)).publicKey),a=await Se.fetchExBitmaps({connection:e,exBitmapAddress:s,batchRequest:!1});return t.reduce((c,u)=>({...c,[u.id]:{...n[u.id],id:new xt(u.id),version:6,programId:new xt(u.programId),mintA:u.mintA,mintB:u.mintB,ammConfig:{...u.config,id:new xt(u.config.id),fundOwner:""},currentPrice:new L(u.price),exBitmapAccount:Ve(new xt(u.programId),new xt(u.id)).publicKey,exBitmapInfo:a[Ve(new xt(u.programId),new xt(u.id)).publicKey.toBase58()],startTime:n[u.id].startTime.toNumber(),rewardInfos:n[u.id].rewardInfos}}),{})}static async fetchComputeClmmInfo({connection:e,poolInfo:t,rpcData:n}){return(await this.fetchComputeMultipleClmmInfo({connection:e,rpcDataMap:n?{[t.id]:n}:void 0,poolList:[t]}))[t.id]}};var Ms={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};function Qu(r){return{...r,type:"Concentrated",programId:r.programId.toString(),id:r.id.toString(),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Clmm",price:r.currentPrice.toNumber(),mintAmountA:0,mintAmountB:0,feeRate:r.ammConfig.tradeFeeRate,openTime:r.startTime.toString(),tvl:0,day:Ms,week:Ms,month:Ms,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,burnPercent:0,config:{...r.ammConfig,id:r.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]}}}var re=class{static mulDivRoundingUp(e,t,n){let o=e.mul(t),i=o.div(n);return o.mod(n).eq(Oe)||(i=i.add(Bt)),i}static mulDivFloor(e,t,n){if(n.eq(Oe))throw new Error("division by 0");return e.mul(t).div(n)}static mulDivCeil(e,t,n){if(n.eq(Oe))throw new Error("division by 0");return e.mul(t).add(n.sub(Bt)).div(n)}static x64ToDecimal(e,t){return new L(e.toString()).div(L.pow(2,64)).toDecimalPlaces(t)}static decimalToX64(e){return new ce(e.mul(L.pow(2,64)).floor().toFixed())}static wrappingSubU128(e,t){return e.add(tr).sub(t).mod(tr)}};function $e(r,e){return _s(r.mul(e),64,256)}function Qd(r,e,t){let n=r.toTwos(t).shln(e);return n.imaskn(t+1),n.fromTwos(t)}function _s(r,e,t){let n=r.toTwos(t).shrn(e);return n.imaskn(t-e+1),n.fromTwos(t-e)}var ie=class{static sqrtPriceX64ToPrice(e,t,n){return re.x64ToDecimal(e).pow(2).mul(L.pow(10,t-n))}static priceToSqrtPriceX64(e,t,n){return re.decimalToX64(e.mul(L.pow(10,n-t)).sqrt())}static getNextSqrtPriceX64FromInput(e,t,n,o){if(!e.gt(Oe))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(Oe))throw new Error("liquidity must greater than 0");return o?this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!0):this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!0)}static getNextSqrtPriceX64FromOutput(e,t,n,o){if(!e.gt(Oe))throw new Error("sqrtPriceX64 must greater than 0");if(!t.gt(Oe))throw new Error("liquidity must greater than 0");return o?this.getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,!1):this.getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,!1)}static getNextSqrtPriceFromTokenAmountARoundingUp(e,t,n,o){if(n.eq(Oe))return e;let i=t.shln(Wo);if(o){let s=i,a=i.add(n.mul(e));return a.gte(s)?re.mulDivCeil(s,e,a):re.mulDivRoundingUp(s,Bt,s.div(e).add(n))}else{let s=n.mul(e);if(!i.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountARoundingUp,liquidityLeftShift must gt amountMulSqrtPrice");let a=i.sub(s);return re.mulDivCeil(i,e,a)}}static getNextSqrtPriceFromTokenAmountBRoundingDown(e,t,n,o){let i=n.shln(Wo);if(o)return e.add(i.div(t));{let s=re.mulDivRoundingUp(i,Bt,t);if(!e.gt(s))throw new Error("getNextSqrtPriceFromTokenAmountBRoundingDown sqrtPriceX64 must gt amountDivLiquidity");return e.sub(s)}}static getSqrtPriceX64FromTick(e){if(!Number.isInteger(e))throw new Error("tick must be integer");if(e<ct||e>pt)throw new Error("tick must be in MIN_TICK and MAX_TICK");let t=e<0?e*-1:e,n=(t&1)!=0?new ce("18445821805675395072"):new ce("18446744073709551616");return(t&2)!=0&&(n=$e(n,new ce("18444899583751176192"))),(t&4)!=0&&(n=$e(n,new ce("18443055278223355904"))),(t&8)!=0&&(n=$e(n,new ce("18439367220385607680"))),(t&16)!=0&&(n=$e(n,new ce("18431993317065453568"))),(t&32)!=0&&(n=$e(n,new ce("18417254355718170624"))),(t&64)!=0&&(n=$e(n,new ce("18387811781193609216"))),(t&128)!=0&&(n=$e(n,new ce("18329067761203558400"))),(t&256)!=0&&(n=$e(n,new ce("18212142134806163456"))),(t&512)!=0&&(n=$e(n,new ce("17980523815641700352"))),(t&1024)!=0&&(n=$e(n,new ce("17526086738831433728"))),(t&2048)!=0&&(n=$e(n,new ce("16651378430235570176"))),(t&4096)!=0&&(n=$e(n,new ce("15030750278694412288"))),(t&8192)!=0&&(n=$e(n,new ce("12247334978884435968"))),(t&16384)!=0&&(n=$e(n,new ce("8131365268886854656"))),(t&32768)!=0&&(n=$e(n,new ce("3584323654725218816"))),(t&65536)!=0&&(n=$e(n,new ce("696457651848324352"))),(t&131072)!=0&&(n=$e(n,new ce("26294789957507116"))),(t&262144)!=0&&(n=$e(n,new ce("37481735321082"))),e>0&&(n=Nu.div(n)),n}static getTickFromPrice(e,t,n){return ie.getTickFromSqrtPriceX64(ie.priceToSqrtPriceX64(e,t,n))}static getTickFromSqrtPriceX64(e){if(e.gt(vt)||e.lt(Ot))throw new Error("Provided sqrtPrice is not within the supported sqrtPrice range.");let t=e.bitLength()-1,n=new ce(t-64),o=Qd(n,32,128),i=new ce("8000000000000000","hex"),s=0,a=new ce(0),c=t>=64?e.shrn(t-63):e.shln(63-t);for(;i.gt(new ce(0))&&s<Ou;){c=c.mul(c);let f=c.shrn(127);c=c.shrn(63+f.toNumber()),a=a.add(i.mul(f)),i=i.shrn(1),s+=1}let u=a.shrn(32),m=o.add(u).mul(new ce(vu)),d=_s(m.sub(new ce(Mu)),64,128).toNumber(),p=_s(m.add(new ce(_u)),64,128).toNumber();return d==p?d:ie.getSqrtPriceX64FromTick(p).lte(e)?p:d}},Vn=class{static getTickWithPriceAndTickspacing(e,t,n,o){let s=ie.getTickFromSqrtPriceX64(ie.priceToSqrtPriceX64(e,n,o))/t;return s<0?s=Math.floor(s):s=Math.ceil(s),s*t}static roundPriceWithTickspacing(e,t,n,o){let i=Vn.getTickWithPriceAndTickspacing(e,t,n,o),s=ie.getSqrtPriceX64FromTick(i);return ie.sqrtPriceX64ToPrice(s,n,o)}},ge=class{static addDelta(e,t){return e.add(t)}static getTokenAmountAFromLiquidity(e,t,n,o){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(Oe))throw new Error("sqrtPriceX64A must greater than 0");let i=n.ushln(Wo),s=t.sub(e);return o?re.mulDivRoundingUp(re.mulDivCeil(i,s,t),Bt,e):re.mulDivFloor(i,s,t).div(e)}static getTokenAmountBFromLiquidity(e,t,n,o){if(e.gt(t)&&([e,t]=[t,e]),!e.gt(Oe))throw new Error("sqrtPriceX64A must greater than 0");return o?re.mulDivCeil(n,t.sub(e),qe):re.mulDivFloor(n,t.sub(e),qe)}static getLiquidityFromTokenAmountA(e,t,n,o){e.gt(t)&&([e,t]=[t,e]);let i=n.mul(e).mul(t),s=t.sub(e),a=i.div(s);return o?re.mulDivRoundingUp(a,Bt,Vo):a.shrn(Wo)}static getLiquidityFromTokenAmountB(e,t,n){return e.gt(t)&&([e,t]=[t,e]),re.mulDivFloor(n,Vo,t.sub(e))}static getLiquidityFromTokenAmounts(e,t,n,o,i){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return ge.getLiquidityFromTokenAmountA(t,n,o,!1);if(e.lt(n)){let s=ge.getLiquidityFromTokenAmountA(e,n,o,!1),a=ge.getLiquidityFromTokenAmountB(t,e,i);return s.lt(a)?s:a}else return ge.getLiquidityFromTokenAmountB(t,n,i)}static getAmountsFromLiquidity(e,t,n,o,i){if(t.gt(n)&&([t,n]=[n,t]),e.lte(t))return{amountA:ge.getTokenAmountAFromLiquidity(t,n,o,i),amountB:new ce(0)};if(e.lt(n)){let s=ge.getTokenAmountAFromLiquidity(e,n,o,i),a=ge.getTokenAmountBFromLiquidity(t,e,o,i);return{amountA:s,amountB:a}}else return{amountA:new ce(0),amountB:ge.getTokenAmountBFromLiquidity(t,n,o,i)}}static getAmountsFromLiquidityWithSlippage(e,t,n,o,i,s,a){let{amountA:c,amountB:u}=ge.getAmountsFromLiquidity(e,t,n,o,s),l=i?1+a:1-a,m=new ce(new L(c.toString()).mul(l).toFixed(0)),d=new ce(new L(u.toString()).mul(l).toFixed(0));return{amountSlippageA:m,amountSlippageB:d}}static getAmountsOutFromLiquidity({poolInfo:e,tickLower:t,tickUpper:n,liquidity:o,slippage:i,add:s,epochInfo:a,amountAddFee:c}){let u=ie.priceToSqrtPriceX64(new L(e.price),e.mintA.decimals,e.mintB.decimals),l=ie.getSqrtPriceX64FromTick(t),m=ie.getSqrtPriceX64FromTick(n),d=s?1+i:1-i,p=ge.getAmountsFromLiquidity(u,l,m,o,s),[f,y]=[ke(p.amountA,e.mintA.extensions?.feeConfig,a,c),ke(p.amountB,e.mintB.extensions?.feeConfig,a,c)],[b,g]=[ke(new ce(new L(p.amountA.toString()).mul(d).toFixed(0)),e.mintA.extensions?.feeConfig,a,c),ke(new ce(new L(p.amountB.toString()).mul(d).toFixed(0)),e.mintB.extensions?.feeConfig,a,c)];return{liquidity:o,amountA:f,amountB:y,amountSlippageA:b,amountSlippageB:g,expirationTime:Dt(f.expirationTime,y.expirationTime)}}},En=class{static swapCompute(e,t,n,o,i,s,a,c,u,l,m,d,p,f,y=!1){if(d.eq(Oe))throw new Error("amountSpecified must not be 0");if(f||(f=s?Ot.add(Bt):vt.sub(Bt)),s){if(f.lt(Ot))throw new Error("sqrtPriceX64 must greater than MIN_SQRT_PRICE_X64");if(f.gte(m))throw new Error("sqrtPriceX64 must smaller than current")}else{if(f.gt(vt))throw new Error("sqrtPriceX64 must smaller than MAX_SQRT_PRICE_X64");if(f.lte(m))throw new Error("sqrtPriceX64 must greater than current")}let b=d.gt(Oe),g={amountSpecifiedRemaining:d,amountCalculated:Oe,sqrtPriceX64:m,tick:u>p?Math.min(p+ye.tickCount(l)-1,u):p,accounts:[],liquidity:c,feeAmount:new ce(0)},P=p,w=n[p],k=0,x=!s&&w.startTickIndex===g.tick;for(;!g.amountSpecifiedRemaining.eq(Oe)&&!g.sqrtPriceX64.eq(f);){k>10;let h={};h.sqrtPriceStartX64=g.sqrtPriceX64;let I=z.nextInitTick(w,g.tick,l,s,x),S=I||null,T=null;if(!S?.liquidityGross.gtn(0)){let R=Se.nextInitializedTickArrayStartIndex({tickCurrent:g.tick,tickSpacing:l,tickArrayBitmap:o,exBitmapInfo:i},P,s);if(!R.isExist){if(y)return{allTrade:!1,amountSpecifiedRemaining:g.amountSpecifiedRemaining,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts};throw Error("swapCompute LiquidityInsufficient")}P=R.nextStartIndex;let{publicKey:N}=be(e,t,P);T=N,w=n[P];try{S=z.firstInitializedTick(w,s)}catch{throw Error("not found next tick info")}}h.tickNext=S.tick,h.initialized=S.liquidityGross.gtn(0),p!==P&&T&&(g.accounts.push(T),p=P),h.tickNext<ct?h.tickNext=ct:h.tickNext>pt&&(h.tickNext=pt),h.sqrtPriceNextX64=ie.getSqrtPriceX64FromTick(h.tickNext);let K;if(s&&h.sqrtPriceNextX64.lt(f)||!s&&h.sqrtPriceNextX64.gt(f)?K=f:K=h.sqrtPriceNextX64,[g.sqrtPriceX64,h.amountIn,h.amountOut,h.feeAmount]=En.swapStepCompute(g.sqrtPriceX64,K,g.liquidity,g.amountSpecifiedRemaining,a,s),g.feeAmount=g.feeAmount.add(h.feeAmount),b?(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.sub(h.amountIn.add(h.feeAmount)),g.amountCalculated=g.amountCalculated.sub(h.amountOut)):(g.amountSpecifiedRemaining=g.amountSpecifiedRemaining.add(h.amountOut),g.amountCalculated=g.amountCalculated.add(h.amountIn.add(h.feeAmount))),g.sqrtPriceX64.eq(h.sqrtPriceNextX64)){if(h.initialized){let R=S.liquidityNet;s&&(R=R.mul(an)),g.liquidity=ge.addDelta(g.liquidity,R)}x=h.tickNext!=g.tick&&!s&&w.startTickIndex===h.tickNext,g.tick=s?h.tickNext-1:h.tickNext}else if(g.sqrtPriceX64!=h.sqrtPriceStartX64){let R=ie.getTickFromSqrtPriceX64(g.sqrtPriceX64);x=R!=g.tick&&!s&&w.startTickIndex===R,g.tick=R}++k}try{let{nextStartIndex:h,isExist:I}=ye.nextInitializedTickArray(g.tick,l,s,o,i);I&&p!==h&&(g.accounts.push(be(e,t,h).publicKey),p=h)}catch{}return{allTrade:!0,amountSpecifiedRemaining:Oe,amountCalculated:g.amountCalculated,feeAmount:g.feeAmount,sqrtPriceX64:g.sqrtPriceX64,liquidity:g.liquidity,tickCurrent:g.tick,accounts:g.accounts}}static swapStepCompute(e,t,n,o,i,s){let a={sqrtPriceX64Next:new ce(0),amountIn:new ce(0),amountOut:new ce(0),feeAmount:new ce(0)},c=o.gte(Oe);if(c){let l=re.mulDivFloor(o,ir.sub(new ce(i.toString())),ir);a.amountIn=s?ge.getTokenAmountAFromLiquidity(t,e,n,!0):ge.getTokenAmountBFromLiquidity(e,t,n,!0),l.gte(a.amountIn)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=ie.getNextSqrtPriceX64FromInput(e,n,l,s)}else a.amountOut=s?ge.getTokenAmountBFromLiquidity(t,e,n,!1):ge.getTokenAmountAFromLiquidity(e,t,n,!1),o.mul(an).gte(a.amountOut)?a.sqrtPriceX64Next=t:a.sqrtPriceX64Next=ie.getNextSqrtPriceX64FromOutput(e,n,o.mul(an),s);let u=t.eq(a.sqrtPriceX64Next);return s?(u&&c||(a.amountIn=ge.getTokenAmountAFromLiquidity(a.sqrtPriceX64Next,e,n,!0)),u&&!c||(a.amountOut=ge.getTokenAmountBFromLiquidity(a.sqrtPriceX64Next,e,n,!1))):(a.amountIn=u&&c?a.amountIn:ge.getTokenAmountBFromLiquidity(e,a.sqrtPriceX64Next,n,!0),a.amountOut=u&&!c?a.amountOut:ge.getTokenAmountAFromLiquidity(e,a.sqrtPriceX64Next,n,!1)),!c&&a.amountOut.gt(o.mul(an))&&(a.amountOut=o.mul(an)),c&&!a.sqrtPriceX64Next.eq(t)?a.feeAmount=o.sub(a.amountIn):a.feeAmount=re.mulDivCeil(a.amountIn,new ce(i),ir.sub(new ce(i))),[a.sqrtPriceX64Next,a.amountIn,a.amountOut,a.feeAmount]}};var Qe=60,_n=512,z=class{static getTickArrayAddressByTick(e,t,n,o){let i=z.getTickArrayStartIndexByTick(n,o),{publicKey:s}=be(e,t,i);return s}static getTickOffsetInArray(e,t){if(e%t!=0)throw new Error("tickIndex % tickSpacing not equal 0");let n=z.getTickArrayStartIndexByTick(e,t),o=Math.floor((e-n)/t);if(o<0||o>=Qe)throw new Error("tick offset in array overflow");return o}static getTickArrayBitIndex(e,t){let n=ye.tickCount(t),o=e/n;return e<0&&e%n!=0?o=Math.ceil(o)-1:o=Math.floor(o),o}static getTickArrayStartIndexByTick(e,t){return this.getTickArrayBitIndex(e,t)*ye.tickCount(t)}static getTickArrayOffsetInBitmapByTick(e,t){let n=t*Qe,o=Math.floor(e/n)+512;return Math.abs(o)}static checkTickArrayIsInitialized(e,t,n){let o=n*Qe,i=Math.floor(t/o)+512,s=Math.abs(i);return{isInitialized:e.testn(s),startIndex:(s-512)*o}}static getNextTickArrayStartIndex(e,t,n){return n?e-t*Qe:e+t*Qe}static mergeTickArrayBitmap(e){let t=new zd(0);for(let n=0;n<e.length;n++)t=t.add(e[n].shln(64*n));return t}static getInitializedTickArrayInRange(e,t,n,o,i){let s=Math.floor(o/(n*Qe));return[...z.searchLowBitFromStart(e,t,s-1,i,n),...z.searchHightBitFromStart(e,t,s,i,n)]}static getAllInitializedTickArrayStartIndex(e,t,n){return z.searchHightBitFromStart(e,t,-7680,_n,n)}static getAllInitializedTickArrayInfo(e,t,n,o,i){let s=[],a=z.getAllInitializedTickArrayStartIndex(n,o,i);for(let c of a){let{publicKey:u}=be(e,t,c);s.push({tickArrayStartIndex:c,tickArrayAddress:u})}return s}static getAllInitializedTickInTickArray(e){return e.ticks.filter(t=>t.liquidityGross.gtn(0))}static searchLowBitFromStart(e,t,n,o,i){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>z.mergeTickArrayBitmap(u)),a=[];for(;n>=-7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n--,a.length===o)break}let c=ye.tickCount(i);return a.map(u=>u*c)}static searchHightBitFromStart(e,t,n,o,i){let s=[...[...t.negativeTickArrayBitmap].reverse(),e.slice(0,8),e.slice(8,16),...t.positiveTickArrayBitmap].map(u=>z.mergeTickArrayBitmap(u)),a=[];for(;n<7680;){let u=Math.floor((n+7680)/512),l=(n+7680)%512;if(s[u].testn(l)&&a.push(n),n++,a.length===o)break}let c=ye.tickCount(i);return a.map(u=>u*c)}static checkIsOutOfBoundary(e){return e<ct||e>pt}static nextInitTick(e,t,n,o,i){if(ye.getArrayStartIndex(t,n)!=e.startTickIndex)return null;let a=Math.floor((t-e.startTickIndex)/n);if(o)for(;a>=0;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a-1}else for(i||(a=a+1);a<Qe;){if(e.ticks[a].liquidityGross.gtn(0))return e.ticks[a];a=a+1}return null}static firstInitializedTick(e,t){if(t){let n=Qe-1;for(;n>=0;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n-1}}else{let n=0;for(;n<Qe;){if(e.ticks[n].liquidityGross.gtn(0))return e.ticks[n];n=n+1}}throw Error(`firstInitializedTick check error: ${e} - ${t}`)}static _getTickPriceLegacy({poolInfo:e,tick:t,baseIn:n}){let o=ie.getSqrtPriceX64FromTick(t),i=ie.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:i,tickSqrtPriceX64:o}:{tick:t,price:new L(1).div(i),tickSqrtPriceX64:o}}static _getPriceAndTickLegacy({poolInfo:e,price:t,baseIn:n}){let o=n?t:new L(1).div(t),i=Vn.getTickWithPriceAndTickspacing(o,e.ammConfig.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=ie.getSqrtPriceX64FromTick(i),a=ie.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:i,price:a}:{tick:i,price:new L(1).div(a)}}static getTickPrice({poolInfo:e,tick:t,baseIn:n}){let o=ie.getSqrtPriceX64FromTick(t),i=ie.sqrtPriceX64ToPrice(o,e.mintA.decimals,e.mintB.decimals);return n?{tick:t,price:i,tickSqrtPriceX64:o}:{tick:t,price:new L(1).div(i),tickSqrtPriceX64:o}}static getPriceAndTick({poolInfo:e,price:t,baseIn:n}){let o=n?t:new L(1).div(t),i=Vn.getTickWithPriceAndTickspacing(o,e.config.tickSpacing,e.mintA.decimals,e.mintB.decimals),s=ie.getSqrtPriceX64FromTick(i),a=ie.sqrtPriceX64ToPrice(s,e.mintA.decimals,e.mintB.decimals);return n?{tick:i,price:a}:{tick:i,price:new L(1).div(a)}}};var Hu=O([Pe(8),V("bump"),Gt("index"),C(""),ut("protocolFeeRate"),ut("tradeFeeRate"),Gt("tickSpacing"),X(A(),8,"")]),Hd=O([ut("blockTimestamp"),io("tickCumulative"),X(A(),4)]),ju=O([Pe(8),Me("initialized"),A("recentEpoch"),Gt("observationIndex"),C("poolId"),X(Hd,100,"observations"),X(A(),4)]),jd=O([V("rewardState"),A("openTime"),A("endTime"),A("lastUpdateTime"),Z("emissionsPerSecondX64"),A("rewardTotalEmissioned"),A("rewardClaimed"),C("tokenMint"),C("tokenVault"),C("creator"),Z("rewardGrowthGlobalX64")]),Fn=O([Pe(8),V("bump"),C("ammConfig"),C("creator"),C("mintA"),C("mintB"),C("vaultA"),C("vaultB"),C("observationId"),V("mintDecimalsA"),V("mintDecimalsB"),Gt("tickSpacing"),Z("liquidity"),Z("sqrtPriceX64"),Ce("tickCurrent"),ut(),Z("feeGrowthGlobalX64A"),Z("feeGrowthGlobalX64B"),A("protocolFeesTokenA"),A("protocolFeesTokenB"),Z("swapInAmountTokenA"),Z("swapOutAmountTokenB"),Z("swapInAmountTokenB"),Z("swapOutAmountTokenA"),V("status"),X(V(),7,""),X(jd,3,"rewardInfos"),X(A(),16,"tickArrayBitmap"),A("totalFeesTokenA"),A("totalFeesClaimedTokenA"),A("totalFeesTokenB"),A("totalFeesClaimedTokenB"),A("fundFeesTokenA"),A("fundFeesTokenB"),A("startTime"),X(A(),15*4-3,"padding")]),Yd=O([Z("growthInsideLastX64"),A("rewardAmountOwed")]),zo=O([Pe(8),V("bump"),C("nftMint"),C("poolId"),Ce("tickLower"),Ce("tickUpper"),Z("liquidity"),Z("feeGrowthInsideLastX64A"),Z("feeGrowthInsideLastX64B"),A("tokenFeesOwedA"),A("tokenFeesOwedB"),X(Yd,3,"rewardInfos"),X(A(),8,"")]),_h=O([Pe(8),V("bump"),C("poolId"),Ce("tickLowerIndex"),Ce("tickUpperIndex"),Z("liquidity"),Z("feeGrowthInsideLastX64A"),Z("feeGrowthInsideLastX64B"),A("tokenFeesOwedA"),A("tokenFeesOwedB"),X(Z(),3,"rewardGrowthInside"),X(A(),8,"")]),Zd=O([Ce("tick"),du("liquidityNet"),Z("liquidityGross"),Z("feeGrowthOutsideX64A"),Z("feeGrowthOutsideX64B"),X(Z(),3,"rewardGrowthsOutsideX64"),X(ut(),13,"")]),Xo=O([Pe(8),C("poolId"),Ce("startTickIndex"),X(Zd,Qe,"ticks"),V("initializedTickCount"),X(V(),115,"")]),Yu=O([Pe(329),X(C(),100,"whitelistMints")]),zu=O([Pe(8),C("poolId"),X(X(A(),8),vs,"positiveTickArrayBitmap"),X(X(A(),8),vs,"negativeTickArrayBitmap")]),Eh=O([A(),V("bump"),C("owner"),C("poolId"),C("positionId"),C("nftAccount"),X(A(),8)]),Fh=O([Pe(8),V("bump"),C("lockOwner"),C("poolId"),C("positionId"),C("nftAccount"),C("lockNftMint"),A("recentEpoch"),X(A(),8)]);ju.span;var Zu=de("Raydium_Clmm"),St={createPool:[233,146,209,142,207,104,64,188],initReward:[95,135,192,196,242,129,230,68],setRewardEmissions:[112,52,167,75,32,201,211,137],openPosition:[77,184,74,214,112,86,241,199],openPositionWithTokenEx:[77,255,174,82,125,29,201,46],closePosition:[123,134,81,0,49,68,98,98],increaseLiquidity:[133,29,89,223,69,238,176,10],decreaseLiquidity:[58,127,188,62,79,82,196,96],swap:[43,4,237,11,26,201,30,98],collectReward:[18,237,166,197,34,16,213,144]},$u=[188,37,179,131,82,150,84,73],Ju=[16,72,250,198,14,162,212,19],Ie=class{static createPoolInstruction(e,t,n,o,i,s,a,c,u,l,m,d,p,f){let y=O([Z("sqrtPriceX64"),A("zero")]),b=[{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:ln.programId,isSigner:!1,isWritable:!1},{pubkey:et,isSigner:!1,isWritable:!1},...f?.map(w=>({pubkey:w,isSigner:!1,isWritable:!1}))||[]],g=Buffer.alloc(y.span);y.encode({sqrtPriceX64:p,zero:Oe},g);let P=Buffer.from([...St.createPool,...g]);return new nt({keys:b,programId:e,data:P})}static async createPoolInstructions(e){let{programId:t,owner:n,mintA:o,mintB:i,ammConfigId:s,initialPriceX64:a,extendMintAccount:c}=e,[u,l]=[new q(o.address),new q(i.address)],{publicKey:m}=Du(t,s,u,l),{publicKey:d}=Uu(t,m),{publicKey:p}=Rs(t,m,u),{publicKey:f}=Rs(t,m,l),y=Ve(t,m).publicKey,b=[this.createPoolInstruction(t,m,n,s,d,u,p,new q(o.programId||Te),l,f,new q(i.programId||Te),y,a,c)];return{signers:[],instructions:b,instructionTypes:[E.CreateAccount,E.ClmmCreatePool],address:{poolId:m,observationId:d,exBitmapAccount:y,mintAVault:p,mintBVault:f},lookupTableAddress:[]}}static openPositionFromLiquidityInstruction(e,t,n,o,i,s,a,c,u,l,m,d,p,f,y,b,g,P,w,k,x,h,I,S,T,K){let R=O([Ce("tickLowerIndex"),Ce("tickUpperIndex"),Ce("tickArrayLowerStartIndex"),Ce("tickArrayUpperStartIndex"),Z("liquidity"),A("amountMaxA"),A("amountMaxB"),Me("withMetadata"),V("optionBaseFlag"),Me("baseFlag")]),N=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],v=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:et,isSigner:!1,isWritable:!1},{pubkey:ln.programId,isSigner:!1,isWritable:!1},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:Ho,isSigner:!1,isWritable:!1},{pubkey:Vt,isSigner:!1,isWritable:!1},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...N],W=Buffer.alloc(R.span);R.encode({tickLowerIndex:P,tickUpperIndex:w,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:x,liquidity:h,amountMaxA:I,amountMaxB:S,withMetadata:T==="create",baseFlag:!1,optionBaseFlag:0},W);let D=Buffer.from([...St.openPosition,...W]);return new nt({keys:v,programId:e,data:D})}static openPositionFromLiquidityInstruction22(e,t,n,o,i,s,a,c,u,l,m,d,p,f,y,b,g,P,w,k,x,h,I,S,T){let K=O([Ce("tickLowerIndex"),Ce("tickUpperIndex"),Ce("tickArrayLowerStartIndex"),Ce("tickArrayUpperStartIndex"),Z("liquidity"),A("amountMaxA"),A("amountMaxB"),Me("withMetadata"),V("optionBaseFlag"),Me("baseFlag")]),R=[...T?[{pubkey:T,isSigner:!1,isWritable:!0}]:[]],N=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:et,isSigner:!1,isWritable:!1},{pubkey:ln.programId,isSigner:!1,isWritable:!1},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:Ho,isSigner:!1,isWritable:!1},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...R],v=Buffer.alloc(K.span);K.encode({tickLowerIndex:g,tickUpperIndex:P,tickArrayLowerStartIndex:w,tickArrayUpperStartIndex:k,liquidity:x,amountMaxA:h,amountMaxB:I,withMetadata:S==="create",baseFlag:!1,optionBaseFlag:0},v);let W=Buffer.from([...St.openPositionWithTokenEx,...v]);return new nt({keys:N,programId:e,data:W})}static async openPositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:i,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d=[],[p,f]=[new q(e.programId),new q(e.id)],y;if(l)y=new q((await l(1))[0]);else{let T=sr.generate();d.push(T),y=T.publicKey}let b=z.getTickArrayStartIndexByTick(o,e.config.tickSpacing),g=z.getTickArrayStartIndexByTick(i,e.config.tickSpacing),{publicKey:P}=be(p,f,b),{publicKey:w}=be(p,f,g),{publicKey:k}=m?$(n.wallet,y,_e):$(n.wallet,y,Te),{publicKey:x}=un(y),{publicKey:h}=ft(p,y),{publicKey:I}=Qt(p,f,o,i),S=m?this.openPositionFromLiquidityInstruction22(p,n.feePayer,f,n.wallet,y,k,I,P,w,h,n.tokenAccountA,n.tokenAccountB,new q(t.vault.A),new q(t.vault.B),new q(e.mintA.address),new q(e.mintB.address),o,i,b,g,s,a,c,u,Se.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ve(p,f).publicKey:void 0):this.openPositionFromLiquidityInstruction(p,n.feePayer,f,n.wallet,y,k,x,I,P,w,h,n.tokenAccountA,n.tokenAccountB,new q(t.vault.A),new q(t.vault.B),new q(e.mintA.address),new q(e.mintB.address),o,i,b,g,s,a,c,u,Se.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ve(p,f).publicKey:void 0);return{signers:d,instructions:[S],instructionTypes:[E.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{nftMint:y,tickArrayLower:P,tickArrayUpper:w,positionNftAccount:k,metadataAccount:x,personalPosition:h,protocolPosition:I}}}static async openPositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:i,base:s,baseAmount:a,otherAmountMax:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d=[],[p,f]=[new q(e.programId),new q(e.id)],y;if(l)y=new q((await l(1))[0]);else{let T=sr.generate();d.push(T),y=T.publicKey}let b=z.getTickArrayStartIndexByTick(o,e.config.tickSpacing),g=z.getTickArrayStartIndexByTick(i,e.config.tickSpacing),{publicKey:P}=be(p,f,b),{publicKey:w}=be(p,f,g),{publicKey:k}=m?$(n.wallet,y,_e):$(n.wallet,y,Te),{publicKey:x}=un(y),{publicKey:h}=ft(p,y),{publicKey:I}=Qt(p,f,o,i),S=m?this.openPositionFromBaseInstruction22(p,n.feePayer,f,n.wallet,y,k,I,P,w,h,n.tokenAccountA,n.tokenAccountB,new q(t.vault.A),new q(t.vault.B),new q(e.mintA.address),new q(e.mintB.address),o,i,b,g,u,s,a,c,Se.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ve(p,f).publicKey:void 0):this.openPositionFromBaseInstruction(p,n.feePayer,f,n.wallet,y,k,x,I,P,w,h,n.tokenAccountA,n.tokenAccountB,new q(t.vault.A),new q(t.vault.B),new q(e.mintA.address),new q(e.mintB.address),o,i,b,g,u,s,a,c,Se.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ve(p,f).publicKey:void 0);return{address:{nftMint:y,tickArrayLower:P,tickArrayUpper:w,positionNftAccount:k,metadataAccount:x,personalPosition:h,protocolPosition:I},instructions:[S],signers:d,instructionTypes:[E.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static openPositionFromBaseInstruction(e,t,n,o,i,s,a,c,u,l,m,d,p,f,y,b,g,P,w,k,x,h,I,S,T,K){let R=O([Ce("tickLowerIndex"),Ce("tickUpperIndex"),Ce("tickArrayLowerStartIndex"),Ce("tickArrayUpperStartIndex"),Z("liquidity"),A("amountMaxA"),A("amountMaxB"),Me("withMetadata"),V("optionBaseFlag"),Me("baseFlag")]),N=[...K?[{pubkey:K,isSigner:!1,isWritable:!0}]:[]],v=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:et,isSigner:!1,isWritable:!1},{pubkey:ln.programId,isSigner:!1,isWritable:!1},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:Ho,isSigner:!1,isWritable:!1},{pubkey:Vt,isSigner:!1,isWritable:!1},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},{pubkey:g,isSigner:!1,isWritable:!1},...N],W=Buffer.alloc(R.span);R.encode({tickLowerIndex:P,tickUpperIndex:w,tickArrayLowerStartIndex:k,tickArrayUpperStartIndex:x,liquidity:new Es(0),amountMaxA:I==="MintA"?S:T,amountMaxB:I==="MintA"?T:S,withMetadata:h==="create",baseFlag:I==="MintA",optionBaseFlag:1},W);let D=Buffer.from([...St.openPosition,...W]);return new nt({keys:v,programId:e,data:D})}static openPositionFromBaseInstruction22(e,t,n,o,i,s,a,c,u,l,m,d,p,f,y,b,g,P,w,k,x,h,I,S,T){let K=O([Ce("tickLowerIndex"),Ce("tickUpperIndex"),Ce("tickArrayLowerStartIndex"),Ce("tickArrayUpperStartIndex"),Z("liquidity"),A("amountMaxA"),A("amountMaxB"),Me("withMetadata"),V("optionBaseFlag"),Me("baseFlag")]),R=[...T?[{pubkey:T,isSigner:!1,isWritable:!0}]:[]],N=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:et,isSigner:!1,isWritable:!1},{pubkey:ln.programId,isSigner:!1,isWritable:!1},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:Ho,isSigner:!1,isWritable:!1},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:b,isSigner:!1,isWritable:!1},...R],v=Buffer.alloc(K.span);K.encode({tickLowerIndex:g,tickUpperIndex:P,tickArrayLowerStartIndex:w,tickArrayUpperStartIndex:k,liquidity:new Es(0),amountMaxA:h==="MintA"?I:S,amountMaxB:h==="MintA"?S:I,withMetadata:x==="create",baseFlag:h==="MintA",optionBaseFlag:1},v);let W=Buffer.from([...St.openPositionWithTokenEx,...v]);return new nt({keys:N,programId:e,data:W})}static async openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:i,liquidity:s,amountMaxA:a,amountMaxB:c,withMetadata:u,getEphemeralSigners:l,nft2022:m}){let d,p=[];if(l)d=new q((await l(1))[0]);else{let T=sr.generate();p.push(T),d=T.publicKey}let[f,y]=[new q(e.programId),new q(e.id)],b=z.getTickArrayStartIndexByTick(o,e.config.tickSpacing),g=z.getTickArrayStartIndexByTick(i,e.config.tickSpacing),{publicKey:P}=be(f,y,b),{publicKey:w}=be(f,y,g),{publicKey:k}=m?$(n.wallet,d,_e):$(n.wallet,d,Te),{publicKey:x}=un(d),{publicKey:h}=ft(f,d),{publicKey:I}=Qt(f,y,o,i),S=m?this.openPositionFromLiquidityInstruction22(f,n.wallet,y,n.wallet,d,k,I,P,w,h,n.tokenAccountA,n.tokenAccountB,new q(t.vault.A),new q(t.vault.B),new q(t.mintA.address),new q(t.mintB.address),o,i,b,g,s,a,c,u,Se.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ve(f,y).publicKey:void 0):this.openPositionFromLiquidityInstruction(f,n.wallet,y,n.wallet,d,k,x,I,P,w,h,n.tokenAccountA,n.tokenAccountB,new q(t.vault.A),new q(t.vault.B),new q(t.mintA.address),new q(t.mintB.address),o,i,b,g,s,a,c,u,Se.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[b,g])?Ve(f,y).publicKey:void 0);return{address:{nftMint:d,tickArrayLower:P,tickArrayUpper:w,positionNftAccount:k,metadataAccount:x,personalPosition:h,protocolPosition:I},instructions:[S],signers:p,instructionTypes:[E.ClmmOpenPosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static closePositionInstruction(e,t,n,o,i,s){let a=O([]),c=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:ln.programId,isSigner:!1,isWritable:!1},{pubkey:s?_e:Te,isSigner:!1,isWritable:!1}],u=Buffer.alloc(a.span);a.encode({},u);let l=Buffer.from([...St.closePosition,...u]);return new nt({keys:c,programId:e,data:l})}static closePositionInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,ownerPosition:o,nft2022:i}){let s=new q(e.programId),a=i?$(n.wallet,o.nftMint,_e).publicKey:$(n.wallet,o.nftMint,Te).publicKey,{publicKey:c}=ft(s,o.nftMint),u=[];return u.push(this.closePositionInstruction(s,n.wallet,o.nftMint,a,c,i)),{address:{positionNftAccount:a,personalPosition:c},signers:[],instructions:u,instructionTypes:[E.ClmmClosePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromLiquidityInstruction(e,t,n,o,i,s,a,c,u,l,m,d,p,f,y,b,g,P){let w=O([Z("liquidity"),A("amountMaxA"),A("amountMaxB"),V("optionBaseFlag"),Me("baseFlag")]),k=[...P?[{pubkey:P,isSigner:!1,isWritable:!0}]:[]],x=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...k],h=Buffer.alloc(w.span);w.encode({liquidity:y,amountMaxA:b,amountMaxB:g,optionBaseFlag:0,baseFlag:!1},h);let I=Buffer.from([...St.increaseLiquidity,...h]);return new nt({keys:x,programId:e,data:I})}static increasePositionFromLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,liquidity:i,amountMaxA:s,amountMaxB:a,nft2022:c}){let[u,l]=[new q(e.programId),new q(e.id)],m=z.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=z.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=be(u,l,m),{publicKey:f}=be(u,l,d),{publicKey:y}=c?$(o.wallet,n.nftMint,_e):$(o.wallet,n.nftMint,Te),{publicKey:b}=ft(u,n.nftMint),{publicKey:g}=Qt(u,l,n.tickLower,n.tickUpper),P=this.increasePositionFromLiquidityInstruction(u,o.wallet,y,b,l,g,p,f,o.tokenAccountA,o.tokenAccountB,new q(t.vault.A),new q(t.vault.B),new q(e.mintA.address),new q(e.mintB.address),i,s,a,Se.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?Ve(u,l).publicKey:void 0);return{address:{tickArrayLower:p,tickArrayUpper:f,positionNftAccount:y,personalPosition:b,protocolPosition:g},signers:[],instructions:[P],instructionTypes:[E.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,base:i,baseAmount:s,otherAmountMax:a,nft2022:c}){let[u,l]=[new q(e.programId),new q(e.id)],m=z.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),d=z.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:p}=be(u,l,m),{publicKey:f}=be(u,l,d),{publicKey:y}=c?$(o.wallet,n.nftMint,_e):$(o.wallet,n.nftMint,Te),{publicKey:b}=ft(u,n.nftMint),{publicKey:g}=Qt(u,l,n.tickLower,n.tickUpper);return{address:{tickArrayLower:p,tickArrayUpper:f,positionNftAccount:y,personalPosition:b,protocolPosition:g},instructions:[this.increasePositionFromBaseInstruction(u,o.wallet,y,b,l,g,p,f,o.tokenAccountA,o.tokenAccountB,new q(t.vault.A),new q(t.vault.B),new q(e.mintA.address),new q(e.mintB.address),i,s,a,Se.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[m,d])?Ve(u,l).publicKey:void 0)],signers:[],instructionTypes:[E.ClmmIncreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static increasePositionFromBaseInstruction(e,t,n,o,i,s,a,c,u,l,m,d,p,f,y,b,g,P){let w=O([Z("liquidity"),A("amountMaxA"),A("amountMaxB"),V("optionBaseFlag"),Me("baseFlag")]),k=[...P?[{pubkey:P,isSigner:!1,isWritable:!0}]:[]],x=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...k],h=Buffer.alloc(w.span);w.encode({liquidity:new Es(0),amountMaxA:y==="MintA"?b:g,amountMaxB:y==="MintA"?g:b,baseFlag:y==="MintA",optionBaseFlag:1},h);let I=Buffer.from([...St.increaseLiquidity,...h]);return new nt({keys:x,programId:e,data:I})}static decreaseLiquidityInstruction(e,t,n,o,i,s,a,c,u,l,m,d,p,f,y,b,g,P,w){let k=O([Z("liquidity"),A("amountMinA"),A("amountMinB")]),x=[...w?[{pubkey:w,isSigner:!1,isWritable:!0}]:[],...y.map(T=>[{pubkey:T.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:T.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:T.rewardMint,isSigner:!1,isWritable:!1}]).flat()],h=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:Ki,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},...x],I=Buffer.alloc(k.span);k.encode({liquidity:b,amountMinA:g,amountMinB:P},I);let S=Buffer.from([...St.decreaseLiquidity,...I]);return new nt({keys:h,programId:e,data:S})}static decreaseLiquidityInstructions({poolInfo:e,poolKeys:t,ownerPosition:n,ownerInfo:o,liquidity:i,amountMinA:s,amountMinB:a,programId:c,nft2022:u}){let[l,m]=[new q(e.programId),new q(e.id)],d=z.getTickArrayStartIndexByTick(n.tickLower,e.config.tickSpacing),p=z.getTickArrayStartIndexByTick(n.tickUpper,e.config.tickSpacing),{publicKey:f}=be(l,m,d),{publicKey:y}=be(l,m,p),{publicKey:b}=u?$(o.wallet,n.nftMint,_e):$(o.wallet,n.nftMint,c),{publicKey:g}=ft(l,n.nftMint),{publicKey:P}=Qt(l,m,n.tickLower,n.tickUpper),w=[];for(let h=0;h<e.rewardDefaultInfos.length;h++)w.push({poolRewardVault:new q(t.rewardInfos[h].vault),ownerRewardVault:o.rewardAccounts[h],rewardMint:new q(e.rewardDefaultInfos[h].mint.address)});let k=[],x=this.decreaseLiquidityInstruction(l,o.wallet,b,g,m,P,f,y,o.tokenAccountA,o.tokenAccountB,new q(t.vault.A),new q(t.vault.B),new q(e.mintA.address),new q(e.mintB.address),w,i,s,a,Se.isOverflowDefaultTickarrayBitmap(e.config.tickSpacing,[d,p])?Ve(l,m).publicKey:void 0);return k.push(x),{address:{tickArrayLower:f,tickArrayUpper:y,positionNftAccount:b,personalPosition:g,protocolPosition:P},signers:[],instructions:k,instructionTypes:[E.ClmmDecreasePosition],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static swapInstruction(e,t,n,o,i,s,a,c,u,l,m,d,p,f,y,b,g){let P=O([A("amount"),A("otherAmountThreshold"),Z("sqrtPriceLimitX64"),Me("isBaseInput")]),w=[...g?[{pubkey:g,isSigner:!1,isWritable:!0}]:[],...m.map(I=>({pubkey:I,isSigner:!1,isWritable:!0}))],k=[{pubkey:t,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:Ki,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},...w],x=Buffer.alloc(P.span);P.encode({amount:p,otherAmountThreshold:f,sqrtPriceLimitX64:y,isBaseInput:b},x);let h=Buffer.from([...St.swap,...x]);return new nt({keys:k,programId:e,data:h})}static makeSwapBaseInInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:o,inputMint:i,amountIn:s,amountOutMin:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new q(e.programId),new q(e.id)],[d,p]=[new q(t.vault.A),new q(t.vault.B)],[f,y]=[new q(e.mintA.address),new q(e.mintB.address)],b=e.mintA.address===i.toString(),g=[this.swapInstruction(l,o.wallet,m,new q(e.config.id),b?o.tokenAccountA:o.tokenAccountB,b?o.tokenAccountB:o.tokenAccountA,b?d:p,b?p:d,b?f:y,b?y:f,u,n,s,a,c,!0,Ve(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[E.ClmmSwapBaseIn],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static makeSwapBaseOutInstructions({poolInfo:e,poolKeys:t,observationId:n,ownerInfo:o,outputMint:i,amountOut:s,amountInMax:a,sqrtPriceLimitX64:c,remainingAccounts:u}){let[l,m]=[new q(e.programId),new q(e.id)],[d,p]=[new q(t.vault.A),new q(t.vault.B)],[f,y]=[new q(e.mintA.address),new q(e.mintB.address)],b=e.mintA.address===i.toBase58(),g=[this.swapInstruction(l,o.wallet,m,new q(e.config.id),b?o.tokenAccountB:o.tokenAccountA,b?o.tokenAccountA:o.tokenAccountB,b?p:d,b?d:p,b?y:f,b?f:y,u,n,s,a,c,!1,Ve(l,m).publicKey)];return{signers:[],instructions:g,instructionTypes:[E.ClmmSwapBaseOut],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[],address:{}}}static initRewardInstruction(e,t,n,o,i,s,a,c,u,l,m,d){let p=O([A("openTime"),A("endTime"),Z("emissionsPerSecondX64")]),f=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:ln.programId,isSigner:!1,isWritable:!1},{pubkey:et,isSigner:!1,isWritable:!1}],y=Buffer.alloc(p.span);p.encode({openTime:j(l),endTime:j(m),emissionsPerSecondX64:d},y);let b=Buffer.from([...St.initReward,...y]);return new nt({keys:f,programId:e,data:b})}static initRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:o}){let[i,s]=[new q(e.programId),new q(e.id)],a=qu(i,s,o.mint).publicKey,c=qo(i).publicKey,u=[this.initRewardInstruction(i,n.wallet,s,c,new q(e.config.id),n.tokenAccount,o.programId,o.mint,a,o.openTime,o.endTime,o.emissionsPerSecondX64)];return{address:{poolRewardVault:a,operationId:c},signers:[],instructions:u,instructionTypes:[E.ClmmInitReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static setRewardInstruction(e,t,n,o,i,s,a,c,u,l,m,d){let p=O([V("rewardIndex"),Z("emissionsPerSecondX64"),A("openTime"),A("endTime")]),f=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0}],y=Buffer.alloc(p.span);p.encode({rewardIndex:u,emissionsPerSecondX64:d,openTime:j(l),endTime:j(m)},y);let b=Buffer.from([...St.setRewardEmissions,...y]);return new nt({keys:f,programId:e,data:b})}static setRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfo:o}){let[i,s]=[new q(e.programId),new q(e.id)],a,c,u;for(let d=0;d<e.rewardDefaultInfos.length;d++)e.rewardDefaultInfos[d].mint.address===o.mint.toString()&&(a=d,c=new q(t.rewardInfos[d].vault),u=new q(t.rewardInfos[d].mint.address));(a===void 0||c===void 0)&&Zu.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let l=qo(i).publicKey,m=[this.setRewardInstruction(i,n.wallet,s,l,new q(e.config.id),n.tokenAccount,c,u,a,o.openTime,o.endTime,o.emissionsPerSecondX64)];return{address:{rewardVault:c,operationId:l},signers:[],instructions:m,instructionTypes:[E.ClmmSetReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static collectRewardInstruction(e,t,n,o,i,s,a){let c=O([V("rewardIndex")]),u=[{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:Ki,isSigner:!1,isWritable:!1}],l=Buffer.alloc(c.span);c.encode({rewardIndex:a},l);let m=Buffer.from([...St.collectReward,...l]);return new nt({keys:u,programId:e,data:m})}static collectRewardInstructions({poolInfo:e,poolKeys:t,ownerInfo:n,rewardMint:o}){let[i,s]=[new q(e.programId),new q(e.id)],a,c;for(let l=0;l<e.rewardDefaultInfos.length;l++)e.rewardDefaultInfos[l].mint.address===o.toString()&&(a=l,c=new q(t.rewardInfos[l].vault));(a===void 0||c===void 0)&&Zu.logWithError("reward mint check error","no reward mint",e.rewardDefaultInfos);let u=[this.collectRewardInstruction(i,n.wallet,s,n.tokenAccount,c,o,a)];return{address:{rewardVault:c},signers:[],instructions:u,instructionTypes:[E.ClmmCollectReward],lookupTableAddress:t.lookupTableAccount?[t.lookupTableAccount]:[]}}static async makeLockPositions({programId:e,authProgramId:t,poolProgramId:n,payer:o,wallet:i,nftMint:s,nft2022:a,getEphemeralSigners:c}){let u=[],l;if(c)l=new q((await c(1))[0]);else{let g=sr.generate();u.push(g),l=g.publicKey}let m=a?$(i,s,_e).publicKey:$(i,s,Te).publicKey,{publicKey:d}=ft(n,s),p=Uo(e,l).publicKey,f=$(i,l,Te).publicKey,y=un(l).publicKey,b=Ie.lockPositionInstructionV2({programId:e,auth:t,payer:o,positionOwner:i,lockOwner:i,positionNftAccount:m,positionId:d,lockPositionId:p,lockNftMint:l,lockNftAccount:f,metadataAccount:y,withMetadata:!0,nft2022:a,positionNftMint:s,authPositionNftAccount:$(t,s,a?_e:Te).publicKey,positionNftProgram:a?_e:Te});return{address:{positionId:d,lockPositionId:p,lockNftAccount:f,lockNftMint:l,positionNftAccount:m,metadataAccount:y},instructions:[b],signers:u,instructionTypes:[E.ClmmLockPosition],lookupTableAddress:[]}}static lockPositionInstructionV2({programId:e,auth:t,payer:n,positionOwner:o,lockOwner:i,positionNftAccount:s,positionId:a,positionNftMint:c,authPositionNftAccount:u,positionNftProgram:l,lockPositionId:m,lockNftMint:d,lockNftAccount:p,metadataAccount:f,withMetadata:y}){let b=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!0,isWritable:!0},{pubkey:o,isSigner:!0,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!0,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:Vt,isSigner:!1,isWritable:!1},{pubkey:Ho,isSigner:!1,isWritable:!1},{pubkey:et,isSigner:!1,isWritable:!1},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:ln.programId,isSigner:!1,isWritable:!1}],g=O([Me("withMetadata")]),P=Buffer.alloc(g.span);g.encode({withMetadata:y},P);let w=Buffer.from([...$u,...P]);return new nt({keys:b,programId:e,data:w})}static lockPositionInstruction({programId:e,authProgramId:t,poolProgramId:n,owner:o,positionNft:i}){let{publicKey:s}=$(o,i,Te),{publicKey:a}=ft(n,i),c=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!0,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:Ns(e,a).publicKey,isSigner:!1,isWritable:!0},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:ln.programId,isSigner:!1,isWritable:!1}];return new nt({keys:c,programId:e,data:Buffer.from($u)})}static harvestLockPositionInstruction(e){let[t,n]=[new q(e.poolKeys.programId),new q(e.poolKeys.id)],o=z.getTickArrayStartIndexByTick(e.ownerPosition.tickLower,e.poolKeys.config.tickSpacing),i=z.getTickArrayStartIndexByTick(e.ownerPosition.tickUpper,e.poolKeys.config.tickSpacing),{publicKey:s}=be(t,n,o),{publicKey:a}=be(t,n,i),{publicKey:c}=$(e.owner,e.ownerPosition.nftMint,Te),{publicKey:u}=ft(t,e.ownerPosition.nftMint),{publicKey:l}=Qt(t,n,e.ownerPosition.tickLower,e.ownerPosition.tickUpper),m=[];for(let f=0;f<e.poolKeys.rewardInfos.length;f++)m.push({poolRewardVault:new q(e.poolKeys.rewardInfos[f].vault),ownerRewardVault:e.ownerRewardAccounts[f],rewardMint:new q(e.poolKeys.rewardInfos[f].mint.address)});let d=[...m.map(f=>[{pubkey:f.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:f.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:f.rewardMint,isSigner:!1,isWritable:!1}]).flat()],p=[{pubkey:e.authProgramId,isSigner:!1,isWritable:!1},{pubkey:Ns(e.programId,u).publicKey,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e.owner,isSigner:!0,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:new q(e.poolKeys.vault.A),isSigner:!1,isWritable:!0},{pubkey:new q(e.poolKeys.vault.B),isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:e.userVaultA,isSigner:!1,isWritable:!0},{pubkey:e.userVaultB,isSigner:!1,isWritable:!0},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:An,isSigner:!1,isWritable:!1},{pubkey:new q(e.poolKeys.mintA.address),isSigner:!1,isWritable:!1},{pubkey:new q(e.poolKeys.mintB.address),isSigner:!1,isWritable:!1},...d];return new nt({keys:p,programId:e.programId,data:Buffer.from(Ju)})}static harvestLockPositionInstructionV2({programId:e,auth:t,lockPositionId:n,clmmProgram:o,lockOwner:i,lockNftMint:s,lockNftAccount:a,positionNftAccount:c,positionId:u,poolId:l,protocolPosition:m,vaultA:d,vaultB:p,tickArrayLower:f,tickArrayUpper:y,userVaultA:b,userVaultB:g,mintA:P,mintB:w,rewardAccounts:k,exTickArrayBitmap:x}){let h=[...x?[{pubkey:x,isSigner:!1,isWritable:!0}]:[],...k.map(S=>[{pubkey:S.poolRewardVault,isSigner:!1,isWritable:!0},{pubkey:S.ownerRewardVault,isSigner:!1,isWritable:!0},{pubkey:S.rewardMint,isSigner:!1,isWritable:!1}]).flat()],I=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0},{pubkey:Te,isSigner:!1,isWritable:!1},{pubkey:_e,isSigner:!1,isWritable:!1},{pubkey:An,isSigner:!1,isWritable:!1},{pubkey:P,isSigner:!1,isWritable:!1},{pubkey:w,isSigner:!1,isWritable:!1},...h];return new nt({keys:I,programId:e,data:Buffer.from(Ju)})}};var $d=O([ut("mintAuthorityOption"),C("mintAuthority"),A("supply"),V("decimals"),V("isInitialized"),ut("freezeAuthorityOption"),C("freezeAuthority")]);import{PublicKey as rT}from"@solana/web3.js";import{MintLayout as aT,TOKEN_PROGRAM_ID as cT}from"@solana/spl-token";var ar=r=>new Ne({mint:r.address,decimals:r.decimals,symbol:r.symbol,name:r.name}),jo=({amount:r,isRaw:e,name:t,...n})=>new we(new Ne({mint:rt(n.address).toBase58(),decimals:n.decimals,symbol:n.symbol,name:t}),r,e,t);var lt=({address:r,programId:e,decimals:t,...n})=>({chainId:101,address:rt(r).toBase58(),programId:e,logoURI:"",symbol:"",name:"",decimals:t,tags:[],extensions:n.extensions||{},...n}),Bn=r=>r?{...r,transferFeeConfigAuthority:r.transferFeeConfigAuthority.toBase58(),withdrawWithheldAuthority:r.withdrawWithheldAuthority.toBase58(),withheldAmount:r.withheldAmount.toString(),olderTransferFee:{...r.olderTransferFee,epoch:r.olderTransferFee.epoch.toString(),maximumFee:r.olderTransferFee.maximumFee.toString()},newerTransferFee:{...r.newerTransferFee,epoch:r.newerTransferFee.epoch.toString(),maximumFee:r.newerTransferFee.maximumFee.toString()}}:void 0;import ec from"bn.js";var Fs=new ec(25),ur=new ec(1e4);import{PublicKey as Jt,SystemProgram as dp,SYSVAR_RENT_PUBKEY as NT,TransactionInstruction as uo}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as pp,TOKEN_PROGRAM_ID as $o}from"@solana/spl-token";var Vs=O([V("instruction"),A("amountIn"),A("minAmountOut")]),Ws=O([V("instruction"),A("maxAmountIn"),A("amountOut")]),IT=O([V("instruction"),V("nonce")]),Jd=O([V("instruction"),V("nonce"),A("startTime")]),Yo=O([A("status"),A("nonce"),A("maxOrder"),A("depth"),A("baseDecimal"),A("quoteDecimal"),A("state"),A("resetFlag"),A("minSize"),A("volMaxCutRatio"),A("amountWaveRatio"),A("baseLotSize"),A("quoteLotSize"),A("minPriceMultiplier"),A("maxPriceMultiplier"),A("systemDecimalValue"),A("minSeparateNumerator"),A("minSeparateDenominator"),A("tradeFeeNumerator"),A("tradeFeeDenominator"),A("pnlNumerator"),A("pnlDenominator"),A("swapFeeNumerator"),A("swapFeeDenominator"),A("baseNeedTakePnl"),A("quoteNeedTakePnl"),A("quoteTotalPnl"),A("baseTotalPnl"),A("poolOpenTime"),A("punishPcAmount"),A("punishCoinAmount"),A("orderbookToInitTime"),Z("swapBaseInAmount"),Z("swapQuoteOutAmount"),A("swapBase2QuoteFee"),Z("swapQuoteInAmount"),Z("swapBaseOutAmount"),A("swapQuote2BaseFee"),C("baseVault"),C("quoteVault"),C("baseMint"),C("quoteMint"),C("lpMint"),C("openOrders"),C("marketId"),C("marketProgramId"),C("targetOrders"),C("withdrawQueue"),C("lpVault"),C("owner"),A("lpReserve"),X(A(),3,"padding")]),BT=O([A("accountType"),A("status"),A("nonce"),A("maxOrder"),A("depth"),A("baseDecimal"),A("quoteDecimal"),A("state"),A("resetFlag"),A("minSize"),A("volMaxCutRatio"),A("amountWaveRatio"),A("baseLotSize"),A("quoteLotSize"),A("minPriceMultiplier"),A("maxPriceMultiplier"),A("systemDecimalsValue"),A("abortTradeFactor"),A("priceTickMultiplier"),A("priceTick"),A("minSeparateNumerator"),A("minSeparateDenominator"),A("tradeFeeNumerator"),A("tradeFeeDenominator"),A("pnlNumerator"),A("pnlDenominator"),A("swapFeeNumerator"),A("swapFeeDenominator"),A("baseNeedTakePnl"),A("quoteNeedTakePnl"),A("quoteTotalPnl"),A("baseTotalPnl"),A("poolOpenTime"),A("punishPcAmount"),A("punishCoinAmount"),A("orderbookToInitTime"),Z("swapBaseInAmount"),Z("swapQuoteOutAmount"),Z("swapQuoteInAmount"),Z("swapBaseOutAmount"),A("swapQuote2BaseFee"),A("swapBase2QuoteFee"),C("baseVault"),C("quoteVault"),C("baseMint"),C("quoteMint"),C("lpMint"),C("modelDataAccount"),C("openOrders"),C("marketId"),C("marketProgramId"),C("targetOrders"),C("owner"),X(A(),64,"padding")]),Ds=O([V("instruction"),A("baseAmountIn"),A("quoteAmountIn"),A("fixedSide"),A("otherAmountMin")]),qs=O([V("instruction"),A("lpAmount"),A("baseAmountMin"),A("quoteAmountMin")]);var tc=O([A("fee")]);import{PublicKey as ep}from"@solana/web3.js";var ao=new ep("CDSr3ssLcRB6XYPJwAfFt18MZvEZp4LjHcvzBVZ45duo"),Dn=5e4,tp=O([A("x"),A("y"),A("price")]),np=O([A("accountType"),A("status"),A("multiplier"),A("validDataCount"),X(tp,Dn,"DataElement")]);function op(r,e){return[0,Dn-2]}function ip(r){return[0,Dn-2]}function rp(r){return[0,Dn-2]}function sp(r,e,t){let[n,o]=op(e,t),i=n,s=o,a=0,c=e*r.multiplier/t;for(;i<=s;){if(a=Math.floor((s+i)/2),a===0||a>=Dn-2)return[a,a,!1];let u=r.DataElement[a].x*r.multiplier/r.DataElement[a].y,l=r.DataElement[a-1].x*r.multiplier/r.DataElement[a-1].y,m=r.DataElement[a+1].x*r.multiplier/r.DataElement[a+1].y;if(c===u)return[a,a,!0];if(c===l)return[a-1,a-1,!0];if(c===m)return[a+1,a+1,!0];if(c<l)s=a-1;else{if(c>l&&c<u)return[a-1,a,!0];if(c>u&&c<m)return[a,a+1,!0];i=a+1}}return[a,a,!1]}function Us(r,e,t){let[n,o,i]=sp(r,e,t);if(!i)return 0;if(n===o){let s=r.DataElement[n].x;return e*r.multiplier/s}else{let s=r.DataElement[n].x,a=r.DataElement[n].y,c=r.DataElement[o].x,u=r.DataElement[o].y,l=t*(c*a-s*u),m=s*l,d=(c-s)*(e*a-s*t)*u,p=m+d;return e*r.multiplier*l/p}}function Wn(r,e,t){return e*r.multiplier/t}function nc(r,e,t){return e*t/r.multiplier}function ap(r,e){let[t,n]=ip(e),o=t,i=n,s=0,a=e;for(;o<i;){if(s=Math.floor((i+o)/2),s<=0||s>Dn-2)return[s,s,!1];let c=r.DataElement[s].x,u=r.DataElement[s-1].x,l=r.DataElement[s+1].x;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<u)i=s-1;else{if(a>u&&a<c)return[s-1,s,!0];if(a>c&&a<l)return[s,s+1,!0];o=s+1}}return[s,s,!1]}function up(r,e){let[t,n]=rp(e),o=t,i=n,s=0,a=e;for(;o<=i;){if(s=Math.floor((i+o)/2),s<=0||s>=Dn-2)return[s,s,!1];let c=r.DataElement[s].y,u=r.DataElement[s-1].y,l=r.DataElement[s+1].y;if(a===c)return[s,s,!0];if(a===u)return[s-1,s-1,!0];if(a===l)return[s+1,s+1,!0];if(a<l)o=s+1;else{if(a<u&&a>c)return[s-1,s,!0];if(a<c&&a>l)return[s,s+1,!0];i=s-1}}return[s,s,!1]}function oc(r,e,t,n){let o=n?e+t:e-t,[i,s,a]=ap(r,o);if(!a)return[0,0,!1,a];if(i===s)return[r.DataElement[s].price,r.DataElement[s].y,!1,a];{let c=r.DataElement[i].x,u=r.DataElement[s].x,l=r.DataElement[i].price,m=r.DataElement[s].price,d=r.DataElement[i].y,p=r.DataElement[s].y;if(e>=c&&e<=u)return n?[m,p,!0,a]:[l,d,!0,a];{let f,y;return n?(f=l+(m-l)*(e-c)/(u-c),y=d-(o-c)*r.multiplier/m):(f=l+(m-l)*(e-c)/(u-c),y=p+(u-o)*r.multiplier/l),[f,y,!1,a]}}}function cp(r,e,t,n){let o=n?e-t:e+t,[i,s,a]=up(r,o);if(!a)return[0,0,!1,a];if(i===s)return[r.DataElement[s].price,r.DataElement[s].x,!1,a];{let c=r.DataElement[i].x,u=r.DataElement[s].x,l=r.DataElement[i].price,m=r.DataElement[s].price,d=r.DataElement[i].y,p=r.DataElement[s].y;if(e>=p&&e<=d)return n?[m,u,!0,a]:[l,c,!0,a];{let f,y;return n?(f=l+(m-l)*(d-e)/(d-p),y=c+m*(d-o)/r.multiplier):(f=l+(m-l)*(d-e)/(d-p),y=u-l*(o-p)/r.multiplier),[f,y,!1,a]}}}function lp(r,e){let t=oc(r,e,0,!1);return t[3]?t[0]:0}function ic(r,e,t,n){let o=Us(r,e,t),i=Wn(r,e,o),s=Wn(r,t,o),a=Wn(r,n,o),c=!0,[u,l,m,d]=oc(r,i,a,c);if(!d)return 0;if(m)return n*r.multiplier/u;{let p=s-l;return nc(r,p,o)}}function rc(r,e,t,n){let o=Us(r,e,t),i=Wn(r,e,o),s=Wn(r,t,o),a=Wn(r,n,o),c=!1,[u,l,m,d]=cp(r,s,a,c);if(!d)return 0;if(m)return n*u/r.multiplier;{let p=i-l;return nc(r,p,o)}}function mp(r){let e=np.decode(r);return{accountType:e.accountType.toNumber(),status:e.status.toNumber(),multiplier:e.multiplier.toNumber(),validDataCount:e.validDataCount.toNumber(),DataElement:e.DataElement.map(t=>({x:t.x.toNumber(),y:t.y.toNumber(),price:t.price.toNumber()}))}}function sc(r,e,t,n){let o=lp(r,Wn(r,e,Us(r,e,t)))/r.multiplier;return n?o:1/o}var Zo=class{connection;_layoutData={accountType:0,status:0,multiplier:0,validDataCount:0,DataElement:[]};constructor({connection:e}){this.connection=e}get stableModelData(){return this._layoutData}async initStableModelLayout(){if(this._layoutData.validDataCount===0&&this.connection){let e=await this.connection.getAccountInfo(ao);e&&(this._layoutData=mp(e?.data))}}};var ac=de("Raydium_liquidity_instruction");function uc(r){let{poolInfo:e,poolKeys:t,userKeys:n,baseAmountIn:o,quoteAmountIn:i,fixedSide:s,otherAmountMin:a}=r,c=Buffer.alloc(Ds.span);Ds.encode({instruction:3,baseAmountIn:j(o),quoteAmountIn:j(i),otherAmountMin:j(a),fixedSide:s==="base"?At:Ma},c);let u=[B({pubkey:$o,isWritable:!1}),B({pubkey:new Jt(e.id)}),B({pubkey:new Jt(t.authority),isWritable:!1}),B({pubkey:new Jt(t.openOrders),isWritable:!1}),B({pubkey:new Jt(t.targetOrders)}),B({pubkey:new Jt(e.lpMint.address)}),B({pubkey:new Jt(t.vault.A)}),B({pubkey:new Jt(t.vault.B)})];return e.pooltype.includes("StablePool")&&u.push(B({pubkey:ao})),u.push(B({pubkey:new Jt(e.marketId),isWritable:!1}),B({pubkey:n.baseTokenAccount}),B({pubkey:n.quoteTokenAccount}),B({pubkey:n.lpTokenAccount}),B({pubkey:n.owner,isWritable:!1,isSigner:!0}),B({pubkey:new Jt(t.marketEventQueue),isWritable:!1})),new uo({programId:new Jt(e.programId),keys:u,data:c})}function Gs(r){let{poolInfo:e,poolKeys:t,userKeys:n,lpAmount:o,baseAmountMin:i,quoteAmountMin:s}=r,a=tt(t),c=4;if(e.pooltype.includes("StablePool")&&(c=5),c===4||c===5){let u=Buffer.alloc(qs.span);qs.encode({instruction:4,lpAmount:j(o),baseAmountMin:j(i),quoteAmountMin:j(s)},u);let l=[B({pubkey:$o,isWritable:!1}),B({pubkey:a.id}),B({pubkey:a.authority,isWritable:!1}),B({pubkey:a.openOrders}),B({pubkey:a.targetOrders}),B({pubkey:a.mintLp.address}),B({pubkey:a.vault.A}),B({pubkey:a.vault.B})];return c===5?l.push(B({pubkey:ao})):(l.push(B({pubkey:a.id})),l.push(B({pubkey:a.id}))),l.push(B({pubkey:a.marketProgramId,isWritable:!1}),B({pubkey:a.marketId}),B({pubkey:a.marketBaseVault}),B({pubkey:a.marketQuoteVault}),B({pubkey:a.marketAuthority,isWritable:!1}),B({pubkey:n.lpTokenAccount}),B({pubkey:n.baseTokenAccount}),B({pubkey:n.quoteTokenAccount}),B({pubkey:n.owner,isWritable:!1,isSigner:!0}),B({pubkey:a.marketEventQueue}),B({pubkey:a.marketBids}),B({pubkey:a.marketAsks})),new uo({programId:a.programId,keys:l,data:u})}return new uo({programId:a.programId,keys:[]})}function Xs({programId:r,ammId:e,ammAuthority:t,ammOpenOrders:n,lpMint:o,coinMint:i,pcMint:s,coinVault:a,pcVault:c,withdrawQueue:u,ammTargetOrders:l,poolTempLp:m,marketProgramId:d,marketId:p,userWallet:f,userCoinVault:y,userPcVault:b,userLpVault:g,nonce:P,openTime:w,coinAmount:k,pcAmount:x,ammConfigId:h,feeDestinationId:I}){let S=O([V("instruction"),V("nonce"),A("openTime"),A("pcAmount"),A("coinAmount")]),T=[{pubkey:$o,isSigner:!1,isWritable:!1},{pubkey:pp,isSigner:!1,isWritable:!1},{pubkey:dp.programId,isSigner:!1,isWritable:!1},{pubkey:et,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!1,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:h,isSigner:!1,isWritable:!1},{pubkey:I,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!0,isWritable:!0},{pubkey:y,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:g,isSigner:!1,isWritable:!0}],K=Buffer.alloc(S.span);return S.encode({instruction:1,nonce:P,openTime:w,coinAmount:k,pcAmount:x},K),{instruction:new uo({keys:T,programId:r,data:K}),instructionType:E.AmmV4CreatePool}}function fp({poolKeys:r,userKeys:e,amountIn:t,minAmountOut:n},o){let i=tt(r),s=Buffer.alloc(Vs.span);Vs.encode({instruction:9,amountIn:j(t),minAmountOut:j(n)},s);let a=[B({pubkey:$o,isWritable:!1}),B({pubkey:i.id}),B({pubkey:i.authority,isWritable:!1}),B({pubkey:i.openOrders})];return o===4&&a.push(B({pubkey:i.targetOrders})),a.push(B({pubkey:i.vault.A}),B({pubkey:i.vault.B})),o===5&&a.push(B({pubkey:ao})),a.push(B({pubkey:i.marketProgramId,isWritable:!1}),B({pubkey:i.marketId}),B({pubkey:i.marketBids}),B({pubkey:i.marketAsks}),B({pubkey:i.marketEventQueue}),B({pubkey:i.marketBaseVault}),B({pubkey:i.marketQuoteVault}),B({pubkey:i.marketAuthority,isWritable:!1}),B({pubkey:e.tokenAccountIn}),B({pubkey:e.tokenAccountOut}),B({pubkey:e.owner,isWritable:!1,isSigner:!0})),new uo({programId:i.programId,keys:a,data:s})}function bp({poolKeys:r,userKeys:e,maxAmountIn:t,amountOut:n},o){let i=tt(r),s=Buffer.alloc(Ws.span);Ws.encode({instruction:11,maxAmountIn:j(t),amountOut:j(n)},s);let a=[B({pubkey:$o,isWritable:!1}),B({pubkey:i.id}),B({pubkey:i.authority,isWritable:!1}),B({pubkey:i.openOrders}),B({pubkey:i.targetOrders}),B({pubkey:i.vault.A}),B({pubkey:i.vault.B})];return o===5&&a.push(B({pubkey:ao})),a.push(B({pubkey:i.marketProgramId,isWritable:!1}),B({pubkey:i.marketId}),B({pubkey:i.marketBids}),B({pubkey:i.marketAsks}),B({pubkey:i.marketEventQueue}),B({pubkey:i.marketBaseVault}),B({pubkey:i.marketQuoteVault}),B({pubkey:i.marketAuthority,isWritable:!1}),B({pubkey:e.tokenAccountIn}),B({pubkey:e.tokenAccountOut}),B({pubkey:e.owner,isWritable:!1,isSigner:!0})),new uo({programId:i.programId,keys:a,data:s})}function cr(r){let{poolKeys:e,version:t,userKeys:n,amountIn:o,amountOut:i,fixedSide:s}=r;if(t===4||t===5){let a={poolKeys:e,userKeys:n};if(s==="in")return fp({...a,amountIn:o,minAmountOut:i},t);if(s==="out")return bp({...a,maxAmountIn:o,amountOut:i},t);ac.logWithError("invalid params","params",r)}throw ac.logWithError("invalid version","poolKeys.version",t),new Error("invalid version")}import{PublicKey as Ap}from"@solana/web3.js";import sI from"bn.js";import{TOKEN_PROGRAM_ID as Pp}from"@solana/spl-token";import{PublicKey as yp}from"@solana/web3.js";var gp=de("Raydium_liquidity_serum");function cc({programId:r,marketId:e}){let t=[e.toBuffer()],n=0,o;for(;n<100;){try{let i=t.concat(Buffer.from([n]),Buffer.alloc(7));o=yp.createProgramAddressSync(i,r)}catch(i){if(i instanceof TypeError)throw i;n++;continue}return{publicKey:o,nonce:n}}throw gp.logWithError("unable to find a viable program address nonce","params",{programId:r,marketId:e}),new Error("unable to find a viable program address nonce")}function lr({programId:r}){let{publicKey:e}=ue([Buffer.from("amm_config_account_seed","utf-8")],r);return e}function qn({name:r,programId:e,marketId:t}){let{publicKey:n}=ue([e.toBuffer(),t.toBuffer(),Buffer.from(r,"utf-8")],e);return n}function wp({programId:r,marketId:e}){let{publicKey:t}=ue([r.toBuffer(),e.toBuffer(),Buffer.from("open_order_associated_seed","utf-8")],r);return t}function zs({programId:r}){return ue([Buffer.from([97,109,109,32,97,117,116,104,111,114,105,116,121])],r)}function Hs({version:r,marketVersion:e,marketId:t,baseMint:n,quoteMint:o,baseDecimals:i,quoteDecimals:s,programId:a,marketProgramId:c}){let u=qn({name:"amm_associated_seed",programId:a,marketId:t}),l=qn({name:"lp_mint_associated_seed",programId:a,marketId:t}),{publicKey:m,nonce:d}=zs({programId:a}),p=qn({name:"coin_vault_associated_seed",programId:a,marketId:t}),f=qn({name:"pc_vault_associated_seed",programId:a,marketId:t}),y=qn({name:"temp_lp_token_associated_seed",programId:a,marketId:t}),b=wp({programId:a,marketId:t}),g=qn({name:"target_associated_seed",programId:a,marketId:t}),P=qn({name:"withdraw_associated_seed",programId:a,marketId:t}),{publicKey:w}=cc({programId:c,marketId:t});return{id:u,baseMint:n,quoteMint:o,lpMint:l,baseDecimals:i,quoteDecimals:s,lpDecimals:i,version:r,programId:a,authority:m,nonce:d,baseVault:p,quoteVault:f,lpVault:y,openOrders:b,targetOrders:g,withdrawQueue:P,marketVersion:e,marketProgramId:c,marketId:t,marketAuthority:w,lookupTableAccount:Ap.default,configId:lr({programId:a})}}var Qs={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]},mr=r=>{let e={},t=Pp.toBase58();return Object.keys(r).map(n=>{let o=r[n],[i,s]=[o.baseMint.toBase58(),o.quoteMint.toBase58()];e[n]={id:n,version:4,status:o.status.toNumber(),programId:o.programId.toBase58(),mintA:lt({address:i,programId:t,decimals:o.baseDecimal.toNumber()}),mintB:lt({address:s,programId:t,decimals:o.quoteDecimal.toNumber()}),rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:o.poolPrice.toNumber(),mintAmountA:new L(o.mintAAmount.toString()).div(10**o.baseDecimal.toNumber()).toNumber(),mintAmountB:new L(o.mintBAmount.toString()).div(10**o.quoteDecimal.toNumber()).toNumber(),baseReserve:o.baseReserve,quoteReserve:o.quoteReserve,feeRate:new L(o.tradeFeeNumerator.toString()).div(o.tradeFeeDenominator.toString()).toNumber(),openTime:o.poolOpenTime.toString(),tvl:0,day:Qs,week:Qs,month:Qs,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0,type:"Standard",marketId:o.marketId.toBase58(),configId:lr({programId:o.programId}).toBase58(),lpPrice:0,lpAmount:new L(o.lpReserve.toString()).div(10**Math.min(o.baseDecimal.toNumber(),o.quoteDecimal.toNumber())).toNumber(),lpMint:lt({address:o.lpMint.toBase58(),programId:t,decimals:Math.min(o.baseDecimal.toNumber(),o.quoteDecimal.toNumber())}),burnPercent:0}}),e};import Ee from"bn.js";import{PublicKey as Jo}from"@solana/web3.js";import ei from"bn.js";import{TOKEN_PROGRAM_ID as pc}from"@solana/spl-token";import{SystemProgram as Un,SYSVAR_RENT_PUBKEY as hp,Transaction as lc,TransactionInstruction as Tp}from"@solana/web3.js";import{createInitializeAccountInstruction as mc,TOKEN_PROGRAM_ID as dc}from"@solana/spl-token";function kp(r="accountFlags"){let e=new $i(r);return e.addBoolean("initialized"),e.addBoolean("market"),e.addBoolean("openOrders"),e.addBoolean("requestQueue"),e.addBoolean("eventQueue"),e.addBoolean("bids"),e.addBoolean("asks"),e}var js=O([Pe(5),kp("accountFlags"),C("ownAddress"),A("vaultSignerNonce"),C("baseMint"),C("quoteMint"),C("baseVault"),A("baseDepositsTotal"),A("baseFeesAccrued"),C("quoteVault"),A("quoteDepositsTotal"),A("quoteFeesAccrued"),A("quoteDustThreshold"),C("requestQueue"),C("eventQueue"),C("bids"),C("asks"),A("baseLotSize"),A("quoteLotSize"),A("feeRateBps"),A("referrerRebatesAccrued"),Pe(7)]);function Ip({programId:r,marketInfo:e}){let t=O([V("version"),ut("instruction"),A("baseLotSize"),A("quoteLotSize"),Gt("feeRateBps"),A("vaultSignerNonce"),A("quoteDustThreshold")]),n=[{pubkey:e.id,isSigner:!1,isWritable:!0},{pubkey:e.requestQueue,isSigner:!1,isWritable:!0},{pubkey:e.eventQueue,isSigner:!1,isWritable:!0},{pubkey:e.bids,isSigner:!1,isWritable:!0},{pubkey:e.asks,isSigner:!1,isWritable:!0},{pubkey:e.baseVault,isSigner:!1,isWritable:!0},{pubkey:e.quoteVault,isSigner:!1,isWritable:!0},{pubkey:e.baseMint,isSigner:!1,isWritable:!1},{pubkey:e.quoteMint,isSigner:!1,isWritable:!1},{pubkey:e.authority?e.quoteMint:hp,isSigner:!1,isWritable:!1}].concat(e.authority?{pubkey:e.authority,isSigner:!1,isWritable:!1}:[]).concat(e.authority&&e.pruneAuthority?{pubkey:e.pruneAuthority,isSigner:!1,isWritable:!1}:[]),o=Buffer.alloc(t.span);return t.encode({version:0,instruction:0,baseLotSize:e.baseLotSize,quoteLotSize:e.quoteLotSize,feeRateBps:e.feeRateBps,vaultSignerNonce:e.vaultSignerNonce,quoteDustThreshold:e.quoteDustThreshold},o),new Tp({keys:n,programId:r,data:o})}async function dr({connection:r,wallet:e,marketInfo:t}){let n=new lc,o=await r.getMinimumBalanceForRentExemption(165);n.add(Un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.baseVault.seed,newAccountPubkey:t.baseVault.publicKey,lamports:o,space:165,programId:dc}),Un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.quoteVault.seed,newAccountPubkey:t.quoteVault.publicKey,lamports:o,space:165,programId:dc}),mc(t.baseVault.publicKey,t.baseMint,t.vaultOwner),mc(t.quoteVault.publicKey,t.quoteMint,t.vaultOwner),Un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.id.seed,newAccountPubkey:t.id.publicKey,lamports:await r.getMinimumBalanceForRentExemption(js.span),space:js.span,programId:t.programId}));let i=new lc;return i.add(Un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.requestQueue.seed,newAccountPubkey:t.requestQueue.publicKey,lamports:t.lowestFeeMarket?6208320:await r.getMinimumBalanceForRentExemption(t.requestQueueSpace??5120+12),space:t.lowestFeeMarket?764:t.requestQueueSpace??5120+12,programId:t.programId}),Un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.eventQueue.seed,newAccountPubkey:t.eventQueue.publicKey,lamports:t.lowestFeeMarket?79594560:await r.getMinimumBalanceForRentExemption(t.eventQueueSpace??262144+12),space:t.lowestFeeMarket?11308:t.eventQueueSpace??262144+12,programId:t.programId}),Un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.bids.seed,newAccountPubkey:t.bids.publicKey,lamports:t.lowestFeeMarket?101977920:await r.getMinimumBalanceForRentExemption(t.orderbookQueueSpace??65536+12),space:t.lowestFeeMarket?14524:t.orderbookQueueSpace??65536+12,programId:t.programId}),Un.createAccountWithSeed({fromPubkey:e,basePubkey:e,seed:t.asks.seed,newAccountPubkey:t.asks.publicKey,lamports:t.lowestFeeMarket?101977920:await r.getMinimumBalanceForRentExemption(t.orderbookQueueSpace??65536+12),space:t.lowestFeeMarket?14524:t.orderbookQueueSpace??65536+12,programId:t.programId}),Ip({programId:t.programId,marketInfo:{id:t.id.publicKey,requestQueue:t.requestQueue.publicKey,eventQueue:t.eventQueue.publicKey,bids:t.bids.publicKey,asks:t.asks.publicKey,baseVault:t.baseVault.publicKey,quoteVault:t.quoteVault.publicKey,baseMint:t.baseMint,quoteMint:t.quoteMint,baseLotSize:t.baseLotSize,quoteLotSize:t.quoteLotSize,feeRateBps:t.feeRateBps,vaultSignerNonce:t.vaultSignerNonce,quoteDustThreshold:t.quoteDustThreshold}})),[{transaction:n,signer:[],instructionTypes:[E.CreateAccount,E.CreateAccount,E.InitAccount,E.InitAccount]},{transaction:i,signer:[],instructionTypes:[E.CreateAccount,E.CreateAccount,E.CreateAccount,E.CreateAccount,E.CreateAccount,E.InitMarket]}]}var co=class extends Ke{async create({baseInfo:e,quoteInfo:t,lotSize:n,tickSize:o,dexProgramId:i,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u,assignSeed:l,txVersion:m,computeBudgetConfig:d,txTipConfig:p,feePayer:f}){let y=this.scope.ownerPubKey,b=l?`${e.mint.toBase58().slice(0,10)}-${t.mint.toBase58().slice(0,10)}-${l}`:void 0,g=Fe({fromPublicKey:y,programId:i,assignSeed:b&&`${b}-market`}),P=Fe({fromPublicKey:y,programId:i,assignSeed:b&&`${b}-request`}),w=Fe({fromPublicKey:y,programId:i,assignSeed:b&&`${b}-event`}),k=Fe({fromPublicKey:y,programId:i,assignSeed:b&&`${b}-bids`}),x=Fe({fromPublicKey:y,programId:i,assignSeed:b&&`${b}-asks`}),h=Fe({fromPublicKey:y,programId:pc,assignSeed:b&&`${b}-baseVault`}),I=Fe({fromPublicKey:y,programId:pc,assignSeed:b&&`${b}-quoteVault`}),S=0,T=new ei(100);function K(){let ee=new ei(0);for(;;)try{return{vaultOwner:Jo.createProgramAddressSync([g.publicKey.toBuffer(),ee.toArrayLike(Buffer,"le",8)],i),vaultSignerNonce:ee}}catch{if(ee.iaddn(1),ee.gt(new ei(25555)))throw Error("find vault owner error")}}let{vaultOwner:R,vaultSignerNonce:N}=K(),v=new ei(Math.round(10**e.decimals*n)),W=new ei(Math.round(n*10**t.decimals*o));if(v.eq(At))throw Error("lot size is too small");if(W.eq(At))throw Error("tick size or lot size is too small");let D=await dr({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:i,id:g,baseMint:e.mint,quoteMint:t.mint,baseVault:h,quoteVault:I,vaultOwner:R,requestQueue:P,eventQueue:w,bids:k,asks:x,feeRateBps:S,quoteDustThreshold:T,vaultSignerNonce:N,baseLotSize:v,quoteLotSize:W,requestQueueSpace:s,eventQueueSpace:a,orderbookQueueSpace:c,lowestFeeMarket:u}}),U=this.createTxBuilder(f);U.addInstruction({instructions:D[0].transaction.instructions,signers:D[0].signer});for await(let ee of D.slice(1,D.length))U.addInstruction({instructions:ee.transaction.instructions,signers:ee.signer,instructionTypes:ee.instructionTypes});return m===0?U.sizeCheckBuildV0({computeBudgetConfig:d,address:{marketId:g.publicKey,requestQueue:P.publicKey,eventQueue:w.publicKey,bids:k.publicKey,asks:x.publicKey,baseVault:h.publicKey,quoteVault:I.publicKey,baseMint:new Jo(e.mint),quoteMint:new Jo(t.mint)}}):U.sizeCheckBuild({computeBudgetConfig:d,address:{marketId:g.publicKey,requestQueue:P.publicKey,eventQueue:w.publicKey,bids:k.publicKey,asks:x.publicKey,baseVault:h.publicKey,quoteVault:I.publicKey,baseMint:new Jo(e.mint),quoteMint:new Jo(t.mint)}})}};var ti=class extends Ke{stableLayout;constructor(e){super(e),this.stableLayout=new Zo({connection:this.scope.connection})}async initLayout(){await this.stableLayout.initStableModelLayout()}async load(){this.checkDisabled()}computePairAmount({poolInfo:e,amount:t,slippage:n,baseIn:o}){let i=new Ee(new L(t).mul(10**e[o?"mintA":"mintB"].decimals).toFixed(0)),s=ar(e[o?"mintB":"mintA"]),[a,c]=[new Ee(new L(e.mintAmountA).mul(10**e.mintA.decimals).toString()),new Ee(new L(e.mintAmountB).mul(10**e.mintB.decimals).toString())],u=new Ee(new L(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,L.ROUND_DOWN));this.logDebug("baseReserve:",a.toString(),"quoteReserve:",c.toString()),this.logDebug("tokenIn:",o?e.mintA.symbol:e.mintB.symbol,"amountIn:",i.toString(),"anotherToken:",o?e.mintB.symbol:e.mintA.symbol,"slippage:",`${n.toSignificant()}%`,"baseReserve",a.toString(),"quoteReserve",c.toString());let l=o?"base":"quote";this.logDebug("input side:",l);let m=At;i.isZero()||(m=l==="base"?Li(i.mul(c),a):Li(i.mul(a),c)),this.logDebug("amountRaw:",m.toString(),"lpAmount:",u.toString());let d=Li(i.mul(u),l==="base"?a:c);this.logDebug("liquidity:",d.toString());let p=new Ye(new Ee(1)).add(n),f=new Ye(new Ee(1)).sub(n),y=p.mul(m).quotient,b=f.mul(m).quotient,g=new we(s,m),P=new we(s,y),w=new we(s,b);return this.logDebug("anotherAmount:",g.toFixed(),"maxAnotherAmount:",P.toFixed()),{anotherAmount:g,maxAnotherAmount:P,minAnotherAmount:w,liquidity:d}}async getAmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async addLiquidity(e){let{poolInfo:t,poolKeys:n,amountInA:o,amountInB:i,otherAmountMin:s,fixedSide:a,config:c,txVersion:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),this.logDebug("amountInA:",o,"amountInB:",i),(o.isZero()||i.isZero())&&this.logAndCreateError("amounts must greater than zero","amountInA & amountInB",{amountInA:o.toFixed(),amountInB:i.toFixed()});let{account:p}=this.scope,{bypassAssociatedCheck:f,checkCreateATAOwner:y}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...c},[b,g]=[o.token,i.token],P=await p.getCreatedTokenAccount({mint:b.mint,associatedOnly:!1}),w=await p.getCreatedTokenAccount({mint:g.mint,associatedOnly:!1});!P&&!w&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",p.tokenAccounts);let k=await p.getCreatedTokenAccount({mint:new De(t.lpMint.address)}),x=[b,g],h=[P,w],I=[o.raw,i.raw],S=o.token.mint.toBase58()===t.mintA.address?"base":"quote",T="base";["quote","base"].includes(S)||this.logAndCreateError("invalid fixedSide","fixedSide",a),S==="quote"?(x.reverse(),h.reverse(),I.reverse(),T=a==="a"?"quote":"base"):S==="base"&&(T=a==="a"?"base":"quote");let[K,R]=x,[N,v]=h,[W,D]=I,U=n??await this.getAmmPoolKeys(t.id),ee=this.createTxBuilder(d),{tokenAccount:J,...le}=await p.handleTokenAccount({side:"in",amount:W,mint:K.mint,tokenAccount:N,bypassAssociatedCheck:f,checkCreateATAOwner:y});ee.addInstruction(le);let{tokenAccount:oe,...fe}=await p.handleTokenAccount({side:"in",amount:D,mint:R.mint,tokenAccount:v,bypassAssociatedCheck:f,checkCreateATAOwner:y});ee.addInstruction(fe);let{tokenAccount:ot,...Ge}=await p.handleTokenAccount({side:"out",amount:0,mint:new De(t.lpMint.address),tokenAccount:k,bypassAssociatedCheck:f,checkCreateATAOwner:y});return ee.addInstruction(Ge),ee.addInstruction({instructions:[uc({poolInfo:t,poolKeys:U,userKeys:{baseTokenAccount:J,quoteTokenAccount:oe,lpTokenAccount:ot,owner:this.scope.ownerPubKey},baseAmountIn:W,quoteAmountIn:D,otherAmountMin:s.raw,fixedSide:T})],instructionTypes:[t.pooltype.includes("StablePool")?E.AmmV5AddLiquidity:E.AmmV4AddLiquidity],lookupTableAddress:U.lookupTableAccount?[U.lookupTableAccount]:[]}),ee.addCustomComputeBudget(l),ee.addTipInstruction(m),u===0?await ee.buildV0():ee.build()}async removeLiquidity(e){this.scope.availability.removeStandardPosition===!1&&this.logAndCreateError("remove liquidity feature disabled in your region");let{poolInfo:t,poolKeys:n,lpAmount:o,baseAmountMin:i,quoteAmountMin:s,config:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:m}=e,d=n??await this.getAmmPoolKeys(t.id),[p,f,y]=[new De(t.mintA.address),new De(t.mintB.address),new De(t.lpMint.address)];this.logDebug("lpAmount:",o),this.logDebug("baseAmountMin:",i),this.logDebug("quoteAmountMin:",s),o.isZero()&&this.logAndCreateError("amount must greater than zero","lpAmount",o.toString());let{account:b}=this.scope,g=await b.getCreatedTokenAccount({mint:y,associatedOnly:!1});g||this.logAndCreateError("cannot found lpTokenAccount","tokenAccounts",b.tokenAccounts);let P=await b.getCreatedTokenAccount({mint:p}),w=await b.getCreatedTokenAccount({mint:f}),k=this.createTxBuilder(m),{bypassAssociatedCheck:x,checkCreateATAOwner:h}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...a},{tokenAccount:I,...S}=await b.handleTokenAccount({side:"out",amount:0,mint:p,tokenAccount:P,bypassAssociatedCheck:x,checkCreateATAOwner:h});k.addInstruction(S);let{tokenAccount:T,...K}=await b.handleTokenAccount({side:"out",amount:0,mint:f,tokenAccount:w,bypassAssociatedCheck:x,checkCreateATAOwner:h});return k.addInstruction(K),k.addInstruction({instructions:[Gs({poolInfo:t,poolKeys:d,userKeys:{lpTokenAccount:g,baseTokenAccount:I,quoteTokenAccount:T,owner:this.scope.ownerPubKey},lpAmount:o,baseAmountMin:i,quoteAmountMin:s})],lookupTableAddress:d.lookupTableAccount?[d.lookupTableAccount]:[],instructionTypes:[t.pooltype.includes("StablePool")?E.AmmV5RemoveLiquidity:E.AmmV4RemoveLiquidity]}),k.addCustomComputeBudget(u),k.addTipInstruction(l),c===0?await k.buildV0():k.build()}async removeAllLpAndCreateClmmPosition({poolInfo:e,clmmPoolInfo:t,removeLpAmount:n,createPositionInfo:o,farmInfo:i,userFarmLpAmount:s,base:a,computeBudgetConfig:c,payer:u,userAuxiliaryLedgers:l,tokenProgram:m=xn,checkCreateATAOwner:d=!0,getEphemeralSigners:p,txVersion:f,feePayer:y}){if((this.scope.availability.removeStandardPosition===!1||this.scope.availability.createConcentratedPosition===!1)&&this.logAndCreateError("remove liquidity or create position feature disabled in your region"),!(e.mintA.address===t.mintA.address||e.mintA.address===t.mintB.address)||!(e.mintB.address===t.mintA.address||e.mintB.address===t.mintB.address))throw Error("mint check error");let b=this.createTxBuilder(y),g={};for(let U of this.scope.account.tokenAccountRawInfos)(g[U.accountInfo.mint.toString()]===void 0||$(this.scope.ownerPubKey,U.accountInfo.mint,xn).publicKey.equals(U.pubkey))&&(g[U.accountInfo.mint.toString()]=U.pubkey);let P=g[e.lpMint.address];if(P===void 0)throw Error("find lp account error in trade accounts");let w=n.add(s??new Ee(0)),k=e.mintA.address===Ne.WSOL.mint.toString(),x=e.mintB.address===Ne.WSOL.mint.toString(),{account:h,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:xn,mint:new De(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:k?{payer:this.scope.ownerPubKey}:void 0,skipCloseAccount:!k,notUseTokenAccount:k,associatedOnly:!0,checkCreateATAOwner:d});if(b.addInstruction(I||{}),h===void 0)throw new Error("base token account not found");let{account:S,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:xn,mint:new De(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:x?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:!0,checkCreateATAOwner:d});if(b.addInstruction(T||{}),S===void 0)throw new Error("quote token account not found");if(g[e.mintA.address]=h,g[e.mintB.address]=S,i!==void 0&&!s?.isZero()){let U=Ct[i.programId],ee=Lt({programId:new De(i.programId),poolId:new De(i.id),owner:this.scope.ownerPubKey,version:U}),J,le=await this.scope.connection.getAccountInfo(ee);if(le&&(J=No(U).decode(le.data)),U!==6&&!J){let{instruction:ht,instructionType:zt}=vo({id:new De(i.id),programId:new De(i.programId),version:U,ledger:ee,owner:this.scope.ownerPubKey});b.addInstruction({instructions:[ht],instructionTypes:[zt]})}let oe=[];for(let ht of i.rewardInfos){let zt=ht.mint.address===Ne.WSOL.mint.toString();if(g[ht.mint.address])oe.push(g[ht.mint.address]);else{let{account:nn,instructionParams:it}=await this.scope.account.getOrCreateTokenAccount({mint:new De(ht.mint.address),tokenProgram:m,owner:this.scope.ownerPubKey,skipCloseAccount:!zt,createInfo:{payer:u||this.scope.ownerPubKey},associatedOnly:!0,checkCreateATAOwner:d});nn||this.logAndCreateError("farm reward account not found:",ht.mint.address),it&&b.addInstruction(it),oe.push(nn)}}let fe=(await this.scope.api.fetchFarmKeysById({ids:i.id}))[0],ot={userAuxiliaryLedgers:l,amount:s,owner:this.scope.ownerPubKey,farmInfo:i,farmKeys:fe,lpAccount:P,rewardAccounts:oe},Ge=Ct[i.programId],ze=Ge===6?Mo(ot):Ge===5?_o(ot):Eo(ot),bt={3:E.FarmV3Withdraw,5:E.FarmV5Withdraw,6:E.FarmV6Withdraw};b.addInstruction({instructions:[ze],instructionTypes:[bt[Ge]]})}let K=await this.getAmmPoolKeys(e.id),R=Gs({poolInfo:e,poolKeys:K,userKeys:{lpTokenAccount:P,baseTokenAccount:h,quoteTokenAccount:S,owner:this.scope.ownerPubKey},lpAmount:w,baseAmountMin:0,quoteAmountMin:0});b.addInstruction({instructions:[R],instructionTypes:[e.pooltype.includes("StablePool")?E.AmmV5RemoveLiquidity:E.AmmV4RemoveLiquidity],lookupTableAddress:K.lookupTableAccount?[K.lookupTableAccount]:[]});let[N,v]=e.mintA.address===t.mintA.address?[h,S]:[S,h],W=await this.scope.clmm.getClmmPoolKeys(t.id),D=await Ie.openPositionFromBaseInstructions({poolInfo:t,poolKeys:W,ownerInfo:{feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:N,tokenAccountB:v},withMetadata:"create",...o,base:a,getEphemeralSigners:p});return b.addInstruction({instructions:[...D.instructions],signers:D.signers,instructionTypes:[...D.instructionTypes],lookupTableAddress:W.lookupTableAccount?[W.lookupTableAccount]:[]}),f===0?b.sizeCheckBuildV0({computeBudgetConfig:c}):b.sizeCheckBuild({computeBudgetConfig:c})}async createPoolV4({programId:e,marketInfo:t,baseMintInfo:n,quoteMintInfo:o,baseAmount:i,quoteAmount:s,startTime:a,ownerInfo:c,associatedOnly:u=!1,checkCreateATAOwner:l=!1,tokenProgram:m,txVersion:d,feeDestinationId:p,computeBudgetConfig:f,txTipConfig:y,feePayer:b}){let g=c.feePayer||this.scope.owner?.publicKey,P=c.useSOLBalance&&n.mint.equals(pr),w=c.useSOLBalance&&o.mint.equals(pr),k=this.createTxBuilder(b),{account:x,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({mint:n.mint,owner:this.scope.ownerPubKey,createInfo:P?{payer:g,amount:i}:void 0,notUseTokenAccount:P,skipCloseAccount:!P,associatedOnly:P?!1:u,checkCreateATAOwner:l});k.addInstruction(h||{});let{account:I,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({mint:o.mint,owner:this.scope.ownerPubKey,createInfo:w?{payer:g,amount:s}:void 0,notUseTokenAccount:w,skipCloseAccount:!w,associatedOnly:w?!1:u,checkCreateATAOwner:l});if(k.addInstruction(S||{}),x===void 0||I===void 0)throw Error("you don't has some token account");let T=Hs({version:4,marketVersion:3,marketId:t.marketId,baseMint:n.mint,quoteMint:o.mint,baseDecimals:n.decimals,quoteDecimals:o.decimals,programId:e,marketProgramId:t.programId}),K={programId:e,ammId:T.id,ammAuthority:T.authority,ammOpenOrders:T.openOrders,lpMint:T.lpMint,coinMint:T.baseMint,pcMint:T.quoteMint,coinVault:T.baseVault,pcVault:T.quoteVault,withdrawQueue:T.withdrawQueue,ammTargetOrders:T.targetOrders,poolTempLp:T.lpVault,marketProgramId:T.marketProgramId,marketId:T.marketId,ammConfigId:T.configId,feeDestinationId:p},{instruction:R,instructionType:N}=Xs({...K,userWallet:this.scope.ownerPubKey,userCoinVault:x,userPcVault:I,userLpVault:$(this.scope.ownerPubKey,T.lpMint,m).publicKey,nonce:T.nonce,openTime:a,coinAmount:i,pcAmount:s});return k.addInstruction({instructions:[R],instructionTypes:[N]}),k.addCustomComputeBudget(f),k.addTipInstruction(y),k.versionBuild({txVersion:d,extInfo:{address:K}})}async createMarketAndPoolV4({programId:e=Oi,marketProgram:t=Xa,feeDestinationId:n=za,tokenProgram:o,baseMintInfo:i,quoteMintInfo:s,baseAmount:a,quoteAmount:c,startTime:u,ownerInfo:l,lowestFeeMarket:m,assignSeed:d,associatedOnly:p=!1,checkCreateATAOwner:f=!1,lotSize:y=1,tickSize:b=.01,txVersion:g,computeBudgetConfig:P,txTipConfig:w,feePayer:k}){let x=this.scope.ownerPubKey,h=l.feePayer||this.scope.owner?.publicKey,I=l.useSOLBalance&&i.mint.equals(pr),S=l.useSOLBalance&&s.mint.equals(pr),T=d?`${i.mint.toBase58().slice(0,7)}-${s.mint.toBase58().slice(0,7)}-${d}`:void 0,K=Fe({fromPublicKey:x,programId:t,assignSeed:T&&`${T}-market`}),R=Fe({fromPublicKey:x,programId:t,assignSeed:T&&`${T}-request`}),N=Fe({fromPublicKey:x,programId:t,assignSeed:T&&`${T}-event`}),v=Fe({fromPublicKey:x,programId:t,assignSeed:T&&`${T}-bids`}),W=Fe({fromPublicKey:x,programId:t,assignSeed:T&&`${T}-asks`}),D=Fe({fromPublicKey:x,programId:xn,assignSeed:T&&`${T}-baseVault`}),U=Fe({fromPublicKey:x,programId:xn,assignSeed:T&&`${T}-quoteVault`}),ee=0,J=new Ee(100);function le(){let Ht=new Ee(0);for(;;)try{return{vaultOwner:De.createProgramAddressSync([K.publicKey.toBuffer(),Ht.toArrayLike(Buffer,"le",8)],t),vaultSignerNonce:Ht}}catch{if(Ht.iaddn(1),Ht.gt(new Ee(25555)))throw Error("find vault owner error")}}let{vaultOwner:oe,vaultSignerNonce:fe}=le(),ot=new Ee(Math.round(10**i.decimals*y)),Ge=new Ee(Math.round(y*10**s.decimals*b));if(ot.eq(At))throw Error("lot size is too small");if(Ge.eq(At))throw Error("tick size or lot size is too small");let ze=await dr({connection:this.scope.connection,wallet:this.scope.ownerPubKey,marketInfo:{programId:t,vaultOwner:oe,baseMint:i.mint,quoteMint:s.mint,id:K,baseVault:D,quoteVault:U,requestQueue:R,eventQueue:N,bids:v,asks:W,feeRateBps:ee,quoteDustThreshold:J,vaultSignerNonce:fe,baseLotSize:ot,quoteLotSize:Ge,lowestFeeMarket:m}}),bt=this.createTxBuilder(k);bt.addInstruction({instructions:ze[0].transaction.instructions,signers:ze[0].signer});for await(let Ht of ze.slice(1,ze.length))bt.addInstruction({instructions:Ht.transaction.instructions,signers:Ht.signer,instructionTypes:Ht.instructionTypes});let{account:ht,instructionParams:zt}=await this.scope.account.getOrCreateTokenAccount({mint:i.mint,owner:this.scope.ownerPubKey,createInfo:I?{payer:h,amount:a}:void 0,notUseTokenAccount:I,skipCloseAccount:!I,associatedOnly:I?!1:p,checkCreateATAOwner:f,assignSeed:I&&T?`${T}-wsol`:void 0});bt.addInstruction(zt||{});let{account:nn,instructionParams:it}=await this.scope.account.getOrCreateTokenAccount({mint:s.mint,owner:this.scope.ownerPubKey,createInfo:S?{payer:h,amount:c}:void 0,notUseTokenAccount:S,skipCloseAccount:!S,associatedOnly:S?!1:p,checkCreateATAOwner:f,assignSeed:S&&T?`${T}-wsol`:void 0});if(bt.addInstruction(it||{}),ht===void 0)throw Error("you don't has base token account");if(nn===void 0)throw Error("you don't has quote token account");let He=Hs({version:4,marketVersion:3,marketId:K.publicKey,baseMint:i.mint,quoteMint:s.mint,baseDecimals:i.decimals,quoteDecimals:s.decimals,programId:e,marketProgramId:t}),Mr={programId:e,ammId:He.id,ammAuthority:He.authority,ammOpenOrders:He.openOrders,lpMint:He.lpMint,coinMint:He.baseMint,pcMint:He.quoteMint,coinVault:He.baseVault,pcVault:He.quoteVault,withdrawQueue:He.withdrawQueue,ammTargetOrders:He.targetOrders,poolTempLp:He.lpVault,marketProgramId:He.marketProgramId,marketId:He.marketId,ammConfigId:He.configId,feeDestinationId:n},{instruction:Hc,instructionType:jc}=Xs({...Mr,userWallet:this.scope.ownerPubKey,userCoinVault:ht,userPcVault:nn,userLpVault:$(this.scope.ownerPubKey,He.lpMint,o).publicKey,nonce:He.nonce,openTime:u,coinAmount:a,pcAmount:c});bt.addInstruction({instructions:[Hc],instructionTypes:[jc]});let la=I||S?[zt?.instructions?.[0]||it?.instructions?.[0]].filter(Ht=>!!Ht):void 0;return g===0?bt.sizeCheckBuildV0({computeBudgetConfig:P,splitIns:la,address:{requestQueue:R.publicKey,eventQueue:N.publicKey,bids:v.publicKey,asks:W.publicKey,baseVault:D.publicKey,quoteVault:U.publicKey,baseMint:new De(i.mint),quoteMint:new De(s.mint),...Mr}}):bt.sizeCheckBuild({computeBudgetConfig:P,splitIns:la,address:{requestQueue:R.publicKey,eventQueue:N.publicKey,bids:v.publicKey,asks:W.publicKey,baseVault:D.publicKey,quoteVault:U.publicKey,baseMint:new De(i.mint),quoteMint:new De(s.mint),...Mr}})}async getCreatePoolFee({programId:e}){let t=lr({programId:e}),n=await this.scope.connection.getAccountInfo(t,{dataSlice:{offset:536,length:8}});if(n===null)throw Error("get config account error");return tc.decode(n.data).fee}computeAmountOut({poolInfo:e,amountIn:t,mintIn:n,mintOut:o,slippage:i}){let[s,a]=[n.toString(),o.toString()];if(s!==e.mintA.address&&s!==e.mintB.address)throw new Error("toke not match");if(a!==e.mintA.address&&a!==e.mintB.address)throw new Error("toke not match");let{baseReserve:c,quoteReserve:u}=e,l=[c,u],m=[e.mintA.decimals,e.mintB.decimals],d=s==e.mintA.address?"base":"quote";d==="quote"&&(l.reverse(),m.reverse());let[p,f]=l,[y,b]=m,g=e.version===4,P;if(g)P=new L(f.toString()).div(10**b).div(new L(p.toString()).div(10**y));else{let N=sc(this.stableLayout.stableModelData,c.toNumber(),u.toNumber(),!1);d==="quote"?P=new L(1e6).div(N*1e6):P=new L(N*1e6).div(1e6)}let w=t,k=new Ee(0),x=new Ee(0);if(!w.isZero())if(g){x=Pn(w.mul(Fs),ur);let N=w.sub(x),v=p.add(N);k=f.mul(N).div(v)}else{x=w.mul(new Ee(2)).div(new Ee(1e4));let N=w.sub(x);d==="quote"?k=new Ee(ic(this.stableLayout.stableModelData,u.toNumber(),c.toNumber(),N.toNumber())):k=new Ee(rc(this.stableLayout.stableModelData,u.toNumber(),c.toNumber(),N.toNumber()))}let h=new Ee(new L(k.toString()).mul(1-i).toFixed(0)),I=k,S=h,T=new L(k.toString()).div(new L(w.sub(x).toString()).toFixed(0));!w.isZero()&&!k.isZero()&&(T=new L(k.toString()).div(10**b).div(new L(w.sub(x).toString()).div(10**y)));let K=P.sub(T).div(P).mul(100);return{amountOut:I,minAmountOut:S,currentPrice:P,executionPrice:T,priceImpact:K,fee:x}}computeAmountIn({poolInfo:e,amountOut:t,mintIn:n,mintOut:o,slippage:i}){let{baseReserve:s,quoteReserve:a}=e;n.toString()!==e.mintA.address&&n.toString()!==e.mintB.address&&this.logAndCreateError("mintIn does not match pool"),o.toString()!==e.mintA.address&&o.toString()!==e.mintB.address&&this.logAndCreateError("mintOut does not match pool"),this.logDebug("baseReserve:",s.toString()),this.logDebug("quoteReserve:",a.toString());let c=n.toString()===e.mintA.address,[u,l]=c?[e.mintA,e.mintB]:[e.mintB,e.mintA];this.logDebug("currencyOut:",l.symbol||l.address),this.logDebug("amountOut:",new L(t.toString()).div(10**l.decimals).toDecimalPlaces(l.decimals).toString(),u.symbol||u.address),this.logDebug("slippage:",`${i*100}%`);let m=[s,a],d=c?"quote":"base";d==="base"&&m.reverse(),this.logDebug("output side:",d);let[p,f]=m,y=new L(f.toString()).div(10**e[c?"mintB":"mintA"].decimals).div(new L(p.toString()).div(10**e[c?"mintA":"mintB"].decimals));this.logDebug("currentPrice:",`1 ${u.symbol||u.address} \u2248 ${y.toString()} ${l.symbol||l.address}`),this.logDebug("currentPrice invert:",`1 ${l.symbol||l.address} \u2248 ${new L(1).div(y).toString()} ${u.symbol||u.address}`);let b=new Ee(0),g=t;if(!g.isZero()){g.gt(f)&&(g=f.sub(new Ee(1)));let S=f.sub(g);b=p.mul(g).div(S).mul(ur).div(ur.sub(Fs))}let P=new Ee(new L(b.toString()).mul(1+i).toFixed(0)),w=b,k=P;this.logDebug("amountIn:",new L(w.toString()).div(10**u.decimals).toDecimalPlaces(u.decimals).toString()),this.logDebug("maxAmountIn:",new L(k.toString()).div(10**u.decimals).toDecimalPlaces(u.decimals).toString());let x=null;!b.isZero()&&!g.isZero()&&(x=new L(g.toString()).div(10**l.decimals).div(new L(b.toString()).div(10**u.decimals)),this.logDebug("executionPrice:",`1 ${l.symbol||l.address} \u2248 ${x.toDecimalPlaces(Math.max(e.mintA.decimals,e.mintB.decimals)).toString()} ${u.symbol||u.address}`),this.logDebug("executionPrice invert:",`1 ${l.symbol||l.address} \u2248 ${new L(1).div(x).toDecimalPlaces(Math.max(e.mintA.decimals,e.mintB.decimals)).toString()} ${u.symbol||u.address}`));let h=y.mul(w.toString()),I=h.sub(t.toString()).abs().div(h);return this.logDebug("priceImpact:",`${I.toString()}%`),{amountIn:w,maxAmountIn:k,currentPrice:y,executionPrice:x,priceImpact:I}}async swap({poolInfo:e,poolKeys:t,amountIn:n,amountOut:o,inputMint:i,fixedSide:s,txVersion:a,config:c,computeBudgetConfig:u,txTipConfig:l,feePayer:m}){let d=this.createTxBuilder(m),{associatedOnly:p=!0,inputUseSolBalance:f=!0,outputUseSolBalance:y=!0}=c||{},[b,g]=i===e.mintA.address?[e.mintA,e.mintB]:[e.mintB,e.mintA],P=f&&b.address===H.toBase58(),w=y&&g.address===H.toBase58(),{account:k,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:xn,mint:new De(b.address),owner:this.scope.ownerPubKey,createInfo:P?{payer:this.scope.ownerPubKey,amount:n}:void 0,skipCloseAccount:!P,notUseTokenAccount:P,associatedOnly:p});d.addInstruction(x||{}),k||this.logAndCreateError("input token account not found",{token:b.symbol||b.address,tokenAccountIn:k,inputTokenUseSolBalance:P,associatedOnly:p});let{account:h,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:xn,mint:new De(g.address),owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!w,notUseTokenAccount:w,associatedOnly:w?!1:p});d.addInstruction(I||{}),h===void 0&&this.logAndCreateError("output token account not found",{token:g.symbol||g.address,tokenAccountOut:h,outputTokenUseSolBalance:w,associatedOnly:p});let S=t||await this.getAmmPoolKeys(e.id),T=4;return e.pooltype.includes("StablePool")&&(T=5),d.addInstruction({instructions:[cr({version:T,poolKeys:S,userKeys:{tokenAccountIn:k,tokenAccountOut:h,owner:this.scope.ownerPubKey},amountIn:n,amountOut:o,fixedSide:s})],instructionTypes:[T===4?E.AmmV4SwapBaseIn:E.AmmV5SwapBaseIn]}),d.addCustomComputeBudget(u),d.addTipInstruction(l),d.versionBuild({txVersion:a})}async getRpcPoolInfo(e){return(await this.getRpcPoolInfos([e]))[e]}async getRpcPoolInfos(e,t){let n=await xe(this.scope.connection,e.map(u=>({pubkey:new De(u)})),t),o={},i=[];for(let u=0;u<e.length;u++){let l=n[u];if(l===null||!l.accountInfo)throw Error("fetch pool info error: "+String(e[u]));let m=Yo.decode(l.accountInfo.data);o[String(e[u])]={...m,programId:l.accountInfo.owner},i.push(m.baseVault,m.quoteVault)}let s={},a=await xe(this.scope.connection,i.map(u=>({pubkey:new De(u)})),t);for(let u=0;u<i.length;u++){let l=a[u].accountInfo;if(l===null)throw Error("fetch vault info error: "+i[u]);s[String(i[u])]=new Ee(Bp.decode(l.data).amount.toString())}let c={};for(let[u,l]of Object.entries(o)){let m=s[l.baseVault.toString()].sub(l.baseNeedTakePnl),d=s[l.quoteVault.toString()].sub(l.quoteNeedTakePnl);c[u]={...l,baseReserve:m,mintAAmount:s[l.baseVault.toString()],mintBAmount:s[l.quoteVault.toString()],quoteReserve:d,poolPrice:new L(d.toString()).div(new L(10).pow(l.quoteDecimal.toString())).div(new L(m.toString()).div(new L(10).pow(l.baseDecimal.toString())))}}return c}async getPoolInfoFromRpc({poolId:e}){let t=await this.getRpcPoolInfo(e),n=mr({[e]:t}),o=n[e],i=await this.scope.tradeV2.computePoolToPoolKeys({pools:[n[e]],ammRpcData:{[e]:t}});return{poolRpcData:t,poolInfo:o,poolKeys:i[0]}}};import{PublicKey as Q}from"@solana/web3.js";import Pt from"bn.js";import{AccountLayout as fc,TOKEN_2022_PROGRAM_ID as Sn,TOKEN_PROGRAM_ID as ni}from"@solana/spl-token";var oi=class extends Ke{constructor(e){super(e)}async getClmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async createPool(e){let{programId:t,owner:n=this.scope.owner?.publicKey||Q.default,mint1:o,mint2:i,ammConfig:s,initialPrice:a,computeBudgetConfig:c,forerunCreate:u,getObserveState:l,txVersion:m,txTipConfig:d,feePayer:p}=e,f=this.createTxBuilder(p),[y,b,g]=new Pt(new Q(o.address).toBuffer()).gt(new Pt(new Q(i.address).toBuffer()))?[i,o,new L(1).div(a)]:[o,i,a],P=ie.priceToSqrtPriceX64(g,y.decimals,b.decimals),w=[],k=[];y.programId===Sn.toBase58()&&k.push(Os(t,new Q(y.address)).publicKey),b.programId===Sn.toBase58()&&k.push(Os(t,new Q(b.address)).publicKey),(await this.scope.connection.getMultipleAccountsInfo(k)).forEach((I,S)=>{I&&w.push(k[S])});let h=await Ie.createPoolInstructions({connection:this.scope.connection,programId:t,owner:n,mintA:y,mintB:b,ammConfigId:s.id,initialPriceX64:P,forerunCreate:!l&&u,extendMintAccount:w});return f.addInstruction(h),f.addCustomComputeBudget(c),f.addTipInstruction(d),f.versionBuild({txVersion:m,extInfo:{address:{...h.address,observationId:h.address.observationId.toBase58(),exBitmapAccount:h.address.exBitmapAccount.toBase58(),programId:t.toString(),id:h.address.poolId.toString(),mintA:y,mintB:b,openTime:"0",vault:{A:h.address.mintAVault.toString(),B:h.address.mintBVault.toString()},rewardInfos:[],config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]}},mockPoolInfo:{type:"Concentrated",rewardDefaultPoolInfos:"Clmm",id:h.address.poolId.toString(),mintA:y,mintB:b,feeRate:s.tradeFeeRate,openTime:"0",programId:t.toString(),price:g.toNumber(),config:{id:s.id.toString(),index:s.index,protocolFeeRate:s.protocolFeeRate,tradeFeeRate:s.tradeFeeRate,tickSpacing:s.tickSpacing,fundFeeRate:s.fundFeeRate,description:s.description,defaultRange:0,defaultRangePoint:[]},burnPercent:0,...Eu},forerunCreate:u}})}async openPositionFromBase({poolInfo:e,poolKeys:t,ownerInfo:n,tickLower:o,tickUpper:i,base:s,baseAmount:a,otherAmountMax:c,nft2022:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,withMetadata:d="create",getEphemeralSigners:p,computeBudgetConfig:f,txTipConfig:y,txVersion:b,feePayer:g}){this.scope.availability.addConcentratedPosition===!1&&this.logAndCreateError("add position feature disabled in your region"),this.scope.checkOwner();let P=this.createTxBuilder(g),w=null,k=null,x=n.useSOLBalance&&e.mintA.address===H.toString(),h=n.useSOLBalance&&e.mintB.address===H.toString(),[I,S]=s==="MintA"?[a,c]:[c,a],{account:T,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new Q(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:x||I.isZero()?{payer:this.scope.ownerPubKey,amount:I}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:x?!1:l,checkCreateATAOwner:m});T&&(w=T),P.addInstruction(K||{});let{account:R,instructionParams:N}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new Q(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:h||S.isZero()?{payer:this.scope.ownerPubKey,amount:S}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:h?!1:l,checkCreateATAOwner:m});R&&(k=R),P.addInstruction(N||{}),(!w||!k)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",{ownerTokenAccountA:w?.toBase58(),ownerTokenAccountB:k?.toBase58()});let v=t||await this.getClmmPoolKeys(e.id),W=await Ie.openPositionFromBaseInstructions({poolInfo:e,poolKeys:v,ownerInfo:{...n,feePayer:this.scope.ownerPubKey,wallet:this.scope.ownerPubKey,tokenAccountA:w,tokenAccountB:k},tickLower:o,tickUpper:i,base:s,baseAmount:a,otherAmountMax:c,withMetadata:d,getEphemeralSigners:p,nft2022:u});return P.addInstruction(W),P.addCustomComputeBudget(f),P.addTipInstruction(y),P.versionBuild({txVersion:b,extInfo:{...W.address}})}async openPositionFromLiquidity({poolInfo:e,poolKeys:t,ownerInfo:n,amountMaxA:o,amountMaxB:i,tickLower:s,tickUpper:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,withMetadata:m="create",txVersion:d,computeBudgetConfig:p,txTipConfig:f,getEphemeralSigners:y,nft2022:b,feePayer:g}){this.scope.availability.createConcentratedPosition===!1&&this.logAndCreateError("open position feature disabled in your region");let P=this.createTxBuilder(g),w=null,k=null,x=n.useSOLBalance&&e.mintA.address===H.toBase58(),h=n.useSOLBalance&&e.mintB.address===H.toBase58(),{account:I,instructionParams:S}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new Q(e.mintA.address),owner:this.scope.ownerPubKey,createInfo:x||o.isZero()?{payer:this.scope.ownerPubKey,amount:o}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:x?!1:u,checkCreateATAOwner:l});I&&(w=I),P.addInstruction(S||{});let{account:T,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new Q(e.mintB.address),owner:this.scope.ownerPubKey,createInfo:h||i.isZero()?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:h?!1:u,checkCreateATAOwner:l});T&&(k=T),P.addInstruction(K||{}),(w===void 0||k===void 0)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let R=t||await this.getClmmPoolKeys(e.id),N=await Ie.openPositionFromLiquidityInstructions({poolInfo:e,poolKeys:R,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:w,tokenAccountB:k},tickLower:s,tickUpper:a,liquidity:c,amountMaxA:o,amountMaxB:i,withMetadata:m,getEphemeralSigners:y,nft2022:b});return P.addInstruction(N),P.addCustomComputeBudget(p),P.addTipInstruction(f),P.versionBuild({txVersion:d,extInfo:{address:N.address}})}async increasePositionFromLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:o,amountMaxA:i,amountMaxB:s,liquidity:a,ownerInfo:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txTipConfig:d,txVersion:p,feePayer:f}=e,y=this.createTxBuilder(f),b,g,P=c.useSOLBalance&&t.mintA.address===H.toString(),w=c.useSOLBalance&&t.mintB.address===H.toString(),{account:k,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Q(t.mintA.address),notUseTokenAccount:P,owner:this.scope.ownerPubKey,createInfo:P||i.isZero()?{payer:this.scope.ownerPubKey,amount:i}:void 0,skipCloseAccount:!P,associatedOnly:P?!1:u,checkCreateATAOwner:l});k&&(b=k),y.addInstruction(x||{});let{account:h,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Q(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:w||s.isZero()?{payer:this.scope.ownerPubKey,amount:s}:void 0,notUseTokenAccount:w,skipCloseAccount:!w,associatedOnly:w?!1:u,checkCreateATAOwner:l});h&&(g=h),y.addInstruction(I||{}),!b&&!g&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let S=n??await this.getClmmPoolKeys(t.id),T=Ie.increasePositionFromLiquidityInstructions({poolInfo:t,poolKeys:S,ownerPosition:o,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:b,tokenAccountB:g},liquidity:a,amountMaxA:i,amountMaxB:s,nft2022:(await this.scope.connection.getAccountInfo(o.nftMint))?.owner.equals(Sn)});return y.addInstruction(T),y.addCustomComputeBudget(m),y.addTipInstruction(d),y.versionBuild({txVersion:p,extInfo:{address:T.address}})}async increasePositionFromBase(e){let{poolInfo:t,ownerPosition:n,base:o,baseAmount:i,otherAmountMax:s,ownerInfo:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:m,txVersion:d,feePayer:p}=e,f=this.createTxBuilder(p),y,b,g=a.useSOLBalance&&t.mintA.address===H.toString(),P=a.useSOLBalance&&t.mintB.address===H.toString(),{account:w,instructionParams:k}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Q(t.mintA.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:g||(o==="MintA"?i:s).isZero()?{payer:this.scope.ownerPubKey,amount:o==="MintA"?i:s}:void 0,skipCloseAccount:!g,associatedOnly:g?!1:c,checkCreateATAOwner:u});w&&(y=w),f.addInstruction(k||{});let{account:x,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Q(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:P||(o==="MintA"?s:i).isZero()?{payer:this.scope.ownerPubKey,amount:o==="MintA"?s:i}:void 0,notUseTokenAccount:P,skipCloseAccount:!P,associatedOnly:P?!1:c,checkCreateATAOwner:u});x&&(b=x),f.addInstruction(h||{}),!y&&!b&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccounts);let I=await this.getClmmPoolKeys(t.id),S=Ie.increasePositionFromBaseInstructions({poolInfo:t,poolKeys:I,ownerPosition:n,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:y,tokenAccountB:b},base:o,baseAmount:i,otherAmountMax:s,nft2022:(await this.scope.connection.getAccountInfo(n.nftMint))?.owner.equals(Sn)});return f.addInstruction(S),f.addCustomComputeBudget(l),f.addTipInstruction(m),f.versionBuild({txVersion:d,extInfo:{address:S.address}})}async decreaseLiquidity(e){let{poolInfo:t,poolKeys:n,ownerPosition:o,ownerInfo:i,amountMinA:s,amountMinB:a,liquidity:c,associatedOnly:u=!0,checkCreateATAOwner:l=!1,computeBudgetConfig:m,txTipConfig:d,txVersion:p,feePayer:f}=e;this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let y=this.createTxBuilder(f),b=i.useSOLBalance&&t.mintA.address===H.toString(),g=i.useSOLBalance&&t.mintB.address===H.toString(),P,w,{account:k,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new Q(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!b,associatedOnly:b?!1:u,checkCreateATAOwner:l});P=k,x&&y.addInstruction(x);let{account:h,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new Q(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!g,associatedOnly:g?!1:u,checkCreateATAOwner:l});w=h,I&&y.addInstruction(I);let S=[];for(let v of t.rewardDefaultInfos){let W=i.useSOLBalance&&v.mint.address===H.toString(),D;if(v.mint.address===t.mintA.address)D=P;else if(v.mint.address===t.mintB.address)D=w;else{let{account:U,instructionParams:ee}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(v.mint.programId),mint:new Q(v.mint.address),notUseTokenAccount:W,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!W,associatedOnly:W?!1:u,checkCreateATAOwner:l});D=U,ee&&y.addInstruction(ee)}S.push(D)}!P&&!w&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",this.scope.account.tokenAccountRawInfos);let T=n??await this.getClmmPoolKeys(t.id),K=(await this.scope.connection.getAccountInfo(o.nftMint))?.owner.equals(Sn),R=await Ie.decreaseLiquidityInstructions({poolInfo:t,poolKeys:T,ownerPosition:o,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:P,tokenAccountB:w,rewardAccounts:S},liquidity:c,amountMinA:s,amountMinB:a,nft2022:K});y.addInstruction({instructions:R.instructions,instructionTypes:[E.ClmmDecreasePosition]});let N={...R.address};if(i.closePosition){let v=await Ie.closePositionInstructions({poolInfo:t,poolKeys:T,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:o,nft2022:K});y.addInstruction({endInstructions:v.instructions,endInstructionTypes:v.instructionTypes}),N={...N,...v.address}}return y.addCustomComputeBudget(m),y.addTipInstruction(d),y.versionBuild({txVersion:p,extInfo:{address:N}})}async lockPosition(e){let{programId:t=Io,authProgramId:n=vi,poolProgramId:o=On,ownerPosition:i,payer:s,computeBudgetConfig:a,txTipConfig:c,txVersion:u,getEphemeralSigners:l,feePayer:m}=e,d=this.createTxBuilder(m),p=await Ie.makeLockPositions({programId:t,authProgramId:n,poolProgramId:o,wallet:this.scope.ownerPubKey,payer:s??this.scope.ownerPubKey,nftMint:i.nftMint,getEphemeralSigners:l,nft2022:(await this.scope.connection.getAccountInfo(i.nftMint))?.owner.equals(Sn)});return d.addInstruction(p),d.addCustomComputeBudget(a),d.addTipInstruction(c),d.versionBuild({txVersion:u,extInfo:p.address})}async harvestLockPosition(e){let{programId:t=Io,authProgramId:n=vi,clmmProgram:o=On,poolKeys:i,lockData:s,ownerInfo:a={useSOLBalance:!0},associatedOnly:c=!0,checkCreateATAOwner:u=!1,computeBudgetConfig:l,txTipConfig:m,txVersion:d,feePayer:p}=e,f=i||await this.getClmmPoolKeys(s.poolId.toString()),y=this.createTxBuilder(p),b=await this.scope.connection.getAccountInfo(s.positionId);b||this.logger.logWithError("position not found",s.positionId);let g=zo.decode(b.data),P=a.useSOLBalance&&f.mintA.address===H.toString(),w=a.useSOLBalance&&f.mintB.address===H.toString(),k,x,{account:h,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:f.mintA.programId,mint:new Q(f.mintA.address),notUseTokenAccount:P,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!P,associatedOnly:P?!1:c,checkCreateATAOwner:u});k=h,I&&y.addInstruction(I);let{account:S,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:f.mintB.programId,mint:new Q(f.mintB.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!w,associatedOnly:w?!1:c,checkCreateATAOwner:u});x=S,T&&y.addInstruction(T);let K={},R=[];for(let fe of f.rewardInfos){let ot=a.useSOLBalance&&fe.mint.address===H.toString(),Ge=K[fe.mint.address];if(!Ge){let{account:ze,instructionParams:bt}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(fe.mint.programId),mint:new Q(fe.mint.address),notUseTokenAccount:ot,owner:this.scope.ownerPubKey,skipCloseAccount:!ot,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:ot?!1:c});Ge=ze,bt&&y.addInstruction(bt)}K[fe.mint.address]=Ge,R.push(Ge)}let N=Uo(t,s.lockNftMint).publicKey,v=$(this.scope.ownerPubKey,s.lockNftMint,ni).publicKey,W=z.getTickArrayStartIndexByTick(g.tickLower,f.config.tickSpacing),D=z.getTickArrayStartIndexByTick(g.tickUpper,f.config.tickSpacing),{publicKey:U}=be(new Q(f.programId),s.poolId,W),{publicKey:ee}=be(new Q(f.programId),s.poolId,D),{publicKey:J}=Qt(new Q(f.programId),s.poolId,g.tickLower,g.tickUpper),le=[];for(let fe=0;fe<f.rewardInfos.length;fe++)le.push({poolRewardVault:new Q(f.rewardInfos[fe].vault),ownerRewardVault:R[fe],rewardMint:new Q(f.rewardInfos[fe].mint.address)});let oe=await Ie.harvestLockPositionInstructionV2({programId:t,auth:n,lockPositionId:N,clmmProgram:o,lockOwner:this.scope.ownerPubKey,lockNftMint:s.lockNftMint,lockNftAccount:v,positionNftAccount:s.nftAccount,positionId:s.positionId,poolId:s.poolId,protocolPosition:J,vaultA:new Q(f.vault.A),vaultB:new Q(f.vault.B),tickArrayLower:U,tickArrayUpper:ee,userVaultA:k,userVaultB:x,mintA:new Q(f.mintA.address),mintB:new Q(f.mintB.address),rewardAccounts:le,exTickArrayBitmap:Ve(o,s.poolId).publicKey});return y.addInstruction({instructions:[oe],instructionTypes:[E.ClmmHarvestLockPosition]}),y.addCustomComputeBudget(l),y.addTipInstruction(m),y.versionBuild({txVersion:d})}async closePosition({poolInfo:e,poolKeys:t,ownerPosition:n,txVersion:o,computeBudgetConfig:i,txTipConfig:s,feePayer:a}){this.scope.availability.removeConcentratedPosition===!1&&this.logAndCreateError("remove position feature disabled in your region");let c=this.createTxBuilder(a),u=t??await this.getClmmPoolKeys(e.id),l=Ie.closePositionInstructions({poolInfo:e,poolKeys:u,ownerInfo:{wallet:this.scope.ownerPubKey},ownerPosition:n,nft2022:(await this.scope.connection.getAccountInfo(n.nftMint))?.owner.equals(Sn)});return c.addCustomComputeBudget(i),c.addTipInstruction(s),c.addInstruction(l).versionBuild({txVersion:o,extInfo:{address:l.address}})}async initReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:o=!0,checkCreateATAOwner:i=!1,computeBudgetConfig:s,txVersion:a,feePayer:c}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let u=this.createTxBuilder(c),l=t.useSOLBalance&&n.mint.address.toString()===H.toString(),m=n.perSecond.mul(n.endTime-n.openTime),{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(n.mint.address),mint:new Q(n.mint.address),notUseTokenAccount:!!l,skipCloseAccount:!l,owner:this.scope.ownerPubKey,createInfo:l?{payer:t.feePayer||this.scope.ownerPubKey,amount:new Pt(new L(m.toFixed(0)).gte(m)?m.toFixed(0):m.add(1).toFixed(0))}:void 0,associatedOnly:l?!1:o,checkCreateATAOwner:i});p&&u.addInstruction(p),d||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=await this.getClmmPoolKeys(e.id),y=Ie.initRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:d},rewardInfo:{programId:new Q(n.mint.programId),mint:new Q(n.mint.address),openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:re.decimalToX64(n.perSecond)}});return u.addInstruction(y),u.addCustomComputeBudget(s),u.versionBuild({txVersion:a,extInfo:{address:y.address}})}async initRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:o,associatedOnly:i=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){for(let p of o)p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let m=this.createTxBuilder(l),d={};for(let p of o){let f=n.useSOLBalance&&p.mint.address===H.toString(),y=p.perSecond.mul(p.endTime-p.openTime),{account:b,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(p.mint.programId),mint:new Q(p.mint.address),notUseTokenAccount:!!f,skipCloseAccount:!f,owner:this.scope.ownerPubKey,createInfo:f?{payer:n.feePayer||this.scope.ownerPubKey,amount:new Pt(new L(y.toFixed(0)).gte(y)?y.toFixed(0):y.add(1).toFixed(0))}:void 0,associatedOnly:f?!1:i,checkCreateATAOwner:s});g&&m.addInstruction(g),b||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let P=t??await this.getClmmPoolKeys(e.id),w=Ie.initRewardInstructions({poolInfo:e,poolKeys:P,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:b},rewardInfo:{programId:new Q(p.mint.programId),mint:new Q(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:re.decimalToX64(p.perSecond)}});d={...d,...w.address},m.addInstruction(w)}return m.addCustomComputeBudget(a),m.addTipInstruction(c),m.versionBuild({txVersion:u,extInfo:{address:d}})}async setReward({poolInfo:e,ownerInfo:t,rewardInfo:n,associatedOnly:o=!0,checkCreateATAOwner:i=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){n.endTime<=n.openTime&&this.logAndCreateError("reward time error","rewardInfo",n);let l=this.createTxBuilder(u),m=t.useSOLBalance&&n.mint.equals(H),{account:d,instructionParams:p}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:n.programId,mint:n.mint,notUseTokenAccount:m,owner:this.scope.ownerPubKey,createInfo:m?{payer:t.feePayer||this.scope.ownerPubKey,amount:new Pt(new L(n.perSecond.mul(n.endTime-n.openTime).toFixed(0)).gte(n.perSecond.mul(n.endTime-n.openTime))?n.perSecond.mul(n.endTime-n.openTime).toFixed(0):n.perSecond.mul(n.endTime-n.openTime).add(1).toFixed(0))}:void 0,associatedOnly:m?!1:o,checkCreateATAOwner:i});p&&l.addInstruction(p),d||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let f=await this.getClmmPoolKeys(e.id),y=Ie.setRewardInstructions({poolInfo:e,poolKeys:f,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:d},rewardInfo:{mint:n.mint,openTime:n.openTime,endTime:n.endTime,emissionsPerSecondX64:re.decimalToX64(n.perSecond)}});return l.addInstruction(y),l.addCustomComputeBudget(s),l.addTipInstruction(a),l.versionBuild({txVersion:c,extInfo:{address:y.address}})}async setRewards({poolInfo:e,poolKeys:t,ownerInfo:n,rewardInfos:o,associatedOnly:i=!0,checkCreateATAOwner:s=!1,computeBudgetConfig:a,txTipConfig:c,txVersion:u,feePayer:l}){let m=this.createTxBuilder(l),d={};for(let p of o){p.endTime<=p.openTime&&this.logAndCreateError("reward time error","rewardInfo",p);let f=n.useSOLBalance&&p.mint.address===H.toString(),{account:y,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(p.mint.programId),mint:new Q(p.mint.address),notUseTokenAccount:f,owner:this.scope.ownerPubKey,createInfo:f?{payer:n.feePayer||this.scope.ownerPubKey,amount:new Pt(new L(p.perSecond.mul(p.endTime-p.openTime).toFixed(0)).gte(p.perSecond.mul(p.endTime-p.openTime))?p.perSecond.mul(p.endTime-p.openTime).toFixed(0):p.perSecond.mul(p.endTime-p.openTime).add(1).toFixed(0))}:void 0,associatedOnly:f?!1:i,checkCreateATAOwner:s});b&&m.addInstruction(b),y||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let g=t??await this.getClmmPoolKeys(e.id),P=Ie.setRewardInstructions({poolInfo:e,poolKeys:g,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:y},rewardInfo:{mint:new Q(p.mint.address),openTime:p.openTime,endTime:p.endTime,emissionsPerSecondX64:re.decimalToX64(p.perSecond)}});m.addInstruction(P),d={...d,...P.address}}return m.addCustomComputeBudget(a),m.addTipInstruction(c),m.versionBuild({txVersion:u,extInfo:{address:d}})}async collectReward({poolInfo:e,ownerInfo:t,rewardMint:n,associatedOnly:o=!0,checkCreateATAOwner:i=!1,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u}){let l=e.rewardDefaultInfos.find(g=>g.mint.address===n.toString());l||this.logAndCreateError("reward mint error","not found reward mint",n);let m=this.createTxBuilder(u),d=t.useSOLBalance&&n.equals(H),{account:p,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(l.mint.programId),mint:n,notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!d,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:d?!1:o,checkCreateATAOwner:i});f&&m.addInstruction(f),p||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos);let y=await this.getClmmPoolKeys(e.id),b=Ie.collectRewardInstructions({poolInfo:e,poolKeys:y,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:p},rewardMint:n});return m.addInstruction(b),m.addCustomComputeBudget(s),m.addTipInstruction(a),m.versionBuild({txVersion:c,extInfo:{address:b.address}})}async collectRewards({poolInfo:e,ownerInfo:t,rewardMints:n,associatedOnly:o=!0,checkCreateATAOwner:i=!1,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l={};for(let m of n){let d=e.rewardDefaultInfos.find(P=>P.mint.address===m.toString());if(!d){this.logAndCreateError("reward mint error","not found reward mint",m);continue}let p=t.useSOLBalance&&m.equals(H),{account:f,instructionParams:y}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(d.mint.programId),mint:m,notUseTokenAccount:p,owner:this.scope.ownerPubKey,skipCloseAccount:!p,createInfo:{payer:t.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:p?!1:o,checkCreateATAOwner:i});f||this.logAndCreateError("no money","ownerRewardAccount",this.scope.account.tokenAccountRawInfos),y&&u.addInstruction(y);let b=await this.getClmmPoolKeys(e.id),g=Ie.collectRewardInstructions({poolInfo:e,poolKeys:b,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccount:f},rewardMint:m});u.addInstruction(g),l={...l,...g.address}}return u.addCustomComputeBudget(s),u.addTipInstruction(a),u.build({address:l})}async swap({poolInfo:e,poolKeys:t,inputMint:n,amountIn:o,amountOutMin:i,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p,txTipConfig:f,feePayer:y}){let b=this.createTxBuilder(y),g=n.toString()===e.mintA.address,P=c.useSOLBalance&&e.mintA.address===H.toBase58(),w=c.useSOLBalance&&e.mintB.address===H.toBase58(),k;!s||s.equals(new L(0))?k=g?Ot.add(new Pt(1)):vt.sub(new Pt(1)):k=ie.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let x;if(!x){let{account:S,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new Q(e.mintA.address),notUseTokenAccount:P,owner:this.scope.ownerPubKey,skipCloseAccount:!P,createInfo:P||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?o:0}:void 0,associatedOnly:P?!1:l,checkCreateATAOwner:m});x=S,T&&b.addInstruction(T)}let h;if(!h){let{account:S,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new Q(e.mintB.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,skipCloseAccount:!w,createInfo:w||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:o}:void 0,associatedOnly:w?!1:l,checkCreateATAOwner:m});h=S,T&&b.addInstruction(T)}(!x||!h)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:x,ownerTokenAccountB:h,mintAUseSOLBalance:P,mintBUseSOLBalance:w,associatedOnly:l});let I=t??await this.getClmmPoolKeys(e.id);return b.addInstruction(Ie.makeSwapBaseInInstructions({poolInfo:e,poolKeys:I,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:x,tokenAccountB:h},inputMint:new Q(n),amountIn:o,amountOutMin:i,sqrtPriceLimitX64:k,remainingAccounts:u})),b.addCustomComputeBudget(p),b.addTipInstruction(f),b.versionBuild({txVersion:d})}async swapBaseOut({poolInfo:e,poolKeys:t,outputMint:n,amountOut:o,amountInMax:i,priceLimit:s,observationId:a,ownerInfo:c,remainingAccounts:u,associatedOnly:l=!0,checkCreateATAOwner:m=!1,txVersion:d,computeBudgetConfig:p,txTipConfig:f,feePayer:y}){let b=this.createTxBuilder(y),g=n.toString()===e.mintB.address,P=c.useSOLBalance&&e.mintA.address===H.toBase58(),w=c.useSOLBalance&&e.mintB.address===H.toBase58(),k;!s||s.equals(new L(0))?k=n.toString()===e.mintB.address?Ot.add(new Pt(1)):vt.sub(new Pt(1)):k=ie.priceToSqrtPriceX64(s,e.mintA.decimals,e.mintB.decimals);let x;if(!x){let{account:S,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintA.programId,mint:new Q(e.mintA.address),notUseTokenAccount:P,owner:this.scope.ownerPubKey,skipCloseAccount:!P,createInfo:P||!g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?i:0}:void 0,associatedOnly:P?!1:l,checkCreateATAOwner:m});x=S,T&&b.addInstruction(T)}let h;if(!h){let{account:S,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:e.mintB.programId,mint:new Q(e.mintB.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,skipCloseAccount:!w,createInfo:w||g?{payer:c.feePayer||this.scope.ownerPubKey,amount:g?0:i}:void 0,associatedOnly:w?!1:l,checkCreateATAOwner:m});h=S,T&&b.addInstruction(T)}(!x||!h)&&this.logAndCreateError("user do not have token account",{tokenA:e.mintA.symbol||e.mintA.address,tokenB:e.mintB.symbol||e.mintB.address,ownerTokenAccountA:x,ownerTokenAccountB:h,mintAUseSOLBalance:P,mintBUseSOLBalance:w,associatedOnly:l});let I=t??await this.getClmmPoolKeys(e.id);return b.addInstruction(Ie.makeSwapBaseOutInstructions({poolInfo:e,poolKeys:I,observationId:a,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:x,tokenAccountB:h},outputMint:new Q(n),amountOut:o,amountInMax:i,sqrtPriceLimitX64:k,remainingAccounts:u})),b.addCustomComputeBudget(p),b.addTipInstruction(f),b.versionBuild({txVersion:d})}async harvestAllRewards({allPoolInfo:e,allPositions:t,lockInfo:n,ownerInfo:o,associatedOnly:i=!0,checkCreateATAOwner:s=!1,programId:a,txVersion:c,computeBudgetConfig:u,feePayer:l}){let m={};for(let b of this.scope.account.tokenAccountRawInfos)i?$(this.scope.ownerPubKey,b.accountInfo.mint,a).publicKey.equals(b.pubkey)&&(m[b.accountInfo.mint.toString()]=b.pubkey):m[b.accountInfo.mint.toString()]=b.pubkey;let d=Object.values(t).flat().map(b=>b.nftMint),p=await xe(this.scope.connection,d.map(b=>({pubkey:b}))),f={};p.forEach(b=>{f[b.pubkey.toBase58()]=b?.accountInfo?.owner??null});let y=this.createTxBuilder(l);for(let b of Object.values(e)){if(t[b.id]===void 0||!t[b.id].find(T=>!T.liquidity.isZero()||T.rewardInfos.find(K=>!K.rewardAmountOwed.isZero())))continue;let g=b,P=o.useSOLBalance&&g.mintA.address===H.toString(),w=o.useSOLBalance&&g.mintB.address===H.toString(),k=m[g.mintA.address];if(!k){let{account:T,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:g.mintA.programId,mint:new Q(g.mintA.address),notUseTokenAccount:P,owner:this.scope.ownerPubKey,skipCloseAccount:!P,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:P?!1:i,checkCreateATAOwner:s});k=T,K&&y.addInstruction(K)}let x=m[g.mintB.address];if(!x){let{account:T,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:g.mintB.programId,mint:new Q(g.mintB.address),notUseTokenAccount:w,owner:this.scope.ownerPubKey,skipCloseAccount:!w,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:w?!1:i,checkCreateATAOwner:s});x=T,K&&y.addInstruction(K)}m[g.mintA.address]=k,m[g.mintB.address]=x;let h=[];for(let T of g.rewardDefaultInfos){let K=o.useSOLBalance&&T.mint.address===H.toString(),R=m[T.mint.address];if(!R){let{account:N,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:new Q(T.mint.programId),mint:new Q(T.mint.address),notUseTokenAccount:K,owner:this.scope.ownerPubKey,skipCloseAccount:!K,createInfo:{payer:o.feePayer||this.scope.ownerPubKey,amount:0},associatedOnly:K?!1:i});R=N,v&&y.addInstruction(v)}m[T.mint.address]=R,h.push(R)}let I=await this.getClmmPoolKeys(g.id),S=[];for(let T=0;T<I.rewardInfos.length;T++)S.push({poolRewardVault:new Q(I.rewardInfos[T].vault),ownerRewardVault:h[T],rewardMint:new Q(I.rewardInfos[T].mint.address)});for(let T of t[b.id]){let K=n?.[b.id]?.[T.nftMint.toBase58()];if(K){let R=$(this.scope.ownerPubKey,K.lockNftMint,ni).publicKey,N=z.getTickArrayStartIndexByTick(T.tickLower,I.config.tickSpacing),v=z.getTickArrayStartIndexByTick(T.tickUpper,I.config.tickSpacing),{publicKey:W}=be(new Q(I.programId),K.poolId,N),{publicKey:D}=be(new Q(I.programId),K.poolId,v),{publicKey:U}=Qt(new Q(I.programId),K.poolId,T.tickLower,T.tickUpper),ee=Uo(Io,K.lockNftMint).publicKey,J=Ie.harvestLockPositionInstructionV2({programId:Io,auth:vi,lockPositionId:ee,clmmProgram:On,lockOwner:this.scope.ownerPubKey,lockNftMint:K.lockNftMint,lockNftAccount:R,positionNftAccount:K.nftAccount,positionId:K.positionId,poolId:K.poolId,protocolPosition:U,vaultA:new Q(I.vault.A),vaultB:new Q(I.vault.B),tickArrayLower:W,tickArrayUpper:D,userVaultA:k,userVaultB:x,mintA:new Q(I.mintA.address),mintB:new Q(I.mintB.address),rewardAccounts:S,exTickArrayBitmap:Ve(On,K.poolId).publicKey});y.addInstruction({instructions:[J],instructionTypes:[E.ClmmHarvestLockPosition],lookupTableAddress:I.lookupTableAccount?[I.lookupTableAccount]:[]})}else{let R=Ie.decreaseLiquidityInstructions({poolInfo:g,poolKeys:I,ownerPosition:T,ownerInfo:{wallet:this.scope.ownerPubKey,tokenAccountA:k,tokenAccountB:x,rewardAccounts:h},liquidity:new Pt(0),amountMinA:new Pt(0),amountMinB:new Pt(0),nft2022:f[T.nftMint.toBase58()]?.equals(Sn)});y.addInstruction(R)}}}return c===0?y.sizeCheckBuildV0({computeBudgetConfig:u}):y.sizeCheckBuild({computeBudgetConfig:u})}async getWhiteListMint({programId:e}){let t=await this.scope.connection.getAccountInfo(qo(e).publicKey);return t?Yu.decode(t.data).whitelistMints.filter(o=>!o.equals(Q.default)):[]}async getOwnerPositionInfo({programId:e}){await this.scope.account.fetchWalletTokenAccounts();let n=this.scope.account.tokenAccountRawInfos.filter(s=>s.accountInfo.amount.eq(new Pt(1))).map(s=>ft(new Q(e),s.accountInfo.mint).publicKey),o=await this.scope.connection.getMultipleAccountsInfo(n),i=[];return o.forEach(s=>{if(!s)return;let a=zo.decode(s.data);i.push(a)}),i}async getRpcClmmPoolInfo({poolId:e}){return(await this.getRpcClmmPoolInfos({poolIds:[e]}))[String(e)]}async getRpcClmmPoolInfos({poolIds:e,config:t}){let n=await xe(this.scope.connection,e.map(i=>({pubkey:new Q(i)})),t),o={};for(let i=0;i<e.length;i++){let s=n[i];if(s===null||!s.accountInfo)throw Error("fetch pool info error: "+String(e[i]));let a=Fn.decode(s.accountInfo.data),c=ie.sqrtPriceX64ToPrice(a.sqrtPriceX64,a.mintDecimalsA,a.mintDecimalsB).toNumber();o[String(e[i])]={...a,currentPrice:c,programId:s.accountInfo.owner}}return o}async getComputeClmmPoolInfos({clmmPoolsRpcInfo:e,mintInfos:t}){let n=new Set(Object.keys(e).map(c=>e[c].ammConfig.toBase58())),o=await xe(this.scope.connection,Array.from(n).map(c=>({pubkey:new Q(c)}))),i={};o.forEach(c=>{!c.accountInfo||(i[c.pubkey.toBase58()]=Hu.decode(c.accountInfo.data))});let s=await Se.fetchComputeMultipleClmmInfo({connection:this.scope.connection,rpcDataMap:e,poolList:Object.keys(e).map(c=>{let[u,l]=[e[c].mintA.toBase58(),e[c].mintB.toBase58()];return{id:c,programId:e[c].programId.toBase58(),mintA:lt({address:u,decimals:e[c].mintDecimalsA,programId:t[u].programId.toBase58()||ni.toBase58(),extensions:{feeConfig:t[u]?.feeConfig?Bn(t[u]?.feeConfig):void 0}}),mintB:lt({address:l,decimals:e[c].mintDecimalsB,programId:t[l].programId.toBase58()||ni.toBase58(),extensions:{feeConfig:t[l]?.feeConfig?Bn(t[l]?.feeConfig):void 0}}),price:e[c].currentPrice,config:{...i[e[c].ammConfig.toBase58()],id:e[c].ammConfig.toBase58(),fundFeeRate:0,description:"",defaultRange:0,defaultRangePoint:[]}}})}),a=await Se.fetchMultiplePoolTickArrays({connection:this.scope.connection,poolKeys:Object.values(s)});return{computeClmmPoolInfo:s,computePoolTickData:a}}async getPoolInfoFromRpc(e){let t=await this.getRpcClmmPoolInfo({poolId:e}),n=new Set([t.mintA.toBase58(),t.mintB.toBase58()]),o=await Yn({connection:this.scope.connection,mints:Array.from(n).map(l=>new Q(l))}),{computeClmmPoolInfo:i,computePoolTickData:s}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:{[e]:t},mintInfos:o}),a=await xe(this.scope.connection,[{pubkey:t.vaultA},{pubkey:t.vaultB}]),c=Qu(i[e]);if(!a[0].accountInfo||!a[1].accountInfo)throw new Error("pool vault data not found");c.mintAmountA=Number(fc.decode(a[0].accountInfo.data).amount.toString()),c.mintAmountB=Number(fc.decode(a[1].accountInfo?.data).amount.toString());let u={...i[e],exBitmapAccount:i[e].exBitmapAccount.toBase58(),observationId:i[e].observationId.toBase58(),id:e,programId:t.programId.toBase58(),openTime:t.startTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},config:c.config,rewardInfos:i[e].rewardInfos.filter(l=>!l.tokenVault.equals(Q.default)).map(l=>({mint:lt({address:l.tokenMint.toBase58(),programId:ni.toBase58(),decimals:10}),vault:l.tokenVault.toBase58()}))};return{poolInfo:c,poolKeys:u,computePoolInfo:i[e],tickData:s}}};import{PublicKey as G}from"@solana/web3.js";import{AccountLayout as ea,createAssociatedTokenAccountIdempotentInstruction as Ic,getAssociatedTokenAddressSync as Bc,NATIVE_MINT as po,TOKEN_PROGRAM_ID as Kt}from"@solana/spl-token";import Ys from"bn.js";import gr from"decimal.js-light";import ii from"bn.js";function fr(r,e){if(e.isZero())throw Error("divisor is zero");return r.mod(e)}function xp(r,e){if(e.isZero())throw Error("rhs is zero");let t=r.div(e);if(t.isZero())throw Error("quotient is zero");let n=fr(r,e);return n.gt(lo)&&(t=t.add(new ii(1)),e=r.div(t),n=fr(r,t),n.gt(lo)&&(e=e.add(new ii(1)))),[t,e]}var lo=new ii(0),br=class{static swapWithoutFees(e,t,n){let o=t.mul(n),i=t.add(e),[s]=xp(o,i),a=n.sub(s);if(a.isZero())throw Error("destinationAmountSwapped is zero");return{destinationAmountSwapped:a}}static lpTokensToTradingTokens(e,t,n,o,i){let s=e.mul(n).div(t),a=e.mul(o).div(t);if(i===0)return{tokenAmount0:s,tokenAmount1:a};if(i===1)return fr(e.mul(n),t).gt(lo)&&s.gt(lo)&&(s=s.add(new ii(1))),fr(e.mul(o),t).gt(lo)&&a.gt(lo)&&(a=a.add(new ii(1))),{tokenAmount0:s,tokenAmount1:a};throw Error("roundDirection value error")}};var yr=class{static tradingFee(e,t){return Ri(e,t,qt)}static protocolFee(e,t){return ts(e,t,qt)}static fundFee(e,t){return ts(e,t,qt)}};var Ar=class{static validate_supply(e,t){if(e.isZero())throw Error("tokenAmount0 is zero");if(t.isZero())throw Error("tokenAmount1 is zero")}static swap(e,t,n,o){let i=yr.tradingFee(e,o),s=e.sub(i),{destinationAmountSwapped:a}=br.swapWithoutFees(s,t,n);return{newSwapDestinationAmount:n.sub(a),sourceAmountSwapped:e,destinationAmountSwapped:a,tradeFee:i}}static swapBaseOut({poolMintA:e,poolMintB:t,tradeFeeRate:n,baseReserve:o,quoteReserve:i,outputMint:s,outputAmount:a}){let[c,u,l,m,d]=t.address===s.toString()?[o,i,e.decimals,t.decimals,e.address]:[i,o,t.decimals,e.decimals,t.address],p=new gr(u.toString()).div(10**m).div(new gr(c.toString()).div(10**l)),f=a.gte(u)?u.sub(new Ys(1)):a,y=u.sub(f),b=Pn(c.mul(f),y),g=Pn(b.mul(new Ys(1e6)),new Ys(1e6).sub(n)),P=g.sub(b),w=new gr(f.toString()).div(10**m).div(new gr(g.toString()).div(10**l)),k=p.isZero()?0:w.sub(p).div(p).abs().toNumber();return{amountRealOut:f,amountIn:g,amountInWithoutFee:b,tradeFee:P,priceImpact:k}}};import ve from"bn.js";import{PublicKey as si,TransactionInstruction as Gn,Keypair as vp,SystemProgram as Mp}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as gc,TOKEN_2022_PROGRAM_ID as $s,TOKEN_PROGRAM_ID as Kn}from"@solana/spl-token";var Sp=Buffer.from("vault_and_lp_mint_auth_seed","utf8"),yx=Buffer.from("amm_config","utf8"),Kp=Buffer.from("pool","utf8"),Cp=Buffer.from("pool_lp_mint","utf8"),Lp=Buffer.from("pool_vault","utf8"),Rp=Buffer.from("observation","utf8");function mo(r){return ue([Sp],r)}function Zs(r,e,t,n){return ue([Kp,e.toBuffer(),t.toBuffer(),n.toBuffer()],r)}function Np(r,e){return ue([Cp,e.toBuffer()],r)}function bc(r,e,t){return ue([Lp,e.toBuffer(),t.toBuffer()],r)}function ri(r,e){return ue([Rp,e.toBuffer()],r)}function yc({poolId:r,programId:e,configId:t,mintA:n,mintB:o}){let i=mo(e).publicKey,s=r||Zs(e,t,n,o).publicKey,a=Np(e,s).publicKey,c=bc(e,s,n).publicKey,u=bc(e,s,o).publicKey,l=ri(e,s).publicKey;return{poolId:s,configId:t,authority:i,lpMint:a,vaultA:c,vaultB:u,observationId:l}}var Op=Buffer.from("locked_liquidity","utf8");function Pr(r,e){return ue([Op,e.toBuffer()],r)}var _p=de("Raydium_cpmm"),Xn={initialize:[175,175,109,31,13,152,155,237],deposit:[242,35,198,137,82,225,242,182],withdraw:[183,18,70,156,148,109,161,34],swapBaseInput:[143,190,90,218,196,30,51,222],swapBaseOutput:[55,217,98,86,163,74,180,173],lockCpLiquidity:[216,157,29,78,38,51,31,26],collectCpFee:[8,30,51,199,209,184,247,133]};function Ac(r,e,t,n,o,i,s,a,c,u,l,m,d,p,f,y,b,g,P,w){let k=O([A("amountMaxA"),A("amountMaxB"),A("openTime")]),x=Zs(r,t,i,s).publicKey,h=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!o.equals(x),isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!1},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:b,isSigner:!1,isWritable:!0},{pubkey:Kn,isSigner:!1,isWritable:!1},{pubkey:f,isSigner:!1,isWritable:!1},{pubkey:y,isSigner:!1,isWritable:!1},{pubkey:gc,isSigner:!1,isWritable:!1},{pubkey:Yr,isSigner:!1,isWritable:!1},{pubkey:et,isSigner:!1,isWritable:!1}],I=Buffer.alloc(k.span);return k.encode({amountMaxA:g,amountMaxB:P,openTime:w},I),new Gn({keys:h,programId:r,data:Buffer.from([...Xn.initialize,...I])})}function Pc(r,e,t,n,o,i,s,a,c,u,l,m,d,p,f){let y=O([A("lpAmount"),A("amountMaxA"),A("amountMaxB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Kn,isSigner:!1,isWritable:!1},{pubkey:$s,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0}],g=Buffer.alloc(y.span);return _p.debug("cpmm deposit data",{lpAmount:d.toString(),amountMaxA:p.toString(),amountMaxB:f.toString()}),y.encode({lpAmount:d,amountMaxA:p,amountMaxB:f},g),new Gn({keys:b,programId:r,data:Buffer.from([...Xn.deposit,...g])})}function wc(r,e,t,n,o,i,s,a,c,u,l,m,d,p,f){let y=O([A("lpAmount"),A("amountMinA"),A("amountMinB")]),b=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:Kn,isSigner:!1,isWritable:!1},{pubkey:$s,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:An,isSigner:!1,isWritable:!1}],g=Buffer.alloc(y.span);return y.encode({lpAmount:d,amountMinA:p,amountMinB:f},g),new Gn({keys:b,programId:r,data:Buffer.from([...Xn.withdraw,...g])})}function wr(r,e,t,n,o,i,s,a,c,u,l,m,d,p,f,y){let b=O([A("amountIn"),A("amounOutMin")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],P=Buffer.alloc(b.span);return b.encode({amountIn:f,amounOutMin:y},P),new Gn({keys:g,programId:r,data:Buffer.from([...Xn.swapBaseInput,...P])})}function kc(r,e,t,n,o,i,s,a,c,u,l,m,d,p,f,y){let b=O([A("amountInMax"),A("amountOut")]),g=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0}],P=Buffer.alloc(b.span);return b.encode({amountInMax:f,amountOut:y},P),new Gn({keys:g,programId:r,data:Buffer.from([...Xn.swapBaseOutput,...P])})}async function hc(r){let{ownerInfo:e,poolInfo:t,poolKeys:n,feeNftOwner:o,getEphemeralSigners:i}=r,s=[],[a,c]=[new si(t.id),new si(t.lpMint.address)],u;if(i)u=new si((await i(1))[0]);else{let b=vp.generate();s.push(b),u=b.publicKey}let{publicKey:l}=$(o,u,Kn),{publicKey:m}=un(u),{publicKey:d}=Pr(r.lockProgram,u),{publicKey:p}=$(e.wallet,c,Kn),{publicKey:f}=$(r.lockAuthProgram,c,Kn),y=Ep({programId:r.lockProgram,auth:r.lockAuthProgram,payer:e.feePayer,liquidityOwner:e.wallet,nftOwner:o,nftMint:u,nftAccount:l,poolId:a,lockPda:d,mintLp:c,userLpVault:p,lockLpVault:f,poolVaultA:new si(n.vault.A),poolVaultB:new si(n.vault.B),metadataAccount:m,lpAmount:r.lpAmount,withMetadata:r.withMetadata??!0});return{address:{nftMint:u,nftAccount:l,metadataAccount:m,lockPda:d,userLpVault:p,lockLpVault:f},instructions:[y],signers:s,instructionTypes:[E.CpmmLockLp],lookupTableAddress:[]}}function Ep({programId:r,auth:e,payer:t,liquidityOwner:n,nftOwner:o,nftMint:i,nftAccount:s,poolId:a,lockPda:c,mintLp:u,userLpVault:l,lockLpVault:m,poolVaultA:d,poolVaultB:p,metadataAccount:f,lpAmount:y,withMetadata:b}){let g=[{pubkey:e,isSigner:!1,isWritable:!1},{pubkey:t,isSigner:!0,isWritable:!0},{pubkey:n,isSigner:!0,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!0,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!1},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!0},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:f,isSigner:!1,isWritable:!0},{pubkey:et,isSigner:!1,isWritable:!1},{pubkey:Mp.programId,isSigner:!1,isWritable:!1},{pubkey:Kn,isSigner:!1,isWritable:!1},{pubkey:gc,isSigner:!1,isWritable:!1},{pubkey:Vt,isSigner:!1,isWritable:!1}],P=O([A("lpAmount"),Me("withMetadata")]),w=Buffer.alloc(P.span);P.encode({lpAmount:y,withMetadata:b},w);let k=Buffer.from([...Xn.lockCpLiquidity,...w]);return new Gn({keys:g,programId:r,data:k})}function Tc({programId:r,nftOwner:e,auth:t,nftAccount:n,lockPda:o,poolId:i,mintLp:s,userVaultA:a,userVaultB:c,poolVaultA:u,poolVaultB:l,mintA:m,mintB:d,lockLpVault:p,lpFeeAmount:f,cpmmProgram:y,cpmmAuthProgram:b}){let g=[{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:y??Mi,isSigner:!1,isWritable:!1},{pubkey:b??Ha,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!0},{pubkey:Kn,isSigner:!1,isWritable:!1},{pubkey:$s,isSigner:!1,isWritable:!1},{pubkey:An,isSigner:!1,isWritable:!1}],P=O([A("lpFeeAmount")]),w=Buffer.alloc(P.span);P.encode({lpFeeAmount:f},w);let k=Buffer.from([...Xn.collectCpFee,...w]);return new Gn({keys:g,programId:r,data:k})}var Js=O([Pe(8),V("bump"),Me("disableCreatePool"),Gt("index"),A("tradeFeeRate"),A("protocolFeeRate"),A("fundFeeRate"),A("createPoolFee"),C("protocolOwner"),C("fundOwner"),X(A(),16)]),ai=O([Pe(8),C("configId"),C("poolCreator"),C("vaultA"),C("vaultB"),C("mintLp"),C("mintA"),C("mintB"),C("mintProgramA"),C("mintProgramB"),C("observationId"),V("bump"),V("status"),V("lpDecimals"),V("mintDecimalA"),V("mintDecimalB"),A("lpAmount"),A("protocolFeesMintA"),A("protocolFeesMintB"),A("fundFeesMintA"),A("fundFeesMintB"),A("openTime"),X(A(),32)]);var Ue=r=>((performance.now()-r)/1e3).toFixed(2),ui=class extends Ke{constructor(e){super(e)}async load(){this.checkDisabled()}async getCpmmPoolKeys(e){return(await this.scope.api.fetchPoolKeysById({idList:[e]}))[0]}async getRpcPoolInfo(e,t,n){if(!e&&!t?.marketAccount)throw new Error("Either poolId or accountInfos.marketAccount must be provided");let o=e?(await xe(this.scope.connection,[{pubkey:new G(e)}]))[0]:t.marketAccount;if(!o?.accountInfo){let x=e||t?.marketAccount?.pubkey?.toBase58()||"unknown";throw new Error(`Pool account not found: ${x}`)}let i={...ai.decode(o.accountInfo.data),programId:o.accountInfo.owner},s=[],a=[i.vaultA,i.vaultB];e&&(s.push(...a.map(x=>({pubkey:new G(x)}))),n&&s.push({pubkey:new G(i.configId)}));let c=[];e&&s.length>0&&(c=await xe(this.scope.connection,s));let u;if(n){let x=e?c[c.length-1]:t?.configState;if(!x?.accountInfo)throw new Error(`Config account not found: ${i.configId}`);u=Js.decode(x.accountInfo.data)}let l=e?c[0]?.accountInfo:t?.vaultAInfo?.accountInfo,m=e?c[1]?.accountInfo:t?.vaultBInfo?.accountInfo;if(!l||!m)throw new Error(`Vault accounts not found: A=${i.vaultA}, B=${i.vaultB}`);let d=new ve(ea.decode(l.data).amount.toString()),p=new ve(ea.decode(m.data).amount.toString()),f=d.sub(i.protocolFeesMintA).sub(i.fundFeesMintA),y=p.sub(i.protocolFeesMintB).sub(i.fundFeesMintB),b=new L(10).pow(i.mintDecimalA),g=new L(10).pow(i.mintDecimalB),P=new L(f.toString()).div(b),w=new L(y.toString()).div(g),k=P.isZero()?new L(0):w.div(P);return{...i,baseReserve:f,quoteReserve:y,vaultAAmount:d,vaultBAmount:p,configInfo:u,poolPrice:k}}async getRpcPoolInfos(e,t){let n=await xe(this.scope.connection,e.map(m=>({pubkey:new G(m)}))),o={},i=new Set,s=[];for(let m=0;m<e.length;m++){let d=n[m];if(d.accountInfo===null)throw Error("fetch pool info error: "+String(e[m]));let p=ai.decode(d.accountInfo.data);o[String(e[m])]={...p,programId:d.accountInfo.owner},i.add(String(p.configId)),s.push(p.vaultA,p.vaultB)}let a={};if(t){let m=[...i],d=await xe(this.scope.connection,m.map(p=>({pubkey:new G(p)})));for(let p=0;p<m.length;p++){let f=d[p].accountInfo;if(f===null)throw Error("fetch pool config error: "+m[p]);a[m[p]]=Js.decode(f.data)}}let c={},u=await xe(this.scope.connection,s.map(m=>({pubkey:new G(m)})));for(let m=0;m<s.length;m++){let d=u[m].accountInfo;if(d===null)throw Error("fetch vault info error: "+s[m]);c[String(s[m])]=new ve(ea.decode(d.data).amount.toString())}let l={};for(let[m,d]of Object.entries(o)){let p=c[d.vaultA.toString()].sub(d.protocolFeesMintA).sub(d.fundFeesMintA),f=c[d.vaultB.toString()].sub(d.protocolFeesMintB).sub(d.fundFeesMintB);l[m]={...d,baseReserve:p,quoteReserve:f,vaultAAmount:c[d.vaultA.toString()],vaultBAmount:c[d.vaultB.toString()],configInfo:a[d.configId.toString()],poolPrice:new L(f.toString()).div(new L(10).pow(d.mintDecimalB)).div(new L(p.toString()).div(new L(10).pow(d.mintDecimalA)))}}return l}toComputePoolInfos({pools:e,mintInfos:t}){return Object.keys(e).reduce((n,o)=>{let i=e[o],[s,a]=[i.mintA.toBase58(),i.mintB.toBase58()];return{...n,[o]:{...i,id:new G(o),configInfo:i.configInfo,version:7,authority:mo(i.programId).publicKey,mintA:lt({address:s,decimals:i.mintDecimalA,programId:i.mintProgramA.toBase58(),extensions:{feeConfig:t[s]?.feeConfig?Bn(t[s]?.feeConfig):void 0}}),mintB:lt({address:a,decimals:i.mintDecimalB,programId:i.mintProgramB.toBase58(),extensions:{feeConfig:t[a]?.feeConfig?Bn(t[a]?.feeConfig):void 0}})}}},{})}async getPoolInfoFromRpc(e,t,n){t=t||await this.getRpcPoolInfo(e,void 0,!0),n=n||await Yn({connection:this.scope.connection,mints:[t.mintA,t.mintB]});let o=lt({address:t.mintA.toBase58(),decimals:t.mintDecimalA,programId:t.mintProgramA.toBase58(),extensions:{feeConfig:n[t.mintA.toBase58()].feeConfig?Bn(n[t.mintA.toBase58()].feeConfig):void 0}}),i=lt({address:t.mintB.toBase58(),decimals:t.mintDecimalB,programId:t.mintProgramB.toBase58(),extensions:{feeConfig:n[t.mintB.toBase58()].feeConfig?Bn(n[t.mintB.toBase58()].feeConfig):void 0}}),s=lt({address:t.mintLp.toBase58(),decimals:t.lpDecimals,programId:Kt.toBase58()}),a={id:t.configId.toBase58(),index:t.configInfo.index,protocolFeeRate:t.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:t.configInfo.tradeFeeRate.toNumber(),fundFeeRate:t.configInfo.fundFeeRate.toNumber(),createPoolFee:t.configInfo.createPoolFee.toString()},c={volume:0,volumeQuote:0,volumeFee:0,apr:0,feeApr:0,priceMin:0,priceMax:0,rewardApr:[]};return{poolInfo:{programId:t.programId.toBase58(),id:e,type:"Standard",lpMint:s,lpPrice:0,lpAmount:t.lpAmount.toNumber(),config:a,mintA:o,mintB:i,rewardDefaultInfos:[],rewardDefaultPoolInfos:"Ecosystem",price:t.poolPrice.toNumber(),mintAmountA:new L(t.vaultAAmount.toString()).div(10**o.decimals).toNumber(),mintAmountB:new L(t.vaultBAmount.toString()).div(10**i.decimals).toNumber(),feeRate:t.configInfo.tradeFeeRate.toNumber(),openTime:t.openTime.toString(),tvl:0,burnPercent:0,day:c,week:c,month:c,pooltype:[],farmUpcomingCount:0,farmOngoingCount:0,farmFinishedCount:0},poolKeys:{programId:t.programId.toBase58(),id:e,mintA:o,mintB:i,openTime:t.openTime.toString(),vault:{A:t.vaultA.toBase58(),B:t.vaultB.toBase58()},authority:mo(t.programId).publicKey.toBase58(),mintLp:s,config:a,observationId:ri(t.programId,new G(e)).publicKey.toBase58()},rpcData:t}}async createPool({poolId:e,programId:t,poolFeeAccount:n,startTime:o,ownerInfo:i,associatedOnly:s=!1,checkCreateATAOwner:a=!1,txVersion:c,feeConfig:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d,...p}){let f=i.feePayer||this.scope.owner?.publicKey,y=new ve(new G(p.mintA.address).toBuffer()).lte(new ve(new G(p.mintB.address).toBuffer())),[b,g]=y?[p.mintA,p.mintB]:[p.mintB,p.mintA],[P,w]=y?[p.mintAAmount,p.mintBAmount]:[p.mintBAmount,p.mintAAmount],k=i.useSOLBalance&&b.address===po.toBase58(),x=i.useSOLBalance&&g.address===po.toBase58(),[h,I]=[new G(b.address),new G(g.address)],S=this.createTxBuilder(d),{account:T,instructionParams:K}=await this.scope.account.getOrCreateTokenAccount({mint:h,tokenProgram:b.programId,owner:this.scope.ownerPubKey,createInfo:k?{payer:f,amount:P}:void 0,notUseTokenAccount:k,skipCloseAccount:!k,associatedOnly:k?!1:s,checkCreateATAOwner:a});S.addInstruction(K||{});let{account:R,instructionParams:N}=await this.scope.account.getOrCreateTokenAccount({mint:new G(g.address),tokenProgram:g.programId,owner:this.scope.ownerPubKey,createInfo:x?{payer:f,amount:w}:void 0,notUseTokenAccount:x,skipCloseAccount:!x,associatedOnly:x?!1:s,checkCreateATAOwner:a});if(S.addInstruction(N||{}),T===void 0||R===void 0)throw Error("you don't has some token account");let v=yc({poolId:e,programId:t,configId:new G(u.id),mintA:h,mintB:I});return S.addInstruction({instructions:[Ac(t,this.scope.ownerPubKey,new G(u.id),v.authority,v.poolId,h,I,v.lpMint,T,R,$(this.scope.ownerPubKey,v.lpMint).publicKey,v.vaultA,v.vaultB,n,new G(b.programId??Kt),new G(g.programId??Kt),v.observationId,P,w,o)],instructionTypes:[E.CpmmCreatePool]}),S.addCustomComputeBudget(l),S.addTipInstruction(m),S.versionBuild({txVersion:c,extInfo:{address:{...v,mintA:b,mintB:g,programId:t,poolFeeAccount:n,feeConfig:u}}})}async addLiquidity(e){let{poolInfo:t,poolKeys:n,inputAmount:o,baseIn:i,slippage:s,computeResult:a,computeBudgetConfig:c,txTipConfig:u,config:l,txVersion:m,feePayer:d}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region"),o.isZero()&&this.logAndCreateError("amounts must greater than zero","amountInA",{amountInA:o.toString()});let{account:p}=this.scope,{bypassAssociatedCheck:f,checkCreateATAOwner:y}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,...l},b=a?void 0:await this.getRpcPoolInfo(t.id),{liquidity:g,inputAmountFee:P,anotherAmount:w}=a||this.computePairAmount({poolInfo:{...t,lpAmount:new L(b.lpAmount.toString()).div(10**t.lpMint.decimals).toNumber()},baseReserve:b.baseReserve,quoteReserve:b.quoteReserve,slippage:new Ye(0),baseIn:i,epochInfo:await this.scope.fetchEpochInfo(),amount:new L(o.toString()).div(10**(i?t.mintA.decimals:t.mintB.decimals))}),k=w.amount,x=t.mintA.address===po.toString(),h=t.mintB.address===po.toString(),I=this.createTxBuilder(d),[S,T]=[new G(t.mintA.address),new G(t.mintB.address)],{account:K,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new G(t.mintA.address),owner:this.scope.ownerPubKey,createInfo:x||(i?o:k).isZero()?{payer:this.scope.ownerPubKey,amount:i?o:k}:void 0,skipCloseAccount:!x,notUseTokenAccount:x,associatedOnly:!1,checkCreateATAOwner:y});I.addInstruction(R||{});let{account:N,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new G(t.mintB.address),owner:this.scope.ownerPubKey,createInfo:h||(i?k:o).isZero()?{payer:this.scope.ownerPubKey,amount:i?k:o}:void 0,skipCloseAccount:!h,notUseTokenAccount:h,associatedOnly:!1,checkCreateATAOwner:y});I.addInstruction(v||{}),!K&&!N&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",p.tokenAccounts);let W=await p.getCreatedTokenAccount({mint:new G(t.lpMint.address)}),{tokenAccount:D,...U}=await p.handleTokenAccount({side:"out",amount:0,mint:new G(t.lpMint.address),tokenAccount:W,bypassAssociatedCheck:f,checkCreateATAOwner:y});I.addInstruction(U);let ee=n??await this.getCpmmPoolKeys(t.id),J=new Ye(new ve(1)).sub(s);return I.addInstruction({instructions:[Pc(new G(t.programId),this.scope.ownerPubKey,new G(ee.authority),new G(t.id),D,K,N,new G(ee.vault.A),new G(ee.vault.B),S,T,new G(t.lpMint.address),a?a?.liquidity:J.mul(g).quotient,i?P.amount:k,i?k:P.amount)],instructionTypes:[E.CpmmAddLiquidity],lookupTableAddress:ee.lookupTableAccount?[ee.lookupTableAccount]:[]}),I.addCustomComputeBudget(c),I.addTipInstruction(u),I.versionBuild({txVersion:m})}async withdrawLiquidity(e){let{poolInfo:t,poolKeys:n,lpAmount:o,slippage:i,computeBudgetConfig:s,txTipConfig:a,txVersion:c,feePayer:u,closeWsol:l=!0}=e;this.scope.availability.addStandardPosition===!1&&this.logAndCreateError("add liquidity feature disabled in your region");let m=new Ye(new ve(1)).sub(i),d=await this.getRpcPoolInfo(t.id),[p,f]=[m.mul(o.mul(d.baseReserve).div(d.lpAmount)).quotient,m.mul(o.mul(d.quoteReserve).div(d.lpAmount)).quotient],y=await this.scope.fetchEpochInfo(),[b,g]=[ke(p,t.mintA.extensions.feeConfig,y,!1),ke(f,t.mintB.extensions.feeConfig,y,!1)],{account:P}=this.scope,w=this.createTxBuilder(u),[k,x]=[new G(t.mintA.address),new G(t.mintB.address)],h=k.equals(H),I=x.equals(H),S,T,{account:K,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new G(t.mintA.address),notUseTokenAccount:h,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(h&&l),associatedOnly:!h,checkCreateATAOwner:!1});S=K,R&&w.addInstruction(R);let{account:N,instructionParams:v}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new G(t.mintB.address),notUseTokenAccount:I,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(I&&l),associatedOnly:!I,checkCreateATAOwner:!1});T=N,v&&w.addInstruction(v),(!S||!T)&&this.logAndCreateError("cannot found target token accounts","tokenAccounts",P.tokenAccounts);let W=await P.getCreatedTokenAccount({mint:new G(t.lpMint.address)});W||this.logAndCreateError("cannot found lp token account","tokenAccounts",P.tokenAccounts);let D=n??await this.getCpmmPoolKeys(t.id);return w.addInstruction({instructions:[wc(new G(t.programId),this.scope.ownerPubKey,new G(D.authority),new G(t.id),W,S,T,new G(D.vault.A),new G(D.vault.B),k,x,new G(t.lpMint.address),o,p.sub(b.fee??new ve(0)),f.sub(g.fee??new ve(0)))],instructionTypes:[E.CpmmWithdrawLiquidity],lookupTableAddress:D.lookupTableAccount?[D.lookupTableAccount]:[]}),w.addCustomComputeBudget(s),w.addTipInstruction(a),w.versionBuild({txVersion:c})}async swap(e){await new Promise(J=>setImmediate(J));let{poolInfo:t,poolKeys:n,baseIn:o,fixedOut:i,inputAmount:s,swapResult:a,slippage:c=0,config:u,computeBudgetConfig:l,txTipConfig:m,txVersion:d,feePayer:p,nonce:f}=e,{bypassAssociatedCheck:y,checkCreateATAOwner:b,associatedOnly:g,useIdempotent:P=!1}={bypassAssociatedCheck:!1,checkCreateATAOwner:!1,associatedOnly:!0,useIdempotent:!1,...u},w=performance.now();console.log(`Swap start: ${Ue(w)}s, baseIn: ${o}, fixedOut: ${i}, inputAmount: ${s.toString()}`);let k=this.createTxBuilder(p);if(console.log(`TxBuilder created: ${Ue(w)}s`),f&&f?.instruction&&(k.addInstruction({instructions:[f.instruction],instructionTypes:[f.instruction].map(()=>E.NonceAccount)}),console.log(`Nonce instruction added: ${Ue(w)}s`)),l){let{instructions:J,instructionTypes:le}=Jn(l);k.addInstruction({instructions:J,instructionTypes:le}),console.log(`Compute budget added: ${Ue(w)}s`)}i?a.sourceAmountSwapped=a.sourceAmountSwapped.mul(new ve((1+c)*1e4)).div(new ve(1e4)):a.destinationAmountSwapped=a.destinationAmountSwapped.mul(new ve((1-c)*1e4)).div(new ve(1e4)),console.log(`Slippage applied: ${Ue(w)}s`);let[x,h]=[new G(t.mintA.address),new G(t.mintB.address)],I,S;if(console.log(`Mints prepared: ${Ue(w)}s`),P){let J=new G(t.mintA.programId??Kt),le=new G(t.mintB.programId??Kt),oe=x.equals(po),fe=h.equals(po);console.log(`${Ue(w)}s: mintAIsSOL: ${oe}, mintBIsSOL: ${fe}`),I=Bc(x,this.scope.ownerPubKey,!1,J),console.log(`${Ue(w)}s: mintATokenAcc prepared: ${I.toBase58()}`),S=Bc(h,this.scope.ownerPubKey,!1,le),console.log(`${Ue(w)}s: mintBTokenAcc prepared: ${S.toBase58()}`),oe||(k.addInstruction({instructions:[Ic(this.scope.ownerPubKey,I,this.scope.ownerPubKey,x,J)],instructionTypes:[E.CreateATA]}),console.log(`Idempotent ATA for mintA added: ${Ue(w)}s`)),fe||(k.addInstruction({instructions:[Ic(this.scope.ownerPubKey,S,this.scope.ownerPubKey,h,le)],instructionTypes:[E.CreateATA]}),console.log(`Idempotent ATA for mintB added: ${Ue(w)}s`))}else{let J=t.mintA.address===H.toBase58(),le=t.mintB.address===H.toBase58();console.log(`mintAUseSOLBalance: ${J}, mintBUseSOLBalance: ${le}, ${Ue(w)}s`);let{account:oe,instructionParams:fe}=await this.scope.account.getOrCreateTokenAccount({mint:x,tokenProgram:new G(t.mintA.programId??Kt),owner:this.scope.ownerPubKey,createInfo:J||!o?{payer:this.scope.ownerPubKey,amount:o?a.sourceAmountSwapped:0}:void 0,notUseTokenAccount:J,skipCloseAccount:!J,associatedOnly:J?!1:g,checkCreateATAOwner:b});console.log(`mintATokenAccResult: ${JSON.stringify(oe)}, ${Ue(w)}s`),fe&&k.addInstruction(fe),console.log(`mintATokenAccInstruction added: ${Ue(w)}s`),I=oe;let{account:ot,instructionParams:Ge}=await this.scope.account.getOrCreateTokenAccount({mint:h,tokenProgram:new G(t.mintB.programId??Kt),owner:this.scope.ownerPubKey,createInfo:le||o?{payer:this.scope.ownerPubKey,amount:o?0:a.sourceAmountSwapped}:void 0,notUseTokenAccount:le,skipCloseAccount:!le,associatedOnly:le?!1:g,checkCreateATAOwner:b});console.log(`mintBTokenAccResult: ${JSON.stringify(ot)}, ${Ue(w)}s`),Ge&&k.addInstruction(Ge),console.log(`mintBTokenAccInstruction added: ${Ue(w)}s`),S=ot,(!I||!S)&&this.logAndCreateError("user do not have token account",{mintA:t.mintA.symbol||t.mintA.address,mintB:t.mintB.symbol||t.mintB.address,mintATokenAcc:I,mintBTokenAcc:S,mintAUseSOLBalance:J,mintBUseSOLBalance:le,associatedOnly:g})}let T=n??await this.getCpmmPoolKeys(t.id);console.log(`Pool keys fetched: ${Ue(w)}s`);let K=o?I:S,R=o?S:I,N=o?x:h,v=o?h:x,W=o?T.vault.A:T.vault.B,D=o?T.vault.B:T.vault.A,U=o?new G(t.mintA.programId??Kt):new G(t.mintB.programId??Kt),ee=o?new G(t.mintB.programId??Kt):new G(t.mintA.programId??Kt);return console.log(`Swap parameters prepared: ${Ue(w)}s`),k.addInstruction({instructions:[i?kc(new G(t.programId),this.scope.ownerPubKey,new G(T.authority),new G(T.config.id),new G(t.id),K,R,new G(W),new G(D),U,ee,N,v,ri(new G(t.programId),new G(t.id)).publicKey,a.sourceAmountSwapped,a.destinationAmountSwapped):wr(new G(t.programId),this.scope.ownerPubKey,new G(T.authority),new G(T.config.id),new G(t.id),K,R,new G(W),new G(D),U,ee,N,v,ri(new G(t.programId),new G(t.id)).publicKey,s,a.destinationAmountSwapped)],instructionTypes:[i?E.CpmmSwapBaseOut:E.CpmmSwapBaseIn]}),console.log(`Swap instruction added: ${Ue(w)}s`),k.addTipInstruction(m),console.log(`Tip instruction added: ${Ue(w)}s`),k.versionBuild({txVersion:d},f?.nonce)}async lockLp(e){let{poolInfo:t,lpAmount:n,computeBudgetConfig:o,txTipConfig:i,txVersion:s,feePayer:a,feeNftOwner:c}=e;n.isZero()&&this.logAndCreateError("lpAmount must greater than zero",{lpAmount:n.toString()});let u=this.createTxBuilder(a),l=e.poolKeys??await this.getCpmmPoolKeys(t.id),m=await hc({poolInfo:t,poolKeys:l,ownerInfo:{wallet:this.scope.ownerPubKey,feePayer:e.feePayer??this.scope.ownerPubKey},feeNftOwner:c??this.scope.ownerPubKey,lockProgram:e.programId??_i,lockAuthProgram:e.authProgram??Ei,lpAmount:n,withMetadata:e.withMetadata??!0,getEphemeralSigners:e.getEphemeralSigners});return u.addInstruction(m),u.addCustomComputeBudget(o),u.addTipInstruction(i),u.versionBuild({txVersion:s,extInfo:m.address})}async harvestLockLp(e){let{poolInfo:t,lpFeeAmount:n,nftMint:o,programId:i=_i,authProgram:s=Ei,cpmmProgram:a,computeBudgetConfig:c,txTipConfig:u,txVersion:l,closeWsol:m=!0}=e;n.isZero()&&this.logAndCreateError("lpFeeAmount must greater than zero",{lpAmount:n.toString()});let d=e.feePayer||this.scope.ownerPubKey,p=this.createTxBuilder(d),[f,y]=[new G(t.mintA.address),new G(t.mintB.address)],b=f.equals(H),g=y.equals(H),P,w,{account:k,instructionParams:x}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintA.programId,mint:new G(t.mintA.address),notUseTokenAccount:b,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(b&&m),associatedOnly:!b,checkCreateATAOwner:!1});P=k,x&&p.addInstruction(x);let{account:h,instructionParams:I}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:t.mintB.programId,mint:new G(t.mintB.address),notUseTokenAccount:g,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!(g&&m),associatedOnly:!g,checkCreateATAOwner:!1});w=h,I&&p.addInstruction(I),(!P||!w)&&this.logAndCreateError("cannot found target token accounts",{tokenAccountA:P,tokenAccountB:w});let S=e.poolKeys??await this.getCpmmPoolKeys(t.id),{publicKey:T}=$(d,o,Kt),{publicKey:K}=Pr(i,o),{publicKey:R}=$(s,new G(t.lpMint.address),Kt);return p.addInstruction({instructions:[Tc({programId:i??_i,nftOwner:this.scope.ownerPubKey,auth:s??Ei,nftMint:o,nftAccount:T,lockPda:K,poolId:new G(t.id),mintLp:new G(S.mintLp.address),userVaultA:P,userVaultB:w,poolVaultA:new G(S.vault.A),poolVaultB:new G(S.vault.B),mintA:f,mintB:y,lockLpVault:R,lpFeeAmount:n,cpmmProgram:a?.programId,cpmmAuthProgram:a?.authProgram})],instructionTypes:[E.CpmmCollectLockFee]}),p.addCustomComputeBudget(c),p.addTipInstruction(u),p.versionBuild({txVersion:l})}computeSwapAmount({pool:e,amountIn:t,outputMint:n,slippage:o}){let i=n.toString()===e.mintB.address,s=Ar.swap(t,i?e.baseReserve:e.quoteReserve,i?e.quoteReserve:e.baseReserve,e.configInfo.tradeFeeRate),a=new L(s.destinationAmountSwapped.toString()).div(s.sourceAmountSwapped.toString()),c=s.destinationAmountSwapped.mul(new ve((1-o)*1e4)).div(new ve(1e4));return{allTrade:s.sourceAmountSwapped.eq(t),amountIn:t,amountOut:s.destinationAmountSwapped,minAmountOut:c,executionPrice:a,fee:s.tradeFee,priceImpact:e.poolPrice.sub(a).div(e.poolPrice)}}computePairAmount({poolInfo:e,baseReserve:t,quoteReserve:n,amount:o,slippage:i,epochInfo:s,baseIn:a}){let c=1-Number(i.toSignificant())/100,u=new ve(new L(o).mul(10**e[a?"mintA":"mintB"].decimals).mul(c).toFixed(0)),l=ke(u,e[a?"mintA":"mintB"].extensions.feeConfig,s,!1),m=u.sub(l.fee??new ve(0)),d=new ve(new L(e.lpAmount).mul(10**e.lpMint.decimals).toFixed(0,L.ROUND_DOWN));this.logDebug("baseReserve:",t.toString(),"quoteReserve:",n.toString()),this.logDebug("tokenIn:",a?e.mintA.symbol:e.mintB.symbol,"amountIn:",u.toString(),"amountInFee:",l.fee?.toString()??0,"anotherToken:",a?e.mintB.symbol:e.mintA.symbol,"slippage:",`${i.toSignificant()}%`);let p=a?"base":"quote";this.logDebug("input side:",p);let f=m.mul(d).div(p==="base"?t:n),y={amount:At,fee:void 0,expirationTime:void 0};if(!m.isZero()){let k=Fp(f,t,n,d);this.logDebug("lpAmountData:",{amountA:k.amountA.toString(),amountB:k.amountB.toString()}),y=ke(k[a?"amountB":"amountA"],e[a?"mintB":"mintA"].extensions.feeConfig,s,!0)}let b=new Ye(new ve(1)).add(i),g=new Ye(new ve(1)).sub(i),P=ke(b.mul(y.amount.sub(y.fee??new ve(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0),w=ke(g.mul(y.amount.sub(y.fee??new ve(0))).quotient,e[a?"mintB":"mintA"].extensions.feeConfig,s,!0);return this.logDebug("anotherAmount:",y.amount.toString(),"anotherAmountFee:",y.fee?.toString()??0,"maxAnotherAmount:",P.amount.toString(),"maxAnotherAmountFee:",P.fee?.toString()??0),{inputAmountFee:l,anotherAmount:y,maxAnotherAmount:P,minAnotherAmount:w,liquidity:f}}};function Fp(r,e,t,n){let o=r.mul(e).div(n);!o.isZero()&&!r.mul(e).mod(n).isZero()&&(o=o.add(new ve(1)));let i=r.mul(t).div(n);return!i.isZero()&&!r.mul(t).mod(n).isZero()&&(i=i.add(new ve(1))),{amountA:o,amountB:i}}import{PublicKey as zn}from"@solana/web3.js";import{createTransferInstruction as Rc,TOKEN_PROGRAM_ID as We,TOKEN_2022_PROGRAM_ID as Tr}from"@solana/spl-token";import Ir from"bn.js";var xc={[os.toBase58()]:3},Sc={3:os};var ta=O([Pe(5),Pe(8),C("ownAddress"),A("vaultSignerNonce"),C("baseMint"),C("quoteMint"),C("baseVault"),A("baseDepositsTotal"),A("baseFeesAccrued"),C("quoteVault"),A("quoteDepositsTotal"),A("quoteFeesAccrued"),A("quoteDustThreshold"),C("requestQueue"),C("eventQueue"),C("bids"),C("asks"),A("baseLotSize"),A("quoteLotSize"),A("feeRateBps"),A("referrerRebatesAccrued"),Pe(7)]),Kc={3:ta};import{PublicKey as Cc}from"@solana/web3.js";var kr=de("Serum"),hr=class{static getProgramId(e){let t=Sc[e];return t||kr.logWithError("invalid version","version",e),t}static getVersion(e){let t=e.toBase58(),n=xc[t];return n||kr.logWithError("invalid program id","programId",t),n}static getStateLayout(e){let t=Kc[e];return t||kr.logWithError(!!t,"invalid version","version",e),t}static getLayouts(e){return{state:this.getStateLayout(e)}}static getAssociatedAuthority({programId:e,marketId:t}){let n=[t.toBuffer()],o=0,i;for(;o<100;){try{let s=n.concat(Buffer.from([o]),Buffer.alloc(7));i=Cc.createProgramAddressSync(s,e)}catch(s){if(s instanceof TypeError)throw s;o++;continue}return{publicKey:i,nonce:o}}return kr.logWithError("unable to find a viable program address nonce","params",{programId:e,marketId:t}),{publicKey:Cc.default,nonce:o}}};import{PublicKey as ne,SystemProgram as Vp,TransactionInstruction as Wp}from"@solana/web3.js";import Qn from"bn.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as Dp,TOKEN_2022_PROGRAM_ID as qp,TOKEN_PROGRAM_ID as Up}from"@solana/spl-token";function Gp(r,e,t,n,o,i,s,a,c,u,l,m,d,p,f){let y=[],b=[B({pubkey:Up,isWritable:!1}),B({pubkey:qp,isWritable:!1}),B({pubkey:Dp,isWritable:!1}),B({pubkey:Vp.programId,isWritable:!1}),B({pubkey:e,isSigner:!0})];b.push(B({pubkey:t})),b.push(B({pubkey:o}));let g=[c,u],P=[l,m],w=[i,s,a];for(let h=0;h<g.length;h++){let I=g[h],S=w[h]===I.mintA.address;if(b.push(B({pubkey:new ne(I.programId),isWritable:!1})),h===g.length-1?b.push(B({pubkey:o})):b.push(B({pubkey:n})),b.push(B({pubkey:new ne(w[h])})),b.push(B({pubkey:new ne(w[h+1])})),I.version===6){let T=P[h];b.push(B({pubkey:new ne(T.config.id)})),b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(S?T.vault.A:T.vault.B)})),b.push(B({pubkey:new ne(S?T.vault.B:T.vault.A)})),b.push(B({pubkey:new ne(I.observationId)})),b.push(B({pubkey:An})),b.push(B({pubkey:Ve(new ne(I.programId),new ne(I.id)).publicKey})),y.push(Xp(I.sqrtPriceX64.toString(),S));for(let K of f[h]??[])b.push(B({pubkey:new ne(K)}))}else if(I.version===5){let T=P[h];b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(T.authority),isWritable:!1})),b.push(B({pubkey:new ne(T.marketProgramId)})),b.push(B({pubkey:new ne(T.marketAuthority)})),b.push(B({pubkey:Qa,isWritable:!1})),b.push(B({pubkey:new ne(T.openOrders)})),b.push(B({pubkey:new ne(T.vault.A)})),b.push(B({pubkey:new ne(T.vault.B)})),b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(T.marketId)})),b.push(B({pubkey:new ne(T.marketBids)})),b.push(B({pubkey:new ne(T.marketAsks)})),b.push(B({pubkey:new ne(T.marketEventQueue)})),b.push(B({pubkey:new ne(T.marketBaseVault)})),b.push(B({pubkey:new ne(T.marketQuoteVault)}))}else if(I.version===4){let T=P[h],K=I.status!==1;b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(T.authority),isWritable:!1})),b.push(B({pubkey:new ne(K?T.id:T.marketProgramId)})),b.push(B({pubkey:new ne(K?T.id:T.marketAuthority)})),b.push(B({pubkey:new ne(K?T.id:T.openOrders)})),b.push(B({pubkey:new ne(T.vault.A)})),b.push(B({pubkey:new ne(T.vault.B)})),b.push(B({pubkey:new ne(K?T.id:T.marketId)})),b.push(B({pubkey:new ne(K?T.id:T.marketBids)})),b.push(B({pubkey:new ne(K?T.id:T.marketAsks)})),b.push(B({pubkey:new ne(K?T.id:T.marketEventQueue)})),b.push(B({pubkey:new ne(K?T.id:T.marketBaseVault)})),b.push(B({pubkey:new ne(K?T.id:T.marketQuoteVault)}))}else if(I.version===7){let T=P[h];b.push(B({pubkey:new ne(T.authority)})),b.push(B({pubkey:new ne(T.config.id)})),b.push(B({pubkey:new ne(T.id)})),b.push(B({pubkey:new ne(S?T.vault.A:T.vault.B)})),b.push(B({pubkey:new ne(S?T.vault.B:T.vault.A)})),b.push(B({pubkey:new ne(I.observationId)}))}else throw Error("pool type error")}let k=O([V("insId"),A("amountIn"),A("amountOut"),X(Z(),y.length,"clmmPriceLimit")]),x=Buffer.alloc(k.span);return k.encode({insId:0,amountIn:d,amountOut:p,clmmPriceLimit:y},x),new Wp({keys:b,programId:r,data:x})}function Xp(r,e){if(r)if(e){let t=new Qn(r).div(new Qn(25));return t.gt(nr)?t:nr}else{let t=new Qn(r).mul(new Qn(25));return t.lt(or)?t:or}else return e?nr:or}function Lc({routeProgram:r,ownerInfo:e,inputMint:t,swapInfo:n}){if(n.routeType==="amm")if(n.poolInfo[0].version===6){let o=n.poolKey[0],i=tt(o),s=t.equals(i.mintA.address)?Ot.add(Bt):vt.sub(Bt);return Ie.makeSwapBaseInInstructions({poolInfo:o,poolKeys:o,observationId:n.poolInfo[0].observationId,ownerInfo:{wallet:e.wallet,tokenAccountA:i.mintA.address.equals(t)?e.sourceToken:e.destinationToken,tokenAccountB:i.mintA.address.equals(t)?e.destinationToken:e.sourceToken},inputMint:t,amountIn:n.amountIn.amount.raw,amountOutMin:n.minAmountOut.amount.raw.sub(n.minAmountOut.fee?.raw??new Qn(0)),sqrtPriceLimitX64:s,remainingAccounts:n.remainingAccounts[0]??[]})}else if(n.poolInfo[0].version===7){let o=n.poolInfo[0],i=t.toString()===n.poolInfo[0].mintA.address;return{signers:[],instructions:[wr(o.programId,e.wallet,o.authority,o.configId,o.id,e.sourceToken,e.destinationToken,i?o.vaultA:o.vaultB,i?o.vaultB:o.vaultA,i?o.mintProgramA:o.mintProgramB,i?o.mintProgramB:o.mintProgramA,new ne(o[i?"mintA":"mintB"].address),new ne(o[i?"mintB":"mintA"].address),o.observationId,n.amountIn.amount.raw,n.minAmountOut.amount.raw)],lookupTableAddress:[],instructionTypes:[i?E.CpmmSwapBaseIn:E.CpmmSwapBaseOut],address:{}}}else{let o=n.poolKey[0];return{signers:[],instructions:[cr({poolKeys:o,version:n.poolInfo[0].pooltype.includes("StablePool")?5:4,userKeys:{tokenAccountIn:e.sourceToken,tokenAccountOut:e.destinationToken,owner:e.wallet},amountIn:n.amountIn.amount.raw,amountOut:n.minAmountOut.amount.raw.sub(n.minAmountOut.fee?.raw??new Qn(0)),fixedSide:"in"})],lookupTableAddress:o.lookupTableAccount?[o.lookupTableAccount]:[],instructionTypes:[n.poolInfo[0].pooltype.includes("StablePool")?E.AmmV5SwapBaseIn:E.AmmV4SwapBaseIn],address:{}}}else if(n.routeType==="route"){let o=n.poolInfo[0],i=n.poolInfo[1],s=n.poolKey[0],a=n.poolKey[1];if(e.routeToken===void 0)throw Error("owner route token account check error");return{signers:[],instructions:[Gp(r,e.wallet,e.sourceToken,e.routeToken,e.destinationToken,t.toString(),n.middleToken.mint.toString(),n.outputMint.toString(),o,i,s,a,n.amountIn.amount.raw,n.minAmountOut.amount.raw.sub(n.minAmountOut.fee?.raw??new Qn(0)),n.remainingAccounts)],instructionTypes:[E.RouteSwap],lookupTableAddress:[s.lookupTableAccount,a.lookupTableAccount].filter(c=>c!==void 0),address:{}}}else throw Error("route type error")}var mn=new Ir(0),ci=class extends Ke{constructor(e){super(e)}async getWSolAccounts(){this.scope.checkOwner(),await this.scope.account.fetchWalletTokenAccounts();let e=this.scope.account.tokenAccounts.filter(t=>t.mint.equals(H));return e.sort((t,n)=>t.isAssociated?1:n.isAssociated||t.amount.lt(n.amount)?-1:1),e}async unWrapWSol(e){let{amount:t,tokenProgram:n,txVersion:o=1,feePayer:i}=e,s=await this.getWSolAccounts(),a=this.createTxBuilder(i);a.addCustomComputeBudget(e.computeBudgetConfig);let c=j(t);for(let u=0;u<s.length;u++)c.gte(s[u].amount)?(a.addInstruction({instructions:[rn({tokenAccount:s[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]}),c.sub(s[u].amount)):a.addInstruction({instructions:[rn({tokenAccount:s[u].publicKey,payer:this.scope.ownerPubKey,owner:this.scope.ownerPubKey,programId:n})]});return a.versionBuild({txVersion:o})}async wrapWSol(e,t,n,o){let i=this.createTxBuilder(o),s=await hn({connection:this.scope.connection,owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,amount:e,skipCloseAccount:!0});return i.addInstruction(s),i.versionBuild({txVersion:n??1})}async swap({swapInfo:e,swapPoolKeys:t,ownerInfo:n,computeBudgetConfig:o,routeProgram:i,txVersion:s,feePayer:a}){let c=this.createTxBuilder(a),u=e.amountIn,l=e.amountOut,m=u.amount.token.mint.equals(H),d=l.amount.token.mint.equals(H),p=u.amount.token.mint,f=l.amount.token.mint,{account:y,instructionParams:b}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.amount.token.isToken2022?Tr:We,mint:p,notUseTokenAccount:m,owner:this.scope.ownerPubKey,skipCloseAccount:!m,createInfo:m?{payer:this.scope.ownerPubKey,amount:u.amount.raw}:void 0,associatedOnly:m?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});if(b&&c.addInstruction(b),y===void 0)throw Error("input account check error");let g;if(e.routeType==="route"&&!d)g=this.scope.account.getAssociatedTokenAccount(f,l.amount.token.isToken2022?Tr:We);else{let{account:x,instructionParams:h}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:l.amount.token.isToken2022?Tr:We,mint:f,notUseTokenAccount:d,owner:this.scope.ownerPubKey,skipCloseAccount:!0,createInfo:{payer:this.scope.ownerPubKey,amount:0},associatedOnly:d?!1:n.associatedOnly,checkCreateATAOwner:n.checkCreateATAOwner});g=x,h&&c.addInstruction(h)}d&&c.addInstruction({endInstructions:[rn({owner:this.scope.ownerPubKey,payer:this.scope.ownerPubKey,tokenAccount:g,programId:We})],endInstructionTypes:[E.CloseAccount]});let P;if(e.routeType==="route"){let x=e.middleToken;P=this.scope.account.getAssociatedTokenAccount(x.mint,x.isToken2022?Tr:We)}let w=t||await this.computePoolToPoolKeys({pools:e.poolInfoList}),k=Lc({routeProgram:i,inputMint:p,swapInfo:{...e,poolInfo:[...e.poolInfoList],poolKey:w,outputMint:f},ownerInfo:{wallet:this.scope.ownerPubKey,sourceToken:y,routeToken:P,destinationToken:g}});if(e.feeConfig!==void 0){let x=this.createTxBuilder();x.addInstruction({instructions:[Rc(y,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[E.TransferAmount]}),x.addInstruction(k);let{transactions:h}=s===0?await x.sizeCheckBuildV0():await x.sizeCheckBuild();h.length<2&&c.addInstruction({instructions:[Rc(y,e.feeConfig.feeAccount,this.scope.ownerPubKey,e.feeConfig.feeAmount.toNumber())],instructionTypes:[E.TransferAmount]})}return c.addInstruction(k),s===0?c.sizeCheckBuildV0({computeBudgetConfig:o,address:k.address}):c.sizeCheckBuild({computeBudgetConfig:o,address:k.address})}async fetchRoutePoolBasicInfo(e){let{amm:t=Oi,clmm:n=On,cpmm:o=Mi}=e||{},i=await this.scope.connection.getProgramAccounts(t,{dataSlice:{offset:Yo.offsetOf("baseMint"),length:64}}),s=O([C("baseMint"),C("quoteMint")]),a=i.map(p=>({id:p.pubkey,version:4,mintA:s.decode(p.account.data).baseMint,mintB:s.decode(p.account.data).quoteMint})),c=O([C("mintA"),C("mintB")]),l=(await this.scope.connection.getProgramAccounts(n,{filters:[{dataSize:Fn.span}],dataSlice:{offset:Fn.offsetOf("mintA"),length:64}})).map(p=>{let f=c.decode(p.account.data);return{id:p.pubkey,version:6,mintA:f.mintA,mintB:f.mintB}}),d=(await this.scope.connection.getProgramAccounts(o,{dataSlice:{offset:ai.offsetOf("mintA"),length:64}})).map(p=>{let f=c.decode(p.account.data);return{id:p.pubkey,version:7,mintA:f.mintA,mintB:f.mintB}});return{clmmPools:l,ammPools:a,cpmmPools:d}}getAllRoute({inputMint:e,outputMint:t,clmmPools:n,ammPools:o,cpmmPools:i}){e=e.toString()===zn.default.toString()?H:e,t=t.toString()===zn.default.toString()?H:t;let s={},a={},c={},u=[],l={};for(let d of n??[]){if((d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),a[d.id.toString()]=d),d.mintA.equals(e)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:We,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintB.equals(e)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:We,in:[],out:[],mDecimals:0}),l[p].in.push(d)}if(d.mintA.equals(t)){let p=d.mintB.toString();l[p]===void 0&&(l[p]={mintProgram:We,in:[],out:[],mDecimals:0}),l[p].out.push(d)}if(d.mintB.equals(t)){let p=d.mintA.toString();l[p]===void 0&&(l[p]={mintProgram:We,in:[],out:[],mDecimals:0}),l[p].out.push(d)}}let m=[];for(let d of o)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),s[d.id.toBase58()]=d,m.push(d)),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:We,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:We,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:We,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:We,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of i)(d.mintA.equals(e)&&d.mintB.equals(t)||d.mintA.equals(t)&&d.mintB.equals(e))&&(u.push(d),c[d.id.toBase58()]=d),d.mintA.equals(e)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:We,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].in.push(d)),d.mintB.equals(e)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:We,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].in.push(d)),d.mintA.equals(t)&&(l[d.mintB.toBase58()]===void 0&&(l[d.mintB.toBase58()]={mintProgram:We,in:[],out:[],mDecimals:0}),l[d.mintB.toBase58()].out.push(d)),d.mintB.equals(t)&&(l[d.mintA.toBase58()]===void 0&&(l[d.mintA.toBase58()]={mintProgram:We,in:[],out:[],mDecimals:0}),l[d.mintA.toBase58()].out.push(d));for(let d of Object.keys(l)){if(l[d].in.length===1&&l[d].out.length===1&&l[d].in[0].id.equals(l[d].out[0].id)){delete l[d];continue}if(l[d].in.length===0||l[d].out.length===0){delete l[d];continue}let p=l[d];for(let f of p.in)for(let y of p.out)f.version===6&&a[f.id.toString()]===void 0?a[f.id.toString()]=f:f.version===7&&c[f.id.toString()]===void 0?c[f.id.toString()]=f:(f.version===4||f.version===5)&&s[f.id.toString()]===void 0&&(s[f.id.toString()]=f),y.version===6&&a[y.id.toString()]===void 0?a[y.id.toString()]=y:y.version===7&&c[y.id.toString()]===void 0?c[y.id.toString()]=y:(y.version===4||y.version===5)&&s[y.id.toString()]===void 0&&(s[y.id.toString()]=y)}return{directPath:u,addLiquidityPools:m,routePathDict:l,needSimulate:Object.values(s),needTickArray:Object.values(a),cpmmPoolList:Object.values(c)}}async fetchSwapRoutesData({routes:e,inputMint:t,outputMint:n}){let o=new Set([...e.needTickArray.map(y=>[y.mintA.toBase58(),y.mintB.toBase58()]).flat(),t.toString(),n.toString()]);console.log("fetching amm pools info, total: ",e.needSimulate.length);let i=await this.scope.liquidity.getRpcPoolInfos(e.needSimulate.map(y=>y.id)),s=mr(i),a={};Object.values(s).forEach(y=>{o.delete(y.mintA.address),a[y.mintA.address]={address:new zn(y.mintA.address),programId:We,mintAuthority:null,supply:BigInt(0),decimals:y.mintA.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0},o.delete(y.mintB.address),a[y.mintB.address]={address:new zn(y.mintB.address),programId:We,mintAuthority:null,supply:BigInt(0),decimals:y.mintB.decimals,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}}),console.log("fetching cpmm pools info, total: ",e.cpmmPoolList.length);let c=await this.scope.cpmm.getRpcPoolInfos(e.cpmmPoolList.map(y=>y.id.toBase58()),!0);Object.values(c).forEach(y=>{let[b,g]=[y.mintA.toBase58(),y.mintB.toBase58()];y.mintProgramA.equals(We)?(o.delete(b),a[b]={address:y.mintA,programId:y.mintProgramA,mintAuthority:null,supply:BigInt(0),decimals:y.mintDecimalA,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):o.add(b),y.mintProgramB.equals(We)?(o.delete(g),a[g]={address:y.mintB,programId:y.mintProgramB,mintAuthority:null,supply:BigInt(0),decimals:y.mintDecimalB,isInitialized:!0,freezeAuthority:null,tlvData:Buffer.from("0","hex"),feeConfig:void 0}):o.add(g)}),console.log("fetching mints info, total: ",o.size);let u=await Yn({connection:this.scope.connection,mints:Array.from(o).map(y=>new zn(y))});a={...a,...u};let l=this.scope.cpmm.toComputePoolInfos({pools:c,mintInfos:a});console.log("fetching clmm pools info, total:",e.needTickArray.length);let m=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:e.needTickArray.map(y=>y.id)}),{computeClmmPoolInfo:d,computePoolTickData:p}=await this.scope.clmm.getComputeClmmPoolInfos({clmmPoolsRpcInfo:m,mintInfos:a}),f=Object.keys(e.routePathDict).reduce((y,b)=>({...y,[b]:{...e.routePathDict[b],mintProgram:a[b].programId,mDecimals:a[b].decimals,in:e.routePathDict[b].in.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()]),out:e.routePathDict[b].out.map(g=>s[g.id.toBase58()]||d[g.id.toBase58()]||l[g.id.toBase58()])}}),{});return{mintInfos:a,ammPoolsRpcInfo:i,ammSimulateCache:s,clmmPoolsRpcInfo:m,computeClmmPoolInfo:d,computePoolTickData:p,computeCpmmData:l,routePathDict:f}}getAllRouteComputeAmountOut({inputTokenAmount:e,outputToken:t,directPath:n,routePathDict:o,simulateCache:i,tickCache:s,slippage:a,chainTime:c,epochInfo:u,feeConfig:l}){let m=l===void 0?new Ir(0):e.raw.mul(new Ir(l.feeBps.toNumber())).div(new Ir(1e4)),d=e.raw.sub(m),p=new we(e.token,d),f=l===void 0?void 0:{feeAmount:m,feeAccount:l.feeAccount},y={...t,address:rt(t.address).toString()},b=[];for(let g of n)try{b.push({...this.computeAmountOut({itemPool:g,tickCache:s,simulateCache:i,chainTime:c,epochInfo:u,slippage:a,outputToken:y,amountIn:p}),feeConfig:f})}catch(P){this.logDebug("direct error",g.version,g.id.toString(),P.message)}this.logDebug("direct done");for(let[g,P]of Object.entries(o)){let w={chainId:101,address:g,programId:P.mintProgram.toBase58(),logoURI:"",symbol:"",name:"",decimals:P.mDecimals,tags:[],extensions:{}},k=P.in.map(h=>{try{return{pool:h,data:this.computeAmountOut({itemPool:h,tickCache:s,simulateCache:i,chainTime:c,epochInfo:u,slippage:a,outputToken:w,amountIn:p})}}catch(I){this.logDebug("route in error",h.version,h.id.toString(),I.message);return}}).sort((h,I)=>{let S=h===void 0?mn:h.data.amountOut.amount.raw.sub(h.data.amountOut.fee?.raw??mn),T=I===void 0?mn:I.data.amountOut.amount.raw.sub(I.data.amountOut.fee?.raw??mn);return S.lt(T)?1:-1})[0];if(k===void 0)continue;let x=new we(ar(w),k.data.amountOut.amount.raw.sub(k.data.amountOut.fee?.raw??mn));for(let h of P.out)try{let I=this.computeAmountOut({itemPool:h,tickCache:s,simulateCache:i,chainTime:c,epochInfo:u,slippage:a,outputToken:y,amountIn:x});b.push({...I,allTrade:!!(k.data.allTrade&&I.allTrade),amountIn:k.data.amountIn,amountOut:I.amountOut,minAmountOut:I.minAmountOut,currentPrice:void 0,executionPrice:new L(new gt({baseToken:k.data.amountIn.amount.token,denominator:k.data.amountIn.amount.raw,quoteToken:I.amountOut.amount.token,numerator:I.amountOut.amount.raw.sub(I.amountOut.fee?.raw??mn)}).toFixed()),priceImpact:new L(k.data.priceImpact.add(I.priceImpact).toFixed()),fee:[k.data.fee[0],I.fee[0]],routeType:"route",poolInfoList:[k.pool,h],remainingAccounts:[k.data.remainingAccounts[0],I.remainingAccounts[0]],minMiddleAmountFee:I.amountOut.fee?.raw?new we(k.data.amountOut.amount.token,(k.data.amountOut.fee?.raw??mn).add(I.amountOut.fee?.raw??mn)):void 0,middleToken:k.data.amountOut.amount.token,poolReady:k.data.poolReady&&I.poolReady,poolType:[k.data.poolType,I.poolType],feeConfig:f,expirationTime:Dt(k.data.expirationTime,I.expirationTime)})}catch(I){this.logDebug("route out error",h.version,h.id.toString(),I.message)}}return b.filter(g=>(g.allTrade||this.logDebug(`pool ${g.poolInfoList.map(P=>P.id.toString()).join(",")} filter out since not all trade`),g.allTrade)).sort((g,P)=>g.amountOut.amount.raw.sub(P.amountOut.amount.raw).gt(mn)?-1:1)}computeAmountOut({itemPool:e,tickCache:t,simulateCache:n,chainTime:o,epochInfo:i,slippage:s,outputToken:a,amountIn:c}){if(e.version===6){let{allTrade:u,realAmountIn:l,amountOut:m,minAmountOut:d,expirationTime:p,currentPrice:f,executionPrice:y,priceImpact:b,fee:g,remainingAccounts:P,executionPriceX64:w}=Se.computeAmountOutFormat({poolInfo:e,tickArrayCache:t[e.id.toString()],amountIn:c.raw,tokenOut:a,slippage:s,epochInfo:i,catchLiquidityInsufficient:!0});return{allTrade:u,amountIn:l,amountOut:m,minAmountOut:d,currentPrice:new L(f.toFixed()),executionPrice:new L(y.toFixed()),priceImpact:new L(b.toFixed()),fee:[g],remainingAccounts:[P],routeType:"amm",poolInfoList:[e],poolReady:e.startTime<o,poolType:"CLMM",slippage:s,clmmExPriceX64:[w],expirationTime:Dt(l.expirationTime,p)}}else if(e.version===7){let{allTrade:u,executionPrice:l,amountOut:m,minAmountOut:d,priceImpact:p,fee:f}=this.scope.cpmm.computeSwapAmount({pool:e,outputMint:a.address,amountIn:c.raw,slippage:s});return{allTrade:u,amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:jo({...a,amount:m}),fee:void 0,expirationTime:void 0},minAmountOut:{amount:jo({...a,amount:d}),fee:void 0,expirationTime:void 0},currentPrice:e.poolPrice,executionPrice:l,priceImpact:p,fee:[new we(c.token,f)],remainingAccounts:[],routeType:"amm",poolInfoList:[e],poolReady:e.openTime.toNumber()<o,poolType:"CPMM",slippage:s,clmmExPriceX64:[void 0],expirationTime:void 0}}else{if(![1,6,7].includes(n[e.id.toString()].status))throw Error("swap error");let{amountOut:u,minAmountOut:l,currentPrice:m,executionPrice:d,priceImpact:p,fee:f}=this.scope.liquidity.computeAmountOut({poolInfo:n[e.id.toString()],amountIn:c.raw,mintIn:c.token.mint,mintOut:a.address,slippage:s});return{amountIn:{amount:c,fee:void 0,expirationTime:void 0},amountOut:{amount:jo({...a,amount:u}),fee:void 0,expirationTime:void 0},minAmountOut:{amount:jo({...a,amount:l}),fee:void 0,expirationTime:void 0},currentPrice:m,executionPrice:d,priceImpact:p,fee:[new we(c.token,f)],routeType:"amm",poolInfoList:[e],remainingAccounts:[],poolReady:Number(n[e.id].openTime)<o,poolType:e.version===5?"STABLE":void 0,expirationTime:void 0,allTrade:!0,slippage:s,clmmExPriceX64:[void 0]}}}async computePoolToPoolKeys({pools:e,clmmRpcData:t={},ammRpcData:n={}}){let o=new Set(e.filter(u=>u.version===6&&!t[u.id.toString()]).map(u=>u.id.toString()));if(o.size>0){let u=await this.scope.clmm.getRpcClmmPoolInfos({poolIds:Array.from(o)});Object.keys(u).forEach(l=>{t[l]=u[l]})}let i=new Set(e.filter(u=>u.version===4&&!n[u.id.toString()]).map(u=>u.id.toString()));if(i.size>0){let u=await this.scope.liquidity.getRpcPoolInfos(Array.from(i));Object.keys(u).forEach(l=>{n[l]=u[l]})}let s=new Set(e.filter(u=>u.version===4).map(u=>u.marketId)),a={};s.size>0&&(await xe(this.scope.connection,Array.from(s).map(l=>({pubkey:new zn(l)})))).forEach(l=>{if(!l.accountInfo)return;let m=ta.decode(l.accountInfo.data);a[l.pubkey.toBase58()]={marketId:l.pubkey.toString(),marketProgramId:l.accountInfo.owner.toString(),marketAuthority:hr.getAssociatedAuthority({programId:l.accountInfo.owner,marketId:l.pubkey}).publicKey.toString(),marketBaseVault:m.baseVault.toString(),marketQuoteVault:m.quoteVault.toString(),marketBids:m.bids.toString(),marketAsks:m.asks.toString(),marketEventQueue:m.eventQueue.toString()}});let c=[];return e.forEach(u=>{if(u.version===6){let l=t[u.id.toString()],m={programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.startTime),vault:{A:l.vaultA.toBase58(),B:l.vaultB.toBase58()},config:{...u.ammConfig,id:u.ammConfig.id.toString(),defaultRange:0,defaultRangePoint:[]},rewardInfos:[],observationId:u.observationId.toBase58(),exBitmapAccount:u.exBitmapAccount.toBase58()};c.push(m)}else if(u.version===4){let l=n[u.id.toString()],m={programId:u.programId,id:u.id,mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),vault:{A:l.baseVault.toBase58(),B:l.quoteVault.toBase58()},authority:zs({programId:new zn(u.programId)}).publicKey.toString(),openOrders:l.openOrders.toBase58(),targetOrders:l.targetOrders.toBase58(),mintLp:u.lpMint,...a[u.marketId]};c.push(m)}else u.version===7&&c.push({observationId:u.observationId.toBase58(),programId:u.programId.toBase58(),id:u.id.toBase58(),mintA:u.mintA,mintB:u.mintB,openTime:String(u.openTime),authority:mo(u.programId).publicKey.toBase58(),vault:{A:u.vaultA.toBase58(),B:u.vaultB.toBase58()},mintLp:lt({address:u.mintLp.toBase58(),programId:We.toBase58(),decimals:u.lpDecimals}),config:{id:u.configId.toBase58(),...u.configInfo,protocolFeeRate:u.configInfo.protocolFeeRate.toNumber(),tradeFeeRate:u.configInfo.tradeFeeRate.toNumber(),fundFeeRate:u.configInfo.fundFeeRate.toNumber(),createPoolFee:u.configInfo.createPoolFee.toString()}})}),c}};import{PublicKey as Qp,Transaction as na,TransactionInstruction as zp}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as Hp}from"@solana/spl-token";import Nc from"bn.js";var mt=class extends Ke{static getPdaPoolId(e,t){return ue([mt.SEED_CONFIG.pool.id,t.toBuffer()],e)}static getPdaOwnerId(e,t,n,o){return ue([mt.SEED_CONFIG.owner.id,t.toBuffer(),n.toBuffer(),Buffer.from(new Nc(o).toArray())],e)}static async getAllInfo({connection:e,programId:t,poolIds:n,wallet:o,chainTime:i}){if(n.length===0)return[];let s=n.map(l=>mt.getPdaPoolId(t,l).publicKey),a=[];for(let l=0;l<mt.VERSION_PROJECT.length;l++)a.push(...s.map(m=>mt.getPdaOwnerId(t,m,o,l).publicKey));let c=await _t(e,[...s,...a]),u=[];for(let l=0;l<c.length;l++){let m=Math.floor(l/n.length),d=l%n.length,p=s[d],f=a[l],y=c[d],b=c[n.length+l];if(!(y&&b)||y.data.length!==mt.POOL_LAYOUT.span||b.data.length!==mt.OWNER_LAYOUT.span)continue;let g=mt.POOL_LAYOUT.decode(y.data),P=mt.OWNER_LAYOUT.decode(b.data),w=g.openTime.toNumber(),k=g.endTime.toNumber(),x=P.tokenInfo.map(S=>S.debtAmount.gt(new Nc(0))).filter(S=>!S).length!==3,h=i>w&&i<k&&g.status===1,I=x&&h;u.push({programId:t,poolId:p,ammId:g.ammId,ownerAccountId:f,snapshotLpAmount:P.lpAmount,project:mt.VERSION_PROJECT[m],openTime:w,endTime:k,canClaim:I,canClaimErrorType:x?h?void 0:"outOfOperationalTime":"alreadyClaimIt",tokenInfo:g.tokenInfo.map((S,T)=>({mintAddress:S.mintAddress,mintVault:S.mintVault,mintDecimals:S.mintDecimals,perLpLoss:S.perLpLoss,debtAmount:P.tokenInfo[T].debtAmount.add(P.tokenInfo[T].claimedAmount)}))})}return u}async makeClaimTransaction({poolInfo:e,ownerInfo:t,feePayer:n}){t.wallet||this.scope.checkOwner();let o=this.createTxBuilder(n),i=t.wallet||this.scope.ownerPubKey,s=[];for(let u of e.tokenInfo){let{account:l,instructionParams:m}=await this.scope.account.getOrCreateTokenAccount({mint:u.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:u.mintAddress.equals(Ne.WSOL.mint),createInfo:{payer:i,amount:0},skipCloseAccount:!u.mintAddress.equals(Ne.WSOL.mint),associatedOnly:u.mintAddress.equals(Ne.WSOL.mint)?!1:t.associatedOnly});m&&o.addInstruction(m),s.push(l)}o.addInstruction({instructions:[mt.makeClaimInstruction({programId:e.programId,poolInfo:e,ownerInfo:{wallet:i,ownerPda:e.ownerAccountId,claimAddress:s}})]});let{transaction:a,signers:c}=o.build();return[{transaction:a,signer:c}]}async makeClaimAllTransaction({poolInfos:e,ownerInfo:t,feePayer:n}){let o=this.createTxBuilder(n),i=t.wallet||this.scope.ownerPubKey,s={};for(let l of e){let m=[];for(let d of l.tokenInfo){let{account:p,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({mint:d.mintAddress,owner:this.scope.ownerPubKey,notUseTokenAccount:d.mintAddress.equals(Ne.WSOL.mint),createInfo:{payer:i,amount:0},skipCloseAccount:!d.mintAddress.equals(Ne.WSOL.mint),associatedOnly:d.mintAddress.equals(Ne.WSOL.mint)?!1:t.associatedOnly});f&&o.addInstruction(f),p&&(s[d.mintAddress.toString()]=p,m.push(p))}o.addInstruction({instructions:[mt.makeClaimInstruction({programId:l.programId,poolInfo:l,ownerInfo:{wallet:i,ownerPda:l.ownerAccountId,claimAddress:m}})]})}let{transaction:a,signers:c}=o.build(),u=o.allInstructions;return ns(u,[i,...c.map(l=>l.publicKey)])?[{transaction:a,signer:c}]:[{transaction:new na().add(...u.slice(0,o.AllTxData.instructions.length-1)),signer:c},{transaction:new na().add(...u.slice(o.AllTxData.instructions.length-1)),signer:[]},{transaction:new na().add(...o.AllTxData.endInstructions),signer:[]}]}static makeClaimInstruction({programId:e,poolInfo:t,ownerInfo:n}){let o=O([]),i=[{pubkey:n.wallet,isSigner:!0,isWritable:!0},{pubkey:t.poolId,isSigner:!1,isWritable:!0},{pubkey:n.ownerPda,isSigner:!1,isWritable:!0},...n.claimAddress.map(c=>({pubkey:c,isSigner:!1,isWritable:!0})),...t.tokenInfo.map(({mintVault:c})=>({pubkey:c,isSigner:!1,isWritable:!0})),{pubkey:Hp,isSigner:!1,isWritable:!1}],s=Buffer.alloc(o.span);o.encode({},s);let a=Buffer.from([10,66,208,184,161,6,191,98,...s]);return new zp({keys:i,programId:e,data:a})}},Mt=mt;Tt(Mt,"CLAIMED_NUM",3),Tt(Mt,"POOL_LAYOUT",O([Pe(8),V("bump"),V("status"),A("openTime"),A("endTime"),C("ammId"),X(O([V("mintDecimals"),C("mintAddress"),C("mintVault"),A("perLpLoss"),A("totalClaimedAmount")]),mt.CLAIMED_NUM,"tokenInfo"),X(A(),10,"padding")])),Tt(Mt,"OWNER_LAYOUT",O([Pe(8),V("bump"),V("version"),C("poolId"),C("owner"),A("lpAmount"),X(O([C("mintAddress"),A("debtAmount"),A("claimedAmount")]),mt.CLAIMED_NUM,"tokenInfo"),X(A(),4,"padding")])),Tt(Mt,"DEFAULT_POOL_ID",["58oQChx4yWmvKdwLLZzBi4ChoCc2fqCUWBkwMihLYQo2","6UmmUiYoBjSrhakAobJw8BvkmJtDVxaeBtbt7rxWo1mg","AVs9TA4nWDzfPJE9gGVNJMVhcQy3V9PGazuz33BfG2RA","DVa7Qmb5ct9RCpaU7UTpSaf3GVMYz17vNVU67XpdCRut","7XawhbbxtsRcQA8KTkHT9f9nc6d69UwqCDh6U5EEbEmX","6a1CsrpeZubDjEJE9s1CMVheB6HWM5d7m1cj2jkhyXhj","EoNrn8iUhwgJySD1pHu8Qxm5gSQqLK3za4m8xzD2RuEb","AceAyRTWt4PyB2pHqf2qhDgNZDtKVNaxgL8Ru3V4aN1P","6tmFJbMk5yVHFcFy7X2K8RwHjKLr6KVFLYXpgpBNeAxB"].map(e=>new Qp(e))),Tt(Mt,"SEED_CONFIG",{pool:{id:Buffer.from("pool_seed","utf8")},owner:{id:Buffer.from("user_claim_seed","utf8")}}),Tt(Mt,"VERSION_PROJECT",[void 0,"Francium","Tulip","Larix"]);import{PublicKey as mi}from"@solana/web3.js";import Mc from"bn.js";import{SYSVAR_CLOCK_PUBKEY as Yp,TransactionInstruction as Oc}from"@solana/web3.js";import{TOKEN_PROGRAM_ID as vc}from"@solana/spl-token";var jp=O([V("instruction"),su("amount")]),li=O([V("instruction")]);function Br({programId:r},e){let t=[{pubkey:vc,isSigner:!1,isWritable:!1},{pubkey:Na,isSigner:!1,isWritable:!1},...Object.entries(e).map(([o,i])=>({pubkey:i,isSigner:o==="userOwner",isWritable:!["authority","userOwner"].includes(o)}))],n=Buffer.alloc(li.span);return li.encode({instruction:2},n),new Oc({keys:t,programId:r,data:n})}function oa(r){let{poolConfig:e,userKeys:t,side:n}=r,o=n==="base"?t.baseTokenAccount:t.quoteTokenAccount,i=n==="base"?e.baseVault:e.quoteVault,s=Buffer.alloc(li.span);li.encode({instruction:2},s);let a=[{pubkey:vc,isWritable:!1,isSigner:!1},{pubkey:Yp,isWritable:!1,isSigner:!1},{pubkey:e.id,isWritable:!0,isSigner:!1},{pubkey:e.authority,isWritable:!1,isSigner:!1},{pubkey:i,isWritable:!0,isSigner:!1},{pubkey:o,isWritable:!0,isSigner:!1},{pubkey:t.ledgerAccount,isWritable:!0,isSigner:!1},{pubkey:t.owner,isWritable:!1,isSigner:!0}];return new Oc({programId:e.programId,keys:a,data:s})}var Zp={[Bo.IDO_PROGRAM_ID_V1.toString()]:1,[Bo.IDO_PROGRAM_ID_V2.toString()]:2,[Bo.IDO_PROGRAM_ID_V3.toString()]:3,[Bo.IDO_PROGRAM_ID_V4.toString()]:4},fo=class extends Ke{async claim({ownerInfo:e,idoKeys:t,associatedOnly:n=!0,checkCreateATAOwner:o=!1,txVersion:i,feePayer:s}){let a=this.createTxBuilder(s),c=Zp[t.programId];c||this.logAndCreateError("invalid version",c);let u=tt(t),[l,m]=[!new Mc(e.coin).isZero(),!new Mc(e.pc).isZero()],d=u.projectInfo.mint.address.equals(H),{account:p,instructionParams:f}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.projectInfo.mint.programId,mint:u.projectInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!d,notUseTokenAccount:d,associatedOnly:d?!1:n,checkCreateATAOwner:o});!p&&l&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),l&&f&&a.addInstruction(f);let y=u.buyInfo.mint.address.equals(H),{account:b,instructionParams:g}=await this.scope.account.getOrCreateTokenAccount({tokenProgram:u.buyInfo.mint.programId,mint:u.buyInfo.mint.address,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!y,notUseTokenAccount:y,associatedOnly:y?!1:n,checkCreateATAOwner:o});if(!p&&m&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address),m&&g&&a.addInstruction(g),(!p||!b)&&this.logAndCreateError("target token accounts not found","mint",t.projectInfo.mint.address,t.buyInfo.mint.address),c===3)return a.addInstruction({instructions:[...l?[Br({programId:u.programId},{idoId:u.id,authority:u.authority,poolTokenAccount:u.projectInfo.vault,userTokenAccount:p,userIdoInfo:new mi(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[],...m?[Br({programId:new mi(t.programId)},{idoId:u.id,authority:u.authority,poolTokenAccount:u.buyInfo.vault,userTokenAccount:b,userIdoInfo:new mi(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]:[]]}).versionBuild({txVersion:i});if(c<3)return!l&&!m&&this.logAndCreateError("no claimable rewards"),a.addInstruction({instructions:[Br({programId:u.programId},{idoId:u.id,authority:u.authority,poolQuoteTokenAccount:u.buyInfo.vault,poolBaseTokenAccount:u.projectInfo.vault,userQuoteTokenAccount:b,userBaseTokenAccount:p,userIdoInfo:new mi(e.userIdoInfo),userOwner:this.scope.ownerPubKey})]}).versionBuild({txVersion:i});let P={poolConfig:{id:u.id,programId:u.programId,authority:u.authority,baseVault:u.projectInfo.vault,quoteVault:u.buyInfo.vault,baseToken:t.projectInfo.mint,quoteToken:t.buyInfo.mint},userKeys:{baseTokenAccount:p,quoteTokenAccount:b,ledgerAccount:new mi(e.userIdoInfo),owner:this.scope.ownerPubKey}};return a.addInstruction({instructions:[...l?[oa({...P,side:"base"})]:[],...m?[oa({...P,side:"quote"})]:[]]}).versionBuild({txVersion:i})}};var $p=Buffer.from("vault_auth_seed","utf8"),jK=Buffer.from("global_config","utf8"),Jp=Buffer.from("pool","utf8"),ef=Buffer.from("pool_vault","utf8"),tf=Buffer.from("pool_vesting","utf8"),nf=Buffer.from("platform_config","utf8");function Hn(r){return ue([$p],r)}function xr(r,e,t){return ue([Jp,e.toBuffer(),t.toBuffer()],r)}function ia(r,e,t){return ue([ef,e.toBuffer(),t.toBuffer()],r)}function Sr(r){return ue([Buffer.from("__event_authority","utf8")],r)}function ra(r,e){return ue([nf,e.toBuffer()],r)}function sa(r,e,t){return ue([tf,e.toBuffer(),t.toBuffer()],r)}import{SystemProgram as di,TransactionInstruction as Cn}from"@solana/web3.js";import{ASSOCIATED_TOKEN_PROGRAM_ID as _c}from"@solana/spl-token";import Ec from"bn.js";var Ln={initialize:Buffer.from([175,175,109,31,13,152,155,237]),buyExactIn:Buffer.from([250,234,13,123,213,156,19,236]),buyExactOut:Buffer.from([24,211,116,40,105,3,153,56]),sellExactIn:Buffer.from([149,39,222,155,211,124,152,26]),sellExactOut:Buffer.from([95,200,71,34,8,9,11,166]),createVestingAccount:Buffer.from([129,178,2,13,217,172,230,218]),claimVestedToken:Buffer.from([49,33,104,30,189,157,79,35]),createPlatformConfig:Buffer.from([176,90,196,175,253,113,220,20]),claimPlatformFee:Buffer.from([156,39,208,135,76,237,61,72]),updatePlaformConfig:Buffer.from([195,60,76,129,146,45,67,143])};function Fc(r,e,t,n,o,i,s,a,c,u,l,m,d,p,f,y,b,g,P,w,k,x){let h=O([V("decimals"),Xt("name"),Xt("symbol"),Xt("uri")]),I=O([A("totalLockedAmount"),A("cliffPeriod"),A("unlockPeriod")]),S=O([V("index"),A("supply"),A("totalFundRaisingB"),V("migrateType")]),T=O([V("index"),A("supply"),A("totalSellA"),A("totalFundRaisingB"),V("migrateType")]),K=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!1},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!0,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!0},{pubkey:m,isSigner:!1,isWritable:!0},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Vt,isSigner:!1,isWritable:!1},{pubkey:di.programId,isSigner:!1,isWritable:!1},{pubkey:et,isSigner:!1,isWritable:!1},{pubkey:Sr(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}],R=Buffer.alloc(Buffer.from(y,"utf-8").length+Buffer.from(b,"utf-8").length+Buffer.from(g,"utf-8").length+4*3+1),N=Buffer.alloc(I.span),v=Buffer.alloc(P.type==="ConstantCurve"?T.span:S.span);return h.encode({decimals:f,name:y,symbol:b,uri:g},R),P.type==="ConstantCurve"?T.encode({index:0,...P,migrateType:P.migrateType==="amm"?0:1},v):P.type==="FixedCurve"?S.encode({index:1,...P,migrateType:P.migrateType==="amm"?0:1},v):P.type==="LinearCurve"&&S.encode({index:2,...P,migrateType:P.migrateType==="amm"?0:1},v),I.encode({totalLockedAmount:w,cliffPeriod:k,unlockPeriod:x},N),new Cn({keys:K,programId:r,data:Buffer.from([...Ln.initialize,...R,...v,...N])})}function Vc(r,e,t,n,o,i,s,a,c,u,l,m,d,p,f,y,b,g){let P=O([A("amountB"),A("minAmountA"),A("shareFeeRate")]),w=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Sr(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}];g&&w.push({pubkey:g,isSigner:!1,isWritable:!0}),console.log({amountB:f.toString(),minAmountA:y.toString()});let k=Buffer.alloc(P.span);return P.encode({amountB:f,minAmountA:y,shareFeeRate:b??new Ec(0)},k),new Cn({keys:w,programId:r,data:Buffer.from([...Ln.buyExactIn,...k])})}function Wc(r,e,t,n,o,i,s,a,c,u,l,m,d,p,f,y,b,g){let P=O([A("amountA"),A("minAmountB"),A("shareFeeRate")]),w=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!1},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:u,isSigner:!1,isWritable:!0},{pubkey:l,isSigner:!1,isWritable:!1},{pubkey:m,isSigner:!1,isWritable:!1},{pubkey:d,isSigner:!1,isWritable:!1},{pubkey:p,isSigner:!1,isWritable:!1},{pubkey:Sr(r).publicKey,isSigner:!1,isWritable:!1},{pubkey:r,isSigner:!1,isWritable:!1}];g&&w.push({pubkey:g,isSigner:!1,isWritable:!0});let k=Buffer.alloc(P.span);return P.encode({amountA:f,minAmountB:y,shareFeeRate:b??new Ec(0)},k),new Cn({keys:w,programId:r,data:Buffer.from([...Ln.sellExactIn,...k])})}function Dc(r,e,t,n,o,i,s,a,c){let u=O([]),l=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!1},{pubkey:c,isSigner:!1,isWritable:!1},{pubkey:di.programId,isSigner:!1,isWritable:!1},{pubkey:_c,isSigner:!1,isWritable:!1}],m=Buffer.alloc(u.span);return u.encode({},m),new Cn({keys:l,programId:r,data:Buffer.from([...Ln.claimVestedToken,...m])})}function qc(r,e,t,n,o,i){let s=O([A("shareAmount")]),a=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:di.programId,isSigner:!1,isWritable:!1}],c=Buffer.alloc(s.span);return s.encode({shareAmount:i},c),new Cn({keys:a,programId:r,data:Buffer.from([...Ln.createVestingAccount,...c])})}function aa(r,e,t,n,o,i,s,a,c){let u=[{pubkey:e,isSigner:!0,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!0},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:s,isSigner:!1,isWritable:!0},{pubkey:a,isSigner:!1,isWritable:!0},{pubkey:c,isSigner:!1,isWritable:!0},{pubkey:di.programId,isSigner:!1,isWritable:!0},{pubkey:_c,isSigner:!1,isWritable:!0}];return new Cn({keys:u,programId:r,data:Ln.claimPlatformFee})}function Uc(r,e,t,n,o,i,s,a,c,u,l){let m=O([A("platformScale"),A("creatorScale"),A("burnScale"),A("feeRate"),Xt("name"),Xt("web"),Xt("img")]),d=[{pubkey:e,isSigner:!0,isWritable:!0},{pubkey:t,isSigner:!1,isWritable:!1},{pubkey:n,isSigner:!1,isWritable:!1},{pubkey:o,isSigner:!1,isWritable:!0},{pubkey:i,isSigner:!1,isWritable:!0},{pubkey:di.programId,isSigner:!1,isWritable:!1}],p=Buffer.alloc(8*4+Buffer.from(c,"utf-8").length+Buffer.from(u,"utf-8").length+Buffer.from(l,"utf-8").length+4*3);return m.encode({platformScale:s.platformScale,creatorScale:s.creatorScale,burnScale:s.burnScale,feeRate:a,name:c,web:u,img:l},p),new Cn({keys:d,programId:r,data:Buffer.from([...Ln.createPlatformConfig,...p])})}function Gc(r,e,t,n){let o=[{pubkey:e,isSigner:!0,isWritable:!1},{pubkey:t,isSigner:!1,isWritable:!0}],i;if(n.type==="updateClaimFeeWallet"){let s=O([V("index"),C("value")]);i=Buffer.alloc(s.span),s.encode({index:0,value:n.value},i)}else if(n.type==="updateLockNftWallet"){let s=O([V("index"),C("value")]);i=Buffer.alloc(s.span),s.encode({index:1,value:n.value},i)}else if(n.type==="migrateCpLockNftScale"){let s=O([V("index"),A("platformScale"),A("creatorScale"),A("burnScale")]);i=Buffer.alloc(s.span),s.encode({index:2,...n.value},i)}else if(n.type==="updateFeeRate"){let s=O([V("index"),A("value")]);i=Buffer.alloc(s.span),s.encode({index:3,value:n.value},i)}else if(n.type==="updateImg"||n.type==="updateName"||n.type==="updateWeb"){let s=O([V("index"),Xt("value")]);i=Buffer.alloc(Buffer.from(n.value,"utf-8").length+4+1*1),n.type==="updateName"?s.encode({index:4,value:n.value},i):n.type==="updateWeb"?s.encode({index:5,value:n.value},i):n.type==="updateImg"&&s.encode({index:6,value:n.value},i)}else if(n.type==="updateCpConfigId"){o.push({pubkey:n.value,isSigner:!1,isWritable:!1});let s=O([V("index")]);i=Buffer.alloc(s.span),s.encode({index:7},i)}else if(n.type==="updateAll"){console.log("Please note that this update will overwrite all data in the platform account with the new data."),o.push({pubkey:n.value.cpConfigId,isSigner:!1,isWritable:!1});let s=O([V("index"),C("platformClaimFeeWallet"),C("platformLockNftWallet"),A("platformScale"),A("creatorScale"),A("burnScale"),A("feeRate"),Xt("name"),Xt("web"),Xt("img")]);i=Buffer.alloc(1+32+32+8*4+4*3+Buffer.from(n.value.name,"utf-8").length+Buffer.from(n.value.web,"utf-8").length+Buffer.from(n.value.img,"utf-8").length),s.encode({index:8,platformClaimFeeWallet:n.value.platformClaimFeeWallet,platformLockNftWallet:n.value.platformLockNftWallet,platformScale:n.value.migrateCpLockNftScale.platformScale,creatorScale:n.value.migrateCpLockNftScale.creatorScale,burnScale:n.value.migrateCpLockNftScale.burnScale,feeRate:n.value.feeRate,name:n.value.name,web:n.value.web,img:n.value.img},i)}else throw Error("updateInfo params type error");return new Cn({keys:o,programId:r,data:Buffer.from([...Ln.updatePlaformConfig,...i])})}import{NATIVE_MINT as Nr,TOKEN_PROGRAM_ID as kt,createAssociatedTokenAccountIdempotentInstruction as bi}from"@solana/spl-token";import pe from"bn.js";import{PublicKey as zc}from"@solana/web3.js";var bo=O([A(),A("epoch"),V("curveType"),Gt("index"),A("migrateFee"),A("tradeFeeRate"),A("maxShareFeeRate"),A("minSupplyA"),A("maxLockRate"),A("minSellRateA"),A("minMigrateRateA"),A("minFundRaisingB"),C("mintB"),C("protocolFeeOwner"),C("migrateFeeOwner"),C("migrateToAmmWallet"),C("migrateToCpmmWallet"),X(A(),16)]),of=O([A("totalLockedAmount"),A("cliffPeriod"),A("unlockPeriod"),A("startTime"),A("totalAllocatedShare")]),dn=O([A(),A("epoch"),V("bump"),V("status"),V("mintDecimalsA"),V("mintDecimalsB"),V("migrateType"),A("supply"),A("totalSellA"),A("virtualA"),A("virtualB"),A("realA"),A("realB"),A("totalFundRaisingB"),A("protocolFee"),A("platformFee"),A("migrateFee"),of.replicate("vestingSchedule"),C("configId"),C("platformId"),C("mintA"),C("mintB"),C("vaultA"),C("vaultB"),C("creator"),X(A(),8)]),a0=O([A(),A("epoch"),C("poolId"),C("beneficiary"),A("claimedAmount"),A("tokenShareAmount"),X(A(),8)]),Kr=O([A(),A("epoch"),C("platformClaimFeeWallet"),C("platformLockNftWallet"),A("platformScale"),A("creatorScale"),A("burnScale"),A("feeRate"),X(V(),64,"name"),X(V(),256,"web"),X(V(),256,"img"),C("cpConfigId"),X(V(),224)]);import en from"bn.js";import pi from"bn.js";var Rn=class{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){throw Error()}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:i,decimalA:s,decimalB:a}){throw Error()}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){throw Error()}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:i}){throw Error()}static buyExactIn({poolInfo:e,amount:t}){throw Error()}static buyExactOut({poolInfo:e,amount:t}){throw Error()}static sellExactIn({poolInfo:e,amount:t}){throw Error()}static sellExactOut({poolInfo:e,amount:t}){throw Error()}};var Cr=class extends Rn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new L(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){return new L(t.toString()).div(e.toString()).mul(10**(n-o))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new L(e.virtualB.add(e.realB).toString()).div(e.virtualA.sub(e.realA).toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:i,decimalA:s,decimalB:a}){return new L(o.sub(i).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let o=e.totalSellA.sub(e.realA),i=e.totalFundRaisingB.sub(e.realB);return new L(e.virtualB.add(e.realB.add(i)).toString()).div(e.virtualA.sub(e.realA.add(o)).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:i}){if(e.lte(n))throw Error("supply need gt total sell");let s=e.sub(n).sub(o);if(s.lte(new pi(0)))throw Error("supplyMinusSellLocked <= 0");let a=t.sub(i);if(a.lte(new pi(0)))throw Error("tfMinusMf <= 0");let c=a.mul(n).mul(n).div(s),u=a.mul(n).div(s).sub(t);if(u.lt(new pi(0)))throw Error("supply/totalSell/totalLockedAmount diff too high");let l=c.div(u),m=t.mul(t).div(u);if(l.lt(new pi(0))||m.lt(new pi(0)))throw Error("invalid input 0");return{a:l,b:m,c:n}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualB.add(e.realB),outputReserve:e.virtualA.sub(e.realA)})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,inputReserve:e.virtualA.sub(e.realA),outputReserve:e.virtualB.add(e.realB)})}static getAmountOut({amountIn:e,inputReserve:t,outputReserve:n}){let o=e.mul(n),i=t.add(e);return o.div(i)}static getAmountIn({amountOut:e,inputReserve:t,outputReserve:n}){let o=t.mul(e),i=n.sub(e);return Fi(o,i)}};import Xc from"bn.js";var Lr=class extends Rn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new L(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){return new L(t.toString()).div(e.toString()).mul(10**(n-o))}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new L(e.virtualB.toString()).div(e.virtualA.toString()).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:i,decimalA:s,decimalB:a}){return new L(o.sub(i).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let o=e.totalSellA.sub(e.realA),i=e.totalFundRaisingB.sub(e.realB);return new L(e.virtualB.add(e.realB).add(i).toString()).div(e.virtualA.sub(e.realA).add(o).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:i}){let s=e.sub(o);if(s.lte(new Xc(0)))throw Error("invalid input 1");let a=new Xc(2).mul(t).sub(i),u=t.mul(s).div(a);return{a:u,b:t,c:u}}static buyExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualB,initOutput:e.virtualA})}static buyExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualB,initOutput:e.virtualA})}static sellExactIn({poolInfo:e,amount:t}){return this.getAmountOut({amountIn:t,initInput:e.virtualA,initOutput:e.virtualB})}static sellExactOut({poolInfo:e,amount:t}){return this.getAmountIn({amountOut:t,initInput:e.virtualA,initOutput:e.virtualB})}static getAmountOut({amountIn:e,initInput:t,initOutput:n}){return n.mul(e).div(t)}static getAmountIn({amountOut:e,initInput:t,initOutput:n}){let o=t.mul(e);return Fi(o,n)}};import wt from"bn.js";import Qc from"bn.js";var fi=class{static _multipler(e){return new L(10).pow(e)}static getPrice({priceX64:e,decimalA:t,decimalB:n}){return new L(e.toString()).div(this._Q64).mul(this._multipler(t)).div(this._multipler(n))}static getPriceX64({price:e,decimalA:t,decimalB:n}){let o=e.mul(this._multipler(n)).div(this._multipler(t));return new Qc(o.mul(this._Q64).toFixed(0))}};Tt(fi,"_Q64",new L(new Qc(1).shln(64).toString()));var Rr=class extends Rn{static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n}){return new L(0)}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o}){return new L(0)}static getPoolPrice({poolInfo:e,decimalA:t,decimalB:n}){return new L(e.virtualA.mul(e.realA).toString()).div(fi._Q64).mul(10**(t-n))}static getPoolEndPrice({supply:e,totalSell:t,totalLockedAmount:n,totalFundRaising:o,migrateFee:i,decimalA:s,decimalB:a}){return new L(o.sub(i).toString()).div(e.sub(t).sub(n).toString()).mul(10**(s-a))}static getPoolEndPriceReal({poolInfo:e,decimalA:t,decimalB:n}){let o=e.totalSellA.sub(e.realA),i=e.totalFundRaisingB.sub(e.realB);return new L(e.virtualB.add(e.realB).add(i).toString()).div(e.virtualA.sub(e.realA).add(o).toString()).mul(10**(t-n))}static getInitParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,migrateFee:i}){let s=e.sub(o);if(s.lte(new wt(0)))throw Error("supplyMinusLocked need gt 0");let a=t.mul(new wt(3)).sub(i),u=t.mul(new wt(2)).mul(s).div(a),l=u.mul(u),m=t.mul(new wt(2)).mul(qe).div(l);if(!m.gt(new wt(0)))throw Error("a need gt 0");if(!Vo.gt(m))throw Error("a need lt u64 max");return{a:m,b:new wt(0),c:u}}static buyExactIn({poolInfo:e,amount:t}){let n=e.realB.add(t),o=new wt(2).mul(n).mul(qe).div(e.virtualA);return new wt(new L(o.toString()).sqrt().toFixed(0)).sub(e.realA)}static buyExactOut({poolInfo:e,amount:t}){let n=e.realA.add(t),o=n.mul(n),{div:i,mod:s}=e.virtualA.mul(o).divmod(new wt(2).mul(qe));return(s.isZero()?i:i.add(new wt(1))).sub(e.realB)}static sellExactIn({poolInfo:e,amount:t}){let n=e.realA.sub(t),o=n.mul(n),{div:i,mod:s}=e.virtualA.mul(o).divmod(new wt(2).mul(qe)),a=s.isZero()?i:i.add(new wt(1));return e.realB.sub(a)}static sellExactOut({poolInfo:e,amount:t}){let n=e.realB.sub(t),o=new wt(2).mul(n).mul(qe).div(e.virtualA),i=new wt(new L(o.toString()).sqrt().toFixed(0));return e.realA.sub(i)}};var tn=class{static getPoolCurvePointByPoolInfo({curveType:e,pointCount:t,poolInfo:n}){return this.getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n.supply,totalFundRaising:n.totalFundRaisingB,totalSell:n.totalSellA,totalLockedAmount:n.vestingSchedule.totalLockedAmount,migrateFee:n.migrateFee,decimalA:n.mintDecimalsA,decimalB:n.mintDecimalsB})}static getPoolCurvePointByInit({curveType:e,pointCount:t,supply:n,totalFundRaising:o,totalSell:i,totalLockedAmount:s,migrateFee:a,decimalA:c,decimalB:u}){if(t<3)throw Error("point count < 3");let l=this.getCurve(e),m=l.getInitParam({supply:n,totalFundRaising:o,totalSell:i,totalLockedAmount:s,migrateFee:a}),d=l.getPoolInitPriceByInit({...m,decimalA:c,decimalB:u}),p=o.div(new en(t-1)),f=new en(0),y=[{price:d,totalSellSupply:0}],{a:b,b:g}=m,P=f,w=f;for(let k=1;k<t;k++){let x=k!==t-1?p:o.sub(w),h=this.buyExactIn({poolInfo:{virtualA:b,virtualB:g,realA:P,realB:w,totalFundRaisingB:o,totalSellA:i},amountB:x,protocolFeeRate:f,platformFeeRate:f,curveType:e,shareFeeRate:f});P=P.add(h.amountA),w=w.add(h.amountB);let I=this.getPrice({poolInfo:{virtualA:b,virtualB:g,realA:P,realB:w},decimalA:c,decimalB:u,curveType:e});y.push({price:I,totalSellSupply:new L(P.toString()).div(10**c).toNumber()})}return y}static getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n,curveType:o}){return this.getCurve(o).getPoolInitPriceByPool({poolInfo:e,decimalA:t,decimalB:n})}static getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o,curveType:i}){return this.getCurve(i).getPoolInitPriceByInit({a:e,b:t,decimalA:n,decimalB:o})}static getPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:o}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:o})}static getEndPrice({poolInfo:e,curveType:t,decimalA:n,decimalB:o}){return this.getCurve(t).getPoolPrice({poolInfo:e,decimalA:n,decimalB:o})}static getPoolEndPriceReal({poolInfo:e,curveType:t,decimalA:n,decimalB:o}){return this.getCurve(t).getPoolEndPriceReal({poolInfo:e,decimalA:n,decimalB:o})}static checkParam({supply:e,totalFundRaising:t,totalSell:n,totalLockedAmount:o,decimals:i,config:s,migrateType:a}){if(Number(i)!==6)throw Error("decimals = 6");if(e.mul(s.maxLockRate).div(qt).lt(o))throw Error("total lock amount gte max lock amount");if(e.lt(s.minSupplyA.mul(new en(10**i))))throw Error("supply lt min supply");let u=e.mul(s.minSellRateA).div(qt);if(n.lt(u))throw Error("invalid input");if(t.lt(s.minFundRaisingB))throw Error("total fund raising lt min fund raising");let l=e.sub(n).sub(o),m=e.mul(s.minMigrateRateA).div(qt);if(l.lt(m))throw Error("migrate lt min migrate amount");let d=e.sub(n).sub(o),p=new en(new L(d.mul(t).toString()).sqrt().toFixed(0));if(a==="amm"){let f=new en(10).pow(new en(i));if(p.lte(f))throw Error("check migrate lp error")}else if(a==="cpmm"){let f=new en(100);if(p.lte(f))throw Error("check migrate lp error")}else throw Error("migrate type error")}static buyExactIn({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:o,curveType:i,shareFeeRate:s}){let a=n.add(s).add(o),c=this.calculateFee({amount:t,feeRate:a}),u=t.sub(c),l=this.getCurve(i),m=l.buyExactIn({poolInfo:e,amount:u}),d=e.totalSellA.sub(e.realA),p,f,y;if(m.gt(d)){p=d;let g=l.buyExactOut({poolInfo:e,amount:p});f=this.calculatePreFee({postFeeAmount:g,feeRate:a}),y=f.sub(g)}else p=m,f=t,y=c;let b=this.splitFee({totalFee:y,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:p,amountB:f,splitFee:b}}static buyExactOut({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:o,curveType:i,shareFeeRate:s}){let a=e.totalSellA.sub(e.realA),c=t;t.gt(a)&&(c=a);let l=this.getCurve(i).buyExactOut({poolInfo:e,amount:t}),m=n.add(s).add(o),d=this.calculatePreFee({postFeeAmount:l,feeRate:m}),p=d.sub(l),f=this.splitFee({totalFee:p,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:c,amountB:d,splitFee:f}}static sellExactIn({poolInfo:e,amountA:t,protocolFeeRate:n,platformFeeRate:o,curveType:i,shareFeeRate:s}){let c=this.getCurve(i).sellExactIn({poolInfo:e,amount:t}),u=this.calculateFee({amount:c,feeRate:n.add(s).add(o)}),l=this.splitFee({totalFee:u,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:t,amountB:c.sub(u),splitFee:l}}static sellExactOut({poolInfo:e,amountB:t,protocolFeeRate:n,platformFeeRate:o,curveType:i,shareFeeRate:s}){let a=n.add(s).add(o),c=this.calculatePreFee({postFeeAmount:t,feeRate:a});if(e.realB.lt(c))throw Error("Insufficient liquidity");let u=c.sub(t),m=tn.getCurve(i).sellExactOut({poolInfo:e,amount:c});if(m.gt(e.realA))throw Error();let d=this.splitFee({totalFee:u,protocolFeeRate:n,platformFeeRate:o,shareFeeRate:s});return{amountA:m,amountB:t,splitFee:d}}static splitFee({totalFee:e,protocolFeeRate:t,platformFeeRate:n,shareFeeRate:o}){let i=t.add(n).add(o),s=i.isZero()?new en(0):e.mul(n).div(i),a=i.isZero()?new en(0):e.mul(o).div(i),c=e.sub(s).sub(a);return{platformFee:s,shareFee:a,protocolFee:c}}static calculateFee({amount:e,feeRate:t}){return Ri(e,t,qt)}static calculatePreFee({postFeeAmount:e,feeRate:t}){if(t.isZero())return e;let n=e.mul(qt),o=qt.sub(t);return n.add(o).sub(new en(1)).div(o)}static getCurve(e){switch(e){case 0:return Cr;case 1:return Lr;case 2:return Rr}throw Error("find curve error")}};var jn={initPriceX64:new pe("515752397214619"),supply:new pe(1e15),totalSellA:new pe(7931e11),totalFundRaisingB:new pe(85e9),totalLockedAmount:new pe("0"),cliffPeriod:new pe("0"),unlockPeriod:new pe("0"),decimals:6,virtualA:new pe("1073471847374405"),virtualB:new pe("30050573465"),realA:new pe(0),realB:new pe(0),protocolFee:new pe(0),platformId:new zc("4Bu96XjU84XjPDSpveTVf6LYGCkfW5FK7SNkREWcEfV4"),vestingSchedule:{totalLockedAmount:new pe(0),cliffPeriod:new pe(0),unlockPeriod:new pe(0),startTime:new pe(0),totalAllocatedShare:new pe(0)}},Or=new pe(1e4),yi=class extends Ke{constructor(e){super(e)}async createLaunchpad({programId:e=Zt,authProgramId:t,platformId:n=jn.platformId,mintA:o,decimals:i=6,mintBDecimals:s=9,name:a,symbol:c,uri:u,migrateType:l,configId:m,configInfo:d,platformFeeRate:p,txVersion:f,computeBudgetConfig:y,txTipConfig:b,feePayer:g,buyAmount:P,minMintAAmount:w,slippage:k,associatedOnly:x=!0,checkCreateATAOwner:h=!1,extraSigners:I,...S}){let T=this.createTxBuilder(g);t=t??Hn(e).publicKey;let K=d;if(!K&&m){let it=await this.scope.connection.getAccountInfo(m);it&&(K=bo.decode(it.data))}K||this.logAndCreateError("config not found");let R=K.mintB,N=K.curveType,{publicKey:v}=xr(e,o,R),{publicKey:W}=ia(e,v,o),{publicKey:D}=ia(e,v,R),{publicKey:U}=un(o);console.log(`create token: ${o.toBase58()}, mintB: ${R.toBase58()}, decimals A:${i}/B:${s}, config:${m.toBase58()}`),c.length>10&&this.logAndCreateError("Symbol length should shorter than 11"),u||this.logAndCreateError("uri should not empty"),P.lte(new pe(0))&&this.logAndCreateError("buy amount should gt 0:",P.toString());let ee=S?.supply??jn.supply,J=S?.totalSellA??jn.totalSellA,le=S?.totalFundRaisingB??jn.totalFundRaisingB,oe=S?.totalLockedAmount??new pe(0),fe=p;if(!p){let it=await this.scope.connection.getAccountInfo(n);it||this.logAndCreateError("platform id not found:",n.toString()),fe=Kr.decode(it.data).feeRate}let Ge=tn.getCurve(K.curveType).getInitParam({supply:ee,totalFundRaising:le,totalSell:J,totalLockedAmount:oe,migrateFee:K.migrateFee}),ze={epoch:new pe(896),bump:254,status:0,mintDecimalsA:i,mintDecimalsB:s,supply:ee,totalSellA:J,mintA:new zc(o),mintB:R,virtualA:Ge.a,virtualB:Ge.b,realA:jn.realA,realB:jn.realB,migrateFee:K.migrateFee,migrateType:l==="amm"?0:1,protocolFee:jn.protocolFee,platformFee:fe,platformId:n,configId:m,vaultA:W,vaultB:D,creator:this.scope.ownerPubKey,totalFundRaisingB:le,vestingSchedule:{totalLockedAmount:oe,cliffPeriod:new pe(0),unlockPeriod:new pe(0),startTime:new pe(0),totalAllocatedShare:new pe(0)}},bt=tn.getCurve(K.curveType),{c:ht}=bt.getInitParam({supply:ze.supply,totalFundRaising:ze.totalFundRaisingB,totalLockedAmount:oe,totalSell:K.curveType===0?ze.totalSellA:new pe(0),migrateFee:K.migrateFee});try{tn.checkParam({supply:ze.supply,totalFundRaising:ze.totalFundRaisingB,totalSell:ht,totalLockedAmount:oe,decimals:ze.mintDecimalsA,config:K,migrateType:l}),console.log("check init params success")}catch(it){this.logAndCreateError(`check create mint params failed, ${it.message}`)}T.addInstruction({instructions:[Fc(e,g??this.scope.ownerPubKey,this.scope.ownerPubKey,m,n,t,v,o,R,W,D,U,kt,kt,i,a,c,u||"https://",{type:N===0?"ConstantCurve":N===1?"FixedCurve":N===2?"LinearCurve":"ConstantCurve",totalSellA:J,migrateType:l,supply:ee,totalFundRaisingB:le},oe,S?.cliffPeriod??new pe(0),S?.unlockPeriod??new pe(0))]});let zt=new pe(0),nn;if(I?.length&&T.addInstruction({signers:I}),!S.createOnly){let{builder:it,extInfo:He}=await this.buyToken({programId:e,authProgramId:t,mintA:o,mintB:R,poolInfo:ze,buyAmount:P,minMintAAmount:w,shareFeeRate:S.shareFeeRate,shareFeeReceiver:S.shareFeeReceiver,configInfo:K,platformFeeRate:fe,slippage:k,associatedOnly:x,checkCreateATAOwner:h});T.addInstruction({...it.AllTxData}),zt=He.outAmount,nn=(this.scope.cluster==="devnet"||f===1)&&S.shareFeeReceiver?[it.allInstructions[0]]:void 0}return T.addTipInstruction(b),f===0?T.sizeCheckBuildV0({computeBudgetConfig:y,outAmount:zt,splitIns:nn,address:{...ze,poolId:v}}):T.sizeCheckBuild({computeBudgetConfig:y,outAmount:zt,splitIns:nn,address:{...ze,poolId:v}})}async buyToken({programId:e=Zt,authProgramId:t,mintA:n,mintB:o=Nr,poolInfo:i,configInfo:s,platformFeeRate:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:m,buyAmount:d,minMintAAmount:p,slippage:f,shareFeeRate:y=new pe(0),shareFeeReceiver:b,associatedOnly:g=!0,checkCreateATAOwner:P=!1}){d.lte(new pe(0))&&this.logAndCreateError("buy amount should gt 0:",d.toString());let w=this.createTxBuilder(m),{publicKey:k}=xr(e,n,o);t=t??Hn(e).publicKey;let x=null,h=null,I=o.equals(Nr),{account:S,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({mint:n,owner:this.scope.ownerPubKey,createInfo:{payer:this.scope.ownerPubKey,amount:0},skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:g,checkCreateATAOwner:P});S&&(x=S),w.addInstruction(T||{}),x===void 0&&this.logAndCreateError(`cannot found mintA(${n.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let{account:K,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({mint:o,owner:this.scope.ownerPubKey,createInfo:I?{payer:this.scope.ownerPubKey,amount:d}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:I?!1:g,checkCreateATAOwner:P});K&&(h=K),w.addInstruction(R||{}),h===void 0&&this.logAndCreateError(`cannot found mintB(${o.toBase58()}) token accounts`,"tokenAccounts",this.scope.account.tokenAccounts);let N=i;if(!N){let oe=await this.scope.connection.getAccountInfo(k,{commitment:"processed"});oe||this.logAndCreateError("cannot found pool:",k.toBase58()),N=dn.decode(oe.data)}let v=s,W=await xe(this.scope.connection,[v?void 0:N.configId,a?void 0:N.platformId].filter(Boolean).map(oe=>({pubkey:oe})));if(!v){let oe=W.find(fe=>fe.pubkey.equals(N.configId));(!oe||!oe.accountInfo)&&this.logAndCreateError("config not found: ",N.configId.toBase58()),v=bo.decode(oe.accountInfo.data)}if(!a){let oe=W.find(fe=>fe.pubkey.equals(N.platformId));(!oe||!oe.accountInfo)&&this.logAndCreateError("platform info not found: ",N.configId.toBase58()),a=Kr.decode(oe.accountInfo.data).feeRate}let D=tn.buyExactIn({poolInfo:N,amountB:d,protocolFeeRate:v.tradeFeeRate,platformFeeRate:a,curveType:v.curveType,shareFeeRate:y}),U=new L(D.amountA.toString()),ee=f?new L(Or.sub(f).toNumber()/Or.toNumber()).clampedTo(0,1):new L(1),J=p??(f?new pe(U.mul(ee).toFixed(0)):D.amountA);D.amountB.lt(d)&&console.log(`maximum ${n.toBase58()} amount can buy is ${D.amountA.toString()}, input ${o.toBase58()} amount: ${D.amountB.toString()}`);let le=b?$(b,o,kt).publicKey:void 0;return le&&w.addInstruction({instructions:[bi(this.scope.ownerPubKey,le,b,o)]}),w.addInstruction({instructions:[Vc(e,this.scope.ownerPubKey,t,N.configId,N.platformId,k,x,h,N.vaultA,N.vaultB,n,o,kt,kt,D.amountB.lt(d)?D.amountB:d,J,y,le)]}),w.addCustomComputeBudget(u),w.addTipInstruction(l),w.versionBuild({txVersion:c,extInfo:{outAmount:J}})}async sellToken({programId:e=Zt,authProgramId:t,mintA:n,mintB:o=Nr,poolInfo:i,configInfo:s,platformFeeRate:a,txVersion:c,computeBudgetConfig:u,txTipConfig:l,feePayer:m,sellAmount:d,minAmountB:p,slippage:f,shareFeeRate:y=new pe(0),shareFeeReceiver:b,associatedOnly:g=!0,checkCreateATAOwner:P=!1}){t=t??Hn(e).publicKey;let w=this.createTxBuilder(m);d.lte(new pe(0))&&this.logAndCreateError("sell amount should be gt 0");let{publicKey:k}=xr(e,n,o),x=null,h=null,I=o.equals(Nr),{account:S,instructionParams:T}=await this.scope.account.getOrCreateTokenAccount({mint:n,owner:this.scope.ownerPubKey,createInfo:void 0,skipCloseAccount:!0,notUseTokenAccount:!1,associatedOnly:g,checkCreateATAOwner:P});S&&(x=S),w.addInstruction(T||{}),x===void 0&&this.logAndCreateError("cannot found mintA token accounts","tokenAccounts",this.scope.account.tokenAccounts);let{account:K,instructionParams:R}=await this.scope.account.getOrCreateTokenAccount({mint:o,owner:this.scope.ownerPubKey,createInfo:I?{payer:this.scope.ownerPubKey,amount:0}:void 0,skipCloseAccount:!I,notUseTokenAccount:I,associatedOnly:I?!1:g,checkCreateATAOwner:P});K&&(h=K),w.addInstruction(R||{}),h===void 0&&this.logAndCreateError("cannot found mintB token accounts","tokenAccounts",this.scope.account.tokenAccounts);let N=i;if(!N){let oe=await this.scope.connection.getAccountInfo(k,{commitment:"processed"});oe||this.logAndCreateError("cannot found pool",k.toBase58()),N=dn.decode(oe.data)}let v=s,W=await xe(this.scope.connection,[v?void 0:N.configId,a?void 0:N.platformId].filter(Boolean).map(oe=>({pubkey:oe})));if(!v){let oe=W.find(fe=>fe.pubkey.equals(N.configId));(!oe||!oe.accountInfo)&&this.logAndCreateError("config not found: ",N.configId.toBase58()),v=bo.decode(oe.accountInfo.data)}if(!a){let oe=W.find(fe=>fe.pubkey.equals(N.platformId));(!oe||!oe.accountInfo)&&this.logAndCreateError("platform info not found: ",N.configId.toBase58()),a=Kr.decode(oe.accountInfo.data).feeRate}let D=tn.sellExactIn({poolInfo:N,amountA:d,protocolFeeRate:v.tradeFeeRate,platformFeeRate:a,curveType:v.curveType,shareFeeRate:y}),U=new L(D.amountB.toString()),ee=f?new L(Or.sub(f).toNumber()/Or.toNumber()).clampedTo(0,1):new L(1),J=p??(f?new pe(U.mul(ee).toFixed(0)):D.amountB);J.lte(new pe(0))&&this.logAndCreateError(`out ${o.toBase58()} amount should be gt 0`);let le=b?$(b,o,kt).publicKey:void 0;return le&&w.addInstruction({instructions:[bi(this.scope.ownerPubKey,le,b,o)]}),w.addInstruction({instructions:[Wc(e,this.scope.ownerPubKey,t,N.configId,N.platformId,k,x,h,N.vaultA,N.vaultB,n,o,kt,kt,D.amountA.lt(d)?D.amountA:d,J,y,le)]}),w.addCustomComputeBudget(u),w.addTipInstruction(l),w.versionBuild({txVersion:c,extInfo:{outAmount:J}})}async createPlatformConfig({programId:e=Zt,platformAdmin:t,platformClaimFeeWallet:n,platformLockNftWallet:o,cpConfigId:i,migrateCpLockNftScale:s,feeRate:a,name:c,web:u,img:l,txVersion:m,computeBudgetConfig:d,txTipConfig:p,feePayer:f}){let y=this.createTxBuilder(f),{publicKey:b}=ra(e,t);return y.addInstruction({instructions:[Uc(e,t,n,o,b,i,s,a,c,u,l)]}),y.addCustomComputeBudget(d),y.addTipInstruction(p),y.versionBuild({txVersion:m,extInfo:{platformId:b}})}async updatePlatformConfig({programId:e=Zt,platformAdmin:t,platformId:n,updateInfo:o,txVersion:i,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l=n??ra(e,t).publicKey;return u.addInstruction({instructions:[Gc(e,t,l,o)]}),u.addCustomComputeBudget(s),u.addTipInstruction(a),u.versionBuild({txVersion:i})}async claimPlatformFee({programId:e=Zt,authProgramId:t,platformId:n,poolId:o,platformClaimFeeWallet:i,mintB:s,vaultB:a,mintBProgram:c=kt,txVersion:u,computeBudgetConfig:l,txTipConfig:m,feePayer:d}){let p=this.createTxBuilder(d);t=t??Hn(e).publicKey;let f=s,y=a;if(!f){let g=await this.scope.connection.getAccountInfo(o,{commitment:"processed"});g||this.logAndCreateError("cannot found pool:",o.toBase58());let P=dn.decode(g.data),w=await this.scope.connection.getAccountInfo(P.configId,{commitment:"processed"});w||this.logAndCreateError("cannot found config:",P.configId.toBase58()),f=bo.decode(w.data).mintB,y=y??P.vaultB}(!f||!y)&&this.logAndCreateError("cannot found mint info, mintB: ",f.toBase58(),", vaultB: ",y?.toBase58()??"");let b=$(this.scope.ownerPubKey,f,kt).publicKey;return p.addInstruction({instructions:[bi(this.scope.ownerPubKey,b,this.scope.ownerPubKey,f)]}),p.addInstruction({instructions:[aa(e,i,t,o,n,y,b,f,c)]}),p.addCustomComputeBudget(l),p.addTipInstruction(m),p.versionBuild({txVersion:u})}async claimAllPlatformFee({programId:e=Zt,authProgramId:t,platformId:n,platformClaimFeeWallet:o,txVersion:i,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c);return t=t??Hn(e).publicKey,(await this.scope.connection.getProgramAccounts(e,{filters:[{dataSize:dn.span},{memcmp:{offset:dn.offsetOf("platformId"),bytes:n.toString()}}]})).forEach(m=>{let d=dn.decode(m.account.data),p=$(this.scope.ownerPubKey,d.mintB,kt).publicKey;u.addInstruction({instructions:[bi(this.scope.ownerPubKey,p,this.scope.ownerPubKey,d.mintB)]}),u.addInstruction({instructions:[aa(e,o,t,m.pubkey,n,d.vaultB,p,d.mintB,kt)]})}),u.addTipInstruction(a),i===0?u.sizeCheckBuildV0({computeBudgetConfig:s}):u.sizeCheckBuild({computeBudgetConfig:s})}async createVesting({programId:e=Zt,poolId:t,beneficiary:n,shareAmount:o,txVersion:i,computeBudgetConfig:s,txTipConfig:a,feePayer:c}){let u=this.createTxBuilder(c),l=sa(e,t,n).publicKey;return u.addInstruction({instructions:[qc(e,this.scope.ownerPubKey,n,t,l,o)]}),u.addCustomComputeBudget(s),u.addTipInstruction(a),u.versionBuild({txVersion:i})}async claimVesting({programId:e=Zt,poolId:t,poolInfo:n,txVersion:o,computeBudgetConfig:i,txTipConfig:s,feePayer:a,associatedOnly:c=!0,checkCreateATAOwner:u=!1}){let l=this.createTxBuilder(a),m=Hn(e).publicKey,d=sa(e,t,this.scope.ownerPubKey).publicKey,p=n;if(!p){let y=await this.scope.connection.getAccountInfo(t);y||this.logAndCreateError("pool not found"),p=dn.decode(y.data)}let f=$(this.scope.ownerPubKey,p.mintA,kt).publicKey;return l.addInstruction({instructions:[bi(this.scope.ownerPubKey,f,this.scope.ownerPubKey,p.mintA)]}),l.addInstruction({instructions:[Dc(e,this.scope.ownerPubKey,m,t,d,f,p.vaultA,p.mintA,kt)]}),l.addCustomComputeBudget(i),l.addTipInstruction(s),l.versionBuild({txVersion:o})}async getRpcPoolInfo({poolId:e}){return(await this.getRpcPoolsInfo({poolIdList:[e]})).poolInfoMap[e.toBase58()]}async getRpcPoolsInfo({poolIdList:e,config:t}){let n=await xe(this.scope.connection,e.map(c=>({pubkey:c})),t),o={},i=[];for(let c=0;c<e.length;c++){let u=n[c];if(u===null||!u.accountInfo)throw Error("fetch pool info error: "+e[c].toBase58());let l=dn.decode(u.accountInfo.data);o[e[c].toBase58()]={...l,poolId:u.accountInfo.owner},i.push(l.configId)}let s=await xe(this.scope.connection,i.map(c=>({pubkey:c})),t),a={};for(let c=0;c<i.length;c++){let u=s[c];if(u===null||!u.accountInfo)throw Error("fetch config info error: "+i[c].toBase58());let l=bo.decode(u.accountInfo.data);a[i[c].toBase58()]={...l,configId:u.accountInfo.owner}}return{poolInfoMap:Object.keys(o).reduce((c,u)=>({...c,[u]:{...o[u],configInfo:a[o[u].configId.toBase58()]}}),{})}}};import{PublicKey as rf}from"@solana/web3.js";import{MintLayout as sf,TOKEN_2022_PROGRAM_ID as ua,TOKEN_PROGRAM_ID as ca}from"@solana/spl-token";var gi=class extends Ke{_tokenList=[];_tokenMap=new Map;_blackTokenMap=new Set;_mintGroup={official:new Set,jup:new Set,extra:new Set};_whiteMap=new Set;_extraTokenList=[];constructor(e){super(e)}async load(e){this.checkDisabled();let{forceUpdate:t=!1,type:n="strict"}=e||{},{mintList:o,blacklist:i,whiteList:s}=await this.scope.fetchV3TokenList(t),a=await this.scope.fetchJupTokenList(t);this._tokenList=[],this._tokenMap=new Map,this._blackTokenMap=new Set(i),this._mintGroup={official:new Set,jup:new Set,extra:new Set},this._whiteMap=new Set(s),this._tokenMap.set(gn.address,gn),this._mintGroup.official.add(gn.address),o.forEach(c=>{this._blackTokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"raydium",priority:2,programId:c.programId??(c.tags.includes("token-2022")?ua.toBase58():ca.toBase58())}),this._mintGroup.official.add(c.address))}),a.forEach(c=>{this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"jupiter",priority:1,programId:c.programId??(c.tags.includes("token-2022")?ua.toBase58():ca.toBase58()),tags:c.freezeAuthority?[...c.tags||[],"hasFreeze"]:c.tags}),this._mintGroup.jup.add(c.address))}),this._extraTokenList.forEach(c=>{this._blackTokenMap.has(c.address)||this._tokenMap.has(c.address)||(this._tokenMap.set(c.address,{...c,type:"extra",priority:1,programId:c.programId||c.tags.includes("token-2022")?ua.toBase58():ca.toBase58()}),this._mintGroup.extra.add(c.address))}),this._tokenList=Array.from(this._tokenMap).map(c=>c[1])}get tokenList(){return this._tokenList}get tokenMap(){return this._tokenMap}get blackTokenMap(){return this._blackTokenMap}get mintGroup(){return this._mintGroup}get whiteListMap(){return this._whiteMap}async getTokenInfo(e){if(!e)throw new Error("please input mint");let t=e.toString(),n=this._tokenMap.get(t);if(n)return n;if(t.toLocaleUpperCase()==="SOL")return gn;let o=(await this.scope.api.getTokenInfo([t]))[0];if(o)return this._mintGroup.extra.add(t),this._tokenMap.set(t,{...o,priority:2}),o;let i=await this.scope.connection.getAccountInfo(new rf(t));if(!i)throw new Error(`mint address not found: ${t}`);let s=sf.decode(i.data),a=t.toString().substring(0,6),c={chainId:101,address:t,programId:i.owner.toBase58(),logoURI:"",symbol:a,name:a,decimals:s.decimals,tags:[],extensions:{},priority:0,type:"unknown"};return this._mintGroup.extra.add(t),this._tokenMap.set(t,c),c}};var vr=class{cluster;farm;account;liquidity;clmm;cpmm;tradeV2;utils1216;marketV2;ido;token;launchpad;rawBalances=new Map;apiData;availability;blockhashCommitment;loopMultiTxStatus;_connection;_owner;api;_apiCacheTime;_signAllTransactions;logger;_chainTime;_epochInfo;constructor(e){let{connection:t,cluster:n,owner:o,api:i,defaultChainTime:s,defaultChainTimeOffset:a,apiCacheTime:c,blockhashCommitment:u="confirmed",loopMultiTxStatus:l}=e;this._connection=t,this.cluster=n||"mainnet",this._owner=o?new Wt(o):void 0,this._signAllTransactions=e.signAllTransactions,this.blockhashCommitment=u,this.loopMultiTxStatus=l,this.api=i,this._apiCacheTime=c||5*60*1e3,this.logger=de("Raydium"),this.farm=new Fo({scope:this,moduleName:"Raydium_Farm"}),this.account=new Lo({scope:this,moduleName:"Raydium_Account",tokenAccounts:e.tokenAccounts,tokenAccountRawInfos:e.tokenAccountRawInfos}),this.liquidity=new ti({scope:this,moduleName:"Raydium_LiquidityV2"}),this.token=new gi({scope:this,moduleName:"Raydium_tokenV2"}),this.tradeV2=new ci({scope:this,moduleName:"Raydium_tradeV2"}),this.clmm=new oi({scope:this,moduleName:"Raydium_clmm"}),this.cpmm=new ui({scope:this,moduleName:"Raydium_cpmm"}),this.utils1216=new Mt({scope:this,moduleName:"Raydium_utils1216"}),this.marketV2=new co({scope:this,moduleName:"Raydium_marketV2"}),this.ido=new fo({scope:this,moduleName:"Raydium_ido"}),this.launchpad=new yi({scope:this,moduleName:"Raydium_lauchpad"}),this.availability={};let m=new Date().getTime();this.apiData={},a&&(this._chainTime={fetched:m,value:{chainTime:s||Date.now()-a,offset:a}})}static async load(e){let t=af({cluster:"mainnet",owner:null,apiRequestInterval:3e5,apiRequestTimeout:1e4},e),{cluster:n,apiRequestTimeout:o,logCount:i,logRequests:s,urlConfigs:a}=t,c=new Xi({cluster:n,timeout:o,urlConfigs:a,logCount:i,logRequests:s}),u=new vr({...t,api:c});return await u.fetchAvailabilityStatus(e.disableFeatureCheck??!0),e.disableLoadToken||await u.token.load({type:e.jupTokenType}),u}get owner(){return this._owner}get ownerPubKey(){if(!this._owner)throw new Error(Qi);return this._owner.publicKey}setOwner(e){return this._owner=e?new Wt(e):void 0,this.account.resetTokenAccounts(),this}get connection(){if(!this._connection)throw new Error($a);return this._connection}setConnection(e){return this._connection=e,this}get signAllTransactions(){return this._signAllTransactions}setSignAllTransactions(e){return this._signAllTransactions=e,this}checkOwner(){if(!this.owner)throw console.error(Qi),new Error(Qi)}isCacheInvalidate(e){return new Date().getTime()-e>this._apiCacheTime}async fetchChainTime(){try{let e=await this.api.getChainTimeOffset();this._chainTime={fetched:Date.now(),value:{chainTime:Date.now()+e.offset*1e3,offset:e.offset*1e3}}}catch{this._chainTime=void 0}}async fetchV3TokenList(e){if(this.apiData.tokenList&&!this.isCacheInvalidate(this.apiData.tokenList.fetched)&&!e)return this.apiData.tokenList.data;try{let t=await this.api.getTokenList(),n={fetched:Date.now(),data:t};return this.apiData.tokenList=n,n.data}catch(t){return console.error(t),{mintList:[],blacklist:[],whiteList:[]}}}async fetchJupTokenList(e){let t=this.apiData.jupTokenList;if(t&&!this.isCacheInvalidate(t.fetched)&&!e)return t.data;try{let n=await this.api.getJupTokenList();return this.apiData.jupTokenList={fetched:Date.now(),data:n.map(o=>({...o,mintAuthority:o.mint_authority||void 0,freezeAuthority:o.freeze_authority||void 0}))},this.apiData.jupTokenList.data}catch(n){return console.error(n),[]}}get chainTimeData(){return this._chainTime?.value}async chainTimeOffset(){return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.offset:(await this.fetchChainTime(),this._chainTime?.value.offset||0)}async currentBlockChainTime(){return this._chainTime&&Date.now()-this._chainTime.fetched<=1e3*60*5?this._chainTime.value.chainTime:(await this.fetchChainTime(),this._chainTime?.value.chainTime||Date.now())}async fetchEpochInfo(){return this._epochInfo&&Date.now()-this._epochInfo.fetched<=1e3*30?this._epochInfo.value:(this._epochInfo={fetched:Date.now(),value:await this.connection.getEpochInfo()},this._epochInfo.value)}async fetchAvailabilityStatus(e){if(e)return{};try{let t=await this.api.fetchAvailabilityStatus(),n=t.all===!1;return this.availability={all:t.all,swap:n?!1:t.swap,createConcentratedPosition:n?!1:t.createConcentratedPosition,addConcentratedPosition:n?!1:t.addConcentratedPosition,addStandardPosition:n?!1:t.addStandardPosition,removeConcentratedPosition:n?!1:t.removeConcentratedPosition,removeStandardPosition:n?!1:t.removeStandardPosition,addFarm:n?!1:t.addFarm,removeFarm:n?!1:t.removeFarm},t}catch{return{}}}};export{vr as Raydium};
/*! noble-hashes - MIT License (c) 2022 Paul Miller (paulmillr.com) */
//# sourceMappingURL=raydium.mjs.map